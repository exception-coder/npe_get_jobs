# ä»»åŠ¡å–æ¶ˆæ–¹æ¡ˆå¯¹æ¯”ä¸é€‰æ‹©æŒ‡å—

## é—®é¢˜ï¼šæ˜¯å¦æ‰€æœ‰å¾ªç¯éƒ½éœ€è¦æ·»åŠ ä¸­æ–­æ£€æŸ¥ï¼Ÿ

**ç­”æ¡ˆï¼šä¸æ˜¯ï¼** å–å†³äºä»¥ä¸‹å› ç´ ï¼š
1. å¾ªç¯è¿è¡Œæ—¶é—´é•¿çŸ­
2. æ˜¯å¦æ˜¯å…³é”®ä¸šåŠ¡é€»è¾‘
3. ç”¨æˆ·å¯¹å–æ¶ˆå“åº”é€Ÿåº¦çš„æœŸæœ›
4. ä»£ç å¤æ‚åº¦çš„æƒè¡¡

## ğŸ¯ æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ 1: Thread.interrupt() - æ ‡å‡†ä¸­æ–­æœºåˆ¶ â­ æ¨è

**å½“å‰å®ç°ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯**

```java
public class BossRecruitmentServiceImpl {
    
    private void checkInterrupted() throws InterruptedException {
        if (Thread.currentThread().isInterrupted()) {
            throw new InterruptedException("ä»»åŠ¡å·²è¢«å–æ¶ˆ");
        }
    }
    
    public List<JobDTO> collectJobs() {
        try {
            for (String cityCode : cityCodes) {
                checkInterrupted(); // âœ… æ£€æŸ¥ç‚¹
                
                for (String keyword : keywords) {
                    checkInterrupted(); // âœ… æ£€æŸ¥ç‚¹
                    collectJobsByCity(cityCode, keyword);
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            log.warn("ä»»åŠ¡è¢«å–æ¶ˆ");
            return Collections.emptyList();
        }
    }
}
```

**âœ… ä¼˜ç‚¹**ï¼š
- Java æ ‡å‡†æœºåˆ¶ï¼Œé€šç”¨æ€§å¼º
- ä¸é˜»å¡æ–¹æ³•ï¼ˆsleepã€waitï¼‰å¤©ç„¶é›†æˆ
- `ExecutorService.shutdownNow()` è‡ªåŠ¨æ”¯æŒ

**âŒ ç¼ºç‚¹**ï¼š
- éœ€è¦ä¸šåŠ¡ä»£ç é…åˆæ£€æŸ¥
- ä»£ç ä¾µå…¥æ€§è¾ƒå¼º

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æœ‰é˜»å¡æ“ä½œçš„ä»»åŠ¡ï¼ˆsleepã€IOç­‰ï¼‰
- âœ… éœ€è¦ä¸ ExecutorService é›†æˆ
- âœ… æ ‡å‡† Java åº”ç”¨

---

### æ–¹æ¡ˆ 2: volatile boolean - è‡ªå®šä¹‰å–æ¶ˆæ ‡å¿—

**ç®€å•ç›´è§‚ï¼Œé€‚åˆç®€å•åœºæ™¯**

```java
public class BossRecruitmentServiceImpl {
    
    // å–æ¶ˆæ ‡å¿—ï¼ˆå¯ä»¥æ”¾åœ¨ Task å¯¹è±¡ä¸­ï¼‰
    private volatile boolean cancelled = false;
    
    public void cancel() {
        this.cancelled = true;
    }
    
    private boolean isCancelled() {
        return this.cancelled;
    }
    
    public List<JobDTO> collectJobs() {
        for (String cityCode : cityCodes) {
            if (isCancelled()) { // âœ… æ£€æŸ¥ç‚¹
                log.warn("ä»»åŠ¡è¢«å–æ¶ˆ");
                return Collections.emptyList();
            }
            
            for (String keyword : keywords) {
                if (isCancelled()) { // âœ… æ£€æŸ¥ç‚¹
                    log.warn("ä»»åŠ¡è¢«å–æ¶ˆ");
                    return Collections.emptyList();
                }
                collectJobsByCity(cityCode, keyword);
            }
        }
    }
}
```

**âœ… ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´è§‚ï¼Œå®¹æ˜“ç†è§£
- ä¸æŠ›å¼‚å¸¸ï¼Œå¯ä»¥ä¼˜é›…è¿”å›
- å¯ä»¥æºå¸¦æ›´å¤šçŠ¶æ€ä¿¡æ¯

**âŒ ç¼ºç‚¹**ï¼š
- æ— æ³•ä¸­æ–­é˜»å¡æ“ä½œï¼ˆsleepã€waitï¼‰
- éœ€è¦æ‰‹åŠ¨ä¼ é€’æ ‡å¿—ä½

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æ²¡æœ‰é˜»å¡æ“ä½œçš„çº¯è®¡ç®—ä»»åŠ¡
- âœ… éœ€è¦æºå¸¦æ›´å¤šçŠ¶æ€çš„åœºæ™¯
- âœ… ä¸æƒ³ä½¿ç”¨å¼‚å¸¸æ§åˆ¶æµç¨‹

---

### æ–¹æ¡ˆ 3: AtomicBoolean - çº¿ç¨‹å®‰å…¨æ ‡å¿—

**æ–¹æ¡ˆ2çš„å¢å¼ºç‰ˆ**

```java
public class TaskContext {
    // åœ¨ TaskExecutor çš„ TaskContext ä¸­æ·»åŠ 
    private final AtomicBoolean cancelled = new AtomicBoolean(false);
    
    public void cancel() {
        cancelled.set(true);
    }
    
    public boolean isCancelled() {
        return cancelled.get();
    }
}

public class BossRecruitmentServiceImpl {
    
    // æ³¨å…¥æˆ–ä¼ é€’ TaskContext
    private TaskContext taskContext;
    
    public List<JobDTO> collectJobs() {
        for (String cityCode : cityCodes) {
            if (taskContext.isCancelled()) { // âœ… æ£€æŸ¥ç‚¹
                log.warn("ä»»åŠ¡è¢«å–æ¶ˆ");
                return Collections.emptyList();
            }
            
            for (String keyword : keywords) {
                if (taskContext.isCancelled()) { // âœ… æ£€æŸ¥ç‚¹
                    log.warn("ä»»åŠ¡è¢«å–æ¶ˆ");
                    return Collections.emptyList();
                }
                collectJobsByCity(cityCode, keyword);
            }
        }
    }
}
```

**âœ… ä¼˜ç‚¹**ï¼š
- çº¿ç¨‹å®‰å…¨ï¼ˆè™½ç„¶ volatile ä¹Ÿå¤Ÿç”¨ï¼‰
- å¯ä»¥æä¾› CAS æ“ä½œ
- å¯ä»¥ä¸å…¶ä»–çŠ¶æ€ç»„åˆ

**âŒ ç¼ºç‚¹**ï¼š
- éœ€è¦ä¼ é€’ TaskContext
- ç¨å¾®å¤æ‚ä¸€äº›

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… éœ€è¦ CAS æ“ä½œçš„åœºæ™¯
- âœ… å·²æœ‰ TaskContext ä¼ é€’æœºåˆ¶

---

### æ–¹æ¡ˆ 4: æ··åˆæ–¹æ¡ˆ - Thread.interrupt() + è‡ªå®šä¹‰æ ‡å¿— â­â­ æœ€ä½³å®è·µ

**ç»“åˆä¸¤è€…ä¼˜ç‚¹ï¼Œæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ**

```java
public class TaskExecutor {
    
    private static class TaskContext {
        final Task task;
        final Future<Task> future;
        final Thread executingThread;
        final AtomicBoolean cancelled = new AtomicBoolean(false);
        
        public void cancel() {
            cancelled.set(true);
        }
        
        public boolean isCancelled() {
            return cancelled.get() || Thread.currentThread().isInterrupted();
        }
    }
    
    public boolean cancelTask(String executionId) {
        TaskContext context = runningTasks.get(executionId);
        if (context == null) {
            return false;
        }
        
        // 1. è®¾ç½®å–æ¶ˆæ ‡å¿—
        context.cancel();
        
        // 2. ä¸­æ–­çº¿ç¨‹
        if (context.executingThread != null) {
            context.executingThread.interrupt();
        }
        
        // 3. å–æ¶ˆFuture
        if (context.future != null) {
            context.future.cancel(true);
        }
        
        return true;
    }
}

public class BossRecruitmentServiceImpl {
    
    // å¯ä»¥é€šè¿‡ ThreadLocal ä¼ é€’ TaskContext
    private static final ThreadLocal<TaskContext> TASK_CONTEXT = new ThreadLocal<>();
    
    private boolean isCancelled() {
        TaskContext context = TASK_CONTEXT.get();
        if (context != null && context.isCancelled()) {
            return true;
        }
        return Thread.currentThread().isInterrupted();
    }
    
    public List<JobDTO> collectJobs() {
        for (String cityCode : cityCodes) {
            if (isCancelled()) { // âœ… ç»Ÿä¸€æ£€æŸ¥ç‚¹
                log.warn("ä»»åŠ¡è¢«å–æ¶ˆ");
                return Collections.emptyList();
            }
            
            for (String keyword : keywords) {
                if (isCancelled()) { // âœ… ç»Ÿä¸€æ£€æŸ¥ç‚¹
                    log.warn("ä»»åŠ¡è¢«å–æ¶ˆ");
                    return Collections.emptyList();
                }
                collectJobsByCity(cityCode, keyword);
            }
        }
    }
}
```

**âœ… ä¼˜ç‚¹**ï¼š
- ç»“åˆä¸¤ç§æ–¹æ¡ˆä¼˜ç‚¹
- æ—¢èƒ½ä¸­æ–­é˜»å¡æ“ä½œï¼Œåˆèƒ½å¿«é€Ÿæ£€æŸ¥
- ä¸å¼ºåˆ¶ä½¿ç”¨å¼‚å¸¸

**âŒ ç¼ºç‚¹**ï¼š
- ç¨å¾®å¤æ‚ä¸€äº›
- éœ€è¦ç»´æŠ¤ä¸¤ç§çŠ¶æ€

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… ç”Ÿäº§ç¯å¢ƒ
- âœ… éœ€è¦å¿«é€Ÿå“åº”å–æ¶ˆ
- âœ… åŒæ—¶æœ‰é˜»å¡å’Œéé˜»å¡æ“ä½œ

---

## ğŸ¯ ä½•æ—¶éœ€è¦æ·»åŠ å–æ¶ˆæ£€æŸ¥ç‚¹ï¼Ÿ

### âœ… å¿…é¡»æ·»åŠ æ£€æŸ¥çš„ä½ç½®

1. **é•¿æ—¶é—´è¿è¡Œçš„å¤–å±‚å¾ªç¯**
```java
// âœ… å¿…é¡»æ£€æŸ¥ - å¯èƒ½è¿è¡Œå‡ åæ¬¡
for (String cityCode : cityCodes) {
    checkCancellation();
    processCity(cityCode);
}
```

2. **åµŒå¥—å¾ªç¯çš„æ¯ä¸€å±‚**
```java
// âœ… å¿…é¡»æ£€æŸ¥ - å¤–å±‚å’Œå†…å±‚éƒ½æ£€æŸ¥
for (String city : cities) {
    checkCancellation(); // å¤–å±‚
    
    for (String keyword : keywords) {
        checkCancellation(); // å†…å±‚
        search(city, keyword);
    }
}
```

3. **å¤§æ•°æ®é›†çš„å¤„ç†**
```java
// âœ… å¿…é¡»æ£€æŸ¥ - å¯èƒ½æœ‰æˆåƒä¸Šä¸‡æ¡
for (JobDTO job : jobs) {
    checkCancellation();
    deliverJob(job);
}
```

4. **é˜»å¡æ“ä½œå‰**
```java
// âœ… å¿…é¡»æ£€æŸ¥ - é¿å…ä¸å¿…è¦çš„ç­‰å¾…
checkCancellation();
Thread.sleep(15000); // 15ç§’ç­‰å¾…
```

### âš ï¸ å¯é€‰æ£€æŸ¥çš„ä½ç½®

5. **å¿«é€Ÿå¾ªç¯ï¼ˆä½†å¯ä»¥å®šæœŸæ£€æŸ¥ï¼‰**
```java
// âš ï¸ å¯é€‰ - å¯ä»¥æ¯Næ¬¡æ£€æŸ¥ä¸€æ¬¡
for (int i = 0; i < 10000; i++) {
    if (i % 100 == 0) { // æ¯100æ¬¡æ£€æŸ¥ä¸€æ¬¡
        checkCancellation();
    }
    quickOperation();
}
```

6. **çŸ­å¾ªç¯ï¼ˆ< 10æ¬¡è¿­ä»£ï¼‰**
```java
// âš ï¸ å¯é€‰ - å¦‚æœè¿­ä»£å¾ˆå¿«å®Œæˆ
for (int i = 0; i < 5; i++) {
    quickOperation(); // å¯ä»¥ä¸æ£€æŸ¥
}
```

### âŒ ä¸éœ€è¦æ£€æŸ¥çš„ä½ç½®

7. **æ–¹æ³•å†…éƒ¨çš„å±€éƒ¨å¾ªç¯ï¼ˆéå¸¸å¿«ï¼‰**
```java
// âŒ ä¸éœ€è¦ - å±€éƒ¨å¤„ç†ï¼Œç¬é—´å®Œæˆ
private String formatData(String data) {
    StringBuilder sb = new StringBuilder();
    for (char c : data.toCharArray()) {
        sb.append(c); // éå¸¸å¿«
    }
    return sb.toString();
}
```

8. **å·²ç»æœ‰å…¶ä»–é€€å‡ºæœºåˆ¶çš„å¾ªç¯**
```java
// âŒ ä¸éœ€è¦ - å·²æœ‰è¶…æ—¶æœºåˆ¶
while (retryCount < 3) {
    try {
        return doOperation();
    } catch (Exception e) {
        retryCount++;
    }
}
```

---

## ğŸ“ æ£€æŸ¥é¢‘ç‡çš„æƒè¡¡

### ç­–ç•¥ 1: æ¯æ¬¡éƒ½æ£€æŸ¥ - æœ€å¿«å“åº”

```java
for (JobDTO job : jobs) {
    checkCancellation(); // æ¯æ¬¡éƒ½æ£€æŸ¥
    deliverJob(job);     // å¯èƒ½å¾ˆæ…¢
}
```

**é€‚ç”¨äº**ï¼š
- æ¯æ¬¡è¿­ä»£è€—æ—¶è¾ƒé•¿ï¼ˆ> 1ç§’ï¼‰
- ç”¨æˆ·æœŸæœ›å¿«é€Ÿå–æ¶ˆ
- å¾ªç¯æ¬¡æ•°ä¸å¤šï¼ˆ< 1000ï¼‰

### ç­–ç•¥ 2: å®šæœŸæ£€æŸ¥ - å¹³è¡¡æ€§èƒ½

```java
for (int i = 0; i < 100000; i++) {
    if (i % 1000 == 0) { // æ¯1000æ¬¡æ£€æŸ¥ä¸€æ¬¡
        checkCancellation();
    }
    fastOperation();     // å¾ˆå¿«
}
```

**é€‚ç”¨äº**ï¼š
- æ¯æ¬¡è¿­ä»£å¾ˆå¿«ï¼ˆ< 1msï¼‰
- å¾ªç¯æ¬¡æ•°å¾ˆå¤šï¼ˆ> 10000ï¼‰
- å¯ä»¥æ¥å—ä¸€å®šå»¶è¿Ÿ

### ç­–ç•¥ 3: å¤–å±‚æ£€æŸ¥ - æœ€å°ä¾µå…¥

```java
for (String city : cities) {
    checkCancellation(); // åªåœ¨å¤–å±‚æ£€æŸ¥
    
    for (String keyword : keywords) {
        // ä¸æ£€æŸ¥ - å†…å±‚å¾ªç¯å¾ˆå¿«
        search(city, keyword);
    }
}
```

**é€‚ç”¨äº**ï¼š
- å†…å±‚å¾ªç¯å¾ˆå¿«å®Œæˆ
- å¤–å±‚å¾ªç¯æ¬¡æ•°è¶³å¤Ÿå¤š
- å¸Œæœ›æœ€å°åŒ–æ£€æŸ¥å¼€é”€

---

## ğŸ¨ å®é™…åº”ç”¨å»ºè®®

### å¯¹äºä½ çš„é¡¹ç›®ï¼ˆBoss ç›´è˜é‡‡é›†æŠ•é€’ï¼‰

#### é‡‡é›†é˜¶æ®µ - æ£€æŸ¥é¢‘ç‡ï¼šä¸­ç­‰
```java
public List<JobDTO> collectJobs() {
    for (String cityCode : cityCodes) {           // âœ… å¤–å±‚æ£€æŸ¥ï¼ˆå‡ ä¸ªåŸå¸‚ï¼‰
        checkCancellation();
        
        for (String keyword : keywords) {          // âœ… å†…å±‚æ£€æŸ¥ï¼ˆå‡ åä¸ªå…³é”®è¯ï¼‰
            checkCancellation();
            collectJobsByCity(cityCode, keyword);  // å¯èƒ½è€—æ—¶å‡ ç§’
        }
    }
}

private int loadJobsWithScroll(Page page) {
    while (unchangedCount < 2) {                   // âœ… æ»šåŠ¨å‰æ£€æŸ¥ï¼ˆæ»šåŠ¨å‡ æ¬¡ï¼‰
        checkCancellation();
        scrollPage();                              // æ¯æ¬¡æ»šåŠ¨è€—æ—¶2-3ç§’
    }
}
```

#### æŠ•é€’é˜¶æ®µ - æ£€æŸ¥é¢‘ç‡ï¼šé«˜
```java
public int deliverJobs(List<JobDTO> jobs) {
    for (JobDTO job : jobs) {                      // âœ… æ¯ä¸ªå²—ä½æ£€æŸ¥ï¼ˆå‡ ååˆ°å‡ ç™¾ä¸ªï¼‰
        checkCancellation();
        deliverSingleJob(job);                     // æ¯ä¸ªè€—æ—¶15ç§’
        // æŠ•é€’é—´éš”å·²ç»åœ¨ sleep ä¸­è‡ªç„¶æ”¯æŒä¸­æ–­
    }
}
```

#### é»‘åå•æ›´æ–° - æ£€æŸ¥é¢‘ç‡ï¼šä½
```java
private void updateBlacklistFromChat() {
    while (!shouldBreak) {                         // âœ… å¤–å±‚æ£€æŸ¥
        if (Thread.currentThread().isInterrupted()) {
            break;
        }
        
        for (int i = 0; i < itemCount; i++) {     // âš ï¸ å†…å±‚é€‰æ‹©æ€§æ£€æŸ¥
            if (i % 10 == 0) {                     // æ¯10æ¡æ£€æŸ¥ä¸€æ¬¡
                if (Thread.currentThread().isInterrupted()) {
                    break;
                }
            }
            processItem(i);                        // å¾ˆå¿«
        }
    }
}
```

---

## ğŸ”§ æ”¹è¿›å»ºè®®ï¼šå¼•å…¥ç²’åº¦æ§åˆ¶

ä¸ºäº†é¿å…åœ¨æ‰€æœ‰åœ°æ–¹éƒ½æ·»åŠ æ£€æŸ¥ï¼Œå¯ä»¥å¼•å…¥**å¯é…ç½®çš„æ£€æŸ¥ç²’åº¦**ï¼š

```java
public enum CancellationCheckLevel {
    NONE,       // ä¸æ£€æŸ¥ï¼ˆç”¨äºä¸å¯ä¸­æ–­çš„å…³é”®æ“ä½œï¼‰
    LOW,        // ä½é¢‘æ£€æŸ¥ï¼ˆå¤–å±‚å¾ªç¯ï¼‰
    MEDIUM,     // ä¸­é¢‘æ£€æŸ¥ï¼ˆå…³é”®æ“ä½œå‰ï¼‰
    HIGH        // é«˜é¢‘æ£€æŸ¥ï¼ˆæ¯æ¬¡è¿­ä»£ï¼‰
}

public class TaskConfig {
    private CancellationCheckLevel checkLevel = CancellationCheckLevel.MEDIUM;
    
    // getter/setter
}

public class BossRecruitmentServiceImpl {
    
    private int checkCounter = 0;
    
    private boolean shouldCheck(CancellationCheckLevel level) {
        switch (level) {
            case NONE:
                return false;
            case LOW:
                return ++checkCounter % 100 == 0;
            case MEDIUM:
                return ++checkCounter % 10 == 0;
            case HIGH:
                return true;
            default:
                return false;
        }
    }
    
    private void checkCancellationIfNeeded() throws InterruptedException {
        TaskConfig config = getCurrentTaskConfig();
        if (shouldCheck(config.getCheckLevel())) {
            checkInterrupted();
        }
    }
}
```

---

## ğŸ“Š æ€»ç»“å¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | å“åº”é€Ÿåº¦ | ä»£ç ä¾µå…¥ | å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|------|---------|---------|--------|---------|
| Thread.interrupt() | â­â­â­ | â­â­â­ | â­â­ | æ ‡å‡†åº”ç”¨ï¼Œæœ‰é˜»å¡æ“ä½œ |
| volatile boolean | â­â­ | â­â­ | â­ | ç®€å•åœºæ™¯ï¼Œæ— é˜»å¡ |
| AtomicBoolean | â­â­ | â­â­â­ | â­â­ | éœ€è¦ CAS æ“ä½œ |
| æ··åˆæ–¹æ¡ˆ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | ç”Ÿäº§ç¯å¢ƒï¼Œæœ€ä½³å®è·µ |

## ğŸ¯ æœ€ç»ˆå»ºè®®

**å¯¹äºä½ çš„é¡¹ç›®**ï¼Œå½“å‰çš„ `Thread.interrupt()` æ–¹æ¡ˆå·²ç»è¶³å¤Ÿå¥½ï¼Œä½†å¯ä»¥ä¼˜åŒ–ï¼š

1. **ä¿æŒå½“å‰æ–¹æ¡ˆ** - å·²ç»å®ç°çš„æ£€æŸ¥ç‚¹å·²ç»è¶³å¤Ÿ
2. **ä¸æ˜¯æ‰€æœ‰å¾ªç¯éƒ½éœ€è¦** - åªåœ¨å…³é”®ä½ç½®æ£€æŸ¥å³å¯
3. **è€ƒè™‘ç²’åº¦æ§åˆ¶** - å¦‚æœè§‰å¾—æ£€æŸ¥å¤ªå¤šï¼Œå¯ä»¥å¼•å…¥æ£€æŸ¥é¢‘ç‡æ§åˆ¶
4. **æœªæ¥å¯ä»¥å‡çº§** - å¦‚æœéœ€è¦æ›´ç²¾ç»†æ§åˆ¶ï¼Œå¯ä»¥æ”¹ä¸ºæ··åˆæ–¹æ¡ˆ

**æ£€æŸ¥ç‚¹ä¼˜å…ˆçº§**ï¼š
- ğŸ”´ å¿…é¡»ï¼šå¤–å±‚å¾ªç¯ã€é•¿æ—¶é—´æ“ä½œå‰ã€å¤§æ•°æ®é›†å¤„ç†
- ğŸŸ¡ æ¨èï¼šåµŒå¥—å¾ªç¯å†…å±‚ã€é˜»å¡æ“ä½œå‰
- ğŸŸ¢ å¯é€‰ï¼šå¿«é€Ÿå¾ªç¯ï¼ˆå¯å®šæœŸæ£€æŸ¥ï¼‰
- âšª ä¸éœ€è¦ï¼šå±€éƒ¨çŸ­å¾ªç¯ã€å·²æœ‰é€€å‡ºæœºåˆ¶çš„å¾ªç¯

