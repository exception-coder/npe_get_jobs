# ğŸš¨ ç´§æ€¥ä¿®å¤ï¼šRoute æ‹¦æˆªå™¨å¤±æ•ˆé—®é¢˜

## é—®é¢˜æè¿°

ä¹‹å‰çš„ Route æ‹¦æˆªå™¨**å®Œå…¨æ²¡æœ‰ç”Ÿæ•ˆ**ï¼Œå¯¼è‡´æ¶æ„ JS æ–‡ä»¶ä»ç„¶è¢«åŠ è½½å¹¶æ‰§è¡Œå†…å­˜ç‚¸å¼¹ã€‚

## æ ¹æœ¬åŸå› 

### 1. åŒ¹é…æ¨¡å¼é”™è¯¯

**é”™è¯¯çš„ä»£ç **ï¼š
```java
context.route("**/*security*/geek/index.js*", route -> {
    // ...
});
```

**é—®é¢˜**ï¼š
- Playwright çš„ route æ–¹æ³•ä½¿ç”¨çš„æ˜¯ **glob æ¨¡å¼**ï¼Œä¸æ˜¯æ­£åˆ™è¡¨è¾¾å¼
- `**/*security*/geek/index.js*` è¿™ä¸ªæ¨¡å¼**æ— æ³•åŒ¹é…**å®é™…çš„ URL
- å®é™… URLï¼š`https://static.zhipin.com/zhipin-geek/security/103/geek/index.js`

### 2. åªæ‹¦æˆªäº†ä¸€ä¸ªæ–‡ä»¶

**é—æ¼çš„å…³é”®æ–‡ä»¶**ï¼š
- `main.js` - è¿™ä¸ªæ–‡ä»¶ä¹ŸåŒ…å«å†…å­˜ç‚¸å¼¹ä»£ç ï¼

ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ° `main.js` çš„æœ€åéƒ¨åˆ†ï¼š
```javascript
try {
    $.ajax({
        url: "/wapi/zpCommon/toggle/all",
        type: "POST",
        data: {system: "9E2145704D3D49648DD85D6DDAC1CF0D"},
        success: function(e) {
            if (éªŒè¯å¤±è´¥) {
                t();  // è§¦å‘å†…å­˜ç‚¸å¼¹ï¼
            }
        },
        error: function() {
            t();  // è§¦å‘å†…å­˜ç‚¸å¼¹ï¼
        }
    });
} catch(e) {
    t();  // è§¦å‘å†…å­˜ç‚¸å¼¹ï¼
}

// t() å‡½æ•°å°±æ˜¯å†…å­˜ç‚¸å¼¹
function t() {
    // åˆ›å»ºå¤§é‡å¯¹è±¡æ¶ˆè€—å†…å­˜
    const a = [];
    for (let t = 0; t < 1000; t++) {
        var n = {};
        for (let e = 0; e < 1000; e++)
            n[`key_${t}_` + e] = "x".repeat(1000);
        a.push(n);
    }
    // ... æ›´å¤šå†…å­˜æ¶ˆè€—ä»£ç 
    // æœ€åè·³è½¬åˆ° about:blank
}
```

## ä¿®å¤æ–¹æ¡ˆ

### ä½¿ç”¨ Lambda è¡¨è¾¾å¼ + å­—ç¬¦ä¸²åŒ…å«åˆ¤æ–­

**æ­£ç¡®çš„ä»£ç **ï¼š
```java
context.route(route -> {
    String url = route.request().url();
    
    // æ‹¦æˆª security/103/geek/index.js - åŒ…å«ç¯å¢ƒæ£€æµ‹å’Œå†…å­˜ç‚¸å¼¹
    if (url.contains("/security/") && url.contains("/geek/index.js")) {
        log.warn("ğŸš« [SECURITY] å·²é˜»æ­¢æ¶æ„ JS æ–‡ä»¶åŠ è½½: {}", url);
        route.fulfill(new Route.FulfillOptions()
                .setStatus(200)
                .setContentType("application/javascript; charset=utf-8")
                .setBody("// Security detection script blocked\nconsole.log('[DEFENSE] Security script neutralized');"));
        return;
    }
    
    // æ‹¦æˆª main.js - åŒ…å«å†…å­˜ç‚¸å¼¹è§¦å‘é€»è¾‘
    if (url.contains("/geek/js/main.js")) {
        log.warn("ğŸš« [SECURITY] å·²é˜»æ­¢åŒ…å«å†…å­˜ç‚¸å¼¹çš„ main.js: {}", url);
        route.fulfill(new Route.FulfillOptions()
                .setStatus(200)
                .setContentType("application/javascript; charset=utf-8")
                .setBody("// Main.js with memory bomb blocked\nconsole.log('[DEFENSE] Main.js neutralized');"));
        return;
    }
    
    // å…¶ä»–è¯·æ±‚æ­£å¸¸é€šè¿‡
    route.resume();
});
```

### ä¸ºä»€ä¹ˆè¿™æ ·ä¿®å¤ï¼Ÿ

1. **Lambda è¡¨è¾¾å¼**ï¼šå¯ä»¥åœ¨å›è°ƒä¸­æ‰§è¡Œå¤æ‚çš„é€»è¾‘åˆ¤æ–­
2. **å­—ç¬¦ä¸²åŒ…å«åˆ¤æ–­**ï¼šæ¯” glob æ¨¡å¼æ›´çµæ´»ã€æ›´å¯é 
3. **æ‹¦æˆªå¤šä¸ªæ–‡ä»¶**ï¼šåŒæ—¶æ‹¦æˆª `index.js` å’Œ `main.js`
4. **æ˜ç¡®çš„ return**ï¼šæ‹¦æˆªåç«‹å³è¿”å›ï¼Œä¸æ‰§è¡Œåç»­ä»£ç 
5. **route.resume()**ï¼šå…¶ä»–è¯·æ±‚æ­£å¸¸é€šè¿‡ï¼Œä¸å½±å“é¡µé¢åŠŸèƒ½

## éªŒè¯æ–¹æ³•

### 1. é‡å¯åº”ç”¨åè§‚å¯Ÿæ—¥å¿—

**æœŸæœ›çœ‹åˆ°**ï¼š
```log
[WARN] ğŸš« [SECURITY] å·²é˜»æ­¢æ¶æ„ JS æ–‡ä»¶åŠ è½½: https://static.zhipin.com/zhipin-geek/security/103/geek/index.js
[WARN] ğŸš« [SECURITY] å·²é˜»æ­¢åŒ…å«å†…å­˜ç‚¸å¼¹çš„ main.js: https://static.zhipin.com/zhipin-geek-seo/v5404/web/geek/js/main.js
```

**ä¸åº”è¯¥çœ‹åˆ°**ï¼š
```log
[JS] 200 https://static.zhipin.com/zhipin-geek/security/103/geek/index.js  â† è¿™è¡¨ç¤ºæ–‡ä»¶è¢«åŠ è½½äº†ï¼
[CONSOLE] clear console.clear  â† è¿™è¡¨ç¤ºå†…å­˜ç‚¸å¼¹è¢«è§¦å‘äº†ï¼
[CONSOLE] table [Object, Object, ...]  â† è¿™è¡¨ç¤ºå†…å­˜ç‚¸å¼¹æ­£åœ¨æ‰§è¡Œï¼
```

### 2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

**æœŸæœ›çœ‹åˆ°**ï¼š
```javascript
[DEFENSE] Security script neutralized
[DEFENSE] Main.js neutralized
```

**ä¸åº”è¯¥çœ‹åˆ°**ï¼š
```javascript
console.clear()  // âŒ
console.table()  // âŒ
```

### 3. éªŒè¯é¡µé¢åŠŸèƒ½

- âœ… é¡µé¢æ­£å¸¸åŠ è½½ï¼Œä¸è·³è½¬åˆ° `about:blank`
- âœ… å¯ä»¥æ­£å¸¸æœç´¢èŒä½
- âœ… å¯ä»¥æŸ¥çœ‹èŒä½è¯¦æƒ…
- âœ… é¡µé¢ä¸ä¼šå´©æºƒæˆ–å¡æ­»

## æŠ€æœ¯ç»†èŠ‚

### Playwright Route API çš„æ­£ç¡®ç”¨æ³•

#### æ–¹å¼ 1ï¼šGlob æ¨¡å¼ï¼ˆç®€å•åœºæ™¯ï¼‰
```java
context.route("**/*.js", route -> {
    // æ‹¦æˆªæ‰€æœ‰ JS æ–‡ä»¶
});
```

#### æ–¹å¼ 2ï¼šLambda è¡¨è¾¾å¼ï¼ˆå¤æ‚åœºæ™¯ï¼‰âœ… **æ¨è**
```java
context.route(route -> {
    String url = route.request().url();
    if (url.contains("æŸä¸ªç‰¹å¾")) {
        route.fulfill(...);  // æ‹¦æˆª
        return;
    }
    route.resume();  // æ”¾è¡Œ
});
```

#### æ–¹å¼ 3ï¼šæ­£åˆ™è¡¨è¾¾å¼ï¼ˆéœ€è¦è½¬æ¢ï¼‰
```java
context.route(route -> {
    String url = route.request().url();
    if (url.matches(".*security.*geek.*index\\.js.*")) {
        route.fulfill(...);
        return;
    }
    route.resume();
});
```

### ä¸ºä»€ä¹ˆ Glob æ¨¡å¼å¤±æ•ˆäº†ï¼Ÿ

Playwright çš„ glob æ¨¡å¼æœ‰ä¸€äº›é™åˆ¶ï¼š
- `*` åŒ¹é…å•ä¸ªè·¯å¾„æ®µï¼ˆä¸åŒ…å« `/`ï¼‰
- `**` åŒ¹é…å¤šä¸ªè·¯å¾„æ®µï¼ˆåŒ…å« `/`ï¼‰
- ä½†æ˜¯å¯¹äºå¤æ‚çš„ URL ç»“æ„ï¼Œå¾ˆå®¹æ˜“å†™é”™

**ç¤ºä¾‹**ï¼š
```
URL: https://static.zhipin.com/zhipin-geek/security/103/geek/index.js

âŒ é”™è¯¯ï¼š**/*security*/geek/index.js*
   - è¿™ä¸ªæ¨¡å¼æœŸæœ› security å‰é¢åªæœ‰ä¸€ä¸ªè·¯å¾„æ®µ
   - ä½†å®é™…ä¸Š security å‰é¢æœ‰ zhipin-geek

âœ… æ­£ç¡®ï¼š**/security/**/geek/index.js
   - ä½¿ç”¨ ** åŒ¹é…å¤šä¸ªè·¯å¾„æ®µ
   
âœ… æ›´å¥½ï¼šä½¿ç”¨ Lambda + contains()
   - æ›´çµæ´»ï¼Œæ›´å®¹æ˜“ç†è§£
```

## Boss ç›´è˜çš„å†…å­˜ç‚¸å¼¹æœºåˆ¶

### è§¦å‘æµç¨‹

```
1. é¡µé¢åŠ è½½ main.js
   â†“
2. main.js å‘èµ· AJAX è¯·æ±‚åˆ° /wapi/zpCommon/toggle/all
   â†“
3. æ£€æŸ¥å“åº”ç»“æœ
   â†“
4. å¦‚æœéªŒè¯å¤±è´¥ï¼ˆæˆ–è¯·æ±‚å¤±è´¥ï¼‰
   â†“
5. æ‰§è¡Œ t() å‡½æ•°ï¼ˆå†…å­˜ç‚¸å¼¹ï¼‰
   â†“
6. åˆ›å»ºå¤§é‡å¯¹è±¡æ¶ˆè€—å†…å­˜
   â†“
7. ç–¯ç‹‚è°ƒç”¨ console.clear() å’Œ console.table()
   â†“
8. æµè§ˆå™¨å†…å­˜è€—å°½ï¼Œé¡µé¢å´©æºƒ
   â†“
9. è·³è½¬åˆ° about:blank
```

### å†…å­˜ç‚¸å¼¹ä»£ç åˆ†æ

```javascript
function t() {
    // ç¬¬ä¸€æ³¢ï¼šåˆ›å»º 1000 x 1000 ä¸ªå¯¹è±¡
    const a = [];
    for (let t = 0; t < 1000; t++) {
        var n = {};
        for (let e = 0; e < 1000; e++)
            n[`key_${t}_` + e] = "x".repeat(1000);  // æ¯ä¸ªå€¼ 1KB
        a.push(n);
    }
    // æ€»è®¡ï¼š1000 * 1000 * 1KB = 1GB å†…å­˜ï¼
    
    // ç¬¬äºŒæ³¢ï¼šåˆ›å»º 100 ä¸ªå¤§æ•°ç»„
    var t = [];
    for (let e = 0; e < 100; e++)
        t.push(new Array(10000).fill("å¾ˆé•¿çš„å­—ç¬¦ä¸²"));
    a.push(...t);
    
    // ç¬¬ä¸‰æ³¢ï¼šé€’å½’è°ƒç”¨ï¼ˆæ ˆæº¢å‡ºï¼‰
    const o = (e) => {
        if (!(e <= 0)) {
            var t = {};
            for (let e = 0; e < 100; e++)
                t["nested_" + e] = "x".repeat(10000);
            a.push(t);
            o(e - 1);  // é€’å½’
        }
    };
    o(100);
    
    // ç¬¬å››æ³¢ï¼šå®šæ—¶å™¨æŒç»­æ¶ˆè€—å†…å­˜
    const s = window.setInterval(() => {
        try {
            var t = [];
            for (let e = 0; e < 1000; e++)
                t.push(new Array(10000).fill("x"));
            a.push(...t);
        } catch(e) {
            window.clearInterval(s);
        }
    }, 10);  // æ¯ 10ms æ‰§è¡Œä¸€æ¬¡ï¼
}
```

**å¨åŠ›**ï¼š
- ç¬¬ä¸€æ³¢å°±æ¶ˆè€— 1GB å†…å­˜
- å®šæ—¶å™¨æ¯ 10ms æ¶ˆè€—æ›´å¤šå†…å­˜
- é€’å½’è°ƒç”¨å¯¼è‡´æ ˆæº¢å‡º
- æœ€ç»ˆæµè§ˆå™¨å´©æºƒ

## é˜²å¾¡ç­–ç•¥æ€»ç»“

### å¤šå±‚é˜²å¾¡ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Route æ‹¦æˆªå™¨ - é˜»æ­¢æ¶æ„ JS æ–‡ä»¶åŠ è½½ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰âœ…      â”‚
â”‚    - æ‹¦æˆª security/103/geek/index.js                         â”‚
â”‚    - æ‹¦æˆª main.js                                            â”‚
â”‚    â†“ å¦‚æœ JS æ–‡ä»¶ç»•è¿‡äº†æ‹¦æˆª                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. AJAX æ‹¦æˆªå™¨ - æ‹¦æˆªéªŒè¯æ¥å£è¯·æ±‚ï¼ˆç¬¬äºŒé“é˜²çº¿ï¼‰âœ…           â”‚
â”‚    - æ‹¦æˆª /wapi/zpCommon/toggle/all                          â”‚
â”‚    - è¿”å›ä¼ªé€ çš„æˆåŠŸå“åº”                                      â”‚
â”‚    â†“ å¦‚æœæ¥å£è¯·æ±‚ç»•è¿‡äº†æ‹¦æˆª                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. Stealth è„šæœ¬ - éšè— Playwright ç‰¹å¾ï¼ˆåŸºç¡€é˜²å¾¡ï¼‰âœ…        â”‚
â”‚    - éšè— navigator.webdriver                                â”‚
â”‚    - ä¼ªé€  window.chrome                                      â”‚
â”‚    - ä¼ªé€  navigator.plugins                                  â”‚
â”‚    â†“ å¦‚æœç‰¹å¾æ£€æµ‹ç»•è¿‡äº†éšè—                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Blank é˜»æ­¢å™¨ - é˜»æ­¢ about:blank è·³è½¬ï¼ˆæœ€åé˜²çº¿ï¼‰âœ…       â”‚
â”‚    - Hook window.location                                    â”‚
â”‚    - Hook document.location                                  â”‚
â”‚    - Hook window.open                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç»éªŒæ•™è®­

### 1. ä¸è¦ç›²ç›®ç›¸ä¿¡ Glob æ¨¡å¼

- Glob æ¨¡å¼å®¹æ˜“å†™é”™
- å¯¹äºå¤æ‚çš„ URLï¼Œä½¿ç”¨ Lambda + contains() æ›´å¯é 

### 2. è¦å…¨é¢åˆ†ææ‰€æœ‰å¯ç–‘æ–‡ä»¶

- ä¸è¦åªå…³æ³¨ä¸€ä¸ªæ–‡ä»¶
- Boss ç›´è˜æœ‰å¤šä¸ªæ–‡ä»¶åŒ…å«å†…å­˜ç‚¸å¼¹
- éœ€è¦é€ä¸ªåˆ†æå¹¶æ‹¦æˆª

### 3. éªŒè¯æ‹¦æˆªæ˜¯å¦ç”Ÿæ•ˆ

- ä¸è¦å‡è®¾ä»£ç ä¼šæ­£å¸¸å·¥ä½œ
- å¿…é¡»é€šè¿‡æ—¥å¿—éªŒè¯æ‹¦æˆªæ˜¯å¦çœŸçš„ç”Ÿæ•ˆ
- çœ‹åˆ° `[JS] 200 xxx.js` å°±è¯´æ˜æ‹¦æˆªå¤±è´¥äº†

### 4. ç†è§£æ”»å‡»æœºåˆ¶

- ä¸è¦åªæ˜¯ç›²ç›®é˜²å¾¡
- è¦ç†è§£å¯¹æ–¹çš„æ”»å‡»æœºåˆ¶
- æ‰èƒ½æ‰¾åˆ°æœ€æœ‰æ•ˆçš„é˜²å¾¡ç‚¹

## åç»­ä¼˜åŒ–

### 1. æ·»åŠ æ›´å¤šæ—¥å¿—

```java
context.route(route -> {
    String url = route.request().url();
    
    // è®°å½•æ‰€æœ‰ JS æ–‡ä»¶è¯·æ±‚
    if (url.endsWith(".js")) {
        log.debug("JS æ–‡ä»¶è¯·æ±‚: {}", url);
    }
    
    // ... æ‹¦æˆªé€»è¾‘
});
```

### 2. å»ºç«‹ JS æ–‡ä»¶é»‘åå•

```java
private static final Set<String> JS_BLACKLIST = Set.of(
    "/security/",
    "/geek/js/main.js",
    // å¯ä»¥ç»§ç»­æ·»åŠ 
);
```

### 3. è‡ªåŠ¨åŒ–æµ‹è¯•

- å®šæœŸè¿è¡Œæµ‹è¯•ï¼ŒéªŒè¯æ‹¦æˆªæ˜¯å¦ç”Ÿæ•ˆ
- ç›‘æ§æ—¥å¿—ï¼Œå‘ç°æ–°çš„åçˆ¬è™«æ‰‹æ®µ

---

**ä¿®å¤æ—¶é—´**ï¼š2026-01-23 02:10:00  
**ä¿®å¤äººå‘˜**ï¼šAI Assistant  
**ç‰ˆæœ¬**ï¼šv2.0 - ç´§æ€¥ä¿®å¤ç‰ˆ

