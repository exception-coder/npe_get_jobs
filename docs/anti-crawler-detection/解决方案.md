# Boss 直聘反爬虫检测解决方案

## 问题分析

### 1. 检测到的问题
- ✅ 页面被劫持到 `about:blank`
- ✅ JavaScript Hook 无法阻止跳转
- ✅ Route API 无法拦截（因为 about:blank 不触发网络请求）
- ✅ 我们的特征检测脚本本身就报错了

### 2. Boss 直聘的检测方式

根据分析，Boss 直聘很可能检测以下特征：

#### A. **navigator.webdriver**
```javascript
if (navigator.webdriver === true) {
    // 检测到自动化工具
    location.href = 'about:blank';
}
```

#### B. **window.chrome 对象缺失**
```javascript
if (!window.chrome || !window.chrome.runtime) {
    // 不是真正的 Chrome 浏览器
    location.href = 'about:blank';
}
```

#### C. **navigator.plugins 为空**
```javascript
if (navigator.plugins.length === 0) {
    // 无插件，可疑
    location.href = 'about:blank';
}
```

#### D. **permissions API 异常**
```javascript
try {
    await navigator.permissions.query({name: 'notifications'});
} catch(e) {
    // permissions API 异常
    location.href = 'about:blank';
}
```

## 解决方案

### 方案 1：使用 Playwright 的 stealth 插件（推荐）⭐

安装 `playwright-extra` 和 `puppeteer-extra-plugin-stealth`：

```xml
<!-- pom.xml -->
<dependency>
    <groupId>io.github.bonigarcia</groupId>
    <artifactId>webdrivermanager</artifactId>
    <version>5.6.2</version>
</dependency>
```

但 Playwright Java 版本没有直接的 stealth 插件，我们需要手动实现。

### 方案 2：手动隐藏所有 Playwright 特征（当前方案）

#### 步骤 1：修复并完善隐藏脚本

在 `PlaywrightService.createNewContext()` 中添加完整的隐藏脚本：

```java
// 1. 隐藏 webdriver
context.addInitScript("Object.defineProperty(navigator, 'webdriver', { get: () => undefined });");

// 2. 伪造 window.chrome 对象
context.addInitScript(
    "window.chrome = {" +
    "  runtime: {}," +
    "  loadTimes: function() {}," +
    "  csi: function() {}," +
    "  app: {}" +
    "};"
);

// 3. 伪造 navigator.plugins
context.addInitScript(
    "Object.defineProperty(navigator, 'plugins', {" +
    "  get: () => [1, 2, 3, 4, 5]" +
    "});"
);

// 4. 伪造 navigator.languages
context.addInitScript(
    "Object.defineProperty(navigator, 'languages', {" +
    "  get: () => ['zh-CN', 'zh', 'en']" +
    "});"
);

// 5. 修复 permissions API
context.addInitScript(
    "const originalQuery = window.navigator.permissions.query;" +
    "window.navigator.permissions.query = (parameters) => (" +
    "  parameters.name === 'notifications' ?" +
    "    Promise.resolve({ state: Notification.permission }) :" +
    "    originalQuery(parameters)" +
    ");"
);
```

#### 步骤 2：使用 Chrome DevTools Protocol (CDP) 隐藏特征

Playwright 支持 CDP，可以更底层地隐藏特征：

```java
// 在 createNewContext() 中
BrowserContext context = browser.newContext(new Browser.NewContextOptions()
    .setUserAgent(randomUserAgent)
    .setJavaScriptEnabled(true)
    .setBypassCSP(true)
    .setPermissions(List.of("geolocation", "notifications"))
    .setLocale("zh-CN")
    .setTimezoneId("Asia/Shanghai")
    .setViewportSize(1920, 1080)  // 设置真实的视口大小
    .setDeviceScaleFactor(1.0)    // 设置设备像素比
    .setHasTouch(false)           // 不是触摸设备
    .setIsMobile(false));         // 不是移动设备
```

### 方案 3：使用 undetected-chromedriver 的思路

参考 Python 的 `undetected-chromedriver`，核心思路是：

1. **修改 Chrome 二进制文件** - 移除自动化标识
2. **使用真实的 Chrome 配置文件** - 包含真实的插件、扩展
3. **注入脚本在页面加载前执行** - 确保在反爬虫脚本之前运行

### 方案 4：使用真实的 Chrome 用户数据目录

```java
browser = playwright.chromium().launch(new BrowserType.LaunchOptions()
    .setHeadless(false)
    .setChannel("chrome")  // 使用系统安装的 Chrome
    .setArgs(List.of(
        "--disable-blink-features=AutomationControlled",
        "--user-data-dir=/path/to/real/chrome/profile"  // 使用真实的 Chrome 配置
    ))
);
```

## 推荐实施步骤

### 第一步：完善隐藏脚本（立即实施）

1. 修复 `PlaywrightPageObserver.attachPlaywrightDetector()` 中的错误
2. 在 `PlaywrightService.createNewContext()` 中添加完整的伪造脚本
3. 移除会暴露特征的检测脚本

### 第二步：测试验证

1. 重启应用
2. 观察是否还会跳转到 `about:blank`
3. 检查控制台是否还有 `[PAGE_ERROR]`

### 第三步：如果还是被检测

考虑以下高级方案：
1. 使用 Chrome DevTools Protocol 更底层地修改
2. 使用真实的 Chrome 用户配置文件
3. 考虑使用代理 IP 池
4. 降低爬取频率，模拟真实用户行为

## 关键代码修改

### 1. 移除有问题的特征检测脚本

在 `PlaywrightService.createNewContext()` 中，**注释掉**：

```java
// 不要调用这个，它会暴露特征
// pageObserver.attachPlaywrightDetector(context);
```

### 2. 添加完整的隐藏脚本

```java
// 完整的隐藏脚本（一次性注入）
context.addInitScript(
    "// 1. 隐藏 webdriver\n" +
    "Object.defineProperty(navigator, 'webdriver', { get: () => undefined });\n" +
    "\n" +
    "// 2. 伪造 chrome 对象\n" +
    "window.chrome = { runtime: {}, loadTimes: function() {}, csi: function() {}, app: {} };\n" +
    "\n" +
    "// 3. 伪造 plugins\n" +
    "Object.defineProperty(navigator, 'plugins', { get: () => [1, 2, 3, 4, 5] });\n" +
    "\n" +
    "// 4. 伪造 languages\n" +
    "Object.defineProperty(navigator, 'languages', { get: () => ['zh-CN', 'zh', 'en'] });\n" +
    "\n" +
    "// 5. 修复 permissions\n" +
    "const originalQuery = window.navigator.permissions.query;\n" +
    "window.navigator.permissions.query = (parameters) => (\n" +
    "  parameters.name === 'notifications' ?\n" +
    "    Promise.resolve({ state: Notification.permission }) :\n" +
    "    originalQuery(parameters)\n" +
    ");\n" +
    "\n" +
    "console.log('[STEALTH] All Playwright features hidden');"
);
```

## 预期效果

实施后应该看到：
- ✅ 不再跳转到 `about:blank`
- ✅ 页面正常加载
- ✅ 控制台输出 `[STEALTH] All Playwright features hidden`
- ✅ 没有 `[PAGE_ERROR]` 错误

## 参考资料

- [Playwright Stealth](https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth)
- [undetected-chromedriver](https://github.com/ultrafunkamsterdam/undetected-chromedriver)
- [Playwright Anti-Detection](https://playwright.dev/docs/emulation)

