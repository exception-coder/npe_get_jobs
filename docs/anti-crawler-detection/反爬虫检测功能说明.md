# åçˆ¬è™«æ£€æµ‹åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬åŠŸèƒ½ä¸“é—¨ç”¨äºåˆ†æå’Œæ£€æµ‹æ‹›è˜å¹³å°ï¼ˆç‰¹åˆ«æ˜¯ Boss ç›´è˜ï¼‰çš„åçˆ¬è™«æœºåˆ¶ï¼Œé€šè¿‡æ‹¦æˆªå’Œè®°å½•é¡µé¢è¡Œä¸ºï¼Œå¸®åŠ©å¼€å‘è€…å®šä½åçˆ¬è™«è„šæœ¬çš„è§¦å‘ç‚¹ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. about:blank è·³è½¬æ‹¦æˆªï¼ˆ`PlaywrightPageObserver.attachBlankInterceptor`ï¼‰

**ç›®çš„ï¼š** æ•è·åçˆ¬è™«è„šæœ¬é€šè¿‡è·³è½¬åˆ° `about:blank` æ¥é˜»æ­¢è‡ªåŠ¨åŒ–å·¥å…·çš„è¡Œä¸ºã€‚

**æ‹¦æˆªçš„æ–¹æ³•ï¼š**
- `location.assign('about:blank')`
- `location.replace('about:blank')`
- `window.open('about:blank', '_self')`
- `location.href = 'about:blank'`

**å·¥ä½œåŸç†ï¼š**
1. åœ¨é¡µé¢åŠ è½½å‰é€šè¿‡ `context.addInitScript()` æ³¨å…¥ JavaScript è„šæœ¬
2. Hook åŸç”Ÿçš„ JavaScript è·³è½¬æ–¹æ³•
3. å½“æ£€æµ‹åˆ°ç›®æ ‡ URL åŒ…å« `about:blank` æ—¶ï¼Œåœ¨æ§åˆ¶å°è¾“å‡º `[ANTI-DEBUG]` è­¦å‘Šå’Œå®Œæ•´è°ƒç”¨å †æ ˆ
4. ä¿ç•™åŸå§‹åŠŸèƒ½ï¼Œä¸å½±å“é¡µé¢æ­£å¸¸è¿è¡Œ

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
[FORENSIC] about:blank æ‹¦æˆªå™¨å·²å°±ç»ª
[ANTI-DEBUG] location.replace about:blank
  at report (eval:5:20)
  at window.location.replace (eval:18:35)
  at antiDebugScript (https://www.zhipin.com/static/js/security.js:123:45)
```

### 2. é¡µé¢è¡Œä¸ºè§‚æµ‹å™¨ï¼ˆ`PlaywrightPageObserver.attachObservers`ï¼‰

**ç›®çš„ï¼š** å…¨é¢ç›‘æ§é¡µé¢è¡Œä¸ºï¼Œè®°å½•æ‰€æœ‰å¯ç–‘æ´»åŠ¨åˆ°æ—¥å¿—æ–‡ä»¶ã€‚

**ç›‘æ§å†…å®¹ï¼š**
1. **ä¸»æ¡†æ¶å¯¼èˆª** - ç›‘æ§é¡µé¢è·³è½¬ï¼Œç‰¹åˆ«æ˜¯ `about:blank` ç­‰å¼‚å¸¸è·³è½¬
2. **æ§åˆ¶å°æ¶ˆæ¯** - æ•è·é¡µé¢è„šæœ¬è¾“å‡ºï¼ŒåŒ…æ‹¬ `[ANTI-DEBUG]` ç­‰åè°ƒè¯•ä¿¡æ¯
3. **é¡µé¢è¿è¡Œæ—¶é”™è¯¯** - å¾ˆå¤šåè°ƒè¯•ä¼š throw æˆ–åˆ»æ„åˆ¶é€ å¼‚å¸¸
4. **å…³é”®ç½‘ç»œè¯·æ±‚** - åªè®°å½• documentã€scriptã€xhrã€fetch ç±»å‹
5. **JavaScript æ–‡ä»¶å“åº”** - é‡ç‚¹è®°å½• JS æ–‡ä»¶æ¥æºï¼Œæ–¹ä¾¿å®šä½åçˆ¬è™«è„šæœ¬ bundle
6. **è¯·æ±‚å¤±è´¥** - å¯èƒ½æ˜¯åçˆ¬è™«æœºåˆ¶å¯¼è‡´çš„è¯·æ±‚æ‹¦æˆª

**æ—¥å¿—æ–‡ä»¶ä½ç½®ï¼š**
```
logs/playwright-observers/{å¹³å°ä»£ç }_observer_{æ—¶é—´æˆ³}.log
```

ä¾‹å¦‚ï¼š`logs/playwright-observers/boss_observer_20260122_143025.log`

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### è‡ªåŠ¨å¯ç”¨ï¼ˆå·²é…ç½®ï¼‰

åœ¨ `PlaywrightService` ä¸­ï¼Œåçˆ¬è™«æ£€æµ‹åŠŸèƒ½å·²è‡ªåŠ¨é…ç½®ï¼š

```java
// 1. åˆ›å»º BrowserContext æ—¶è‡ªåŠ¨æ³¨å…¥æ‹¦æˆªè„šæœ¬
private BrowserContext createNewContext() {
    // ... åŸºç¡€é…ç½® ...
    
    // éšè—è‡ªåŠ¨åŒ–ç‰¹å¾
    context.addInitScript(
        "Object.defineProperty(navigator, 'webdriver', { get: () => undefined });");
    
    // æ·»åŠ  blank è·³è½¬æ‹¦æˆªå–è¯è„šæœ¬
    pageObserver.attachBlankInterceptor(context);
    
    return context;
}

// 2. ä¸º BOSS å¹³å°è‡ªåŠ¨é™„åŠ è§‚æµ‹å™¨
for (RecruitmentPlatformEnum platform : RecruitmentPlatformEnum.values()) {
    Page page = createNewPage(context);
    
    // é’ˆå¯¹ BOSS å¹³å°ï¼Œé™„åŠ è§‚æµ‹å™¨ç”¨äºåˆ†æåçˆ¬è™«æœºåˆ¶
    if (platform == RecruitmentPlatformEnum.BOSS_ZHIPIN) {
        pageObserver.attachObservers(page, platform);
    }
    
    // ... å…¶ä»–åˆå§‹åŒ– ...
}
```

### æ‰‹åŠ¨ä½¿ç”¨

å¦‚æœéœ€è¦ä¸ºå…¶ä»–å¹³å°å¯ç”¨è§‚æµ‹å™¨ï¼š

```java
// ä¸ºæŒ‡å®šå¹³å°é™„åŠ è§‚æµ‹å™¨
pageObserver.attachObservers(page, RecruitmentPlatformEnum.ZHILIAN_ZHAOPIN);

// å…³é—­æŒ‡å®šå¹³å°çš„è§‚æµ‹å™¨
pageObserver.closeObserver(RecruitmentPlatformEnum.BOSS_ZHIPIN);

// å…³é—­æ‰€æœ‰è§‚æµ‹å™¨
pageObserver.closeAllObservers();
```

## ğŸ“Š æ—¥å¿—åˆ†æ

### æ—¥å¿—æ ¼å¼

```
[2026-01-22 14:30:25.123] [NAV] https://www.zhipin.com
[2026-01-22 14:30:25.234] [REQ] document GET https://www.zhipin.com
[2026-01-22 14:30:25.456] [JS] 200 https://www.zhipin.com/static/js/app.js
[2026-01-22 14:30:25.789] [CONSOLE] warning [ANTI-DEBUG] location.replace about:blank
  at report (eval:5:20)
  at window.location.replace (eval:18:35)
  at antiDebugScript (https://www.zhipin.com/static/js/security.js:123:45)
```

### å…³é”®æ ‡è®°

- `[NAV]` - é¡µé¢å¯¼èˆªäº‹ä»¶
- `[CONSOLE]` - æ§åˆ¶å°æ¶ˆæ¯
- `[PAGE_ERROR]` - é¡µé¢è¿è¡Œæ—¶é”™è¯¯
- `[REQ]` - ç½‘ç»œè¯·æ±‚
- `[JS]` - JavaScript æ–‡ä»¶å“åº”
- `[REQ_FAILED]` - è¯·æ±‚å¤±è´¥
- `[ANTI-DEBUG]` - åè°ƒè¯•è¡Œä¸ºï¼ˆé‡ç‚¹å…³æ³¨ï¼‰
- `[FORENSIC]` - å–è¯è„šæœ¬çŠ¶æ€

### åˆ†ææ­¥éª¤

1. **æŸ¥æ‰¾ [ANTI-DEBUG] æ ‡è®°**
   - è¿™æ˜¯åçˆ¬è™«è„šæœ¬è§¦å‘çš„ç›´æ¥è¯æ®
   - æŸ¥çœ‹å †æ ˆä¿¡æ¯ï¼Œå®šä½è§¦å‘çš„è„šæœ¬æ–‡ä»¶å’Œè¡Œå·

2. **åˆ†æ [JS] è®°å½•**
   - æ‰¾åˆ°æ‰€æœ‰åŠ è½½çš„ JavaScript æ–‡ä»¶
   - é‡ç‚¹å…³æ³¨ securityã€antiã€protect ç­‰å…³é”®è¯çš„æ–‡ä»¶

3. **æ£€æŸ¥ [NAV] è®°å½•**
   - å¦‚æœå‡ºç° `about:blank`ï¼Œè¯´æ˜åçˆ¬è™«è„šæœ¬æˆåŠŸè§¦å‘
   - ç»“åˆæ—¶é—´æˆ³ï¼Œæ‰¾åˆ°è§¦å‘å‰çš„æ“ä½œ

4. **æŸ¥çœ‹ [CONSOLE] å’Œ [PAGE_ERROR]**
   - å¯èƒ½åŒ…å«åè°ƒè¯•è„šæœ¬çš„è°ƒè¯•ä¿¡æ¯
   - æœ‰åŠ©äºç†è§£åçˆ¬è™«é€»è¾‘

## ğŸ› ï¸ ä¼˜åŒ–å»ºè®®

### é—®é¢˜ï¼šæ— æ³•æ•è·è·³è½¬

**å¯èƒ½åŸå› ï¼š**
1. åçˆ¬è™«è„šæœ¬åœ¨æ‹¦æˆªå™¨æ³¨å…¥å‰å°±æ‰§è¡Œäº†
2. ä½¿ç”¨äº†å…¶ä»–è·³è½¬æ–¹å¼ï¼ˆå¦‚ iframeã€form submitï¼‰
3. é€šè¿‡æµè§ˆå™¨åŸç”Ÿ API ç»•è¿‡äº† Hook

**è§£å†³æ–¹æ¡ˆï¼š**
1. âœ… ç¡®ä¿ `attachBlankInterceptor` åœ¨ `addInitScript` ä¹‹å‰è°ƒç”¨ï¼ˆå·²ä¼˜åŒ–ï¼‰
2. âœ… ä½¿ç”¨ `includes('about:blank')` è€Œä¸æ˜¯ `=== 'about:blank'`ï¼ˆå·²ä¼˜åŒ–ï¼‰
3. âœ… æ·»åŠ  `location.href` setter çš„ Hookï¼ˆå·²ä¼˜åŒ–ï¼‰
4. ä½¿ç”¨ `WaitUntilState.DOMCONTENTLOADED` è€Œä¸æ˜¯ `LOAD`ï¼ˆå·²é…ç½®ï¼‰

### æ‰©å±•ç›‘æ§

å¦‚æœéœ€è¦ç›‘æ§æ›´å¤šè·³è½¬æ–¹å¼ï¼Œå¯ä»¥åœ¨ `attachBlankInterceptor` ä¸­æ·»åŠ ï¼š

```javascript
// Hook document.write
const _write = document.write.bind(document);
document.write = function(content) {
    if(String(content).includes('about:blank')) {
        report('document.write', content);
    }
    return _write(content);
};

// Hook iframe src
const originalSrcDescriptor = Object.getOwnPropertyDescriptor(HTMLIFrameElement.prototype, 'src');
if (originalSrcDescriptor && originalSrcDescriptor.set) {
    Object.defineProperty(HTMLIFrameElement.prototype, 'src', {
        set: function(url) {
            if(String(url).includes('about:blank')) {
                report('iframe.src setter', url);
            }
            return originalSrcDescriptor.set.call(this, url);
        },
        get: originalSrcDescriptor.get
    });
}
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**
   - è§‚æµ‹å™¨ä¼šè®°å½•å¤§é‡æ—¥å¿—ï¼Œå¯èƒ½å½±å“æ€§èƒ½
   - å»ºè®®åªåœ¨éœ€è¦åˆ†ææ—¶å¯ç”¨

2. **æ—¥å¿—æ–‡ä»¶ç®¡ç†**
   - æ—¥å¿—æ–‡ä»¶ä¼šæŒç»­å¢é•¿ï¼Œéœ€è¦å®šæœŸæ¸…ç†
   - å»ºè®®è®¾ç½®æ—¥å¿—è½®è½¬ç­–ç•¥

3. **éšç§å’Œå®‰å…¨**
   - æ—¥å¿—å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆCookieã€Token ç­‰ï¼‰
   - ä¸è¦å°†æ—¥å¿—æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ

4. **å…¼å®¹æ€§**
   - Hook æ–¹æ³•å¯èƒ½è¢«æŸäº›é«˜çº§åçˆ¬è™«æ£€æµ‹åˆ°
   - å¦‚æœå‘ç°å¼‚å¸¸ï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨æ‹¦æˆªå™¨

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ—¥å¿—æ–‡ä»¶æ²¡æœ‰ç”Ÿæˆ

**æ£€æŸ¥ï¼š**
1. ç¡®è®¤ `logs/playwright-observers/` ç›®å½•æ˜¯å¦æœ‰å†™å…¥æƒé™
2. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Œæ˜¯å¦æœ‰ "å·²ä¸ºå¹³å° XXX åˆ›å»ºè§‚æµ‹å™¨æ—¥å¿—æ–‡ä»¶" çš„ä¿¡æ¯
3. ç¡®è®¤å¹³å°æ˜¯å¦ä¸º `BOSS_ZHIPIN`

### é—®é¢˜ï¼šæ²¡æœ‰æ•è·åˆ° [ANTI-DEBUG] ä¿¡æ¯

**æ£€æŸ¥ï¼š**
1. ç¡®è®¤ `attachBlankInterceptor` æ˜¯å¦è¢«è°ƒç”¨
2. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰ `[FORENSIC] about:blank æ‹¦æˆªå™¨å·²å°±ç»ª` çš„ä¿¡æ¯
3. å°è¯•æ‰‹åŠ¨åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ `location.replace('about:blank')` æµ‹è¯•

### é—®é¢˜ï¼šæ—¥å¿—æ–‡ä»¶è¿‡å¤§

**è§£å†³ï¼š**
1. å‡å°‘ç›‘æ§çš„è¯·æ±‚ç±»å‹ï¼ˆä¿®æ”¹ `attachObservers` ä¸­çš„è¿‡æ»¤æ¡ä»¶ï¼‰
2. åªåœ¨éœ€è¦æ—¶å¯ç”¨è§‚æµ‹å™¨
3. å®ç°æ—¥å¿—è½®è½¬æœºåˆ¶

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `PlaywrightService.java` - Playwright æœåŠ¡ä¸»ç±»
- `PlaywrightPageObserver.java` - é¡µé¢è§‚æµ‹å™¨å·¥å…·ç±»
- `logs/playwright-observers/` - æ—¥å¿—æ–‡ä»¶ç›®å½•

## ğŸ“ æœ€ä½³å®è·µ

1. **åˆ†æå‰å‡†å¤‡**
   - æ¸…ç©ºæ—§çš„æ—¥å¿—æ–‡ä»¶
   - ç¡®ä¿æµè§ˆå™¨çª—å£å¯è§ï¼ˆheadless=falseï¼‰
   - å‡†å¤‡å¥½æµè§ˆå™¨å¼€å‘è€…å·¥å…·

2. **åˆ†æè¿‡ç¨‹**
   - åŒæ—¶æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶å’Œæµè§ˆå™¨æ§åˆ¶å°
   - è®°å½•è§¦å‘åçˆ¬è™«çš„æ“ä½œæ­¥éª¤
   - å¯¹æ¯”æ­£å¸¸è®¿é—®å’Œè‡ªåŠ¨åŒ–è®¿é—®çš„å·®å¼‚

3. **åˆ†æå**
   - ä¿å­˜æœ‰ä»·å€¼çš„æ—¥å¿—æ–‡ä»¶
   - è®°å½•å‘ç°çš„åçˆ¬è™«ç‰¹å¾
   - æ›´æ–°åçˆ¬è™«å¯¹æŠ—ç­–ç•¥

---

**æœ€åæ›´æ–°ï¼š** 2026-01-22  
**ç»´æŠ¤è€…ï¼š** zhangkai

