import{M as U,L as x,ab as Me,v as k,J as z,bV as Q,bC as N,cc as oe,f as Se,ac as K,C as de,w as M,V as O,af as Te,ai as X,cP as be,O as Oe,o as De,G as Ae,z as We,cy as Le,ap as Be,W as je,j as Fe,bQ as ze,d as Ke,S as Ge,q as Ye,I as b,u as Je,x as qe,H as Qe,F as Xe}from"./TeamSpreadsheet-DqPQXi__.js";import{G as le,nJ as B,lg as T,lh as Re,ae as Ze,ag as et,eK as W,e4 as Ue,eM as tt,ah as Ce,S as nt,jc as it,jb as st,jd as at,m as rt,kz as ot,nU as dt,nT as lt,nV as ut,a6 as ct,km as Ne,z as xe,dg as pt}from"./index--BQDx9CP.js";var ht=Object.defineProperty,gt=(e,t,n)=>t in e?ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,w=(e,t,n)=>gt(e,typeof t!="symbol"?t+"":t,n),mt=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},It=(e,t)=>(n,s)=>t(n,s,e);let v=class extends O{constructor(e){super(),w(this,"_linkUpdate$",new Te),w(this,"linkUpdate$",this._linkUpdate$.asObservable()),w(this,"_linkMap",new Map),w(this,"_linkPositionMap",new Map),this._univerInstanceService=e,this.disposeWithMe({dispose:()=>{this._linkUpdate$.complete()}})}_ensureMap(e,t){let n=this._linkMap.get(e);n||(n=new Map,this._linkMap.set(e,n));let s=n.get(t);s||(s=new X,n.set(t,s));let i=this._linkPositionMap.get(e);i||(i=new Map,this._linkPositionMap.set(e,i));let a=i.get(t);return a||(a=new Map,i.set(t,a)),{matrix:s,positionMap:a}}addHyperLink(e,t,n){const{matrix:s,positionMap:i}=this._ensureMap(e,t);return s.setValue(n.row,n.column,n),i.set(n.id,{row:n.row,column:n.column,link:n}),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:n,type:"add"}),!0}updateHyperLink(e,t,n,s,i=!1){const{matrix:a,positionMap:r}=this._ensureMap(e,t),o=r.get(n);if(!o)return!0;const d=a.getValue(o.row,o.column);return d&&(Object.assign(d,s),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:{display:d.display,payload:d.payload},id:n,type:"update",silent:i})),!0}updateHyperLinkRef(e,t,n,s,i=!1){const{matrix:a,positionMap:r}=this._ensureMap(e,t),o=r.get(n);if(!o)return!0;let d=a.getValue(o.row,o.column);return!d||d.id!==n?d=o.link:a.realDeleteValue(o.row,o.column),Object.assign(d,s),r.set(n,{...s,link:d}),a.setValue(s.row,s.column,d),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:s,id:n,type:"updateRef",silent:i}),!0}removeHyperLink(e,t,n){const{matrix:s,positionMap:i}=this._ensureMap(e,t),a=i.get(n);if(!a)return!1;i.delete(n);const r=s.getValue(a.row,a.column);return r&&r.id===n&&s.realDeleteValue(a.row,a.column),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:a.link,type:"remove"}),!0}getHyperLink(e,t,n){const{matrix:s,positionMap:i}=this._ensureMap(e,t),a=i.get(n);if(a)return s.getValue(a.row,a.column)}getHyperLinkByLocation(e,t,n,s){const{matrix:i}=this._ensureMap(e,t);return i.getValue(n,s)}getHyperLinkByLocationSync(e,t,n,s){var i,a,r,o,d;const{matrix:l}=this._ensureMap(e,t),u=this._univerInstanceService.getUnit(e,M.UNIVER_SHEET),p=(i=u==null?void 0:u.getSheetBySheetId(t))==null?void 0:i.getCellRaw(n,s),c=((d=(o=p==null?void 0:p.v)!=null?o:(r=(a=p==null?void 0:p.p)==null?void 0:a.body)==null?void 0:r.dataStream.slice(0,-2))!=null?d:"").toString(),h=l.getValue(n,s);if(h)return{...h,display:c}}getSubUnit(e,t){const{matrix:n}=this._ensureMap(e,t),s=[];return n.forValue((i,a,r)=>{r&&s.push(r)}),s}getUnit(e){const t=this._linkMap.get(e);return t?Array.from(t.keys()).map(n=>{const s=this.getSubUnit(e,n);return{unitId:e,subUnitId:n,links:s}}):[]}deleteUnit(e){const t=this.getUnit(e);this._linkMap.delete(e),this._linkPositionMap.delete(e),this._linkUpdate$.next({type:"unload",unitId:e,unitLinks:t})}getAll(){return Array.from(this._linkMap.keys()).map(e=>this.getUnit(e))}};v=mt([It(0,k)],v);const P={type:U.MUTATION,id:"sheets.mutation.add-hyper-link",handler(e,t){if(!t)return!1;const n=e.get(v),{unitId:s,subUnitId:i,link:a}=t;return n.addHyperLink(s,i,a)}},$={type:U.MUTATION,id:"sheets.mutation.remove-hyper-link",handler(e,t){if(!t)return!1;const n=e.get(v),{unitId:s,subUnitId:i,id:a}=t;return n.removeHyperLink(s,i,a)}},ft={type:U.COMMAND,id:"sheets.command.add-hyper-link",async handler(e,t){if(!t)return!1;const n=e.get(x),s=e.get(Me),i=e.get(k),a=e.get(v),r=e.get(le),o=B(i,t);if(!o)return!1;const{unitId:d,subUnitId:l,workbook:u,worksheet:p}=o,{link:c}=t,{payload:h,display:f,row:m,column:g,id:I}=c,R=p.getCell(m,g),S=p.getBlankCellDocumentModel(R,m,g),H=S.documentModel.getSnapshot(),_=z.deepClone(H.body);if(!_)return!1;let y;if(f?y=Q.selection.replace({selection:{startOffset:0,endOffset:_.dataStream.length-2,collapsed:_.dataStream.length-2===0},body:{dataStream:`${f}`,customRanges:[{startIndex:0,endIndex:f.length-1,rangeType:N.HYPERLINK,rangeId:I,properties:{url:h}}]},doc:S.documentModel}):y=Q.customRange.add({body:_,ranges:[{startOffset:0,endOffset:_.dataStream.length-2,collapsed:!1}],rangeId:I,rangeType:N.HYPERLINK,properties:{url:h,refId:I}}),!y)return!1;const V=oe.apply(_,y.serialize()),E={p:{...H,body:V},t:Se.STRING},D=r.onWriteCell(u,p,m,g,E),L={unitId:d,subUnitId:l,cellValue:{[c.row]:{[c.column]:D}}},G={id:T.id,params:L},ue=Re(e,L),ce={id:T.id,params:ue},j=[G],A=[ce],F=a.getHyperLinkByLocation(d,l,m,g);return F&&(j.push({id:$.id,params:{unitId:d,subUnitId:l,id:F.id}}),A.push({id:P.id,params:{unitId:d,subUnitId:l,link:F}})),await K(j,n)?await r.onValidateCell(u,p,m,g)===!1?(K(A,n),!1):(s.pushUndoRedo({redoMutations:j,undoMutations:A,unitID:d}),!0):!1}},_t={id:"sheets.command.add-rich-hyper-link",type:U.COMMAND,handler:async(e,t)=>{if(!t)return!1;const{documentId:n,link:s}=t,i=e.get(x),a=de(),{payload:r}=s,o=Ze(e,{unitId:n,rangeId:a,rangeType:N.HYPERLINK,properties:{url:r,refId:a}});return o?i.syncExecuteCommand(o.id,o.params):!1}},yt={type:U.COMMAND,id:"sheets.command.cancel-hyper-link",handler(e,t){var n,s;if(!t)return!1;const i=e.get(x),a=e.get(Me),r=e.get(k),o=e.get(v),d=B(r,t);if(!d)return!1;const{row:l,column:u,id:p}=t,{unitId:c,subUnitId:h,worksheet:f}=d,m=f.getCell(l,u);if(!m)return!1;const g=f.getCellDocumentModelWithFormula(m,l,u);if(!(g!=null&&g.documentModel))return!1;const I=z.deepClone(g.documentModel.getSnapshot()),R=(s=(n=I.body)==null?void 0:n.customRanges)==null?void 0:s.find(L=>`${L.rangeId}`===p);if(!R)return!1;const S=Q.customRange.delete({documentDataModel:g.documentModel,rangeId:R.rangeId});if(!S)return!1;const H=oe.apply(I.body,S.serialize()),_=[],y=[],V={unitId:c,subUnitId:h,cellValue:{[l]:{[u]:{p:{...I,body:H},t:Se.STRING}}}};_.push({id:T.id,params:V});const E=Re(e,V);y.push({id:T.id,params:E});const D=o.getHyperLinkByLocation(c,h,l,u);return D&&(_.push({id:$.id,params:{unitId:c,subUnitId:h,id:p}}),y.push({id:P.id,params:{unitId:c,subUnitId:h,link:{...D}}})),K(_,i).result?(a.pushUndoRedo({redoMutations:_,undoMutations:y,unitID:c}),!0):!1}},vt={type:U.COMMAND,id:"sheets.command.cancel-rich-hyper-link",handler(e,t){var n,s;if(!t)return!1;const{id:i,documentId:a}=t,r=e.get(x),o=e.get(k).getUnit(a,M.UNIVER_DOC),d=(s=(n=o==null?void 0:o.getBody())==null?void 0:n.customRanges)==null?void 0:s.find(p=>p.rangeId===i);let l=null;d&&d.endIndex===o.getBody().dataStream.length-3&&(l={dataStream:" "});const u=et(e,{unitId:a,rangeId:i,insert:l});return u?r.syncExecuteCommand(u.id,u.params):!1}},Mt={type:U.COMMAND,id:"sheets.command.update-hyper-link",async handler(e,t){var n,s,i;if(!t)return!1;const a=e.get(x),r=e.get(Me),o=e.get(k),d=e.get(v),l=e.get(le),u=B(o,{unitId:t.unitId,subUnitId:t.subUnitId});if(!u)return!1;const{payload:p,row:c,column:h,id:f}=t,{workbook:m,worksheet:g,unitId:I,subUnitId:R}=u,{payload:S,display:H=""}=p,_=g.getCell(c,h);if(!_)return!1;const y=g.getCellDocumentModelWithFormula(_,c,h);if(!(y!=null&&y.documentModel))return!1;const V=y.documentModel.getSnapshot(),E=(s=(n=V.body)==null?void 0:n.customRanges)==null?void 0:s.find($e=>`${$e.rangeId}`===f);if(!E)return!1;const D=de(),L=(i=Le(y.documentModel.getBody(),E.startIndex,E.endIndex+1).textRuns)==null?void 0:i[0];L&&(L.ed=H.length+1);const G=Ce(e,{unitId:I,body:{dataStream:`${H}`,customRanges:[{rangeId:D,rangeType:N.HYPERLINK,startIndex:0,endIndex:H.length-1,properties:{url:S}}],textRuns:L?[L]:void 0},selection:{startOffset:E.startIndex,endOffset:E.endIndex+1,collapsed:!1},doc:y.documentModel});if(!G)return!1;const ue=oe.apply(z.deepClone(V.body),G.textX.serialize()),ce={p:{...V,body:ue},t:Se.STRING},j=l.onWriteCell(m,g,c,h,ce),A={id:T.id,params:{unitId:I,subUnitId:R,cellValue:{[c]:{[h]:j}}}},F=Re(e,A.params),Pe={id:T.id,params:F},pe=[A],he=[Pe],ge=d.getHyperLinkByLocation(I,R,c,h);return ge&&(pe.push({id:$.id,params:{unitId:I,subUnitId:R,id:ge.id}}),he.push({id:P.id,params:{unitId:I,subUnitId:R,link:ge}})),K(pe,a)?await l.onValidateCell(m,g,c,h)===!1?(K(he,a),!1):(r.pushUndoRedo({redoMutations:pe,undoMutations:he,unitID:I}),!0):!1}},St={type:U.COMMAND,id:"sheets.command.update-rich-hyper-link",handler:(e,t)=>{var n,s,i,a;if(!t)return!1;const{documentId:r,payload:o,id:d}=t,l=e.get(k),u=e.get(x),p=l.getUnit(r,M.UNIVER_DOC);if(!p)return!1;const c=(s=(n=p.getBody())==null?void 0:n.customRanges)==null?void 0:s.find(I=>I.rangeId===d);if(!c)return!1;const h=(i=t.payload.display)!=null?i:"",f=de(),m=(a=Le(p.getBody(),c.startIndex,c.endIndex+1).textRuns)==null?void 0:a[0];m&&(m.ed=h.length+1);const g=Ce(e,{unitId:r,body:{dataStream:`${h}`,customRanges:[{rangeId:f,rangeType:N.HYPERLINK,startIndex:0,endIndex:h.length-1,properties:{url:o.payload}}],textRuns:m?[m]:void 0},selection:{startOffset:c.startIndex,endOffset:c.endIndex+1,collapsed:!1},doc:p});return g?u.syncExecuteCommand(g.id,g.params):!1}},_e={type:U.MUTATION,id:"sheets.mutation.update-hyper-link",handler(e,t){if(!t)return!1;const n=e.get(v),{unitId:s,subUnitId:i,payload:a,id:r}=t;return n.updateHyperLink(s,i,r,a,!1)}},ye={type:U.MUTATION,id:"sheets.mutation.update-hyper-link-ref",handler(e,t){if(!t)return!1;const n=e.get(v),{unitId:s,subUnitId:i,id:a,row:r,column:o,silent:d}=t;return n.updateHyperLinkRef(s,i,a,{row:r,column:o},d)}},q={type:U.MUTATION,id:"sheets.mutation.update-rich-hyper-link",handler(e,t){var n,s,i;if(!t)return!1;const{unitId:a,subUnitId:r,row:o,col:d,id:l,url:u}=t,p=e.get(k),c=B(p,{unitId:a,subUnitId:r});if(!c)return!1;const{worksheet:h}=c,f=h.getCellRaw(o,d),m=(i=(s=(n=f==null?void 0:f.p)==null?void 0:n.body)==null?void 0:s.customRanges)==null?void 0:i.find(g=>g.rangeType===N.HYPERLINK&&g.rangeId===l);return m&&(m.properties.url=u),!0}},bt="sheets-hyper-link.config",ke={},He="SHEET_HYPER_LINK_PLUGIN",Z="err";var Rt=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},Y=(e,t)=>(n,s)=>t(n,s,e);let ee=class extends O{constructor(e,t,n,s){super(),w(this,"_disposableMap",new Map),w(this,"_watchDisposableMap",new Map),w(this,"_rangeDisableMap",new Map),w(this,"_rangeWatcherMap",new Map),w(this,"_handlePositionChange",(i,a,r,o,d)=>{const l={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};return o?{redos:[{id:ye.id,params:{unitId:i,subUnitId:a,id:r.id,row:o.startRow,column:o.startColumn,silent:d}}],undos:[{id:ye.id,params:{unitId:i,subUnitId:a,id:r.id,row:l.startRow,column:l.startColumn,silent:d}}]}:{redos:[{id:$.id,params:{unitId:i,subUnitId:a,id:r.id}}],undos:[{id:P.id,params:{unitId:i,subUnitId:a,link:r}}]}}),this._refRangeService=e,this._hyperLinkModel=t,this._selectionManagerService=n,this._commandService=s,this._initData(),this._initRefRange()}_registerPosition(e,t,n){const s=n.id,i={startColumn:n.column,endColumn:n.column,startRow:n.row,endRow:n.row},a=r=>{const o=lt(i,r,{selectionManagerService:this._selectionManagerService}),d=Array.isArray(o)?o[0]:o;return d&&d.startColumn===i.startColumn&&d.startRow===i.startRow?{undos:[],redos:[]}:this._handlePositionChange(e,t,n,d,!1)};this._disposableMap.set(s,this._refRangeService.registerRefRange(i,a,e,t))}_watchPosition(e,t,n){const s=n.id,i={startColumn:n.column,endColumn:n.column,startRow:n.row,endRow:n.row};this._watchDisposableMap.set(s,this._refRangeService.watchRange(e,t,i,(a,r)=>{const{redos:o}=this._handlePositionChange(e,t,n,r,!0);Be(o,this._commandService,{onlyLocal:!0})},!0))}_unregisterPosition(e){const t=this._disposableMap.get(e);t==null||t.dispose(),this._disposableMap.delete(e)}_unwatchPosition(e){const t=this._watchDisposableMap.get(e);t==null||t.dispose(),this._watchDisposableMap.delete(e)}_registerRange(e,t,n,s=!1){var i,a,r;if(n.startsWith("#")){const o=new URLSearchParams(n.slice(1)),d={gid:(i=o.get("gid"))!=null?i:"",range:(a=o.get("range"))!=null?a:"",rangeid:(r=o.get("rangeid"))!=null?r:""};if(d.range&&d.gid){const l=d.gid,u=Ue(d.range).range;if(be(u)&&d.range!==Z){const p=c=>{const h=ut(u,c,{selectionManagerService:this._selectionManagerService});return h&&W(h)===W(u)?{redos:[],undos:[]}:{redos:[{id:_e.id,params:{unitId:e,subUnitId:l,id:t,payload:{payload:`#gid=${l}&range=${h?W(h):"err"}`}}}],undos:[{id:_e.id,params:{unitId:e,subUnitId:l,id:t,payload:{payload:n}}}]}};this._rangeDisableMap.set(t,this._refRangeService.registerRefRange(u,p,e,l)),s||this._rangeWatcherMap.set(t,this._refRangeService.watchRange(e,l,u,(c,h)=>{this._hyperLinkModel.updateHyperLink(e,l,t,{payload:`#gid=${l}&range=${h?W(h):"err"}`},!0)},!0))}}}}_unregisterRange(e){const t=this._rangeDisableMap.get(e);t==null||t.dispose(),this._rangeDisableMap.delete(e)}_unwatchRange(e){const t=this._rangeWatcherMap.get(e);t==null||t.dispose(),this._rangeWatcherMap.delete(e)}_initData(){this._hyperLinkModel.getAll().forEach(e=>{e.forEach(t=>{const{unitId:n,subUnitId:s,links:i}=t;i.forEach(a=>{this._registerPosition(n,s,a),this._watchPosition(n,s,a),this._registerRange(n,a.id,a.payload)})})})}_initRefRange(){this.disposeWithMe(this._hyperLinkModel.linkUpdate$.subscribe(e=>{switch(e.type){case"add":{this._registerPosition(e.unitId,e.subUnitId,e.payload),this._watchPosition(e.unitId,e.subUnitId,e.payload),this._registerRange(e.unitId,e.payload.id,e.payload.payload);break}case"remove":{this._unregisterPosition(e.payload.id),this._unwatchPosition(e.payload.id),this._unregisterRange(e.payload.id),this._unwatchRange(e.payload.id);break}case"updateRef":{const{unitId:t,subUnitId:n,id:s,silent:i}=e,a=this._hyperLinkModel.getHyperLink(t,n,s);if(!a)return;this._unregisterPosition(s),this._registerPosition(t,n,a),i||(this._unwatchPosition(s),this._watchPosition(t,n,a));break}case"unload":{const{unitLinks:t}=e;t.forEach(n=>{const{links:s}=n;s.forEach(i=>{this._unregisterPosition(i.id),this._unwatchPosition(i.id),this._unregisterRange(i.id),this._unwatchRange(i.id)})});break}case"update":{e.silent||this._unwatchRange(e.id),this._unregisterRange(e.id),this._registerRange(e.unitId,e.id,e.payload.payload,e.silent);break}}})),this.disposeWithMe(je(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}};ee=Rt([Y(0,b(Ne)),Y(1,b(v)),Y(2,b(xe)),Y(3,x)],ee);var Ut=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},me=(e,t)=>(n,s)=>t(n,s,e);let te=class extends O{constructor(e,t,n){super(),this._sheetInterceptorService=e,this._univerInstanceService=t,this._hyperLinkModel=n,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:e=>{var t;if(e.id===ot.id){const n=e.params,s=n.unitId?this._univerInstanceService.getUnit(n.unitId):this._univerInstanceService.getCurrentUnitForType(M.UNIVER_SHEET);if(!s)return{redos:[],undos:[]};const i=s.getUnitId(),a=n.subUnitId||((t=s.getActiveSheet())==null?void 0:t.getSheetId());if(!a)return{redos:[],undos:[]};const r=this._hyperLinkModel.getSubUnit(i,a),o=r.map(l=>({id:$.id,params:{unitId:i,subUnitId:a,id:l.id}})),d=r.map(l=>({id:P.id,params:{unitId:i,subUnitId:a,link:l}}));return{redos:o,undos:d}}return{redos:[],undos:[]}}}))}};te=Ut([me(0,b(le)),me(1,k),me(2,b(v))],te);var kt=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},Ie=(e,t)=>(n,s)=>t(n,s,e);let ne=class extends O{constructor(e,t,n){super(),w(this,"_refRangeMap",new Map),this._commandService=e,this._univerInstanceService=t,this._refRangeService=n,this._initWorkbookLoad(),this._initWorkbookUnload(),this._initSetRangesListener()}_enusreMap(e,t){let n=this._refRangeMap.get(e);n||(n=new Map,this._refRangeMap.set(e,n));let s=n.get(t);return s||(s=new X,n.set(t,s)),s}_isLegalRangeUrl(e,t){var n,s,i;const a=this._univerInstanceService.getUnit(e,M.UNIVER_SHEET);if(!a)return null;if(t&&t.startsWith("#")){const r=new URLSearchParams(t.slice(1)),o={gid:(n=r.get("gid"))!=null?n:"",range:(s=r.get("range"))!=null?s:"",rangeid:(i=r.get("rangeid"))!=null?i:""};if(o.range&&o.gid){const d=o.gid,l=a.getSheetBySheetId(d);if(!l)return null;const u=Ue(o.range).range;if(be(u,l)&&o.range!==Z)return{range:u,worksheet:l}}}return null}_registerRange(e,t,n,s,i){var a,r,o,d;const l=this._enusreMap(e,t);if((r=(a=i.body)==null?void 0:a.customRanges)!=null&&r.some(u=>{var p;return u.rangeType===N.HYPERLINK&&this._isLegalRangeUrl(e,(p=u.properties)==null?void 0:p.url)})){const u=new Ke;let p=!1;(d=(o=i.body)==null?void 0:o.customRanges)==null||d.forEach(c=>{var h;if(c.rangeType===N.HYPERLINK){const f=(h=c.properties)==null?void 0:h.url,m=this._isLegalRangeUrl(e,f);if(m){const{range:g,worksheet:I}=m;p=!0,u.add(this._refRangeService.registerRefRange(g,R=>{const S=dt(g,R);return S&&Ge.equals(S,g)?{preRedos:[],preUndos:[],redos:[],undos:[]}:{preRedos:[{id:q.id,params:{unitId:e,subUnitId:t,row:n,col:s,id:c.rangeId,url:`#gid=${t}&range=${S?W(S):Z}`}}],undos:[{id:q.id,params:{unitId:e,subUnitId:t,row:n,col:s,id:c.rangeId,url:f}}],redos:[]}},I.getUnitId(),I.getSheetId()))}}}),p&&l.setValue(n,s,u)}}_initWorkbookLoad(){const e=t=>{const n=t.getUnitId();t.getSheets().forEach(s=>{const i=s.getSheetId(),a=this._enusreMap(n,i);s.getCellMatrix().forValue((r,o,d)=>{const l=a.getValue(r,o);l&&l.dispose(),d&&d.p&&this._registerRange(n,i,r,o,d.p)})})};this._univerInstanceService.getAllUnitsForType(M.UNIVER_SHEET).forEach(t=>{e(t)}),this.disposeWithMe(this._univerInstanceService.unitAdded$.subscribe(t=>{t.type===M.UNIVER_SHEET&&e(t)}))}_initWorkbookUnload(){this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(e=>{if(e.type===M.UNIVER_SHEET){const t=e,n=t.getUnitId();t.getSheets().forEach(s=>{const i=s.getSheetId();this._enusreMap(n,i).forValue((a,r,o)=>{o&&o.dispose()})}),this._refRangeMap.delete(n)}}))}_initSetRangesListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===T.id){const t=e.params,{unitId:n,subUnitId:s,cellValue:i}=t,a=this._enusreMap(n,s);i&&new X(i).forValue((r,o,d)=>{const l=a.getValue(r,o);l&&l.dispose(),d&&d.p&&this._registerRange(n,s,r,o,d.p)})}})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===q.id){const t=e.params,{unitId:n,subUnitId:s,row:i,col:a}=t,r=B(this._univerInstanceService,{unitId:n,subUnitId:s}),o=this._enusreMap(n,s).getValue(i,a);if(o&&o.dispose(),r){const{worksheet:d}=r,l=d.getCellRaw(i,a);l&&l.p&&this._registerRange(n,s,i,a,l.p)}}}))}};ne=kt([Ie(0,x),Ie(1,k),Ie(2,b(Ne))],ne);var wt=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},J=(e,t)=>(n,s)=>t(n,s,e);let ie=class extends O{constructor(e,t,n,s){super(),this._sheetInterceptorService=e,this._hyperLinkModel=t,this._selectionManagerService=n,this._univerInstanceService=s,this._initCommandInterceptor(),this._initAfterEditor()}_initCommandInterceptor(){this._initSetRangeValuesCommandInterceptor(),this._initClearSelectionCommandInterceptor()}_initSetRangeValuesCommandInterceptor(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:e=>{if(e.id===nt.id){const t=e.params,{unitId:n,subUnitId:s}=t,i=[],a=[];return t.cellValue&&new X(t.cellValue).forValue((r,o)=>{const d=this._hyperLinkModel.getHyperLinkByLocation(n,s,r,o);d&&(i.push({id:$.id,params:{unitId:n,subUnitId:s,id:d.id}}),a.push({id:P.id,params:{unitId:n,subUnitId:s,link:d}}))}),{undos:a,redos:i}}return{redos:[],undos:[]}}}))}_initClearSelectionCommandInterceptor(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:e=>{if(e.id===it.id||e.id===st.id||e.id===at.id){const t=[],n=[],s=this._selectionManagerService.getCurrentLastSelection(),i=B(this._univerInstanceService);if(s&&i){const{unitId:a,subUnitId:r}=i;Fe.foreach(s.range,(o,d)=>{const l=this._hyperLinkModel.getHyperLinkByLocation(a,r,o,d);l&&(t.push({id:$.id,params:{unitId:a,subUnitId:r,id:l.id}}),n.push({id:P.id,params:{unitId:a,subUnitId:r,link:l}}))})}return{redos:t,undos:n}}return{redos:[],undos:[]}}}))}_initAfterEditor(){this.disposeWithMe(this._sheetInterceptorService.writeCellInterceptor.intercept(rt,{handler:(e,t,n)=>{if(!e||e.p)return n(e);if(typeof e.v=="string"&&z.isLegalUrl(e.v)&&e.v[e.v.length-1]!==" "){const{unitId:s,subUnitId:i,row:a,col:r}=t,o=z.normalizeUrl(e.v),d=this._univerInstanceService.getUnit(s,M.UNIVER_SHEET),l=d==null?void 0:d.getSheetBySheetId(i);if(!l)return n(e);const u=l.getBlankCellDocumentModel(e,a,r);if(!u.documentModel)return n(e);const p=Q.selection.replace({selection:{startOffset:0,endOffset:e.v.length,collapsed:!1},body:{dataStream:`${e.v}`,customRanges:[{startIndex:0,endIndex:e.v.length-1,rangeId:de(),rangeType:N.HYPERLINK,properties:{url:o}}]},doc:u.documentModel});if(!p)return n(e);const c=u.documentModel.getBody();return oe.apply(c,p.serialize()),n({...e,p:{id:ze,body:c,documentStyle:{pageSize:{width:1/0,height:1/0}}}})}return n(e)}}))}};ie=wt([J(0,b(le)),J(1,b(v)),J(2,b(xe)),J(3,k)],ie);var Et=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},we=(e,t)=>(n,s)=>t(n,s,e);let se=class extends O{constructor(e,t){super(),this._resourceManagerService=e,this._hyperLinkModel=t,this._initSnapshot()}_initSnapshot(){const e=n=>{const s=this._hyperLinkModel.getUnit(n),i={};return s?(s.forEach(a=>{i[a.subUnitId]=a.links.map(({display:r,...o})=>o)}),JSON.stringify(i)):""},t=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:He,businesses:[M.UNIVER_SHEET],toJson:n=>e(n),parseJson:n=>t(n),onUnLoad:n=>{this._hyperLinkModel.deleteUnit(n)},onLoad:async(n,s)=>{Object.keys(s).forEach(i=>{s[i].forEach(a=>{this._hyperLinkModel.addHyperLink(n,i,a)})})}}))}};se=Et([we(0,Qe),we(1,b(v))],se);var Lt=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},Ct=(e,t)=>(n,s)=>t(n,s,e);let ae=class extends O{constructor(e){super(),this._commandService=e,this._registerCommands()}_registerCommands(){[ft,Mt,yt,St,vt,_t,P,_e,$,ye,q].forEach(e=>{this._commandService.registerCommand(e)})}};ae=Lt([Ct(0,x)],ae);var C=(e=>(e.SHEET="gid",e.RANGE="range",e.DEFINE_NAME="rangeid",e.INVALID="invalid",e.URL="url",e))(C||{}),Nt=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},fe=(e,t)=>(n,s)=>t(n,s,e);let ve=class{constructor(e,t,n){this._univerInstanceService=e,this._localeService=t,this._definedNamesService=n}buildHyperLink(e,t,n){return`#${C.SHEET}=${t}${n?`&${typeof n=="string"?C.DEFINE_NAME:C.RANGE}=${typeof n=="string"?n:W(n)}`:""}`}parseHyperLink(e){var t,n,s,i;if(e.startsWith("#")){const a=new URLSearchParams(e.slice(1)),r={gid:(t=a.get("gid"))!=null?t:"",range:(n=a.get("range"))!=null?n:"",rangeid:(s=a.get("rangeid"))!=null?s:"",unitid:(i=a.get("unitid"))!=null?i:""},o=this._getURLName(r);return{type:o.type,name:o.name,url:e,searchObj:r}}else return{type:C.URL,name:e,url:e,searchObj:null}}_getURLName(e){var t;const{gid:n,range:s,rangeid:i,unitid:a}=e,r=a?this._univerInstanceService.getUnit(a,M.UNIVER_SHEET):this._univerInstanceService.getCurrentUnitForType(M.UNIVER_SHEET),o={type:C.INVALID,name:this._localeService.t("hyperLink.message.refError")};if(!r)return o;const d=n?r.getSheetBySheetId(n):r.getActiveSheet(),l=(t=d==null?void 0:d.getName())!=null?t:"";if(s){if(!d)return o;const u=Ue(s).range;return be(u,d)&&s!==Z?{type:C.RANGE,name:tt(l,u)}:o}if(i){const u=this._definedNamesService.getValueById(r.getUnitId(),i);return u?{type:C.DEFINE_NAME,name:u.formulaOrRefString}:o}if(n){const u=r.getSheetBySheetId(n);return u?{type:C.SHEET,name:u.getName()}:o}return o}};ve=Nt([fe(0,k),fe(1,b(Xe)),fe(2,pt)],ve);var xt=Object.defineProperty,Ht=(e,t,n)=>t in e?xt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Vt=(e,t,n,s)=>{for(var i=t,a=e.length-1,r;a>=0;a--)(r=e[a])&&(i=r(i)||i);return i},Ee=(e,t)=>(n,s)=>t(n,s,e),Ve=(e,t,n)=>Ht(e,typeof t!="symbol"?t+"":t,n);let re=class extends Oe{constructor(e=ke,t,n){super(),this._config=e,this._injector=t,this._configService=n;const{...s}=De({},ke,this._config);this._configService.setConfig(bt,s)}onStarting(){Ae(this._injector,[[v],[ve],[se],[ae],[ee],[ie],[te],[ne]]),We(this._injector,[[ee],[se],[ae],[ie],[te],[ne]])}};Ve(re,"pluginName",He);Ve(re,"type",M.UNIVER_SHEET);re=Vt([Ye(ct),Ee(1,b(Je)),Ee(2,qe)],re);export{Mt as C,P as D,C as E,yt as I,vt as M,$ as N,_t as R,ft as S,_e as _,v as a,re as d,Z as t,ve as v,St as w,ye as y};
