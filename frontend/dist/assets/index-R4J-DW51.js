import{M as X,L as B,ab as K,ac as Ae,a3 as y,J as I,cM as v,b7 as Re,v as T,V as k,af as Pe,ai as Ie,dB as it,w as V,j as L,S as C,a4 as c,k as D,dK as xe,a0 as O,n as Ze,e2 as Rt,O as It,o as St,C as qe,e3 as Et,dr as st,e4 as yt,K as Mt,a6 as Vt,W as Ye,f as bt,$ as nt,Q as et,q as Ft,I as _,u as Xe,x as Nt,an as Tt,N as Ut}from"./TeamSpreadsheet-DqPQXi__.js";import{S as w,N as A,G as Q,b as S,v as E,j as Ct,F as G,Q as At,U as wt,C as Ot,h as we}from"./index-DT5UJx9J.js";import{nJ as Ke,lg as le,kA as lt,e5 as Lt,na as Bt,dy as P,z as ut,cK as Dt,eA as ot,eJ as xt,e4 as kt,jb as Ht,kz as Wt,je as $t,eH as jt,nS as Qt,lh as dt,km as Gt,G as ct}from"./index--BQDx9CP.js";import{m as Pt,j as ht,x as mt}from"./index-DNSnhRIr.js";var qt=Object.defineProperty,Yt=(t,e,r)=>e in t?qt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,m=(t,e,r)=>Yt(t,typeof e!="symbol"?e+"":e,r),Xt=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},ke=(t,e)=>(r,a)=>e(r,a,t);let j=class extends k{constructor(t,e,r){super(),m(this,"_cacheMatrix",new Map),m(this,"_dirtyRanges$",new Pe),m(this,"dirtyRanges$",this._dirtyRanges$.asObservable()),this._commandService=t,this._univerInstanceService=e,this._sheetDataValidationModel=r,this._initDirtyRanges(),this._initSheetRemove()}_initDirtyRanges(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===le.id){const{cellValue:e,unitId:r,subUnitId:a}=t.params;if(e){const i=new Ie(e).getDataRange();if(i.endRow===-1)return;const s=this._sheetDataValidationModel.getRules(r,a).map(n=>n.ranges).flat().map(n=>it(n,i)).filter(Boolean);s.length&&this.markRangeDirty(r,a,s,!0)}}}))}_initSheetRemove(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{var e;if(t.id===lt.id){const{unitId:r,subUnitId:a}=t.params;(e=this._cacheMatrix.get(r))==null||e.delete(a)}})),this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(t=>{t.type===V.UNIVER_SHEET&&this._cacheMatrix.delete(t.getUnitId())}))}_ensureCache(t,e){let r=this._cacheMatrix.get(t);r||(r=new Map,this._cacheMatrix.set(t,r));let a=r.get(e);return a||(a=new Ie,r.set(e,a)),a}ensureCache(t,e){return this._ensureCache(t,e)}addRule(t,e,r){this.markRangeDirty(t,e,r.ranges)}removeRule(t,e,r){this._deleteRange(t,e,r.ranges)}markRangeDirty(t,e,r,a){const i=this._ensureCache(t,e);r.forEach(s=>{L.foreach(s,(n,u)=>{i.getValue(n,u)!==void 0&&i.setValue(n,u,void 0)})}),this._dirtyRanges$.next({unitId:t,subUnitId:e,ranges:r,isSetRange:a})}_deleteRange(t,e,r){const a=this._ensureCache(t,e);r.forEach(i=>{L.foreach(i,(s,n)=>{a.realDeleteValue(s,n)})}),this._dirtyRanges$.next({unitId:t,subUnitId:e,ranges:r})}getValue(t,e,r,a){return this._ensureCache(t,e).getValue(r,a)}};j=Xt([ke(0,_(B)),ke(1,_(T)),ke(2,_(we))],j);function ne(t){var e,r;return(r=(e=t==null?void 0:t[0])==null?void 0:e[0])==null?void 0:r.v}function fe(t){var e;return(e=t==null?void 0:t[0])==null?void 0:e[0]}function b(t){return!Dt.has(t)}function ce(t,e){var r;const a=e.getValidatorItem(t);return(r=a==null?void 0:a.offsetFormulaByRange)!=null?r:!1}var Kt=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},ie=(t,e)=>(r,a)=>e(r,a,t);let x=class extends k{constructor(t,e,r,a,i){super(),m(this,"_ruleFormulaMap",new Map),m(this,"_ruleFormulaMap2",new Map),this._instanceSrv=t,this._registerOtherFormulaService=e,this._dataValidationModel=r,this._dataValidationCacheService=a,this._validatorRegistryService=i,this._initFormulaResultHandler(),this._initDirtyRanges()}dispose(){super.dispose(),this._ruleFormulaMap.clear(),this._ruleFormulaMap2.clear()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(t=>{for(const e in t){const r=t[e];if(this._instanceSrv.getUnitType(e)===V.UNIVER_SHEET)for(const a in r){const i=r[a],{ruleFormulaMap:s}=this._ensureMaps(e,a);i.forEach(n=>{var u,l;const o=s.get((u=n.extra)==null?void 0:u.ruleId),d=this._dataValidationModel.getRuleById(e,a,(l=n.extra)==null?void 0:l.ruleId);d&&o&&this._dataValidationCacheService.markRangeDirty(e,a,d.ranges)})}}}))}_ensureMaps(t,e){let r=this._ruleFormulaMap.get(t),a=this._ruleFormulaMap2.get(t);r||(r=new Map,this._ruleFormulaMap.set(t,r)),a||(a=new Map,this._ruleFormulaMap2.set(t,a));let i=r.get(e);i||(i=new Map,r.set(e,i));let s=a.get(e);return s||(s=new Map,a.set(e,s)),{ruleFormulaMap:i,ruleFormulaMap2:s}}_registerFormula(t,e,r,a,i){return this._registerOtherFormulaService.registerFormulaWithRange(t,e,a,i,{ruleId:r})}_handleDirtyRanges(t,e,r){this._dataValidationModel.getRules(t,e).forEach(a=>{const i=a.ranges;C.doAnyRangesIntersect(i,r)&&this.makeRuleDirty(t,e,a.uid)})}_initDirtyRanges(){this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.subscribe(t=>{t.isSetRange&&this._handleDirtyRanges(t.unitId,t.subUnitId,t.ranges)}))}deleteByRuleId(t,e,r){const{ruleFormulaMap:a,ruleFormulaMap2:i}=this._ensureMaps(t,e),s=this._dataValidationModel.getRuleById(t,e,r),n=a.get(r);if(!s||!n)return;const u=a.get(r);u&&(a.delete(r),this._registerOtherFormulaService.deleteFormula(t,e,[u.formulaId]));const l=i.get(r);l&&(i.delete(r),this._registerOtherFormulaService.deleteFormula(t,e,[l.formulaId]))}_addFormulaByRange(t,e,r,a,i,s){const{ruleFormulaMap:n,ruleFormulaMap2:u}=this._ensureMaps(t,e),l=s[0].startRow,o=s[0].startColumn;if(a&&v(a)){const d=this._registerFormula(t,e,r,a,s);n.set(r,{formula:a,originCol:o,originRow:l,formulaId:d})}if(i&&v(i)){const d=this._registerFormula(t,e,r,i,s);u.set(r,{formula:i,originCol:o,originRow:l,formulaId:d})}}addRule(t,e,r){if(ce(r.type,this._validatorRegistryService)){const{ranges:a,formula1:i,formula2:s,uid:n}=r;this._addFormulaByRange(t,e,n,i,s,a)}}async getCellFormulaValue(t,e,r,a,i){var s,n;const{ruleFormulaMap:u}=this._ensureMaps(t,e),l=u.get(r);if(!l)return Promise.resolve(void 0);const o=await this._registerOtherFormulaService.getFormulaValue(t,e,l.formulaId),{originRow:d,originCol:h}=l,g=a-d,p=i-h;return fe((n=(s=o==null?void 0:o.result)==null?void 0:s[g])==null?void 0:n[p])}async getCellFormula2Value(t,e,r,a,i){var s,n;const{ruleFormulaMap2:u}=this._ensureMaps(t,e),l=u.get(r);if(!l)return Promise.resolve(void 0);const o=await this._registerOtherFormulaService.getFormulaValue(t,e,l.formulaId),{originRow:d,originCol:h}=l,g=a-d,p=i-h;return fe((n=(s=o==null?void 0:o.result)==null?void 0:s[g])==null?void 0:n[p])}getCellFormulaValueSync(t,e,r,a,i){var s,n;const{ruleFormulaMap:u}=this._ensureMaps(t,e),l=u.get(r);if(!l)return;const o=this._registerOtherFormulaService.getFormulaValueSync(t,e,l.formulaId),{originRow:d,originCol:h}=l,g=a-d,p=i-h;return fe((n=(s=o==null?void 0:o.result)==null?void 0:s[g])==null?void 0:n[p])}getCellFormula2ValueSync(t,e,r,a,i){var s,n;const{ruleFormulaMap2:u}=this._ensureMaps(t,e),l=u.get(r);if(!l)return;const o=this._registerOtherFormulaService.getFormulaValueSync(t,e,l.formulaId),{originRow:d,originCol:h}=l,g=a-d,p=i-h;return fe((n=(s=o==null?void 0:o.result)==null?void 0:s[g])==null?void 0:n[p])}getRuleFormulaInfo(t,e,r){const{ruleFormulaMap:a}=this._ensureMaps(t,e);return a.get(r)}makeRuleDirty(t,e,r){var a,i,s,n;const u=(i=(a=this._ruleFormulaMap.get(t))==null?void 0:a.get(e))==null?void 0:i.get(r),l=(n=(s=this._ruleFormulaMap2.get(t))==null?void 0:s.get(e))==null?void 0:n.get(r);u&&this._registerOtherFormulaService.markFormulaDirty(t,e,u.formulaId),l&&this._registerOtherFormulaService.markFormulaDirty(t,e,l.formulaId)}};x=Kt([ie(0,T),ie(1,_(ht)),ie(2,_(we)),ie(3,_(j)),ie(4,_(G))],x);var Jt=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},se=(t,e)=>(r,a)=>e(r,a,t);let Y=class extends k{constructor(t,e,r,a,i){super(),m(this,"_formulaRuleMap",new Map),this._instanceService=t,this._registerOtherFormulaService=e,this._dataValidationCacheService=r,this._dataValidationModel=a,this._validatorRegistryService=i,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(t=>{for(const e in t){const r=t[e];if(this._instanceService.getUnitType(e)===V.UNIVER_SHEET)for(const a in r){const i=r[a],s=this._ensureRuleFormulaMap(e,a);i.forEach(n=>{var u,l;if(s.get((u=n.extra)==null?void 0:u.ruleId)){const o=this._dataValidationModel.getRuleById(e,a,(l=n.extra)==null?void 0:l.ruleId);o&&this._dataValidationCacheService.markRangeDirty(e,a,o.ranges)}})}}}))}_ensureRuleFormulaMap(t,e){let r=this._formulaRuleMap.get(t);r||(r=new Map,this._formulaRuleMap.set(t,r));let a=r.get(e);return a||(a=new Map,r.set(e,a)),a}_registerSingleFormula(t,e,r,a){const i=[{startColumn:0,endColumn:0,startRow:0,endRow:0}];return this._registerOtherFormulaService.registerFormulaWithRange(t,e,r,i,{ruleId:a})}addRule(t,e,r){if(!ce(r.type,this._validatorRegistryService)&&r.type!==y.CHECKBOX){const{formula1:a,formula2:i,uid:s}=r,n=v(a),u=v(i);if(!n&&!u)return;const l=this._ensureRuleFormulaMap(t,e),o=[void 0,void 0];if(n){const d=this._registerSingleFormula(t,e,a,s);o[0]={id:d,text:a}}if(u){const d=this._registerSingleFormula(t,e,i,s);o[1]={id:d,text:i}}l.set(s,o)}}removeRule(t,e,r){const a=this._ensureRuleFormulaMap(t,e).get(r);if(!a)return;const[i,s]=a,n=[i==null?void 0:i.id,s==null?void 0:s.id].filter(Boolean);n.length&&this._registerOtherFormulaService.deleteFormula(t,e,n)}getRuleFormulaResult(t,e,r){const a=this._ensureRuleFormulaMap(t,e).get(r);if(!a)return Promise.resolve(null);const i=async s=>s&&this._registerOtherFormulaService.getFormulaValue(t,e,s.id);return Promise.all([i(a[0]),i(a[1])])}getRuleFormulaResultSync(t,e,r){const a=this._ensureRuleFormulaMap(t,e).get(r);if(a)return a.map(i=>{if(i)return this._registerOtherFormulaService.getFormulaValueSync(t,e,i.id)})}getRuleFormulaInfo(t,e,r){return this._ensureRuleFormulaMap(t,e).get(r)}};Y=Jt([se(0,T),se(1,_(ht)),se(2,_(j)),se(3,_(we)),se(4,_(G))],Y);function ue(t){return Et(t)}function gt(t){var e;return String((e=ue(t))!=null?e:"")}class Je{constructor(e,r,a,i,s=!1){m(this,"_map"),m(this,"_tree",new yt),m(this,"_dirty",!0),m(this,"_buildTree",()=>{if(!this._dirty||this._disableTree)return;this._tree.clear();const n=[];this._map.forEach((u,l)=>{u.forEach(o=>{n.push({minX:o.startRow,maxX:o.endRow,minY:o.startColumn,maxY:o.endColumn,ruleId:l})})}),this._tree.load(n),this._dirty=!1}),m(this,"_debonceBuildTree",Mt(this._buildTree,0)),this._unitId=r,this._subUnitId=a,this._univerInstanceService=i,this._disableTree=s,this._map=e,this._buildTree()}get _worksheet(){var e;return(e=this._univerInstanceService.getUnit(this._unitId,V.UNIVER_SHEET))==null?void 0:e.getSheetBySheetId(this._subUnitId)}_addRule(e,r){if(!this._worksheet)return;const a=C.mergeRanges(r.map(i=>L.transformRange(i,this._worksheet)));this._map.forEach((i,s)=>{const n=C.subtractMulti(i,a);n.length===0?this._map.delete(s):this._map.set(s,n)}),this._dirty=!0,this._map.set(e,a),this._debonceBuildTree()}addRule(e){this._addRule(e.uid,e.ranges)}removeRange(e){if(!this._worksheet)return;const r=e.map(a=>L.transformRange(a,this._worksheet));this._map.forEach((a,i)=>{const s=C.subtractMulti(a,r);s.length===0?this._map.delete(i):this._map.set(i,s)}),this._dirty=!0,this._debonceBuildTree()}_removeRule(e){this._map.delete(e),this._dirty=!0,this._debonceBuildTree()}removeRule(e){this._removeRule(e.uid)}updateRange(e,r){this._removeRule(e),this._addRule(e,r)}addRangeRules(e){e.forEach(({id:r,ranges:a})=>{if(!a.length)return;let i=this._map.get(r);i?(this._map.set(r,C.mergeRanges([...i,...a])),i=this._map.get(r)):(i=a,this._map.set(r,i)),this._map.forEach((s,n)=>{if(n===r)return;const u=C.subtractMulti(s,a);u.length===0?this._map.delete(n):this._map.set(n,u)})}),this._dirty=!0,this._debonceBuildTree()}diff(e){const r=[];let a=0;return e.forEach((i,s)=>{var n;const u=(n=this._map.get(i.uid))!=null?n:[],l=i.ranges;u.length!==0&&(u.length!==l.length||u.some((o,d)=>!C.equals(o,l[d])))&&r.push({type:"update",ruleId:i.uid,oldRanges:l,newRanges:C.sort(u),rule:i}),u.length===0&&(r.push({type:"delete",rule:i,index:s-a}),a++)}),r}diffWithAddition(e,r){const a=[];let i=0;return e.forEach((s,n)=>{var u;const l=(u=this._map.get(s.uid))!=null?u:[],o=s.ranges;l.length!==0&&(l.length!==o.length||l.some((d,h)=>!C.equals(d,o[h])))&&a.push({type:"update",ruleId:s.uid,oldRanges:o,newRanges:C.sort(l),rule:s}),l.length===0&&(a.push({type:"delete",rule:s,index:n-i}),i++)}),Array.from(r).forEach(s=>{var n;const u=(n=this._map.get(s.uid))!=null?n:[];a.push({type:"add",rule:{...s,ranges:C.sort(u)}})}),a}clone(){return new Je(new Map(I.deepClone(Array.from(this._map.entries()))),this._unitId,this._subUnitId,this._univerInstanceService,!0)}getValue(e,r){this._dirty&&this._buildTree();const a=this._tree.search({minX:e,maxX:e,minY:r,maxY:r});return a.length>0?a[0].ruleId:void 0}}var zt=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},q=(t,e)=>(r,a)=>e(r,a,t);let M=class extends k{constructor(t,e,r,a,i,s,n){super(),m(this,"_ruleMatrixMap",new Map),m(this,"_validStatusChange$",new Pe),m(this,"_ruleChange$",new Pe),m(this,"ruleChange$",this._ruleChange$.asObservable()),m(this,"validStatusChange$",this._validStatusChange$.asObservable()),this._dataValidationModel=t,this._univerInstanceService=e,this._dataValidatorRegistryService=r,this._dataValidationCacheService=a,this._dataValidationFormulaService=i,this._dataValidationCustomFormulaService=s,this._commandService=n,this._initRuleUpdateListener(),this.disposeWithMe(()=>{this._ruleChange$.complete(),this._validStatusChange$.complete()}),this._initUniverInstanceListener()}_initUniverInstanceListener(){this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(t=>{this._ruleMatrixMap.delete(t.getUnitId())})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===lt.id){const{unitId:e,subUnitId:r}=t.params,a=this._ruleMatrixMap.get(e);a&&a.delete(r)}}))}_initRuleUpdateListener(){const t=this._dataValidationModel.getAll();for(const[e,r]of t)for(const[a,i]of r)for(const s of i)this._addRule(e,a,s),this._ruleChange$.next({type:"add",unitId:e,subUnitId:a,rule:s,source:"patched"});this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":this._addRule(e.unitId,e.subUnitId,e.rule);break;case"update":this._updateRule(e.unitId,e.subUnitId,e.rule.uid,e.oldRule,e.updatePayload);break;case"remove":this._removeRule(e.unitId,e.subUnitId,e.rule);break}this._ruleChange$.next(e)}))}_ensureRuleMatrix(t,e){let r=this._ruleMatrixMap.get(t);r||(r=new Map,this._ruleMatrixMap.set(t,r));let a=r.get(e);return a||(a=new Je(new Map,t,e,this._univerInstanceService),r.set(e,a)),a}_addRuleSideEffect(t,e,r){this._ensureRuleMatrix(t,e).addRule(r),this._dataValidationCacheService.addRule(t,e,r),this._dataValidationFormulaService.addRule(t,e,r),this._dataValidationCustomFormulaService.addRule(t,e,r)}_addRule(t,e,r){(Array.isArray(r)?r:[r]).forEach(a=>{this._addRuleSideEffect(t,e,a)})}_updateRule(t,e,r,a,i){const s=this._ensureRuleMatrix(t,e),n={...a,...i.payload};i.type===S.RANGE?s.updateRange(r,i.payload):i.type===S.ALL&&s.updateRange(r,i.payload.ranges),this._dataValidationCacheService.removeRule(t,e,a),this._dataValidationCacheService.addRule(t,e,n),this._dataValidationFormulaService.removeRule(t,e,a.uid),this._dataValidationFormulaService.addRule(t,e,n),this._dataValidationCustomFormulaService.deleteByRuleId(t,e,r),this._dataValidationCustomFormulaService.addRule(t,e,n)}_removeRule(t,e,r){this._ensureRuleMatrix(t,e).removeRule(r),this._dataValidationCacheService.removeRule(t,e,r),this._dataValidationCustomFormulaService.deleteByRuleId(t,e,r.uid)}getValidator(t){return this._dataValidatorRegistryService.getValidatorItem(t)}getRuleIdByLocation(t,e,r,a){return this._ensureRuleMatrix(t,e).getValue(r,a)}getRuleByLocation(t,e,r,a){const i=this.getRuleIdByLocation(t,e,r,a);if(i)return this._dataValidationModel.getRuleById(t,e,i)}validator(t,e,r){const{col:a,row:i,unitId:s,subUnitId:n,worksheet:u}=e,l=(p,R)=>{r&&r(p,R),R&&this._validStatusChange$.next({unitId:s,subUnitId:n,ruleId:t.uid,status:p,row:i,col:a})},o=u.getCellValueOnly(i,a),d=this.getValidator(t.type),h=u.getCellRaw(i,a),g=ue(h);if(d){const p=this._dataValidationCacheService.ensureCache(s,n),R=p.getValue(i,a);return R==null?(p.setValue(i,a,O.VALIDATING),d.validator({value:g,unitId:s,subUnitId:n,row:i,column:a,worksheet:e.worksheet,workbook:e.workbook,interceptValue:ue(o),t:h==null?void 0:h.t},t).then(N=>{const F=N?O.VALID:O.INVALID,f=p.getValue(i,a);F===O.VALID?p.realDeleteValue(i,a):p.setValue(i,a,F),l(F,R!==f)}),O.VALIDATING):(l(R??O.VALID,!1),R??O.VALID)}else return l(O.VALID,!1),O.VALID}getRuleObjectMatrix(t,e){return this._ensureRuleMatrix(t,e)}getRuleById(t,e,r){return this._dataValidationModel.getRuleById(t,e,r)}getRuleIndex(t,e,r){return this._dataValidationModel.getRuleIndex(t,e,r)}getRules(t,e){return[...this._dataValidationModel.getRules(t,e)]}getUnitRules(t){return this._dataValidationModel.getUnitRules(t)}deleteUnitRules(t){return this._dataValidationModel.deleteUnitRules(t)}getSubUnitIds(t){return this._dataValidationModel.getSubUnitIds(t)}getAll(){return this._dataValidationModel.getAll()}};M=zt([q(0,_(we)),q(1,T),q(2,_(G)),q(3,_(j)),q(4,_(Y)),q(5,_(x)),q(6,B)],M);const Se=1,Ee=0;function tt(t,e){return I.isBlank(t)?e.t("dataValidation.validFail.value"):v(t)?e.t("dataValidation.validFail.primitive"):""}const pe=t=>I.isDefine(t)&&String(t).toLowerCase()==="true"?"1":String(t).toLowerCase()==="false"?"0":t;class Zt extends Q{constructor(){super(...arguments),m(this,"id",y.CHECKBOX),m(this,"title","dataValidation.checkbox.title"),m(this,"operators",[]),m(this,"scopes",["sheet"]),m(this,"order",41),m(this,"offsetFormulaByRange",!1),m(this,"_formulaService",this.injector.get(Y)),m(this,"skipDefaultFontRender",(e,r,a)=>{const{unitId:i,subUnitId:s}=a,{formula1:n,formula2:u}=this.parseFormulaSync(e,i,s),l=`${r??""}`;return!l||l===`${n}`||l===`${u}`})}validatorFormula(e,r,a){const{formula1:i,formula2:s}=e,n=i===s;if(I.isBlank(i)&&I.isBlank(s))return{success:!0};if(n)return{success:!1,formula1:this.localeService.t("dataValidation.validFail.checkboxEqual"),formula2:this.localeService.t("dataValidation.validFail.checkboxEqual")};const u=tt(i,this.localeService),l=tt(s,this.localeService);return{success:!u&&!l,formula1:u,formula2:l}}async parseFormula(e,r,a){var i,s,n,u;const{formula1:l=Se,formula2:o=Ee}=e,d=await this._formulaService.getRuleFormulaResult(r,a,e.uid),h=v(l)?ne((s=(i=d==null?void 0:d[0])==null?void 0:i.result)==null?void 0:s[0][0]):l,g=v(o)?ne((u=(n=d==null?void 0:d[1])==null?void 0:n.result)==null?void 0:u[0][0]):o,p=b(String(h))&&b(String(g));return{formula1:pe(h),formula2:pe(g),originFormula1:h,originFormula2:g,isFormulaValid:p}}getExtraStyle(e,r){return{tb:Re.CLIP}}parseFormulaSync(e,r,a){var i,s,n,u;const{formula1:l=Se,formula2:o=Ee}=e,d=this._formulaService.getRuleFormulaResultSync(r,a,e.uid),h=v(l)?ne((s=(i=d==null?void 0:d[0])==null?void 0:i.result)==null?void 0:s[0][0]):l,g=v(o)?ne((u=(n=d==null?void 0:d[1])==null?void 0:n.result)==null?void 0:u[0][0]):o,p=b(String(h))&&b(String(g));return{formula1:pe(h),formula2:pe(g),originFormula1:h,originFormula2:g,isFormulaValid:p}}async isValidType(e,r,a){const{value:i,unitId:s,subUnitId:n}=e,{formula1:u,formula2:l,originFormula1:o,originFormula2:d}=await this.parseFormula(a,s,n);return!I.isDefine(u)||!I.isDefine(l)?!0:I.isDefine(i)&&(String(i)===String(u)||String(i)===String(l)||String(i)===String(o??"")||String(i)===String(d??""))}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.checkbox.error")}generateRuleName(e){return this.titleStr}}const er={[c.BETWEEN]:"dataValidation.date.operators.between",[c.EQUAL]:"dataValidation.date.operators.equal",[c.GREATER_THAN]:"dataValidation.date.operators.greaterThan",[c.GREATER_THAN_OR_EQUAL]:"dataValidation.date.operators.greaterThanOrEqual",[c.LESS_THAN]:"dataValidation.date.operators.lessThan",[c.LESS_THAN_OR_EQUAL]:"dataValidation.date.operators.lessThanOrEqual",[c.NOT_BETWEEN]:"dataValidation.date.operators.notBetween",[c.NOT_EQUAL]:"dataValidation.date.operators.notEqual"};c.BETWEEN+"",c.EQUAL+"",c.GREATER_THAN+"",c.GREATER_THAN_OR_EQUAL+"",c.LESS_THAN+"",c.LESS_THAN_OR_EQUAL+"",c.NOT_BETWEEN+"",c.NOT_EQUAL+"";const rt={[c.BETWEEN]:"dataValidation.date.ruleName.between",[c.EQUAL]:"dataValidation.date.ruleName.equal",[c.GREATER_THAN]:"dataValidation.date.ruleName.greaterThan",[c.GREATER_THAN_OR_EQUAL]:"dataValidation.date.ruleName.greaterThanOrEqual",[c.LESS_THAN]:"dataValidation.date.ruleName.lessThan",[c.LESS_THAN_OR_EQUAL]:"dataValidation.date.ruleName.lessThanOrEqual",[c.NOT_BETWEEN]:"dataValidation.date.ruleName.notBetween",[c.NOT_EQUAL]:"dataValidation.date.ruleName.notEqual",NONE:"dataValidation.date.ruleName.legal"},tr={[c.BETWEEN]:"dataValidation.date.errorMsg.between",[c.EQUAL]:"dataValidation.date.errorMsg.equal",[c.GREATER_THAN]:"dataValidation.date.errorMsg.greaterThan",[c.GREATER_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.greaterThanOrEqual",[c.LESS_THAN]:"dataValidation.date.errorMsg.lessThan",[c.LESS_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.lessThanOrEqual",[c.NOT_BETWEEN]:"dataValidation.date.errorMsg.notBetween",[c.NOT_EQUAL]:"dataValidation.date.errorMsg.notEqual",NONE:"dataValidation.date.errorMsg.legal"},Oe=[c.BETWEEN,c.NOT_BETWEEN],oe="{FORMULA1}",de="{FORMULA2}";function Lr(t){return t.filter(Boolean).join(",")}function _e(t){return t.split(",").filter(Boolean)}function Br(t){const e=ue(t);return e==null?"":e.toString()}function Le(t,e,r){const{formula1:a,formula2:i}=e,s=e.ranges[0].startRow,n=e.ranges[0].startColumn,u=r.row-s,l=r.col-n,o=v(a)?t.moveFormulaRefOffset(a,l,u,!0):a,d=v(i)?t.moveFormulaRefOffset(i,l,u,!0):i;return{transformedFormula1:o,transformedFormula2:d}}const He=t=>{var e,r;if(t==null||typeof t=="boolean")return;if(typeof t=="number"||!Number.isNaN(+t))return+t;const a=(e=D.parseDate(t))==null?void 0:e.v;return I.isDefine(a)?a:(r=D.parseDate(st(t).format("YYYY-MM-DD HH:mm:ss")))==null?void 0:r.v};class rr extends Q{constructor(){super(...arguments),m(this,"id",y.DATE),m(this,"title","dataValidation.date.title"),m(this,"order",40),m(this,"operators",[c.BETWEEN,c.EQUAL,c.GREATER_THAN,c.GREATER_THAN_OR_EQUAL,c.LESS_THAN,c.LESS_THAN_OR_EQUAL,c.NOT_BETWEEN,c.NOT_EQUAL]),m(this,"scopes",["sheet"]),m(this,"_customFormulaService",this.injector.get(x)),m(this,"_lexerTreeBuilder",this.injector.get(P))}async parseFormula(e,r,a,i,s){const n=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,s),u=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,s),{formula1:l,formula2:o}=e,d=b(String(n==null?void 0:n.v))&&b(String(u==null?void 0:u.v));return{formula1:He(v(l)?n==null?void 0:n.v:l),formula2:He(v(o)?u==null?void 0:u.v:o),isFormulaValid:d}}async isValidType(e){const{interceptValue:r,value:a}=e;return typeof a=="number"&&typeof r=="string"?!!D.parseDate(r):typeof r=="string"?!!D.parseDate(r):!1}_validatorSingleFormula(e){return!I.isBlank(e)&&(v(e)||!Number.isNaN(+e)||!!(e&&D.parseDate(e)))}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!0};const s=this._validatorSingleFormula(e.formula1),n=this.localeService.t("dataValidation.validFail.date");if(Oe.includes(i)){const u=this._validatorSingleFormula(e.formula2);return{success:s&&u,formula1:s?void 0:n,formula2:u?void 0:n}}return{success:s,formula1:s?void 0:n}}normalizeFormula(e,r,a){const{formula1:i,formula2:s,bizInfo:n}=e,u=l=>{var o;if(!l)return l;let d;if(!Number.isNaN(+l))d=D.dateFromSerial(+l);else{const h=(o=D.parseDate(l))==null?void 0:o.v;if(h==null)return"";d=D.dateFromSerial(h)}return st(`${d[0]}/${d[1]}/${d[2]} ${d[3]}:${d[4]}:${d[5]}`).format(n!=null&&n.showTime?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD")};return{formula1:v(i)?i:u(`${i}`),formula2:v(s)?s:u(`${s}`)}}transform(e,r,a){const{value:i}=e;return{...e,value:He(i)}}get operatorNames(){return this.operators.map(e=>this.localeService.t(er[e]))}generateRuleName(e){var r,a;if(!e.operator)return this.localeService.t(rt.NONE);const i=this.localeService.t(rt[e.operator]).replace(oe,(r=e.formula1)!=null?r:"").replace(de,(a=e.formula2)!=null?a:"");return`${this.titleStr} ${i}`}generateRuleErrorMessage(e,r){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Le(this._lexerTreeBuilder,e,r);return`${this.localeService.t(tr[e.operator]).replace(oe,a??"").replace(de,i??"")}`}}c.BETWEEN+"",c.EQUAL+"",c.GREATER_THAN+"",c.GREATER_THAN_OR_EQUAL+"",c.LESS_THAN+"",c.LESS_THAN_OR_EQUAL+"",c.NOT_BETWEEN+"",c.NOT_EQUAL+"";c.BETWEEN+"",c.EQUAL+"",c.GREATER_THAN+"",c.GREATER_THAN_OR_EQUAL+"",c.LESS_THAN+"",c.LESS_THAN_OR_EQUAL+"",c.NOT_BETWEEN+"",c.NOT_EQUAL+"";const ye={[c.BETWEEN]:"dataValidation.errorMsg.between",[c.EQUAL]:"dataValidation.errorMsg.equal",[c.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[c.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[c.LESS_THAN]:"dataValidation.errorMsg.lessThan",[c.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[c.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[c.NOT_EQUAL]:"dataValidation.errorMsg.notEqual",NONE:"dataValidation.errorMsg.legal"};function Me(t){return+t}class ar extends Q{constructor(){super(...arguments),m(this,"_customFormulaService",this.injector.get(x)),m(this,"id",y.DECIMAL),m(this,"_lexerTreeBuilder",this.injector.get(P)),m(this,"title","dataValidation.decimal.title"),m(this,"order",20),m(this,"operators",[c.BETWEEN,c.EQUAL,c.GREATER_THAN,c.GREATER_THAN_OR_EQUAL,c.LESS_THAN,c.LESS_THAN_OR_EQUAL,c.NOT_BETWEEN,c.NOT_EQUAL]),m(this,"scopes",["sheet"])}_isFormulaOrNumber(e){return!I.isBlank(e)&&(v(e)||!Number.isNaN(+e))}async isValidType(e,r,a){const{value:i}=e;return!Number.isNaN(Me(i))}transform(e,r,a){const{value:i}=e;return{...e,value:Me(i)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,r,a,i,s){const n=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,s),u=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,s),{formula1:l,formula2:o}=e,d=b(String(n==null?void 0:n.v))&&b(String(u==null?void 0:u.v));return{formula1:this._parseNumber(v(l)?n==null?void 0:n.v:l),formula2:this._parseNumber(v(o)?u==null?void 0:u.v:o),isFormulaValid:d}}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!0};const s=I.isDefine(e.formula1)&&this._isFormulaOrNumber(e.formula1),n=I.isDefine(e.formula2)&&this._isFormulaOrNumber(e.formula2),u=Oe.includes(i),l=this.localeService.t("dataValidation.validFail.number");return u?{success:s&&n,formula1:s?void 0:l,formula2:n?void 0:l}:{success:s,formula1:s?"":l}}generateRuleErrorMessage(e,r){if(!e.operator)return this.localeService.t(ye.NONE).replace("{TYPE}",this.titleStr);const{transformedFormula1:a,transformedFormula2:i}=Le(this._lexerTreeBuilder,e,r);return`${this.localeService.t(ye[e.operator]).replace(oe,a??"").replace(de,i??"")}`}}function We(t){if(!t)return[];const e=new Set;return t.forEach(r=>{r.forEach(a=>{var i,s;const n=ue(a);if(n!=null){if(typeof n!="string"&&typeof(a==null?void 0:a.s)=="object"&&(s=(i=a.s)==null?void 0:i.n)!=null&&s.pattern){e.add(D.format(a.s.n.pattern,n,{throws:!1}));return}b(n.toString())&&e.add(n.toString())}})}),[...e]}const ir=["if","indirect","choose","offset"];function sr(t,e){if(!v(t)||ot(t.slice(1)))return!0;const r=e.sequenceNodesBuilder(t);return r&&r.some(a=>typeof a=="object"&&a.nodeType===xt.FUNCTION&&ir.indexOf(a.token.toLowerCase())>-1)}function nr(t,e){const{formula1:r="",ranges:a}=t;if(ot(r.slice(1))){const i=kt(r.slice(1));if((!i.sheetName||i.sheetName===e)&&a.some(s=>C.intersects(s,i.range)))return!0}return!1}class ft extends Q{constructor(){super(...arguments),m(this,"formulaService",this.injector.get(Y)),m(this,"_lexer",this.injector.get(P)),m(this,"_univerInstanceService",this.injector.get(T)),m(this,"order",50),m(this,"offsetFormulaByRange",!1),m(this,"id",y.LIST),m(this,"title","dataValidation.list.title"),m(this,"operators",[]),m(this,"scopes",["sheet"]),m(this,"skipDefaultFontRender",e=>e.renderMode!==xe.TEXT)}validatorFormula(e,r,a){var i,s,n;const u=!I.isBlank(e.formula1),l=sr((i=e.formula1)!=null?i:"",this._lexer),o=(n=(s=this._univerInstanceService.getUnit(r,V.UNIVER_SHEET))==null?void 0:s.getSheetBySheetId(a))==null?void 0:n.getName(),d=nr(e,o??"");return{success:!!(u&&l&&!d),formula1:u?l?d?this.localeService.t("dataValidation.validFail.listIntersects"):void 0:this.localeService.t("dataValidation.validFail.listInvalid"):this.localeService.t("dataValidation.validFail.list")}}getExtraStyle(e,r,{style:a}){var i;const s=(i=a.tb!==Re.OVERFLOW?a.tb:Re.CLIP)!=null?i:Re.WRAP;if(e.type===y.LIST&&(e.renderMode===xe.ARROW||e.renderMode===xe.TEXT)){const n=this.getListWithColorMap(e),u=`${r??""}`,l=n[u];if(l)return{bg:{rgb:l},tb:s}}return{tb:s}}parseCellValue(e){const r=e.toString();return _e(r)}async parseFormula(e,r,a){var i,s;const n=await this.formulaService.getRuleFormulaResult(r,a,e.uid),u=ne((s=(i=n==null?void 0:n[0])==null?void 0:i.result)==null?void 0:s[0][0]);return{formula1:void 0,formula2:void 0,isFormulaValid:b(String(u))}}async isValidType(e,r,a){var i,s;const{value:n,unitId:u,subUnitId:l}=e,{formula1:o=""}=a,d=await this.formulaService.getRuleFormulaResult(u,l,a.uid),h=v(o)?We((s=(i=d==null?void 0:d[0])==null?void 0:i.result)==null?void 0:s[0][0]):_e(o);return this.parseCellValue(n).every(g=>h.includes(g))}generateRuleName(){return this.localeService.t("dataValidation.list.name")}generateRuleErrorMessage(){return this.localeService.t("dataValidation.list.error")}getList(e,r,a){var i,s,n,u;const{formula1:l=""}=e,o=this.injector.get(T),d=(i=r?o.getUniverSheetInstance(r):void 0)!=null?i:o.getCurrentUnitForType(V.UNIVER_SHEET);if(!d)return[];const h=(s=a?d.getSheetBySheetId(a):void 0)!=null?s:d.getActiveSheet();if(!h)return[];const g=d.getUnitId(),p=h.getSheetId(),R=this.formulaService.getRuleFormulaResultSync(g,p,e.uid);return v(l)?We((u=(n=R==null?void 0:R[0])==null?void 0:n.result)==null?void 0:u[0][0]):_e(l)}async getListAsync(e,r,a){var i,s,n,u;const{formula1:l=""}=e,o=this.injector.get(T),d=(i=r?o.getUniverSheetInstance(r):void 0)!=null?i:o.getCurrentUnitForType(V.UNIVER_SHEET);if(!d)return[];const h=(s=a?d.getSheetBySheetId(a):void 0)!=null?s:d.getActiveSheet();if(!h)return[];const g=d.getUnitId(),p=h.getSheetId(),R=await this.formulaService.getRuleFormulaResult(g,p,e.uid);return v(l)?We((u=(n=R==null?void 0:R[0])==null?void 0:n.result)==null?void 0:u[0][0]):_e(l)}getListWithColor(e,r,a){const i=this.getList(e,r,a),s=(e.formula2||"").split(",");return i.map((n,u)=>({label:n,color:s[u]}))}getListWithColorMap(e,r,a){const i=this.getListWithColor(e,r,a),s={};return i.forEach(n=>{n.color&&(s[n.label]=n.color)}),s}}class lr extends Q{constructor(){super(...arguments),m(this,"id",y.TEXT_LENGTH),m(this,"title","dataValidation.textLength.title"),m(this,"_lexerTreeBuilder",this.injector.get(P)),m(this,"order",30),m(this,"operators",[c.BETWEEN,c.EQUAL,c.GREATER_THAN,c.GREATER_THAN_OR_EQUAL,c.LESS_THAN,c.LESS_THAN_OR_EQUAL,c.NOT_BETWEEN,c.NOT_EQUAL]),m(this,"scopes",["sheet"]),m(this,"_customFormulaService",this.injector.get(x))}_isFormulaOrInt(e){return!I.isBlank(e)&&(v(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!1};const s=I.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),n=I.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),u=Oe.includes(i),l=this.localeService.t("dataValidation.validFail.number");return u?{success:s&&n,formula1:s?void 0:l,formula2:n?void 0:l}:{success:s,formula1:l}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,r,a,i,s){const n=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,s),u=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,s),{formula1:l,formula2:o}=e,d=b(String(n==null?void 0:n.v))&&b(String(u==null?void 0:u.v));return{formula1:this._parseNumber(v(l)?n==null?void 0:n.v:l),formula2:this._parseNumber(v(o)?u==null?void 0:u.v:o),isFormulaValid:d}}transform(e,r,a){return{...e,value:e.value.toString().length}}async isValidType(e,r,a){const{value:i}=e;return typeof i=="string"||typeof i=="number"}generateRuleErrorMessage(e,r){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Le(this._lexerTreeBuilder,e,r);return`${this.localeService.t(wt[e.operator]).replace(oe,a??"").replace(de,i??"")}`}}function pt(t){var e,r;return t?t.p?!((r=(e=t.p.body)==null?void 0:e.dataStream)!=null?r:"").slice(0,-2).trim():I.isBlank(t.v):!0}function Be(t,e,r,a,i="command",s=!0){const n=a.get(P),u=a.get(G),l=[],o=[],d=a.get(M),h=a.get(T),g=Ke(h,{unitId:t,subUnitId:e});if(!g)return{redoMutations:l,undoMutations:o};const{worksheet:p}=g,R=new Ie;let N=!1;function F(f,U){s&&f.forEach(H=>{L.foreach(H,(W,J)=>{const $=p.getCellRaw(W,J),z=gt($);(pt($)||z===U)&&!($!=null&&$.p)&&(N=!0,R.setValue(W,J,{v:U,p:null}))})})}if(r.forEach(f=>{switch(f.type){case"delete":l.push({id:A.id,params:{unitId:t,subUnitId:e,ruleId:f.rule.uid,source:i}}),o.unshift({id:w.id,params:{unitId:t,subUnitId:e,rule:f.rule,index:f.index,source:i}});break;case"update":{if(ce(f.rule.type,u)){const H=f.oldRanges[0].startRow,W=f.oldRanges[0].startColumn,J=f.newRanges[0].startRow,$=f.newRanges[0].startColumn,z=J-H,he=$-W,me=v(f.rule.formula1)?n.moveFormulaRefOffset(f.rule.formula1,he,z):f.rule.formula1,Z=v(f.rule.formula2)?n.moveFormulaRefOffset(f.rule.formula2,he,z):f.rule.formula2;me!==f.rule.formula1||Z!==f.rule.formula2||!nt(f.newRanges,f.oldRanges)?(l.push({id:E.id,params:{unitId:t,subUnitId:e,ruleId:f.ruleId,payload:{type:S.ALL,payload:{formula1:me,formula2:Z,ranges:f.newRanges}}}}),o.unshift({id:E.id,params:{unitId:t,subUnitId:e,ruleId:f.ruleId,payload:{type:S.ALL,payload:{formula1:f.rule.formula1,formula2:f.rule.formula2,ranges:f.oldRanges}}}})):(l.push({id:E.id,params:{unitId:t,subUnitId:e,ruleId:f.ruleId,payload:{type:S.RANGE,payload:f.newRanges},source:i}}),o.unshift({id:E.id,params:{unitId:t,subUnitId:e,ruleId:f.ruleId,payload:{type:S.RANGE,payload:f.oldRanges},source:i}}))}else l.push({id:E.id,params:{unitId:t,subUnitId:e,ruleId:f.ruleId,payload:{type:S.RANGE,payload:f.newRanges},source:i}}),o.unshift({id:E.id,params:{unitId:t,subUnitId:e,ruleId:f.ruleId,payload:{type:S.RANGE,payload:f.oldRanges},source:i}});const U=d.getRuleById(t,e,f.ruleId);if(U&&U.type===y.CHECKBOX){const H=d.getValidator(y.CHECKBOX).parseFormulaSync(U,t,e);F(f.newRanges,H.formula2)}break}case"add":{if(l.push({id:w.id,params:{unitId:t,subUnitId:e,rule:f.rule,source:i}}),o.unshift({id:A.id,params:{unitId:t,subUnitId:e,ruleId:f.rule.uid,source:i}}),f.rule.type===y.CHECKBOX){const U=d.getValidator(y.CHECKBOX).parseFormulaSync(f.rule,t,e);F(f.rule.ranges,U.originFormula2)}break}}}),N){const f={id:le.id,params:{unitId:t,subUnitId:e,cellValue:R.getData()}},U={id:le.id,params:dt(a,f.params)};l.push(f),o.push(U)}return{redoMutations:l,undoMutations:o}}const ur={type:X.COMMAND,id:"sheet.command.updateDataValidationRuleRange",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ranges:i,ruleId:s}=e,n=t.get(M),u=t.get(B),l=t.get(K);if(!n.getRuleById(r,a,s))return!1;const o=n.getRuleObjectMatrix(r,a).clone();o.updateRange(s,i);const d=o.diff(n.getRules(r,a)),{redoMutations:h,undoMutations:g}=Be(r,a,d,t);return l.pushUndoRedo({undoMutations:g,redoMutations:h,unitID:r}),Ae(h,u),!0}},or={type:X.COMMAND,id:"sheet.command.addDataValidation",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,rule:i}=e,s=t.get(M),n=t.get(B),u=t.get(K),l=s.getRuleObjectMatrix(r,a).clone();l.addRule(i);const o=l.diff(s.getRules(r,a)),d=s.getValidator(i.type),h={unitId:r,subUnitId:a,rule:{...i,...d==null?void 0:d.normalizeFormula(i,r,a)}},{redoMutations:g,undoMutations:p}=Be(r,a,o,t);return g.push({id:w.id,params:h}),p.unshift({id:A.id,params:{unitId:r,subUnitId:a,ruleId:i.uid}}),u.pushUndoRedo({unitID:r,redoMutations:g,undoMutations:p}),Ae(g,n),!0}},dr={type:X.COMMAND,id:"sheets.command.update-data-validation-setting",handler(t,e){if(!e)return!1;const r=t.get(B),a=t.get(K),i=t.get(M),s=t.get(G),{unitId:n,subUnitId:u,ruleId:l,setting:o}=e,d=s.getValidatorItem(o.type);if(!d)return!1;const h=i.getRuleById(n,u,l);if(!h)return!1;const g={...h,...o};if(!d.validatorFormula(g,n,u).success)return!1;const p={unitId:n,subUnitId:u,ruleId:l,payload:{type:S.SETTING,payload:{...o,...d.normalizeFormula(g,n,u)}}},R=[{id:E.id,params:p}],N={unitId:n,subUnitId:u,ruleId:l,payload:{type:S.SETTING,payload:At(h)}},F=[{id:E.id,params:N}];if(o.type===y.CHECKBOX){const f=h.ranges,U=t.get(T),H=Ke(U,{unitId:n,subUnitId:u});if(H){const W=new Ie,{worksheet:J}=H,{formula2:$=Ee,formula1:z=Se}=h,{formula2:he=Ee,formula1:me=Se}=o;let Z=!1;if(f.forEach(ge=>{L.foreach(ge,(ae,De)=>{const ee=J.getCellRaw(ae,De),ze=gt(ee);(pt(ee)||ze===String($))&&!(ee!=null&&ee.p)?(W.setValue(ae,De,{v:he,p:null}),Z=!0):ze===String(z)&&!(ee!=null&&ee.p)&&(W.setValue(ae,De,{v:me,p:null}),Z=!0)})}),Z){const ge={id:le.id,params:{unitId:n,subUnitId:u,cellValue:W.getData()}},ae={id:le.id,params:dt(t,ge.params)};R.push(ge),F.push(ae)}}}return Ae(R,r).result?(a.pushUndoRedo({unitID:n,redoMutations:R,undoMutations:F}),!0):!1}},cr={type:X.COMMAND,id:"sheets.command.update-data-validation-options",handler(t,e){if(!e)return!1;const r=t.get(B),a=t.get(K),i=t.get(M),{unitId:s,subUnitId:n,ruleId:u,options:l}=e,o=i.getRuleById(s,n,u);if(!o)return!1;const d={unitId:s,subUnitId:n,ruleId:u,payload:{type:S.OPTIONS,payload:l}},h=[{id:E.id,params:d}],g={unitId:s,subUnitId:n,ruleId:u,payload:{type:S.OPTIONS,payload:Ct(o)}},p=[{id:E.id,params:g}];return a.pushUndoRedo({unitID:s,redoMutations:h,undoMutations:p}),r.executeCommand(E.id,d),!0}},hr={type:X.COMMAND,id:"sheets.command.clear-range-data-validation",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ranges:i}=e,s=t.get(B),n=t.get(T),u=Ke(n,{unitId:r,subUnitId:a}),l=t.get(M);if(!u)return!1;const o=t.get(K),d=l.getRuleObjectMatrix(r,a).clone();d.removeRange(i);const h=d.diff(l.getRules(r,a)),{redoMutations:g,undoMutations:p}=Be(r,a,h,t);return o.pushUndoRedo({unitID:r,redoMutations:g,undoMutations:p}),Ae(g,s).result}},mr={type:X.COMMAND,id:"sheet.command.remove-all-data-validation",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a}=e,i=t.get(B),s=t.get(M),n=t.get(K),u=[...s.getRules(r,a)],l={unitId:r,subUnitId:a,ruleId:u.map(h=>h.uid)},o=[{id:A.id,params:l}],d=[{id:w.id,params:{unitId:r,subUnitId:a,rule:u}}];return n.pushUndoRedo({redoMutations:o,undoMutations:d,unitID:r}),i.executeCommand(A.id,l),!0}},gr=(t,e)=>{const r=t.get(M),{unitId:a,subUnitId:i,ruleId:s,source:n}=e;if(Array.isArray(s)){const u=s.map(l=>r.getRuleById(a,i,l)).filter(Boolean);return[{id:w.id,params:{unitId:a,subUnitId:i,rule:u,source:n}}]}return[{id:w.id,params:{unitId:a,subUnitId:i,rule:{...r.getRuleById(a,i,s)},index:r.getRuleIndex(a,i,s)}}]},fr={type:X.COMMAND,id:"sheet.command.remove-data-validation-rule",handler(t,e){if(!e)return!1;const{unitId:r,subUnitId:a,ruleId:i}=e,s=t.get(B),n=t.get(K),u=t.get(M),l=[{id:A.id,params:e}],o=[{id:w.id,params:{unitId:r,subUnitId:a,rule:{...u.getRuleById(r,a,i)},index:u.getRuleIndex(r,a,i)}}];return n.pushUndoRedo({undoMutations:o,redoMutations:l,unitID:e.unitId}),s.executeCommand(A.id,e),!0}},pr="SHEET_DATA_VALIDATION_PLUGIN";var _t=(t=>(t[t.View=0]="View",t[t.Edit=1]="Edit",t[t.ManageCollaborator=2]="ManageCollaborator",t[t.Print=3]="Print",t[t.Duplicate=4]="Duplicate",t[t.Comment=5]="Comment",t[t.Copy=6]="Copy",t[t.Share=7]="Share",t[t.Export=8]="Export",t[t.MoveWorksheet=9]="MoveWorksheet",t[t.DeleteWorksheet=10]="DeleteWorksheet",t[t.HideWorksheet=11]="HideWorksheet",t[t.RenameWorksheet=12]="RenameWorksheet",t[t.CreateWorksheet=13]="CreateWorksheet",t[t.SetWorksheetStyle=14]="SetWorksheetStyle",t[t.EditWorksheetCell=15]="EditWorksheetCell",t[t.InsertHyperlink=16]="InsertHyperlink",t[t.Sort=17]="Sort",t[t.Filter=18]="Filter",t[t.PivotTable=19]="PivotTable",t[t.FloatImg=20]="FloatImg",t[t.History=21]="History",t[t.RwHgtClWdt=22]="RwHgtClWdt",t[t.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",t[t.ViewFilter=24]="ViewFilter",t[t.MoveSheet=25]="MoveSheet",t[t.DeleteSheet=26]="DeleteSheet",t[t.HideSheet=27]="HideSheet",t[t.CopySheet=28]="CopySheet",t[t.RenameSheet=29]="RenameSheet",t[t.CreateSheet=30]="CreateSheet",t[t.SelectProtectedCells=31]="SelectProtectedCells",t[t.SelectUnProtectedCells=32]="SelectUnProtectedCells",t[t.SetCellStyle=33]="SetCellStyle",t[t.SetCellValue=34]="SetCellValue",t[t.SetRowStyle=35]="SetRowStyle",t[t.SetColumnStyle=36]="SetColumnStyle",t[t.InsertRow=37]="InsertRow",t[t.InsertColumn=38]="InsertColumn",t[t.DeleteRow=39]="DeleteRow",t[t.DeleteColumn=40]="DeleteColumn",t[t.EditExtraObject=41]="EditExtraObject",t[t.Delete=42]="Delete",t[t.RecoverHistory=43]="RecoverHistory",t[t.ViewHistory=44]="ViewHistory",t[t.CreatePermissionObject=45]="CreatePermissionObject",t[t.UNRECOGNIZED=-1]="UNRECOGNIZED",t))(_t||{}),_r=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},$e=(t,e)=>(r,a)=>e(r,a,t);let Ve=class extends k{constructor(t,e,r){super(),this._univerInstanceService=t,this._permissionService=e,this._lexerTreeBuilder=r}getFormulaRefCheck(t){var e,r;const a=this._lexerTreeBuilder.sequenceNodesBuilder(t);if(!a)return!0;for(let i=0;i<a.length;i++){const s=a[i];if(typeof s=="string")continue;const{token:n}=s,u=Lt(n),l=this._univerInstanceService.getCurrentUnitForType(V.UNIVER_SHEET);let o=l.getActiveSheet();const d=l.getUnitId();if(u.sheetName){if(o=l.getSheetBySheetName(u.sheetName),!o)return!1;const N=o==null?void 0:o.getSheetId();if(!this._permissionService.getPermissionPoint(new Bt(d,N).id))return!1}if(!o)return!1;const{startRow:h,endRow:g,startColumn:p,endColumn:R}=u.range;for(let N=h;N<=g;N++)for(let F=p;F<=R;F++){const f=(r=(e=o.getCell(N,F))==null?void 0:e.selectionProtection)==null?void 0:r[0];if((f==null?void 0:f[_t.View])===!1)return!1}}return!0}};Ve=_r([$e(0,T),$e(1,Tt),$e(2,_(P))],Ve);const vr="sheets-data-validation.config",at={};var Rr=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},je=(t,e)=>(r,a)=>e(r,a,t);let be=class extends k{constructor(t,e,r){super(),m(this,"_disposableMap",new Map),m(this,"registerRule",(a,i,s)=>{ce(s.type,this._validatorRegistryService)&&this.register(a,i,s)}),this._dataValidationModel=t,this._formulaRefRangeService=e,this._validatorRegistryService=r,this._initRefRange()}_getIdWithUnitId(t,e,r){return`${t}_${e}_${r}`}register(t,e,r){const a=r.ranges,i=r.formula1,s=r.formula2,n=this._formulaRefRangeService.registerRangeFormula(t,e,a,[i??"",s??""],l=>{if(l.length===0)return{undos:[{id:w.id,params:{unitId:t,subUnitId:e,rule:r,source:"patched"}}],redos:[{id:A.id,params:{unitId:t,subUnitId:e,ruleId:r.uid,source:"patched"}}]};const o=[],d=[],h=l[0];o.push({id:E.id,params:{unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:S.ALL,payload:{ranges:h.ranges,formula1:h.formulas[0],formula2:h.formulas[1]}},source:"patched"}}),d.push({id:E.id,params:{unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:S.ALL,payload:{ranges:a,formula1:i,formula2:s}},source:"patched"}});for(let g=1;g<l.length;g++){const p=l[g],R=qe();o.push({id:w.id,params:{unitId:t,subUnitId:e,rule:{...r,uid:R,formula1:p.formulas[0],formula2:p.formulas[1],ranges:p.ranges},source:"patched"}}),d.push({id:A.id,params:{unitId:t,subUnitId:e,ruleId:R,source:"patched"}})}return{undos:d,redos:o}}),u=this._getIdWithUnitId(t,e,r.uid);this._disposableMap.set(u,n)}_initRefRange(){const t=this._dataValidationModel.getAll();for(const[e,r]of t)for(const[a,i]of r)for(const s of i)this.registerRule(e,a,s);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{const{unitId:r,subUnitId:a,rule:i}=e;switch(e.type){case"add":{const s=e.rule;this.registerRule(e.unitId,e.subUnitId,s);break}case"remove":{const s=this._disposableMap.get(this._getIdWithUnitId(r,a,i.uid));s&&s.dispose();break}case"update":{const s=e.rule,n=this._disposableMap.get(this._getIdWithUnitId(r,a,s.uid));n&&n.dispose(),this.registerRule(e.unitId,e.subUnitId,s);break}}})),this.disposeWithMe(Ye(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}};be=Rr([je(0,_(M)),je(1,_(mt)),je(2,_(G))],be);var Ir=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},te=(t,e)=>(r,a)=>e(r,a,t);let Fe=class extends k{constructor(t,e,r,a,i,s){super(),m(this,"_disposableMap",new Map),m(this,"registerRule",(n,u,l)=>{ce(l.type,this._validatorRegistryService)||(this.register(n,u,l),this.registerFormula(n,u,l))}),this._dataValidationModel=t,this._injector=e,this._refRangeService=r,this._dataValidationFormulaService=a,this._formulaRefRangeService=i,this._validatorRegistryService=s,this._initRefRange()}_getIdWithUnitId(t,e,r){return`${t}_${e}_${r}`}registerFormula(t,e,r){var a;const i=r.uid,s=this._getIdWithUnitId(t,e,i),n=(a=this._disposableMap.get(s))!=null?a:new Set,u=(o,d)=>{const h=this._dataValidationModel.getRuleById(t,e,i);if(!h)return{redos:[],undos:[]};const g=h[o];if(!g||g===d)return{redos:[],undos:[]};const p={unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:S.SETTING,payload:{type:h.type,formula1:h.formula1,formula2:h.formula2,[o]:d}},source:"patched"},R={unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:S.SETTING,payload:{type:h.type,formula1:h.formula1,formula2:h.formula2}},source:"patched"},N=[{id:E.id,params:p}],F=[{id:E.id,params:R}];return{redos:N,undos:F}},l=this._dataValidationFormulaService.getRuleFormulaInfo(t,e,i);if(l){const[o,d]=l;if(o){const h=this._formulaRefRangeService.registerFormula(t,e,o.text,g=>u("formula1",g));n.add(()=>h.dispose())}if(d){const h=this._formulaRefRangeService.registerFormula(t,e,d.text,g=>u("formula2",g));n.add(()=>h.dispose())}}}register(t,e,r){var a;const i=l=>{const o=[...r.ranges],d=o.map(h=>Qt(h,l)).filter(h=>!!h).flat();if(nt(d,o))return{redos:[],undos:[]};if(d.length){const h={unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:S.RANGE,payload:d},source:"patched"},g=[{id:E.id,params:h}],p=[{id:E.id,params:{unitId:t,subUnitId:e,ruleId:r.uid,payload:{type:S.RANGE,payload:o},source:"patched"}}];return{redos:g,undos:p}}else{const h={unitId:t,subUnitId:e,ruleId:r.uid},g=[{id:A.id,params:h}],p=gr(this._injector,h);return{redos:g,undos:p}}},s=[];r.ranges.forEach(l=>{const o=this._refRangeService.registerRefRange(l,i,t,e);s.push(()=>o.dispose())});const n=this._getIdWithUnitId(t,e,r.uid),u=(a=this._disposableMap.get(n))!=null?a:new Set;u.add(()=>s.forEach(l=>l())),this._disposableMap.set(n,u)}_initRefRange(){const t=this._dataValidationModel.getAll();for(const[e,r]of t)for(const[a,i]of r)for(const s of i)this.registerRule(e,a,s);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{const{unitId:r,subUnitId:a,rule:i}=e;switch(e.type){case"add":{const s=e.rule;this.registerRule(e.unitId,e.subUnitId,s);break}case"remove":{const s=this._disposableMap.get(this._getIdWithUnitId(r,a,i.uid));s&&s.forEach(n=>n());break}case"update":{const s=e.rule,n=this._disposableMap.get(this._getIdWithUnitId(r,a,s.uid));n&&n.forEach(u=>u()),this.registerRule(e.unitId,e.subUnitId,s);break}}})),this.disposeWithMe(Ye(()=>{this._disposableMap.forEach(e=>{e.forEach(r=>r())}),this._disposableMap.clear()}))}};Fe=Ir([te(0,_(M)),te(1,_(Xe)),te(2,_(Gt)),te(3,_(Y)),te(4,_(mt)),te(5,_(G))],Fe);var Sr=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},Qe=(t,e)=>(r,a)=>e(r,a,t);let Ne=class extends k{constructor(t,e,r){super(),this._sheetInterceptorService=t,this._univerInstanceService=e,this._sheetDataValidationModel=r,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:t=>{var e;if(t.id===Wt.id){const r=t.params,a=r.unitId||this._univerInstanceService.getCurrentUnitForType(V.UNIVER_SHEET).getUnitId(),i=this._univerInstanceService.getUniverSheetInstance(a);if(!i)return{redos:[],undos:[]};const s=r.subUnitId||((e=i.getActiveSheet())==null?void 0:e.getSheetId());if(!s)return{redos:[],undos:[]};const n=this._sheetDataValidationModel.getRules(a,s);if(n.length===0)return{redos:[],undos:[]};const u=n.map(d=>d.uid),l={unitId:a,subUnitId:s,ruleId:u,source:"patched"},o={unitId:a,subUnitId:s,rule:[...n],source:"patched"};return{redos:[{id:A.id,params:l}],undos:[{id:w.id,params:o}]}}else if(t.id===$t.id){const r=t.params,{unitId:a,subUnitId:i,targetSubUnitId:s}=r;if(!a||!i||!s)return{redos:[],undos:[]};const n=this._sheetDataValidationModel.getRules(a,i);if(n.length===0)return{redos:[],undos:[]};const u=n.map(l=>({...l,uid:qe(6)}));return{redos:[{id:w.id,params:{unitId:a,subUnitId:s,rule:u,source:"patched"}}],undos:[{id:A.id,params:{unitId:a,subUnitId:s,ruleId:u.map(l=>l.uid),source:"patched"}}]}}return{redos:[],undos:[]}}}))}};Ne=Sr([Qe(0,_(ct)),Qe(1,_(T)),Qe(2,_(M))],Ne);class Er extends Q{constructor(){super(...arguments),m(this,"id",y.ANY),m(this,"title","dataValidation.any.title"),m(this,"operators",[]),m(this,"scopes",["sheet"]),m(this,"order",0),m(this,"offsetFormulaByRange",!1)}async parseFormula(e,r,a){return{formula1:e.formula1,formula2:e.formula2,isFormulaValid:!0}}validatorFormula(e,r,a){return{success:!0}}async isValidType(e,r,a){return!0}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.any.error")}}class yr extends Q{constructor(){super(...arguments),m(this,"id",y.CUSTOM),m(this,"title","dataValidation.custom.title"),m(this,"operators",[]),m(this,"scopes",["sheet"]),m(this,"order",60),m(this,"_customFormulaService",this.injector.get(x)),m(this,"_lexerTreeBuilder",this.injector.get(P))}validatorFormula(e,r,a){var i;const s=v(e.formula1),n=(i=e.formula1)!=null?i:"",u=this._lexerTreeBuilder.checkIfAddBracket(n)===0&&n.startsWith(jt.EQUALS);return{success:s&&u,formula1:s&&u?"":this.localeService.t("dataValidation.validFail.formula")}}async parseFormula(e,r,a){return{formula1:void 0,formula2:void 0,isFormulaValid:!0}}async isValidType(e,r,a){const{column:i,row:s,unitId:n,subUnitId:u}=e,l=await this._customFormulaService.getCellFormulaValue(n,u,a.uid,s,i),o=l==null?void 0:l.v;return b(String(o))&&I.isDefine(o)&&o!==""?l.t===bt.BOOLEAN?!!o:typeof o=="boolean"?o:typeof o=="number"?!!o:typeof o=="string"?b(o):!!o:!1}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.custom.error")}generateRuleName(e){var r;return this.localeService.t("dataValidation.custom.ruleName").replace("{FORMULA1}",(r=e.formula1)!=null?r:"")}}class Mr extends ft{constructor(){super(...arguments),m(this,"id",y.LIST_MULTIPLE),m(this,"title","dataValidation.listMultiple.title"),m(this,"offsetFormulaByRange",!1),m(this,"skipDefaultFontRender",()=>!0)}}class Vr extends Q{constructor(){super(...arguments),m(this,"_customFormulaService",this.injector.get(x)),m(this,"_lexerTreeBuilder",this.injector.get(P)),m(this,"id",y.WHOLE),m(this,"title","dataValidation.whole.title"),m(this,"order",10),m(this,"operators",[c.BETWEEN,c.EQUAL,c.GREATER_THAN,c.GREATER_THAN_OR_EQUAL,c.LESS_THAN,c.LESS_THAN_OR_EQUAL,c.NOT_BETWEEN,c.NOT_EQUAL]),m(this,"scopes",["sheet"])}_isFormulaOrInt(e){return!I.isBlank(e)&&(v(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}async isValidType(e,r,a){const{value:i}=e,s=Me(i);return!Number.isNaN(s)&&Number.isInteger(s)}transform(e,r,a){const{value:i}=e;return{...e,value:Me(i)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,r,a,i,s){const n=await this._customFormulaService.getCellFormulaValue(r,a,e.uid,i,s),u=await this._customFormulaService.getCellFormula2Value(r,a,e.uid,i,s),{formula1:l,formula2:o}=e,d=v(l)?n==null?void 0:n.v:l,h=v(o)?u==null?void 0:u.v:o,g=b(`${d}`)&&b(`${h}`);return{formula1:this._parseNumber(d),formula2:this._parseNumber(h),isFormulaValid:g}}validatorFormula(e,r,a){const i=e.operator;if(!i)return{success:!0};const s=I.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),n=I.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),u=Oe.includes(i),l=this.localeService.t("dataValidation.validFail.number");return u?{success:s&&n,formula1:s?void 0:l,formula2:n?void 0:l}:{success:s,formula1:l}}generateRuleErrorMessage(e,r){if(!e.operator)return this.localeService.t(ye.NONE).replace("{TYPE}",this.titleStr);const{transformedFormula1:a,transformedFormula2:i}=Le(this._lexerTreeBuilder,e,r);return`${this.localeService.t(ye[e.operator]).replace(oe,a??"").replace(de,i??"")}`}}var br=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},re=(t,e)=>(r,a)=>e(r,a,t);let Te=class extends Vt{constructor(t,e,r,a,i,s){super(),this._univerInstanceService=t,this._dataValidatorRegistryService=e,this._injector=r,this._selectionManagerService=a,this._sheetInterceptorService=i,this._sheetDataValidationModel=s,this._init()}_init(){this._registerValidators(),this._initCommandInterceptor()}_registerValidators(){[Er,ar,Vr,lr,rr,Zt,ft,Mr,yr].forEach(t=>{const e=this._injector.createInstance(t);this.disposeWithMe(this._dataValidatorRegistryService.register(e)),this.disposeWithMe(Ye(()=>this._injector.delete(t)))})}_initCommandInterceptor(){this._sheetInterceptorService.interceptCommand({getMutations:t=>{var e;if(t.id===Ht.id){const r=this._univerInstanceService.getCurrentUnitForType(V.UNIVER_SHEET),a=r.getUnitId(),i=r.getActiveSheet();if(!i)throw new Error("No active sheet found");const s=i.getSheetId(),n=(e=this._selectionManagerService.getCurrentSelections())==null?void 0:e.map(h=>h.range),u=this._sheetDataValidationModel.getRuleObjectMatrix(a,s).clone();n&&u.removeRange(n);const l=u.diff(this._sheetDataValidationModel.getRules(a,s)),{redoMutations:o,undoMutations:d}=Be(a,s,l,this._injector,"patched");return{undos:d,redos:o}}return{undos:[],redos:[]}}})}};Te=br([re(0,T),re(1,_(G)),re(2,_(Xe)),re(3,_(ut)),re(4,_(ct)),re(5,_(M))],Te);var Fr=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},ve=(t,e)=>(r,a)=>e(r,a,t);let Ue=class extends k{constructor(t,e,r,a){super(),this._univerInstanceService=t,this._sheetDataValidationModel=e,this._dataValidationCacheService=r,this._lifecycleService=a,this._initRecalculate()}_initRecalculate(){const t=e=>{if(e.length===0)return;const r=this._univerInstanceService.getCurrentUnitForType(V.UNIVER_SHEET),a=r==null?void 0:r.getActiveSheet(),i={};e.flat().forEach(s=>{i[s.unitId]||(i[s.unitId]={}),i[s.unitId][s.subUnitId]||(i[s.unitId][s.subUnitId]=[]);const n=this._univerInstanceService.getUnit(s.unitId,V.UNIVER_SHEET),u=n==null?void 0:n.getSheetBySheetId(s.subUnitId);u&&i[s.unitId][s.subUnitId].push(...s.ranges.map(l=>L.transformRange(l,u)))}),Object.entries(i).forEach(([s,n])=>{Object.entries(n).forEach(([u,l])=>{(r==null?void 0:r.getUnitId())===s&&(a==null?void 0:a.getSheetId())===u?this.validatorRanges(s,u,l):requestIdleCallback(()=>{this.validatorRanges(s,u,l)})})})};this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(Pt(()=>this._lifecycleService.lifecycle$.pipe(Ze(e=>e===et.Rendered)))).subscribe(t)),this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(Ze(()=>this._lifecycleService.stage>=et.Rendered),Rt(20)).subscribe(t))}async _validatorByCell(t,e,r,a){const i=t.getUnitId(),s=e.getSheetId();if(!I.isDefine(r)||!I.isDefine(a))throw new Error(`row or col is not defined, row: ${r}, col: ${a}`);const n=this._sheetDataValidationModel.getRuleByLocation(i,s,r,a);return n?new Promise(u=>{this._sheetDataValidationModel.validator(n,{unitId:i,subUnitId:s,row:r,col:a,worksheet:e,workbook:t},l=>{u(l)})}):O.VALID}async validatorCell(t,e,r,a){const i=this._univerInstanceService.getUnit(t,V.UNIVER_SHEET);if(!i)throw new Error(`cannot find current workbook, unitId: ${t}`);const s=i.getSheetBySheetId(e);if(!s)throw new Error(`cannot find current worksheet, sheetId: ${e}`);return this._validatorByCell(i,s,r,a)}validatorRanges(t,e,r){if(!r.length)return Promise.resolve([]);const a=this._univerInstanceService.getUnit(t,V.UNIVER_SHEET);if(!a)throw new Error(`cannot find current workbook, unitId: ${t}`);const i=a.getSheetBySheetId(e);if(!i)throw new Error(`cannot find current worksheet, sheetId: ${e}`);const s=this._sheetDataValidationModel.getRules(t,e).map(u=>u.ranges).flat(),n=r.map(u=>s.map(l=>it(u,l))).flat().filter(Boolean);return Promise.all(n.map(u=>{const l=[];return L.foreach(u,(o,d)=>{l.push(this._validatorByCell(a,i,o,d))}),Promise.all(l)}))}async validatorWorksheet(t,e){const r=this._univerInstanceService.getUnit(t,V.UNIVER_SHEET);if(!r)throw new Error(`cannot find current workbook, unitId: ${t}`);const a=r.getSheetBySheetId(e);if(!a)throw new Error(`cannot find current worksheet, sheetId: ${e}`);const i=this._sheetDataValidationModel.getRules(t,e);return await Promise.all(i.map(s=>Promise.all(s.ranges.map(n=>{const u=[];return L.foreach(n,(l,o)=>{u.push(this._validatorByCell(r,a,l,o))}),Promise.all(u)})))),this._dataValidationCacheService.ensureCache(t,e)}async validatorWorkbook(t){const e=this._sheetDataValidationModel.getSubUnitIds(t),r=await Promise.all(e.map(i=>this.validatorWorksheet(t,i))),a={};return r.forEach((i,s)=>{a[e[s]]=i}),a}getDataValidations(t,e,r){const a=this._sheetDataValidationModel.getRuleObjectMatrix(t,e),i=new Set;return r.forEach(s=>{L.foreach(s,(n,u)=>{const l=a.getValue(n,u);l&&i.add(l)})}),Array.from(i).map(s=>this._sheetDataValidationModel.getRuleById(t,e,s)).filter(Boolean)}getDataValidation(t,e,r){return this.getDataValidations(t,e,r)[0]}};Ue=Fr([ve(0,T),ve(1,_(M)),ve(2,_(j)),ve(3,_(Ut))],Ue);var Nr=Object.defineProperty,Tr=(t,e,r)=>e in t?Nr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Ur=(t,e,r,a)=>{for(var i=e,s=t.length-1,n;s>=0;s--)(n=t[s])&&(i=n(i)||i);return i},Ge=(t,e)=>(r,a)=>e(r,a,t),vt=(t,e,r)=>Tr(t,typeof e!="symbol"?e+"":e,r);let Ce=class extends It{constructor(t=at,e,r,a){super(),this._config=t,this._injector=e,this._commandService=r,this._configService=a;const{...i}=St({},at,this._config);this._configService.setConfig(vr,i)}onStarting(){[[j],[Y],[x],[Ue],[M],[Te],[Ve],[Ne],[Fe],[be]].forEach(t=>{this._injector.add(t)}),[or,ur,dr,cr,fr,mr,hr].forEach(t=>{this._commandService.registerCommand(t)}),this._injector.get(j),this._injector.get(Ue),this._injector.get(Te),this._injector.get(be),this._injector.get(Fe)}onReady(){this._injector.get(Ne)}onRendered(){this._injector.get(Ve)}};vt(Ce,"pluginName",pr);vt(Ce,"type",V.UNIVER_SHEET);Ce=Ur([Ft(Ot),Ge(1,_(Xe)),Ge(2,B),Ge(3,Nt)],Ce);function Dr(t){const e=t.get(ut).getCurrentSelections().map(r=>r.range);return{uid:qe(6),type:y.DECIMAL,operator:c.EQUAL,formula1:"100",ranges:e??[{startColumn:0,endColumn:0,startRow:0,endRow:0}]}}const xr="data-validation.custom-formula-input",kr="data-validation.formula-input",Hr="data-validation.list-formula-input",Wr="data-validation.checkbox-formula-input";export{b as C,Mr as D,Se as E,M as F,x as H,Ce as I,xr as J,Y as K,Le as L,j as Q,mr as R,fr as S,Ve as T,Be as U,Ee as V,Dr as Z,hr as _,Wr as a,pr as b,ft as c,_e as d,kr as e,cr as f,or as g,ue as h,Zt as i,fe as j,Lr as k,pe as l,ur as m,rr as n,ne as o,dr as p,Hr as t,Ue as w,Me as y,Br as z};
