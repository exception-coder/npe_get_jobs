import{L as H,a1 as E,v as z,dG as O,bQ as B,N as se,d as $,Q as L,n as g,c as ae,w as de,P as x,W as v,dJ as he,s as le,C as ce}from"./TeamSpreadsheet-DqPQXi__.js";import{I as G,a as ge}from"./facade-DLk4o3Z_.js";import{pv as f,q as k,I as j,ac as ue,pS as A,M as u,i as S,oC as P,rf as V,F as Z,o as N,q4 as D,j7 as ve,nM as we,oY as ee,rT as Ce,s5 as F,rP as q,sO as K,u as R,pm as b,q9 as T,w as me,r as be,fq as X,qd as M,oZ as U,oW as te,gv as pe,iz as Ee,qh as ke,pR as Se,m8 as fe,py as _e,pN as Ie,jX as Re,G as He,h as ye,k as Y,pV as J,D as Pe,oX as Ue,z as xe}from"./index--BQDx9CP.js";import{C as re,S as ne,Y as oe,H as W,k as ie}from"./facade-DJ8otAmv.js";class je extends G{_initSheetUIEvent(e){const r=e.get(H);this.registerEventHandler(this.Event.BeforeSheetEditStart,()=>r.beforeCommandExecuted(t=>{if(t.id!==f.id)return;const o=this.getActiveSheet();if(!o)return;const{workbook:i,worksheet:s}=o,h=e.get(k),l=t.params,{visible:c,keycode:w,eventType:a}=l,n=h.getEditLocation();if(c){const d={row:n.row,column:n.column,eventType:a,keycode:w,workbook:i,worksheet:s,isZenEditor:!1};if(this.fireEvent(this.Event.BeforeSheetEditStart,d),d.cancel)throw new E}})),this.registerEventHandler(this.Event.BeforeSheetEditEnd,()=>r.beforeCommandExecuted(t=>{if(t.id!==f.id)return;const o=this.getActiveSheet();if(!o)return;const{workbook:i,worksheet:s}=o,h=e.get(k),l=e.get(z),c=t.params,{visible:w,keycode:a,eventType:n}=c,d=h.getEditLocation();if(!w){const _={row:d.row,column:d.column,eventType:n,keycode:a,workbook:i,worksheet:s,isZenEditor:!1,value:O.create(l.getUnit(B).getSnapshot()),isConfirm:a!==j.ESC};if(this.fireEvent(this.Event.BeforeSheetEditEnd,_),_.cancel)throw new E}})),this.registerEventHandler(this.Event.SheetEditStarted,()=>r.onCommandExecuted(t=>{if(t.id!==f.id)return;const o=this.getCommandSheetTarget(t);if(!o)return;const{workbook:i,worksheet:s}=o,h=e.get(k),l=t.params,{visible:c,keycode:w,eventType:a}=l,n=h.getEditLocation();if(c){const d={row:n.row,column:n.column,eventType:a,keycode:w,workbook:i,worksheet:s,isZenEditor:!1};this.fireEvent(this.Event.SheetEditStarted,d)}})),this.registerEventHandler(this.Event.SheetEditEnded,()=>r.onCommandExecuted(t=>{if(t.id!==f.id)return;const o=this.getCommandSheetTarget(t);if(!o)return;const{workbook:i,worksheet:s}=o,h=e.get(k),l=t.params,{visible:c,keycode:w,eventType:a}=l,n=h.getEditLocation();if(!c){const d={row:n.row,column:n.column,eventType:a,keycode:w,workbook:i,worksheet:s,isZenEditor:!1,isConfirm:w!==j.ESC};this.fireEvent(this.Event.SheetEditEnded,d)}})),this.registerEventHandler(this.Event.SheetEditChanging,()=>r.onCommandExecuted(t=>{if(t.id!==ue.id)return;const o=this.getActiveSheet();if(!o)return;const{workbook:i,worksheet:s}=o,h=e.get(k),l=e.get(z),c=t.params;if(!h.isVisible().visible)return;const{unitId:w}=c;if(w===B){const{row:a,column:n}=h.getEditLocation(),d={workbook:i,worksheet:s,row:a,column:n,value:O.create(l.getUnit(B).getSnapshot()),isZenEditor:!1};this.fireEvent(this.Event.SheetEditChanging,d)}})),this.registerEventHandler(this.Event.BeforeSheetZoomChange,()=>r.beforeCommandExecuted(t=>{if(t.id!==A.id)return;const o=this.getCommandSheetTarget(t);if(!o)return;const{workbook:i,worksheet:s}=o,h={zoom:t.params.zoomRatio,workbook:i,worksheet:s};if(this.fireEvent(this.Event.BeforeSheetZoomChange,h),h.cancel)throw new E})),this.registerEventHandler(this.Event.SheetZoomChanged,()=>r.onCommandExecuted(t=>{if(t.id!==A.id)return;const o=this.getCommandSheetTarget(t);if(!o)return;const{workbook:i,worksheet:s}=o;this.fireEvent(this.Event.SheetZoomChanged,{zoom:s.getZoom(),workbook:i,worksheet:s})}))}_initObserverListener(e){const r=e.get(u),t=e.get(se),o=new $;this.disposeWithMe(t.lifecycle$.subscribe(l=>{if(l!==L.Rendered)return;o.dispose();const c=e.get(S),w=e.get(P);c&&(this.registerEventHandler(this.Event.CellClicked,()=>{var a;return(a=c.currentClickedCell$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.location.unitId,n.location.subUnitId);d&&this.fireEvent(this.Event.CellClicked,{...d,...n,row:n.location.row,column:n.location.col})})}),this.registerEventHandler(this.Event.CellHover,()=>{var a;return(a=c.currentRichText$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.CellHover,{...d,...n,row:n.row,column:n.col})})}),this.registerEventHandler(this.Event.CellPointerDown,()=>{var a;return(a=c.currentPointerDownCell$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.CellPointerDown,{...d,...n,row:n.row,column:n.col})})}),this.registerEventHandler(this.Event.CellPointerUp,()=>{var a;return(a=c.currentPointerUpCell$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.CellPointerUp,{...d,...n,row:n.row,column:n.col})})}),this.registerEventHandler(this.Event.CellPointerMove,()=>{var a;return(a=c.currentCellPosWithEvent$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.CellPointerMove,{...d,...n,row:n.row,column:n.col})})}),this.registerEventHandler(this.Event.DragOver,()=>{var a;return(a=w.currentCell$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.location.unitId,n.location.subUnitId);d&&this.fireEvent(this.Event.DragOver,{...d,...n,row:n.location.row,column:n.location.col})})}),this.registerEventHandler(this.Event.Drop,()=>{var a;return(a=w.endCell$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.location.unitId,n.location.subUnitId);d&&this.fireEvent(this.Event.Drop,{...d,...n,row:n.location.row,column:n.location.col})})}),this.registerEventHandler(this.Event.RowHeaderClick,()=>{var a;return(a=c.currentRowHeaderClick$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.RowHeaderClick,{...d,row:n.index})})}),this.registerEventHandler(this.Event.RowHeaderPointerDown,()=>{var a;return(a=c.currentRowHeaderPointerDown$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.RowHeaderPointerDown,{...d,row:n.index})})}),this.registerEventHandler(this.Event.RowHeaderPointerUp,()=>{var a;return(a=c.currentRowHeaderPointerUp$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.RowHeaderPointerUp,{...d,row:n.index})})}),this.registerEventHandler(this.Event.RowHeaderHover,()=>{var a;return(a=c.currentHoveredRowHeader$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.RowHeaderHover,{...d,row:n.index})})}),this.registerEventHandler(this.Event.ColumnHeaderClick,()=>{var a;return(a=c.currentColHeaderClick$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.ColumnHeaderClick,{...d,column:n.index})})}),this.registerEventHandler(this.Event.ColumnHeaderPointerDown,()=>{var a;return(a=c.currentColHeaderPointerDown$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.ColumnHeaderPointerDown,{...d,column:n.index})})}),this.registerEventHandler(this.Event.ColumnHeaderPointerUp,()=>{var a;return(a=c.currentColHeaderPointerUp$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.ColumnHeaderPointerUp,{...d,column:n.index})})}),this.registerEventHandler(this.Event.ColumnHeaderHover,()=>{var a;return(a=c.currentHoveredColHeader$)==null?void 0:a.pipe(g(n=>!!n)).subscribe(n=>{const d=this.getSheetTarget(n.unitId,n.subUnitId);d&&this.fireEvent(this.Event.ColumnHeaderHover,{...d,column:n.index})})}))})),this.disposeWithMe(o);const i=new Map;let s;const h=ae([r.created$,t.lifecycle$]);this.disposeWithMe(h.subscribe(([l,c])=>{var w;if(l.type===de.UNIVER_SHEET&&(s=l),c<=L.Rendered||!s)return;const a=new $,n=this.getWorkbook(s.unitId);if(!n)return;i.get(s.unitId)&&((w=i.get(s.unitId))==null||w.dispose()),i.set(s.unitId,a);const d=s.with(M),_=s.with(xe);a.add(this.registerEventHandler(this.Event.Scroll,()=>d.validViewportScrollInfo$.subscribe(C=>{C&&this.fireEvent(this.Event.Scroll,{workbook:n,worksheet:n.getActiveSheet(),...C})}))),a.add(this.registerEventHandler(this.Event.SelectionMoveStart,()=>_.selectionMoveStart$.subscribe(C=>{var m;this.fireEvent(this.Event.SelectionMoveStart,{workbook:n,worksheet:n.getActiveSheet(),selections:(m=C==null?void 0:C.map(I=>I.range))!=null?m:[]})}))),a.add(this.registerEventHandler(this.Event.SelectionMoving,()=>_.selectionMoving$.subscribe(C=>{var m;this.fireEvent(this.Event.SelectionMoving,{workbook:n,worksheet:n.getActiveSheet(),selections:(m=C==null?void 0:C.map(I=>I.range))!=null?m:[]})}))),a.add(this.registerEventHandler(this.Event.SelectionMoveEnd,()=>_.selectionMoveEnd$.subscribe(C=>{var m;this.fireEvent(this.Event.SelectionMoveEnd,{workbook:n,worksheet:n.getActiveSheet(),selections:(m=C==null?void 0:C.map(I=>I.range))!=null?m:[]})}))),a.add(this.registerEventHandler(this.Event.SelectionChanged,()=>_.selectionChanged$.subscribe(C=>{var m;this.fireEvent(this.Event.SelectionChanged,{workbook:n,worksheet:n.getActiveSheet(),selections:(m=C==null?void 0:C.map(I=>I.range))!=null?m:[]})}))),s=null,this.disposeWithMe(a)})),this.disposeWithMe(r.disposed$.subscribe(l=>{var c;(c=i.get(l))==null||c.dispose(),i.delete(l)})),this.disposeWithMe(()=>{i.forEach(l=>{l.dispose()})})}_initialize(e){this._initSheetUIEvent(e),this._initObserverListener(e);const r=e.get(H);this.registerEventHandler(this.Event.BeforeClipboardChange,()=>r.beforeCommandExecuted(t=>{switch(t.id){case Z.id:case V.id:this._beforeClipboardChange();break}})),this.registerEventHandler(this.Event.ClipboardChanged,()=>r.onCommandExecuted(t=>{switch(t.id){case Z.id:case V.id:this._clipboardChanged();break}})),this.registerEventHandler(this.Event.BeforeClipboardPaste,()=>r.beforeCommandExecuted(t=>{switch(t.id){case D.id:this._beforeClipboardPaste(t.params);break;case N.id:this._beforeClipboardPasteAsync();break}})),this.registerEventHandler(this.Event.ClipboardPasted,()=>r.onCommandExecuted(t=>{switch(t.id){case D.id:this._clipboardPaste(t.params);break;case N.id:this._clipboardPasteAsync();break}})),this.registerEventHandler(this.Event.SheetSkeletonChanged,()=>r.onCommandExecuted(t=>{if(ve.indexOf(t.id)>-1){const o=this.getActiveSheet();if(!o)return;const i=we(t,o.worksheet.getMaxColumns()).map(s=>{var h,l;return(l=(h=this.getWorkbook(s.unitId))==null?void 0:h.getSheetBySheetId(s.subUnitId))==null?void 0:l.getRange(s.range)}).filter(Boolean);if(!i.length)return;this.fireEvent(this.Event.SheetSkeletonChanged,{workbook:o.workbook,worksheet:o.worksheet,payload:t,skeleton:o.worksheet.getSkeleton(),effectedRanges:i})}}))}_generateClipboardCopyParam(){const e=this.getActiveWorkbook(),r=e==null?void 0:e.getActiveSheet(),t=e==null?void 0:e.getActiveRange();if(!e||!r||!t)return;const o=this._injector.get(ee).generateCopyContent(e.getId(),r.getSheetId(),t.getRange());if(!o)return;const{html:i,plain:s}=o;return{workbook:e,worksheet:r,text:s,html:i,fromSheet:r,fromRange:t}}_beforeClipboardChange(){const e=this._generateClipboardCopyParam();if(e&&(this.fireEvent(this.Event.BeforeClipboardChange,e),e.cancel))throw new E}_clipboardChanged(){const e=this._generateClipboardCopyParam();e&&this.fireEvent(this.Event.ClipboardChanged,e)}_generateClipboardPasteParam(e){if(!e)return;const{htmlContent:r,textContent:t}=e,o=this.getActiveWorkbook(),i=o==null?void 0:o.getActiveSheet();return!o||!i?void 0:{workbook:o,worksheet:i,text:t,html:r}}async _generateClipboardPasteParamAsync(){const e=this.getActiveWorkbook(),r=e==null?void 0:e.getActiveSheet();if(!e||!r)return;const t=(await this._injector.get(Ce).read())[0];let o;if(t){const i=t.types,s=i.indexOf(F)!==-1?await t.getType(F).then(l=>l&&l.text()):"",h=i.indexOf(q)!==-1?await t.getType(q).then(l=>l&&l.text()):"";o={workbook:e,worksheet:r,text:s,html:h}}return o}_beforeClipboardPaste(e){const r=this._generateClipboardPasteParam(e);if(r&&(this.fireEvent(this.Event.BeforeClipboardPaste,r),r.cancel))throw new E}_clipboardPaste(e){const r=this._generateClipboardPasteParam(e);if(r&&(this.fireEvent(this.Event.ClipboardPasted,r),r.cancel))throw new E}async _beforeClipboardPasteAsync(){if(!K()){this._injector.get(x).warn("[Facade]: The navigator object only supports the browser environment");return}const e=await this._generateClipboardPasteParamAsync();if(e&&(this.fireEvent(this.Event.BeforeClipboardPaste,e),e.cancel))throw new E}async _clipboardPasteAsync(){if(!K()){this._injector.get(x).warn("[Facade]: The navigator object only supports the browser environment");return}const e=await this._generateClipboardPasteParamAsync();if(e&&(this.fireEvent(this.Event.ClipboardPasted,e),e.cancel))throw new E}customizeColumnHeader(e){var r,t;const o=this.getActiveWorkbook();if(!o){console.error("WorkBook not exist");return}const i=o==null?void 0:o.getId(),s=this._injector.get(u),h=o.getActiveSheet(),l=h.getSheetId(),c=s.getRenderById(i);c&&(r=e.headerStyle)!=null&&r.size&&(c.with(R).setColumnHeaderSize(c,l,(t=e.headerStyle)==null?void 0:t.size),h==null||h.refreshCanvas()),this._getSheetRenderComponent(i,b.COLUMN).setCustomHeader(e),h==null||h.refreshCanvas()}customizeRowHeader(e){const r=this.getActiveWorkbook();if(!r){console.error("WorkBook not exist");return}const t=r==null?void 0:r.getId();this._getSheetRenderComponent(t,b.ROW).setCustomHeader(e)}registerSheetRowHeaderExtension(e,...r){const t=this._getSheetRenderComponent(e,b.ROW),o=t.register(...r);return v(()=>{o.dispose(),t.makeDirty(!0)})}registerSheetColumnHeaderExtension(e,...r){const t=this._getSheetRenderComponent(e,b.COLUMN),o=t.register(...r);return v(()=>{o.dispose(),t.makeDirty(!0)})}registerSheetMainExtension(e,...r){const t=this._getSheetRenderComponent(e,b.MAIN),o=t.register(...r);return v(()=>{o.dispose(),t.makeDirty(!0)})}_getSheetRenderComponent(e,r){const t=this._injector.get(u).getRenderById(e);if(!t)throw new Error(`Render Unit with unitId ${e} not found`);const{components:o}=t,i=o.get(r);if(!i)throw new Error("Render component not found");return i}getSheetHooks(){return this._injector.createInstance(W)}pasteIntoSheet(e,r,t){return this._commandService.executeCommand(D.id,{htmlContent:e,textContent:r,files:t})}setProtectedRangeShadowStrategy(e){this._injector.get(T).setProtectedRangeShadowStrategy(e)}getProtectedRangeShadowStrategy(){return this._injector.get(T).getProtectedRangeShadowStrategy()}getProtectedRangeShadowStrategy$(){return this._injector.get(T).getProtectedRangeShadowStrategy$()}}G.extend(je);class Me extends re{openSiderbar(e){return this._logDeprecation("openSiderbar"),this._injector.get(me).open(e)}openDialog(e){this._logDeprecation("openDialog");const r=this._injector.get(be).open({...e,onClose:()=>{r.dispose()}});return r}customizeColumnHeader(e){const r=this._workbook.getUnitId();this._getSheetRenderComponent(r,b.COLUMN).setCustomHeader(e)}customizeRowHeader(e){const r=this._workbook.getUnitId();this._getSheetRenderComponent(r,b.ROW).setCustomHeader(e)}_getSheetRenderComponent(e,r){const t=this._injector.get(u).getRenderById(e);if(!t)throw new Error(`Render Unit with unitId ${e} not found`);const{components:o}=t,i=o.get(r);if(!i)throw new Error("Render component not found");return i}_logDeprecation(e){this._injector.get(x).warn("[FWorkbook]",`${e} is deprecated. Please use the function of the same name on "FUniver".`)}generateCellParams(e){const r=this.getActiveSheet();return{row:e.row,column:e.col,workbook:this,worksheet:r}}onCellClick(e){const r=this._injector.get(S);return v(r.currentClickedCell$.pipe(g(t=>!!t)).subscribe(t=>{e(t)}))}onCellHover(e){const r=this._injector.get(S);return v(r.currentRichText$.pipe(g(t=>!!t)).subscribe(e))}onCellPointerDown(e){const r=this._injector.get(S);return v(r.currentPointerDownCell$.subscribe(e))}onCellPointerUp(e){const r=this._injector.get(S);return v(r.currentPointerUpCell$.subscribe(e))}onCellPointerMove(e){const r=this._injector.get(S);return v(r.currentCellPosWithEvent$.pipe(g(t=>!!t)).subscribe(t=>{e(t,t.event)}))}onDragOver(e){const r=this._injector.get(P);return v(r.currentCell$.pipe(g(t=>!!t)).subscribe(t=>{e(t)}))}onDrop(e){const r=this._injector.get(P);return v(r.endCell$.pipe(g(t=>!!t)).subscribe(t=>{e(t)}))}startEditing(){const e=this._injector.get(H);return this._injector.get(k).isVisible().visible?!0:e.syncExecuteCommand(f.id,{eventType:X.Dblclick,unitId:this._workbook.getUnitId(),visible:!0})}async endEditing(e){const r=this._injector.get(H);return this._injector.get(k).isVisible().visible&&r.syncExecuteCommand(f.id,{eventType:X.Keyboard,keycode:e?j.ENTER:j.ESC,visible:!1,unitId:this._workbook.getUnitId()}),await he(0),!0}endEditingAsync(e=!0){return this.endEditing(e)}abortEditingAsync(){return this.endEditingAsync(!1)}isCellEditing(){return this._injector.get(k).isVisible().visible}getScrollStateBySheetId(e){const r=this._workbook.getUnitId(),t=this._injector.get(u).getRenderById(r);return t?t.with(M).getScrollStateByParam({unitId:r,sheetId:e}):null}disableSelection(){const e=this._workbook.getUnitId(),r=this._injector.get(u).getRenderById(e);return r&&r.with(U).disableSelection(),this}enableSelection(){const e=this._workbook.getUnitId(),r=this._injector.get(u).getRenderById(e);return r&&r.with(U).enableSelection(),this}transparentSelection(){const e=this._workbook.getUnitId(),r=this._injector.get(u).getRenderById(e);return r&&r.with(U).transparentSelection(),this}showSelection(){const e=this._workbook.getUnitId(),r=this._injector.get(u).getRenderById(e);return r&&r.with(U).showSelection(),this}}re.extend(Me);class Be extends ne{refreshCanvas(){const e=this._injector.get(u),r=this._fWorkbook.id,t=e.getRenderById(r);if(!t)throw new Error(`Render Unit with unitId ${r} not found`);t.with(R).reCalculate();const o=t.mainComponent;if(!o)throw new Error("Main component not found");return o.makeDirty(),this}highlightRanges(e,r,t){const o=this._injector.get(te),i=[];for(const s of e){const h=s.getRange(),l=o.addShapeWithNoFresh({range:h,style:r,primary:t});l&&i.push(l)}if(o.refreshShapes(),i.length===0)throw new Error("Failed to highlight current range");return v(()=>{i.forEach(s=>{o.removeShape(s)})})}zoom(e){const r=this._injector.get(H),t=Math.min(Math.max(e,.1),4);return r.executeCommand(A.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),zoomRatio:t}),this}getZoom(){return this._worksheet.getZoomRatio()}getVisibleRange(){const e=this._workbook.getUnitId(),r=this._injector.get(u).getRenderById(e);let t={startColumn:0,startRow:0,endColumn:0,endRow:0};if(!r)return t;const o=r.with(R).getCurrentSkeleton();if(!o)return t;const i=o==null?void 0:o.getVisibleRanges();if(!i)return t;t=o.getVisibleRangeByViewport(pe.VIEW_MAIN);for(const[s,h]of i)Ee.indexOf(s)!==-1&&(t.startColumn=Math.min(t.startColumn,h.startColumn),t.startRow=Math.min(t.startRow,h.startRow),t.endColumn=Math.max(t.endColumn,h.endColumn),t.endRow=Math.max(t.endRow,h.endRow));return t}scrollToCell(e,r,t){const o=this._workbook.getUnitId(),i=this._injector.get(u).getRenderById(o);return i&&(i==null?void 0:i.with(ke)).scrollToCell(e,r,t),this}getScrollState(){const e={offsetX:0,offsetY:0,sheetViewStartColumn:0,sheetViewStartRow:0},r=this._workbook.getUnitId(),t=this._worksheet.getSheetId(),o=this._injector.get(u).getRenderById(r);return o&&o.with(M).getScrollStateByParam({unitId:r,sheetId:t})||e}onScroll(e){var r;const t=this._workbook.getUnitId(),o=(r=this._injector.get(u).getRenderById(t))==null?void 0:r.with(M);if(o){const i=o.validViewportScrollInfo$.subscribe(s=>{e(s)});return v(i)}return v(()=>{})}getSkeleton(){var e,r;const t=(e=this._injector.get(u).getRenderById(this._workbook.getUnitId()))==null?void 0:e.with(R);return(r=t==null?void 0:t.getWorksheetSkeleton(this._worksheet.getSheetId()))==null?void 0:r.skeleton}autoResizeColumn(e){return this.autoResizeColumns(e,1)}autoResizeColumns(e,r){const t=this._workbook.getUnitId(),o=this._worksheet.getSheetId(),i=[{startColumn:e,endColumn:e+r-1,startRow:0,endRow:this._worksheet.getRowCount()-1}];return this._commandService.syncExecuteCommand(Se.id,{unitId:t,subUnitId:o,ranges:i}),this}setColumnAutoWidth(e,r){return this.autoResizeColumns(e,r)}autoResizeRows(e,r){const t=this._workbook.getUnitId(),o=this._worksheet.getSheetId(),i=[{startRow:e,endRow:e+r-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1}];return this._commandService.syncExecuteCommand(fe.id,{unitId:t,subUnitId:o,ranges:i}),this}customizeColumnHeader(e){var r,t;const o=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),s=this._injector.get(u).getRenderById(o);s&&(r=e.headerStyle)!=null&&r.size&&s.with(R).setColumnHeaderSize(s,i,(t=e.headerStyle)==null?void 0:t.size),this._getSheetRenderComponent(o,b.COLUMN).setCustomHeader(e,i)}customizeRowHeader(e){var r,t;const o=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),s=this._injector.get(u).getRenderById(o);s&&(r=e.headerStyle)!=null&&r.size&&s.with(R).setRowHeaderSize(s,i,(t=e.headerStyle)==null?void 0:t.size),this._getSheetRenderComponent(o,b.ROW).setCustomHeader(e,i)}setColumnHeaderHeight(e){const r=this._workbook.getUnitId(),t=this._worksheet.getSheetId();return this._commandService.executeCommand(_e.id,{unitId:r,subUnitId:t,size:e}),this}setRowHeaderWidth(e){const r=this._workbook.getUnitId(),t=this._worksheet.getSheetId();return this._commandService.executeCommand(Ie.id,{unitId:r,subUnitId:t,size:e}),this}_getSheetRenderComponent(e,r){const t=this._injector.get(u).getRenderById(e);if(!t)throw new Error(`Render Unit with unitId ${e} not found`);const{components:o}=t,i=o.get(r);if(!i)throw new Error("Render component not found");return i}}ne.extend(Be);class De extends oe{setPermissionDialogVisible(e){this._permissionService.setShowComponents(e)}}oe.extend(De);class Te extends W{onCellPointerMove(e){return v(this._injector.get(S).currentPosition$.subscribe(e))}onCellPointerOver(e){return v(this._injector.get(S).currentCell$.subscribe(e))}onCellDragOver(e){return v(this._injector.get(P).currentCell$.subscribe(e))}onCellDrop(e){return v(this._injector.get(P).endCell$.subscribe(e))}onCellRender(e,r=le.Style,t=Re.DATA_VALIDATION){return this._injector.get(He).intercept(ye.CELL_CONTENT,{effect:r,handler:(o,i,s)=>(o&&!o.customRender&&e&&(o.customRender=[...e]),s(o)),priority:t})}onBeforeCellEdit(e){return this._injector.get(H).beforeCommandExecuted(r=>{const t=r.params;r.id===f.id&&t.visible&&e(t)})}onAfterCellEdit(e){return this._injector.get(H).onCommandExecuted(r=>{const t=r.params;r.id===f.id&&!t.visible&&e(t)})}}W.extend(Te);const y={CellClicked:"CellClicked",CellPointerDown:"CellPointerDown",CellPointerUp:"CellPointerUp",CellPointerMove:"CellPointerMove",CellHover:"CellHover"};class $e{get BeforeClipboardChange(){return"BeforeClipboardChange"}get ClipboardChanged(){return"ClipboardChanged"}get BeforeClipboardPaste(){return"BeforeClipboardPaste"}get ClipboardPasted(){return"ClipboardPasted"}get BeforeSheetEditStart(){return"BeforeSheetEditStart"}get SheetEditStarted(){return"SheetEditStarted"}get SheetEditChanging(){return"SheetEditChanging"}get BeforeSheetEditEnd(){return"BeforeSheetEditEnd"}get SheetEditEnded(){return"SheetEditEnded"}get CellClicked(){return y.CellClicked}get CellHover(){return y.CellHover}get CellPointerDown(){return y.CellPointerDown}get CellPointerUp(){return y.CellPointerUp}get CellPointerMove(){return y.CellPointerMove}get DragOver(){return"DragOver"}get Drop(){return"Drop"}get Scroll(){return"Scroll"}get SelectionMoveStart(){return"SelectionMoveStart"}get SelectionChanged(){return"SelectionChanged"}get SelectionMoving(){return"SelectionMoving"}get SelectionMoveEnd(){return"SelectionMoveEnd"}get RowHeaderClick(){return"RowHeaderClick"}get RowHeaderPointerDown(){return"RowHeaderPointerDown"}get RowHeaderPointerUp(){return"RowHeaderPointerUp"}get RowHeaderHover(){return"RowHeaderHover"}get ColumnHeaderClick(){return"ColumnHeaderClick"}get ColumnHeaderPointerDown(){return"ColumnHeaderPointerDown"}get ColumnHeaderPointerUp(){return"ColumnHeaderPointerUp"}get ColumnHeaderHover(){return"ColumnHeaderHover"}get SheetSkeletonChanged(){return"SheetSkeletonChanged"}get BeforeSheetZoomChange(){return"BeforeSheetZoomChange"}get SheetZoomChanged(){return"SheetZoomChanged"}}ge.extend($e);class Ae extends ie{getCell(){var e;const r=this._injector.get(u),t=this._injector.get(x),o=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),s=r.getRenderById(o),h=(e=s==null?void 0:s.with(R).getSkeletonParam(i))==null?void 0:e.skeleton;if(!h)throw t.error("[Facade]: `FRange.getCell` can only be called in current worksheet"),new Error("`FRange.getCell` can only be called in current worksheet");return h.getCellWithCoordByIndex(this._range.startRow,this._range.startColumn)}getCellRect(){const{startX:e,startY:r,endX:t,endY:o}=this.getCell(),i={x:e,y:r,width:t-e,height:o-r,top:r,left:e,bottom:o,right:t};return{...i,toJSON:()=>JSON.stringify(i)}}generateHTML(){var e;const r=this._injector.get(ee).generateCopyContent(this._workbook.getUnitId(),this._worksheet.getSheetId(),this._range);return(e=r==null?void 0:r.html)!=null?e:""}attachPopup(e){var r,t,o;e.direction=(r=e.direction)!=null?r:"horizontal",e.extraProps=(t=e.extraProps)!=null?t:{},e.offset=(o=e.offset)!=null?o:[0,0];const{key:i,disposableCollection:s}=Q(e,this._injector.get(Y)),h=this._injector.get(J).attachPopupToCell(this._range.startRow,this._range.startColumn,{...e,componentKey:i},this.getUnitId(),this._worksheet.getSheetId());return h?(s.add(h),s):(s.dispose(),null)}attachAlertPopup(e){const r=this._injector.get(Pe),t={workbook:this._workbook,worksheet:this._worksheet,row:this._range.startRow,col:this._range.startColumn,unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId()};return r.showAlert({...e,location:t}),{dispose:()=>{r.removeAlert(e.key)}}}attachRangePopup(e){var r,t,o;e.direction=(r=e.direction)!=null?r:"top-center",e.extraProps=(t=e.extraProps)!=null?t:{},e.offset=(o=e.offset)!=null?o:[0,0];const{key:i,disposableCollection:s}=Q(e,this._injector.get(Y)),h=this._injector.get(J).attachRangePopup(this._range,{...e,componentKey:i},this.getUnitId(),this._worksheet.getSheetId());return h?(s.add(h),s):(s.dispose(),null)}highlight(e,r){const t=this._injector.get(te),o=t.addShape({range:this._range,style:e,primary:r});if(!o)throw new Error("Failed to highlight current range");return v(()=>{t.removeShape(o)})}showDropdown(e){return this._injector.get(Ue).showDropdown(e)}}ie.extend(Ae);function Q(p,e){const{componentKey:r,isVue3:t}=p;let o;const i=new $;return typeof r=="string"?o=r:(o=`External_${ce(6)}`,i.add(e.register(o,r,{framework:t?"vue3":"react"}))),{key:o,disposableCollection:i}}export{Q as q};
