import{V as q,af as un,ai as cn,w as T,ap as mn,W as Ie,O as lt,z as hn,C as oe,q as ut,I as b,u as Ze,L as P,v as Q,M as ct,o as Ut,c4 as vn,F as mt,df as Ue,a5 as st,n as kt,e as ze,bC as pn,bQ as gn,bV as Xe,cy as Cn,J as qe,x as Mt,d as fn,s as In,j as Et,a9 as gt,S as _n,b as bn,a1 as Te,dG as _e,cN as wn}from"./TeamSpreadsheet-DqPQXi__.js";import{eO as Z,nT as xn,eK as at,kz as Sn,je as yn,km as Un,z as ht,G as Rt,d as E,t6 as H,w as $t,sT as kn,sv as Mn,be as En,I as dt,ao as Rn,bA as $n,nJ as Tn,r0 as jn,c as Tt,B as jt,H as Nt,h as Nn,or as Pn,kg as Je,na as Ge,mu as Ye,u as An,lG as Bn,pp as Dn,s2 as Ct,rb as Ln,ra as Vn,sd as Hn,oW as Pt,pV as On,j as Wn,ou as Fn,M as At,oY as Zn,i as zn,mb as Bt,q as qn,n as Jn,k as Gn,R as Yn,e4 as Qn}from"./index--BQDx9CP.js";import{z as ft,R as be,E as ce,I as Dt,i as ve,p as Lt,h as we,Q as se,Z as Ae,t as ae,X as xe,e as Se}from"./index-CGM0O1y3.js";import{r as g,j as m,L as It,v as Be,i as et,R as Kn,p as Xn,k as er,c as tr,a as Vt,I as Ht}from"./facade-DLk4o3Z_.js";import{k as vt,C as Ot,S as Wt}from"./facade-DJ8otAmv.js";import"./index-mJOBftNs.js";import"./VRow-C6N6h8s9.js";import"./VCard-DFIDGoOa.js";import"./VSelect-CO5xudFf.js";import"./VTextField-tFIcna6m.js";import"./VTabs-BYSgCciz.js";import"./VAlert-CfJUBCCM.js";import"./VDialog-C4Wnh1zS.js";import"./VFileInput-DBMVcNlc.js";import"./VTextarea-34QBZFhW.js";var nr=Object.defineProperty,rr=(t,e,n)=>e in t?nr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,re=(t,e,n)=>rr(t,typeof e!="symbol"?e+"":e,n),ir=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},_t=(t,e)=>(n,r)=>e(n,r,t);let A=class extends q{constructor(t,e){super(),re(this,"_matrixMap",new Map),re(this,"_locationMap",new Map),re(this,"_commentUpdate$",new un),re(this,"commentUpdate$",this._commentUpdate$.asObservable()),this._threadCommentModel=t,this._univerInstanceService=e,this._init(),this.disposeWithMe(()=>{this._commentUpdate$.complete()})}_init(){this._initData(),this._initUpdateTransform()}_ensureCommentMatrix(t,e){let n=this._matrixMap.get(t);n||(n=new Map,this._matrixMap.set(t,n));let r=n.get(e);return r||(r=new cn,n.set(e,r)),r}_ensureCommentLocationMap(t,e){let n=this._locationMap.get(t);n||(n=new Map,this._locationMap.set(t,n));let r=n.get(e);return r||(r=new Map,n.set(e,r)),r}_addCommentToMatrix(t,e,n,r){var i;const o=(i=t.getValue(e,n))!=null?i:new Set;o.add(r),t.setValue(e,n,o)}_deleteCommentFromMatrix(t,e,n,r){if(e>=0&&n>=0){const i=t.getValue(e,n);i&&i.has(r)&&(i.delete(r),i.size===0&&t.realDeleteValue(e,n))}}_ensure(t,e){const n=this._ensureCommentMatrix(t,e),r=this._ensureCommentLocationMap(t,e);return{matrix:n,locationMap:r}}_initData(){const t=this._threadCommentModel.getAll();for(const e of t)for(const n of e.threads){const{unitId:r,subUnitId:i,root:o}=n;this._addComment(r,i,o)}}_addComment(t,e,n){const r=Z(n.ref),i=n.parentId,{row:o,column:s}=r,a=n.id,{matrix:d,locationMap:l}=this._ensure(t,e);!i&&o>=0&&s>=0&&(this._addCommentToMatrix(d,o,s,a),l.set(a,{row:o,column:s})),i||this._commentUpdate$.next({unitId:t,subUnitId:e,payload:n,type:"add",isRoot:!i,...r})}_initUpdateTransform(){this.disposeWithMe(this._threadCommentModel.commentUpdate$.subscribe(t=>{const{unitId:e,subUnitId:n}=t;try{if(this._univerInstanceService.getUnitType(e)!==T.UNIVER_SHEET)return}catch{}const{matrix:r,locationMap:i}=this._ensure(e,n);switch(t.type){case"add":{this._addComment(t.unitId,t.subUnitId,t.payload);break}case"delete":{const{isRoot:o,comment:s}=t.payload;if(o){const a=Z(s.ref),{row:d,column:l}=a;this._deleteCommentFromMatrix(r,d,l,s.id),this._commentUpdate$.next({...t,...a})}break}case"update":{const{commentId:o}=t.payload,s=this._threadCommentModel.getComment(e,n,o);if(!s)return;const a=Z(s.ref);this._commentUpdate$.next({...t,...a});break}case"updateRef":{const o=Z(t.payload.ref),{commentId:s}=t.payload,a=i.get(s);if(!a)return;const{row:d,column:l}=a;this._deleteCommentFromMatrix(r,d,l,s),i.delete(s),o.row>=0&&o.column>=0&&(this._addCommentToMatrix(r,o.row,o.column,s),i.set(s,{row:o.row,column:o.column})),this._commentUpdate$.next({...t,...o});break}case"resolve":{const{unitId:o,subUnitId:s,payload:a}=t,{locationMap:d}=this._ensure(o,s),l=d.get(a.commentId);l&&this._commentUpdate$.next({...t,...l});break}}}))}getByLocation(t,e,n,r){var i;return(i=this.getAllByLocation(t,e,n,r).filter(o=>!o.resolved)[0])==null?void 0:i.id}getAllByLocation(t,e,n,r){const i=this._ensureCommentMatrix(t,e).getValue(n,r);return i?Array.from(i).map(o=>this.getComment(t,e,o)).filter(Boolean):[]}getComment(t,e,n){return this._threadCommentModel.getComment(t,e,n)}getCommentWithChildren(t,e,n,r){const i=this.getByLocation(t,e,n,r);if(!i)return;const o=this.getComment(t,e,i);if(o)return this._threadCommentModel.getThread(t,e,o.threadId)}showCommentMarker(t,e,n,r){const i=this.getByLocation(t,e,n,r);if(!i)return!1;const o=this.getComment(t,e,i);return!!(o&&!o.resolved)}getSubUnitAll(t,e){return this._threadCommentModel.getUnit(t).filter(n=>n.subUnitId===e).map(n=>n.root)}};A=ir([_t(0,b(ve)),_t(1,Q)],A);var or=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},Ce=(t,e)=>(n,r)=>e(n,r,t);let De=class extends q{constructor(e,n,r,i,o){super(),re(this,"_disposableMap",new Map),re(this,"_watcherMap",new Map),re(this,"_handleRangeChange",(s,a,d,l,c)=>{const u=d.id,p={startColumn:d.column,endColumn:d.column,startRow:d.row,endRow:d.row};return l?{redos:[{id:ft.id,params:{unitId:s,subUnitId:a,payload:{ref:at(l),commentId:u},silent:c}}],undos:[{id:ft.id,params:{unitId:s,subUnitId:a,payload:{ref:at(p),commentId:u},silent:c}}]}:{redos:[{id:ce.id,params:{unitId:s,subUnitId:a,commentId:u}}],undos:[{id:be.id,params:{unitId:s,subUnitId:a,comment:d,sync:!0}}]}}),this._refRangeService=e,this._sheetsThreadCommentModel=n,this._threadCommentModel=r,this._selectionManagerService=i,this._commandService=o,this._initData(),this._initRefRange()}_getIdWithUnitId(e,n,r){return`${e}-${n}-${r}`}_register(e,n,r){const i=r.id,o={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._disposableMap.set(this._getIdWithUnitId(e,n,i),this._refRangeService.registerRefRange(o,s=>{const a=xn(o,s,{selectionManagerService:this._selectionManagerService}),d=Array.isArray(a)?a[0]:a;return d&&d.startColumn===o.startColumn&&d.startRow===o.startRow?{undos:[],redos:[]}:this._handleRangeChange(e,n,r,d,!1)},e,n))}_watch(e,n,r){const i=r.id,o={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._watcherMap.set(this._getIdWithUnitId(e,n,i),this._refRangeService.watchRange(e,n,o,(s,a)=>{const{redos:d}=this._handleRangeChange(e,n,r,a,!0);mn(d,this._commandService,{onlyLocal:!0})},!0))}_unwatch(e,n,r){var i;const o=this._getIdWithUnitId(e,n,r);(i=this._watcherMap.get(o))==null||i.dispose(),this._watcherMap.delete(o)}_unregister(e,n,r){var i;const o=this._getIdWithUnitId(e,n,r);(i=this._disposableMap.get(o))==null||i.dispose(),this._disposableMap.delete(o)}_initData(){const e=this._threadCommentModel.getAll();for(const n of e)for(const r of n.threads){const{unitId:i,subUnitId:o,root:s}=r,a=Z(s.ref),d={...s,...a};this._register(i,o,d),this._watch(i,o,d)}}_initRefRange(){this.disposeWithMe(this._sheetsThreadCommentModel.commentUpdate$.subscribe(e=>{const{unitId:n,subUnitId:r}=e;switch(e.type){case"add":{if(e.payload.parentId)return;const i={...e.payload,row:e.row,column:e.column};this._register(e.unitId,e.subUnitId,i),this._watch(e.unitId,e.subUnitId,i);break}case"delete":{this._unregister(n,r,e.payload.commentId),this._unwatch(n,r,e.payload.commentId);break}case"updateRef":{const i=this._sheetsThreadCommentModel.getComment(n,r,e.payload.commentId);if(!i)return;this._unregister(n,r,e.payload.commentId);const o={...i,row:e.row,column:e.column};e.silent||(this._unwatch(n,r,e.payload.commentId),this._watch(n,r,o)),this._register(e.unitId,e.subUnitId,o);break}}})),this.disposeWithMe(Ie(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}};De=or([Ce(0,b(Un)),Ce(1,b(A)),Ce(2,b(ve)),Ce(3,b(ht)),Ce(4,P)],De);const sr={};var ar=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},je=(t,e)=>(n,r)=>e(n,r,t);let Le=class extends q{constructor(t,e,n,r){super(),this._univerInstanceService=t,this._sheetInterceptorService=e,this._threadCommentModel=n,this._threadCommentDataSourceService=r,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:t=>{var e;if(t.id===Sn.id){const n=t.params,r=n.unitId||this._univerInstanceService.getCurrentUnitOfType(T.UNIVER_SHEET).getUnitId(),i=n.subUnitId||((e=this._univerInstanceService.getCurrentUnitOfType(T.UNIVER_SHEET).getActiveSheet())==null?void 0:e.getSheetId());if(!r||!i)return{redos:[],undos:[]};const o=this._threadCommentModel.ensureMap(r,i),s=Array.from(o.values()).filter(c=>!c.parentId),a=this._threadCommentDataSourceService.syncUpdateMutationToColla,d=[],l=[];return s.forEach(({children:c,...u})=>{d.push({id:ce.id,params:{unitId:r,subUnitId:i,commentId:u.id}}),l.push({id:be.id,params:{unitId:r,subUnitId:i,comment:{...u,children:a?c:void 0},sync:!a}})}),{redos:d,undos:l}}else if(t.id===yn.id){const n=t.params,{unitId:r,subUnitId:i,targetSubUnitId:o}=n;if(!r||!i||!o)return{redos:[],undos:[]};const s=this._threadCommentModel.ensureMap(r,i),a=Array.from(s.values()).map(u=>({...u,subUnitId:o,id:oe(),threadId:oe()})).filter(u=>!u.parentId),d=this._threadCommentDataSourceService.syncUpdateMutationToColla,l=[],c=[];return a.forEach(({children:u,...p})=>{l.push({id:be.id,params:{unitId:r,subUnitId:o,comment:{...p,children:d?u:void 0},sync:!d}}),c.push({id:ce.id,params:{unitId:r,subUnitId:o,commentId:p.id}})}),{redos:l,undos:c}}return{redos:[],undos:[]}}}))}};Le=ar([je(0,Q),je(1,b(Rt)),je(2,b(ve)),je(3,Lt)],Le);const dr="SHEET_THREAD_COMMENT_BASE_PLUGIN";var lr=Object.defineProperty,ur=(t,e,n)=>e in t?lr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,cr=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},bt=(t,e)=>(n,r)=>e(n,r,t),Ft=(t,e,n)=>ur(t,typeof e!="symbol"?e+"":e,n);let me=class extends lt{constructor(t=sr,e,n){super(),this._config=t,this._injector=e,this._commandService=n}onStarting(){[[A],[De],[Le]].forEach(t=>{this._injector.add(t)}),hn(this._injector,[[De],[Le]])}};Ft(me,"pluginName",dr);Ft(me,"type",T.UNIVER_SHEET);me=cr([ut(Dt),bt(1,b(Ze)),bt(2,b(P))],me);var mr=Object.defineProperty,hr=(t,e,n)=>e in t?mr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,ue=(t,e,n)=>hr(t,typeof e!="symbol"?e+"":e,n),vr=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},wt=(t,e)=>(n,r)=>e(n,r,t);let Y=class extends q{constructor(t,e){super(),ue(this,"_panelVisible",!1),ue(this,"_panelVisible$",new st(!1)),ue(this,"_activeCommentId"),ue(this,"_activeCommentId$",new st(void 0)),ue(this,"panelVisible$",this._panelVisible$.asObservable()),ue(this,"activeCommentId$",this._activeCommentId$.asObservable()),this._sidebarService=t,this._univerInstanceService=e,this._init(),this.disposeWithMe(()=>{this._activeCommentId$.complete(),this._panelVisible$.complete()})}_init(){this.disposeWithMe(this._sidebarService.sidebarOptions$.subscribe(t=>{t.visible||this.setPanelVisible(!1)})),this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(T.UNIVER_SHEET).pipe(kt(t=>!t)).subscribe(()=>{this._sidebarService.close()}))}get panelVisible(){return this._panelVisible}get activeCommentId(){return this._activeCommentId}setPanelVisible(t){this._panelVisible=t,this._panelVisible$.next(t)}setActiveComment(t){this._activeCommentId=t,this._activeCommentId$.next(t)}};Y=vr([wt(0,b($t)),wt(1,Q)],Y);const Zt="thread-comment-panel",pr="UNIVER_THREAD_COMMENT_UI_PLUGIN",pt={id:"thread-comment-ui.operation.toggle-panel",type:ct.OPERATION,handler(t){const e=t.get($t),n=t.get(Y);return n.panelVisible?(e.close(),n.setPanelVisible(!1)):(e.open({header:{title:"threadCommentUI.panel.title"},children:{label:Zt},width:330}),n.setPanelVisible(!0)),!0}},z={id:"thread-comment-ui.operation.set-active-comment",type:ct.OPERATION,handler(t,e){return t.get(Y).setActiveComment(e),!0}},gr="thread-comment-ui.config",xt={};var Cr=Object.defineProperty,fr=(t,e,n)=>e in t?Cr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Ir=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},tt=(t,e)=>(n,r)=>e(n,r,t),zt=(t,e,n)=>fr(t,typeof e!="symbol"?e+"":e,n);let he=class extends lt{constructor(t=xt,e,n,r){super(),this._config=t,this._injector=e,this._commandService=n,this._configService=r;const{menu:i,...o}=Ut({},xt,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(gr,o)}onStarting(){var t;vn([[Y]],(t=this._config)==null?void 0:t.overrides).forEach(e=>{this._injector.add(e)}),[pt,z].forEach(e=>{this._commandService.registerCommand(e)})}};zt(he,"pluginName",pr);zt(he,"type",T.UNIVER_UNKNOWN);he=Ir([ut(Dt),tt(1,b(Ze)),tt(2,P),tt(3,Mt)],he);function de({ref:t,...e}){const{icon:n,id:r,className:i,extend:o,...s}=e,a=`univerjs-icon univerjs-icon-${r} ${i||""}`.trim(),d=g.useRef(`_${wr()}`);return qt(n,`${r}`,{defIds:n.defIds,idSuffix:d.current},{ref:t,className:a,...s},o)}function qt(t,e,n,r,i){return g.createElement(t.tag,{key:e,..._r(t,n,i),...r},(br(t,n).children||[]).map((o,s)=>qt(o,`${e}-${t.tag}-${s}`,n,void 0,i)))}function _r(t,e,n){const r={...t.attrs};n!=null&&n.colorChannel1&&r.fill==="colorChannel1"&&(r.fill=n.colorChannel1),t.tag==="mask"&&r.id&&(r.id=r.id+e.idSuffix),Object.entries(r).forEach(([o,s])=>{o==="mask"&&typeof s=="string"&&(r[o]=s.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))});const{defIds:i}=e;return!i||i.length===0||(t.tag==="use"&&r["xlink:href"]&&(r["xlink:href"]=r["xlink:href"]+e.idSuffix),Object.entries(r).forEach(([o,s])=>{typeof s=="string"&&(r[o]=s.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))})),r}function br(t,e){var n;const{defIds:r}=e;return!r||r.length===0?t:t.tag==="defs"&&(n=t.children)!=null&&n.length?{...t,children:t.children.map(i=>typeof i.attrs.id=="string"&&r&&r.includes(i.attrs.id)?{...i,attrs:{...i.attrs,id:i.attrs.id+e.idSuffix}}:i)}:t}function wr(){return Math.random().toString(36).substring(2,8)}de.displayName="UniverIcon";const xr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993 0.866699 5.9313 0.866699H10.069C10.4004 0.866699 10.669 1.13533 10.669 1.4667C10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443C14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928L9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171C10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778L9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539C9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263L6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539C5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778L6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Jt=g.forwardRef(function(t,e){return g.createElement(de,Object.assign({},t,{id:"delete-icon",ref:e,icon:xr}))});Jt.displayName="DeleteIcon";const Sr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},Gt=g.forwardRef(function(t,e){return g.createElement(de,Object.assign({},t,{id:"increase-icon",ref:e,icon:Sr}))});Gt.displayName="IncreaseIcon";const yr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3 9C3.55228 9 4 8.55228 4 8C4 7.44772 3.55228 7 3 7C2.44772 7 2 7.44772 2 8C2 8.55228 2.44772 9 3 9Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M8 9C8.55228 9 9 8.55228 9 8C9 7.44772 8.55228 7 8 7C7.44772 7 7 7.44772 7 8C7 8.55228 7.44772 9 8 9Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M13 9C13.5523 9 14 8.55228 14 8C14 7.44772 13.5523 7 13 7C12.4477 7 12 7.44772 12 8C12 8.55228 12.4477 9 13 9Z"}}]},Yt=g.forwardRef(function(t,e){return g.createElement(de,Object.assign({},t,{id:"more-horizontal-icon",ref:e,icon:yr}))});Yt.displayName="MoreHorizontalIcon";const Ur={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{stroke:"currentColor",d:"M7.48389 10.3267V12.1905C7.48389 12.7428 7.9316 13.1905 8.48389 13.1905H11.2216L12.2955 14.2644L13.3695 13.1905H14.1593C14.7116 13.1905 15.1593 12.7428 15.1593 12.1905V8.46289C15.1593 7.91061 14.7116 7.46289 14.1593 7.46289H12.2955",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M0.840332 3.73535C0.840332 2.63078 1.73576 1.73535 2.84033 1.73535H10.2955C11.4001 1.73535 12.2955 2.63078 12.2955 3.73535V8.32676C12.2955 9.43132 11.4001 10.3268 10.2955 10.3268H5.6014L4.1695 11.7587L3.05978 10.3268H2.84033C1.73576 10.3268 0.840332 9.43133 0.840332 8.32676V3.73535Z",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M6.41016 6.1311H6.76813",strokeLinecap:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M8.91626 6.1311H9.27424",strokeLinecap:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M3.90454 6.1311H4.26252",strokeLinecap:"round",strokeWidth:1.2}}]},Qt=g.forwardRef(function(t,e){return g.createElement(de,Object.assign({},t,{id:"reply-to-comment-icon",ref:e,icon:Ur}))});Qt.displayName="ReplyToCommentIcon";const kr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6106 15.4036C12.4766 15.4036 15.6106 12.2696 15.6106 8.40356C15.6106 4.53757 12.4766 1.40356 8.6106 1.40356C4.7446 1.40356 1.6106 4.53757 1.6106 8.40356C1.6106 12.2696 4.7446 15.4036 8.6106 15.4036ZM12.3351 6.82773C12.5694 6.59342 12.5694 6.21352 12.3351 5.9792C12.1007 5.74489 11.7208 5.74489 11.4865 5.9792L7.91079 9.55494L6.33506 7.9792C6.10074 7.74489 5.72084 7.74489 5.48653 7.9792C5.25221 8.21352 5.25221 8.59342 5.48653 8.82773L7.48653 10.8277C7.72084 11.062 8.10074 11.062 8.33506 10.8277L12.3351 6.82773Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Kt=g.forwardRef(function(t,e){return g.createElement(de,Object.assign({},t,{id:"resolved-icon",ref:e,icon:kr}))});Kt.displayName="ResolvedIcon";const Mr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"circle",attrs:{cx:8.73,cy:8.4,r:6.4,stroke:"currentColor",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M6.02637 8.40356L8.02637 10.4036L12.0264 6.40356",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}}]},Xt=g.forwardRef(function(t,e){return g.createElement(de,Object.assign({},t,{id:"solve-icon",ref:e,icon:Mr}))});Xt.displayName="SolveIcon";function St(t){return{id:"d",body:t,documentStyle:{}}}const en=g.forwardRef((t,e)=>{var n;const{comment:r,onSave:i,id:o,onCancel:s,autoFocus:a,unitId:d,type:l}=t,c=E(P),u=E(mt),[p,C]=g.useState(!1),h=E(En),v=g.useRef(null),M=l===T.UNIVER_DOC?gn:d,[$,j]=g.useState(()=>{var f,_,S;return Xe.transform.getPlainText((S=(_=(f=v.current)==null?void 0:f.getDocumentData().body)==null?void 0:_.dataStream)!=null?S:"")});g.useEffect(()=>{var f,_,S,k;j(Xe.transform.getPlainText((S=(_=(f=v.current)==null?void 0:f.getDocumentData().body)==null?void 0:_.dataStream)!=null?S:""));const x=(k=v.current)==null?void 0:k.selectionChange$.subscribe(()=>{var R,B,J;j(Xe.transform.getPlainText((J=(B=(R=v.current)==null?void 0:R.getDocumentData().body)==null?void 0:B.dataStream)!=null?J:""))});return()=>x==null?void 0:x.unsubscribe()},[(n=v.current)==null?void 0:n.selectionChange$]);const y=g.useMemo(()=>({keyCodes:[{keyCode:dt.ENTER}],handler:f=>{f===dt.ENTER&&c.executeCommand(Rn.id)}}),[c]);g.useImperativeHandle(e,()=>({reply(f){var _,S;if(!v.current)return;h.focus((_=v.current.getEditorId())!=null?_:"");const k=St(f);(S=v.current)==null||S.setDocumentData(k,[{startOffset:k.body.dataStream.length-2,endOffset:k.body.dataStream.length-2,collapsed:!0}])}}));const w=()=>{if(v.current){const f=qe.deepClone(v.current.getDocumentData().body);C(!1),i==null||i({...r,text:f}),v.current.replaceText(""),setTimeout(()=>{var _,S;(_=v.current)==null||_.setSelectionRanges([]),(S=v.current)==null||S.blur()},10)}};return m.jsxs("div",{onClick:f=>f.preventDefault(),children:[m.jsx($n,{className:"univer-w-full",editorRef:v,autoFocus:a,keyboardEventConfig:y,placeholder:u.t("threadCommentUI.editor.placeholder"),initialValue:(r==null?void 0:r.text)&&St(r.text),onFocusChange:f=>f&&C(f),isSingle:!1,maxHeight:64,onClickOutside:()=>{setTimeout(()=>{h.focus(M)},30)}}),p?m.jsxs("div",{className:"univer-mt-3 univer-flex univer-flex-row univer-justify-end univer-gap-2",children:[m.jsx(Be,{onClick:()=>{var f;s==null||s(),C(!1),(f=v.current)==null||f.replaceText("",!0),c.executeCommand(z.id)},children:u.t("threadCommentUI.editor.cancel")}),m.jsx(Be,{variant:"primary",disabled:!$,onClick:w,children:u.t(o?"threadCommentUI.editor.save":"threadCommentUI.editor.reply")})]}):null]})}),Er=t=>{const{dataStream:e,customRanges:n}=t,r=e.endsWith(`\r
`)?e.length-2:e.length,i=[];let o=0;return n==null||n.forEach(s=>{o<s.startIndex&&i.push({type:"text",content:e.slice(o,s.startIndex)}),i.push({type:"mention",content:{label:e.slice(s.startIndex,s.endIndex+1),id:s.rangeId}}),o=s.endIndex+1}),i.push({type:"text",content:e.slice(o,r)}),i},Rr=t=>{const{paragraphs:e=[]}=t;let n=0;return e.map(r=>{const i=Cn(t,n,r.startIndex);return n=r.startIndex+1,Er(i)})},$r=t=>{let e="";const n=[];return t.forEach(r=>{switch(r.type){case"text":e+=r.content;break;case"mention":{const i=e.length;e+=r.content.label;const o=e.length-1;n.push({rangeId:r.content.id,rangeType:pn.MENTION,startIndex:i,endIndex:o,properties:{},wholeEntity:!0});break}}}),e+=`\r
`,{textRuns:[],paragraphs:[{startIndex:e.length-2,paragraphStyle:{}}],sectionBreaks:[{startIndex:e.length-1}],dataStream:e,customRanges:n}},tn="__mock__",Tr=t=>{const{item:e,unitId:n,subUnitId:r,editing:i,onEditingChange:o,onReply:s,resolved:a,isRoot:d,onClose:l,onDeleteComment:c,type:u}=t,p=E(P),C=E(mt),h=E(Ue),v=h.getUser(e.personId),M=H(h.currentUser$),$=(M==null?void 0:M.userID)===e.personId,j=e.id===tn,[y,w]=g.useState(!1),f=kn(Mn),_=f==null?void 0:f.avatarFallback,S=()=>{(c==null?void 0:c(e))!==!1&&(p.executeCommand(d?ae.id:Se.id,{unitId:n,subUnitId:r,commentId:e.id}),d&&(l==null||l()))};return m.jsxs("div",{className:"univer-relative univer-mb-3 univer-pl-[30px]",onMouseLeave:()=>w(!1),onMouseEnter:()=>w(!0),children:[m.jsx("div",{className:"univer-absolute univer-left-0 univer-top-0 univer-h-6 univer-w-6 univer-rounded-full univer-bg-cover univer-bg-center univer-bg-no-repeat",style:{backgroundImage:`url(${(v==null?void 0:v.avatar)||_})`}}),v?m.jsxs("div",{className:"univer-mb-1 univer-flex univer-h-6 univer-items-center univer-justify-between",children:[m.jsx("div",{className:"univer-text-sm univer-font-medium univer-leading-5",children:(v==null?void 0:v.name)||" "}),m.jsxs("div",{children:[j||a?null:y&&v?m.jsx("div",{className:"univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-sm univer-text-base hover:univer-bg-gray-50",onClick:()=>s(v),children:m.jsx(Qt,{})}):null,$&&!j&&!a?m.jsx(tr,{overlay:m.jsx("div",{className:"univer-rounded-lg",children:m.jsxs("ul",{className:"univer-m-0 univer-box-border univer-grid univer-list-none univer-p-1.5 univer-text-sm [&_a]:univer-block [&_a]:univer-cursor-pointer [&_a]:univer-rounded [&_a]:univer-px-2 [&_a]:univer-py-1.5 [&_a]:univer-transition-colors",children:[m.jsx("li",{children:m.jsx("a",{className:"hover:univer-bg-gray-200",onClick:()=>o==null?void 0:o(!0),children:C.t("threadCommentUI.item.edit")})}),m.jsx("li",{children:m.jsx("a",{className:"hover:univer-bg-gray-200",onClick:S,children:C.t("threadCommentUI.item.delete")})})]})}),children:m.jsx("div",{className:"univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-sm univer-text-base hover:univer-bg-gray-50",children:m.jsx(Yt,{})})}):null]})]}):null,m.jsx("time",{className:"univer-mb-1 univer-text-xs/normal univer-text-gray-600 dark:!univer-text-gray-200",children:e.dT}),i?m.jsx(en,{type:u,id:e.id,comment:e,onCancel:()=>o==null?void 0:o(!1),autoFocus:!0,unitId:n,subUnitId:r,onSave:({text:k,attachments:x})=>{o==null||o(!1),p.executeCommand(xe.id,{unitId:n,subUnitId:r,payload:{commentId:e.id,text:k,attachments:x}})}}):m.jsx("div",{className:"univer-text-sm univer-text-gray-900 dark:!univer-text-white",children:Rr(e.text).map((k,x)=>m.jsx("div",{className:"univer-break-words",children:k.map((R,B)=>{switch(R.type){case"mention":return m.jsxs("a",{className:"univer-text-primary-600",children:[R.content.label," "]},B);default:return R.content}})},x))})]})},nn=t=>{var e,n,r;const{id:i,unitId:o,subUnitId:s,refStr:a,showEdit:d=!0,onClick:l,showHighlight:c,onClose:u,getSubUnitName:p,prefix:C,autoFocus:h,onMouseEnter:v,onMouseLeave:M,onAddComment:$,onDeleteComment:j,onResolve:y,type:w,style:f,full:_}=t,S=E(ve),[k,x]=g.useState(!1),[R,B]=g.useState(""),J=g.useMemo(()=>S.commentUpdate$.pipe(ze(16)),[S]);H(J);const U=i?S.getCommentWithChildren(o,s,i):null,G=E(P),te=E(Ue),D=U==null?void 0:U.root.resolved,L=H(te.currentUser$),pe=g.useRef(null),ge=[...U?[U.root]:[{id:tn,text:{dataStream:`
\r`},personId:(e=L==null?void 0:L.userID)!=null?e:"",ref:a??"",dT:"",unitId:o,subUnitId:s,threadId:""}],...(n=U==null?void 0:U.children)!=null?n:[]],le=g.useRef(null),Ee=N=>{N.stopPropagation(),D?G.executeCommand(z.id,{unitId:o,subUnitId:s,commentId:i}):G.executeCommand(z.id),G.executeCommand(Ae.id,{unitId:o,subUnitId:s,commentId:i,resolved:!D}),y==null||y(!D)},Ke=N=>{N.stopPropagation(),G.executeCommand(z.id),!(U!=null&&U.root&&(j==null?void 0:j(U.root))===!1)&&(G.executeCommand(ae.id,{unitId:o,subUnitId:s,commentId:i}),u==null||u())};g.useEffect(()=>M==null?void 0:M(),[]);const Re=p((r=U==null?void 0:U.root.subUnitId)!=null?r:s),$e=d&&!R&&!D,I=`${a||(U==null?void 0:U.root.ref)||""}${Re?" Â· ":""}${Re}`;return m.jsxs("div",{id:`${C}-${o}-${s}-${i}`,className:et("univer-relative univer-box-border univer-rounded-md univer-bg-white univer-p-4 dark:!univer-bg-gray-900 dark:!univer-text-white",er,{"univer-w-[278px]":!_,"univer-w-full":_,"univer-shadow":!D&&(c||k||C==="cell")}),style:f,onClick:l,onMouseEnter:()=>{v==null||v(),x(!0)},onMouseLeave:()=>{M==null||M(),x(!1)},children:[!D&&c&&m.jsx("div",{className:"univer-absolute univer-left-0 univer-right-0 univer-top-0 univer-h-1.5 univer-rounded-t-md univer-bg-yellow-400"}),m.jsxs("div",{className:"univer-mb-4 univer-flex univer-flex-row univer-items-center univer-justify-between univer-text-sm univer-leading-5",children:[m.jsxs("div",{className:"univer-flex univer-flex-1 univer-flex-row univer-items-center univer-overflow-hidden",children:[m.jsx("div",{className:"univer-mr-2 univer-h-3.5 univer-w-[3px] univer-flex-shrink-0 univer-flex-grow-0 univer-rounded-sm univer-bg-yellow-500"}),m.jsx(Kn,{showIfEllipsis:!0,title:I,children:m.jsx("span",{className:"univer-flex-1 univer-truncate",children:I})})]}),!!U&&m.jsxs("div",{className:"univer-flex univer-flex-shrink-0 univer-flex-grow-0 univer-flex-row",children:[m.jsx("div",{className:et("univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-[3px] univer-text-base hover:univer-bg-gray-50 dark:hover:!univer-bg-gray-800",{"univer-text-green-500":D}),onClick:Ee,children:D?m.jsx(Kt,{}):m.jsx(Xt,{})}),(L==null?void 0:L.userID)===U.root.personId?m.jsx("div",{className:"univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-[3px] univer-text-base hover:univer-bg-gray-50 dark:hover:!univer-bg-gray-800",onClick:Ke,children:m.jsx(Jt,{})}):null]})]}),m.jsx("div",{ref:le,className:et("univer-max-h-80 univer-overflow-y-auto univer-overflow-x-hidden",Xn),children:ge.map(N=>m.jsx(Tr,{unitId:o,subUnitId:s,item:N,isRoot:N.id===(U==null?void 0:U.root.id),editing:R===N.id,resolved:U==null?void 0:U.root.resolved,type:w,onClose:u,onEditingChange:O=>{B(O?N.id:"")},onReply:O=>{O&&requestAnimationFrame(()=>{var W;(W=pe.current)==null||W.reply($r([{type:"mention",content:{id:O.userID,label:`@${O.name}`}},{type:"text",content:" "}]))})},onAddComment:$,onDeleteComment:j},N.id))}),$e&&m.jsx("div",{children:m.jsx(en,{ref:pe,type:w,unitId:o,subUnitId:s,onSave:async({text:N,attachments:O})=>{const W={text:N,attachments:O,dT:we(),id:oe(),ref:a,personId:L==null?void 0:L.userID,parentId:U==null?void 0:U.root.id,unitId:o,subUnitId:s,threadId:U==null?void 0:U.root.threadId};($==null?void 0:$(W))!==!1&&(await G.executeCommand(se.id,{unitId:o,subUnitId:s,comment:W}),le.current&&(le.current.scrollTop=le.current.scrollHeight))},autoFocus:h||!U,onCancel:()=>{U||u==null||u()}},`${h}`)})]})},jr=t=>{const{unitId:e,subUnitId$:n,type:r,onAdd:i,getSubUnitName:o,onResolve:s,sortComments:a,onItemLeave:d,onItemEnter:l,disableAdd:c,tempComment:u,onAddComment:p,onDeleteComment:C,showComments:h}=t,[v,M]=g.useState("all"),[$,j]=g.useState("all"),y=E(mt),w=E(Ue),f=E(ve),[_,S]=g.useState(()=>f.getUnit(e)),k=E(Y),x=H(k.activeCommentId$),R=H(f.commentUpdate$),B=E(P),J=H(n),U=g.useRef(!0),G="panel",te=H(w.currentUser$),D=g.useMemo(()=>{var I;const N=v==="all"?_:(I=_.filter(V=>V.subUnitId===J))!=null?I:[],O=a??(V=>V),W=N.map(V=>{var ne;return{...V.root,children:(ne=V.children)!=null?ne:[],users:V.relativeUsers}});if(h){const V=new Map;return W.forEach(ne=>{V.set(ne.id,ne)}),[...h,""].map(ne=>V.get(ne)).filter(Boolean)}else return O(W)},[h,v,_,a,J]),L=g.useMemo(()=>[...D.filter(I=>!I.resolved),...D.filter(I=>I.resolved)],[D]),pe=g.useMemo(()=>$==="resolved"?L.filter(I=>I.resolved):$==="unsolved"?L.filter(I=>!I.resolved):$==="concern_me"&&te!=null&&te.userID?L.filter(I=>I==null?void 0:I.users.has(te.userID)):L,[L,te==null?void 0:te.userID,$]),ge=u?[u,...pe]:pe,le=ge.filter(I=>!I.resolved),Ee=ge.filter(I=>I.resolved),Ke=$!=="all"||v!=="all",Re=()=>{j("all"),M("all")};g.useEffect(()=>{e&&S(f.getUnit(e))},[e,f,R]),g.useEffect(()=>{var I;if(!x)return;if(!U.current){U.current=!0;return}const{unitId:N,subUnitId:O,commentId:W}=x,V=`${G}-${N}-${O}-${W}`;(I=document.getElementById(V))==null||I.scrollIntoView({block:"center"})},[x]);const $e=I=>m.jsx(nn,{prefix:G,getSubUnitName:o,id:I.id,unitId:I.unitId,subUnitId:I.subUnitId,refStr:I.ref,type:r,showEdit:(x==null?void 0:x.commentId)===I.id,showHighlight:(x==null?void 0:x.commentId)===I.id,onClick:()=>{U.current=!1,I.resolved?B.executeCommand(z.id):B.executeCommand(z.id,{unitId:I.unitId,subUnitId:I.subUnitId,commentId:I.id,temp:!1})},onMouseEnter:()=>l==null?void 0:l(I),onMouseLeave:()=>d==null?void 0:d(I),onAddComment:p,onDeleteComment:C,onResolve:N=>s==null?void 0:s(I.id,N)},I.id);return m.jsxs("div",{className:"univer-flex univer-min-h-full univer-flex-col univer-pb-3",children:[m.jsxs("div",{className:"univer-mt-3 univer-flex univer-flex-row univer-justify-between",children:[r===T.UNIVER_SHEET?m.jsx(It,{borderless:!0,value:v,options:[{value:"current",label:y.t("threadCommentUI.filter.sheet.current")},{value:"all",label:y.t("threadCommentUI.filter.sheet.all")}],onChange:M}):null,m.jsx(It,{borderless:!0,value:$,options:[{value:"all",label:y.t("threadCommentUI.filter.status.all")},{value:"resolved",label:y.t("threadCommentUI.filter.status.resolved")},{value:"unsolved",label:y.t("threadCommentUI.filter.status.unsolved")},{value:"concern_me",label:y.t("threadCommentUI.filter.status.concernMe")}],onChange:j})]}),ge.length===0?m.jsxs("div",{className:"univer-flex univer-flex-1 univer-flex-col univer-items-center univer-justify-center univer-text-sm univer-text-gray-600 dark:!univer-text-gray-200",children:[y.t("threadCommentUI.panel.empty"),Ke?m.jsx("div",{className:"univer-mt-2 univer-flex univer-flex-row",children:m.jsx(Be,{onClick:Re,children:y.t("threadCommentUI.panel.reset")})}):c?null:m.jsx("div",{className:"univer-mt-2 univer-flex univer-flex-row",children:m.jsxs(Be,{onClick:i,children:[m.jsx(Gt,{className:"univer-mr-1.5"}),y.t("threadCommentUI.panel.addComment")]})})]}):m.jsxs("div",{className:"univer-mt-3 univer-flex univer-flex-col univer-gap-3",children:[le.map($e),Ee.length>0&&m.jsx("div",{className:"univer-text-xs",children:y.t("threadCommentUI.panel.solved")}),Ee.map($e)]})]})};var Nr=Object.defineProperty,Pr=(t,e,n)=>e in t?Nr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,ie=(t,e,n)=>Pr(t,typeof e!="symbol"?e+"":e,n);const rn="univer.sheet.thread-comment-modal",on="SHEET_THREAD_COMMENT";var Ar=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},nt=(t,e)=>(n,r)=>e(n,r,t);let X=class extends q{constructor(t,e,n){super(),ie(this,"_lastPopup",null),ie(this,"_activePopup"),ie(this,"_activePopup$",new st(null)),ie(this,"activePopup$",this._activePopup$.asObservable()),this._canvasPopupManagerService=t,this._zenZoneService=e,this._cellPopupManagerService=n,this._initZenVisible(),this.disposeWithMe(()=>{this._activePopup$.complete()})}get activePopup(){return this._activePopup}_initZenVisible(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(t=>{t&&this.hidePopup()}))}dispose(){super.dispose(),this.hidePopup()}showPopup(t,e){var n;const{row:r,col:i,unitId:o,subUnitId:s}=t;if(this._activePopup&&r===this._activePopup.row&&i===this._activePopup.col&&o===this._activePopup.unitId&&s===((n=this.activePopup)==null?void 0:n.subUnitId)){this._activePopup=t,this._activePopup$.next(t);return}if(this._lastPopup&&this._lastPopup.dispose(),this._zenZoneService.visible)return;this._activePopup=t,this._activePopup$.next(t);const a=this._cellPopupManagerService.showPopup({row:r,col:i,unitId:o,subUnitId:s},{componentKey:rn,onClickOutside:()=>{this.hidePopup()},direction:"horizontal",excludeOutside:[...Array.from(document.querySelectorAll(".univer-thread-comment")),document.getElementById("thread-comment-add")].filter(Boolean),priority:2});if(!a)throw new Error("[SheetsThreadCommentPopupService]: cannot show popup!");const d=new fn;d.add(a),d.add({dispose:()=>{e==null||e()}}),this._lastPopup=d}hidePopup(){this._activePopup&&(this._lastPopup&&this._lastPopup.dispose(),this._lastPopup=null,this._activePopup=null,this._activePopup$.next(null))}persistPopup(){!this._activePopup||!this._activePopup.temp||(this._activePopup={...this._activePopup,temp:!1},this._activePopup$.next(this._activePopup))}};X=Ar([nt(0,b(On)),nt(1,Wn),nt(2,b(Fn))],X);const ke={type:ct.OPERATION,id:"sheets.operation.show-comment-modal",handler(t){var e;const n=t.get(ht),r=t.get(Q),i=t.get(X),o=t.get(Y),s=(e=n.getCurrentLastSelection())==null?void 0:e.primary,a=t.get(A);if(!s)return!1;const d=Tn(r);if(!d)return!1;const{workbook:l,worksheet:c,unitId:u,subUnitId:p}=d,C={workbook:l,worksheet:c,unitId:u,subUnitId:p,row:s.startRow,col:s.startColumn};i.showPopup(C);const h=a.getByLocation(u,p,s.startRow,s.startColumn);return h&&o.setActiveComment({unitId:u,subUnitId:p,commentId:h,trigger:"context-menu"}),!0}},Br="sheets-thread-comment.config",yt={};var Dr=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},Ne=(t,e)=>(n,r)=>e(n,r,t);let Ve=class extends q{constructor(t,e,n,r){super(),this._sheetInterceptorService=t,this._sheetsThreadCommentModel=e,this._univerInstanceService=n,this._renderManagerService=r,this._initViewModelIntercept(),this._initSkeletonChange()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(Nn.CELL_CONTENT,{effect:In.Style,handler:(t,e,n)=>{const{row:r,col:i,unitId:o,subUnitId:s}=e;return this._sheetsThreadCommentModel.showCommentMarker(o,s,r,i)&&((!t||t===e.rawData)&&(t={...e.rawData}),t.markers={...t==null?void 0:t.markers,tr:{color:"#FFBD37",size:6}}),n(t)},priority:100}))}_initSkeletonChange(){const t=()=>{var e;const n=this._univerInstanceService.getCurrentUnitForType(T.UNIVER_SHEET);if(!n)return;const r=n.getUnitId(),i=this._renderManagerService.getRenderById(r);(e=i==null?void 0:i.mainComponent)==null||e.makeForceDirty()};this.disposeWithMe(this._sheetsThreadCommentModel.commentUpdate$.pipe(ze(16)).subscribe(()=>{t()}))}};Ve=Dr([Ne(0,b(Rt)),Ne(1,b(A)),Ne(2,Q),Ne(3,At)],Ve);var Lr=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},rt=(t,e)=>(n,r)=>e(n,r,t);const Vr=(t,e,n)=>{const r=Z(t),i=n.row-e.row,o=n.column-e.column,s={startColumn:r.column+o,startRow:r.row+i,endColumn:r.column+o,endRow:r.row+i};return at(s)};let He=class extends q{constructor(e,n,r){super(),ie(this,"_copyInfo"),this._sheetClipboardService=e,this._sheetsThreadCommentModel=n,this._threadCommentDataSourceService=r,this._initClipboardHook()}_initClipboardHook(){this.disposeWithMe(this._sheetClipboardService.addClipboardHook({id:on,onBeforeCopy:(e,n,r)=>{this._copyInfo={unitId:e,subUnitId:n,range:r}},onPasteCells:(e,n,r,i)=>{const{unitId:o,subUnitId:s,range:a}=n,d={row:a.rows[0],column:a.cols[0]};if(i.copyType===Pn.CUT&&this._copyInfo){const{range:l,unitId:c,subUnitId:u}=this._copyInfo,p={row:l.startRow,column:l.startColumn};if(!(o===c&&s===u)){const C=[];Et.foreach(l,(y,w)=>{const f=this._sheetsThreadCommentModel.getAllByLocation(c,u,y,w);this._threadCommentDataSourceService.syncUpdateMutationToColla?f.forEach(_=>{C.push(_)}):f.forEach(({children:_,...S})=>{S.parentId||C.push(S)})});const h=[],v=[],M=[],$=[],j=y=>{h.unshift({id:ce.id,params:{unitId:c,subUnitId:u,commentId:y.id}}),M.push({id:be.id,params:{unitId:o,subUnitId:s,comment:{...y,ref:Vr(y.ref,p,d),unitId:o,subUnitId:s},sync:!0}}),v.push({id:be.id,params:{unitId:c,subUnitId:u,comment:y,sync:!0}}),$.unshift({id:ce.id,params:{unitId:o,subUnitId:s,commentId:y.id}})};return C.forEach(y=>{j(y)}),{redos:[...h,...M],undos:[...$,...v]}}}return{redos:[],undos:[]}}}))}};He=Lr([rt(0,b(Zn)),rt(1,b(A)),rt(2,Lt)],He);var Hr=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},Pe=(t,e)=>(n,r)=>e(n,r,t);let Oe=class extends q{constructor(t,e,n,r){super(),this._hoverManagerService=t,this._sheetsThreadCommentPopupService=e,this._sheetsThreadCommentModel=n,this._sheetPermissionCheckController=r,this._initHoverEvent()}_initHoverEvent(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe(ze(100)).subscribe(t=>{const e=this._sheetsThreadCommentPopupService.activePopup;if(t&&(e&&e.temp||!e)){const{location:n}=t,{unitId:r,subUnitId:i,row:o,col:s}=n,a=this._sheetsThreadCommentModel.getByLocation(r,i,o,s);if(a){if(!this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[Ye],worksheetTypes:[Ge],rangeTypes:[Je]},[{startRow:o,startColumn:s,endRow:o,endColumn:s}]))return;const d=this._sheetsThreadCommentModel.getComment(r,i,a);d&&!d.resolved&&this._sheetsThreadCommentPopupService.showPopup({unitId:r,subUnitId:i,row:o,col:s,commentId:a,temp:!0})}else e&&this._sheetsThreadCommentPopupService.hidePopup()}}))}};Oe=Hr([Pe(0,b(zn)),Pe(1,b(X)),Pe(2,b(A)),Pe(3,b(Bt))],Oe);var Or=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},F=(t,e)=>(n,r)=>e(n,r,t);let We=class extends q{constructor(t,e,n,r,i,o,s,a,d,l){super(),ie(this,"_isSwitchToCommenting",!1),ie(this,"_selectionShapeInfo",null),this._commandService=t,this._sheetsThreadCommentPopupService=e,this._sheetsThreadCommentModel=n,this._threadCommentPanelService=r,this._univerInstanceService=i,this._sheetPermissionCheckController=o,this._markSelectionService=s,this._sheetSelectionService=a,this._editorBridgeService=d,this._renderManagerService=l,this._initCommandListener(),this._initPanelListener(),this._initMarkSelection(),this._initSelectionUpdateListener(),this._initEditorBridge()}_handleSelectionChange(t,e,n){var r,i,o;const s=(r=t[0])==null?void 0:r.range,a=this._renderManagerService.getRenderById(e),d=(i=a==null?void 0:a.with(An).getSkeletonParam(n))==null?void 0:i.skeleton;if(!d||!s)return;const l=d.getCellWithCoordByIndex(s.startRow,s.startColumn);if((((o=s.rangeType)!=null?o:gt.NORMAL)!==gt.NORMAL||s.endColumn-s.startColumn>0||s.endRow-s.startRow>0)&&!((l.isMerged||l.isMergedMainCell)&&_n.equals(l.mergeInfo,s))){this._threadCommentPanelService.activeCommentId&&this._commandService.executeCommand(z.id);return}const c=l.actualRow,u=l.actualColumn;if(!this._sheetsThreadCommentModel.showCommentMarker(e,n,c,u)){this._threadCommentPanelService.activeCommentId&&this._commandService.executeCommand(z.id);return}const p=this._sheetsThreadCommentModel.getByLocation(e,n,c,u);p&&this._commandService.executeCommand(z.id,{unitId:e,subUnitId:n,commentId:p})}_initSelectionUpdateListener(){this.disposeWithMe(this._sheetSelectionService.selectionMoveEnd$.subscribe(t=>{if(this._isSwitchToCommenting)return;const e=this._sheetSelectionService.currentSelectionParam;e&&this._handleSelectionChange(t,e.unitId,e.sheetId)}))}_initEditorBridge(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(t=>{t.visible&&this._sheetsThreadCommentPopupService.hidePopup()}))}_initCommandListener(){this._commandService.onCommandExecuted(t=>{if(t.id===ce.id){const e=t.params,n=this._sheetsThreadCommentPopupService.activePopup;if(!n)return;const{unitId:r,subUnitId:i,commentId:o}=n;e.unitId===r&&e.subUnitId===i&&e.commentId===o&&this._sheetsThreadCommentPopupService.hidePopup()}})}_initPanelListener(){this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.subscribe(async t=>{var e;if(t){const{unitId:n,subUnitId:r,commentId:i,trigger:o}=t,s=this._sheetsThreadCommentModel.getComment(n,r,i);if(!s||s.resolved)return;const a=this._univerInstanceService.getCurrentUnitForType(T.UNIVER_SHEET);if(!a||a.getUnitId()!==n)return;this._isSwitchToCommenting=!0,((e=a.getActiveSheet())==null?void 0:e.getSheetId())!==r&&await this._commandService.executeCommand(Bn.id,{unitId:n,subUnitId:r}),this._isSwitchToCommenting=!1;const d=Z(s.ref),{row:l,column:c}=d;if(!this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[Ye],worksheetTypes:[Ge],rangeTypes:[Je]},[{startRow:l,startColumn:c,endRow:l,endColumn:c}]))return;const u=1;if(await this._commandService.executeCommand(Dn.id,{range:{startRow:Math.max(d.row-u,0),endRow:d.row+u,startColumn:Math.max(d.column-u,0),endColumn:d.column+u}}),this._editorBridgeService.isVisible().visible)return;this._sheetsThreadCommentPopupService.showPopup({unitId:n,subUnitId:r,row:d.row,col:d.column,commentId:s.id,trigger:o})}else this._sheetsThreadCommentPopupService.hidePopup()}))}_initMarkSelection(){this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.pipe(ze(100)).subscribe(t=>{var e,n;if(!t){this._selectionShapeInfo&&(this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId),this._selectionShapeInfo=null);return}const{unitId:r,subUnitId:i,commentId:o}=t;this._selectionShapeInfo&&(this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId),this._selectionShapeInfo=null);const s=this._sheetsThreadCommentModel.getComment(r,i,o);if(!s)return;const a=Z(s.ref),{row:d,column:l}=a;if(Number.isNaN(d)||Number.isNaN(l))return null;const c=(e=this._univerInstanceService.getCurrentUnitForType(T.UNIVER_SHEET))==null?void 0:e.getSheetBySheetId(i),u=(n=c==null?void 0:c.getMergedCell(d,l))!=null?n:{startColumn:l,endColumn:l,startRow:d,endRow:d},p=this._markSelectionService.addShape({range:u,style:{fill:"rgba(255, 189, 55, 0.35)",strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null},[],-1);p&&(this._selectionShapeInfo={...t,shapeId:p})}))}};We=Or([F(0,P),F(1,b(X)),F(2,b(A)),F(3,b(Y)),F(4,Q),F(5,b(Bt)),F(6,Pt),F(7,b(ht)),F(8,qn),F(9,At)],We);function sn({ref:t,...e}){const{icon:n,id:r,className:i,extend:o,...s}=e,a=`univerjs-icon univerjs-icon-${r} ${i||""}`.trim(),d=g.useRef(`_${Zr()}`);return an(n,`${r}`,{defIds:n.defIds,idSuffix:d.current},{ref:t,className:a,...s},o)}function an(t,e,n,r,i){return g.createElement(t.tag,{key:e,...Wr(t,n,i),...r},(Fr(t,n).children||[]).map((o,s)=>an(o,`${e}-${t.tag}-${s}`,n,void 0,i)))}function Wr(t,e,n){const r={...t.attrs};n!=null&&n.colorChannel1&&r.fill==="colorChannel1"&&(r.fill=n.colorChannel1),t.tag==="mask"&&r.id&&(r.id=r.id+e.idSuffix),Object.entries(r).forEach(([o,s])=>{o==="mask"&&typeof s=="string"&&(r[o]=s.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))});const{defIds:i}=e;return!i||i.length===0||(t.tag==="use"&&r["xlink:href"]&&(r["xlink:href"]=r["xlink:href"]+e.idSuffix),Object.entries(r).forEach(([o,s])=>{typeof s=="string"&&(r[o]=s.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))})),r}function Fr(t,e){var n;const{defIds:r}=e;return!r||r.length===0?t:t.tag==="defs"&&(n=t.children)!=null&&n.length?{...t,children:t.children.map(i=>typeof i.attrs.id=="string"&&r&&r.includes(i.attrs.id)?{...i,attrs:{...i.attrs,id:i.attrs.id+e.idSuffix}}:i)}:t}function Zr(){return Math.random().toString(36).substring(2,8)}sn.displayName="UniverIcon";const zr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521C5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345ZM8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521C8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345ZM11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521C11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521C5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521C8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521C11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.84351 3.41861C1.84351 3.01861 2.15531 2.69434 2.53993 2.69434H14.9381C15.3228 2.69434 15.6346 3.01861 15.6346 3.41861V12.4611C15.6346 12.8612 15.3228 13.1854 14.9381 13.1854H8.82117L6.06643 14.6179C5.85054 14.7301 5.59416 14.7181 5.38884 14.5862C5.18352 14.4542 5.05855 14.2211 5.05855 13.9701V13.1854H2.53993C2.15531 13.1854 1.84351 12.8612 1.84351 12.4611L1.84351 3.41861ZM6.45141 12.7982L8.34531 12.0135C8.44201 11.9632 8.54864 11.9371 8.65676 11.9371H14.2417C14.3522 11.9371 14.4417 11.8475 14.4417 11.7371V4.14271C14.4417 4.03225 14.3522 3.94271 14.2417 3.94271H3.23636C3.12591 3.94271 3.03636 4.03225 3.03636 4.14271L3.03636 11.7371C3.03636 11.8475 3.12591 11.9371 3.23636 11.9371L5.75498 11.9371C6.1396 11.9371 6.45141 12.0611 6.45141 12.4611V12.7982Z",fillRule:"evenodd",clipRule:"evenodd"}}]},dn=g.forwardRef(function(t,e){return g.createElement(sn,Object.assign({},t,{id:"comment-icon",ref:e,icon:zr}))});dn.displayName="CommentIcon";const qr=()=>{const t=E(Q),e=E(X),n=H(e.activePopup$),r=E(A);if(H(r.commentUpdate$),!n)return null;const{row:i,col:o,unitId:s,subUnitId:a,trigger:d}=n,l=r.getByLocation(s,a,i,o),c=`${qe.chatAtABC(o)}${i+1}`,u=()=>{e.hidePopup()},p=C=>{var h,v,M;return(M=(v=(h=t.getCurrentUnitForType(T.UNIVER_SHEET))==null?void 0:h.getSheetBySheetId(C))==null?void 0:v.getName())!=null?M:""};return m.jsx(nn,{onClick:()=>{e.persistPopup()},prefix:"cell",id:l,unitId:s,subUnitId:a,type:T.UNIVER_SHEET,refStr:c,onClose:u,getSubUnitName:p,autoFocus:d==="context-menu"})},Jr=()=>{var t;const e=E(Pt),n=E(Q),r=E(X),i=n.getCurrentUnitForType(T.UNIVER_SHEET),o=i.getUnitId(),s=E(P),a=g.useMemo(()=>i.activeSheet$.pipe(bn(w=>w==null?void 0:w.getSheetId())),[i.activeSheet$]),d=H(a,(t=i.getActiveSheet())==null?void 0:t.getSheetId()),l=g.useRef(null),c=E(Y),u=H(c.activeCommentId$),p=H(c.panelVisible$,c.panelVisible),C=g.useCallback(w=>{const f=i.getSheets(),_={};f.forEach((k,x)=>{_[k.getSheetId()]=x});const S=k=>k.map(x=>{var R;const B=Z(x.ref),J=[(R=_[x.subUnitId])!=null?R:0,B.row,B.column];return{...x,p:J}}).sort((x,R)=>x.p[0]===R.p[0]?x.p[1]===R.p[1]?x.p[2]-R.p[2]:x.p[1]-R.p[1]:x.p[0]-R.p[0]);return[...S(w.filter(k=>!k.resolved)),...S(w.filter(k=>k.resolved))]},[i]),h=g.useCallback(w=>{var f;if(w.unitId===o&&w.subUnitId===d&&!w.resolved){const{row:_,column:S}=Z(w.ref),k=i.getSheetBySheetId(w.subUnitId),x=(f=k==null?void 0:k.getMergedCell(_,S))!=null?f:{startColumn:S,endColumn:S,startRow:_,endRow:_};if(!Number.isNaN(_)&&!Number.isNaN(S))return e.addShape({range:x,style:{fill:"rgb(255, 189, 55, 0.35)",strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null})}return null},[e,d,o]),v=w=>{var f,_;return(_=(f=i.getSheetBySheetId(w))==null?void 0:f.getName())!=null?_:""},M=()=>{s.executeCommand(ke.id)},$=w=>{u&&u.unitId===w.unitId&&u.subUnitId===w.subUnitId&&u.commentId===w.id||(l.current&&(e.removeShape(l.current),l.current=null),l.current=h(w))},j=()=>{l.current&&(e.removeShape(l.current),l.current=null)},y=(w,f)=>{f&&r.hidePopup()};return g.useEffect(()=>{!p&&l.current&&e.removeShape(l.current)},[e,p]),m.jsx(jr,{unitId:o,subUnitId$:a,type:T.UNIVER_SHEET,onAdd:M,getSubUnitName:v,onResolve:y,sortComments:C,onItemEnter:$,onItemLeave:j,onDeleteComment:()=>(j(),!0)})},Gr=t=>({id:ke.id,type:Nt.BUTTON,icon:"CommentIcon",title:"sheetThreadComment.menu.addComment",hidden$:jt(t,T.UNIVER_SHEET),disabled$:Tt(t,{workbookTypes:[Ye],worksheetTypes:[Ge],rangeTypes:[Je]})}),Yr=t=>({id:pt.id,type:Nt.BUTTON,icon:"CommentIcon",tooltip:"sheetThreadComment.menu.commentManagement",disabled$:Tt(t,{workbookTypes:[Ye],worksheetTypes:[Ge],rangeTypes:[Je]}),hidden$:jt(t,T.UNIVER_SHEET)}),Qr={id:ke.id,binding:dt.M|Ct.CTRL_COMMAND|Ct.ALT,preconditions:jn},Kr={[Hn.MEDIA]:{[pt.id]:{order:2,menuItemFactory:Yr}},[Ln.MAIN_AREA]:{[Vn.OTHERS]:{[ke.id]:{order:0,menuItemFactory:Gr}}}};var Xr=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},it=(t,e)=>(n,r)=>e(n,r,t);let Fe=class extends q{constructor(t,e,n){super(),this._menuManagerService=t,this._componentManager=e,this._shortcutService=n,this._initMenu(),this._initShortcut(),this._initComponent()}_initShortcut(){this._shortcutService.registerShortcut(Qr)}_initMenu(){this._menuManagerService.mergeMenu(Kr)}_initComponent(){[[rn,qr],[Zt,Jr],["CommentIcon",dn]].forEach(([t,e])=>{this.disposeWithMe(this._componentManager.register(t,e))})}};Fe=Xr([it(0,Jn),it(1,b(Gn)),it(2,Yn)],Fe);var ei=Object.defineProperty,ti=(t,e,n)=>e in t?ei(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,ni=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},ot=(t,e)=>(n,r)=>e(n,r,t),ln=(t,e,n)=>ti(t,typeof e!="symbol"?e+"":e,n);let ye=class extends lt{constructor(t=yt,e,n,r){super(),this._config=t,this._injector=e,this._commandService=n,this._configService=r;const{menu:i,...o}=Ut({},yt,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(Br,o)}onStarting(){[[Fe],[Ve],[He],[Oe],[We],[X]].forEach(t=>{this._injector.add(t)}),[ke].forEach(t=>{this._commandService.registerCommand(t)}),this._injector.get(Fe)}onReady(){this._injector.get(Ve)}onRendered(){this._injector.get(He),this._injector.get(Oe),this._injector.get(We)}};ln(ye,"pluginName",on);ln(ye,"type",T.UNIVER_SHEET);ye=ni([ut(he,me),ot(1,b(Ze)),ot(2,b(P)),ot(3,Mt)],ye);var ri=Object.defineProperty,ii=(t,e,n)=>e in t?ri(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,oi=(t,e,n)=>ii(t,e+"",n),si=(t,e,n,r)=>{for(var i=e,o=t.length-1,s;o>=0;o--)(s=t[o])&&(i=s(i)||i);return i},fe=(t,e)=>(n,r)=>e(n,r,t);class Qe{constructor(e){oi(this,"_comment",{id:oe(),ref:"",threadId:"",dT:"",personId:"",text:wn.newEmptyData().body,attachments:[],unitId:"",subUnitId:""}),e&&(this._comment=e)}static create(e){return new Qe(e)}get personId(){return this._comment.personId}get dateTime(){return this._comment.dT}get content(){return _e.createByBody(this._comment.text)}get id(){return this._comment.id}get threadId(){return this._comment.threadId}copy(){return Me.create(qe.deepClone(this._comment))}}class Me extends Qe{static create(e){return new Me(e)}setContent(e){return e instanceof _e?this._comment.text=e.getData().body:this._comment.text=e,this}setPersonId(e){return this._comment.personId=e,this}setDateTime(e){return this._comment.dT=we(e),this}setId(e){return this._comment.id=e,this}setThreadId(e){return this._comment.threadId=e,this}build(){return this._comment}}let ee=class{constructor(t,e,n,r,i,o,s){this._thread=t,this._parent=e,this._injector=n,this._commandService=r,this._univerInstanceService=i,this._threadCommentModel=o,this._userManagerService=s}_getRef(){var t;const e=((t=this._parent)==null?void 0:t.ref)||this._thread.ref;return Qn(e).range}getIsRoot(){return!this._parent}getCommentData(){const{children:t,...e}=this._thread;return e}getReplies(){var t;const e=this._getRef(),n=this._threadCommentModel.getCommentWithChildren(this._thread.unitId,this._thread.subUnitId,e.startRow,e.startColumn);return(t=n==null?void 0:n.children)==null?void 0:t.map(r=>this._injector.createInstance(ee,r))}getRange(){const t=this._univerInstanceService.getUnit(this._thread.unitId,T.UNIVER_SHEET);if(!t)return null;const e=t.getSheetBySheetId(this._thread.subUnitId);if(!e)return null;const n=this._getRef();return this._injector.createInstance(vt,t,e,n)}getContent(){return this._thread.text}getRichText(){const t=this._thread.text;return _e.create({body:t,documentStyle:{},id:"d"})}deleteAsync(){return this._commandService.executeCommand(this.getIsRoot()?ae.id:Se.id,{commentId:this._thread.id,unitId:this._thread.unitId,subUnitId:this._thread.subUnitId})}delete(){return this.deleteAsync()}async update(t){return this.updateAsync(t)}async updateAsync(t){const e=t instanceof _e?t.getData().body:t,n=we();return await this._commandService.executeCommand(xe.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,payload:{commentId:this._thread.id,text:e,updated:!0,updateT:n}})}resolve(t){return this.resolveAsync(t)}resolveAsync(t){return this._commandService.executeCommand(Ae.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,commentId:this._thread.id,resolved:t??!this._thread.resolved})}replyAsync(t){var e;const n=t.build();return this._commandService.executeCommand(se.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,comment:{id:oe(),parentId:this._thread.id,threadId:this._thread.threadId,ref:((e=this._parent)==null?void 0:e.ref)||this._thread.ref,unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,text:n.text,attachments:n.attachments,dT:n.dT||we(),personId:n.personId||this._userManagerService.getCurrentUser().userID}})}};ee=si([fe(2,b(Ze)),fe(3,P),fe(4,Q),fe(5,b(A)),fe(6,b(Ue))],ee);class ai extends vt{getComment(){const e=this._injector.get(A),n=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),i=e.getByLocation(n,r,this._range.startRow,this._range.startColumn);if(!i)return null;const o=e.getComment(n,r,i);return o?this._injector.createInstance(ee,o):null}getComments(){const e=this._injector.get(A),n=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),i=[];return Et.foreach(this._range,(o,s)=>{const a=e.getByLocation(n,r,o,s);if(a){const d=e.getComment(n,r,a);d&&i.push(this._injector.createInstance(ee,d))}}),i}addComment(e){var n;const r=this._injector,i=(n=this.getComment())==null?void 0:n.getCommentData(),o=r.get(P),s=r.get(Ue),a=this._workbook.getUnitId(),d=this._worksheet.getSheetId(),l=`${qe.chatAtABC(this._range.startColumn)}${this._range.startRow+1}`,c=s.getCurrentUser(),u=e instanceof Me?e.build():{text:e};return o.executeCommand(se.id,{unitId:a,subUnitId:d,comment:{text:u.text,dT:u.dT||we(),attachments:[],id:u.id||oe(),ref:l,personId:u.personId||c.userID,parentId:i==null?void 0:i.id,unitId:a,subUnitId:d,threadId:(i==null?void 0:i.threadId)||oe()}})}clearComment(){var e;const n=this._injector,r=(e=this.getComment())==null?void 0:e.getCommentData(),i=n.get(P),o=this._workbook.getUnitId(),s=this._worksheet.getSheetId();return r?i.executeCommand(ae.id,{unitId:o,subUnitId:s,threadId:r.threadId,commentId:r.id}):Promise.resolve(!0)}clearComments(){const e=this.getComments().map(n=>n.deleteAsync());return Promise.all(e).then(()=>!0)}addCommentAsync(e){return this.addComment(e)}clearCommentAsync(){return this.clearComment()}clearCommentsAsync(){return this.clearComments()}}vt.extend(ai);class di extends Ot{_initialize(){Object.defineProperty(this,"_threadCommentModel",{get(){return this._injector.get(ve)}})}getComments(){return this._threadCommentModel.getUnit(this._workbook.getUnitId()).map(e=>this._injector.createInstance(ee,e.root))}clearComments(){const e=this.getComments().map(n=>n.deleteAsync());return Promise.all(e).then(()=>!0)}onThreadCommentChange(e){return Ie(this._threadCommentModel.commentUpdate$.pipe(kt(n=>n.unitId===this._workbook.getUnitId())).subscribe(e))}onBeforeAddThreadComment(e){return Ie(this._commandService.beforeCommandExecuted((n,r)=>{const i=n.params;if(n.id===se.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeAddThreadComment")}}))}onBeforeUpdateThreadComment(e){return Ie(this._commandService.beforeCommandExecuted((n,r)=>{const i=n.params;if(n.id===xe.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateThreadComment")}}))}onBeforeDeleteThreadComment(e){return Ie(this._commandService.beforeCommandExecuted((n,r)=>{const i=n.params;if(n.id===Se.id||n.id===ae.id){if(i.unitId!==this._workbook.getUnitId())return;if(e(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteThreadComment")}}))}}Ot.extend(di);class li extends Wt{getComments(){return this._injector.get(A).getSubUnitAll(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>this._injector.createInstance(ee,e))}clearComments(){const e=this.getComments().map(n=>n.deleteAsync());return Promise.all(e).then(()=>!0)}onCommented(e){return this._injector.get(P).onCommandExecuted(n=>{if(n.id===se.id){const r=n.params;e(r)}})}getCommentById(e){const n=this._injector.get(A).getComment(this._workbook.getUnitId(),this._worksheet.getSheetId(),e);if(n)return this._injector.createInstance(ee,n)}}Wt.extend(li);const K={CommentAdded:"CommentAdded",BeforeCommentAdd:"BeforeCommentAdd",CommentUpdated:"CommentUpdated",BeforeCommentUpdate:"BeforeCommentUpdate",CommentDeleted:"CommentDeleted",BeforeCommentDelete:"BeforeCommentDelete",CommentResolved:"CommentResolved",BeforeCommentResolve:"BeforeCommentResolve"};class ui extends Vt{get CommentAdded(){return K.CommentAdded}get BeforeCommentAdd(){return K.BeforeCommentAdd}get CommentUpdated(){return K.CommentUpdated}get BeforeCommentUpdate(){return K.BeforeCommentUpdate}get CommentDeleted(){return K.CommentDeleted}get BeforeCommentDelete(){return K.BeforeCommentDelete}get CommentResolved(){return K.CommentResolved}get BeforeCommentResolve(){return K.BeforeCommentResolve}}Vt.extend(ui);class ci extends Ht{_initialize(e){const n=e.get(P);this.registerEventHandler(this.Event.CommentAdded,()=>n.onCommandExecuted(r=>{var i,o,s,a,d;if(r.id!==se.id)return;const l=r.params;if(!l)return;const c=l.unitId?this.getUniverSheet(l.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!c)return;const u=c.getSheetBySheetId(l.subUnitId||l.sheetId)||c.getActiveSheet();if(!u)return;const p=r.params,{comment:C}=p,h=u.getRange(C.ref).getComment();h&&this.fireEvent(this.Event.CommentAdded,{workbook:c,worksheet:u,row:(s=(o=h.getRange())==null?void 0:o.getRow())!=null?s:0,col:(d=(a=h.getRange())==null?void 0:a.getColumn())!=null?d:0,comment:h})})),this.registerEventHandler(this.Event.CommentUpdated,()=>n.onCommandExecuted(r=>{var i,o,s,a,d;if(r.id!==xe.id)return;const l=r.params;if(!l)return;const c=l.unitId?this.getUniverSheet(l.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!c)return;const u=c.getSheetBySheetId(l.subUnitId||l.sheetId)||c.getActiveSheet();if(!u)return;const p=r.params,{commentId:C}=p.payload,h=u.getCommentById(C);h&&this.fireEvent(this.Event.CommentUpdated,{workbook:c,worksheet:u,row:(s=(o=h.getRange())==null?void 0:o.getRow())!=null?s:0,col:(d=(a=h.getRange())==null?void 0:a.getColumn())!=null?d:0,comment:h})})),this.registerEventHandler(this.Event.CommentDeleted,()=>n.onCommandExecuted(r=>{var i;if(r.id!==Se.id&&r.id!==ae.id)return;const o=r.params;if(!o)return;const s=o.unitId?this.getUniverSheet(o.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!s)return;const a=s.getSheetBySheetId(o.subUnitId||o.sheetId)||s.getActiveSheet();if(!a)return;const d=r.params,{commentId:l}=d;this.fireEvent(this.Event.CommentDeleted,{workbook:s,worksheet:a,commentId:l})})),this.registerEventHandler(this.Event.CommentResolved,()=>n.onCommandExecuted(r=>{var i,o,s;if(r.id!==Ae.id)return;const a=r.params;if(!a)return;const d=a.unitId?this.getUniverSheet(a.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!d)return;const l=d.getSheetBySheetId(a.subUnitId||a.sheetId)||d.getActiveSheet();if(!l)return;const c=r.params,{commentId:u,resolved:p}=c,C=l.getComments().find(h=>h.getCommentData().id===u);C&&this.fireEvent(this.Event.CommentResolved,{workbook:d,worksheet:l,row:(o=C.getRange().getRow())!=null?o:0,col:(s=C.getRange().getColumn())!=null?s:0,comment:C,resolved:p})})),this.registerEventHandler(this.Event.BeforeCommentAdd,()=>n.beforeCommandExecuted(r=>{var i,o,s;if(r.id!==se.id)return;const a=r.params;if(!a)return;const d=a.unitId?this.getUniverSheet(a.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!d)return;const l=d.getSheetBySheetId(a.subUnitId||a.sheetId)||d.getActiveSheet();if(!l)return;const c=r.params,{comment:u}=c,p=l.getActiveRange();if(!p)return;const C={workbook:d,worksheet:l,row:(o=p.getRow())!=null?o:0,col:(s=p.getColumn())!=null?s:0,comment:Qe.create(u)};if(this.fireEvent(this.Event.BeforeCommentAdd,C),C.cancel)throw new Te})),this.registerEventHandler(this.Event.BeforeCommentUpdate,()=>n.beforeCommandExecuted(r=>{var i,o,s,a,d;if(r.id!==xe.id)return;const l=r.params;if(!l)return;const c=l.unitId?this.getUniverSheet(l.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!c)return;const u=c.getSheetBySheetId(l.subUnitId||l.sheetId)||c.getActiveSheet();if(!u)return;const p=r.params,{commentId:C,text:h}=p.payload,v=u.getCommentById(C);if(v){const M={workbook:c,worksheet:u,row:(s=(o=v.getRange())==null?void 0:o.getRow())!=null?s:0,col:(d=(a=v.getRange())==null?void 0:a.getColumn())!=null?d:0,comment:v,newContent:_e.createByBody(h)};if(this.fireEvent(this.Event.BeforeCommentUpdate,M),M.cancel)throw new Te}})),this.registerEventHandler(this.Event.BeforeCommentDelete,()=>n.beforeCommandExecuted(r=>{var i,o,s,a,d;if(r.id!==Se.id&&r.id!==ae.id)return;const l=r.params;if(!l)return;const c=l.unitId?this.getUniverSheet(l.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!c)return;const u=c.getSheetBySheetId(l.subUnitId||l.sheetId)||c.getActiveSheet();if(!u)return;const p=r.params,{commentId:C}=p,h=u.getCommentById(C);if(h){const v={workbook:c,worksheet:u,row:(s=(o=h.getRange())==null?void 0:o.getRow())!=null?s:0,col:(d=(a=h.getRange())==null?void 0:a.getColumn())!=null?d:0,comment:h};if(this.fireEvent(this.Event.BeforeCommentDelete,v),v.cancel)throw new Te}})),this.registerEventHandler(this.Event.BeforeCommentResolve,()=>n.beforeCommandExecuted(r=>{var i,o,s;if(r.id!==Ae.id)return;const a=r.params;if(!a)return;const d=a.unitId?this.getUniverSheet(a.unitId):(i=this.getActiveWorkbook)==null?void 0:i.call(this);if(!d)return;const l=d.getSheetBySheetId(a.subUnitId||a.sheetId)||d.getActiveSheet();if(!l)return;const c=r.params,{commentId:u,resolved:p}=c,C=l.getComments().find(h=>h.getCommentData().id===u);if(C){const h={workbook:d,worksheet:l,row:(o=C.getRange().getRow())!=null?o:0,col:(s=C.getRange().getColumn())!=null?s:0,comment:C,resolved:p};if(this.fireEvent(this.Event.BeforeCommentResolve,h),h.cancel)throw new Te}}))}newTheadComment(e){return new Me(e)}}Ht.extend(ci);function Ei(t={}){return{plugins:[he,me,ye]}}export{se as AddCommentCommand,Se as DeleteCommentCommand,ae as DeleteCommentTreeCommand,Lt as IThreadCommentDataSourceService,Ae as ResolveCommentCommand,on as SHEETS_THREAD_COMMENT,z as SetActiveCommentOperation,A as SheetsThreadCommentModel,X as SheetsThreadCommentPopupService,De as SheetsThreadCommentRefRangeController,ke as ShowAddSheetCommentModalOperation,Zt as THREAD_COMMENT_PANEL,jr as ThreadCommentPanel,Y as ThreadCommentPanelService,nn as ThreadCommentTree,pt as ToggleSheetCommentPanelOperation,me as UniverSheetsThreadCommentPlugin,Ei as UniverSheetsThreadCommentPreset,ye as UniverSheetsThreadCommentUIPlugin,he as UniverThreadCommentUIPlugin,xe as UpdateCommentCommand};
