import{M as G,aa as Ar,ab as ve,L as H,F as Q,C as Ne,ac as _e,P as It,v as P,w as de,ad as Bt,V as se,S as ce,ae as Wr,s as Yn,af as Oe,a5 as Vt,O as Zn,o as Jn,G as Qn,z as ln,f as ke,n as Ot,ag as nt,I,H as Pr,u as Fe,x as Qt,ah as qr,ai as Yr,aj as gn,a6 as Gn,ak as ge,m as mn,b as Zr,al as jt,e as Jr,am as bn,an as zn,ao as Qr,U as Re,q as Gr,y as zr}from"./TeamSpreadsheet-DqPQXi__.js";import{iZ as Xn,kv as Kn,md as Gt,nJ as ne,z as De,jF as er,ks as tr,nD as zt,jS as nr,ky as rr,h as pn,kz as Xr,je as Kr,kl as vn,s as Te,kr as ea,kx as ta,jE as na,jR as ra,G as wt,jz as aa,km as sa,me as ia,nb as la,t9 as ar,lg as oa,lf as sr,pq as ua,nF as Mn,lr as Nn,t8 as da,lC as ca,qG as ha,E as ga,A as ma,pT as ba,pO as pa,P as ir,u as Xt,qP as va,gv as fa,h8 as Ia,h9 as Ca,o7 as wa,np as Ta,d as U,eK as $n,e4 as _a,t6 as Be,rb as Sa,ra as xa,f as Ra,H as We,c as ya,B as Ma,gD as Na,w as $a,mK as lr,r as or,gj as En,M as ur,k as dr,pV as Ea,x as Fa,qd as Da,n as Ua}from"./index--BQDx9CP.js";import{r as x,j as g,X as La,v as je,d as Oa,i as A,k as J,c as Qe,s as Rt,V as fn,e as Fn,p as ja,o as ka,x as tn,l as Ba,f as Va,L as Ha,O as cr}from"./facade-DLk4o3Z_.js";import{M as Aa,m as Dn}from"./index-BANiMnH0.js";import{W as Wa}from"./index-DNSnhRIr.js";import{C as hr,S as gr}from"./facade-DJ8otAmv.js";import"./index-mJOBftNs.js";import"./VRow-C6N6h8s9.js";import"./VCard-DFIDGoOa.js";import"./VSelect-CO5xudFf.js";import"./VTextField-tFIcna6m.js";import"./VTabs-BYSgCciz.js";import"./VAlert-CfJUBCCM.js";import"./VDialog-C4Wnh1zS.js";import"./VFileInput-DBMVcNlc.js";import"./VTextarea-34QBZFhW.js";var Pa=Object.defineProperty,qa=(t,e,n)=>e in t?Pa(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,_=(t,e,n)=>qa(t,typeof e!="symbol"?e+"":e,n),W=(t=>(t.Insert="insert",t.Delete="delete",t))(W||{}),X=(t=>(t.Row="row",t.Col="column",t))(X||{}),mr=(t=>(t.None="none",t.String="string",t.Number="number",t.Date="date",t.Bool="bool",t.Checkbox="checkbox",t.List="list",t))(mr||{}),Ee=(t=>(t.manual="manual",t.condition="condition",t))(Ee||{}),L=(t=>(t.Date="date",t.Number="number",t.String="string",t.Logic="logic",t))(L||{}),R=(t=>(t.Equal="equal",t.NotEqual="notEqual",t.GreaterThan="greaterThan",t.GreaterThanOrEqual="greaterThanOrEqual",t.LessThan="lessThan",t.LessThanOrEqual="lessThanOrEqual",t.Between="between",t.NotBetween="notBetween",t.Above="above",t.Below="below",t.TopN="topN",t))(R||{}),k=(t=>(t.Equal="equal",t.NotEqual="notEqual",t.Contains="contains",t.NotContains="notContains",t.StartsWith="startsWith",t.EndsWith="endsWith",t))(k||{}),d=(t=>(t.Equal="equal",t.NotEqual="notEqual",t.After="after",t.AfterOrEqual="afterOrEqual",t.Before="before",t.BeforeOrEqual="beforeOrEqual",t.Between="between",t.NotBetween="notBetween",t.Today="today",t.Yesterday="yesterday",t.Tomorrow="tomorrow",t.ThisWeek="thisWeek",t.LastWeek="lastWeek",t.NextWeek="nextWeek",t.ThisMonth="thisMonth",t.LastMonth="lastMonth",t.NextMonth="nextMonth",t.ThisQuarter="thisQuarter",t.LastQuarter="lastQuarter",t.NextQuarter="nextQuarter",t.ThisYear="thisYear",t.LastYear="lastYear",t.NextYear="nextYear",t.YearToDate="yearToDate",t.Quarter="quarter",t.Month="month",t.M1="m1",t.M2="m2",t.M3="m3",t.M4="m4",t.M5="m5",t.M6="m6",t.M7="m7",t.M8="m8",t.M9="m9",t.M10="m10",t.M11="m11",t.M12="m12",t.Q1="q1",t.Q2="q2",t.Q3="q3",t.Q4="q4",t))(d||{}),ae=(t=>(t[t.FilteredSortNone=1]="FilteredSortNone",t[t.FilteredSortAsc=2]="FilteredSortAsc",t[t.FilteredSortDesc=3]="FilteredSortDesc",t[t.FilterNoneSortNone=4]="FilterNoneSortNone",t[t.FilterNoneSortAsc=5]="FilterNoneSortAsc",t[t.FilterNoneSortDesc=6]="FilterNoneSortDesc",t))(ae||{}),be=(t=>(t.Asc="asc",t.Desc="desc",t.None="none",t))(be||{});function pt(t,e){return`${e} ${t}`}const Un="TRUE",Ln="FALSE",Ya=t=>{var e;return((e=t.body)==null?void 0:e.dataStream.replace(/\r\n$/,""))||""};function br(t){if(t){const{v:e,t:n,p:r}=t;return r?Ya(r):(n===ke.FORCE_STRING||n===ke.STRING)&&e!==void 0&&e!==null?String(e):n===ke.BOOLEAN?e?Un:Ln:n===ke.NUMBER?String(e):typeof e=="boolean"?e?Un:Ln:e==null?"":String(e)}return""}function Za(t,e){if(t!=null)switch(e){case be.Asc:return ae.FilteredSortAsc;case be.Desc:return ae.FilteredSortDesc;default:return ae.FilteredSortNone}else switch(e){case be.Asc:return ae.FilterNoneSortAsc;case be.Desc:return ae.FilterNoneSortDesc;default:return ae.FilterNoneSortNone}}function pr(t){return t?t.filterType===Ee.condition:!1}function Ja(t){return t?t.filterType===Ee.manual:!1}const ue={s:Ar.THIN,cl:{rgb:"rgb(95, 101, 116)"}},vr="sheets-table.config",On={},Qa={headerRowStyle:{bd:{t:ue}},headerColumnStyle:{bd:{l:ue}},lastColumnStyle:{bd:{r:ue}},lastRowStyle:{bd:{b:ue}}},jn=(t,e)=>{if(t==="headerRowStyle"){if(!e.bd)return{...e,bd:{t:ue}}}else if(t==="lastRowStyle"){if(!e.bd)return{...e,bd:{b:ue}}}else if(t==="lastColumnStyle"){if(!e.bd)return{...e,bd:{r:ue}}}else if(t==="headerColumnStyle"&&!e.bd)return{...e,bd:{l:ue}};return e},Ga=[[["#6280F9","#FFFFFF","#BAC6F8","#D2DAFA"],["#fff"]],[["#16BDCA","#FFFFFF","#EDFAFA","#AFECEF"],["#000"]],[["#31C48D","#FFFFFF","#F3FAF7","#BCF0DA"],["#fff"]],[["#AC94FA","#FFFFFF","#F6F5FF","#EDEBFE"],["#fff"]],[["#F17EBB","#FFFFFF","#FDF2F8","#FCE8F3"],["#fff"]],[["#F98080","#FFFFFF","#FDF2F2","#FDE8E8"],["#fff"]]],fr=Ga.map((t,e)=>{const[n,r]=t,[a,s,i,l]=n,[u]=r;return{name:`table-default-${e}`,style:{headerRowStyle:{bg:{rgb:a},cl:{rgb:u},bd:{t:ue}},headerColumnStyle:{bd:{l:ue}},firstRowStyle:{bg:{rgb:s}},secondRowStyle:{bg:{rgb:i}},lastRowStyle:{bg:{rgb:l},bd:{b:ue}},lastColumnStyle:{bd:{r:ue}}}}});let Ge=class{constructor(e,n){_(this,"dataType"),_(this,"id"),_(this,"displayName"),_(this,"formula"),_(this,"meta"),_(this,"style"),this.id=e,this.displayName=n,this.dataType=mr.String,this.formula="",this.meta={},this.style={}}getMeta(){return this.meta}setMeta(e){this.meta=e}getDisplayName(){return this.displayName}toJSON(){return{id:this.id,displayName:this.displayName,dataType:this.dataType,formula:this.formula,meta:this.meta,style:this.style}}fromJSON(e){this.id=e.id,this.displayName=e.displayName,this.dataType=e.dataType,this.formula=e.formula,this.meta=e.meta,this.style=e.style}};const za=t=>t.getMonth()<=2,Xa=t=>{const e=t.getMonth();return e>2&&e<=5},Ka=t=>{const e=t.getMonth();return e>5&&e<=8},es=t=>{const e=t.getMonth();return e>8&&e<=11},ts=t=>t.getMonth()===0,ns=t=>t.getMonth()===1,rs=t=>t.getMonth()===2,as=t=>t.getMonth()===3,ss=t=>t.getMonth()===4,is=t=>t.getMonth()===5,ls=t=>t.getMonth()===6,os=t=>t.getMonth()===7,us=t=>t.getMonth()===8,ds=t=>t.getMonth()===9,cs=t=>t.getMonth()===10,hs=t=>t.getMonth()===11,gs=(t,e=new Date)=>t.toDateString()===e.toDateString(),ms=(t,e=new Date)=>{const n=new Date(e);return n.setDate(n.getDate()+1),t.toDateString()===n.toDateString()},bs=(t,e=new Date)=>{const n=new Date(e);return n.setDate(n.getDate()-1),t.toDateString()===n.toDateString()},ze=t=>{const e=t.getDay(),n=t.getDate()-e+(e===0?-6:1),r=new Date(t);return r.setDate(n),r},Ir=10080*60*1e3,ps=(t,e=new Date)=>{const n=ze(t),r=ze(e);return n.toDateString()===r.toDateString()},vs=(t,e=new Date)=>{const n=ze(t),r=new Date(ze(e).getTime()+Ir);return n.toDateString()===r.toDateString()},fs=(t,e=new Date)=>{const n=ze(t),r=new Date(ze(e).getTime()-Ir);return n.toDateString()===r.toDateString()},Is=(t,e=new Date)=>t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth(),Cs=t=>{const e=new Date(t);return e.setHours(0,0,0,0),e.setDate(1),e},ws=(t,e=new Date)=>{const n=new Date(e);n.setHours(0,0,0,0),n.setMonth(n.getMonth()+1,1);const r=new Date(n);r.setMonth(r.getMonth()+1,0);const a=t.getTime();return a>=n.getTime()&&a<r.getTime()},Ts=(t,e=new Date)=>{const n=Cs(e),r=new Date(n);r.setMonth(r.getMonth()+1,0);const a=t.getTime();return a>=n.getTime()&&a<r.getTime()},In=t=>{const e=new Date(t);e.setHours(0,0,0,0),e.setDate(1);const n=e.getMonth();return e.setMonth(n-n%3),e},_s=(t,e=new Date)=>{const n=In(e),r=new Date(n);r.setMonth(r.getMonth()+3);const a=t.getTime();return a>=n.getTime()&&a<r.getTime()},Ss=(t,e=new Date)=>{const n=In(e),r=new Date(n);r.setMonth(r.getMonth()+3);const a=new Date(r);a.setMonth(a.getMonth()+3,0);const s=t.getTime();return s>=r.getTime()&&s<a.getTime()},xs=(t,e=new Date)=>{const n=In(e),r=new Date(n);r.setMonth(r.getMonth()-3);const a=new Date(n);a.setDate(0);const s=t.getTime();return s>=r.getTime()&&s<a.getTime()},Rs=(t,e=new Date)=>t.getFullYear()===e.getFullYear(),ys=(t,e=new Date)=>t.getFullYear()===e.getFullYear()+1,Ms=(t,e=new Date)=>t.getFullYear()===e.getFullYear()-1,Ns=(t,e=new Date)=>{const n=new Date(e);n.setHours(0,0,0,0),n.setMonth(0,1);const r=t.getTime();return r>=n.getTime()&&r<e.getTime()};function $s(t){switch(t.compareType){case d.Equal:{const e=new Date(t.expectedValue);return n=>n.getTime()===e.getTime()}case d.NotEqual:{const e=new Date(t.expectedValue);return n=>n.getTime()!==e.getTime()}case d.After:{const e=new Date(t.expectedValue);return n=>n.getTime()>e.getTime()}case d.Before:{const e=new Date(t.expectedValue);return n=>n.getTime()<e.getTime()}case d.AfterOrEqual:{const e=new Date(t.expectedValue);return n=>n.getTime()>=e.getTime()}case d.BeforeOrEqual:{const e=new Date(t.expectedValue);return n=>n.getTime()<=e.getTime()}case d.Between:return e=>{const[n,r]=t.expectedValue;return e.getTime()>=new Date(n).getTime()&&e.getTime()<=new Date(r).getTime()};case d.NotBetween:return e=>{const[n,r]=t.expectedValue;return e.getTime()<new Date(n).getTime()||e.getTime()>new Date(r).getTime()};case d.Today:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>gs(n,e)}case d.Yesterday:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>bs(n,e)}case d.Tomorrow:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>ms(n,e)}case d.ThisWeek:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>ps(n,e)}case d.LastWeek:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>fs(n,e)}case d.NextWeek:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>vs(n,e)}case d.ThisMonth:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>Is(n,e)}case d.LastMonth:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>Ts(n,e)}case d.NextMonth:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>ws(n,e)}case d.ThisQuarter:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>_s(n,e)}case d.LastQuarter:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>xs(n,e)}case d.NextQuarter:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>Ss(n,e)}case d.ThisYear:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>Rs(n,e)}case d.LastYear:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>Ms(n,e)}case d.NextYear:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>ys(n,e)}case d.YearToDate:{const e=t.anchorTime?new Date(t.anchorTime):new Date;return n=>Ns(n,e)}case d.M1:return ts;case d.M2:return ns;case d.M3:return rs;case d.M4:return as;case d.M5:return ss;case d.M6:return is;case d.M7:return ls;case d.M8:return os;case d.M9:return us;case d.M10:return ds;case d.M11:return cs;case d.M12:return hs;case d.Q1:return za;case d.Q2:return Xa;case d.Q3:return Ka;case d.Q4:return es;default:throw new Error("Unsupported compare type")}}class Es{constructor(){_(this,"heap"),this.heap=[]}swap(e,n){const r=this.heap[e];this.heap[e]=this.heap[n],this.heap[n]=r}getParentIndex(e){return Math.floor((e-1)/2)}getLeftIndex(e){return e*2+1}getRightIndex(e){return e*2+2}size(){return this.heap.length}peek(){return this.heap[0]}include(e){return this.heap.includes(e)}}class Fs extends Es{constructor(){super()}shiftUp(e){if(e===0)return;const n=this.getParentIndex(e);this.heap[n]>this.heap[e]&&(this.swap(n,e),this.shiftUp(n))}shiftDown(e){const n=this.getLeftIndex(e),r=this.getRightIndex(e);this.heap[n]<this.heap[e]&&(this.swap(n,e),this.shiftDown(n)),this.heap[r]<this.heap[e]&&(this.swap(r,e),this.shiftDown(r))}insert(e){this.heap.push(e),this.shiftUp(this.heap.length-1)}pop(){this.heap[0]=this.heap.pop(),this.shiftDown(0)}}const Ds=(t,e)=>{const n=new Fs;for(const r of t)n.insert(r),n.size()>e&&n.pop();return n.heap},Us=(t,e)=>t>e,Ls=(t,e)=>t<e,Os=(t,e,n)=>Ds(t,e).includes(n);function js(t,e){switch(t.compareType){case R.Equal:{const n=Number(t.expectedValue);return r=>r===n}case R.NotEqual:{const n=Number(t.expectedValue);return r=>r!==n}case R.GreaterThan:{const n=Number(t.expectedValue);return r=>r>n}case R.GreaterThanOrEqual:{const n=Number(t.expectedValue);return r=>r>=n}case R.LessThan:{const n=Number(t.expectedValue);return r=>r<n}case R.LessThanOrEqual:{const n=Number(t.expectedValue);return r=>r<=n}case R.Between:{const[n,r]=t.expectedValue,a=Number(n),s=Number(r);return a>s?i=>i>=s&&i<=a:i=>i>=a&&i<=s}case R.NotBetween:{const[n,r]=t.expectedValue,a=Number(n),s=Number(r);return a>s?i=>i<s||i>a:i=>i<a||i>s}case R.Above:{const n=e.average;return r=>Us(r,n)}case R.Below:{const n=e.average;return r=>Ls(r,n)}case R.TopN:{const n=e.list,r=Number(t.expectedValue);return a=>Os(n,r,a)}}}const ks=(t,e)=>nt(e).test(t),Bs=(t,e)=>!nt(e).test(t),Vs=(t,e)=>nt(`*${e}*`).test(t),Hs=(t,e)=>!nt(`*${e}*`).test(t),As=(t,e)=>nt(`${e}*`).test(t),Ws=(t,e)=>nt(`*${e}`).test(t);function Ps(t){switch(t.compareType){case k.Equal:return e=>ks(e,t.expectedValue);case k.NotEqual:return e=>Bs(e,t.expectedValue);case k.Contains:return e=>Vs(e,t.expectedValue);case k.NotContains:return e=>Hs(e,t.expectedValue);case k.StartsWith:return e=>As(e,t.expectedValue);case k.EndsWith:return e=>Ws(e,t.expectedValue);default:return console.error(`Unknown filter operator: ${t.compareType}`),e=>!0}}const qs=new Set([R.Above,R.Below,R.TopN]);d.Today,d.Yesterday,d.Tomorrow,d.ThisWeek,d.LastWeek,d.NextWeek,d.ThisMonth,d.LastMonth,d.NextMonth,d.ThisQuarter,d.LastQuarter,d.NextQuarter,d.NextYear,d.ThisYear,d.LastYear,d.YearToDate;function Cr(t){return qs.has(t)}function Ys(t,e){if(Cr(t.filterInfo.compareType))return n=>!0;switch(t.filterInfo.conditionType){case L.Date:return $s(t.filterInfo);case L.Number:return js(t.filterInfo,e);case L.String:return Ps(t.filterInfo);case L.Logic:default:return n=>!0}}function kt(t,e,n,r){switch(r){case L.Date:{const a=kn(t,e,n);return a?Qs(a):null}case L.Number:return kn(t,e,n);case L.String:default:return Js(t,e,n)}}const Zs=t=>{var e;return((e=t.body)==null?void 0:e.dataStream.replace(/\r\n$/,""))||""};function Js(t,e,n){const r=t.getCell(e,n);if(!r)return null;const{v:a,t:s,p:i}=r;if(i)return Zs(i);if(typeof a=="string")return s===ke.BOOLEAN?a.toUpperCase():a;if(typeof a=="number")return s===ke.BOOLEAN?a?"TRUE":"FALSE":a;if(typeof a=="boolean")return a?"TRUE":"FALSE";if(a!==void 0)return String(a)}function kn(t,e,n){const r=t.getCell(e,n);if(!r)return null;const{v:a,t:s,p:i}=r;return i?null:typeof a=="string"&&s===ke.NUMBER?Number(t.getCellRaw(e,n).v):Number(a)}function Qs(t){const e=new Date(Date.UTC(1900,0,1,0,0,0)),n=new Date(Date.UTC(1900,1,28,0,0,0));let r=t-1;return r>(n.getTime()-e.getTime())/(1e3*3600*24)&&(r-=1),r<0&&(r=t),new Date(e.getTime()+r*(1e3*3600*24))}class Bn{constructor(){_(this,"_tableColumnFilterList"),_(this,"_tableSortInfo"),_(this,"_filterOutRows"),this._tableColumnFilterList=[]}setColumnFilter(e,n){n?this._tableColumnFilterList[e]=n:this._tableColumnFilterList[e]=void 0}setSortState(e,n){this._tableSortInfo={columnIndex:e,sortState:n}}getColumnFilter(e){return this._tableColumnFilterList[e]}getFilterState(e){var n;const r=((n=this._tableSortInfo)==null?void 0:n.columnIndex)===e?this._tableSortInfo.sortState:be.None;return Za(this._tableColumnFilterList[e],r)}getSortState(){var e;return(e=this._tableSortInfo)!=null?e:{}}getFilterStates(e){const n=[],{startColumn:r,endColumn:a}=e;for(let s=r;s<=a;s++)n.push(this.getFilterState(s-r));return n}getFilterOutRows(){return this._filterOutRows}doFilter(e,n){const r=new Set,a=this._tableColumnFilterList;for(let s=0;s<a.length;s++)a[s]&&this.doColumnFilter(e,n,s,r);return this._filterOutRows=r,r}doColumnFilter(e,n,r,a){const s=this._tableColumnFilterList[r];if(s&&e){const{startRow:i,endRow:l,startColumn:u}=n,o=u+r,h=this.getExecuteFunc(e,n,r,s);for(let c=i;c<=l;c++){const m=pr(s)?s.filterInfo.conditionType:L.String;kt(e,c,o,m)===null?a.add(c):h(kt(e,c,o,m))||a.add(c)}}}_getNumberCalculatedOptions(e,n,r){const{startRow:a,endRow:s,startColumn:i}=n,l=i+r,u=[];let o=0,h=0;for(let c=a;c<=s;c++){const m=kt(e,c,l,L.Number);m!==null&&(u.push(m),o++,h+=m)}return{list:u,average:o>0?h/o:0}}getExecuteFunc(e,n,r,a){if(a.filterType===Ee.manual){const s=new Set(a.values);return i=>s.has(i)}else if(a.filterType===Ee.condition){const s=Cr(a.filterInfo.compareType)?this._getNumberCalculatedOptions(e,n,r):void 0;return Ys(a,s)}else return s=>!0}toJSON(){return{tableColumnFilterList:this._tableColumnFilterList,tableSortInfo:this._tableSortInfo}}fromJSON(e){var n;this._tableColumnFilterList=(n=e.tableColumnFilterList)!=null?n:[],e.tableSortInfo&&(this._tableSortInfo=e.tableSortInfo)}dispose(){this._tableColumnFilterList=[]}}let Vn=class{constructor(e,n,r,a,s={}){_(this,"_id"),_(this,"_name"),_(this,"_tableStyleId"),_(this,"_showHeader"),_(this,"_showFooter"),_(this,"_range"),_(this,"_columns",new Map),_(this,"_columnOrder",[]),_(this,"tableMeta"),_(this,"_tableFilters"),_(this,"_subUnitId"),this._id=e,this._range=r,this._name=n,this._tableFilters=new Bn,this._init(a,s)}_init(e,n){var r,a;this._tableStyleId=n==null?void 0:n.tableStyleId,this._showHeader=(r=n==null?void 0:n.showHeader)!=null?r:!0,this._showFooter=!1;const s=this.getRange(),i=s.startColumn,l=s.endColumn;for(let u=i;u<=l;u++){const o=u-i;let h,c;(a=n.columns)!=null&&a[o]?(h=n.columns[o].id,c=n.columns[o].displayName):(h=Ne(),c=e[u-i]);const m=new Ge(h,c);this._columns.set(h,m),this._columnOrder.push(h)}n.filters&&n.filters.forEach((u,o)=>{u&&this._tableFilters.setColumnFilter(o,u)})}setTableFilterColumn(e,n){this._tableFilters.setColumnFilter(e,n)}getTableFilterColumn(e){return this._tableFilters.getColumnFilter(e)}getTableFilters(){return this._tableFilters}getTableFilterRange(){const e=this.getRange(),n=this.isShowHeader(),r=this.isShowFooter(),{startRow:a,startColumn:s,endRow:i,endColumn:l}=e,u=n?a+1:a,o=r?i-1:i;return{startRow:u,startColumn:s,endRow:o,endColumn:l}}setColumns(e){this._columns.clear(),this._columnOrder=[],e.forEach(n=>{const r=new Ge(n.id,n.displayName);r.fromJSON(n),this._columns.set(n.id,r),this._columnOrder.push(n.id)})}getColumnsCount(){return this._columnOrder.length}insertColumn(e,n){const r=n.id;this._columns.set(r,n),this._columnOrder.splice(e,0,r)}removeColumn(e){const n=this._columnOrder[e];this._columns.delete(n),this._columnOrder.splice(e,1)}setTableMeta(e){this.tableMeta=e}getTableMeta(){return this.tableMeta}getColumn(e){return this._columns.get(e)}getTableColumnByIndex(e){const n=this._columnOrder[e];return this.getColumn(n)}getColumnNameByIndex(e){var n;const r=this._columnOrder[e];return((n=this.getColumn(r))==null?void 0:n.getDisplayName())||""}getId(){return this._id}getRangeInfo(){return{...this._range}}getRange(){return{...this._range}}setRange(e){this._range=e}setDisplayName(e){this._name=e}getDisplayName(){return this._name}getSubunitId(){return this._subUnitId}setSubunitId(e){this._subUnitId=e}getTableStyleId(){var e;return(e=this._tableStyleId)!=null?e:fr[0].name}setTableStyleId(e){this._tableStyleId=e}isShowHeader(){var e;return(e=this._showHeader)!=null?e:!0}setShowHeader(e){this._showHeader=e}isShowFooter(){var e;return(e=this._showFooter)!=null?e:!1}getTableInfo(){return{id:this._id,subUnitId:this._subUnitId,name:this._name,range:this.getRangeInfo(),meta:this.tableMeta,showHeader:this._showHeader,columns:this._columnOrder.map(e=>this._columns.get(e).toJSON())}}getTableConfig(){return{name:this.getDisplayName(),range:this.getRangeInfo(),options:{showHeader:this._showHeader,showFooter:this._showFooter},tableStyleId:this._tableStyleId}}getFilterStates(e){return this._tableFilters.getFilterStates(e)}toJSON(){const e=[];return this._columns.forEach(n=>{e.push(n.toJSON())}),{id:this._id,name:this._name,range:this.getRangeInfo(),options:{showHeader:this._showHeader,showFooter:this._showFooter,tableStyleId:this._tableStyleId},filters:this._tableFilters.toJSON(),columns:e,meta:this.tableMeta}}fromJSON(e){var n,r;this._id=e.id,this._name=e.name,this._range=e.range,this.tableMeta=e.meta,this._tableStyleId=e.options.tableStyleId||"",this._showHeader=(n=e.options.showHeader)!=null?n:!0,this._showFooter=(r=e.options.showFooter)!=null?r:!0,e.columns.forEach(a=>{const s=new Ge(a.id,a.displayName);s.fromJSON(a),this._columns.set(a.id,s),this._columnOrder.push(a.id)}),this._tableFilters=new Bn,this._tableFilters.fromJSON(e.filters)}dispose(){this._id="",this._name="",this._tableStyleId="",this._showHeader=!0,this._showFooter=!0,delete this._range,this._columns.clear(),this._columnOrder=[]}};var Gs=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Hn=(t,e)=>(n,r)=>e(n,r,t);let O=class extends se{constructor(t,e){super(),_(this,"_tableMap"),_(this,"_tableAdd$",new Oe),_(this,"tableAdd$",this._tableAdd$.asObservable()),_(this,"_tableDelete$",new Oe),_(this,"tableDelete$",this._tableDelete$.asObservable()),_(this,"_tableNameChanged$",new Oe),_(this,"tableNameChanged$",this._tableNameChanged$.asObservable()),_(this,"_tableRangeChanged$",new Oe),_(this,"tableRangeChanged$",this._tableRangeChanged$.asObservable()),_(this,"_tableThemeChanged$",new Oe),_(this,"tableThemeChanged$",this._tableThemeChanged$.asObservable()),_(this,"_tableFilterChanged$",new Oe),_(this,"tableFilterChanged$",this._tableFilterChanged$.asObservable()),_(this,"_tableInitStatus",new Vt(!1)),_(this,"tableInitStatus$",this._tableInitStatus.asObservable()),this._univerInstanceService=t,this._localeService=e,this._tableMap=new Map}_ensureUnit(t){return this._tableMap.has(t)||this._tableMap.set(t,new Map),this._tableMap.get(t)}getColumnHeader(t,e,n,r){var a;const s=(a=this._univerInstanceService.getUnit(t))==null?void 0:a.getSheetBySheetId(e),{startRow:i,startColumn:l,endColumn:u}=n,o=[],h=r??"Column";for(let c=l;c<=u;c++)o.push(br(s==null?void 0:s.getCell(i,c))||pt(c-l+1,h));return o}addTable(t,e,n,r,a,s,i){var l;const u=s??Ne(),o=a||this.getColumnHeader(t,e,r),h=new Vn(u,n,r,o,i);if(h.setSubunitId(e),this._ensureUnit(t).set(u,h),this._tableAdd$.next({unitId:t,subUnitId:e,range:r,tableName:n,tableId:u,tableStyleId:i==null?void 0:i.tableStyleId}),i!=null&&i.filters){const c=(l=this._univerInstanceService.getUnit(t))==null?void 0:l.getSheetBySheetId(e);h.getTableFilters().doFilter(c,r),this._tableFilterChanged$.next({unitId:t,subUnitId:e,tableId:u})}return u}addFilter(t,e,n,r){const a=this.getTable(t,e);if(a){a.getTableFilters().setColumnFilter(n,r);const s=a.getSubunitId();this._tableFilterChanged$.next({unitId:t,subUnitId:s,tableId:e})}}getFilterRanges(t,e){const n=this._tableMap.get(t);if(!n)return[];const r=[];return n.forEach(a=>{a.getSubunitId()===e&&a.isShowHeader()&&r.push(a.getRange())}),r}getSheetFilterRangeWithState(t,e){const n=this._tableMap.get(t);if(!n)return[];const r=[];return n.forEach(a=>{a.getSubunitId()===e&&a.isShowHeader()&&r.push({tableId:a.getId(),range:a.getRange(),states:a.getFilterStates(a.getRange())})}),r}getTable(t,e){const n=this._tableMap.get(t);if(n)return n.get(e)}getUniqueTableName(t,e){const n=this._tableMap.get(t);if(!n)return e;const r=new Set(Array.from(n.values()).map(i=>i.getDisplayName()));let a=e,s=1;for(;r.has(a);)a=`${e}-${s}`,s++;return a}getTableById(t,e){return this.getTable(t,e)}getTableList(t){const e=this._tableMap.get(t);return e?Array.from(e.values()).map(n=>({...n.getTableInfo(),unitId:t})):[]}getTablesBySubunitId(t,e){const n=this._tableMap.get(t);return n?Array.from(n.values()).filter(r=>r.getSubunitId()===e):[]}getTablesInfoBySubunitId(t,e){return this.getTablesBySubunitId(t,e).map(n=>({id:n.getId(),name:n.getDisplayName(),range:n.getRange()}))}deleteTable(t,e){const n=this._tableMap.get(t),r=n==null?void 0:n.get(e);if(r){const a=r.getTableInfo(),s=r.getTableStyleId();n==null||n.delete(e);const{subUnitId:i,range:l,name:u}=a;this._tableDelete$.next({unitId:t,subUnitId:i,tableId:e,range:l,tableName:u,tableStyleId:s})}}operationTableRowCol(t,e,n){const r=this.getTableById(t,e);if(!r)return;const{operationType:a,rowColType:s,index:i,count:l,columnsJson:u}=n,o=r.getRange(),h={...o};if(a===W.Insert){if(s==="row")h.endRow+=l;else if(s==="column"){h.endColumn+=l;for(let c=0;c<l;c++){const m=this._localeService.t("sheets-table.columnPrefix"),b=new Ge(Ne(),pt(r.getColumnsCount()+1+c,m));u!=null&&u[c]&&b.fromJSON(u[c]);const f=i+c-o.startColumn;r.insertColumn(f,b)}}}else if(s==="row")h.endRow-=l;else if(s==="column"){h.endColumn-=l;for(let c=l-1;c>=0;c--){const m=i+c-o.startColumn;r.removeColumn(m)}}r.setRange(h),this._tableRangeChanged$.next({unitId:t,subUnitId:r.getSubunitId(),tableId:e,range:h,oldRange:o})}updateTableRange(t,e,n){const r=this.getTableById(t,e);if(!r)return;const a=r.getRange(),s=n.newRange;if(s.startColumn<a.startColumn){const i=a.startColumn-s.startColumn,l=this._localeService.t("sheets-table.columnPrefix");for(let u=0;u<i;u++)r.insertColumn(a.startColumn,new Ge(Ne(),pt(r.getColumnsCount()+1,l)))}else if(s.startColumn>a.startColumn){const i=s.startColumn-a.startColumn;for(let l=i-1;l>=0;l--){const u=s.startColumn+l-a.startColumn;r.removeColumn(u)}}if(s.endColumn<a.endColumn){const i=a.endColumn-s.endColumn;for(let l=i-1;l>=0;l--){const u=s.endColumn+l-a.startColumn;r.removeColumn(u)}}else if(s.endColumn>a.endColumn){const i=s.endColumn-a.endColumn;for(let l=0;l<i;l++)r.insertColumn(a.endColumn,new Ge(Ne(),pt(r.getColumnsCount()+1,"Column")))}r.setRange(s),this._tableRangeChanged$.next({unitId:t,subUnitId:r.getSubunitId(),tableId:e,range:s,oldRange:a})}setTableByConfig(t,e,n){var r;const a=this._tableMap.get(t),s=a==null?void 0:a.get(e);if(!s)return;const i=s.getSubunitId(),{name:l,updateRange:u,rowColOperation:o,theme:h,options:c}=n;if(l){const m=s.getDisplayName();s.setDisplayName(l),this._tableNameChanged$.next({unitId:t,subUnitId:i,tableId:e,tableName:l,oldTableName:m})}if(o&&this.operationTableRowCol(t,e,o),u&&this.updateTableRange(t,e,u),h){const m=(r=s.getTableStyleId())!=null?r:"default";s.setTableStyleId(h),this._tableThemeChanged$.next({unitId:t,subUnitId:i,tableId:e,theme:h,oldTheme:m})}c&&c.showHeader!==void 0&&s.setShowHeader(c.showHeader)}toJSON(t){const e={},n=this._tableMap.get(t);return n&&n.forEach(r=>{const a=r.getSubunitId();if(!e[a]){const s=new Set;this.getTablesBySubunitId(t,a).forEach(i=>{const l=i.getTableFilters().getFilterOutRows();if(l)for(const u of l)s.add(u)}),e[a]={tables:[],tableFilteredOutRows:Array.from(s)}}e[a].tables.push(r.toJSON())}),e}fromJSON(t,e){const n=this._ensureUnit(t);Object.keys(e).forEach(r=>{const a=ne(this._univerInstanceService,{unitId:t,subUnitId:r});if(!a)return;const s=a.worksheet;let i;e[r].tables?i=e[r].tables:Array.isArray(e[r])&&(i=e[r]),i&&i.forEach(l=>{const u=this.getColumnHeader(t,r,l.range),o=new Vn(l.id,l.name,l.range,u,l.options);if(o.setTableMeta(l.meta),l.columns.length&&o.setColumns(l.columns),l.filters){const h=o.getTableFilters();h.fromJSON(l.filters),h.doFilter(s,o.getTableFilterRange())}o.setSubunitId(r),n.set(l.id,o),this._tableAdd$.next({unitId:t,subUnitId:r,range:l.range,tableName:l.name,tableId:l.id})})}),this._tableInitStatus.next(!0)}deleteUnitId(t){this._tableMap.delete(t)}dispose(){super.dispose(),this._tableMap.forEach(t=>{t.forEach(e=>e.dispose()),t.clear()}),this._tableMap.clear()}};O=Gs([Hn(0,P),Hn(1,I(Q))],O);var zs=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Xs=(t,e)=>(n,r)=>e(n,r,t);let he=class extends se{constructor(e){super(),this._tableManager=e}getTableInfo(e,n){const r=this._tableManager.getTable(e,n);if(r)return{unitId:e,...r.getTableInfo()}}getTableList(e){return this._tableManager.getTableList(e)}addTable(e,n,r,a,s,i,l){return this._tableManager.addTable(e,n,r,a,s,i,l)}deleteTable(e,n,r){this._tableManager.deleteTable(e,r)}getTableMeta(e,n){var r;return(r=this._tableManager.getTable(e,n))==null?void 0:r.getTableMeta()}setTableMeta(e,n,r){var a;(a=this._tableManager.getTable(e,n))==null||a.setTableMeta(r)}getTableColumnMeta(e,n,r){var a,s;return(s=(a=this._tableManager.getTable(e,n))==null?void 0:a.getTableColumnByIndex(r))==null?void 0:s.getMeta()}selTableColumnMeta(e,n,r,a){var s,i;(i=(s=this._tableManager.getTable(e,n))==null?void 0:s.getTableColumnByIndex(r))==null||i.setMeta(a)}addFilter(e,n,r,a){this._tableManager.addFilter(e,n,r,a)}getCellValueWithConditionType(e,n,r,a=L.String){return kt(e,n,r,a)}};he=zs([Xs(0,I(O))],he);const Ve={id:"sheet.mutation.add-table",type:G.MUTATION,handler:(t,e)=>{const{tableId:n,unitId:r,subUnitId:a,name:s,range:i,header:l,options:u}=e;return t.get(he).addTable(r,a,s,i,l,n,u),!0}},He={id:"sheet.mutation.delete-table",type:G.MUTATION,handler:(t,e)=>{const{unitId:n,subUnitId:r,tableId:a}=e;return t.get(he).deleteTable(n,r,a),!0}},Kt={id:"sheet.command.add-table",type:G.COMMAND,handler:(t,e)=>{var n;if(!e)return!1;const r=t.get(ve),a=t.get(H),s=t.get(Q),i=(n=e.id)!=null?n:Ne();let l=e.name;if(!l){const p=t.get(O).getTableList(e.unitId).length;l=`${s.t("sheets-table.tablePrefix")}${p+1}`}const u=[],o=[],h=t.get(O),{unitId:c,subUnitId:m,range:b}=e,f=h.getColumnHeader(c,m,b,s.t("sheets-table.columnPrefix"));return u.push({id:Ve.id,params:{...e,tableId:i,name:l,header:f}}),o.push({id:He.id,params:{tableId:i,unitId:e.unitId}}),_e(u,a)&&r.pushUndoRedo({unitID:e.unitId,undoMutations:o,redoMutations:u}),!0}},en={id:"sheet.command.delete-table",type:G.COMMAND,handler:(t,e)=>{if(!e)return!1;const n=t.get(ve),r=t.get(H),a=t.get(O),s=t.get(It),i=[],l=[],u=a.getTable(e.unitId,e.tableId),o=u==null?void 0:u.toJSON();return o?(i.push({id:He.id,params:{...e}}),l.push({id:Ve.id,params:{unitId:e.unitId,subUnitId:e.subUnitId,tableId:e.tableId,name:o.name,range:o.range,options:o.options}}),_e(i,r)&&n.pushUndoRedo({unitID:e.unitId,undoMutations:l,redoMutations:i}),!0):(s.error("[TableManager]: Table not found"),!1)}},on={id:"sheet.mutation.set-table-filter",type:G.MUTATION,handler:(t,e)=>{const{tableId:n,unitId:r,column:a,tableFilter:s}=e;return t.get(O).addFilter(r,n,a,s),!0}},Xe={id:"sheet.command.set-table-filter",type:G.COMMAND,handler:(t,e)=>{if(!e)return!1;const n=t.get(ve),r=t.get(H),a=e.tableId||Ne(),s=[],i=[];return s.push({id:on.id,params:{...e,tableId:a}}),i.push({id:on.id,params:{...e,tableId:a,tableFilter:void 0}}),_e(s,r)&&n.pushUndoRedo({unitID:e.unitId,undoMutations:i,redoMutations:s}),!0}},wr="SHEET_TABLE_PLUGIN",yt="SHEET_TABLE",Tr="table-custom";var Ks=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Mt=(t,e)=>(n,r)=>e(n,r,t);let pe=class extends se{constructor(t,e,n,r){super(),_(this,"_tableRangeRTree",new Map),this._univerInstanceService=t,this._sheetInterceptorService=e,this._tableManager=n,this._resourceManagerService=r,this._initSnapshot(),this._initSheetChange(),this.registerTableChangeEvent(),this.registerTableHeaderInterceptor()}getContainerTableWithRange(t,e,n){const r=this._ensureTableRangeRTree(t),a=Array.from(r.bulkSearch([{unitId:t,sheetId:e,range:n}])).find(s=>{const i=this._tableManager.getTable(t,String(s));return i?ce.contains(i.getRange(),n):!1});if(a)return this._tableManager.getTable(t,String(a))}_ensureTableRangeRTree(t){return this._tableRangeRTree.has(t)||this._tableRangeRTree.set(t,new Wr),this._tableRangeRTree.get(t)}registerTableChangeEvent(){this.disposeWithMe(this._tableManager.tableAdd$.subscribe(t=>{const{range:e,tableId:n,unitId:r,subUnitId:a}=t;this._ensureTableRangeRTree(r).insert({unitId:r,sheetId:a,id:n,range:{...e}})})),this.disposeWithMe(this._tableManager.tableRangeChanged$.subscribe(t=>{const{range:e,tableId:n,unitId:r,subUnitId:a,oldRange:s}=t,i=this._ensureTableRangeRTree(r);i.remove({unitId:r,sheetId:a,id:n,range:{...s}}),i.insert({unitId:r,sheetId:a,id:n,range:{...e}})})),this.disposeWithMe(this._tableManager.tableDelete$.subscribe(t=>{const{tableId:e,unitId:n,subUnitId:r,range:a}=t;this._ensureTableRangeRTree(n).remove({unitId:n,sheetId:r,id:e,range:{...a}})}))}registerTableHeaderInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(pn.CELL_CONTENT,{effect:Yn.Value,handler:(t,e,n)=>{const{row:r,col:a,unitId:s,subUnitId:i}=e,l=this._ensureTableRangeRTree(s);if((t==null?void 0:t.v)===void 0&&l){const u=Array.from(l.bulkSearch([{unitId:s,sheetId:i,range:{startColumn:a,endColumn:a,startRow:r,endRow:r}}]));if(u.length>0){const o=this._tableManager.getTable(s,u[0]);if(o){const h=o.getRange(),c=a-h.startColumn;if(h.startRow===r){const m=o.getColumnNameByIndex(c);return(!t||t===e.rawData)&&(t={...e.rawData}),t.v=m,n(t)}}}}return n(t)}}))}_toJson(t){return this._tableManager.toJSON(t)}_fromJSON(t,e){return this._tableManager.fromJSON(t,e)}_deleteUnitId(t){this._tableManager.deleteUnitId(t)}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t=>JSON.stringify(this._toJson(t)),parseJson:t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}},businesses:[de.UNIVER_SHEET],pluginName:wr,onLoad:(t,e)=>{this._fromJSON(t,e)},onUnLoad:t=>{this._deleteUnitId(t)}}))}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:t=>{var e;if(t.id===Xr.id){const n=t.params,r=n.unitId||this._univerInstanceService.getCurrentUnitOfType(de.UNIVER_SHEET).getUnitId(),a=n.subUnitId||((e=this._univerInstanceService.getCurrentUnitOfType(de.UNIVER_SHEET).getActiveSheet())==null?void 0:e.getSheetId());if(!r||!a)return{redos:[],undos:[]};const s=this._tableManager.getTablesBySubunitId(r,a);if(s.length===0)return{redos:[],undos:[]};const i=[],l=[];return s.forEach(u=>{const o=u.toJSON();i.push({id:He.id,params:{unitId:r,subUnitId:a,tableId:o.id}}),l.push({id:Ve.id,params:{unitId:r,subUnitId:a,name:o.name,range:o.range,tableId:o.id,options:{...o.options,columns:o.columns,filters:o.filters.tableColumnFilterList}}})}),{redos:i,undos:l}}else if(t.id===Kr.id){const n=t.params,{unitId:r,subUnitId:a,targetSubUnitId:s}=n;if(!r||!a||!s)return{redos:[],undos:[]};const i=this._tableManager.getTablesBySubunitId(r,a);if(i.length===0)return{redos:[],undos:[]};const l=[],u=[];return i.forEach(o=>{const h=o.toJSON(),c=Ne();l.push({id:Ve.id,params:{unitId:r,subUnitId:s,name:h.name,range:{...h.range,sheetId:s},tableId:c,options:{...h.options,columns:h.columns,filters:h.filters.tableColumnFilterList}}}),u.push({id:He.id,params:{unitId:r,subUnitId:s,tableId:c}})}),{redos:l,undos:u}}return{redos:[],undos:[]}}}))}dispose(){super.dispose(),this._tableRangeRTree.clear()}};pe=Ks([Mt(0,I(P)),Mt(1,I(wt)),Mt(2,I(O)),Mt(3,I(Pr))],pe);const E={id:"sheet.mutation.set-sheet-table",type:G.MUTATION,handler:(t,e)=>{if(!e)return!1;const{unitId:n,tableId:r,config:a}=e;return t.get(O).setTableByConfig(n,r,a),!0}},Cn={id:"sheet.command.add-table-theme",type:G.COMMAND,handler:(t,e)=>{if(!e)return!1;const n=t.get(O),{unitId:r,tableId:a,themeStyle:s}=e,i=[],l=[],u=n.getTableById(r,a);if(!u)return!1;const o=u.getSubunitId();i.push({id:Xn.id,params:{unitId:r,subUnitId:o,styleJSON:s.toJson()}}),i.push({id:E.id,params:{unitId:r,subUnitId:o,tableId:a,config:{theme:s.getName()}}}),l.push({id:E.id,params:{unitId:r,subUnitId:o,tableId:a,config:{themeStyle:u.getTableStyleId()}}}),l.push({id:Kn.id,params:{unitId:r,subUnitId:o,styleName:s.getName()}});const h=t.get(H);return _e(i,h)&&t.get(ve).pushUndoRedo({unitID:r,undoMutations:l,redoMutations:i}),!0}},_r={id:"sheet.command.remove-table-theme",type:G.COMMAND,handler:(t,e)=>{if(!e)return!1;const{unitId:n,tableId:r,themeName:a}=e,s=t.get(O),i=t.get(Gt),l=s.getTableById(n,r);if(!l)return!1;const u=l.getSubunitId(),o=[],h=[],c=i.getRegisteredRangeThemes().filter(p=>p==null?void 0:p.startsWith("table-default"));let m=i.getRegisteredRangeThemes().filter(p=>p==null?void 0:p.startsWith(Tr)).find(p=>p!==a);m||(m=c[0]),o.push({id:E.id,params:{unitId:n,subUnitId:u,tableId:r,config:{theme:m}}}),o.push({id:Kn.id,params:{unitId:n,subUnitId:u,styleName:a}});const b=i.getDefaultRangeThemeStyle(a);b&&(h.push({id:Xn.id,params:{unitId:n,subUnitId:u,styleJSON:b.toJson()}}),h.push({id:E.id,params:{unitId:n,subUnitId:u,tableId:r,config:{theme:a}}}));const f=t.get(H);return _e(o,f)&&t.get(ve).pushUndoRedo({unitID:n,redoMutations:o,undoMutations:h}),!0}},Ke={id:"sheet.command.set-table-config",type:G.COMMAND,handler:(t,e)=>{if(!e)return!1;const{unitId:n,tableId:r,name:a,updateRange:s,rowColOperation:i,theme:l}=e,u=t.get(O),o=u.getTableById(n,r);if(!o)return!1;const h={},c={},m=t.get(Q),b=t.get(P).getCurrentUnitOfType(de.UNIVER_SHEET),f=new Set;if(b&&(b.getSheets().forEach(v=>{f.add(v.getName())}),u.getTableList(n).forEach(v=>{f.add(v.name)})),a){if(!Bt(a,f))return t.get(It).warn(m.t("sheets-table.tableNameError")),!1;h.name=o.getDisplayName(),c.name=a}i&&(h.rowColOperation={operationType:i.operationType===W.Insert?W.Delete:W.Insert,rowColType:i.rowColType,index:i.index,count:i.count},c.rowColOperation=i),s&&(h.updateRange={newRange:o.getRange()},c.updateRange=s),l&&(h.theme=o.getTableStyleId(),c.theme=l);const p={unitId:n,subUnitId:o.getSubunitId(),tableId:r,config:c};return t.get(H).executeCommand(E.id,p),t.get(ve).pushUndoRedo({unitID:n,undoMutations:[{id:E.id,params:{unitId:n,subUnitId:o.getSubunitId(),tableId:r,config:h}}],redoMutations:[{id:E.id,params:p}]}),!0}},wn={id:"sheet.command.table-insert-row",type:G.COMMAND,handler:t=>{const e=t.get(P),n=ne(e);if(!n)return!1;const{workbook:r,worksheet:a,unitId:s,subUnitId:i}=n,l=t.get(De).getCurrentSelections();if(!l.length||l.length>1)return!1;t.get(O);const u=l[0].range,o=t.get(pe).getContainerTableWithRange(s,i,u);if(!o)return!1;const h=u.endRow-u.startRow+1,c=a.getRowCount()-1,m=a.getCellMatrix().getDataRange().endRow,b=[],f=[];if(c-m<h)b.push({id:nr.id,params:{unitId:s,subUnitId:i,range:{...u}}}),b.push({id:E.id,params:{unitId:s,subUnitId:i,tableId:o.getId(),config:{updateRange:{newRange:{...o.getRange(),endRow:o.getRange().endRow+h}}}}}),f.push({id:E.id,params:{unitId:s,subUnitId:i,tableId:o.getId(),config:{updateRange:{newRange:o.getRange()}}}}),f.push({id:rr.id,params:{unitId:s,subUnitId:i,range:{...u}}});else{const v={...o.getRange()};b.push({id:E.id,params:{unitId:s,subUnitId:i,tableId:o.getId(),config:{updateRange:{newRange:{...v,endRow:v.endRow+h}}}}}),f.push({id:E.id,params:{unitId:s,subUnitId:i,tableId:o.getId(),config:{updateRange:{newRange:{...v}}}}});const w=zt(t,{unitId:s,subUnitId:i,range:{startRow:u.startRow,endRow:m,startColumn:v.startColumn,endColumn:v.endColumn}},{subUnitId:i,range:{startRow:u.startRow+h,endRow:m+h,startColumn:v.startColumn,endColumn:v.endColumn}});w&&(b.push(...w.redos),f.push(...w.undos))}const p=t.get(H);return _e(b,p)&&t.get(ve).pushUndoRedo({unitID:s,undoMutations:f,redoMutations:b}),!0}},Tn={id:"sheet.command.table-insert-col",type:G.COMMAND,handler:t=>{const e=t.get(P),n=ne(e);if(!n)return!1;const{worksheet:r,unitId:a,subUnitId:s}=n,i=t.get(De).getCurrentSelections();if(!i.length||i.length>1)return!1;const l=i[0].range,u=t.get(pe).getContainerTableWithRange(a,s,l);if(!u)return!1;const o=l.endColumn-l.startColumn+1,h=r.getColumnCount()-1,c=r.getCellMatrix().getDataRange().endColumn,m=[],b=[];if(h-c<o)m.push({id:er.id,params:{unitId:a,subUnitId:s,range:{...l}}}),m.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:W.Insert,rowColType:X.Col,index:l.startColumn,count:o}}}}),b.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:W.Delete,rowColType:X.Col,index:l.startColumn,count:o}}}}),b.push({id:tr.id,params:{unitId:a,subUnitId:s,range:{...l}}});else{const p=u.getRange();m.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:W.Insert,rowColType:X.Col,index:l.startColumn,count:o}}}}),b.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:W.Delete,rowColType:X.Col,index:l.startColumn,count:o}}}});const v=zt(t,{unitId:a,subUnitId:s,range:{startRow:p.startRow,endRow:p.endRow,startColumn:l.startColumn,endColumn:c}},{subUnitId:s,range:{startRow:p.startRow,endRow:p.endRow,startColumn:l.startColumn+o,endColumn:c+o}});v&&(m.push(...v.redos),b.push(...v.undos))}const f=t.get(H);return _e(m,f)&&t.get(ve).pushUndoRedo({unitID:a,undoMutations:b,redoMutations:m}),!0}},_n={id:"sheet.command.table-remove-row",type:G.COMMAND,handler:(t,e)=>{if(!e)return!1;const n=t.get(P),r=ne(n);if(!r)return!1;const{unitId:a,subUnitId:s}=r,i=t.get(De).getCurrentSelections();if(!i.length||i.length>1)return!1;const l=i[0].range,u=t.get(pe).getContainerTableWithRange(a,s,l);if(!u)return!1;const o=l.endRow-l.startRow+1,h=[],c=[],m=u.getRange();h.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{updateRange:{newRange:{...m,endRow:m.endRow-o}}}}}),c.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{updateRange:{newRange:{...m}}}}});const b=r.worksheet.getCellMatrix().getDataRange().endRow,f=zt(t,{unitId:a,subUnitId:s,range:{startRow:l.endRow+1,endRow:b,startColumn:m.startColumn,endColumn:m.endColumn}},{subUnitId:s,range:{startRow:l.startRow,endRow:b-o,startColumn:m.startColumn,endColumn:m.endColumn}});f&&(h.push(...f.redos),c.push(...f.undos));const p=t.get(H);return _e(h,p)&&t.get(ve).pushUndoRedo({unitID:a,undoMutations:c,redoMutations:h}),!0}},Sn={id:"sheet.command.table-remove-col",type:G.COMMAND,handler:(t,e)=>{if(!e)return!1;const n=t.get(P),r=ne(n);if(!r)return!1;const{workbook:a,unitId:s,subUnitId:i}=r;t.get(O);const l=t.get(De).getCurrentSelections();if(!l.length||l.length>1)return!1;const u=l[0].range,o=t.get(pe).getContainerTableWithRange(s,i,u);if(!o)return!1;const h=u.endColumn-u.startColumn+1,c=[],m=[],b=o.getRange();c.push({id:E.id,params:{unitId:s,subUnitId:i,tableId:o.getId(),config:{rowColOperation:{operationType:W.Delete,rowColType:X.Col,index:u.startColumn,count:h}}}});const f=[],p=u.startColumn-b.startColumn;for(let $=0;$<h;$++){const y=o.getTableInfo().columns[p+$];y&&f.push(y)}m.push({id:E.id,params:{unitId:s,subUnitId:i,tableId:o.getId(),config:{rowColOperation:{operationType:W.Insert,rowColType:X.Col,index:u.startColumn,count:h,columnsJson:f}}}});const v=r.worksheet.getCellMatrix().getDataRange().endColumn,w=zt(t,{unitId:s,subUnitId:i,range:{startRow:b.startRow,endRow:b.endRow,startColumn:u.endColumn+1,endColumn:v}},{subUnitId:i,range:{startRow:b.startRow,endRow:b.endRow,startColumn:u.startColumn,endColumn:v-h}});w&&(c.push(...w.redos),m.push(...w.undos));const F=t.get(H);return _e(c,F)&&t.get(ve).pushUndoRedo({unitID:s,undoMutations:m,redoMutations:c}),!0}};var ei=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},An=(t,e)=>(n,r)=>e(n,r,t);let Ht=class extends se{constructor(t,e){super(),this._tableManager=t,this._exclusiveRangeService=e,this._initRangeListener()}_initRangeListener(){this.disposeWithMe(this._tableManager.tableRangeChanged$.subscribe(t=>{const{range:e,tableId:n,unitId:r,subUnitId:a}=t;this._exclusiveRangeService.clearExclusiveRangesByGroupId(r,a,yt,n),this._exclusiveRangeService.addExclusiveRange(r,a,yt,[{range:{...e},groupId:n}])})),this.disposeWithMe(this._tableManager.tableAdd$.subscribe(t=>{const{tableId:e,unitId:n,subUnitId:r,range:a}=t;this._exclusiveRangeService.addExclusiveRange(n,r,yt,[{range:{...a},groupId:e}])})),this.disposeWithMe(this._tableManager.tableDelete$.subscribe(t=>{const{tableId:e,unitId:n,subUnitId:r}=t;this._exclusiveRangeService.clearExclusiveRangesByGroupId(n,r,yt,e)}))}};Ht=ei([An(0,I(O)),An(1,I(aa))],Ht);var ti=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Le=(t,e)=>(n,r)=>e(n,r,t);let At=class extends se{constructor(t,e,n,r,a,s,i){super(),this._commandService=t,this._refRangeService=e,this._univerInstanceService=n,this._injector=r,this._sheetInterceptorService=a,this._tableManager=s,this._localeService=i,this._initCommandInterceptor(),this._initCommandListener()}_initCommandInterceptor(){const t=this;this._sheetInterceptorService.interceptCommand({getMutations(e){const n={redos:[],undos:[]},{id:r,params:a}=e;switch(r){case ra.id:return t._generateTableMutationWithInsertRow(a);case na.id:return t._generateTableMutationWithInsertCol(a);case ta.id:return t._generateTableMutationWithRemoveRow(a);case ea.id:return t._generateTableMutationWithRemoveCol(a)}return n}})}_generateTableMutationWithInsertRow(t){const e=[],n=[],r=ne(this._univerInstanceService);if(!r)return{undos:e,redos:n};const{unitId:a,subUnitId:s}=r,i=this._tableManager.getTablesBySubunitId(a,s);if(!i.length)return{undos:e,redos:n};const{range:l}=t;return i.forEach(u=>{const o=u.getRange();if(l.startRow>o.startRow&&l.startRow<=o.endRow){const h=l.endRow-l.startRow+1;n.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{updateRange:{newRange:{...o,endRow:o.endRow+h}}}}}),e.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{updateRange:{newRange:{...o}}}}})}}),{undos:e,redos:n}}_generateTableMutationWithInsertCol(t){const e=[],n=[],r=ne(this._univerInstanceService);if(!r)return{undos:e,redos:n};const{unitId:a,subUnitId:s}=r,i=this._tableManager.getTablesBySubunitId(a,s);if(!i.length)return{undos:e,redos:n};const{range:l}=t;return i.forEach(u=>{const o=u.getRange();if(l.startColumn>o.startColumn&&l.startColumn<=o.endColumn){const h=l.endColumn-l.startColumn+1;n.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:W.Insert,rowColType:X.Col,index:l.startColumn,count:h}}}}),e.push({id:E.id,params:{unitId:a,subUnitId:s,tableId:u.getId(),config:{rowColOperation:{operationType:W.Delete,rowColType:X.Col,index:l.startColumn,count:h}}}})}}),{undos:e,redos:n}}_generateTableMutationWithRemoveRow(t){const e=[],n=[],r=[],a=[],s=ne(this._univerInstanceService);if(!s)return{undos:e,redos:n,preRedos:r,preUndos:a};const{unitId:i,subUnitId:l}=s,u=this._tableManager.getTablesBySubunitId(i,l);if(!u.length)return{undos:e,redos:n,preRedos:r,preUndos:a};const{range:o}=t,h=o.endRow-o.startRow+1;return u.forEach(c=>{const m=c.getRange();if(ce.intersects(m,o))if(o.startRow<=m.startRow&&o.endRow>=m.startRow){r.push({id:He.id,params:{unitId:i,subUnitId:l,tableId:c.getId()}});const b=c.toJSON();e.push({id:Ve.id,params:{unitId:i,subUnitId:l,tableId:b.id,name:b.name,range:b.range,options:b.options}})}else o.startRow>m.startRow&&o.startRow<=m.endRow?(n.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{updateRange:{newRange:{...m,endRow:m.endRow-h}}}}}),e.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{updateRange:{newRange:{...m}}}}})):o.startRow<m.endRow&&o.endRow>=m.endRow&&(n.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{updateRange:{newRange:{...m,endRow:o.startRow-1}}}}}),e.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{updateRange:{newRange:{...m}}}}}))}),{undos:e,redos:n,preRedos:r,preUndos:a}}_generateTableMutationWithRemoveCol(t){const e=[],n=[],r=[],a=[],s=ne(this._univerInstanceService);if(!s)return{undos:e,redos:n,preRedos:r,preUndos:a};const{unitId:i,subUnitId:l}=s,u=this._tableManager.getTablesBySubunitId(i,l);if(!u.length)return{undos:e,redos:n,preRedos:r,preUndos:a};const{range:o}=t,h=o.endColumn-o.startColumn+1;return u.forEach(c=>{const m=c.getRange();if(ce.intersects(m,o)){if(o.startColumn<=m.startColumn&&o.endColumn>=m.endColumn){r.push({id:He.id,params:{unitId:i,subUnitId:l,tableId:c.getId()}});const b=c.toJSON(),{startRow:f,startColumn:p,endColumn:v}=b.range,w=this._univerInstanceService.getUnit(i),F=w==null?void 0:w.getSheetBySheetId(l);if(!F)return{undos:e,redos:n,preRedos:r,preUndos:a};const $=[];for(let y=p;y<=v;y++)$.push(br(F==null?void 0:F.getCell(f,y))||pt(y-p+1,this._localeService.t("sheets-table.columnPrefix")));e.push({id:Ve.id,params:{unitId:i,subUnitId:l,tableId:b.id,name:b.name,header:$,range:b.range,options:b.options}})}else if(o.startColumn<=m.startColumn&&o.endColumn>=m.startColumn){const b=o.endColumn-m.startColumn+1;n.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{rowColOperation:{operationType:W.Delete,rowColType:X.Col,index:m.startColumn,count:b}}}});const f=[];for(let p=0;p<b;p++){const v=c.getTableColumnByIndex(p);v&&f.push(v.toJSON())}e.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{rowColOperation:{operationType:W.Insert,rowColType:X.Col,index:m.startColumn,count:b,columnsJson:f}}}})}else if(o.startColumn>m.startColumn&&o.endColumn>m.endColumn){const b=m.endColumn-o.startColumn+1;n.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{rowColOperation:{operationType:W.Delete,rowColType:X.Col,index:o.startColumn,count:b}}}});const f=[],p=o.startColumn-m.startColumn;for(let v=0;v<b;v++){const w=c.getTableColumnByIndex(v+p);w&&f.push(w.toJSON())}e.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{rowColOperation:{operationType:W.Insert,rowColType:X.Col,index:o.startColumn,count:h,columnsJson:f}}}})}else if(o.startColumn>m.startColumn&&o.endColumn<=m.endColumn){n.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{rowColOperation:{operationType:W.Delete,rowColType:X.Col,index:o.startColumn,count:h}}}});const b=[],f=o.startColumn-m.startColumn;for(let p=0;p<h;p++){const v=c.getTableColumnByIndex(p+f);v&&b.push(v.toJSON())}e.push({id:E.id,params:{unitId:i,subUnitId:l,tableId:c.getId(),config:{rowColOperation:{operationType:W.Insert,rowColType:X.Col,index:o.startColumn,count:h,columnsJson:b}}}})}}}),{undos:e,redos:n,preRedos:r,preUndos:a}}_initCommandListener(){this._commandService.onCommandExecuted(t=>{if(t.id===nr.id){const e=t.params,{unitId:n,subUnitId:r,range:a}=e,s=a.endRow-a.startRow+1;this._tableManager.getTablesBySubunitId(n,r).forEach(i=>{const l=i.getRange();a.startRow<=l.startRow&&this._tableManager.updateTableRange(n,i.getId(),{newRange:{...l,startRow:l.startRow+s,endRow:l.endRow+s}})})}else if(t.id===er.id){const e=t.params,{unitId:n,subUnitId:r,range:a}=e,s=a.endColumn-a.startColumn+1;this._tableManager.getTablesBySubunitId(n,r).forEach(i=>{const l=i.getRange();a.startColumn<=l.startColumn&&this._tableManager.updateTableRange(n,i.getId(),{newRange:{...l,startColumn:l.startColumn+s,endColumn:l.endColumn+s}})})}else if(t.id===rr.id){const e=t.params,{unitId:n,subUnitId:r,range:a}=e,s=a.endRow-a.startRow+1;this._tableManager.getTablesBySubunitId(n,r).forEach(i=>{const l=i.getRange();a.startRow<l.startRow&&this._tableManager.updateTableRange(n,i.getId(),{newRange:{...l,startRow:l.startRow-s,endRow:l.endRow-s}})})}else if(t.id===tr.id){const e=t.params,{unitId:n,subUnitId:r,range:a}=e,s=a.endColumn-a.startColumn+1;this._tableManager.getTablesBySubunitId(n,r).forEach(i=>{const l=i.getRange();a.startColumn<l.startColumn&&this._tableManager.updateTableRange(n,i.getId(),{newRange:{...l,startColumn:l.startColumn-s,endColumn:l.endColumn-s}})})}})}};At=ti([Le(0,I(H)),Le(1,I(sa)),Le(2,I(P)),Le(3,I(Fe)),Le(4,I(wt)),Le(5,I(O)),Le(6,I(Q))],At);var ni=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Nt=(t,e)=>(n,r)=>e(n,r,t);let Wt=class extends se{constructor(t,e,n,r){super(),_(this,"_defaultThemeIndex",0),_(this,"_allThemes",[]),this._tableManager=t,this._sheetRangeThemeService=e,this._sheetRangeThemeModel=n,this._configService=r,this._initUserTableTheme(),this.registerTableChangeEvent(),this._initDefaultTableTheme()}registerTableChangeEvent(){this.disposeWithMe(this._tableManager.tableAdd$.subscribe(t=>{const{range:e,tableId:n,unitId:r,subUnitId:a,tableStyleId:s}=t,i=this._tableManager.getTable(r,n),l=s||this._allThemes[this._defaultThemeIndex].name;i.setTableStyleId(l),this._sheetRangeThemeService.registerRangeThemeStyle(l,{unitId:r,subUnitId:a,range:{...e}})})),this.disposeWithMe(this._tableManager.tableRangeChanged$.subscribe(t=>{const{range:e,oldRange:n,tableId:r,unitId:a,subUnitId:s}=t,i=this._tableManager.getTable(a,r);let l=i.getTableStyleId();l||(l=this._allThemes[this._defaultThemeIndex].name,i.setTableStyleId(l)),this._sheetRangeThemeService.removeRangeThemeRule(l,{unitId:a,subUnitId:s,range:{...n}}),this._sheetRangeThemeService.registerRangeThemeStyle(l,{unitId:a,subUnitId:s,range:{...e}})})),this.disposeWithMe(this._tableManager.tableThemeChanged$.subscribe(t=>{const{theme:e,oldTheme:n,tableId:r,unitId:a,subUnitId:s}=t,i=this._tableManager.getTable(a,r).getRange();this._sheetRangeThemeService.removeRangeThemeRule(n,{unitId:a,subUnitId:s,range:{...i}}),this._sheetRangeThemeService.registerRangeThemeStyle(e,{unitId:a,subUnitId:s,range:{...i}})})),this.disposeWithMe(this._tableManager.tableDelete$.subscribe(t=>{const{range:e,unitId:n,subUnitId:r,tableStyleId:a=this._allThemes[this._defaultThemeIndex].name}=t;this._sheetRangeThemeService.removeRangeThemeRule(a,{unitId:n,subUnitId:r,range:{...e}})}))}_initUserTableTheme(){const t=this._configService.getConfig(vr)||{},e=t.defaultThemeIndex||0,n=t.userThemes||[];this._defaultThemeIndex=e,this._allThemes=n.concat(fr)}_initDefaultTableTheme(){for(let t=0;t<this._allThemes.length;t++){const{name:e,style:n}=this._allThemes[t],r=new vn(e,n);this._sheetRangeThemeModel.registerDefaultRangeTheme(r)}}dispose(){super.dispose(),this._allThemes=[],this._defaultThemeIndex=0}};Wt=ni([Nt(0,I(O)),Nt(1,I(ia)),Nt(2,I(Gt)),Nt(3,Qt)],Wt);var ri=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},$t=(t,e)=>(n,r)=>e(n,r,t);let Pt=class extends se{constructor(e,n,r,a){super(),_(this,"_tableFilteredOutRows$",new Vt(new Set)),_(this,"tableFilteredOutRows$",this._tableFilteredOutRows$.asObservable()),_(this,"_subscription",null),this._tableManager=e,this._sheetInterceptorService=n,this._univerInstanceService=r,this._zebraCrossingCacheController=a,this.registerFilterChangeEvent(),this.initTableHiddenRowIntercept(),this._initFilteredOutRows()}get tableFilteredOutRows(){return this._tableFilteredOutRows$.value}set tableFilteredOutRows(e){this._tableFilteredOutRows$.next(e)}initTableHiddenRowIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(pn.ROW_FILTERED,{priority:100,handler:(e,n,r)=>{if(e)return!0;const a=this.tableFilteredOutRows.has(n.row);return a?!0:r(a)}}))}_initFilteredOutRows(){this._tableManager.tableInitStatus$.pipe(Ot(e=>e),Te(()=>this._univerInstanceService.getCurrentTypeOfUnit$(de.UNIVER_SHEET)),Ot(e=>e!=null),Te(e=>e.activeSheet$),Ot(e=>e!=null)).subscribe(()=>{const e=ne(this._univerInstanceService);if(!e)return;const{unitId:n,subUnitId:r}=e;this.tableFilteredOutRows.clear(),this._tableManager.getTablesBySubunitId(n,r).forEach(a=>{const s=a.getTableFilters().getFilterOutRows();if(s)for(const i of s)this.tableFilteredOutRows.add(i)})})}registerFilterChangeEvent(){this.disposeWithMe(this._tableManager.tableFilterChanged$.subscribe(e=>{var n;const{unitId:r,subUnitId:a,tableId:s}=e,i=(n=this._univerInstanceService.getUnit(r))==null?void 0:n.getSheetBySheetId(a),l=this._tableManager.getTable(r,s);!i||!l||(this.tableFilteredOutRows.clear(),l.getTableFilters().doFilter(i,l.getTableFilterRange()),this._tableManager.getTablesBySubunitId(r,a).forEach(u=>{const o=u.getTableFilters().getFilterOutRows();if(o)for(const h of o)this.tableFilteredOutRows.add(h)}),this._zebraCrossingCacheController.updateZebraCrossingCache(r,a))}))}dispose(){var e;super.dispose(),(e=this._subscription)==null||e.unsubscribe()}};Pt=ri([$t(0,I(O)),$t(1,I(wt)),$t(2,I(P)),$t(3,I(la))],Pt);var ai=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},nn=(t,e)=>(n,r)=>e(n,r,t),Et;let qt=(Et=class extends Zn{constructor(t=On,e,n,r){super(),this._config=t,this._injector=e,this._configService=n,this._commandService=r;const{...a}=Jn({},On,this._config);this._configService.setConfig(vr,a),this._initRegisterCommand()}onStarting(){Qn(this._injector,[[O],[Wt],[pe],[he],[Pt],[Ht],[At]]),ln(this._injector,[[Ht],[At],[Wt],[pe],[he],[Pt]])}onReady(){ln(this._injector,[[O]])}_initRegisterCommand(){[Kt,Ve,en,He,on,Xe,Ke,E,Cn,_r,wn,Tn,_n,Sn].forEach(t=>this._commandService.registerCommand(t))}},_(Et,"pluginName",wr),_(Et,"type",de.UNIVER_SHEET),Et);qt=ai([nn(1,I(Fe)),nn(2,Qt),nn(3,I(H))],qt);var si=Object.defineProperty,ii=(t,e,n)=>e in t?si(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,K=(t,e,n)=>ii(t,typeof e!="symbol"?e+"":e,n);const li="SHEET_TABLE_UI_PLUGIN",Me="SHEETS_TABLE_FILTER_PANEL_OPENED_KEY",oi="UNIVER_SHEET_Table_FILTER_PANEL_ID",Sr="TABLE_TOOLBAR_BUTTON",Je="TABLE_SELECTOR_DIALOG",ui="SHEET_TABLE_THEME_PANEL_ID",xr="SHEET_TABLE_THEME_PANEL",rn="table-custom-",di="table-default-",ye="rgb(255, 255, 255)",oe="none",Ft="1px solid rgb(var(--grey-200))";function fe({ref:t,...e}){const{icon:n,id:r,className:a,extend:s,...i}=e,l=`univerjs-icon univerjs-icon-${r} ${a||""}`.trim(),u=x.useRef(`_${gi()}`);return Rr(n,`${r}`,{defIds:n.defIds,idSuffix:u.current},{ref:t,className:l,...i},s)}function Rr(t,e,n,r,a){return x.createElement(t.tag,{key:e,...ci(t,n,a),...r},(hi(t,n).children||[]).map((s,i)=>Rr(s,`${e}-${t.tag}-${i}`,n,void 0,a)))}function ci(t,e,n){const r={...t.attrs};n!=null&&n.colorChannel1&&r.fill==="colorChannel1"&&(r.fill=n.colorChannel1),t.tag==="mask"&&r.id&&(r.id=r.id+e.idSuffix),Object.entries(r).forEach(([s,i])=>{s==="mask"&&typeof i=="string"&&(r[s]=i.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))});const{defIds:a}=e;return!a||a.length===0||(t.tag==="use"&&r["xlink:href"]&&(r["xlink:href"]=r["xlink:href"]+e.idSuffix),Object.entries(r).forEach(([s,i])=>{typeof i=="string"&&(r[s]=i.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))})),r}function hi(t,e){var n;const{defIds:r}=e;return!r||r.length===0?t:t.tag==="defs"&&(n=t.children)!=null&&n.length?{...t,children:t.children.map(a=>typeof a.attrs.id=="string"&&r&&r.includes(a.attrs.id)?{...a,attrs:{...a.attrs,id:a.attrs.id+e.idSuffix}}:a)}:t}function gi(){return Math.random().toString(36).substring(2,8)}fe.displayName="UniverIcon";const mi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.4208 14.4667C12.4208 14.798 12.1522 15.0667 11.8208 15.0667C11.4895 15.0667 11.2208 14.798 11.2208 14.4667V2.98193L9.97861 4.22417C9.7443 4.45848 9.3644 4.45848 9.13008 4.22417C8.89577 3.98985 8.89577 3.60995 9.13008 3.37564L11.3967 1.10897C11.6311 0.874657 12.011 0.874657 12.2453 1.10897L14.5119 3.37564C14.7463 3.60995 14.7463 3.98985 14.5119 4.22417C14.2776 4.45848 13.8977 4.45848 13.6634 4.22417L12.4208 2.9816V14.4667Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.98967 10.2798C1.6583 10.2798 1.38967 10.0112 1.38967 9.67983C1.38967 9.34846 1.6583 9.07983 1.98967 9.07983H6.50138C6.74406 9.07983 6.96284 9.22602 7.05571 9.45022C7.14858 9.67443 7.09725 9.9325 6.92565 10.1041L3.43819 13.5916H6.50138C6.83276 13.5916 7.10138 13.8602 7.10138 14.1916C7.10138 14.5229 6.83276 14.7916 6.50138 14.7916H1.98967C1.74699 14.7916 1.52821 14.6454 1.43534 14.4212C1.34247 14.197 1.3938 13.9389 1.5654 13.7673L5.05286 10.2798H1.98967Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.1846 1.86439C4.8641 0.989866 3.62725 0.989866 3.30674 1.86439L1.34882 7.20672C1.23479 7.51786 1.39458 7.86252 1.70571 7.97655C2.01684 8.09058 2.3615 7.93079 2.47553 7.61966L3.06159 6.02055L3.06338 6.02056H5.42975L6.01581 7.61966C6.12984 7.93079 6.4745 8.09058 6.78563 7.97655C7.09677 7.86252 7.25655 7.51786 7.14252 7.20672L5.1846 1.86439ZM4.98996 4.82056L4.24567 2.78971L3.50138 4.82056H4.98996Z",fillRule:"evenodd",clipRule:"evenodd"}}]},yr=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"ascending-icon",ref:e,icon:mi}))});yr.displayName="AscendingIcon";const bi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993 0.866699 5.9313 0.866699H10.069C10.4004 0.866699 10.669 1.13533 10.669 1.4667C10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443C14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928L9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171C10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778L9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539C9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263L6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539C5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778L6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Mr=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"delete-icon",ref:e,icon:bi}))});Mr.displayName="DeleteIcon";const pi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.4208 1.53335C12.4208 1.20198 12.1522 0.93335 11.8208 0.93335C11.4895 0.93335 11.2208 1.20198 11.2208 1.53335V13.0181L9.97861 11.7758C9.7443 11.5415 9.3644 11.5415 9.13008 11.7758C8.89577 12.0101 8.89577 12.39 9.13008 12.6244L11.3967 14.891C11.6311 15.1253 12.011 15.1253 12.2453 14.891L14.5119 12.6244C14.7463 12.39 14.7463 12.0101 14.5119 11.7758C14.2776 11.5415 13.8977 11.5415 13.6634 11.7758L12.4208 13.0184V1.53335Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.98967 10.2798C1.6583 10.2798 1.38967 10.0112 1.38967 9.67983C1.38967 9.34846 1.6583 9.07983 1.98967 9.07983H6.50138C6.74406 9.07983 6.96284 9.22602 7.05571 9.45022C7.14858 9.67443 7.09725 9.9325 6.92565 10.1041L3.43819 13.5916H6.50138C6.83276 13.5916 7.10138 13.8602 7.10138 14.1916C7.10138 14.5229 6.83276 14.7916 6.50138 14.7916H1.98967C1.74699 14.7916 1.52821 14.6454 1.43534 14.4212C1.34247 14.197 1.3938 13.9389 1.5654 13.7673L5.05286 10.2798H1.98967Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.1846 1.86439C4.8641 0.989866 3.62725 0.989866 3.30674 1.86439L1.34882 7.20672C1.23479 7.51786 1.39458 7.86252 1.70571 7.97655C2.01684 8.09058 2.3615 7.93079 2.47553 7.61966L3.06159 6.02055L3.06338 6.02056H5.42975L6.01581 7.61966C6.12984 7.93079 6.4745 8.09058 6.78563 7.97655C7.09677 7.86252 7.25655 7.51786 7.14252 7.20672L5.1846 1.86439ZM4.98996 4.82056L4.24567 2.78971L3.50138 4.82056H4.98996Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Nr=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"descending-icon",ref:e,icon:pi}))});Nr.displayName="DescendingIcon";const vi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.85869 12.9216C8.38445 13.4708 7.61555 13.4708 7.14131 12.9216L0.358114 5.06726C-0.406895 4.18144 0.134916 2.66683 1.2168 2.66683L14.7832 2.66683C15.8651 2.66683 16.4069 4.18144 15.6419 5.06726L8.85869 12.9216Z"}}]},vt=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"dropdown-icon",ref:e,icon:vi}))});vt.displayName="DropdownIcon";const fi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.33333 3.33333V6H6V3.33333H3.33333ZM2 3.238C2 2.55427 2.55427 2 3.238 2H6.09533C6.77906 2 7.33333 2.55427 7.33333 3.238V6.09533C7.33333 6.77906 6.77906 7.33333 6.09533 7.33333H3.238C2.55427 7.33333 2 6.77906 2 6.09533V3.238ZM10 3.33333V6H12.6667V3.33333H10ZM8.66667 3.238C8.66667 2.55427 9.22094 2 9.90467 2H12.762C13.4457 2 14 2.55427 14 3.238V6.09533C14 6.77906 13.4457 7.33333 12.762 7.33333H9.90467C9.22094 7.33333 8.66667 6.77906 8.66667 6.09533V3.238ZM3.33333 10V12.6667H6V10H3.33333ZM2 9.90467C2 9.22094 2.55427 8.66667 3.238 8.66667H6.09533C6.77906 8.66667 7.33333 9.22094 7.33333 9.90467V12.762C7.33333 13.4457 6.77906 14 6.09533 14H3.238C2.55427 14 2 13.4457 2 12.762V9.90467ZM10 10V12.6667H12.6667V10H10ZM8.66667 9.90467C8.66667 9.22094 9.22094 8.66667 9.90467 8.66667H12.762C13.4457 8.66667 14 9.22094 14 9.90467V12.762C14 13.4457 13.4457 14 12.762 14H9.90467C9.22094 14 8.66667 13.4457 8.66667 12.762V9.90467Z",fillRule:"evenodd",clipRule:"evenodd"}}]},$r=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"grid-outline-icon",ref:e,icon:fi}))});$r.displayName="GridOutlineIcon";const Ii={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},xn=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"more-down-icon",ref:e,icon:Ii}))});xn.displayName="MoreDownIcon";const Ci={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.80068 2.57257L7.27955 2.57256C7.61092 2.57256 7.87954 2.30393 7.87954 1.97256C7.87954 1.64119 7.61091 1.37256 7.27954 1.37256L3.80068 1.37257C2.36473 1.37257 1.20067 2.53665 1.20068 3.97259L1.20074 12.3001C1.20075 13.736 2.36481 14.9 3.80074 14.9H12.1282C13.5641 14.9 14.7282 13.736 14.7282 12.3V8.82116C14.7282 8.48979 14.4595 8.22116 14.1282 8.22116C13.7968 8.22116 13.5282 8.48979 13.5282 8.82116V12.3C13.5282 13.0732 12.9014 13.7 12.1282 13.7H3.80074C3.02754 13.7 2.40074 13.0732 2.40074 12.3001L2.40068 3.97258C2.40068 3.19938 3.02748 2.57257 3.80068 2.57257Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.0072 2.0955C13.0997 1.18757 11.6278 1.18794 10.7207 2.09632L6.17749 6.646C6.10294 6.72065 6.04543 6.81056 6.00889 6.90954L4.59817 10.7315C4.51713 10.951 4.57116 11.1977 4.73657 11.3633C4.90198 11.5288 5.14858 11.5831 5.36823 11.5023L9.20237 10.0916C9.30186 10.055 9.3922 9.99722 9.46714 9.92224L14.0073 5.37972C14.9139 4.47266 14.9138 3.00252 14.0072 2.0955ZM11.5698 2.94424C12.0083 2.50513 12.7198 2.50496 13.1585 2.94384C13.5968 3.38229 13.5968 4.09294 13.1585 4.53141L8.69127 9.00102L6.1742 9.92713L7.09912 7.42132L11.5698 2.94424Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Er=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"rename-icon",ref:e,icon:Ci}))});Er.displayName="RenameIcon";const wi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.7643 4.13354C1.7643 2.82523 2.82488 1.76465 4.13319 1.76465H11.8665C13.1748 1.76465 14.2354 2.82524 14.2354 4.13354V11.8669C14.2354 13.1752 13.1748 14.2358 11.8665 14.2358H4.13318C2.82488 14.2358 1.7643 13.1752 1.7643 11.8669V6.1462C1.76388 6.13711 1.76367 6.12797 1.76367 6.11878C1.76367 6.10959 1.76388 6.10045 1.7643 6.09136V4.13354ZM2.94652 6.70989V11.8669C2.94652 12.5222 3.47781 13.0535 4.13318 13.0535H5.52732V6.70989H2.94652ZM5.52732 5.52767H2.94652V4.13354C2.94652 3.47816 3.47781 2.94687 4.13319 2.94687H5.52732V5.52767ZM6.70954 6.70989V13.0535H11.8665C12.5219 13.0535 13.0532 12.5222 13.0532 11.8669V6.70989L6.70954 6.70989ZM13.0532 5.52767L6.70954 5.52767V2.94687H11.8665C12.5219 2.94687 13.0532 3.47816 13.0532 4.13354V5.52767Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Fr=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"table-icon",ref:e,icon:wi}))});Fr.displayName="TableIcon";const Ti={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.01281 1.36643C8.79386 0.585377 10.0602 0.585378 10.8412 1.36643L12.9223 3.44752C13.7034 4.22857 13.7034 5.4949 12.9223 6.27595L9.36445 9.83383C8.5834 10.6149 7.31707 10.6149 6.53602 9.83383L4.45493 7.75273C3.67388 6.97168 3.67388 5.70535 4.45493 4.9243L8.01281 1.36643ZM9.9927 2.21495C9.68028 1.90253 9.17375 1.90253 8.86133 2.21495L5.30346 5.77283L5.29671 5.77966L10.839 6.66224L12.0738 5.42742C12.3862 5.115 12.3862 4.60847 12.0738 4.29605L9.9927 2.21495Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.5179 9.48875C14.5179 9.99175 14.1101 10.3995 13.607 10.3995C13.1041 10.3995 12.6963 9.99175 12.6963 9.48875C12.6963 9.1773 13.0455 8.59966 13.3114 8.20487C13.4549 7.99177 13.7591 7.99177 13.9027 8.20486C14.1687 8.59965 14.5179 9.1773 14.5179 9.48875Z"}},{tag:"path",attrs:{fill:"colorChannel1",d:"M1.98682 13.4992C1.98682 12.5603 2.74793 11.7992 3.68682 11.7992H14.2868C15.2257 11.7992 15.9868 12.5603 15.9868 13.4992V13.4992C15.9868 14.4381 15.2257 15.1992 14.2868 15.1992H3.68682C2.74793 15.1992 1.98682 14.4381 1.98682 13.4992V13.4992Z"}}]},Dr=x.forwardRef(function(t,e){return x.createElement(fe,Object.assign({},t,{id:"paint-bucket-double-icon",ref:e,icon:Ti}))});Dr.displayName="PaintBucketDoubleIcon";var $e=(t=>(t.Items="items",t.Condition="condition",t))($e||{}),_i=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},mt=(t,e)=>(n,r)=>e(n,r,t);let et=class extends se{constructor(t,e,n,r,a){super(),K(this,"_itemsCache",new Map),this._tableManager=t,this._sheetTableService=e,this._univerInstanceService=n,this._commandService=r,this._localeService=a,this._registerTableFilterChangeEvent()}_registerTableFilterChangeEvent(){this._commandService.onCommandExecuted(t=>{if(t.id===oa.id){const{unitId:e,subUnitId:n,cellValue:r}=t.params,a=this._tableManager.getTablesBySubunitId(e,n);if(!a.length)return;new Yr(r).forValue((s,i,l)=>{const u=gn(s,i),o=a.find(h=>{const c=h.getTableFilterRange();return ce.intersects(c,u)});if(o){const h=i-o.getRange().startColumn;this._itemsCache.delete(o.getId()+h)}})}else if(t.id===Xe.id){const{unitId:e,tableId:n}=t.params,r=this._tableManager.getTable(e,n);if(!r)return;const a=r.getSubunitId();this._tableManager.getTablesBySubunitId(e,a).forEach(s=>{const i=s.getRange();for(let l=i.startColumn;l<=i.endColumn;l++)this._itemsCache.delete(s.getId()+l)})}})}getTableFilterPanelInitProps(t,e,n,r){const a=this._tableManager.getTable(t,n),s=a.getRange(),i=a.getTableFilterColumn(r-s.startColumn);return{unitId:t,subUnitId:e,tableFilter:i,currentFilterBy:pr(i)?$e.Condition:$e.Items,tableId:n,columnIndex:r-s.startColumn}}getTableFilterCheckedItems(t,e,n){const r=this._tableManager.getTable(t,e),a=[];if(r){const s=r.getTableFilterColumn(n);s&&Ja(s)&&a.push(...s.values)}return a}setTableFilter(t,e,n,r){if(!this._tableManager.getTable(t,e))return;const a={unitId:t,tableId:e,column:n,tableFilter:r};this._commandService.executeCommand(Xe.id,a)}getTableFilterItems(t,e,n,r){var a;if(this._itemsCache.has(n+r))return this._itemsCache.get(n+r)||{data:[],itemsCountMap:new Map,allItemsCount:0};const s=this._tableManager.getTable(t,n);if(!s)return{data:[],itemsCountMap:new Map,allItemsCount:0};const i=s.getTableFilterRange(),{startRow:l,endRow:u,startColumn:o}=i,h=o+r,c=(a=this._univerInstanceService.getUnit(t))==null?void 0:a.getSheetBySheetId(e);if(!c)return{data:[],itemsCountMap:new Map,allItemsCount:0};const m=[],b=new Map;let f=0;for(let p=l;p<=u;p++){if(c.isRowFiltered(p))continue;let v=this._sheetTableService.getCellValueWithConditionType(c,p,h);v===void 0&&(v=this._localeService.t("sheets-table.condition.empty")),b.has(v)||m.push({title:v,key:`${h}_${p}`,leaf:!0}),f++,b.set(v,(b.get(v)||0)+1)}return this._itemsCache.set(n+r,{data:m,itemsCountMap:b,allItemsCount:f}),{data:m,itemsCountMap:b,allItemsCount:f}}};et=_i([mt(0,I(O)),mt(1,I(he)),mt(2,I(P)),mt(3,H),mt(4,I(Q))],et);var z=(t=>(t.DatePicker="DatePicker",t.DateRange="DateRange",t.Input="Input",t.Inputs="Inputs",t.Select="Select",t.None="None",t))(z||{});function Si(t){const e=t.get(Q).t;return[{value:L.String,label:e(`sheets-table.condition.${L.String}`),children:[{value:k.Equal,label:e(`sheets-table.string.compare.${k.Equal}`)},{value:k.NotEqual,label:e(`sheets-table.string.compare.${k.NotEqual}`)},{value:k.Contains,label:e(`sheets-table.string.compare.${k.Contains}`)},{value:k.NotContains,label:e(`sheets-table.string.compare.${k.NotContains}`)},{value:k.StartsWith,label:e(`sheets-table.string.compare.${k.StartsWith}`)},{value:k.EndsWith,label:e(`sheets-table.string.compare.${k.EndsWith}`)}]},{value:L.Number,label:e(`sheets-table.condition.${L.Number}`),children:[{value:R.Equal,label:e(`sheets-table.number.compare.${R.Equal}`)},{value:R.NotEqual,label:e(`sheets-table.number.compare.${R.NotEqual}`)},{value:R.GreaterThan,label:e(`sheets-table.number.compare.${R.GreaterThan}`)},{value:R.GreaterThanOrEqual,label:e(`sheets-table.number.compare.${R.GreaterThanOrEqual}`)},{value:R.LessThan,label:e(`sheets-table.number.compare.${R.LessThan}`)},{value:R.LessThanOrEqual,label:e(`sheets-table.number.compare.${R.LessThanOrEqual}`)},{value:R.Between,label:e(`sheets-table.number.compare.${R.Between}`)},{value:R.NotBetween,label:e(`sheets-table.number.compare.${R.NotBetween}`)},{value:R.Above,label:e(`sheets-table.number.compare.${R.Above}`)},{value:R.Below,label:e(`sheets-table.number.compare.${R.Below}`)}]},{value:L.Date,label:e(`sheets-table.condition.${L.Date}`),children:[{value:d.Equal,label:e(`sheets-table.date.compare.${d.Equal}`)},{value:d.NotEqual,label:e(`sheets-table.date.compare.${d.NotEqual}`)},{value:d.After,label:e(`sheets-table.date.compare.${d.After}`)},{value:d.AfterOrEqual,label:e(`sheets-table.date.compare.${d.AfterOrEqual}`)},{value:d.Before,label:e(`sheets-table.date.compare.${d.Before}`)},{value:d.BeforeOrEqual,label:e(`sheets-table.date.compare.${d.BeforeOrEqual}`)},{value:d.Between,label:e(`sheets-table.date.compare.${d.Between}`)},{value:d.NotBetween,label:e(`sheets-table.date.compare.${d.NotBetween}`)},{value:d.Today,label:e(`sheets-table.date.compare.${d.Today}`)},{value:d.Yesterday,label:e(`sheets-table.date.compare.${d.Yesterday}`)},{value:d.Tomorrow,label:e(`sheets-table.date.compare.${d.Tomorrow}`)},{value:d.ThisWeek,label:e(`sheets-table.date.compare.${d.ThisWeek}`)},{value:d.LastWeek,label:e(`sheets-table.date.compare.${d.LastWeek}`)},{value:d.NextWeek,label:e(`sheets-table.date.compare.${d.NextWeek}`)},{value:d.ThisMonth,label:e(`sheets-table.date.compare.${d.ThisMonth}`)},{value:d.LastMonth,label:e(`sheets-table.date.compare.${d.LastMonth}`)},{value:d.NextMonth,label:e(`sheets-table.date.compare.${d.NextMonth}`)},{value:d.ThisYear,label:e(`sheets-table.date.compare.${d.ThisYear}`)},{value:d.LastYear,label:e(`sheets-table.date.compare.${d.LastYear}`)},{value:d.NextYear,label:e(`sheets-table.date.compare.${d.NextYear}`)},{value:d.Quarter,label:e(`sheets-table.date.compare.${d.Quarter}`)},{value:d.Month,label:e(`sheets-table.date.compare.${d.Month}`)}]}]}function xi(t,e){if(!e)return[];const n=t.get(Q).t;switch(e){case d.Quarter:return[{value:d.Q1,label:n(`sheets-table.date.compare.${d.Q1}`)},{value:d.Q2,label:n(`sheets-table.date.compare.${d.Q2}`)},{value:d.Q3,label:n(`sheets-table.date.compare.${d.Q3}`)},{value:d.Q4,label:n(`sheets-table.date.compare.${d.Q4}`)}];case d.Month:return[{value:d.M1,label:n(`sheets-table.date.compare.${d.M1}`)},{value:d.M2,label:n(`sheets-table.date.compare.${d.M2}`)},{value:d.M3,label:n(`sheets-table.date.compare.${d.M3}`)},{value:d.M4,label:n(`sheets-table.date.compare.${d.M4}`)},{value:d.M5,label:n(`sheets-table.date.compare.${d.M5}`)},{value:d.M6,label:n(`sheets-table.date.compare.${d.M6}`)},{value:d.M7,label:n(`sheets-table.date.compare.${d.M7}`)},{value:d.M8,label:n(`sheets-table.date.compare.${d.M8}`)},{value:d.M9,label:n(`sheets-table.date.compare.${d.M9}`)},{value:d.M10,label:n(`sheets-table.date.compare.${d.M10}`)},{value:d.M11,label:n(`sheets-table.date.compare.${d.M11}`)},{value:d.M12,label:n(`sheets-table.date.compare.${d.M12}`)}];default:return[]}}const Rn=new Set([d.Equal,d.NotEqual,d.After,d.AfterOrEqual,d.Before,d.BeforeOrEqual]);function Ri(t,e){return e?t===L.String?z.Input:t===L.Number?e===R.Between||e===R.NotBetween?z.Inputs:z.Input:t===L.Date?e===d.Between||e===d.NotBetween?z.DateRange:e===d.Quarter||e===d.Month?z.Select:Rn.has(e)?z.DatePicker:z.None:z.None:z.None}function yi(t){if(!t||t.filterType!=="condition")return{type:L.String,compareType:k.Equal,info:{}};const e=t.filterInfo,{conditionType:n,compareType:r}=e;if(n===L.Date)if(r===d.Between||r===d.NotBetween){let a;return Array.isArray(e.expectedValue)&&(a=e.expectedValue.map(s=>typeof s=="string"?new Date(s):s)),{type:n,compare:r,info:{dateRange:a}}}else{if(r===d.Today||r===d.Yesterday||r===d.Tomorrow||r===d.ThisWeek||r===d.LastWeek||r===d.NextWeek||r===d.ThisMonth||r===d.LastMonth||r===d.NextMonth||r===d.ThisYear||r===d.LastYear||r===d.NextYear)return{type:n,compare:r,info:{}};if(Rn.has(r)){let a;if(typeof e.expectedValue=="string")a=new Date(e.expectedValue);else if(Array.isArray(e.expectedValue))for(let s=0;s<e.expectedValue.length;s++)typeof e.expectedValue[s]=="string"&&(e.expectedValue[s]=new Date(e.expectedValue[s]));return{type:n,compare:r,info:{date:a}}}else return new Set([d.Q1,d.Q2,d.Q3,d.Q4]).has(r)?{type:n,compare:d.Quarter,info:{dateSelect:e.compareType}}:{type:n,compare:d.Month,info:{dateSelect:e.compareType}}}else{if(n===L.Number)return r===R.Between||r===R.NotBetween?{type:n,compare:r,info:{numberRange:e.expectedValue}}:{type:n,compare:r,info:{number:e.expectedValue}};if(n===L.String)return{type:n,compare:r,info:{string:e.expectedValue}}}return{type:L.String,compare:k.Equal,info:{}}}const Mi=t=>{var e,n,r,a,s,i,l,u;const{conditionInfo:o,onChange:h}=t,c=U(Q),[m,b]=x.useState(!1),f=U(Fe),p=Si(f),v=(C,M,q)=>{h({type:M??o.type,compare:q??o.compare,info:C})},w=C=>{var M;const q=C[0],S=C[1];S&&b(!1);const B={};q===L.Date?S===d.Quarter?B.dateSelect=d.Q1:S===d.Month?B.dateSelect=d.M1:Rn.has(S)?B.date=new Date:B.dateRange=[new Date,new Date]:q===L.Number?B.number=0:q===L.String&&(B.string=""),v(B,C[0],(M=C[1])!=null?M:k.Equal)},F=Ri(o.type,o.compare);let $="";o.compare?$=`${c.t(`sheets-table.condition.${o.type}`)} - ${c.t(`sheets-table.${o.type}.compare.${o.compare}`)}`:$=c.t(`sheets-table.condition.${o.type}`);const y=xi(f,o.compare);return g.jsxs("div",{children:[g.jsx(Qe,{align:"start",open:m,onOpenChange:b,overlay:g.jsx(ka,{value:[o.type,o.compare],options:p,onChange:w,contentClassName:"univer-flex-1",wrapperClassName:"!univer-h-[150px]"}),children:g.jsxs("div",{className:A("univer-box-border univer-flex univer-h-8 univer-w-full univer-items-center univer-justify-between univer-rounded-md univer-bg-white univer-px-2 univer-text-sm univer-transition-colors univer-duration-200 hover:univer-border-primary-600 focus:univer-border-primary-600 focus:univer-outline-none focus:univer-ring-2 dark:!univer-bg-gray-700 dark:!univer-text-white",J),children:[g.jsx("span",{children:$}),g.jsx(xn,{})]})}),g.jsxs("div",{className:"univer-mt-3 univer-w-full",children:[F===z.Input&&g.jsx(g.Fragment,{children:o.type===L.String?g.jsx(fn,{className:"univer-w-full",placeholder:"",value:o.info.string,onChange:C=>v({string:C})}):g.jsx(tn,{className:"univer-h-7 univer-w-full",value:o.info.number,controls:!1,onChange:C=>{C!==null&&v({number:C})}})}),F===z.DatePicker&&g.jsx("div",{id:"univer-table-date-picker-wrapper",children:g.jsx(Ba,{className:"univer-w-full",value:(e=o.info.date)!=null?e:new Date,onValueChange:C=>v({date:C})})}),F===z.DateRange&&g.jsx("div",{id:"univer-table-date-range-wrapper",children:g.jsx(Va,{className:"univer-w-full",value:[(r=(n=o.info.dateRange)==null?void 0:n[0])!=null?r:new Date,(s=(a=o.info.dateRange)==null?void 0:a[1])!=null?s:new Date],onValueChange:C=>{v(C?{dateRange:C}:{})}})}),F===z.Inputs&&g.jsxs("div",{className:"univer-flex univer-items-center univer-gap-2",children:[g.jsx(tn,{className:"univer-w-full",value:(i=o.info.numberRange)==null?void 0:i[0],onChange:C=>{var M;C!==null&&v({numberRange:[C,(M=o.info.numberRange)==null?void 0:M[1]]})},controls:!1}),g.jsx("span",{children:" - "}),g.jsx(tn,{className:"univer-w-full",value:(l=o.info.numberRange)==null?void 0:l[1],controls:!1,onChange:C=>{var M;C!==null&&v({numberRange:[(M=o.info.numberRange)==null?void 0:M[0],C]})}})]}),F===z.Select&&g.jsx(Ha,{className:"univer-w-full",value:(u=o.info.dateSelect)!=null?u:y[0].value,options:y,onChange:C=>v({dateSelect:C})})]})]})},Ni=t=>{let e=0;return t.forEach(n=>{e+=n}),e};function $i(t){const{unitId:e,tableId:n,subUnitId:r,columnIndex:a,checkedItemSet:s,setCheckedItemSet:i,tableFilter:l}=t,u=U(Q),o=U(et),{data:h,itemsCountMap:c,allItemsCount:m}=o.getTableFilterItems(e,r,n,a),[b,f]=x.useState(l===void 0?!0:s.size===c.size),[p,v]=x.useState(b?m:Ni(c)),w=!b&&s.size>0,[F,$]=x.useState(""),y=x.useMemo(()=>F?h.filter(S=>String(S.title).toLowerCase().includes(F.toLowerCase())):h,[F,h]),C=x.useCallback(()=>{b?(s.clear(),i(new Set(s)),f(!1)):(y.forEach(S=>{s.add(S.title)}),i(new Set(s)),f(!0))},[b]),M=x.useCallback(S=>{S===""?(f(!0),h.forEach(B=>{s.add(B.title)}),v(m)):(s.clear(),f(!1),v(0)),$(S)},[]),q=S=>{if(b){f(!1);const B=new Set;for(const{title:ee}of h)S!==ee&&B.add(ee);v(m-c.get(S)),i(B)}else s.has(S)?(s.delete(S),v(p-c.get(S))):(s.add(S),v(p+c.get(S))),i(new Set(s))};return g.jsxs("div",{className:"univer-flex univer-h-full univer-flex-col",children:[g.jsx(fn,{autoFocus:!0,value:F,placeholder:u.t("sheets-table.filter.search-placeholder"),onChange:M}),g.jsx("div",{className:A("univer-mt-2 univer-box-border univer-flex univer-h-[180px] univer-max-h-[180px] univer-flex-grow univer-flex-col univer-overflow-hidden univer-rounded-md univer-py-1.5 univer-pl-2",J),children:g.jsx("div",{className:A("univer-h-40 univer-overflow-y-auto univer-py-1 univer-pl-2",ja),children:g.jsxs("div",{className:"univer-h-full",children:[g.jsx("div",{className:"univer-flex univer-items-center univer-px-2 univer-py-1",children:g.jsx(Fn,{indeterminate:w,disabled:h.length===0,checked:b,onChange:C,children:g.jsxs("div",{className:"univer-flex univer-h-5 univer-flex-1 univer-items-center univer-text-sm",children:[g.jsx("span",{className:"univer-inline-block univer-truncate",children:`${u.t("sheets-table.filter.select-all")}`}),g.jsx("span",{className:"univer-ml univer-text-gray-400",children:`(${p}/${F?y.length:m})`})]})})}),y.map(S=>g.jsx("div",{className:"univer-flex univer-items-center univer-px-2 univer-py-1",children:g.jsx(Fn,{checked:b||s.has(S.title),onChange:()=>{q(S.title)},children:g.jsxs("div",{className:"univer-flex univer-h-5 univer-flex-1 univer-text-sm",children:[g.jsx("span",{className:"univer-inline-block univer-truncate",children:S.title}),g.jsx("span",{className:"univer-ml-1 univer-text-gray-400",children:`(${c.get(S.title)||0})`})]})})},S.key))]})})})]})}function Ei(){var t;const e=U(Q),n=Fi(e),r=U(et),a=U(O),s=U(H),i=U(zn),l=U(tt),u=l.getCurrentTableFilterInfo(),o=r.getTableFilterPanelInitProps(u.unitId,u.subUnitId,u.tableId,u.column),{unitId:h,subUnitId:c,tableId:m,tableFilter:b,currentFilterBy:f,columnIndex:p}=o,{data:v}=r.getTableFilterItems(h,c,m,p),w=r.getTableFilterCheckedItems(h,m,p),[F,$]=x.useState(new Set(w)),[y,C]=x.useState(f||$e.Items),[M,q]=x.useState(()=>{const D=o.tableFilter;return yi(D)}),S=a.getTable(h,m);if(!S)return null;const B=S.getTableFilters(),ee=B.getSortState();ee.columnIndex===p&&(ee.sortState,be.Asc),ee.columnIndex===p&&(ee.sortState,be.Desc);const te=()=>{l.closeFilterPanel()},re=()=>{te()},Y=D=>{const V=S.getTableFilterRange();s.executeCommand(Aa.id,{unitId:h,subUnitId:c,range:V,orderRules:[{colIndex:p+V.startColumn,type:D?Dn.ASC:Dn.DESC}],hasTitle:!1}),B.setSortState(p,D?be.Asc:be.Desc),te()},Se=()=>{if(y===$e.Items){const D=[];for(const Ue of v)F.has(Ue.title)&&D.push(Ue.title);const V=S.getTableFilterColumn(p);if(V){if(V.values.join(",")===D.join(",")){te();return}}else if(D.length===0){te();return}const le={filterType:Ee.manual,values:D};r.setTableFilter(h,m,p,le)}else{let D;M.compare===d.Quarter||M.compare===d.Month?D={conditionType:M.type,compareType:Object.values(M.info)[0]}:D={conditionType:M.type,compareType:M.compare,expectedValue:Object.values(M.info)[0]};const V={filterType:Ee.condition,filterInfo:D};r.setTableFilter(h,m,p,V)}te()},Pe=()=>{r.setTableFilter(h,m,p,void 0),te()},ie=new ir(h).id,N=(t=i.getPermissionPoint(ie))==null?void 0:t.value;return g.jsxs("div",{className:"univer-box-border univer-flex univer-min-w-[312px] univer-flex-col univer-rounded-[10px] univer-bg-white univer-p-4 univer-shadow-lg dark:!univer-border-gray-600 dark:!univer-bg-gray-700",children:[N&&g.jsx("div",{className:"univer-mb-3 univer-flex",children:g.jsxs(La,{className:"univer-mb-3 !univer-flex univer-w-full",children:[g.jsxs(je,{className:"univer-w-1/2",onClick:()=>Y(!0),children:[g.jsx(yr,{className:"univer-mr-1"}),e.t("sheets-sort.general.sort-asc")]}),g.jsxs(je,{className:"univer-w-1/2",onClick:()=>Y(!1),children:[g.jsx(Nr,{className:"univer-mr-1"}),e.t("sheets-sort.general.sort-desc")]})]})}),g.jsx("div",{className:"univer-w-full",children:g.jsx(Oa,{value:y,items:n,onChange:D=>C(D)})}),g.jsx("div",{className:"univer-z-10 univer-h-60",children:g.jsx("div",{className:"univer-mt-3 univer-h-full univer-w-full",children:y===$e.Items?g.jsx($i,{tableFilter:b,unitId:h,subUnitId:c,tableId:m,columnIndex:p,checkedItemSet:F,setCheckedItemSet:$}):g.jsx(Mi,{tableFilter:b,unitId:h,subUnitId:c,tableId:m,columnIndex:p,conditionInfo:M,onChange:q})})}),g.jsxs("div",{className:"univer-flex-wrap-nowrap univer-mt-4 univer-inline-flex univer-flex-shrink-0 univer-flex-grow-0 univer-justify-between univer-gap-6 univer-overflow-hidden",children:[g.jsx(je,{disabled:b===void 0,onClick:Pe,children:e.t("sheets-table.filter.clear-filter")}),g.jsxs("div",{children:[g.jsx(je,{className:"univer-mr-2",onClick:re,children:e.t("sheets-table.filter.cancel")}),g.jsx(je,{variant:"primary",onClick:Se,children:e.t("sheets-table.filter.confirm")})]})]})]})}function Fi(t){const e=t.getCurrentLocale();return x.useMemo(()=>[{label:t.t("sheets-table.filter.by-values"),value:$e.Items},{label:t.t("sheets-table.filter.by-conditions"),value:$e.Condition}],[e,t])}var Di=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Dt=(t,e)=>(n,r)=>e(n,r,t);let tt=class extends se{constructor(t,e,n,r){super(),K(this,"_popupDisposable"),K(this,"_currentTableFilterInfo",null),this._componentManager=t,this._contextService=e,this._sheetCanvasPopupService=n,this._dialogService=r,this._initComponents(),this._initUIPopup()}setCurrentTableFilterInfo(t){this._currentTableFilterInfo=t}clearCurrentTableFilterInfo(){this._currentTableFilterInfo=null}getCurrentTableFilterInfo(){return this._currentTableFilterInfo}_initComponents(){[[Me,Ei]].forEach(([t,e])=>{this.disposeWithMe(this._componentManager.register(t,e))})}_initUIPopup(){this.disposeWithMe(this._contextService.subscribeContextValue$(Me).pipe(ar(void 0),qr()).subscribe(t=>{t?this._openFilterPopup():t===!1&&this._closeFilterPopup()}))}closeFilterPanel(){this._contextService.setContextValue(Me,!1)}_openFilterPopup(){const t=this._currentTableFilterInfo;if(!t)throw new Error("[SheetsFilterUIController]: no filter model when opening filter popup!");const{row:e,column:n}=t;this._popupDisposable=this._sheetCanvasPopupService.attachPopupToCell(e,n,{componentKey:Me,direction:"horizontal",onClickOutside:()=>{this._dialogService.close(oi),this._contextService.setContextValue(Me,!1)},offset:[5,0],portal:!0})}_closeFilterPopup(){var t;(t=this._popupDisposable)==null||t.dispose(),this._popupDisposable=null,this.clearCurrentTableFilterInfo()}};tt=Di([Dt(0,I(dr)),Dt(1,bn),Dt(2,I(Ea)),Dt(3,I(or))],tt);const un={type:G.OPERATION,id:"sheet.operation.open-table-filter-panel",async handler(t,e){if(!e)return!1;const{row:n,col:r,unitId:a,subUnitId:s,tableId:i}=e,l=t.get(O),u=t.get(bn),o=t.get(tt);return l.getTable(a,i)?(u.getContextValue(Me)||(o.setCurrentTableFilterInfo({unitId:a,subUnitId:s,row:n,tableId:i,column:r}),u.setContextValue(Me,!0)),!0):!1}},yn={type:G.OPERATION,id:"sheet.operation.open-table-selector",async handler(t){var e;const n=t.get(P),r=t.get(H),a=ne(n);if(!a)return!1;const{unitId:s,subUnitId:i,worksheet:l}=a,u=t.get(De).getCurrentLastSelection(),o=(e=u==null?void 0:u.range)!=null?e:{startRow:0,endRow:0,startColumn:0,endColumn:0},h=wa(u)?Ta(o,{up:!0,left:!0,right:!0,down:!0},l):o,c=await Ur(t,s,i,h);return c?(r.executeCommand(Kt.id,{...c}),!0):!1}};async function Ur(t,e,n,r,a){const s=t.get(or),i=t.get(Q);return new Promise(l=>{const u={unitId:e,subUnitId:n,range:r,tableId:a,onConfirm:o=>{l(o),s.close(Je)},onCancel:()=>{l(null),s.close(Je)}};s.open({id:Je,title:{title:i.t("sheets-table.selectRange")},draggable:!0,destroyOnClose:!0,mask:!1,maskClosable:!1,children:{label:{name:Je,props:u}},width:300,onClose:()=>{l(null),s.close(Je)}})})}const Lr="sheets-table-ui.config",Wn={anchorHeight:24,anchorBackgroundColor:"rgb(134,139,156)"};var Ui=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Li=(t,e)=>(n,r)=>e(n,r,t);let Ae=class extends se{constructor(t){super(),K(this,"_refreshTable",new Oe),K(this,"refreshTable$",this._refreshTable.asObservable()),this._commandService=t,this._initListener()}_initListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===sr.id){const e=t.params,{styleName:n}=e;n.startsWith(Tr)&&this._refreshTable.next(Math.random())}}))}};Ae=Ui([Li(0,I(H))],Ae);const Oi=()=>{var t,e;const[n,r]=x.useState(""),[a,s]=x.useState(""),i=U($a),[l,u]=x.useState({}),o=U(Fe),h=U(Yt),c=Be(h.anchorPosition$),m=U(H),b=U(P),f=U(lr),p=Be(f.unitPermissionInitStateChange$,!1),v=U(O),w=U(Gt),F=U(Ae),$=Be(F.refreshTable$),y=U(Q),C=U(De),M=Be(C.selectionChanged$,[{range:gn(0,0),primary:null}]),[,q]=x.useState(Math.random()),S=U(Qt).getConfig(Lr),B=(t=S==null?void 0:S.anchorHeight)!=null?t:24,ee=(e=S==null?void 0:S.anchorBackgroundColor)!=null?e:"rgb(53,91,183)",te=(N,D)=>{u(V=>({...V,[N]:D}))};if(x.useEffect(()=>{q(Math.random())},[$]),!(c!=null&&c.length))return null;const re=ne(b);if(!re)return null;const{unitId:Y,subUnitId:Se}=re,Pe=(N,D)=>{var V;if(((V=v.getTableById(Y,N))==null?void 0:V.getDisplayName())===D){r(""),s("");return}m.executeCommand(Ke.id,{tableId:N,unitId:Y,name:D}),s(""),r("")},ie=async N=>{const D=v.getTableById(Y,N);if(!D)return;const V=D.getRange(),le=await Ur(o,Y,Se,V,N);le&&m.executeCommand(Ke.id,{tableId:N,unitId:Y,updateRange:{newRange:le.range}})};return p?g.jsx("div",{className:"univer-absolute univer-z-50 univer-h-0 univer-w-0",children:c.map(N=>{var D,V,le,Ue,rt,at,Tt;const xe=v.getTableById(Y,N.tableId);if(!xe)return null;const qe=w.getRangeThemeStyle(Y,xe.getTableStyleId()),Ye=(le=(V=(D=qe==null?void 0:qe.getHeaderRowStyle())==null?void 0:D.bg)==null?void 0:V.rgb)!=null?le:ee,_t=(at=(rt=(Ue=qe==null?void 0:qe.getHeaderRowStyle())==null?void 0:Ue.cl)==null?void 0:rt.rgb)!=null?at:"rgb(255, 255, 255)",St=xe.getRange();if(!(M!=null&&M.length))return null;const xt=M[M.length-1].range,T=!ce.intersects(St,xt)&&N.y<=20;return g.jsxs("div",{className:A("univer-shadow-xs univer-absolute univer-box-border univer-cursor-pointer univer-items-center univer-rounded-xl univer-pl-2 univer-pr-2",J,{"univer-flex":!T,"univer-hidden":T}),style:{left:N.x,top:Math.max(N.y,0),backgroundColor:Ye,color:_t,borderWidth:"0.5px",height:B?`${B}px`:"24px"},children:[g.jsx("div",{className:"univer-text-nowrap",children:n===N.tableId?g.jsx(fn,{className:"univer-h-[18px] univer-min-w-16 univer-rounded-none",inputClass:"univer-h-[18px] univer-w-[80px]",value:a,onChange:j=>s(j),onBlur:()=>Pe(N.tableId,a),onKeyDown:j=>{j.key==="Enter"&&Pe(N.tableId,a)},autoFocus:n===N.tableId}):g.jsx("div",{className:"univer-h-[18px] univer-max-w-24 univer-truncate univer-text-sm",children:N.tableName})}),g.jsx(Qe,{align:"start",overlay:g.jsxs("div",{className:"univer-pb-2 univer-pt-2",children:[g.jsxs("div",{className:"univer-flex univer-min-w-32 univer-cursor-pointer univer-items-center univer-gap-2 univer-pb-1 univer-pl-2 univer-pr-2 univer-pt-1 univer-text-sm hover:univer-bg-gray-200",onClick:()=>{r(N.tableId),s(N.tableName)},children:[g.jsx(Er,{}),y.t("sheets-table.rename")]}),g.jsx("div",{className:"univer-mb-1 univer-mt-1 univer-h-px univer-w-full univer-bg-gray-200"}),g.jsxs("div",{onClick:()=>ie(N.tableId),className:"univer-flex univer-min-w-32 univer-cursor-pointer univer-items-center univer-gap-2 univer-pb-1 univer-pl-2 univer-pr-2 univer-pt-1 univer-text-sm hover:univer-bg-gray-200",children:[g.jsx($r,{}),y.t("sheets-table.updateRange")]}),g.jsxs("div",{className:"univer-flex univer-min-w-32 univer-cursor-pointer univer-items-center univer-gap-2 univer-pb-1 univer-pl-2 univer-pr-2 univer-pt-1 univer-text-sm hover:univer-bg-gray-200",onClick:()=>{te(N.tableId,!1);const j=v.getTableById(Y,N.tableId);if(!j)return;const Ie=j.getTableConfig(),Ce={id:ui,header:{title:y.t("sheets-table.tableStyle")},children:{label:xr,oldConfig:Ie,unitId:Y,subUnitId:Se,tableId:N.tableId},width:330};i.open(Ce)},children:[g.jsx(Dr,{extend:{colorChannel1:"rgb(53,91,183)"}}),y.t("sheets-table.setTheme")]}),g.jsx("div",{className:"univer-mb-1 univer-mt-1 univer-h-px univer-w-full univer-bg-gray-200"}),g.jsxs("div",{className:"univer-flex univer-min-w-32 univer-cursor-pointer univer-items-center univer-pb-1 univer-pl-2 univer-pr-2 univer-pt-1 univer-text-sm hover:univer-bg-gray-200",onClick:()=>{te(N.tableId,!1),m.executeCommand(en.id,{tableId:N.tableId,subUnitId:Se,unitId:Y})},children:[g.jsx(Mr,{className:"univer-mr-2"}),y.t("sheets-table.removeTable")]})]}),open:(Tt=l[N.tableId])!=null?Tt:!1,onOpenChange:j=>{te(N.tableId,j)},children:g.jsx(xn,{})},N.tableId)]},N.tableId)})}):null};var ji=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},me=(t,e)=>(n,r)=>e(n,r,t);let Yt=class extends se{constructor(t,e,n,r,a,s,i,l,u,o,h){super(),K(this,"_anchorVisible$",new Vt(!0)),K(this,"_timer"),K(this,"_anchorPosition$",new Vt([])),K(this,"anchorPosition$",this._anchorPosition$.asObservable()),this._context=t,this._injector=e,this._sheetSkeletonManagerService=n,this._renderManagerService=r,this._commandService=a,this._univerInstanceService=s,this._uiPartsService=i,this._tableManager=l,this._scrollManagerService=u,this._workbookPermissionService=o,this._permissionService=h,this._initUI(),this._initListener(),this._initTableAnchor()}_initUI(){this.disposeWithMe(this._uiPartsService.registerComponent(ga.CONTENT,()=>ma(Oi,this._injector)))}_initListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{(t.id===ba.id||t.id===pa.id)&&(this._anchorVisible$.next(!1),this._timer&&clearTimeout(this._timer),this._timer=setTimeout(()=>{this._anchorVisible$.next(!0)},300))}))}_initTableAnchor(){this.disposeWithMe(mn(this._context.unit.activeSheet$,this._sheetSkeletonManagerService.currentSkeleton$,this._scrollManagerService.validViewportScrollInfo$,this._tableManager.tableAdd$,this._tableManager.tableDelete$,this._tableManager.tableNameChanged$,this._tableManager.tableRangeChanged$,this._tableManager.tableThemeChanged$,this._workbookPermissionService.unitPermissionInitStateChange$.pipe(Ot(t=>t)),this._permissionService.permissionPointUpdate$.pipe(Jr(300)),this._anchorVisible$).subscribe(()=>{var t;if(!this._anchorVisible$.getValue()){this._anchorPosition$.next([]);return}const e=this._context.unit,n=e.getActiveSheet(),r=n==null?void 0:n.getSheetId(),a=this._tableManager.getTableList(this._context.unitId).filter(l=>l.subUnitId===r),s=this._renderManagerService.getRenderById(this._context.unitId);if(!s){this._anchorPosition$.next([]);return}if(!((t=this._permissionService.getPermissionPoint(new ir(e.getUnitId()).id))!=null&&t.value)){this._anchorPosition$.next([]);return}const i=a.reduce((l,u)=>{const{startRow:o,startColumn:h}=u.range,c=s.with(Xt),m=va(this._univerInstanceService,this._renderManagerService);if(!m)return l;const{scene:b}=m,f=b.getViewport(fa.VIEW_MAIN);if(!f)return l;const p=b==null?void 0:b.scaleX,v=b==null?void 0:b.scaleY,w=b==null?void 0:b.getViewportScrollXY(f);if(!p||!b||!v||!w)return l;const F=c.getCurrentSkeleton();if(!F)return l;const $=F.getNoMergeCellWithCoordByIndex(o,h),y=Ia($.startX,p,w),C=Ca($.startY,v,w)-25-4;return C>=-10&&y>=45&&l.push({x:y,y:C,tableId:u.id,tableName:u.name}),l},[]);this._anchorPosition$.next(i)}))}};Yt=ji([me(1,I(Fe)),me(2,I(Xt)),me(3,ur),me(4,H),me(5,P),me(6,Fa),me(7,I(O)),me(8,I(Da)),me(9,I(lr)),me(10,I(zn))],Yt);const Ze=16;new Path2D("M3.30363 3C2.79117 3 2.51457 3.60097 2.84788 3.99024L6.8 8.60593V12.5662C6.8 12.7184 6.8864 12.8575 7.02289 12.9249L8.76717 13.7863C8.96655 13.8847 9.2 13.7396 9.2 13.5173V8.60593L13.1521 3.99024C13.4854 3.60097 13.2088 3 12.6964 3H3.30363Z");class Pn{static drawNoSetting(e,n,r,a){e.save(),En.drawWith(e,{radius:2,width:Ze,height:Ze,fill:a}),e.lineCap="square",e.strokeStyle=r,e.scale(n/Ze,n/Ze),e.beginPath(),e.lineWidth=1,e.lineCap="round",e.moveTo(3,4),e.lineTo(13,4),e.moveTo(4.5,8),e.lineTo(11.5,8),e.moveTo(6,12),e.lineTo(10,12),e.stroke(),e.restore()}static drawIconByPath(e,n,r,a){e.save(),e.strokeStyle=r,e.fillStyle=a,En.drawWith(e,{radius:2,width:Ze,height:Ze,fill:a}),n.forEach(s=>{const i=new Path2D(s);e.fillStyle=r,e.fill(i,"evenodd")}),e.restore()}}const ki=["M3.30363 3C2.79117 3 2.51457 3.60097 2.84788 3.99024L6.8 8.60593V12.5662C6.8 12.7184 6.8864 12.8575 7.02289 12.9249L8.76717 13.7863C8.96655 13.8847 9.2 13.7396 9.2 13.5173V8.60593L13.1521 3.99024C13.4854 3.60097 13.2088 3 12.6964 3H3.30363Z"],Bi=["M12.4008 13.1831C12.6907 13.1831 12.9258 12.9481 12.9258 12.6581V4.60873L14.013 5.69597C14.218 5.901 14.5505 5.901 14.7555 5.69597C14.9605 5.49094 14.9605 5.15853 14.7555 4.95351L12.7721 2.97017C12.5671 2.76515 12.2347 2.76515 12.0297 2.97017L10.0463 4.95351C9.84132 5.15853 9.84132 5.49094 10.0463 5.69597C10.2514 5.901 10.5838 5.901 10.7888 5.69597L11.8758 4.60901V12.6581C11.8758 12.9481 12.1108 13.1831 12.4008 13.1831Z","M1.28069 4.85447C0.842195 4.33439 1.21191 3.5391 1.89218 3.5391H8.59333C9.2736 3.5391 9.64331 4.33439 9.20482 4.85447L6.51052 8.0501V11.6601C6.51052 12.2245 5.94174 12.6114 5.41683 12.404L4.48092 12.0343C4.1756 11.9136 3.97498 11.6187 3.97498 11.2904V8.0501L1.28069 4.85447Z"],Vi=["M12.4008 2.81641C12.6907 2.81641 12.9258 3.05146 12.9258 3.34141V11.3908L14.013 10.3036C14.218 10.0986 14.5505 10.0986 14.7555 10.3036C14.9605 10.5086 14.9605 10.841 14.7555 11.046L12.7721 13.0294C12.5671 13.2344 12.2347 13.2344 12.0297 13.0294L10.0463 11.046C9.84132 10.841 9.84132 10.5086 10.0463 10.3036C10.2514 10.0986 10.5838 10.0986 10.7888 10.3036L11.8758 11.3905V3.34141C11.8758 3.05146 12.1108 2.81641 12.4008 2.81641Z","M1.28069 4.85444C0.842195 4.33435 1.21191 3.53906 1.89218 3.53906H8.59333C9.2736 3.53906 9.64331 4.33435 9.20482 4.85443L6.51052 8.05006V11.6601C6.51052 12.2245 5.94174 12.6113 5.41683 12.404L4.48092 12.0342C4.1756 11.9136 3.97498 11.6186 3.97498 11.2903V8.05006L1.28069 4.85444Z"],Hi=["M11.9003 13.7046C11.9003 13.9969 11.6633 14.2339 11.371 14.2339C11.0787 14.2339 10.8417 13.9969 10.8417 13.7046V3.57272L9.74577 4.66862C9.53906 4.87534 9.20391 4.87534 8.9972 4.66862C8.79048 4.46191 8.79048 4.12676 8.9972 3.92005L10.9969 1.92039C11.2036 1.71368 11.5387 1.71368 11.7454 1.92039L13.7451 3.92005C13.9518 4.12676 13.9518 4.46191 13.7451 4.66862C13.5384 4.87534 13.2032 4.87534 12.9965 4.66862L11.9003 3.57243V13.7046Z","M2.69779 10.0113C2.40546 10.0113 2.16847 9.77429 2.16847 9.48196C2.16847 9.18962 2.40546 8.95264 2.69779 8.95264H6.67804C6.89213 8.95264 7.08514 9.0816 7.16707 9.2794C7.249 9.47719 7.20371 9.70486 7.05233 9.85624L3.97569 12.9329H6.67804C6.97038 12.9329 7.20736 13.1699 7.20736 13.4622C7.20736 13.7545 6.97038 13.9915 6.67804 13.9915H2.69779C2.4837 13.9915 2.29069 13.8626 2.20876 13.6648C2.12684 13.467 2.17212 13.2393 2.32351 13.0879L5.40015 10.0113H2.69779Z","M5.51638 2.58693C5.23363 1.81542 4.14248 1.81543 3.85973 2.58693L2.13245 7.29995C2.03185 7.57443 2.17281 7.87849 2.4473 7.97909C2.72178 8.07969 3.02584 7.93872 3.12644 7.66424L3.64346 6.25351L3.64504 6.25351H5.73266L6.24968 7.66424C6.35027 7.93872 6.65433 8.07969 6.92882 7.97909C7.2033 7.87849 7.34426 7.57443 7.24367 7.29995L5.51638 2.58693ZM5.34467 5.19487L4.68806 3.40325L4.03144 5.19487H5.34467Z"],Ai=["M11.9003 2.29495C11.9003 2.00261 11.6633 1.76562 11.371 1.76562C11.0787 1.76562 10.8417 2.00261 10.8417 2.29495V12.4268L9.74577 11.3309C9.53906 11.1242 9.20391 11.1242 8.9972 11.3309C8.79048 11.5376 8.79048 11.8727 8.9972 12.0795L10.9969 14.0791C11.2036 14.2858 11.5387 14.2858 11.7454 14.0791L13.7451 12.0795C13.9518 11.8727 13.9518 11.5376 13.7451 11.3309C13.5384 11.1242 13.2032 11.1242 12.9965 11.3309L11.9003 12.4271V2.29495Z","M2.69792 10.0113C2.40558 10.0113 2.16859 9.77429 2.16859 9.48196C2.16859 9.18962 2.40558 8.95264 2.69792 8.95264H6.67816C6.89225 8.95264 7.08526 9.0816 7.16719 9.2794C7.24912 9.47719 7.20384 9.70486 7.05245 9.85624L3.97581 12.9329H6.67816C6.9705 12.9329 7.20749 13.1699 7.20749 13.4622C7.20749 13.7545 6.9705 13.9915 6.67816 13.9915H2.69792C2.48383 13.9915 2.29082 13.8626 2.20889 13.6648C2.12696 13.467 2.17224 13.2393 2.32363 13.0879L5.40027 10.0113H2.69792Z","M5.5165 2.58693C5.23375 1.81542 4.1426 1.81543 3.85985 2.58693L2.13257 7.29995C2.03197 7.57443 2.17294 7.8785 2.44742 7.97909C2.7219 8.07969 3.02596 7.93872 3.12656 7.66424L3.64358 6.25351L3.64516 6.25351H5.73278L6.2498 7.66424C6.35039 7.93872 6.65446 8.07969 6.92894 7.97909C7.20342 7.8785 7.34438 7.57443 7.24379 7.29995L5.5165 2.58693ZM5.34479 5.19487L4.68818 3.40325L4.03156 5.19487H5.34479Z"];var Wi=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},an=(t,e)=>(n,r)=>e(n,r,t);const we=16,ft=1;let dn=class extends Na{constructor(t,e,n,r,a){super(t,e),K(this,"_cellWidth",0),K(this,"_cellHeight",0),K(this,"_filterParams"),K(this,"_hovered",!1),this._contextService=n,this._commandService=r,this._themeService=a,this.setShapeProps(e),this.onPointerDown$.subscribeEvent(s=>this.onPointerDown(s)),this.onPointerEnter$.subscribeEvent(()=>this.onPointerEnter()),this.onPointerLeave$.subscribeEvent(()=>this.onPointerLeave())}setShapeProps(t){typeof t.cellHeight<"u"&&(this._cellHeight=t.cellHeight),typeof t.cellWidth<"u"&&(this._cellWidth=t.cellWidth),typeof t.filterParams<"u"&&(this._filterParams=t.filterParams),this.transformByState({width:t.width,height:t.height})}_draw(t){const e=this._cellHeight,n=this._cellWidth,r=we-n,a=we-e;t.save();const s=new Path2D;s.rect(r,a,n,e),t.clip(s);const{buttonState:i}=this._filterParams,l=this._themeService.getColorFromTheme("primary.600"),u=this._hovered?this._themeService.getColorFromTheme("gray.50"):"rgba(255, 255, 255, 1.0)";let o;switch(i){case ae.FilteredSortNone:o=ki;break;case ae.FilteredSortAsc:o=Bi;break;case ae.FilteredSortDesc:o=Vi;break;case ae.FilterNoneSortNone:break;case ae.FilterNoneSortAsc:o=Hi;break;case ae.FilterNoneSortDesc:o=Ai;break}o?Pn.drawIconByPath(t,o,l,u):i!==void 0&&Pn.drawNoSetting(t,we,l,u),t.restore()}onPointerDown(t){if(t.button===2)return;const{row:e,col:n,unitId:r,subUnitId:a,tableId:s}=this._filterParams;this._contextService.getContextValue(Me)||!this._commandService.hasCommand(un.id)||setTimeout(()=>{const i={row:e,col:n,unitId:r,subUnitId:a,tableId:s};this._commandService.executeCommand(un.id,i)},200)}onPointerEnter(){this._hovered=!0,this.makeDirty(!0)}onPointerLeave(){this._hovered=!1,this.makeDirty(!0)}};dn=Wi([an(2,bn),an(3,H),an(4,I(zr))],dn);var Pi=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},bt=(t,e)=>(n,r)=>e(n,r,t);const qi=5e3,Yi=(t,e,n,r)=>{switch(r){case jt.TOP:return t+ft;case jt.MIDDLE:return t+Math.max(0,(n-we)/2);case jt.BOTTOM:default:return e-we-ft}};let cn=class extends Gn{constructor(t,e,n,r,a,s){super(),K(this,"_buttonRenderDisposable",null),K(this,"_tableFilterButtonShapes",[]),this._context=t,this._injector=e,this._sheetSkeletonManagerService=n,this._sheetInterceptorService=r,this._tableManager=a,this._commandService=s,this._initRenderer(),this._initCommandExecuted()}dispose(){super.dispose(),this._disposeRendering()}_initRenderer(){const t=this._tableManager;this._sheetSkeletonManagerService.currentSkeleton$.pipe(Te(e=>{var n;if(!e)return ge(null);const{unit:r,unitId:a}=this._context,s=((n=r.getActiveSheet())==null?void 0:n.getSheetId())||"",i=()=>({unitId:a,worksheetId:s,tableFilterRanges:this._tableManager.getSheetFilterRangeWithState(r.getUnitId(),s),skeleton:e.skeleton});return mn(t.tableAdd$,t.tableNameChanged$,t.tableRangeChanged$,t.tableThemeChanged$,t.tableDelete$,t.tableFilterChanged$).pipe(Zr(()=>i()),ar(i()))}),da(this.dispose$)).subscribe(e=>{this._disposeRendering(),!(!e||!e.tableFilterRanges)&&this._renderButtons(e)})}_initCommandExecuted(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{var e;if(t.id!==ca.id)return;const{unit:n,unitId:r}=this._context,a=((e=n.getActiveSheet())==null?void 0:e.getSheetId())||"",s=this._sheetSkeletonManagerService.getCurrentSkeleton();if(!s)return;const i={unitId:r,worksheetId:a,tableFilterRanges:this._tableManager.getSheetFilterRangeWithState(n.getUnitId(),a),skeleton:s};this._disposeRendering(),!(!i||!i.tableFilterRanges)&&this._renderButtons(i)}))}_renderButtons(t){const{tableFilterRanges:e,unitId:n,skeleton:r,worksheetId:a}=t,{unit:s,scene:i}=this._context,l=s.getSheetBySheetId(a);if(l){for(const{range:u,states:o,tableId:h}of e){const{startRow:c,startColumn:m,endColumn:b}=u;this._interceptCellContent(n,a,u);for(let f=m;f<=b;f++){const p=`sheets-table-filter-button-${c}-${f}`,v=ha(c,f,i,r),w=l.getCellStyle(c,f),F=(w==null?void 0:w.vt)||jt.BOTTOM,{startX:$,startY:y,endX:C,endY:M}=v,q=C-$,S=M-y;if(S<=ft||q<=ft)continue;const B=o[f-m],ee=C-we-ft,te=Yi(y,M,S,F),re={left:ee,top:te,height:we,width:we,zIndex:qi,cellHeight:S,cellWidth:q,filterParams:{unitId:n,subUnitId:a,row:c,col:f,buttonState:B,tableId:h}},Y=this._injector.createInstance(dn,p,re);this._tableFilterButtonShapes.push(Y)}}i.addObjects(this._tableFilterButtonShapes),i.makeDirty()}}_interceptCellContent(t,e,n){const{startRow:r,startColumn:a,endColumn:s}=n;this._buttonRenderDisposable=this._sheetInterceptorService.intercept(pn.CELL_CONTENT,{effect:Yn.Style,handler:(i,l,u)=>{const{row:o,col:h,unitId:c,subUnitId:m}=l;return c!==t||m!==e||o!==r||h<a||h>s||((!i||i===l.rawData)&&(i={...l.rawData}),i.fontRenderExtension={...i==null?void 0:i.fontRenderExtension,rightOffset:we}),u(i)},priority:10})}_disposeRendering(){var t;this._tableFilterButtonShapes.forEach(e=>e.dispose()),(t=this._buttonRenderDisposable)==null||t.dispose(),this._buttonRenderDisposable=null,this._tableFilterButtonShapes=[]}};cn=Pi([bt(1,I(Fe)),bt(2,I(Xt)),bt(3,I(wt)),bt(4,I(O)),bt(5,H)],cn);const Zi=t=>{const{unitId:e,subUnitId:n,range:r,onCancel:a,onConfirm:s,tableId:i}=t,l=U(O),[u,o]=x.useState(r),[h,c]=x.useState(""),m=U(Q),b=U(P);return g.jsxs(g.Fragment,{children:[g.jsx(Wa,{maxRangeCount:1,unitId:e,subUnitId:n,initialValue:$n(r),onChange:(f,p)=>{const v=$n(r),w=_a(p).range,F=ne(b,{unitId:e,subUnitId:n});if(!F)return;if(F.worksheet.getMergeData().some(C=>ce.intersects(w,C))){c(m.t("sheets-table.tableRangeWithMergeError"));return}if(l.getTablesBySubunitId(e,n).some(C=>{if(C.getId()===i)return!1;const M=C.getRange();return ce.intersects(w,M)})){c(m.t("sheets-table.tableRangeWithOtherTableError"));return}const{startRow:$,endRow:y}=w;if($===y){c(m.t("sheets-table.tableRangeSingleRowError"));return}if(v!==p){if(i){const C=l.getTableById(e,i);if(C){const M=C.getRange();if(ce.intersects(w,M)&&M.startRow===w.startRow){o(w),c(""),s({unitId:e,subUnitId:n,range:w});return}else{c(m.t("sheets-table.updateError"));return}}}o(w),c("")}},supportAcrossSheet:!1}),h&&g.jsx("div",{className:"univer-mt-1 univer-text-xs univer-text-red-500",children:h}),g.jsxs("div",{className:"univer-mt-4 univer-flex univer-justify-end",children:[g.jsx(je,{onClick:a,children:m.t("sheets-table.cancel")}),g.jsx(je,{variant:"primary",onClick:()=>{h||s({unitId:e,subUnitId:n,range:u})},className:"univer-ml-2",children:m.t("sheets-table.confirm")})]})]})},Ji=t=>{var e,n,r,a,s,i,l,u,o,h,c,m;const{unitId:b,subUnitId:f,tableId:p}=t,v=U(H),w=U(Q),F=U(O),$=F.getTableById(b,p),y=U(Gt),C=U(Ae),M=Be(y.rangeThemeMapChange$),q=Be(C.refreshTable$),S=U(Qr),[,B]=x.useState(Math.random()),ee=Be(F.tableThemeChanged$,{theme:$==null?void 0:$.getTableStyleId(),oldTheme:$==null?void 0:$.getTableStyleId(),unitId:b,subUnitId:f,tableId:p}),te=y.getRegisteredRangeThemes().filter(T=>T==null?void 0:T.startsWith(di)),re=y.getALLRegisteredTheme(b).filter(T=>T==null?void 0:T.startsWith(rn)),Y=$==null?void 0:$.getTableStyleId(),Se=re.find(T=>T===Y),Pe=Se||re[0],ie=y.getCustomRangeThemeStyle(b,Pe),N=(r=(n=(e=ie==null?void 0:ie.getHeaderRowStyle())==null?void 0:e.bg)==null?void 0:n.rgb)!=null?r:ye,D=(i=(s=(a=ie==null?void 0:ie.getFirstRowStyle())==null?void 0:a.bg)==null?void 0:s.rgb)!=null?i:ye,V=(o=(u=(l=ie==null?void 0:ie.getSecondRowStyle())==null?void 0:l.bg)==null?void 0:u.rgb)!=null?o:ye,le=(m=(c=(h=ie==null?void 0:ie.getLastRowStyle())==null?void 0:h.bg)==null?void 0:c.rgb)!=null?m:ye,[Ue,rt]=x.useState(null),at=T=>{v.executeCommand(Ke.id,{unitId:b,tableId:p,theme:T})},Tt=()=>{if(re.length>=11){S.emit(w.t("sheets-table.customTooMore"));return}const T=re[re.length-1];let j=`${rn}1`;if(T){const Ce=Number(T.split("-")[2]);j=`${rn}${Ce+1}`}const Ie=new vn(j,{...Qa});v.executeCommand(Cn.id,{unitId:b,tableId:p,themeStyle:Ie})},xe=(T,j)=>{v.executeCommand(sr.id,{unitId:b,subUnitId:f,styleName:T,style:j})},qe=T=>{v.executeCommand(_r.id,{unitId:b,tableId:p,themeName:T})};if(x.useEffect(()=>{B(Math.random())},[M,q]),!$)return null;const Ye=new Re(N).isDark(),_t=new Re(D).isDark(),St=new Re(V).isDark(),xt=new Re(le).isDark();return g.jsxs("div",{children:[g.jsx("h5",{children:w.t("sheets-table.defaultStyle")}),g.jsx("div",{className:"univer-flex univer-gap-2",children:te.map(T=>{var j,Ie,Ce,st,it,lt,ot,ut;const Z=y.getDefaultRangeThemeStyle(T),dt=((Ie=(j=Z==null?void 0:Z.getHeaderRowStyle())==null?void 0:j.bg)==null?void 0:Ie.rgb)||ye,ct=((st=(Ce=Z==null?void 0:Z.getFirstRowStyle())==null?void 0:Ce.bg)==null?void 0:st.rgb)||ye,ht=((lt=(it=Z==null?void 0:Z.getSecondRowStyle())==null?void 0:it.bg)==null?void 0:lt.rgb)||ye,gt=((ut=(ot=Z==null?void 0:Z.getLastRowStyle())==null?void 0:ot.bg)==null?void 0:ut.rgb)||ye;return g.jsxs("div",{className:A("univer-h-10 univer-w-8 univer-cursor-pointer univer-border univer-border-solid univer-border-gray-200 univer-p-px [&>div]:univer-box-border [&>div]:univer-h-2.5",{"univer-border-blue-500":T===ee.theme}),onClick:()=>at(T),children:[g.jsx("div",{style:{background:dt,border:`${oe}`}}),g.jsx("div",{style:{background:ct,border:`${oe}`}}),g.jsx("div",{style:{background:ht,border:`${oe}`}}),g.jsx("div",{style:{background:gt,border:`${oe}`}})]},T)})}),g.jsx("h5",{children:w.t("sheets-table.customStyle")}),g.jsxs("div",{className:A("univer-w-full univer-rounded-sm",J),children:[g.jsxs("div",{className:"univer-flex univer-flex-wrap univer-gap-2 univer-p-2",children:[g.jsx("div",{className:A("univer-h-10 univer-w-8 univer-cursor-pointer univer-p-px univer-text-center univer-leading-10",J),onClick:Tt,children:"+"}),re.map(T=>{var j,Ie,Ce,st,it,lt,ot,ut;const Z=y.getCustomRangeThemeStyle(b,T),dt=(Ie=(j=Z==null?void 0:Z.getHeaderRowStyle())==null?void 0:j.bg)==null?void 0:Ie.rgb,ct=(st=(Ce=Z==null?void 0:Z.getFirstRowStyle())==null?void 0:Ce.bg)==null?void 0:st.rgb,ht=(lt=(it=Z==null?void 0:Z.getSecondRowStyle())==null?void 0:it.bg)==null?void 0:lt.rgb,gt=(ut=(ot=Z==null?void 0:Z.getLastRowStyle())==null?void 0:ot.bg)==null?void 0:ut.rgb;return g.jsxs("div",{className:A("univer-relative univer-h-10 univer-w-8 univer-cursor-pointer univer-border univer-border-solid univer-border-gray-200 univer-p-px",{"univer-border-blue-500":T===ee.theme}),onClick:()=>at(T),onMouseEnter:()=>rt(T),onMouseLeave:()=>rt(null),children:[g.jsx("div",{className:"univer-box-border univer-h-2.5",style:{background:dt??oe,border:`${dt?oe:Ft}`}}),g.jsx("div",{className:"univer-box-border univer-h-2.5",style:{background:ct??oe,border:`${ct?oe:Ft}`}}),g.jsx("div",{className:"univer-box-border univer-h-2.5",style:{background:ht??oe,border:`${ht?oe:Ft}`}}),g.jsx("div",{className:"univer-box-border univer-h-2.5",style:{background:gt??oe,border:`${gt?oe:Ft}`}}),g.jsx("div",{className:"univer-absolute univer-right-[-3px] univer-top-[-3px] univer-h-3 univer-w-3 univer-rounded-md univer-bg-gray-200 univer-text-center univer-text-xs univer-leading-[10px]",style:{display:Ue===T?"block":"none"},onClick:Hr=>{Hr.stopPropagation(),qe(T)},children:"x"})]},T)})]}),Se&&g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"univer-h-px univer-w-full univer-bg-gray-200"}),g.jsxs("div",{className:"univer-flex univer-flex-col univer-gap-2 univer-p-2",children:[g.jsxs("div",{className:"univer-flex univer-h-9 univer-gap-2",children:[g.jsx("div",{className:A("univer-box-border univer-h-full univer-w-52 univer-rounded-sm univer-text-center univer-leading-9",J,{"univer-text-white":Ye,"univer-text-gray-900":!Ye}),style:{background:N},children:w.t("sheets-table.header")}),g.jsx(Qe,{overlay:g.jsx("div",{className:"univer-p-2",children:g.jsx(Rt,{value:N,onChange:T=>{const j=jn("headerRowStyle",{bg:{rgb:T},cl:{rgb:new Re(T).isDark()?"#fff":"#000"}});xe($.getTableStyleId(),{headerRowStyle:j})}})}),children:g.jsxs("div",{className:A("univer-flex univer-cursor-pointer univer-items-center univer-gap-2 univer-rounded-sm univer-bg-white univer-p-1",J),children:[g.jsx("div",{className:A("univer-h-4 univer-w-4 univer-rounded-lg univer-bg-gray-400",J,{"univer-text-white":Ye,"univer-text-gray-900":!Ye}),style:{background:N}}),g.jsx(vt,{className:"univer-h-2 univer-w-2"})]})})]}),g.jsxs("div",{className:"univer-flex univer-h-9 univer-gap-2",children:[g.jsx("div",{className:A("univer-box-border univer-h-full univer-w-52 univer-rounded-sm univer-text-center univer-leading-9",J,{"univer-text-white":_t,"univer-text-gray-900":!_t}),style:{background:D},children:w.t("sheets-table.firstLine")}),g.jsx(Qe,{overlay:g.jsx("div",{className:"univer-p-2",children:g.jsx(Rt,{value:D,onChange:T=>{xe($.getTableStyleId(),{firstRowStyle:{bg:{rgb:T},cl:{rgb:new Re(T).isDark()?"#fff":"#000"}}})}})}),children:g.jsxs("div",{className:A("univer-flex univer-cursor-pointer univer-items-center univer-gap-2 univer-rounded-sm univer-bg-white univer-p-1",J),children:[g.jsx("div",{className:A("univer-h-4 univer-w-4 univer-rounded-lg univer-bg-gray-400",J),style:{background:D}}),g.jsx(vt,{className:"univer-h-2 univer-w-2"})]})})]}),g.jsxs("div",{className:"univer-flex univer-h-9 univer-gap-2",children:[g.jsx("div",{className:A("univer-box-border univer-h-full univer-w-52 univer-rounded-sm univer-text-center univer-leading-9",J,{"univer-text-white":St,"univer-text-gray-900":!St}),style:{background:V},children:w.t("sheets-table.secondLine")}),g.jsx(Qe,{overlay:g.jsx("div",{className:"univer-p-2",children:g.jsx(Rt,{value:V,onChange:T=>xe($.getTableStyleId(),{secondRowStyle:{bg:{rgb:T},cl:{rgb:new Re(T).isDark()?"#fff":"#000"}}})})}),children:g.jsxs("div",{className:A("univer-flex univer-cursor-pointer univer-items-center univer-gap-2 univer-rounded-sm univer-bg-white univer-p-1",J),children:[g.jsx("div",{className:A("univer-h-4 univer-w-4 univer-rounded-lg univer-bg-gray-400",J),style:{background:V}}),g.jsx(vt,{className:"univer-h-2 univer-w-2"})]})})]}),g.jsxs("div",{className:"univer-flex univer-h-9 univer-gap-2",children:[g.jsx("div",{className:A("univer-box-border univer-h-full univer-w-52 univer-rounded-sm univer-text-center univer-leading-9",J,{"univer-text-white":xt,"univer-text-gray-900":!xt}),style:{background:le},children:w.t("sheets-table.footer")}),g.jsx(Qe,{overlay:g.jsx("div",{className:"univer-p-2",children:g.jsx(Rt,{value:le,onChange:T=>{const j=jn("lastRowStyle",{bg:{rgb:T},cl:{rgb:new Re(T).isDark()?"#fff":"#000"}});xe($.getTableStyleId(),{lastRowStyle:j})}})}),children:g.jsxs("div",{className:A("univer-flex univer-cursor-pointer univer-items-center univer-gap-2 univer-rounded-sm univer-bg-white univer-p-1",J),children:[g.jsx("div",{className:A("univer-h-4 univer-w-4 univer-rounded-lg univer-bg-gray-400",J),style:{background:le}}),g.jsx(vt,{className:"univer-h-2 univer-w-2"})]})})]})]})]})]})]})},Or="sheet.table.context-insert_menu-id",jr="sheet.table.context-remove_menu-id";function Qi(t){return{id:yn.id,type:We.BUTTON,icon:Sr,tooltip:"sheets-table.title",title:"sheets-table.title",hidden$:Ma(t,de.UNIVER_SHEET),disabled$:ya(t,{},!0)}}function Gi(t){return{id:Or,type:We.SUBITEMS,icon:"InsertDoubleIcon",title:"sheets-table.insert.main",hidden$:kr(t)}}function zi(t){return{id:jr,type:We.SUBITEMS,icon:"ReduceDoubleIcon",title:"sheets-table.remove.main",hidden$:kr(t)}}function Xi(t){return{id:wn.id,type:We.BUTTON,title:"sheets-table.insert.row",hidden$:Br(t)}}function Ki(t){return{id:Tn.id,title:"sheets-table.insert.col",type:We.BUTTON}}function el(t){return{id:_n.id,type:We.BUTTON,title:"sheets-table.remove.row",hidden$:Br(t)}}function tl(t){return{id:Sn.id,title:"sheets-table.remove.col",type:We.BUTTON}}function kr(t){const e=t.get(De);return t.get(P).getCurrentTypeOfUnit$(de.UNIVER_SHEET).pipe(Te(n=>n?n.activeSheet$.pipe(Te(r=>r?e.selectionMoveEnd$.pipe(Te(a=>{if(!a.length||a.length>1)return ge(!0);const s=a[0].range,i=t.get(pe).getContainerTableWithRange(n.getUnitId(),r.getSheetId(),s);return ge(!i)})):ge(!0))):ge(!0)))}function Br(t){const e=t.get(De);return t.get(P).getCurrentTypeOfUnit$(de.UNIVER_SHEET).pipe(Te(n=>n?n.activeSheet$.pipe(Te(r=>r?e.selectionMoveEnd$.pipe(Te(a=>{if(!a.length||a.length>1)return ge(!0);const s=a[0].range,i=t.get(pe).getContainerTableWithRange(n.getUnitId(),r.getSheetId(),s);if(!i)return ge(!0);const l=i.getRange();return s.startRow===l.startRow?ge(!0):ge(!1)})):ge(!0))):ge(!0)))}const nl={[Ra.ORGANIZATION]:{[yn.id]:{order:0,menuItemFactory:Qi}},[Sa.MAIN_AREA]:{[xa.LAYOUT]:{[Or]:{order:5,menuItemFactory:Gi,[wn.id]:{order:1,menuItemFactory:Xi},[Tn.id]:{order:2,menuItemFactory:Ki}},[jr]:{order:6,menuItemFactory:zi,[_n.id]:{order:1,menuItemFactory:el},[Sn.id]:{order:2,menuItemFactory:tl}}}}};var rl=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},qn=(t,e)=>(n,r)=>e(n,r,t);let Zt=class extends se{constructor(t,e){super(),this._componentManager=t,this._menuManagerService=e,this._initComponents(),this._initMenu()}_initComponents(){[[Sr,Fr],[Je,Zi],[xr,Ji]].forEach(([t,e])=>{this.disposeWithMe(this._componentManager.register(t,e))})}_initMenu(){this._menuManagerService.mergeMenu(nl)}};Zt=rl([qn(0,I(dr)),qn(1,I(Ua))],Zt);var al=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Ut=(t,e)=>(n,r)=>e(n,r,t);let hn=class extends Gn{constructor(t,e,n,r,a){super(),this._context=t,this._injector=e,this._sheetSkeletonManagerService=n,this._tableManager=r,this._sheetTableThemeUIController=a,this._initListener()}_dirtySkeleton(){var t;(t=this._context.mainComponent)==null||t.makeDirty();const e=this._sheetSkeletonManagerService.getCurrentParam();if(e){const n={...e,dirty:!0};this._sheetSkeletonManagerService.reCalculate(n)}}_initListener(){const t=this._tableManager,e=this._dirtySkeleton.bind(this);this.disposeWithMe(mn(t.tableAdd$,t.tableDelete$,t.tableNameChanged$,t.tableRangeChanged$,t.tableThemeChanged$,t.tableFilterChanged$,t.tableInitStatus$,this._sheetTableThemeUIController.refreshTable$).subscribe(e))}};hn=al([Ut(1,I(Fe)),Ut(2,I(Xt)),Ut(3,I(O)),Ut(4,I(Ae))],hn);var sl=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},sn=(t,e)=>(n,r)=>e(n,r,t);let Jt=class extends se{constructor(t,e,n){super(),this._sheetInterceptorService=t,this._univerInstanceService=e,this._tableManager=n,this._initSelectionChange()}_initSelectionChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:t=>{if(t.id===ua.id){const e=ne(this._univerInstanceService);if(!e)return{redos:[],undos:[]};const n=t.params,{range:r}=n,{unitId:a,subUnitId:s,worksheet:i}=e,l=this._tableManager.getTablesBySubunitId(a,s).find(u=>{const o=u.getRange();return ce.contains(o,r)});if(l){const u=l.getRange(),o={...u,startRow:u.startRow+1};return ce.equals(u,r)?{undos:[],redos:[]}:ce.equals(o,r)?{undos:[],redos:[{id:Nn.id,params:{unitId:a,subUnitId:s,selections:[{range:u,primary:Mn(u,i)}]}}]}:{undos:[],redos:[{id:Nn.id,params:{unitId:a,subUnitId:s,selections:[{range:o,primary:Mn(o,i)}]}}]}}}return{redos:[],undos:[]}}}))}};Jt=sl([sn(0,I(wt)),sn(1,I(P)),sn(2,I(O))],Jt);var il=Object.defineProperty,ll=(t,e,n)=>e in t?il(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,ol=(t,e,n,r)=>{for(var a=e,s=t.length-1,i;s>=0;s--)(i=t[s])&&(a=i(a)||a);return a},Lt=(t,e)=>(n,r)=>e(n,r,t),Vr=(t,e,n)=>ll(t,typeof e!="symbol"?e+"":e,n);let Ct=class extends Zn{constructor(t=Wn,e,n,r,a){super(),this._config=t,this._injector=e,this._commandService=n,this._configService=r,this._renderManagerService=a;const{menu:s,...i}=Jn({},Wn,this._config);s&&this._configService.setConfig("menu",s,{merge:!0}),this._configService.setConfig(Lr,i),this._initRegisterCommand()}onStarting(){Qn(this._injector,[[tt],[et],[Zt],[Ae],[Jt]])}onReady(){ln(this._injector,[[tt],[et],[Zt],[Ae],[Jt]])}onRendered(){this._registerRenderModules()}_registerRenderModules(){const t=[[cn],[hn]];this._config.hideAnchor!==!0&&t.push([Yt]),t.forEach(e=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(de.UNIVER_SHEET,e))})}_initRegisterCommand(){[un,yn].forEach(t=>this._commandService.registerCommand(t))}};Vr(Ct,"pluginName",li);Vr(Ct,"type",de.UNIVER_SHEET);Ct=ol([Gr(qt),Lt(1,I(Fe)),Lt(2,I(H)),Lt(3,Qt),Lt(4,ur)],Ct);class ul extends hr{getTableInfo(e){const n=this.getId();return this._injector.get(he).getTableInfo(n,e)}getTableList(){const e=this.getId();return this._injector.get(he).getTableList(e)}async addTable(e,n,r,a,s){var i;const l=this._injector.get(he),u=this._injector.get(Q),o=this._injector.get(P).getCurrentUnitOfType(de.UNIVER_SHEET),h=new Set;if(o&&o.getSheets().forEach(m=>{h.add(m.getName())}),!Bt(n,h)){this._injector.get(It).warn(u.t("sheets-table.tableNameError"));return}const c={unitId:this.getId(),name:n,subUnitId:e,range:r,options:s,id:a};if(await this._commandService.executeCommand(Kt.id,c))return(i=l.getTableList(this.getId()).find(m=>m.name===n))==null?void 0:i.id}async removeTable(e){var n;const r=(n=this.getTableInfo(e))==null?void 0:n.subUnitId;if(!r)return!1;const a={unitId:this.getId(),subUnitId:r,tableId:e};return this._commandService.executeCommand(en.id,a)}getTableInfoByName(e){return this.getTableList().find(n=>n.name===e)}setTableFilter(e,n,r){const a={unitId:this.getId(),tableId:e,column:n,tableFilter:r};return this._commandService.executeCommand(Xe.id,a)}}hr.extend(ul);class dl extends gr{addTable(e,n,r,a){const s=this.getSheetId(),i=this.getWorkbook(),l=i.getUnitId(),u=this._injector.get(Q),o=new Set;if(i&&i.getSheets().forEach(c=>{o.add(c.getName())}),!Bt(e,o))return this._injector.get(It).warn(u.t("sheets-table.tableNameError")),!1;const h={unitId:l,subUnitId:s,name:e,range:n,id:r,options:a};return this._commandService.executeCommand(Kt.id,h)}setTableFilter(e,n,r){const a={unitId:this.getWorkbook().getUnitId(),tableId:e,column:n,tableFilter:r};return this._commandService.executeCommand(Xe.id,a)}removeTable(e){const n={unitId:this._fWorkbook.getId(),subUnitId:this.getSheetId(),tableId:e};return this._commandService.executeCommand(en.id,n)}setTableRange(e,n){const r={unitId:this.getWorkbook().getUnitId(),tableId:e,updateRange:{newRange:n}};return this._commandService.executeCommand(Ke.id,r)}setTableName(e,n){const r=this.getWorkbook(),a=this._injector.get(Q),s=new Set;if(r&&r.getSheets().forEach(l=>{s.add(l.getName())}),!Bt(n,s))return this._injector.get(It).warn(a.t("sheets-table.tableNameError")),!1;const i={unitId:this.getWorkbook().getUnitId(),tableId:e,name:n};return this._commandService.executeCommand(Ke.id,i)}getSubTableInfos(){const e=this._fWorkbook.getId();return this._injector.get(he).getTableList(e).filter(n=>n.subUnitId===this.getSheetId())}resetFilter(e,n){const r={unitId:this._fWorkbook.getId(),tableId:e,column:n,tableFilter:void 0};return this._commandService.executeCommand(Xe.id,r)}getTableByCell(e,n){const r=this._fWorkbook.getId(),a=this._injector.get(he).getTableList(r).filter(i=>i.subUnitId===this.getSheetId()),s=gn(e,n);return a.find(i=>{const l=i.range;return ce.intersects(l,s)})}addTableTheme(e,n){const r=new vn("table-style");return r.fromJson(n),this._commandService.executeCommand(Cn.id,{unitId:this._fWorkbook.getId(),tableId:e,themeStyle:r})}}gr.extend(dl);class cl extends cr{get TableColumnFilterTypeEnum(){return Ee}get TableConditionTypeEnum(){return L}get TableNumberCompareTypeEnum(){return R}get TableStringCompareTypeEnum(){return k}get TableDateCompareTypeEnum(){return d}}cr.extend(cl);function Fl(){return{plugins:[qt,Ct].filter(t=>!!t)}}export{Kt as AddSheetTableCommand,Ve as AddSheetTableMutation,Cn as AddTableThemeCommand,en as DeleteSheetTableCommand,He as DeleteSheetTableMutation,_r as RemoveTableThemeCommand,Tr as SHEET_TABLE_CUSTOM_THEME_PREFIX,Ke as SetSheetTableCommand,Xe as SetSheetTableFilterCommand,on as SetSheetTableFilterMutation,E as SetSheetTableMutation,Tn as SheetTableInsertColCommand,wn as SheetTableInsertRowCommand,Sn as SheetTableRemoveColCommand,_n as SheetTableRemoveRowCommand,he as SheetTableService,ae as SheetsTableButtonStateEnum,pe as SheetsTableController,be as SheetsTableSortStateEnum,mr as TableColumnDataTypeEnum,Ee as TableColumnFilterTypeEnum,L as TableConditionTypeEnum,d as TableDateCompareTypeEnum,O as TableManager,R as TableNumberCompareTypeEnum,k as TableStringCompareTypeEnum,qt as UniverSheetsTablePlugin,Fl as UniverSheetsTablePreset,Ct as UniverSheetsTableUIPlugin,Qa as customEmptyThemeWithBorderStyle,pr as isConditionFilter,Ja as isManualFilter,jn as processStyleWithBorderStyle};
