import{M as Pe,am as ke,bW as xt,L as W,O as Je,o as Ot,G as ir,aT as yt,z as ut,w as re,V as ce,a5 as B,aO as sr,v as Ue,J as Fe,a6 as Rt,ah as lr,af as or,m as nr,c as ar,b as oe,F as Q,ak as ue,U as ht,l as cr,n as ur,al as be,s as hr,b8 as dr,k as We,Y as dt,q as At,I as T,u as ie,x as wt,B as mr,P as fr,y as $t}from"./TeamSpreadsheet-DqPQXi__.js";import{M as z,b as R,g as Se,R as pr,p as vr,e as _r,a as gr,z as Cr,B as Er,c as D,d as et,u as tt,G as Sr,I as u,E as Tr,f as Lt}from"./index-Ctp6PiU5.js";import{g as Nr,q as mt,pv as Fr,iT as br,iS as Ir,nJ as xr,mX as me,na as fe,kg as pe,np as Or,r0 as yr,tb as Mt,t9 as Pt,tf as Rr,e$ as ft,s as rt,t8 as Ar,pr as wr,qu as $r,qG as Lr,h as Mr,I as Pr,s2 as pt,f as kr,B as it,H as st,qN as Ur,c as Hr,d as H,t6 as M,sS as jr,qj as Br,r8 as Dr,gD as Wr,v as kt,gj as vt,lg as Qr,iK as Ut,km as Vr,mb as Gr,z as Yr,u as qr,G as Zr,oZ as zr,M as Ht,qg as jt,k as Xr,pV as Kr,R as Jr,n as ei}from"./index--BQDx9CP.js";import{r as S,m as Bt,j as h,d as ti,v as Qe,V as Dt,i as Ie,e as ri,af as ii,k as lt,L as _t,R as si,aa as li,b as oi,T as gt}from"./facade-DLk4o3Z_.js";var ni=Object.defineProperty,ai=(e,t,i)=>t in e?ni(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,p=(e,t,i)=>ai(e,typeof t!="symbol"?t+"":t,i),O=(e=>(e[e.FIRST=0]="FIRST",e[e.SECOND=1]="SECOND",e))(O||{}),_=(e=>(e.NONE="none",e.STARTS_WITH="startsWith",e.DOES_NOT_START_WITH="doesNotStartWith",e.ENDS_WITH="endsWith",e.DOES_NOT_END_WITH="doesNotEndWith",e.CONTAINS="contains",e.DOES_NOT_CONTAIN="doesNotContain",e.EQUALS="equals",e.NOT_EQUALS="notEquals",e.EMPTY="empty",e.NOT_EMPTY="notEmpty",e.BETWEEN="between",e.NOT_BETWEEN="notBetween",e.CUSTOM="custom",e))(_||{}),m;(e=>{e.NONE={label:"sheets-filter.conditions.none",operator:_.NONE,order:O.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.NONE]: should not have initial form params!")},testMappingParams:r=>r.operator1===_.NONE,mapToFilterColumn:()=>null,testMappingFilterColumn:r=>!r.customFilters&&!r.filters?{}:!1},e.EMPTY={label:"sheets-filter.conditions.empty",operator:_.EMPTY,order:O.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.EMPTY]: should not have initial form params!")},testMappingParams:({operator1:r})=>r===_.EMPTY,mapToFilterColumn:()=>({customFilters:{customFilters:[{val:""}]}}),testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.val===""&&a.operator===void 0?{operator1:_.EMPTY}:!1}},e.NOT_EMPTY={label:"sheets-filter.conditions.not-empty",operator:_.NOT_EMPTY,order:O.SECOND,numOfParameters:0,getDefaultFormParams:()=>{throw new Error("[FilterConditionItems.NOT_EMPTY]: should not have initial form params!")},testMappingParams:({operator1:r})=>r===_.NOT_EMPTY,mapToFilterColumn:()=>({customFilters:{customFilters:[{val:"",operator:u.NOT_EQUALS}]}}),testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.val===" "&&a.operator===u.NOT_EQUALS?{operator1:_.NOT_EMPTY}:!1}},e.TEXT_CONTAINS={label:"sheets-filter.conditions.text-contains",operator:_.CONTAINS,order:O.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:_.CONTAINS,val1:""}),testMappingParams:r=>{const[l]=P(r);return l===_.CONTAINS},mapToFilterColumn:r=>{const{val1:l}=r;return l===""?null:{customFilters:{customFilters:[{val:`*${l}*`}]}}},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0],c=a.val.toString();return!a.operator&&c.startsWith("*")&&c.endsWith("*")?{operator1:_.CONTAINS,val1:c.slice(1,-1)}:!1}},e.DOES_NOT_CONTAIN={label:"sheets-filter.conditions.does-not-contain",operator:_.DOES_NOT_CONTAIN,order:O.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:_.DOES_NOT_CONTAIN,val1:""}),mapToFilterColumn:r=>({customFilters:{customFilters:[{val:`*${r.val1}*`,operator:u.NOT_EQUALS}]}}),testMappingParams:r=>{const[l]=P(r);return l===_.DOES_NOT_CONTAIN},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0],c=a.val.toString();return a.operator===u.NOT_EQUALS&&c.startsWith("*")&&c.endsWith("*")?{operator1:_.DOES_NOT_CONTAIN,val1:c.slice(1,-1)}:!1}},e.STARTS_WITH={label:"sheets-filter.conditions.starts-with",operator:_.STARTS_WITH,order:O.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:_.STARTS_WITH,val1:""}),mapToFilterColumn:r=>({customFilters:{customFilters:[{val:`${r.val1}*`}]}}),testMappingParams:r=>{const[l]=P(r);return l===_.STARTS_WITH},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0],c=a.val.toString();return!a.operator&&c.endsWith("*")&&!c.startsWith("*")?{operator1:_.STARTS_WITH,val1:c.slice(0,-1)}:!1}},e.ENDS_WITH={label:"sheets-filter.conditions.ends-with",operator:_.ENDS_WITH,order:O.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:_.ENDS_WITH,val1:""}),mapToFilterColumn:r=>({customFilters:{customFilters:[{val:`*${r.val1}`}]}}),testMappingParams:r=>{const[l]=P(r);return l===_.ENDS_WITH},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0],c=a.val.toString();return!a.operator&&c.startsWith("*")&&!c.endsWith("*")?{operator1:_.ENDS_WITH,val1:c.slice(1)}:!1}},e.EQUALS={label:"sheets-filter.conditions.equals",operator:_.EQUALS,order:O.FIRST,numOfParameters:1,getDefaultFormParams:()=>({operator1:_.EQUALS,val1:""}),testMappingParams:r=>{const[l]=P(r);return l===_.EQUALS},mapToFilterColumn:r=>{const{val1:l}=r;return l===""?null:{customFilters:{customFilters:[{val:l}]}}},testMappingFilterColumn:r=>{var l,a,c;return((a=(l=r.filters)==null?void 0:l.filters)==null?void 0:a.length)===1?{operator1:_.EQUALS,val1:""}:((c=r.customFilters)==null?void 0:c.customFilters.length)===1&&!r.customFilters.customFilters[0].operator?{operator1:_.EQUALS,val1:r.customFilters.customFilters[0].val.toString()}:!1}},e.GREATER_THAN={label:"sheets-filter.conditions.greater-than",operator:u.GREATER_THAN,numOfParameters:1,order:O.FIRST,getDefaultFormParams:()=>({operator1:u.GREATER_THAN,val1:""}),mapToFilterColumn:r=>({customFilters:{customFilters:[{val:r.val1,operator:u.GREATER_THAN}]}}),testMappingParams:r=>{const[l]=P(r);return l===u.GREATER_THAN},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.operator!==u.GREATER_THAN?!1:{operator1:u.GREATER_THAN,val1:a.val.toString()}}},e.GREATER_THAN_OR_EQUAL={label:"sheets-filter.conditions.greater-than-or-equal",operator:u.GREATER_THAN_OR_EQUAL,numOfParameters:1,order:O.FIRST,getDefaultFormParams:()=>({operator1:u.GREATER_THAN_OR_EQUAL,val1:""}),testMappingParams:r=>{const[l]=P(r);return l===u.GREATER_THAN_OR_EQUAL},mapToFilterColumn:r=>({customFilters:{customFilters:[{val:r.val1,operator:u.GREATER_THAN_OR_EQUAL}]}}),testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.operator!==u.GREATER_THAN_OR_EQUAL?!1:{operator1:u.GREATER_THAN_OR_EQUAL,val1:a.val.toString()}}},e.LESS_THAN={label:"sheets-filter.conditions.less-than",operator:u.LESS_THAN,numOfParameters:1,order:O.FIRST,getDefaultFormParams:()=>({operator1:u.LESS_THAN,val1:""}),testMappingParams:r=>{const[l]=P(r);return l===u.LESS_THAN},mapToFilterColumn:r=>({customFilters:{customFilters:[{val:r.val1,operator:u.LESS_THAN}]}}),testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.operator!==u.LESS_THAN?!1:{operator1:u.LESS_THAN,val1:a.val.toString()}}},e.LESS_THAN_OR_EQUAL={label:"sheets-filter.conditions.less-than-or-equal",operator:u.LESS_THAN_OR_EQUAL,numOfParameters:1,order:O.FIRST,getDefaultFormParams:()=>({operator1:u.LESS_THAN_OR_EQUAL,val1:""}),testMappingParams:r=>{const[l]=P(r);return l===u.LESS_THAN_OR_EQUAL},mapToFilterColumn:r=>({customFilters:{customFilters:[{val:r.val1,operator:u.LESS_THAN_OR_EQUAL}]}}),testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.operator!==u.LESS_THAN_OR_EQUAL?!1:{operator1:u.LESS_THAN_OR_EQUAL,val1:a.val.toString()}}},e.EQUAL={label:"sheets-filter.conditions.equal",operator:u.EQUAL,numOfParameters:1,order:O.FIRST,getDefaultFormParams:()=>({operator1:u.EQUAL,val1:""}),testMappingParams:r=>{const[l]=P(r);return l===u.EQUAL},mapToFilterColumn:r=>({customFilters:{customFilters:[{val:r.val1,operator:u.EQUAL}]}}),testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.operator!==u.EQUAL?!1:{operator1:u.EQUAL,val1:a.val.toString()}}},e.NOT_EQUAL={label:"sheets-filter.conditions.not-equal",operator:u.NOT_EQUALS,numOfParameters:1,order:O.FIRST,getDefaultFormParams:()=>({operator1:u.NOT_EQUALS,val1:""}),testMappingParams:r=>{const[l]=P(r);return l===u.NOT_EQUALS},mapToFilterColumn:r=>({customFilters:{customFilters:[{val:r.val1,operator:u.NOT_EQUALS}]}}),testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==1)return!1;const a=r.customFilters.customFilters[0];return a.operator!==u.NOT_EQUALS?!1:{operator1:u.NOT_EQUALS,val1:a.val.toString()}}},e.BETWEEN={label:"sheets-filter.conditions.between",operator:_.BETWEEN,order:O.SECOND,numOfParameters:2,getDefaultFormParams:()=>({and:!0,operator1:u.GREATER_THAN_OR_EQUAL,val1:"",operator2:u.LESS_THAN_OR_EQUAL,val2:""}),testMappingParams:r=>{const{and:l,operator1:a,operator2:c}=r;if(!l)return!1;const d=[a,c];return d.includes(u.GREATER_THAN_OR_EQUAL)&&d.includes(u.LESS_THAN_OR_EQUAL)},mapToFilterColumn:r=>{const{val1:l,val2:a,operator1:c}=r,d=c===u.GREATER_THAN_OR_EQUAL;return{customFilters:{and:dt.TRUE,customFilters:[{val:d?l:a,operator:u.GREATER_THAN_OR_EQUAL},{val:d?a:l,operator:u.LESS_THAN_OR_EQUAL}]}}},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==2)return!1;const[a,c]=r.customFilters.customFilters;return a.operator===u.GREATER_THAN_OR_EQUAL&&c.operator===u.LESS_THAN_OR_EQUAL&&r.customFilters.and?{and:!0,operator1:u.GREATER_THAN_OR_EQUAL,val1:a.val.toString(),operator2:u.LESS_THAN_OR_EQUAL,val2:c.val.toString()}:c.operator===u.GREATER_THAN_OR_EQUAL&&a.operator===u.LESS_THAN_OR_EQUAL&&r.customFilters.and?{and:!0,operator1:u.GREATER_THAN_OR_EQUAL,val1:c.val.toString(),operator2:u.LESS_THAN_OR_EQUAL,val2:a.val.toLocaleString()}:!1}},e.NOT_BETWEEN={label:"sheets-filter.conditions.not-between",operator:_.NOT_BETWEEN,order:O.SECOND,numOfParameters:2,getDefaultFormParams:()=>({operator1:u.LESS_THAN,val1:"",operator2:u.GREATER_THAN,val2:""}),testMappingParams:r=>{const{and:l,operator1:a,operator2:c}=r;if(l)return!1;const d=[a,c];return d.includes(u.GREATER_THAN)&&d.includes(u.LESS_THAN)},mapToFilterColumn:r=>{const{val1:l,val2:a,operator1:c}=r,d=c===u.GREATER_THAN;return{customFilters:{customFilters:[{val:d?l:a,operator:u.GREATER_THAN},{val:d?a:l,operator:u.LESS_THAN}]}}},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==2)return!1;const[a,c]=r.customFilters.customFilters;return a.operator===u.LESS_THAN&&c.operator===u.GREATER_THAN&&!r.customFilters.and?{operator1:u.LESS_THAN,val1:a.val.toString(),operator2:u.GREATER_THAN,val2:c.val.toString()}:c.operator===u.LESS_THAN&&a.operator===u.GREATER_THAN&&!r.customFilters.and?{operator1:u.GREATER_THAN,val1:c.val.toString(),operator2:u.LESS_THAN,val2:a.val.toLocaleString()}:!1}},e.CUSTOM={label:"sheets-filter.conditions.custom",operator:_.CUSTOM,order:O.SECOND,numOfParameters:2,getDefaultFormParams:()=>({operator1:_.NONE,val1:"",operator2:_.NONE,val2:""}),testMappingParams:()=>!0,mapToFilterColumn:r=>{const{and:l,val1:a,val2:c,operator1:d,operator2:v}=r;function f(I,F){for(const b of e.ALL_CONDITIONS)if(b.operator===I)return b.mapToFilterColumn({val1:F,operator1:I})}const g=!d||d===e.NONE.operator,E=!v||v===e.NONE.operator;if(g&&E)return e.NONE.mapToFilterColumn({});if(g)return f(v,c);if(E)return f(d,a);const C=f(d,a),N=f(v,c),y={customFilters:[C.customFilters.customFilters[0],N.customFilters.customFilters[0]]};return l&&(y.and=dt.TRUE),{customFilters:y}},testMappingFilterColumn:r=>{var l;if(((l=r.customFilters)==null?void 0:l.customFilters.length)!==2)return!1;const a=r.customFilters.customFilters.map(d=>n({customFilters:{customFilters:[d]}})),c={operator1:a[0][0].operator,val1:a[0][1].val1,operator2:a[1][0].operator,val2:a[1][1].val1};return r.customFilters.and&&(c.and=!0),c}},e.ALL_CONDITIONS=[e.NONE,e.EMPTY,e.NOT_EMPTY,e.TEXT_CONTAINS,e.DOES_NOT_CONTAIN,e.STARTS_WITH,e.ENDS_WITH,e.EQUALS,e.GREATER_THAN,e.GREATER_THAN_OR_EQUAL,e.LESS_THAN,e.LESS_THAN_OR_EQUAL,e.EQUAL,e.NOT_EQUAL,e.BETWEEN,e.NOT_BETWEEN,e.CUSTOM];function t(r){const l=e.ALL_CONDITIONS.find(a=>a.operator===r);if(!l)throw new Error(`[SheetsFilter]: no condition item found for operator: ${r}`);return l}e.getItemByOperator=t;function i(r,l){for(const a of e.ALL_CONDITIONS.filter(c=>c.numOfParameters===l))if(a.numOfParameters!==0&&a.testMappingParams(r))return a;for(const a of e.ALL_CONDITIONS)if(a.testMappingParams(r))return a;throw new Error("[SheetsFilter]: no condition item can be mapped from the filter map params!")}e.testMappingParams=i;function s(r){const l=e.ALL_CONDITIONS.find(a=>a.operator===r);return(l==null?void 0:l.numOfParameters)===0?{operator1:l.operator}:l.getDefaultFormParams()}e.getInitialFormParams=s;function o(r,l){return r.mapToFilterColumn(l)}e.mapToFilterColumn=o;function n(r){if(!r)return[e.NONE,{}];for(const l of e.ALL_CONDITIONS){const a=l.testMappingFilterColumn(r);if(a)return[l,a]}return[e.NONE,{}]}e.testMappingFilterColumn=n})(m||(m={}));function P(e){const{operator1:t,operator2:i,val1:s,val2:o}=e;if(t&&i)throw new Error("Both operator1 and operator2 are set!");if(!t&&!i)throw new Error("Neither operator1 and operator2 and both not set!");return t?[t,s]:[i,o]}function qe(e){const t=[],i=[];let s=0,o=0;function n(r){r.leaf&&(r.checked?(t.push(r),s+=r.count):(i.push(r),o+=r.count)),r.children&&r.children.forEach(n)}return e.forEach(n),{checkedItems:t,uncheckedItems:i,checked:s,unchecked:o}}var ci=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},Ve=(e,t)=>(i,s)=>t(i,s,e);const ot="sheets-filter.generate-filter-values.service",xe=yt(ot);let Ze=class extends ce{constructor(e,t,i){super(),this._localeService=e,this._univerInstanceService=t,this._logService=i}async getFilterValues(e){var t;const{unitId:i,subUnitId:s,filteredOutRowsByOtherColumns:o,filterColumn:n,filters:r,blankChecked:l,iterateRange:a,alreadyChecked:c}=e,d=this._univerInstanceService.getUnit(i),v=(t=this._univerInstanceService.getUnit(i))==null?void 0:t.getSheetBySheetId(s);return!d||!v?[]:(this._logService.debug("[SheetsGenerateFilterValuesService]","getFilterValues for",{unitId:i,subUnitId:s}),Wt(r,this._localeService,a,v,new Set(o),n,new Set(c.map(String)),l,d.getStyles()))}};Ze=ci([Ve(0,T(Q)),Ve(1,Ue),Ve(2,fr)],Ze);function Wt(e,t,i,s,o,n,r,l,a){var c,d,v,f,g,E,C,N,y,I;const F=new Map,b=new Map,X="yyyy-mm-dd",V="empty",K=!e&&((n==null?void 0:n.filterBy)===R.COLORS||(n==null?void 0:n.filterBy)===R.CONDITIONS)&&((c=n.filteredOutRows)==null?void 0:c.size);let L=0;for(const w of s.iterateByColumn(i,!1,!1)){const{row:je,rowSpan:nt=1}=w;let se=0;for(;se<nt;){const rr=je+se;if(o.has(rr)){se++;continue}const J=w!=null&&w.value?dr(w.value):"";if(!J){L+=1,se+=nt;continue}const Te=(d=w.value)!=null&&d.v&&!w.value.p?(g=(f=a.get((v=w.value)==null?void 0:v.s))==null?void 0:f.n)==null?void 0:g.pattern:"",at=Te&&We.getFormatInfo(Te).isDate;let ct=!1;if(at){const{year:k,month:G,day:x}=We.getFormatDateInfo(Te);ct=k||G||x}if(Te&&at&&ct){const k=(E=s.getCellRaw(w.row,w.col))==null?void 0:E.v;if(!k){se++;continue}const G=We.format(X,Number(k)),[x,U,de]=G.split("-").map(Number);let ee=F.get(`${x}`);ee||(ee={title:`${x}`,key:`${x}`,children:[],count:0,leaf:!1,checked:!1},F.set(`${x}`,ee),b.set(`${x}`,[`${x}`]));let Y=(C=ee.children)==null?void 0:C.find(De=>De.key===`${x}-${U}`);Y||(Y={title:t.t(`sheets-filter.date.${U}`),key:`${x}-${U}`,children:[],count:0,leaf:!1,checked:!1},(N=ee.children)==null||N.push(Y),b.set(`${x}-${U}`,[`${x}`,`${x}-${U}`]));const Be=(y=Y==null?void 0:Y.children)==null?void 0:y.find(De=>De.key===`${x}-${U}-${de}`);Be?(Be.originValues.add(J),Be.count++,Y.count++,ee.count++):((I=Y.children)==null||I.push({title:`${de}`,key:`${x}-${U}-${de}`,count:1,originValues:new Set([J]),leaf:!0,checked:K?!1:r.size?r.has(J):!l}),Y.count++,ee.count++,b.set(`${x}-${U}-${de}`,[`${x}`,`${x}-${U}`,`${x}-${U}-${de}`]))}else{const k=J;let G=F.get(k);G?G.count++:(G={title:J,leaf:!0,checked:K?!1:r.size?r.has(J):!l,key:k,count:1},F.set(k,G),b.set(k,[k]))}se++}}const A=K?!1:e?l:!0;if(L>0){const w={title:t.t("sheets-filter.panel.empty"),count:L,leaf:!0,checked:A,key:V};F.set("empty",w),b.set("empty",[V])}return{filterTreeItems:ui(Array.from(F.values())),filterTreeMapCache:b}}function ui(e){return Array.from(e).sort((t,i)=>t.children&&!i.children?-1:!t.children&&i.children?1:hi(t.title,i.title)).map(t=>(t.children&&t.children.sort((i,s)=>{const o=Number.parseInt(i.key.split("-")[1],10),n=Number.parseInt(s.key.split("-")[1],10);return o-n}).forEach(i=>{i.children&&i.children.sort((s,o)=>{const n=Number.parseInt(s.key.split("-")[2],10),r=Number.parseInt(o.key.split("-")[2],10);return n-r})}),t))}const Ct=e=>!Number.isNaN(Number(e))&&!Number.isNaN(Number.parseFloat(e));function hi(e,t){const i=Ct(e),s=Ct(t);return i&&s?Number.parseFloat(e)-Number.parseFloat(t):i&&!s?-1:!i&&s?1:e.localeCompare(t)}function ze(e,t){for(const i of e){if(i.key===t)return i;if(i.children){const s=ze(i.children,t);if(s)return s}}return null}function Qt(e){return e.leaf?e.checked:e.children?e.children.every(t=>Qt(t)):!0}function ve(e,t){e.leaf&&(t!==void 0?e.checked=t:e.checked=!e.checked),e.children&&e.children.forEach(i=>ve(i,t))}function Vt(e,t){const i=[];return e.forEach(s=>{const o=s.originValues?t.some(r=>Array.from(s.originValues).some(l=>l.toLowerCase().includes(r.toLowerCase()))):!1,n=!o&&t.some(r=>s.title.toLowerCase().includes(r.toLowerCase()));if(o||n)i.push({...s});else if(s.children){const r=Vt(s.children,t);if(r.length>0){const l=r.reduce((a,c)=>a+c.count,0);i.push({...s,count:l,children:r})}}}),i}var He=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},Ce=(e,t)=>(i,s)=>t(i,s,e);yt("sheets-filter-ui.sheets-filter-panel.service");let Z=class extends ce{constructor(e,t){super(),p(this,"_filterBy$",new B(R.VALUES)),p(this,"filterBy$",this._filterBy$.asObservable()),p(this,"_filterByModel$",new sr(1)),p(this,"filterByModel$",this._filterByModel$.asObservable()),p(this,"_filterByModel",null),p(this,"_hasCriteria$",new B(!1)),p(this,"hasCriteria$",this._hasCriteria$.asObservable()),p(this,"_filterModel",null),p(this,"_col$",new B(-1)),p(this,"col$",this._col$.asObservable()),p(this,"_filterHeaderListener",null),this._injector=e,this._refRangeService=t}get filterBy(){return this._filterBy$.getValue()}get filterByModel(){return this._filterByModel}set filterByModel(e){this._filterByModel=e,this._filterByModel$.next(e)}get filterModel(){return this._filterModel}get col(){return this._col$.getValue()}dispose(){this._filterBy$.complete(),this._filterByModel$.complete(),this._hasCriteria$.complete()}setupCol(e,t){this.terminate(),this._filterModel=e,this._col$.next(t);const i=e.getFilterColumn(t);if(i){const s=i.getColumnData();if(s.customFilters){this._hasCriteria$.next(!0),this._setupByConditions(e,t);return}if(s.colorFilters){this._hasCriteria$.next(!0),this._setupByColors(e,t);return}if(s.filters){this._hasCriteria$.next(!0),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t)}changeFilterBy(e){if(!this._filterModel||this.col===-1)return!1;switch(e){case R.VALUES:this._setupByValues(this._filterModel,this.col);break;case R.COLORS:this._setupByColors(this._filterModel,this.col);break;case R.CONDITIONS:this._setupByConditions(this._filterModel,this.col);break}return!0}terminate(){return this._filterModel=null,this._col$.next(-1),this._disposeFilterHeaderChangeListener(),!0}_disposeFilterHeaderChangeListener(){var e;(e=this._filterHeaderListener)==null||e.dispose(),this._filterHeaderListener=null}_listenToFilterHeaderChange(e,t){this._disposeFilterHeaderChangeListener();const i=e.unitId,s=e.subUnitId,o=e.getRange(),n={startColumn:t,startRow:o.startRow,endRow:o.startRow,endColumn:t};this._filterHeaderListener=this._refRangeService.watchRange(i,s,n,(r,l)=>{if(!l)this.terminate();else{const a=l.startColumn-r.startColumn;a!==0&&this._filterByModel.deltaCol(a)}})}async _setupByValues(e,t){this._disposePreviousModel();const i=e.getRange();if(i.startRow===i.endRow)return!1;const s=await ye.fromFilterColumn(this._injector,e,t);return this.filterByModel=s,this._filterBy$.next(R.VALUES),this._listenToFilterHeaderChange(e,t),!0}async _setupByColors(e,t){this._disposePreviousModel();const i=e.getRange();if(i.startRow===i.endRow)return!1;const s=await Re.fromFilterColumn(this._injector,e,t);return this.filterByModel=s,this._filterBy$.next(R.COLORS),this._listenToFilterHeaderChange(e,t),!0}_setupByConditions(e,t){this._disposePreviousModel();const i=e.getRange();if(i.startRow===i.endRow)return!1;const s=Oe.fromFilterColumn(this._injector,e,t,e.getFilterColumn(t));return this.filterByModel=s,this._filterBy$.next(R.CONDITIONS),this._listenToFilterHeaderChange(e,t),!0}_disposePreviousModel(){var e;(e=this._filterByModel)==null||e.dispose(),this.filterByModel=null}};Z=He([Ce(0,T(ie)),Ce(1,T(Vr))],Z);let Oe=class extends ce{constructor(e,t,i,s,o){super(),p(this,"canApply$",ue(!0)),p(this,"_conditionItem$"),p(this,"conditionItem$"),p(this,"_filterConditionFormParams$"),p(this,"filterConditionFormParams$"),this._filterModel=e,this.col=t,this._commandService=o,this._conditionItem$=new B(i),this.conditionItem$=this._conditionItem$.asObservable(),this._filterConditionFormParams$=new B(s),this.filterConditionFormParams$=this._filterConditionFormParams$.asObservable()}static fromFilterColumn(e,t,i,s){const[o,n]=m.testMappingFilterColumn(s==null?void 0:s.getColumnData());return e.createInstance(Oe,t,i,o,n)}get conditionItem(){return this._conditionItem$.getValue()}get filterConditionFormParams(){return this._filterConditionFormParams$.getValue()}dispose(){super.dispose(),this._conditionItem$.complete(),this._filterConditionFormParams$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;const e=m.mapToFilterColumn(this.conditionItem,this.filterConditionFormParams);return this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:e})}onPrimaryConditionChange(e){const t=m.ALL_CONDITIONS.find(i=>i.operator===e);if(!t)throw new Error(`[ByConditionsModel]: condition item not found for operator: ${e}!`);this._conditionItem$.next(t),this._filterConditionFormParams$.next(m.getInitialFormParams(e))}onConditionFormChange(e){const t={...this.filterConditionFormParams,...e};if(t.and!==!0&&delete t.and,typeof e.and<"u"||typeof e.operator1<"u"||typeof e.operator2<"u"){const i=m.testMappingParams(t,this.conditionItem.numOfParameters);this._conditionItem$.next(i)}this._filterConditionFormParams$.next(t)}};Oe=He([Ce(4,W)],Oe);let ye=class extends ce{constructor(e,t,i,s,o){super(),p(this,"_rawFilterItems$"),p(this,"rawFilterItems$"),p(this,"filterItems$"),p(this,"_filterItems",[]),p(this,"_treeMapCache"),p(this,"canApply$"),p(this,"_manuallyUpdateFilterItems$"),p(this,"_searchString$"),p(this,"searchString$"),this._filterModel=e,this.col=t,this._commandService=o,this._treeMapCache=s,this._searchString$=new B(""),this.searchString$=this._searchString$.asObservable(),this._rawFilterItems$=new B(i),this.rawFilterItems$=this._rawFilterItems$.asObservable(),this._manuallyUpdateFilterItems$=new or,this.filterItems$=nr(ar([this._searchString$.pipe(Mt(500,void 0,{leading:!0,trailing:!0}),Pt(void 0)),this._rawFilterItems$]).pipe(oe(([n,r])=>{if(!n)return r;const l=n.toLowerCase().split(/\s+/).filter(a=>!!a);return Vt(r,l)})),this._manuallyUpdateFilterItems$).pipe(Rr(1)),this.canApply$=this.filterItems$.pipe(oe(n=>qe(n).checked>0)),this.disposeWithMe(this.filterItems$.subscribe(n=>this._filterItems=n))}static async fromFilterColumn(e,t,i){const s=e.get(Ue),o=e.get(Q),n=e.get(xe,xt.OPTIONAL),{unitId:r,subUnitId:l}=t,a=s.getUniverSheetInstance(r);if(!a)throw new Error(`[ByValuesModel]: Workbook not found for filter model with unitId: ${r}!`);const c=a==null?void 0:a.getSheetBySheetId(l);if(!c)throw new Error(`[ByValuesModel]: Worksheet not found for filter model with unitId: ${r} and subUnitId: ${l}!`);const d=t.getRange(),v=i,f=t.getFilterColumn(i),g=f==null?void 0:f.getColumnData().filters,E=new Set(g==null?void 0:g.filters),C=!!(g&&g.blank),N=t.getFilteredOutRowsExceptCol(i),y={...d,startRow:d.startRow+1,startColumn:v,endColumn:v};let I,F;if(n){const b=await n.getFilterValues({unitId:r,subUnitId:l,filteredOutRowsByOtherColumns:Array.from(N),filterColumn:f,filters:!!g,blankChecked:C,iterateRange:y,alreadyChecked:Array.from(E)});I=b.filterTreeItems,F=b.filterTreeMapCache}else{const b=Wt(!!g,o,y,c,N,f,E,C,a.getStyles());I=b.filterTreeItems,F=b.filterTreeMapCache}return e.createInstance(ye,t,i,I,F)}get rawFilterItems(){return this._rawFilterItems$.getValue()}get filterItems(){return this._filterItems}get treeMapCache(){return this._treeMapCache}dispose(){this._rawFilterItems$.complete(),this._searchString$.complete()}deltaCol(e){this.col+=e}setSearchString(e){this._searchString$.next(e)}onCheckAllToggled(e){const t=Fe.deepClone(this._filterItems);t.forEach(i=>ve(i,e)),this._manuallyUpdateFilterItems(t)}onFilterCheckToggled(e){const t=Fe.deepClone(this._filterItems),i=ze(t,e.key);if(!i)return;const s=Qt(i);ve(i,!s),this._manuallyUpdateFilterItems(t)}onFilterOnly(e){const t=Fe.deepClone(this._filterItems);t.forEach(i=>ve(i,!1)),e.forEach(i=>{const s=ze(t,i);s&&ve(s,!0)}),this._manuallyUpdateFilterItems(t)}_manuallyUpdateFilterItems(e){this._manuallyUpdateFilterItems$.next(e)}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;const e=qe(this._filterItems),{checked:t,checkedItems:i}=e,s=this.rawFilterItems;let o=0;for(const a of s)o+=a.count;const n=t===0,r=e.checked===o,l={colId:this.col};if(n)throw new Error("[ByValuesModel]: no checked items!");if(r)return this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});{l.filters={};const a=i.filter(c=>c.key!=="empty");a.length>0&&(l.filters={filters:a.flatMap(c=>c.originValues?Array.from(c.originValues):[c.title])}),a.length!==i.length&&(l.filters.blank=!0)}return this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:l})}};ye=He([Ce(4,W)],ye);let Re=class extends ce{constructor(e,t,i,s,o){super(),p(this,"canApply$",ue(!0)),p(this,"_cellFillColors$"),p(this,"cellFillColors$"),p(this,"_cellTextColors$"),p(this,"cellTextColors$"),this._filterModel=e,this.col=t,this._commandService=o,this._cellFillColors$=new B(Array.from(i.values())),this.cellFillColors$=this._cellFillColors$.asObservable(),this._cellTextColors$=new B(Array.from(s.values())),this.cellTextColors$=this._cellTextColors$.asObservable()}static async fromFilterColumn(e,t,i){var s,o,n;const r=e.get(Ue),{unitId:l,subUnitId:a}=t,c=r.getUniverSheetInstance(l);if(!c)throw new Error(`[ByColorsModel]: Workbook not found for filter model with unitId: ${l}!`);const d=c==null?void 0:c.getSheetBySheetId(a);if(!d)throw new Error(`[ByColorsModel]: Worksheet not found for filter model with unitId: ${l} and subUnitId: ${a}!`);const v=t.getRange(),f=i,g=(s=t.getFilterColumn(i))==null?void 0:s.getColumnData().colorFilters,E=t.getFilteredOutRowsExceptCol(i),C={...v,startRow:v.startRow+1,startColumn:f,endColumn:f},N=new Map,y=new Set((o=g==null?void 0:g.cellFillColors)!=null?o:[]),I=new Map,F=new Set((n=g==null?void 0:g.cellTextColors)!=null?n:[]);for(const b of d.iterateByColumn(C,!1,!0)){const{row:X,col:V,value:K}=b;if(E.has(X))continue;const L=d.getComposedCellStyleByCellData(X,V,K);if(L.bg&&L.bg.rgb){const A=new ht(L.bg.rgb).toRgbString();N.has(A)||N.set(A,{color:A,checked:y.has(A)})}else N.set("default-fill-color",{color:null,checked:y.has(null)});if(L.cl&&L.cl.rgb){const A=new ht(L.cl.rgb).toRgbString();I.has(A)||I.set(A,{color:A,checked:F.has(A)})}else I.set("default-font-color",{color:ft,checked:F.has(ft)})}return e.createInstance(Re,t,i,N,I)}get cellFillColors(){return this._cellFillColors$.getValue()}get cellTextColors(){return this._cellTextColors$.getValue()}dispose(){super.dispose(),this._cellFillColors$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}onFilterCheckToggled(e,t=!0){const i=t?this.cellFillColors:this.cellTextColors,s=[];let o=!1;for(let n=0;n<i.length;n++){const r=i[n];if(r.color===e.color){o=!0,s.push({color:r.color,checked:!r.checked});continue}s.push({color:r.color,checked:r.checked})}o&&(this._resetColorsCheckedStatus(!t),t?this._cellFillColors$.next([...s]):this._cellTextColors$.next([...s]))}_resetColorsCheckedStatus(e=!0){const t=e?this.cellFillColors:this.cellTextColors,i=[];for(let s=0;s<t.length;s++)i.push({color:t[s].color,checked:!1});e?this._cellFillColors$.next([...i]):this._cellTextColors$.next([...i])}async apply(){if(this._disposed)return!1;const e=this.cellFillColors.filter(s=>s.checked).map(s=>s.color),t=this.cellTextColors.filter(s=>s.checked).map(s=>s.color);if(e.length===0&&t.length===0)return this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});const i={colId:this.col};return e.length>0?i.colorFilters={cellFillColors:e}:t.length>0&&(i.colorFilters={cellTextColors:t}),this._commandService.executeCommand(D.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:i})}};Re=He([Ce(4,W)],Re);const ne="FILTER_PANEL_OPENED",Ae={id:"sheet.operation.open-filter-panel",type:Pe.OPERATION,handler:(e,t)=>{const i=e.get(ke),s=e.get(z),o=e.get(Z),n=e.get(W),r=e.has(mt)?e.get(mt):null;r!=null&&r.isVisible().visible&&n.syncExecuteCommand(Fr.id,{visible:!1});const{unitId:l,subUnitId:a,col:c}=t,d=s.getFilterModel(l,a);return d?(o.setupCol(d,c),i.getContextValue(ne)||i.setContextValue(ne,!0),!0):!1}},_e={id:"sheet.operation.close-filter-panel",type:Pe.OPERATION,handler:e=>{const t=e.get(ke),i=e.get(Z),s=e.get(Nr,xt.OPTIONAL);return t.getContextValue(ne)?(t.setContextValue(ne,!1),s==null||s.focus(),i.terminate()):!1}},Gt={id:"sheet.operation.apply-filter",type:Pe.OPERATION,handler:(e,t)=>{const{filterBy:i}=t;return e.get(Z).changeFilterBy(i)}},Yt="sheets-filter-ui.config",we={};var di=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},le=(e,t)=>(i,s)=>t(i,s,e);let ae=class extends ce{constructor(e,t,i,s,o,n){super(),this._sheetsFilterService=e,this._localeService=t,this._commandService=i,this._sheetPermissionCheckPermission=s,this._injector=o,this._sheetsSelectionService=n,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{var t,i,s;if(e.id===Se.id){const o=this._injector.get(Ue),n=xr(o);if(!n)return;const{unitId:r,subUnitId:l,worksheet:a}=n,c=(t=this._sheetsFilterService.getFilterModel(r,l))==null?void 0:t.getRange();let d;if(c)d=this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[pe],worksheetTypes:[me,fe]},[c]);else{const v=(i=this._sheetsSelectionService.getCurrentLastSelection())==null?void 0:i.range;if(v){let f={...v};f=v.startColumn===v.endColumn&&v.startRow===v.endRow?Or(f,{left:!0,right:!0,up:!0,down:!0},a):f,d=this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[pe],worksheetTypes:[fe,me]},[f],r,l)}else d=this._sheetPermissionCheckPermission.permissionCheckWithoutRange({rangeTypes:[pe],worksheetTypes:[fe,me]})}d||this._sheetPermissionCheckPermission.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.filterErr"))}if(e.id===Ae.id){const o=e.params,{unitId:n,subUnitId:r}=o,l=(s=this._sheetsFilterService.getFilterModel(n,r))==null?void 0:s.getRange(),a=Fe.deepClone(l);a&&(a.startColumn=o.col,a.endColumn=o.col,this._sheetPermissionCheckPermission.permissionCheckWithRanges({rangeTypes:[pe],worksheetTypes:[me,fe]},[a])||this._sheetPermissionCheckPermission.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.filterErr")))}}))}};ae=di([le(0,T(z)),le(1,T(Q)),le(2,W),le(3,T(Gr)),le(4,T(ie)),le(5,T(Yr))],ae);const q=16,mi=new Path2D("M3.30363 3C2.79117 3 2.51457 3.60097 2.84788 3.99024L6.8 8.60593V12.5662C6.8 12.7184 6.8864 12.8575 7.02289 12.9249L8.76717 13.7863C8.96655 13.8847 9.2 13.7396 9.2 13.5173V8.60593L13.1521 3.99024C13.4854 3.60097 13.2088 3 12.6964 3H3.30363Z");class Et{static drawNoCriteria(t,i,s,o){t.save(),vt.drawWith(t,{radius:2,width:q,height:q,fill:o}),t.lineCap="square",t.strokeStyle=s,t.scale(i/q,i/q),t.beginPath(),t.lineWidth=1,t.lineCap="round",t.moveTo(3,4),t.lineTo(13,4),t.moveTo(4.5,8),t.lineTo(11.5,8),t.moveTo(6,12),t.lineTo(10,12),t.stroke(),t.restore()}static drawHasCriteria(t,i,s,o){t.save(),vt.drawWith(t,{radius:2,width:q,height:q,fill:o}),t.scale(i/q,i/q),t.fillStyle=s,t.fill(mi),t.restore()}}var fi=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},Ge=(e,t)=>(i,s)=>t(i,s,e);const j=16,ge=1;let Xe=class extends Wr{constructor(e,t,i,s,o){super(e,t),p(this,"_cellWidth",0),p(this,"_cellHeight",0),p(this,"_filterParams"),p(this,"_hovered",!1),this._contextService=i,this._commandService=s,this._themeService=o,this.setShapeProps(t),this.onPointerDown$.subscribeEvent(n=>this.onPointerDown(n)),this.onPointerEnter$.subscribeEvent(()=>this.onPointerEnter()),this.onPointerLeave$.subscribeEvent(()=>this.onPointerLeave())}setShapeProps(e){typeof e.cellHeight<"u"&&(this._cellHeight=e.cellHeight),typeof e.cellWidth<"u"&&(this._cellWidth=e.cellWidth),typeof e.filterParams<"u"&&(this._filterParams=e.filterParams),this.transformByState({width:e.width,height:e.height})}_draw(e){const t=this._cellHeight,i=this._cellWidth,s=j-i,o=j-t;e.save();const n=new Path2D;n.rect(s,o,i,t),e.clip(n);const{hasCriteria:r}=this._filterParams,l=this._themeService.getColorFromTheme("primary.600"),a=this._hovered?this._themeService.getColorFromTheme("gray.50"):"rgba(255, 255, 255, 1.0)";r?Et.drawHasCriteria(e,j,l,a):Et.drawNoCriteria(e,j,l,a),e.restore()}onPointerDown(e){if(e.button===2)return;const{col:t,unitId:i,subUnitId:s}=this._filterParams;this._contextService.getContextValue(ne)||!this._commandService.hasCommand(Ae.id)||setTimeout(()=>{this._commandService.executeCommand(Ae.id,{unitId:i,subUnitId:s,col:t})},200)}onPointerEnter(){this._hovered=!0,this.makeDirty(!0)}onPointerLeave(){this._hovered=!1,this.makeDirty(!0)}};Xe=fi([Ge(2,ke),Ge(3,W),Ge(4,T($t))],Xe);var pi=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},te=(e,t)=>(i,s)=>t(i,s,e);const vi=1e3,_i=5e3;function gi(e,t,i,s){switch(s){case be.TOP:return e+ge;case be.MIDDLE:return e+Math.max(0,(i-j)/2);case be.BOTTOM:default:return t-j-ge}}let Ke=class extends Rt{constructor(e,t,i,s,o,n,r,l){super(),p(this,"_filterRangeShape",null),p(this,"_buttonRenderDisposable",null),p(this,"_filterButtonShapes",[]),this._context=e,this._injector=t,this._sheetSkeletonManagerService=i,this._sheetsFilterService=s,this._themeService=o,this._sheetInterceptorService=n,this._commandService=r,this._selectionRenderService=l,this._initRenderer()}dispose(){super.dispose(),this._disposeRendering()}_initRenderer(){this._sheetSkeletonManagerService.currentSkeleton$.pipe(rt(e=>{var t,i;if(!e)return ue(null);const{unit:s,unitId:o}=this._context,n=((t=s.getActiveSheet())==null?void 0:t.getSheetId())||"",r=(i=this._sheetsFilterService.getFilterModel(o,n))!=null?i:void 0,l=()=>({unitId:o,worksheetId:n,filterModel:r,range:r==null?void 0:r.getRange(),skeleton:e.skeleton});return cr(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(ur(([a])=>{var c;return a.type===Pe.MUTATION&&((c=a.params)==null?void 0:c.unitId)===s.getUnitId()&&(Tr.has(a.id)||a.id===Qr.id)}),Mt(20,void 0,{leading:!1,trailing:!0}),oe(l),Pt(l()))}),Ar(this.dispose$)).subscribe(e=>{this._disposeRendering(),!(!e||!e.range)&&(this._renderRange(e.range,e.skeleton),this._renderButtons(e))})}_renderRange(e,t){const{scene:i}=this._context,{rowHeaderWidth:s,columnHeaderHeight:o}=t,n=this._filterRangeShape=new wr(i,vi,this._themeService,{rowHeaderWidth:s,columnHeaderHeight:o,enableAutoFill:!1,highlightHeader:!1}),r=$r({range:e,primary:null,style:{fill:"rgba(0, 0, 0, 0.0)"}},t);n.updateRangeBySelectionWithCoord(r),n.setEvent(!1),i.makeDirty(!0)}_renderButtons(e){const{range:t,filterModel:i,unitId:s,skeleton:o,worksheetId:n}=e,{unit:r,scene:l}=this._context,a=r.getSheetBySheetId(n);if(!a)return;this._interceptCellContent(s,n,e.range);const{startColumn:c,endColumn:d,startRow:v}=t;for(let f=c;f<=d;f++){const g=`sheets-filter-button-${f}`,E=Lr(v,f,l,o),C=a.getComposedCellStyle(v,f),N=(C==null?void 0:C.vt)||be.BOTTOM,{startX:y,startY:I,endX:F,endY:b}=E,X=F-y,V=b-I;if(V<=ge||X<=ge)continue;const K=!!i.getFilterColumn(f),L=F-j-ge,A=gi(I,b,V,N),w={left:L,top:A,height:j,width:j,zIndex:_i,cellHeight:V,cellWidth:X,filterParams:{unitId:s,subUnitId:n,col:f,hasCriteria:K}},je=this._injector.createInstance(Xe,g,w);this._filterButtonShapes.push(je)}l.addObjects(this._filterButtonShapes),l.makeDirty()}_interceptCellContent(e,t,i){const{startRow:s,startColumn:o,endColumn:n}=i;this._buttonRenderDisposable=this._sheetInterceptorService.intercept(Mr.CELL_CONTENT,{effect:hr.Style,handler:(r,l,a)=>{const{row:c,col:d,unitId:v,subUnitId:f}=l;return v!==e||f!==t||c!==s||d<o||d>n||((!r||r===l.rawData)&&(r={...l.rawData}),r.fontRenderExtension={...r==null?void 0:r.fontRenderExtension,rightOffset:j}),a(r)},priority:10})}_disposeRendering(){var e,t;(e=this._filterRangeShape)==null||e.dispose(),this._filterButtonShapes.forEach(i=>i.dispose()),(t=this._buttonRenderDisposable)==null||t.dispose(),this._filterRangeShape=null,this._buttonRenderDisposable=null,this._filterButtonShapes=[]}};Ke=pi([te(1,T(ie)),te(2,T(qr)),te(3,T(z)),te(4,T($t)),te(5,T(Zr)),te(6,W),te(7,zr)],Ke);var Ci=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},St=(e,t)=>(i,s)=>t(i,s,e);let Ee=class extends Rt{constructor(e,t){super(),this._renderManagerService=e,this._sheetsRenderService=t,[pr,vr,_r,gr].forEach(i=>this.disposeWithMe(this._sheetsRenderService.registerSkeletonChangingMutations(i.id))),this.disposeWithMe(this._renderManagerService.registerRenderModule(re.UNIVER_SHEET,[Ke]))}};Ee=Ci([St(0,Ht),St(1,T(jt))],Ee);var Ei=Object.defineProperty,Si=(e,t,i)=>t in e?Ei(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ti=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},Tt=(e,t)=>(i,s)=>t(i,s,e),qt=(e,t,i)=>Si(e,typeof t!="symbol"?t+"":t,i);const Ni="SHEET_FILTER_UI_PLUGIN";let $e=class extends Je{constructor(e=we,t,i){super(),this._config=e,this._injector=t,this._configService=i;const{menu:s,...o}=Ot({},we,this._config);s&&this._configService.setConfig("menu",s,{merge:!0}),this._configService.setConfig(Yt,o)}onStarting(){[[ae],[Ee]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(ae)}onRendered(){this._injector.get(Ee)}};qt($e,"type",re.UNIVER_SHEET);qt($e,"pluginName",Ni);$e=Ti([At(Lt),Tt(1,T(ie)),Tt(2,wt)],$e);function he({ref:e,...t}){const{icon:i,id:s,className:o,extend:n,...r}=t,l=`univerjs-icon univerjs-icon-${s} ${o||""}`.trim(),a=S.useRef(`_${Ii()}`);return Zt(i,`${s}`,{defIds:i.defIds,idSuffix:a.current},{ref:e,className:l,...r},n)}function Zt(e,t,i,s,o){return S.createElement(e.tag,{key:t,...Fi(e,i,o),...s},(bi(e,i).children||[]).map((n,r)=>Zt(n,`${t}-${e.tag}-${r}`,i,void 0,o)))}function Fi(e,t,i){const s={...e.attrs};i!=null&&i.colorChannel1&&s.fill==="colorChannel1"&&(s.fill=i.colorChannel1),e.tag==="mask"&&s.id&&(s.id=s.id+t.idSuffix),Object.entries(s).forEach(([n,r])=>{n==="mask"&&typeof r=="string"&&(s[n]=r.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))});const{defIds:o}=t;return!o||o.length===0||(e.tag==="use"&&s["xlink:href"]&&(s["xlink:href"]=s["xlink:href"]+t.idSuffix),Object.entries(s).forEach(([n,r])=>{typeof r=="string"&&(s[n]=r.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))})),s}function bi(e,t){var i;const{defIds:s}=t;return!s||s.length===0?e:e.tag==="defs"&&(i=e.children)!=null&&i.length?{...e,children:e.children.map(o=>typeof o.attrs.id=="string"&&s&&s.includes(o.attrs.id)?{...o,attrs:{...o.attrs,id:o.attrs.id+t.idSuffix}}:o)}:e}function Ii(){return Math.random().toString(36).substring(2,8)}he.displayName="UniverIcon";const xi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 20",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M10 1.05957C10.356 1.05957 10.6816 1.26162 10.8408 1.58008L18.8408 17.5801L18.8799 17.668C19.0486 18.1134 18.8551 18.6232 18.4199 18.8408C17.9557 19.0727 17.3913 18.8841 17.1592 18.4199L10 4.10156L2.84082 18.4199C2.60871 18.8841 2.04434 19.0727 1.58008 18.8408C1.11587 18.6087 0.92731 18.0443 1.15918 17.5801L9.15918 1.58008C9.31841 1.26162 9.64395 1.05957 10 1.05957Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M15.3337 11.7261L15.4294 11.731C15.9035 11.779 16.2732 12.1798 16.2732 12.6665C16.2732 13.1532 15.9035 13.554 15.4294 13.602L15.3337 13.6069H4.66675C4.1476 13.6069 3.72632 13.1856 3.72632 12.6665C3.72632 12.1474 4.1476 11.7261 4.66675 11.7261H15.3337Z"}}]},zt=S.forwardRef(function(e,t){return S.createElement(he,Object.assign({},e,{id:"a-icon",ref:t,icon:xi}))});zt.displayName="AIcon";const Oi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 20",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M17.0596 10C17.0596 6.10087 13.8992 2.94043 10 2.94043C6.10087 2.94043 2.94043 6.10087 2.94043 10C2.94043 13.8992 6.10087 17.0596 10 17.0596C13.8992 17.0596 17.0596 13.8992 17.0596 10ZM18.9404 10C18.9404 14.9374 14.9374 18.9404 10 18.9404C5.06257 18.9404 1.05957 14.9374 1.05957 10C1.05957 5.06257 5.06257 1.05957 10 1.05957C14.9374 1.05957 18.9404 5.06257 18.9404 10Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.29492 4.13476C4.63911 3.79057 5.1845 3.76906 5.55371 4.07031L5.625 4.13476L16.0244 14.5352L16.0889 14.6064C16.3902 14.9757 16.3686 15.52 16.0244 15.8643C15.6573 16.2313 15.0624 16.2313 14.6953 15.8643L4.29492 5.46484L4.23047 5.39355C3.92922 5.02434 3.95073 4.47895 4.29492 4.13476Z"}}]},Xt=S.forwardRef(function(e,t){return S.createElement(he,Object.assign({},e,{id:"ban-icon",ref:t,icon:Oi}))});Xt.displayName="BanIcon";const yi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.32182 2.60967C2.98161 2.60967 2.79671 3.0074 3.01601 3.2675L6.85819 7.8246C6.94943 7.93282 6.99947 8.06981 6.99947 8.21136V12.7338C6.99947 12.898 7.0998 13.0455 7.2525 13.1058L8.73833 13.6928C9.00085 13.7965 9.28531 13.6031 9.28531 13.3208V8.21136C9.28531 8.06981 9.33535 7.93282 9.42659 7.8246L13.2688 3.2675C13.4881 3.0074 13.3032 2.60967 12.963 2.60967H3.32182ZM2.09858 4.04101C1.22139 3.0006 1.96097 1.40967 3.32182 1.40967H12.963C14.3238 1.40967 15.0634 3.0006 14.1862 4.04101L10.4853 8.43054V13.3208C10.4853 14.4498 9.34747 15.2237 8.29742 14.8089L6.81158 14.2219C6.20078 13.9806 5.79947 13.3905 5.79947 12.7338V8.43054L2.09858 4.04101Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Kt=S.forwardRef(function(e,t){return S.createElement(he,Object.assign({},e,{id:"filter-icon",ref:t,icon:yi}))});Kt.displayName="FilterIcon";const Ri={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.00016 1.33203C6.68162 1.33203 5.39269 1.72302 4.29636 2.45557C3.20004 3.18811 2.34555 4.2293 1.84097 5.44747C1.33638 6.66565 1.20436 8.00609 1.4616 9.2993C1.71883 10.5925 2.35377 11.7804 3.28612 12.7127C4.21847 13.6451 5.40636 14.28 6.69956 14.5373C7.99277 14.7945 9.33321 14.6625 10.5514 14.1579C11.7696 13.6533 12.8108 12.7988 13.5433 11.7025C14.2758 10.6062 14.6668 9.31724 14.6668 7.9987C14.6649 6.23118 13.9619 4.53662 12.7121 3.2868C11.4622 2.03697 9.76768 1.33397 8.00016 1.33203ZM7.66683 3.9987C7.86461 3.9987 8.05795 4.05735 8.2224 4.16723C8.38685 4.27711 8.51502 4.43329 8.59071 4.61601C8.6664 4.79874 8.6862 4.99981 8.64762 5.19379C8.60903 5.38777 8.51379 5.56595 8.37394 5.7058C8.23409 5.84566 8.0559 5.9409 7.86192 5.97948C7.66794 6.01807 7.46687 5.99826 7.28415 5.92258C7.10142 5.84689 6.94524 5.71872 6.83536 5.55427C6.72548 5.38982 6.66683 5.19648 6.66683 4.9987C6.66683 4.73348 6.77219 4.47913 6.95972 4.29159C7.14726 4.10405 7.40162 3.9987 7.66683 3.9987ZM9.3335 11.332H6.66683C6.49002 11.332 6.32045 11.2618 6.19543 11.1368C6.0704 11.0117 6.00016 10.8422 6.00016 10.6654C6.00016 10.4886 6.0704 10.319 6.19543 10.194C6.32045 10.0689 6.49002 9.9987 6.66683 9.9987H7.3335V7.9987H6.66683C6.49002 7.9987 6.32045 7.92846 6.19543 7.80343C6.0704 7.67841 6.00016 7.50884 6.00016 7.33203C6.00016 7.15522 6.0704 6.98565 6.19543 6.86063C6.32045 6.7356 6.49002 6.66536 6.66683 6.66536H8.00016C8.17698 6.66536 8.34655 6.7356 8.47157 6.86063C8.59659 6.98565 8.66683 7.15522 8.66683 7.33203V9.9987H9.3335C9.51031 9.9987 9.67988 10.0689 9.8049 10.194C9.92993 10.319 10.0002 10.4886 10.0002 10.6654C10.0002 10.8422 9.92993 11.0117 9.8049 11.1368C9.67988 11.2618 9.51031 11.332 9.3335 11.332Z"}}]},Jt=S.forwardRef(function(e,t){return S.createElement(he,Object.assign({},e,{id:"info-icon",ref:t,icon:Ri}))});Jt.displayName="InfoIcon";const Ai={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8 15C11.866 15 15 11.866 15 8C15 4.13401 11.866 1 8 1C4.13401 1 1 4.13401 1 8C1 11.866 4.13401 15 8 15ZM11.7245 6.42417C11.9588 6.18985 11.9588 5.80995 11.7245 5.57564C11.4901 5.34132 11.1102 5.34132 10.8759 5.57564L7.3002 9.15137L5.72446 7.57564C5.49014 7.34132 5.11025 7.34132 4.87593 7.57564C4.64162 7.80995 4.64162 8.18985 4.87593 8.42417L6.87593 10.4242C7.11025 10.6585 7.49014 10.6585 7.72446 10.4242L11.7245 6.42417Z",fillRule:"evenodd",clipRule:"evenodd"}}]},er=S.forwardRef(function(e,t){return S.createElement(he,Object.assign({},e,{id:"success-icon",ref:t,icon:Ai}))});er.displayName="SuccessIcon";function wi(e){const{model:t}=e,i=H(Q),s=M(t.cellFillColors$,[],!0),o=M(t.cellTextColors$,[],!0),n=S.useCallback(l=>{t.onFilterCheckToggled(l)},[t]),r=S.useCallback(l=>{t.onFilterCheckToggled(l,!1)},[t]);return h.jsx("div",{"data-u-comp":"sheets-filter-panel-colors-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:h.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:Ie("univer-mt-2 univer-box-border univer-flex univer-h-[300px] univer-flex-grow univer-flex-col univer-gap-4 univer-overflow-auto univer-rounded-md univer-px-2 univer-py-2.5",lt),children:[s.length>1&&h.jsxs("div",{children:[h.jsx("div",{className:"univer-mb-2 univer-text-sm univer-text-gray-900 dark:!univer-text-white",children:i.t("sheets-filter.panel.filter-by-cell-fill-color")}),h.jsx("div",{className:"univer-grid univer-grid-cols-8 univer-items-center univer-justify-start univer-gap-2",children:s.map((l,a)=>h.jsxs("div",{className:"univer-relative univer-h-6 univer-w-6",onClick:()=>n(l),children:[l.color?h.jsx("button",{type:"button",className:Ie("univer-box-border univer-h-6 univer-w-6 univer-cursor-pointer univer-rounded-full univer-border univer-border-solid univer-border-transparent univer-bg-gray-300 univer-transition-shadow hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white"),style:{backgroundColor:l.color}}):h.jsx(Xt,{className:"univer-h-6 univer-w-6 univer-cursor-pointer univer-rounded-full hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white"}),l.checked&&h.jsx(Nt,{})]},`sheets-filter-cell-fill-color-${a}`))})]}),o.length>1&&h.jsxs("div",{children:[h.jsx("div",{className:"univer-mb-2 univer-text-sm univer-text-gray-900 dark:!univer-text-white",children:i.t("sheets-filter.panel.filter-by-cell-text-color")}),h.jsx("div",{className:"univer-grid univer-grid-cols-8 univer-items-center univer-justify-start univer-gap-2",children:o.map((l,a)=>h.jsxs("div",{className:"univer-relative univer-h-6 univer-w-6",onClick:()=>r(l),children:[h.jsx("div",{className:"univer-box-border univer-flex univer-h-full univer-w-full univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-full univer-border univer-border-solid univer-border-[rgba(13,13,13,0.06)] univer-p-0.5 hover:univer-ring-2 hover:univer-ring-offset-2 hover:univer-ring-offset-white dark:!univer-border-[rgba(255,255,255,0.06)]",children:h.jsx(zt,{style:{color:l.color}})}),l.checked&&h.jsx(Nt,{})]},`sheets-filter-cell-text-color-${a}`))})]}),s.length<=1&&o.length<=1&&h.jsx("div",{className:"univer-flex univer-h-full univer-w-full univer-items-center univer-justify-center univer-text-sm univer-text-gray-900 dark:!univer-text-gray-200",children:i.t("sheets-filter.panel.filter-by-color-none")})]})})}function Nt(){return h.jsx("div",{className:"univer-absolute -univer-bottom-0.5 -univer-right-0.5 univer-flex univer-h-3 univer-w-3 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-full univer-bg-white",children:h.jsx(er,{className:"univer-h-full univer-w-full univer-font-bold univer-text-[#418F1F]"})})}function $i(e){var t,i;const{model:s}=e,o=H(Q),n=M(s.conditionItem$,void 0),r=M(s.filterConditionFormParams$,void 0),l=r!=null&&r.and?"AND":"OR",a=S.useCallback(C=>{s.onConditionFormChange({and:C==="AND"})},[s]),c=Li(o),d=S.useCallback(C=>{s.onPrimaryConditionChange(C)},[s]),v=Mi(o),f=S.useCallback(C=>{s.onConditionFormChange(C)},[s]),g=o.t("sheets-filter.panel.input-values-placeholder");function E(C,N,y){const I=m.getItemByOperator(C).numOfParameters===1;return h.jsxs(h.Fragment,{children:[y==="operator2"&&h.jsxs(oi,{value:l,onChange:a,children:[h.jsx(gt,{value:"AND",children:o.t("sheets-filter.panel.and")}),h.jsx(gt,{value:"OR",children:o.t("sheets-filter.panel.or")})]}),h.jsx(_t,{value:C,options:v,onChange:F=>f({[y]:F})}),I&&h.jsx("div",{children:h.jsx(Dt,{className:"univer-mt-2",value:N,placeholder:g,onChange:F=>f({[y==="operator1"?"val1":"val2"]:F})})})]})}return h.jsx("div",{"data-u-comp":"sheets-filter-panel-conditions-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:n&&r&&h.jsxs(h.Fragment,{children:[h.jsx(_t,{value:n.operator,options:c,onChange:d}),m.getItemByOperator(n.operator).numOfParameters!==0?h.jsxs("div",{"data-u-comp":"sheets-filter-panel-conditions-container-inner",className:Ie("univer-mt-2 univer-flex-grow univer-overflow-hidden univer-rounded-md univer-p-2",lt),children:[n.numOfParameters>=1&&E(r.operator1,(t=r.val1)!=null?t:"","operator1"),n.numOfParameters>=2&&E(r.operator2,(i=r.val2)!=null?i:"","operator2"),h.jsxs("div",{"data-u-comp":"sheets-filter-panel-conditions-desc",className:"univer-mt-2 univer-text-xs univer-text-gray-500",children:[o.t("sheets-filter.panel.?"),h.jsx("br",{}),o.t("sheets-filter.panel.*")]})]}):null]})})}function Li(e){const t=e.getCurrentLocale();return S.useMemo(()=>[{options:[{label:e.t(m.NONE.label),value:m.NONE.operator}]},{options:[{label:e.t(m.EMPTY.label),value:m.EMPTY.operator},{label:e.t(m.NOT_EMPTY.label),value:m.NOT_EMPTY.operator}]},{options:[{label:e.t(m.TEXT_CONTAINS.label),value:m.TEXT_CONTAINS.operator},{label:e.t(m.DOES_NOT_CONTAIN.label),value:m.DOES_NOT_CONTAIN.operator},{label:e.t(m.STARTS_WITH.label),value:m.STARTS_WITH.operator},{label:e.t(m.ENDS_WITH.label),value:m.ENDS_WITH.operator},{label:e.t(m.EQUALS.label),value:m.EQUALS.operator}]},{options:[{label:e.t(m.GREATER_THAN.label),value:m.GREATER_THAN.operator},{label:e.t(m.GREATER_THAN_OR_EQUAL.label),value:m.GREATER_THAN_OR_EQUAL.operator},{label:e.t(m.LESS_THAN.label),value:m.LESS_THAN.operator},{label:e.t(m.LESS_THAN_OR_EQUAL.label),value:m.LESS_THAN_OR_EQUAL.operator},{label:e.t(m.EQUAL.label),value:m.EQUAL.operator},{label:e.t(m.NOT_EQUAL.label),value:m.NOT_EQUAL.operator},{label:e.t(m.BETWEEN.label),value:m.BETWEEN.operator},{label:e.t(m.NOT_BETWEEN.label),value:m.NOT_BETWEEN.operator}]},{options:[{label:e.t(m.CUSTOM.label),value:m.CUSTOM.operator}]}],[t,e])}function Mi(e){const t=e.getCurrentLocale();return S.useMemo(()=>m.ALL_CONDITIONS.filter(i=>i.numOfParameters!==2).map(i=>({label:e.t(i.label),value:i.operator})),[t,e])}function Pi(e){const{model:t}=e,i=H(Q),s=M(t.searchString$,"",!0),o=M(t.filterItems$,void 0,!0),n=i.t("sheets-filter.panel.filter-only"),r=qe(o),l=r.checked>0&&r.unchecked===0,a=r.checked>0&&r.unchecked>0,c=t.treeMapCache,d=S.useCallback(()=>{t.onCheckAllToggled(!l)},[t,l]),v=S.useCallback(g=>{t.setSearchString(g)},[t]);function f(g){let E=[];return g.forEach(C=>{C.checked&&E.push(C.key),C.children&&(E=E.concat(f(C.children)))}),E}return h.jsxs("div",{"data-u-comp":"sheets-filter-panel-values-container",className:"univer-flex univer-h-full univer-min-h-[300px] univer-flex-col",children:[h.jsx(Dt,{autoFocus:!0,value:s,placeholder:i.t("sheets-filter.panel.search-placeholder"),onChange:v}),h.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:Ie("univer-mt-2 univer-box-border univer-flex univer-flex-grow univer-flex-col univer-overflow-hidden univer-rounded-md univer-px-2 univer-py-2.5",lt),children:[h.jsx("div",{"data-u-comp":"sheets-filter-panel-values-item",className:"univer-box-border univer-h-8 univer-w-full univer-py-0.5",children:h.jsxs("div",{"data-u-comp":"sheets-filter-panel-values-item-inner",className:"univer-box-border univer-flex univer-h-7 univer-items-center univer-rounded-md univer-pb-0 univer-pl-5 univer-pr-0.5 univer-pt-0 univer-text-sm",children:[h.jsx(ri,{indeterminate:a,disabled:o.length===0,checked:l,onChange:d}),h.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-text",className:"univer-mx-1 univer-inline-block univer-flex-shrink univer-truncate univer-text-gray-900 dark:!univer-text-white",children:`${i.t("sheets-filter.panel.select-all")}`}),h.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-count",className:"univer-text-gray-400 dark:!univer-text-gray-500",children:`(${r.checked}/${r.checked+r.unchecked})`})]})}),h.jsx("div",{"data-u-comp":"sheets-filter-panel-values-virtual",className:"univer-flex-grow",children:h.jsx(ii,{data:o,defaultExpandAll:!1,valueGroup:f(o),onChange:g=>{t.onFilterCheckToggled(g)},defaultCache:c,itemHeight:28,treeNodeClassName:`
                          univer-pr-2 univer-border-box univer-rounded-md
                          [&:hover_a]:univer-inline-block
                          hover:univer-bg-gray-50 univer-h-full
                          univer-text-gray-900 dark:hover:!univer-bg-gray-900
                          dark:!univer-text-white
                        `,attachRender:g=>h.jsxs("div",{className:"univer-ml-1 univer-flex univer-h-5 univer-flex-1 univer-cursor-pointer univer-items-center univer-justify-between univer-text-sm univer-text-primary-500",children:[h.jsx("span",{"data-u-comp":"sheets-filter-panel-values-item-count",className:"univer-text-gray-400 dark:!univer-text-gray-500",children:`(${g.count})`}),h.jsx("a",{className:"univer-box-border univer-hidden univer-h-4 univer-whitespace-nowrap univer-px-1.5",onClick:()=>{const E=[];g.children?g.children.forEach(C=>{C.children?C.children.forEach(N=>{E.push(N.key)}):E.push(C.key)}):E.push(g.key),t.onFilterOnly(E)},children:n})]})})})]})]})}function ki(){const e=H(Sr);if(!M(e.visible$,void 0,!0))return null;const t=H(Q),i=H(kt),s=M(e.enabled$,void 0,!0);return h.jsxs("div",{className:"univer-mt-2 univer-flex univer-items-center univer-justify-between univer-text-sm univer-text-gray-900 dark:!univer-text-gray-200",children:[h.jsxs("div",{className:"univer-flex univer-items-center univer-gap-1",children:[h.jsx("span",{children:t.t("sheets-filter.sync.title")}),h.jsx(si,{title:s?t.t("sheets-filter.sync.statusTips.off"):t.t("sheets-filter.sync.statusTips.on"),asChild:!0,children:h.jsx(Jt,{className:"univer-block"})})]}),h.jsx(li,{defaultChecked:s,onChange:o=>{const n=o?t.t("sheets-filter.sync.switchTips.on"):t.t("sheets-filter.sync.switchTips.off");e.setEnabled(o),i.show({content:n,type:Bt.Success,duration:2e3})}})]})}function Ui(){var e;const t=H(Z),i=H(Q),s=H(W),o=M(t.filterBy$,void 0,!0),n=M(t.filterByModel$,void 0,!1),r=M(()=>(n==null?void 0:n.canApply$)||ue(!1),void 0,!1,[n]),l=Hi(i),a=!M(t.hasCriteria$),c=S.useCallback(N=>{s.executeCommand(Gt.id,{filterBy:N})},[s]),d=S.useCallback(async()=>{await(n==null?void 0:n.clear()),s.executeCommand(_e.id)},[n,s]),v=S.useCallback(()=>{s.executeCommand(_e.id)},[s]),f=S.useCallback(async()=>{await(n==null?void 0:n.apply()),s.executeCommand(_e.id)},[n,s]),g=(e=H(z).activeFilterModel)==null?void 0:e.getRange(),E=t.col,C=jr(Br.FILTER_PANEL_EMBED_POINT);return h.jsxs("div",{"data-u-comp":"sheets-filter-panel",className:"univer-box-border univer-flex univer-max-h-[500px] univer-w-[400px] univer-flex-col univer-rounded-lg univer-bg-white univer-p-4 univer-shadow-lg dark:!univer-border-gray-600 dark:!univer-bg-gray-700",children:[h.jsx(Dr,{components:C,sharedProps:{range:g,colIndex:E,onClose:v}}),h.jsx("div",{className:"univer-mb-1 univer-flex-shrink-0 univer-flex-grow-0",children:h.jsx(ti,{value:o,items:l,onChange:N=>c(N)})}),n?h.jsx("div",{"data-u-comp":"sheets-filter-panel-content",className:"univer-flex-shrink univer-flex-grow univer-pt-2",children:o===R.VALUES?h.jsx(Pi,{model:n}):o===R.COLORS?h.jsx(wi,{model:n}):h.jsx($i,{model:n})}):h.jsx("div",{className:"univer-flex-1"}),h.jsx(ki,{}),h.jsxs("div",{"data-u-comp":"sheets-filter-panel-footer",className:"univer-mt-4 univer-inline-flex univer-flex-shrink-0 univer-flex-grow-0 univer-flex-nowrap univer-justify-between univer-overflow-hidden",children:[h.jsx(Qe,{variant:"link",onClick:d,disabled:a,children:i.t("sheets-filter.panel.clear-filter")}),h.jsxs("span",{className:"univer-flex univer-gap-2",children:[h.jsx(Qe,{variant:"default",onClick:v,children:i.t("sheets-filter.panel.cancel")}),h.jsx(Qe,{disabled:!r,variant:"primary",onClick:f,children:i.t("sheets-filter.panel.confirm")})]})]})]})}function Hi(e){const t=e.getCurrentLocale();return S.useMemo(()=>[{label:e.t("sheets-filter.panel.by-values"),value:R.VALUES},{label:e.t("sheets-filter.panel.by-colors"),value:R.COLORS},{label:e.t("sheets-filter.panel.by-conditions"),value:R.CONDITIONS}],[t,e])}function ji(e){const t=e.get(z);return{id:Se.id,type:st.BUTTON_SELECTOR,icon:"FilterIcon",tooltip:"sheets-filter.toolbar.smart-toggle-filter-tooltip",hidden$:it(e,re.UNIVER_SHEET),activated$:t.activeFilterModel$.pipe(oe(i=>!!i)),disabled$:Ur(e,Hr(e,{worksheetTypes:[me,fe],rangeTypes:[pe]}))}}function Bi(e){const t=e.get(z);return{id:et.id,type:st.BUTTON,title:"sheets-filter.toolbar.clear-filter-criteria",hidden$:it(e,re.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe(rt(i=>{var s;return(s=i==null?void 0:i.hasCriteria$.pipe(oe(o=>!o)))!=null?s:ue(!0)}))}}function Di(e){const t=e.get(z);return{id:tt.id,type:st.BUTTON,title:"sheets-filter.toolbar.re-calc-filter-conditions",hidden$:it(e,re.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe(rt(i=>{var s;return(s=i==null?void 0:i.hasCriteria$.pipe(oe(o=>!o)))!=null?s:ue(!0)}))}}const Wi={[kr.ORGANIZATION]:{[Se.id]:{order:2,menuItemFactory:ji,[et.id]:{order:0,menuItemFactory:Bi},[tt.id]:{order:1,menuItemFactory:Di}}}},Qi={id:Se.id,binding:Pr.L|pt.CTRL_COMMAND|pt.SHIFT,description:"sheets-filter.shortcut.smart-toggle-filter",preconditions:yr,group:"4_sheet-edit"};var Vi=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},$=(e,t)=>(i,s)=>t(i,s,e);const Ft="FILTER_PANEL_POPUP";let Le=class extends Ee{constructor(e,t,i,s,o,n,r,l,a,c,d,v,f){super(f,v),p(this,"_popupDisposable"),this._injector=e,this._componentManager=t,this._sheetsFilterPanelService=i,this._sheetCanvasPopupService=s,this._sheetsFilterService=o,this._localeService=n,this._shortcutService=r,this._commandService=l,this._menuManagerService=a,this._contextService=c,this._messageService=d,this._initCommands(),this._initShortcuts(),this._initMenuItems(),this._initUI()}dispose(){super.dispose(),this._closeFilterPopup()}_initShortcuts(){[Qi].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_initCommands(){[Se,Cr,Er,D,et,tt,Gt,Ae,_e].forEach(e=>{this.disposeWithMe(this._commandService.registerCommand(e))})}_initMenuItems(){this._menuManagerService.mergeMenu(Wi)}_initUI(){[[Ft,Ui],["FilterIcon",Kt]].forEach(([e,t])=>{this.disposeWithMe(this._componentManager.register(e,t))}),this.disposeWithMe(this._contextService.subscribeContextValue$(ne).pipe(lr()).subscribe(e=>{e?this._openFilterPopup():this._closeFilterPopup()})),this.disposeWithMe(this._sheetsFilterService.errorMsg$.subscribe(e=>{e&&this._messageService.show({type:Bt.Error,content:this._localeService.t(e)})}))}_openFilterPopup(){const e=this._sheetsFilterPanelService.filterModel;if(!e)throw new Error("[SheetsFilterUIController]: no filter model when opening filter popup!");const t=e.getRange(),i=this._sheetsFilterPanelService.col,{startRow:s}=t;this._popupDisposable=this._sheetCanvasPopupService.attachPopupToCell(s,i,{componentKey:Ft,direction:"horizontal",onClickOutside:()=>this._commandService.syncExecuteCommand(_e.id),offset:[5,0]})}_closeFilterPopup(){var e;(e=this._popupDisposable)==null||e.dispose(),this._popupDisposable=null}};Le=Vi([$(0,T(ie)),$(1,T(Xr)),$(2,T(Z)),$(3,T(Kr)),$(4,T(z)),$(5,T(Q)),$(6,Jr),$(7,W),$(8,ei),$(9,ke),$(10,kt),$(11,T(jt)),$(12,Ht)],Le);var Gi=Object.defineProperty,Yi=(e,t,i)=>t in e?Gi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,qi=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},Ye=(e,t)=>(i,s)=>t(i,s,e),tr=(e,t,i)=>Yi(e,typeof t!="symbol"?t+"":t,i);const Zi="SHEET_FILTER_UI_PLUGIN";let Me=class extends Je{constructor(e=we,t,i,s){super(),this._config=e,this._injector=t,this._configService=i,this._rpcChannelService=s;const{menu:o,...n}=Ot({},we,this._config);o&&this._configService.setConfig("menu",o,{merge:!0}),this._configService.setConfig(Yt,n)}onStarting(){ir(this._injector,[[Z],[ae],[Le]]),this._config.useRemoteFilterValuesGenerator&&this._rpcChannelService&&this._injector.add([xe,{useFactory:()=>br(this._rpcChannelService.requestChannel(ot))}])}onReady(){ut(this._injector,[[ae]])}onRendered(){ut(this._injector,[[Le]])}};tr(Me,"type",re.UNIVER_SHEET);tr(Me,"pluginName",Zi);Me=qi([At(Lt),Ye(1,T(ie)),Ye(2,wt),Ye(3,mr(Ut))],Me);var zi=(e,t,i,s)=>{for(var o=t,n=e.length-1,r;n>=0;n--)(r=e[n])&&(o=r(o)||o);return o},bt=(e,t)=>(i,s)=>t(i,s,e),Ne;let It=(Ne=class extends Je{constructor(e,t,i){super(),this._config=e,this._injector=t,this._rpcChannelService=i}onStarting(){[[xe,{useClass:Ze}]].forEach(e=>this._injector.add(e))}onReady(){this._rpcChannelService.registerChannel(ot,Ir(this._injector.get(xe)))}},p(Ne,"type",re.UNIVER_SHEET),p(Ne,"pluginName","SHEET_FILTER_UI_WORKER_PLUGIN"),Ne);It=zi([bt(1,T(ie)),bt(2,Ut)],It);export{Me as H,Ae as M,_e as S,$e as U,Gt as X,It as w};
