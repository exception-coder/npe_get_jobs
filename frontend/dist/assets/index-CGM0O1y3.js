import{M as u,aT as R,L as f,V as U,af as D,Q as b,dr as L,w as v,O as j,o as k,c4 as W,I as C,N as H,H as V,u as J,x as P}from"./TeamSpreadsheet-DqPQXi__.js";var Y=Object.defineProperty,K=(n,e,t)=>e in n?Y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,h=(n,e,t)=>K(n,typeof e!="symbol"?e+"":e,t);class Q extends U{constructor(){super(),h(this,"_dataSource",null),h(this,"syncUpdateMutationToColla",!0)}set dataSource(e){this._dataSource=e}get dataSource(){return this._dataSource}async getThreadComment(e,t,a){return this._dataSource?(await this._dataSource.listComments(e,t,[a]))[0]:null}async addComment(e){var t;return this._dataSource?this._dataSource.addComment(e):{...e,threadId:(t=e.threadId)!=null?t:e.id}}async updateComment(e){return this._dataSource?this._dataSource.updateComment(e):!0}async resolveComment(e){return this._dataSource?this._dataSource.resolveComment(e):!0}async deleteComment(e,t,a,r){return this._dataSource?this._dataSource.deleteComment(e,t,a,r):!0}async listThreadComments(e,t,a){return this.dataSource?this.dataSource.listComments(e,t,a):!1}saveToSnapshot(e,t){if(this._dataSource){const a={};return Object.keys(e).forEach(r=>{const o=e[r];a[r]=o.map(this.dataSource.saveCommentToSnapshot)}),a}return e}}const p=R("univer.thread-comment.data-source-service");var q=(n,e,t,a)=>{for(var r=e,o=n.length-1,s;o>=0;o--)(s=n[o])&&(r=s(r)||r);return r},E=(n,e)=>(t,a)=>e(t,a,n);let i=class extends U{constructor(n,e){super(),h(this,"_commentsMap",new Map),h(this,"_threadMap",new Map),h(this,"_commentUpdate$",new D),h(this,"commentUpdate$",this._commentUpdate$.asObservable()),h(this,"_tasks",[]),this._dataSourceService=n,this._lifecycleService=e,this.disposeWithMe(()=>{this._commentUpdate$.complete()}),this.disposeWithMe(this._lifecycleService.lifecycle$.subscribe(t=>{const a=new Map;t===b.Rendered&&(this._tasks.forEach(({unitId:r,subUnitId:o,threadIds:s})=>{let d=a.get(r);d||(d=new Map,a.set(r,d));let m=d.get(o);m||(m=new Set,d.set(o,m));for(const c of s)m.add(c)}),this._tasks=[],a.forEach((r,o)=>{r.forEach((s,d)=>{this.syncThreadComments(o,d,Array.from(s))})}))}))}_ensureCommentMap(n,e){let t=this._commentsMap.get(n);t||(t=new Map,this._commentsMap.set(n,t));let a=t.get(e);return a||(a=new Map,t.set(e,a)),a}ensureMap(n,e){return this._ensureCommentMap(n,e)}_ensureThreadMap(n,e){let t=this._threadMap.get(n);t||(t=new Map,this._threadMap.set(n,t));let a=t.get(e);return a||(a=new Map,t.set(e,a)),a}_replaceComment(n,e,t){const a=this._ensureCommentMap(n,e),r=a.get(t.id);if(r){const{children:o,...s}=t,d={...s,ref:r.ref};a.set(t.id,d),o==null||o.forEach(m=>{a.set(m.id,{...m,ref:""})}),this._commentUpdate$.next({unitId:n,subUnitId:e,type:"syncUpdate",payload:d}),!!t.resolved!=!!r.resolved&&this._commentUpdate$.next({unitId:n,subUnitId:e,type:"resolve",payload:{commentId:t.id,resolved:!!t.resolved}})}}async syncThreadComments(n,e,t){if(this._lifecycleService.stage<b.Rendered){this._tasks.push({unitId:n,subUnitId:e,threadIds:t});return}const a=this._ensureThreadMap(n,e),r=this._ensureCommentMap(n,e),o=await this._dataSourceService.listThreadComments(n,e,t);if(!o)return;const s=new Set(t);o.forEach(d=>{this._replaceComment(n,e,d),s.delete(d.threadId)}),s.forEach(d=>{a.delete(d),r.forEach((m,c)=>{m.threadId===d&&r.delete(c)})})}addComment(n,e,t,a){const r=this._ensureCommentMap(n,e),{parentId:o,children:s=[],...d}=t,m={...d,parentId:o===t.id?void 0:o};m.threadId||(m.threadId=m.parentId||m.id);const c=l=>{r.set(l.id,l),this._commentUpdate$.next({unitId:n,subUnitId:e,type:"add",payload:l,isRoot:!l.parentId})};c(m);const I=this._ensureThreadMap(n,e);if(!m.parentId){I.set(m.threadId,m);for(const l of s)c(l)}return a&&this.syncThreadComments(n,e,[m.threadId]),!0}updateComment(n,e,t,a){const r=this._ensureCommentMap(n,e).get(t.commentId);return r&&(r.updated=!0,r.text=t.text,r.attachments=t.attachments,r.updateT=t.updateT,this._commentUpdate$.next({unitId:n,subUnitId:e,type:"update",payload:t,silent:a})),!0}updateCommentRef(n,e,t,a){const r=this._ensureCommentMap(n,e).get(t.commentId);return r?(r.ref=t.ref,this._commentUpdate$.next({unitId:n,subUnitId:e,type:"updateRef",payload:t,silent:a,threadId:r.threadId}),!0):!1}resolveComment(n,e,t,a){const r=this._ensureCommentMap(n,e).get(t);return r?(r.resolved=a,this._commentUpdate$.next({unitId:n,subUnitId:e,type:"resolve",payload:{commentId:t,resolved:a}}),!0):!1}getComment(n,e,t){return this._ensureCommentMap(n,e).get(t)}getRootComment(n,e,t){return this._ensureThreadMap(n,e).get(t)}getThread(n,e,t){const a=this._ensureCommentMap(n,e),r=Array.from(a.values()).filter(m=>m.threadId===t);let o;const s=[],d=new Set;for(const m of r)m.parentId?s.push(m):o=m,d.add(m.personId);if(o)return{root:o,children:s,relativeUsers:d,unitId:n,subUnitId:e,threadId:t}}getCommentWithChildren(n,e,t){const a=this.getComment(n,e,t);if(a)return this.getThread(n,e,a.threadId)}_deleteComment(n,e,t){const a=this._ensureCommentMap(n,e),r=a.get(t);r&&(a.delete(t),this._commentUpdate$.next({unitId:n,subUnitId:e,type:"delete",payload:{commentId:t,isRoot:!r.parentId,comment:r}}))}deleteThread(n,e,t){this._ensureThreadMap(n,e).delete(t),this._ensureCommentMap(n,e).forEach(a=>{a.threadId===t&&this._deleteComment(n,e,a.id)})}deleteComment(n,e,t){const a=this._ensureCommentMap(n,e).get(t);return a&&(a.parentId?this._deleteComment(n,e,t):this.deleteThread(n,e,a.threadId)),!0}deleteUnit(n){const e=this._commentsMap.get(n);e&&e.forEach((t,a)=>{t.forEach(r=>{this.deleteComment(n,a,r.id)})})}getUnit(n){const e=this._threadMap.get(n);if(!e)return[];const t=[];return e.forEach((a,r)=>{a.forEach((o,s)=>{const d=this.getThread(n,r,s);d&&t.push(d)})}),t}getAll(){const n=[];return this._commentsMap.forEach((e,t)=>{n.push({unitId:t,threads:this.getUnit(t)})}),n}};i=q([E(0,C(p)),E(1,C(H))],i);const x={id:"thread-comment.mutation.add-comment",type:u.MUTATION,handler(n,e,t){if(!e)return!1;const a=n.get(i),{unitId:r,subUnitId:o,comment:s,sync:d}=e,m=d||(t==null?void 0:t.fromChangeset)&&!s.parentId;return a.addComment(r,o,s,m)}},O={id:"thread-comment.mutation.update-comment",type:u.MUTATION,handler(n,e){if(!e)return!1;const t=n.get(i),{unitId:a,subUnitId:r,payload:o,silent:s}=e;return t.updateComment(a,r,o,s)}},z={id:"thread-comment.mutation.update-comment-ref",type:u.MUTATION,handler(n,e){if(!e)return!1;const t=n.get(i),{unitId:a,subUnitId:r,payload:o,silent:s}=e;return t.updateCommentRef(a,r,o,s)}},$={id:"thread-comment.mutation.resolve-comment",type:u.MUTATION,handler(n,e){if(!e)return!1;const t=n.get(i),{unitId:a,subUnitId:r,resolved:o,commentId:s}=e;return t.resolveComment(a,r,s,o)}},S={id:"thread-comment.mutation.delete-comment",type:u.MUTATION,handler(n,e){if(!e)return!1;const t=n.get(i),{unitId:a,subUnitId:r,commentId:o}=e;return t.deleteComment(a,r,o)}},G={id:"thread-comment.command.add-comment",type:u.COMMAND,async handler(n,e){if(!e)return!1;const t=n.get(f),a=n.get(p),{comment:r}=e,o=await a.addComment(r),s=a.syncUpdateMutationToColla,d=!r.parentId,m={id:x.id,params:{...e,comment:o}};return d?await t.executeCommand(m.id,m.params):t.executeCommand(m.id,m.params,{onlyLocal:!s})}},X={id:"thread-comment.command.update-comment",type:u.COMMAND,async handler(n,e){if(!e)return!1;const{unitId:t,subUnitId:a,payload:r}=e,o=n.get(f),s=n.get(i),d=n.get(p),m=d.syncUpdateMutationToColla,c=s.getComment(t,a,r.commentId);if(!c)return!1;const{children:I,...l}=c;if(!await d.updateComment({...l,...r}))return!1;const T={id:O.id,params:e};return o.executeCommand(T.id,T.params,{onlyLocal:!m}),!0}},Z={id:"thread-comment.command.resolve-comment",type:u.COMMAND,async handler(n,e){if(!e)return!1;const{unitId:t,subUnitId:a,resolved:r,commentId:o}=e,s=n.get(p),d=n.get(i).getComment(t,a,o),m=s.syncUpdateMutationToColla;return!d||!await s.resolveComment({...d,resolved:r})?!1:n.get(f).executeCommand($.id,e,{onlyLocal:!m})}},B={id:"thread-comment.command.delete-comment",type:u.COMMAND,async handler(n,e){if(!e)return!1;const t=n.get(i),a=n.get(p),r=n.get(f),{unitId:o,subUnitId:s,commentId:d}=e,m=a.syncUpdateMutationToColla,c=t.getComment(o,s,d);if(!c||!await a.deleteComment(o,s,c.threadId,d))return!1;const I={id:S.id,params:e};return r.executeCommand(I.id,I.params,{onlyLocal:!m})}},F={id:"thread-comment.command.delete-comment-tree",type:u.COMMAND,async handler(n,e){if(!e)return!1;const t=n.get(i),a=n.get(f),r=n.get(p),{unitId:o,subUnitId:s,commentId:d}=e,m=t.getCommentWithChildren(o,s,d);return!m||!await r.deleteComment(o,s,m.root.threadId,d)?!1:await a.executeCommand(S.id,{unitId:o,subUnitId:s,commentId:m.root.id})}};function oe(n){return L(n).format("YYYY/MM/DD HH:mm")}const A="UNIVER_THREAD_COMMENT_PLUGIN";var ee=(n,e,t,a)=>{for(var r=e,o=n.length-1,s;o>=0;o--)(s=n[o])&&(r=s(r)||r);return r},M=(n,e)=>(t,a)=>e(t,a,n);const te=`SHEET_${A}`;let g=class extends U{constructor(n,e,t){super(),this._resourceManagerService=n,this._threadCommentModel=e,this._threadCommentDataSourceService=t,this._initSnapshot()}_initSnapshot(){const n=t=>{const a=this._threadCommentModel.getUnit(t),r={};return a?(a.forEach(o=>{var s;const d=(s=r[o.subUnitId])!=null?s:[];d.push({...o.root,children:o.children}),r[o.subUnitId]=d}),JSON.stringify(this._threadCommentDataSourceService.saveToSnapshot(r,t))):""},e=t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:te,businesses:[v.UNIVER_SHEET,v.UNIVER_DOC],toJson:t=>n(t),parseJson:t=>e(t),onUnLoad:t=>{this._threadCommentModel.deleteUnit(t)},onLoad:async(t,a)=>{Object.keys(a).forEach(r=>{const o=a[r];o.forEach(s=>{this._threadCommentModel.addComment(t,r,s)}),this._threadCommentModel.syncThreadComments(t,r,o.map(s=>s.threadId))})}}))}};g=ee([M(0,V),M(1,C(i)),M(2,p)],g);const ne="thread-comment.config",w={};var ae=(n,e,t,a)=>{for(var r=e,o=n.length-1,s;o>=0;o--)(s=n[o])&&(r=s(r)||r);return r},y=(n,e)=>(t,a)=>e(t,a,n),_;let N=(_=class extends j{constructor(n=w,e,t,a){super(),this._config=n,this._injector=e,this._commandService=t,this._configService=a;const{...r}=k({},w,this._config);this._configService.setConfig(ne,r)}onStarting(){var n;W([[p,{useClass:Q}],[i],[g]],(n=this._config)==null?void 0:n.overrides).forEach(e=>{this._injector.add(e)}),[G,X,B,Z,F,x,O,z,S,$].forEach(e=>{this._commandService.registerCommand(e)}),this._injector.get(g)}},h(_,"pluginName",A),h(_,"type",v.UNIVER_UNKNOWN),_);N=ae([y(1,C(J)),y(2,f),y(3,P)],N);export{S as E,N as I,G as Q,x as R,X,Z,B as e,oe as h,i,p,F as t,O as x,z};
