import{ts as Vr,th as q,d as ne,M as ce,tt as J,fS as xn,fl as ze,gj as ke,gD as Ji,f1 as qi,fL as Rt,gg as Ne,ti as We,ik as Pe,s as De,f0 as Ut,g$ as Rn,hc as or,hs as Gr,iD as Yr,k as Xn,v as Fn,rW as Qi,r as Xr,kz as es,je as ts,tk as Fr,G as xt,hn as zn,oZ as ft,nJ as Ce,u as he,g6 as dr,pT as cr,l6 as ns,m2 as rs,j7 as is,pO as ss,tl as lr,tn as ur,tm as hr,tj as Mn,c0 as gr,S as fr,qt as zr,w as as,qy as os,gv as Kr,tp as pr,to as mr,I as ut,t8 as wr,A as ds,mR as vr,na as Ir,P as jn,V as kn,p7 as ot,or as Le,qz as _r,q_ as cs,bx as ls,h as us,jX as hs,oG as gs,bg as fs,pv as Sr,jR as Zr,jE as Jr,kx as qr,kr as Qr,jh as ei,ji as ti,jM as ni,jN as ri,jr as Nn,ll as An,jq as ii,l1 as si,lm as ai,lt as oi,ls as di,k_ as ci,k0 as li,k5 as ui,k3 as hi,lG as ps,lo as ms,ln as ws,l0 as vs,k$ as Is,m7 as _s,lH as Ss,tb as bs,sd as Cs,B as Kn,H as Zn,c as ys,s7 as Rs,L as Ms,rZ as Us,z as Jn,pV as Es,i as Ts,q as Ds,oS as Os,oY as xs,rT as js,r4 as ks,qb as Ns,n as As,R as Ps}from"./index--BQDx9CP.js";import{aT as gi,V as ge,w as W,O as mn,o as wn,z as qt,H as fi,v as ve,I as j,u as Oe,x as vn,M as le,F as Ie,cD as B,c8 as ht,L as X,ec as $e,K as Bt,ed as pi,W as Mt,ak as Pn,C as Ke,ca as In,q as mi,ab as pt,ac as wi,ct as Be,af as Un,n as $s,cH as Bs,d as Wt,a5 as at,b as Ye,c9 as tt,ee as $n,bG as br,bM as Cr,bJ as yr,by as Rr,Y as Mr,bV as Bn,cv as lt,G as Ws,ci as Ls,a6 as Hs,J as dt,ef as Vs,c as Lt,dp as xe,t as Ur,ah as Er,bQ as Ct,cm as ct,s as Gs,ai as Ys,bR as Xs,S as Fs,c2 as zs,c1 as Ks,eg as Zs,Q as Js,am as vi,an as qs,df as Qs,N as ea}from"./TeamSpreadsheet-DqPQXi__.js";import{r as x,j as R,i as Ue,u as ta,k as na,v as Xe,x as vt,e as ra,L as Ii,m as Me,U as ia,G as sa,b as aa,T as En}from"./facade-DLk4o3Z_.js";var oa=Object.defineProperty,da=(t,e,n)=>e in t?oa(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Tr=(t,e,n)=>da(t,typeof e!="symbol"?e+"":e,n);let Dr=class extends Vr{};const _i=gi("univer.doc.plugin.doc-drawing.service");var ca=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Ht=(t,e)=>(n,r)=>e(n,r,t);const Si="DOC_DRAWING_PLUGIN";let Et=class extends ge{constructor(e,n,r,i){super(),this._docDrawingService=e,this._drawingManagerService=n,this._resourceManagerService=r,this._univerInstanceService=i,this._init()}_init(){this._initSnapshot()}_initSnapshot(){const e=r=>{const i=this._univerInstanceService.getUnit(r,W.UNIVER_DOC);if(i){const s=i.getSnapshot().drawings,a=i.getSnapshot().drawingsOrder;return JSON.stringify({data:s??{},order:a??[]})}return""},n=r=>{if(!r)return{data:{},order:[]};try{return JSON.parse(r)}catch{return{data:{},order:[]}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:Si,businesses:[W.UNIVER_DOC],toJson:r=>e(r),parseJson:r=>n(r),onUnLoad:r=>{this._setDrawingDataForUnit(r,{data:{},order:[]})},onLoad:(r,i)=>{var s,a;this._setDrawingDataForUnit(r,{data:(s=i.data)!=null?s:{},order:(a=i.order)!=null?a:[]})}}))}_setDrawingDataForUnit(e,n){const r=this._univerInstanceService.getUnit(e);r!=null&&(r.resetDrawing(n.data,n.order),this.loadDrawingDataForUnit(e))}loadDrawingDataForUnit(e){const n=this._univerInstanceService.getUnit(e,W.UNIVER_DOC);if(!n)return!1;const r=e,i=n.getDrawings(),s=n.getDrawingsOrder();if(!i||!s)return!1;Object.keys(i).forEach(o=>{const d=i[o];i[o]={...d}});const a={[r]:{unitId:e,subUnitId:r,data:i,order:s}};return this._docDrawingService.registerDrawingData(e,a),this._drawingManagerService.registerDrawingData(e,a),!0}};Et=ca([Ht(0,_i),Ht(1,q),Ht(2,fi),Ht(3,ve)],Et);const la="docs-drawing.config",Or={};var ua=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},xr=(t,e)=>(n,r)=>e(n,r,t),Vt;let Wn=(Vt=class extends mn{constructor(t=Or,e,n){super(),this._config=t,this._injector=e,this._configService=n;const{...r}=wn({},Or,this._config);this._configService.setConfig(la,r)}onStarting(){[[Et],[Dr],[_i,{useClass:Dr}]].forEach(t=>this._injector.add(t)),qt(this._injector,[[Et]])}},Tr(Vt,"pluginName",Si),Tr(Vt,"type",W.UNIVER_DOC),Vt);Wn=ua([xr(1,j(Oe)),xr(2,vn)],Wn);var ha=Object.defineProperty,ga=(t,e,n)=>e in t?ha(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Ae=(t,e,n)=>ga(t,typeof e!="symbol"?e+"":e,n),G=(t=>(t.default="0",t.left="1",t.center="2",t.right="3",t.top="4",t.middle="5",t.bottom="6",t.horizon="7",t.vertical="8",t))(G||{});const qn={id:"sheet.operation.set-image-align",type:le.OPERATION,handler:(t,e)=>!0},Qt={id:"sheet.operation.open-image-crop",type:le.OPERATION,handler:(t,e)=>!0},Fe={id:"sheet.operation.close-image-crop",type:le.OPERATION,handler:(t,e)=>!0};var te=(t=>(t.FREE="0",t.R1_1="1",t.R16_9="2",t.R9_16="3",t.R5_4="4",t.R4_5="5",t.R4_3="6",t.R3_4="7",t.R3_2="8",t.R2_3="9",t))(te||{});const en={id:"sheet.operation.Auto-image-crop",type:le.OPERATION,handler:(t,e)=>!0},Qn={id:"sheet.operation.image-reset-size",type:le.OPERATION,handler:(t,e)=>!0},fa="drawing-ui.config",jr={},bi="COMPONENT_IMAGE_POPUP_MENU";function Ee({ref:t,...e}){const{icon:n,id:r,className:i,extend:s,...a}=e,o=`univerjs-icon univerjs-icon-${r} ${i||""}`.trim(),d=x.useRef(`_${wa()}`);return Ci(n,`${r}`,{defIds:n.defIds,idSuffix:d.current},{ref:t,className:o,...a},s)}function Ci(t,e,n,r,i){return x.createElement(t.tag,{key:e,...pa(t,n,i),...r},(ma(t,n).children||[]).map((s,a)=>Ci(s,`${e}-${t.tag}-${a}`,n,void 0,i)))}function pa(t,e,n){const r={...t.attrs};n!=null&&n.colorChannel1&&r.fill==="colorChannel1"&&(r.fill=n.colorChannel1),t.tag==="mask"&&r.id&&(r.id=r.id+e.idSuffix),Object.entries(r).forEach(([s,a])=>{s==="mask"&&typeof a=="string"&&(r[s]=a.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))});const{defIds:i}=e;return!i||i.length===0||(t.tag==="use"&&r["xlink:href"]&&(r["xlink:href"]=r["xlink:href"]+e.idSuffix),Object.entries(r).forEach(([s,a])=>{typeof a=="string"&&(r[s]=a.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))})),r}function ma(t,e){var n;const{defIds:r}=e;return!r||r.length===0?t:t.tag==="defs"&&(n=t.children)!=null&&n.length?{...t,children:t.children.map(i=>typeof i.attrs.id=="string"&&r&&r.includes(i.attrs.id)?{...i,attrs:{...i.attrs,id:i.attrs.id+e.idSuffix}}:i)}:t}function wa(){return Math.random().toString(36).substring(2,8)}Ee.displayName="UniverIcon";const va={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.0045 4.4334C14.8881 4.4334 15.6045 3.71705 15.6045 2.8334C15.6045 1.94974 14.8881 1.2334 14.0045 1.2334H3.70449C2.82084 1.2334 2.10449 1.94974 2.10449 2.8334C2.10449 3.71705 2.82084 4.4334 3.70449 4.4334H14.0045ZM14.4045 2.8334C14.4045 3.05431 14.2254 3.2334 14.0045 3.2334H3.70449C3.48358 3.2334 3.30449 3.05431 3.30449 2.8334C3.30449 2.61248 3.48358 2.4334 3.70449 2.4334H14.0045C14.2254 2.4334 14.4045 2.61249 14.4045 2.8334Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.1544 8.5999C15.038 8.5999 15.7544 7.88356 15.7544 6.9999C15.7544 6.11625 15.038 5.3999 14.1544 5.3999H3.85439C2.97074 5.3999 2.25439 6.11625 2.25439 6.9999C2.25439 7.88356 2.97074 8.5999 3.85439 8.5999H14.1544ZM14.5544 6.9999C14.5544 7.22082 14.3753 7.3999 14.1544 7.3999H3.85439C3.63348 7.3999 3.45439 7.22082 3.45439 6.9999C3.45439 6.77899 3.63348 6.5999 3.85439 6.5999H14.1544C14.3753 6.5999 14.5544 6.77899 14.5544 6.9999Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902L6.58023 12.5907C6.34591 12.3564 6.34591 11.9765 6.58023 11.7421C6.81454 11.5078 7.19444 11.5078 7.42876 11.7421L8.40449 12.7179V10.1664C8.40449 9.83504 8.67312 9.56641 9.00449 9.56641C9.33586 9.56641 9.60449 9.83504 9.60449 10.1664V12.7179L10.5802 11.7421C10.8145 11.5078 11.1944 11.5078 11.4288 11.7421C11.6631 11.9765 11.6631 12.3564 11.4288 12.5907L9.42923 14.5902"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902C8.58121 14.5917 8.58268 14.5931 8.58416 14.5946C8.64077 14.6502 8.70566 14.6923 8.77482 14.7209C8.84557 14.7502 8.92314 14.7664 9.00449 14.7664C9.08585 14.7664 9.16342 14.7502 9.23416 14.7209C9.30332 14.6923 9.36821 14.6502 9.42482 14.5946"}}]},yi=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"bottom-icon",ref:e,icon:va}))});yi.displayName="BottomIcon";const Ia={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.97705 7.51296C5.97705 7.18159 6.24568 6.91296 6.57705 6.91296H8.48632C8.81769 6.91296 9.08632 7.18159 9.08632 7.51296C9.08632 7.84433 8.81769 8.11296 8.48632 8.11296H6.57705C6.24568 8.11296 5.97705 7.84433 5.97705 7.51296Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6.57705 9.41028C6.24568 9.41028 5.97705 9.67891 5.97705 10.0103C5.97705 10.3416 6.24568 10.6103 6.57705 10.6103H10.8199C11.1512 10.6103 11.4199 10.3416 11.4199 10.0103C11.4199 9.67891 11.1512 9.41028 10.8199 9.41028H6.57705Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.51074 2.37063C3.51074 1.48697 4.22709 0.77063 5.11074 0.77063H9.80318L9.81294 0.770708C9.97168 0.768161 10.1311 0.82824 10.2511 0.95055L14.4317 5.21408C14.5165 5.30049 14.5697 5.406 14.5917 5.51645C14.6041 5.5644 14.6106 5.61467 14.6106 5.66648V11.6406C14.6106 12.5243 13.8943 13.2406 13.0106 13.2406H5.11074C4.22709 13.2406 3.51074 12.5243 3.51074 11.6406V2.37063ZM10.4032 4.66648V2.81964L12.6063 5.06648H10.8032C10.5823 5.06648 10.4032 4.88739 10.4032 4.66648ZM5.11074 1.97063C4.88983 1.97063 4.71074 2.14972 4.71074 2.37063V11.6406C4.71074 11.8615 4.88983 12.0406 5.11074 12.0406H13.0106C13.2316 12.0406 13.4106 11.8615 13.4106 11.6406V6.26648H10.8032C9.91953 6.26648 9.20318 5.55013 9.20318 4.66648V1.97063H5.11074Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.58916 6.6741C2.58916 6.34273 2.32053 6.0741 1.98916 6.0741C1.65779 6.0741 1.38916 6.34273 1.38916 6.6741V12.6294C1.38916 14.0653 2.55322 15.2294 3.98916 15.2294H9.41408C9.74545 15.2294 10.0141 14.9607 10.0141 14.6294C10.0141 14.298 9.74545 14.0294 9.41408 14.0294H3.98916C3.21596 14.0294 2.58916 13.4026 2.58916 12.6294V6.6741Z"}}]},Ri=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"create-copy-icon",ref:e,icon:Ia}))});Ri.displayName="CreateCopyIcon";const _a={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.38125 1.16211C6.49759 1.16211 5.78125 1.87845 5.78125 2.76211V5.6377H2.87783C1.99418 5.6377 1.27783 6.35404 1.27783 7.2377V13.2377C1.27783 14.1214 1.99418 14.8377 2.87783 14.8377H8.87783C9.76149 14.8377 10.4778 14.1214 10.4778 13.2377V10.3621H13.3813C14.2649 10.3621 14.9813 9.64577 14.9813 8.76211V2.76211C14.9813 1.87845 14.2649 1.16211 13.3813 1.16211H7.38125ZM10.4778 9.16211H13.3813C13.6022 9.16211 13.7812 8.98302 13.7812 8.76211V2.76211C13.7812 2.5412 13.6022 2.36211 13.3813 2.36211H7.38125C7.16034 2.36211 6.98125 2.5412 6.98125 2.76211V5.6377H8.87783C9.76149 5.6377 10.4778 6.35404 10.4778 7.2377V9.16211ZM6.98125 6.8377H8.87783C9.09875 6.8377 9.27783 7.01678 9.27783 7.2377V9.16211H7.38125C7.16034 9.16211 6.98125 8.98302 6.98125 8.76211V6.8377ZM5.78125 6.8377V8.76211C5.78125 9.64577 6.49759 10.3621 7.38125 10.3621H9.27783V13.2377C9.27783 13.4586 9.09875 13.6377 8.87783 13.6377H2.87783C2.65692 13.6377 2.47783 13.4586 2.47783 13.2377V7.2377C2.47783 7.01678 2.65692 6.8377 2.87783 6.8377H5.78125Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Mi=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"group-icon",ref:e,icon:_a}))});Mi.displayName="GroupIcon";const Sa={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ui=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"more-down-icon",ref:e,icon:Sa}))});Ui.displayName="MoreDownIcon";const ba={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 2.96401C1.25 3.84767 1.96634 4.56401 2.85 4.56401H13.15C14.0337 4.56401 14.75 3.84767 14.75 2.96401C14.75 2.08036 14.0337 1.36401 13.15 1.36401H2.85C1.96635 1.36401 1.25 2.08036 1.25 2.96401ZM2.85 3.36401C2.62909 3.36401 2.45 3.18493 2.45 2.96401C2.45 2.7431 2.62909 2.56401 2.85 2.56401H13.15C13.3709 2.56401 13.55 2.7431 13.55 2.96401C13.55 3.18493 13.3709 3.36401 13.15 3.36401H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 11.6118C5.80995 11.3774 6.18985 11.3774 6.42417 11.6118L7.3999 12.5875V6.36951C7.3999 6.03814 7.66853 5.76951 7.9999 5.76951C8.33127 5.76951 8.5999 6.03814 8.5999 6.36951V12.5875L9.57564 11.6118C9.80995 11.3774 10.1899 11.3774 10.4242 11.6118C10.6585 11.8461 10.6585 12.226 10.4242 12.4603L8.4324 14.452C8.32324 14.5655 8.16982 14.6362 7.9999 14.6362C7.82998 14.6362 7.67655 14.5655 7.56739 14.452L5.57564 12.4603C5.34132 12.226 5.34132 11.8461 5.57564 11.6118Z"}}]},Ei=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"move-down-icon",ref:e,icon:ba}))});Ei.displayName="MoveDownIcon";const Ca={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 13.036C1.25 12.1523 1.96634 11.436 2.85 11.436H13.15C14.0337 11.436 14.75 12.1523 14.75 13.036C14.75 13.9196 14.0337 14.636 13.15 14.636H2.85C1.96635 14.636 1.25 13.9196 1.25 13.036ZM2.85 12.636C2.62909 12.636 2.45 12.8151 2.45 13.036C2.45 13.2569 2.62909 13.436 2.85 13.436H13.15C13.3709 13.436 13.55 13.2569 13.55 13.036C13.55 12.8151 13.3709 12.636 13.15 12.636H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 4.38825C5.80995 4.62256 6.18985 4.62256 6.42417 4.38825L7.3999 3.41251V9.63049C7.3999 9.96186 7.66853 10.2305 7.9999 10.2305C8.33127 10.2305 8.5999 9.96186 8.5999 9.63049V3.41251L9.57564 4.38825C9.80995 4.62256 10.1899 4.62256 10.4242 4.38825C10.6585 4.15393 10.6585 3.77403 10.4242 3.53972L8.4324 1.54796C8.32324 1.43445 8.16982 1.36382 7.9999 1.36382C7.82998 1.36382 7.67655 1.43446 7.56739 1.54797L5.57564 3.53972C5.34132 3.77403 5.34132 4.15393 5.57564 4.38825Z"}}]},Ti=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"move-up-icon",ref:e,icon:Ca}))});Ti.displayName="MoveUpIcon";const ya={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.82994 1.40913C7.88746 1.35161 7.95376 1.30821 8.02453 1.27893C8.09527 1.24959 8.17285 1.2334 8.2542 1.2334C8.33555 1.2334 8.41313 1.24959 8.48387 1.27893C8.55464 1.30821 8.62094 1.35161 8.67846 1.40913L10.6785 3.40913C10.9128 3.64345 10.9128 4.02335 10.6785 4.25766C10.4441 4.49198 10.0642 4.49198 9.82994 4.25766L8.8542 3.28193V5.8334C8.8542 6.16477 8.58557 6.4334 8.2542 6.4334C7.92283 6.4334 7.6542 6.16477 7.6542 5.8334V3.28193L6.67846 4.25766C6.44415 4.49198 6.06425 4.49198 5.82994 4.25766C5.59562 4.02335 5.59562 3.64345 5.82994 3.40913L7.82994 1.40913Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.50439 9C1.50439 8.11634 2.22074 7.4 3.10439 7.4H13.4044C14.288 7.4 15.0044 8.11634 15.0044 9C15.0044 9.88366 14.2881 10.6 13.4044 10.6H3.1044C2.22074 10.6 1.50439 9.88366 1.50439 9ZM3.10439 8.6C2.88348 8.6 2.70439 8.77909 2.70439 9C2.70439 9.22091 2.88348 9.4 3.1044 9.4H13.4044C13.6253 9.4 13.8044 9.22091 13.8044 9C13.8044 8.77909 13.6253 8.6 13.4044 8.6H3.10439Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.6543 13.1665C1.6543 12.2828 2.37064 11.5665 3.2543 11.5665H13.5543C14.438 11.5665 15.1543 12.2828 15.1543 13.1665C15.1543 14.0502 14.438 14.7665 13.5543 14.7665H3.2543C2.37064 14.7665 1.6543 14.0502 1.6543 13.1665ZM3.2543 12.7665C3.03338 12.7665 2.8543 12.9456 2.8543 13.1665C2.8543 13.3874 3.03338 13.5665 3.2543 13.5665H13.5543C13.7752 13.5665 13.9543 13.3874 13.9543 13.1665C13.9543 12.9456 13.7752 12.7665 13.5543 12.7665H3.2543Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Di=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"topmost-icon",ref:e,icon:ya}))});Di.displayName="TopmostIcon";const Ra={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.46855 2.83731C7.46855 2.61639 7.64764 2.4373 7.86855 2.4373H13.8603C14.0812 2.4373 14.2603 2.61639 14.2603 2.8373V9.5049C14.2603 9.72581 14.0812 9.90489 13.8603 9.90489H12.866C12.5346 9.90489 12.266 10.1735 12.266 10.5049C12.266 10.8363 12.5346 11.1049 12.866 11.1049H13.8603C14.7439 11.1049 15.4603 10.3886 15.4603 9.5049V2.8373C15.4603 1.95365 14.7439 1.2373 13.8603 1.2373H7.86855C6.9849 1.2373 6.26855 1.95365 6.26855 2.83731V3.48688C6.26855 3.81825 6.53718 4.08688 6.86855 4.08688C7.19993 4.08688 7.46855 3.81825 7.46855 3.48688V2.83731Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.19888 5.56299C2.31522 5.56299 1.59888 6.27933 1.59888 7.16299V13.163C1.59888 14.0466 2.31522 14.763 3.19888 14.763H9.19888C10.0825 14.763 10.7989 14.0466 10.7989 13.163V7.16299C10.7989 6.27933 10.0825 5.56299 9.19888 5.56299H3.19888ZM2.79888 7.16299C2.79888 6.94207 2.97796 6.76299 3.19888 6.76299H9.19888C9.41979 6.76299 9.59888 6.94207 9.59888 7.16299V13.163C9.59888 13.3839 9.41979 13.563 9.19888 13.563H3.19888C2.97796 13.563 2.79888 13.3839 2.79888 13.163V7.16299Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Oi=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"ungroup-icon",ref:e,icon:Ra}))});Oi.displayName="UngroupIcon";const Ma={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"colorChannel1",d:"M11.0363 12.2367V14.0367C11.0363 14.3681 11.3049 14.6367 11.6363 14.6367C11.9676 14.6367 12.2363 14.3681 12.2363 14.0367V12.2367H14.0364C14.3677 12.2367 14.6364 11.9681 14.6364 11.6367C14.6364 11.3054 14.3677 11.0367 14.0364 11.0367H12.2363V9.23672C12.2363 8.90535 11.9676 8.63672 11.6363 8.63672C11.3049 8.63672 11.0363 8.90535 11.0363 9.23672V11.0367H9.23635C8.90498 11.0367 8.63635 11.3054 8.63635 11.6367C8.63635 11.9681 8.90498 12.2367 9.23635 12.2367H11.0363Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 1.36377C1.90091 1.36377 1.36365 1.90103 1.36365 2.56377V6.16377C1.36365 6.82651 1.90091 7.36377 2.56365 7.36377H6.16365C6.82639 7.36377 7.36365 6.82651 7.36365 6.16377V2.56377C7.36365 1.90103 6.82639 1.36377 6.16365 1.36377H2.56365ZM6.16365 2.56377H2.56365L2.56365 6.16377H6.16365V2.56377Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 8.63647C1.90091 8.63647 1.36365 9.17373 1.36365 9.83647V13.4365C1.36365 14.0992 1.90091 14.6365 2.56365 14.6365H6.16365C6.82639 14.6365 7.36365 14.0992 7.36365 13.4365V9.83647C7.36365 9.17373 6.82639 8.63647 6.16365 8.63647H2.56365ZM6.16365 9.83647H2.56365L2.56365 13.4365H6.16365V9.83647Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M9.83635 7.36377C9.17361 7.36377 8.63635 6.82651 8.63635 6.16377V2.56377C8.63635 1.90103 9.17361 1.36377 9.83635 1.36377H13.4364C14.0991 1.36377 14.6364 1.90103 14.6364 2.56377V6.16377C14.6364 6.82651 14.0991 7.36377 13.4364 7.36377H9.83635ZM9.83635 6.16377V2.56377L13.4364 2.56377V6.16377H9.83635Z",fillRule:"evenodd",clipRule:"evenodd"}}]},xi=x.forwardRef(function(t,e){return x.createElement(Ee,Object.assign({},t,{id:"autofill-double-icon",ref:e,icon:Ma}))});xi.displayName="AutofillDoubleIcon";function Ua(t){var e;const{popup:n}=t,r=(e=n==null?void 0:n.extraProps)==null?void 0:e.menuItems;if(!r)return null;const i=ne(X),s=ne(Ie),[a,o]=x.useState(!1),[d,l]=x.useState(!1),c=()=>{l(!0)},u=()=>{l(!1)},g=f=>{o(f)},h=f=>{i.executeCommand(f.commandId,f.commandParams),o(!1)},m=a||d,p=r.filter(f=>!f.disable);return R.jsx("div",{onMouseEnter:c,onMouseLeave:u,children:R.jsx(ta,{align:"start",items:p.map(f=>({type:"item",children:s.t(f.label),onSelect:()=>h(f)})),open:a,onOpenChange:g,children:R.jsxs("div",{className:Ue("univer-flex univer-items-center univer-gap-2 univer-rounded univer-p-1 hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-800",na,{"univer-bg-gray-100 dark:!univer-bg-gray-800":a,"univer-bg-white dark:!univer-bg-gray-900":!a}),children:[R.jsx(xi,{className:"univer-fill-primary-600 univer-text-gray-900 dark:!univer-text-white"}),m&&R.jsx(Ui,{className:"dark:!univer-text-white"})]})})})}var Ea=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},kr=(t,e)=>(n,r)=>e(n,r,t);let tn=class extends ge{constructor(e,n){super(),this._componentManager=e,this._commandService=n,this._init()}_initCustomComponents(){const e=this._componentManager;this.disposeWithMe(e.register(bi,Ua))}_initCommands(){[Qt,Fe,Qn,qn,en].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_init(){this._initCommands(),this._initCustomComponents()}};tn=Ea([kr(0,j(Xn)),kr(1,X)],tn);function _n(t,e){const n=[];return t.forEach(r=>{const{oKey:i,left:s,top:a,height:o,width:d,angle:l}=r,c=e.getDrawingOKey(i);if(c==null)return n.push(null),!0;const{unitId:u,subUnitId:g,drawingId:h,drawingType:m}=c,p={unitId:u,subUnitId:g,drawingId:h,drawingType:m,transform:{left:s,top:a,height:o,width:d,angle:l}};m===B.DRAWING_IMAGE&&(p.srcRect=r.srcRect),n.push(p)}),n}function Nr(t,e,n,r){const i=r.getDrawingByParam(t);if(i==null)return;const s=J(t),a=n.getObject(s);if(a&&!(a instanceof Rt))return;if(a!=null){a.addObject(e);return}const o=new Rt(s);n.addObject(o,ze).attachTransformerTo(o),o.addObject(e);const{transform:d}=i;d&&o.transformByState({left:d.left,top:d.top,angle:d.angle})}function ji(t,e){var n;const r=e?t.getUnit(e):t.getFocusedUnit();if(r==null)return;const i=r.getUnitId();let s;return r.type===W.UNIVER_SHEET?s=(n=r.getActiveSheet())==null?void 0:n.getSheetId():(r.type===W.UNIVER_DOC||r.type===W.UNIVER_SLIDE)&&(s=i),{unitId:i,subUnitId:s,current:r}}var Ta=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Gt=(t,e)=>(n,r)=>e(n,r,t);let nn=class extends ge{constructor(t,e,n,r){super(),Ae(this,"_sceneListenerOnDrawingMap",new WeakSet),this._currentUniverService=t,this._commandService=e,this._renderManagerService=n,this._drawingManagerService=r,this._initialize()}dispose(){super.dispose()}_initialize(){this._recoveryImages(),this._drawingAddListener(),this._drawingRemoveListener(),this._drawingUpdateListener(),this._commandExecutedListener(),this._drawingArrangeListener(),this._drawingGroupListener(),this._drawingRefreshListener(),this._drawingVisibleListener()}_recoveryImages(){const t=this._drawingManagerService.drawingManagerData,e=ji(this._currentUniverService);if(e==null)return;const{unitId:n,subUnitId:r}=e;Object.keys(t).forEach(i=>{Object.keys(t[i]).forEach(s=>{const a=t[i][s].data;a==null||i!==n||s!==r||Object.keys(a).forEach(o=>{a[o]&&this._insertDrawing([{unitId:i,subUnitId:s,drawingId:o}])})})})}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===qn.id){const e=t.params;if(e==null)return;this._drawingAlign(e)}}))}_drawingGroupListener(){this.disposeWithMe(this._drawingManagerService.group$.subscribe(t=>{this._groupDrawings(t)})),this.disposeWithMe(this._drawingManagerService.ungroup$.subscribe(t=>{this._ungroupDrawings(t)}))}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const e=this._renderManagerService.getRenderById(t),n=e==null?void 0:e.scene;if(n==null)return null;const r=n.getTransformerByCreate();return{scene:n,transformer:r}}_groupDrawings(t){t.forEach(e=>{this._groupDrawing(e)})}_groupDrawing(t){const{parent:e,children:n}=t,{unitId:r,subUnitId:i,drawingId:s}=e,a=this._getSceneAndTransformerByDrawingSearch(e.unitId);if(a==null)return;const{scene:o,transformer:d}=a;this._commandService.syncExecuteCommand(Fe.id);const l=[];if(n.forEach(g=>{const h=J(g),m=o.getObjectIncludeInGroup(h);if(m==null||l.includes(m))return;l.push(m);const{transform:p}=g;p!=null&&(m.classType===Ne.GROUP?m.transformByState({left:p.left,top:p.top}):m.transformByState(p))}),l.length===0)return;const c=J({unitId:r,subUnitId:i,drawingId:s}),u=new Rt(c);o.addObject(u,ze).attachTransformerTo(u),u.addObjects(...l),e.transform&&u.transformByState({left:e.transform.left,top:e.transform.top}),d.clearSelectedObjects(),d.setSelectedControl(u)}_ungroupDrawings(t){t.forEach(e=>{this._ungroupDrawing(e)})}_ungroupDrawing(t){const{parent:e,children:n}=t,r=this._getSceneAndTransformerByDrawingSearch(e.unitId);if(r==null)return;const{scene:i,transformer:s}=r;n.forEach(c=>{const u=J(c),g=i.getObjectIncludeInGroup(u);if(g==null)return!0;if(g==null)return;const{transform:h}=c;h!=null&&(g.classType===Ne.GROUP?g.transformByState({left:h.left,top:h.top}):g.transformByState(h))});const a=J(e),o=i.getObject(a),{width:d,height:l}=o;o.getObjects().forEach(c=>{o.removeSelfObjectAndTransform(c.oKey,d,l)}),o.dispose(),s.clearSelectedObjects()}_drawingAlign(t){const{alignType:e}=t,n=this._drawingManagerService.getFocusDrawings();if(e===G.default)return;const r=[];let i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY,d=0;n.forEach(l=>{const{unitId:c,subUnitId:u,drawingId:g,drawingType:h}=l,m=this._drawingManagerService.getDrawingByParam({unitId:c,subUnitId:u,drawingId:g});if(m==null||m.transform==null)return;r.push({unitId:c,subUnitId:u,drawingId:g,drawingType:h,transform:m.transform});const{left:p=0,top:f=0,width:w=0,height:v=0}=m.transform;i=Math.min(i,p),s=Math.min(s,f),a=Math.max(a,p+w),o=Math.max(o,f+v),d++}),d!==0&&(this._sortDrawingTransform(r,e),this._applyAlignType(r,e,i,s,a,o,d))}_applyAlignType(t,e,n,r,i,s,a){const o=Math.round((i-n)/a*10)/10,d=Math.round((s-r)/a*10)/10,l=[],c=this._getSceneAndTransformerByDrawingSearch(t[0].unitId);if(c==null)return;const{scene:u,transformer:g}=c;t.forEach((h,m)=>{const{unitId:p,subUnitId:f,drawingId:w,transform:v,drawingType:b}=h,{left:C=0,top:_=0,width:S=0,height:I=0}=v;let y=C,M=_;switch(e){case G.left:y=n;break;case G.center:y=n+(i-n)/2-S/2;break;case G.right:y=i-S;break;case G.top:M=r;break;case G.middle:M=r+(s-r)/2-I/2;break;case G.bottom:M=s-I;break;case G.horizon:y=n+o*m;break;case G.vertical:M=r+d*m;break}(y!==C||M!==_)&&l.push({unitId:p,subUnitId:f,drawingId:w,drawingType:b,transform:{left:y,top:M}})}),this._drawingManagerService.featurePluginUpdateNotification(l),g.refreshControls().changeNotification()}_sortDrawingTransform(t,e){t.sort((n,r)=>{const i=n.transform,s=r.transform,{left:a=0,top:o=0,width:d=0,height:l=0}=i,{left:c=0,top:u=0,width:g=0,height:h=0}=s;switch(e){case G.left:return a-c;case G.center:return a+d/2-(c+g/2);case G.right:return a+d-(c+g);case G.top:return o-u;case G.middle:return o+l/2-(u+h/2);case G.bottom:return o+l-(u+h);case G.horizon:return a+d/2-(c+g/2);case G.vertical:return o+l/2-(u+h/2);default:return 0}})}_drawingArrangeListener(){this.disposeWithMe(this._drawingManagerService.order$.subscribe(t=>{this._drawingArrange(t)}))}_drawingArrange(t){const{unitId:e,subUnitId:n,drawingIds:r}=t,i=this._getSceneAndTransformerByDrawingSearch(e);if(i==null)return;const{scene:s}=i;r.forEach(a=>{const o=J({unitId:e,subUnitId:n,drawingId:a}),d=s.fuzzyMathObjects(o,!0);if(d==null||d.length===0)return;const l=this._drawingManagerService.getDrawingOrder(e,n).indexOf(a);for(const c of d)c.setProps({zIndex:l}),c.makeDirty()})}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{this._insertDrawing(t)}))}_insertDrawing(t){const e=[];t.forEach(n=>{const{unitId:r}=n;if(this._drawingManagerService.getDrawingByParam(n)==null)return;const i=this._getSceneAndTransformerByDrawingSearch(r);if(i==null)return;const{scene:s}=i;e.includes(s)||e.push(s)}),e.forEach(n=>{this._sceneListenerOnDrawingMap.has(n)||(this._addListenerOnDrawing(n),this._sceneListenerOnDrawingMap.add(n))})}_drawingRemoveListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(e=>{var n;const{unitId:r,subUnitId:i,drawingId:s}=e,a=this._getSceneAndTransformerByDrawingSearch(r);if(a==null)return;const{scene:o}=a,d=J({unitId:r,subUnitId:i,drawingId:s}),l=o.fuzzyMathObjects(d,!0);if(l.length>0){for(const c of l)c.dispose();(n=o.getTransformer())==null||n.clearSelectedObjects()}})}))}_drawingUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(e=>{var n;const{unitId:r,subUnitId:i,drawingId:s}=e,a=this._drawingManagerService.getDrawingByParam(e);if(a==null)return;const{transform:o,drawingType:d}=a,l=this._getSceneAndTransformerByDrawingSearch(r);if(l==null)return;const{scene:c,transformer:u}=l;if(o==null)return!0;const{left:g=0,top:h=0,width:m=0,height:p=0,angle:f=0,flipX:w=!1,flipY:v=!1,skewX:b=0,skewY:C=0}=o,_=J({unitId:r,subUnitId:i,drawingId:s}),S=c.getObject(_);if(S==null)return!0;S.transformByState({left:g,top:h,width:m,height:p,angle:f,flipX:w,flipY:v,skewX:b,skewY:C}),(n=c.getTransformer())==null||n.debounceRefreshControls()})}))}_drawingRefreshListener(){this.disposeWithMe(this._drawingManagerService.refreshTransform$.subscribe(t=>{t.forEach(e=>{const{unitId:n,subUnitId:r,drawingId:i}=e,s=this._getSceneAndTransformerByDrawingSearch(n);if(s==null)return;const a=this._drawingManagerService.getDrawingByParam(e);if(a==null)return;const{transform:o}=a,{scene:d}=s,l=J({unitId:n,subUnitId:r,drawingId:i}),c=d.getObject(l);if(c==null||o==null)return!0;const{left:u=0,top:g=0,width:h=0,height:m=0,angle:p=0,flipX:f=!1,flipY:w=!1,skewX:v=0,skewY:b=0}=o;c.transformByState({left:u,top:g,width:h,height:m,angle:p,flipX:f,flipY:w,skewX:v,skewY:b})})}))}_drawingVisibleListener(){this.disposeWithMe(this._drawingManagerService.visible$.subscribe(t=>{t.forEach(e=>{const{unitId:n,subUnitId:r,drawingId:i,visible:s}=e,a=this._getSceneAndTransformerByDrawingSearch(n);if(a==null)return;const{scene:o}=a,d=J({unitId:n,subUnitId:r,drawingId:i}),l=o.getObject(d);if(l==null)return!0;s?l.show():l.hide()})}))}_filterUpdateParams(t,e){return t.filter((n,r)=>{if(n==null)return!1;const{transform:i}=n;return pi(i,e==null?void 0:e[r])})}_addListenerOnDrawing(t){const e=t.getTransformerByCreate();let n=null;this.disposeWithMe(Mt(e.changeStart$.subscribe(r=>{const{objects:i}=r,s=Array.from(i.values()),a=[];n=s.map(o=>{const{left:d,top:l,height:c,width:u,angle:g,oKey:h,isInGroup:m}=o,p=this._drawingManagerService.getDrawingOKey(h);if(m||o instanceof Rt){let f=o.ancestorGroup;if(f==null&&o instanceof Rt&&(f=o),f==null)return null;const w=this._drawingManagerService.getDrawingOKey(f.oKey);if(w){const{unitId:v,subUnitId:b,drawingId:C}=w;a.push({unitId:v,subUnitId:b,drawingId:C});const{left:_,top:S,height:I,width:y,angle:M}=f;return{left:_,top:S,height:I,width:y,angle:M}}}else if(p!=null){const{unitId:f,subUnitId:w,drawingId:v}=p;return a.push({unitId:f,subUnitId:w,drawingId:v}),{left:d,top:l,height:c,width:u,angle:g}}return null}).filter(o=>o!=null),a.length>0?this._commandService.syncExecuteCommand(We.id,a):this._commandService.syncExecuteCommand(We.id,[])}))),this.disposeWithMe(Mt(e.changeEnd$.subscribe(r=>{const{objects:i}=r,s=this._filterUpdateParams(_n(i,this._drawingManagerService),n);s.length>0&&this._drawingManagerService.featurePluginUpdateNotification(s)})))}};nn=Ta([Gt(0,ve),Gt(1,X),Gt(2,ce),Gt(3,q)],nn);class yt extends Ji{constructor(e,n){n==null&&(n={}),n.transformerConfig={keepRatio:!1,isCropper:!0,anchorFill:"rgb(0, 0, 0)",anchorStroke:"rgb(255, 255, 255)",anchorSize:24},super(e,n),Ae(this,"_srcRect"),Ae(this,"_prstGeom"),Ae(this,"_applyTransform"),Ae(this,"_dragPadding",8),Ae(this,"_cacheCanvas"),n!=null&&n.srcRect&&(this._srcRect=n.srcRect),n!=null&&n.prstGeom&&(this._prstGeom=n.prstGeom),n!=null&&n.applyTransform&&(this._applyTransform=n.applyTransform),n!=null&&n.dragPadding&&(this._dragPadding=n.dragPadding),this._applyProps()}refreshSrcRect(e,n){this._srcRect=e,this._applyTransform=n,this._applyProps()}get srcRect(){return this._srcRect}dispose(){var e;super.dispose(),(e=this._cacheCanvas)==null||e.dispose(),this._srcRect=null}isHit(e){const n=this.getInverseCoord(e);return n.x>=-this.strokeWidth/2&&n.x<=this.width+this.strokeWidth/2&&n.y>=-this.strokeWidth/2&&n.y<=this.height+this.strokeWidth/2&&!this._inSurround(n)}_inSurround(e){const n=this._dragPadding;return e.x>=n-this.strokeWidth/2&&e.x<=this.width+this.strokeWidth/2-n&&e.y>=n-this.strokeWidth/2&&e.y<=this.height+this.strokeWidth/2-n}render(e,n){return this.visible?(e.save(),this._draw(e),e.restore(),this.makeDirty(!1),this):(this.makeDirty(!1),this)}_draw(e){var n,r;const i=this.getScene().getEngine(),{width:s,height:a}=i;this._initialCacheCanvas(),(n=this._cacheCanvas)==null||n.clear();const o=(r=this._cacheCanvas)==null?void 0:r.getContext();o!=null&&(o.save(),ke.drawWith(o,{left:0,top:0,width:s,height:a,fill:"rgba(0, 0, 0, 0.5)"}),o.setTransform(e.getTransform()),this._clipForApplyObject(o),this._applyCache(e),o.restore())}_clipForApplyObject(e){let n=0;if(this._prstGeom!=null&&(n=1),e.globalCompositeOperation="destination-out",e.beginPath(),n===0){const r=this.transform.getMatrix();e.transform(r[0],r[1],r[2],r[3],r[4],r[5]),e.rect(0,0,this.width,this.height),e.fill()}}_applyProps(){if(this._applyTransform==null)return;let e=0,n=0,r=0,i=0;const{left:s=0,top:a=0,width:o=0,height:d=0,angle:l}=this._applyTransform;if(this._srcRect!=null){const{left:g=0,top:h=0,right:m=0,bottom:p=0}=this._srcRect;e=g,n=h,r=m,i=p}const c=s+e,u=a+n;this.transformByState({left:c,top:u,width:s+o-r-c,height:a+d-i-u,angle:l})}_applyCache(e){if(!e||this._cacheCanvas==null)return;const n=this._cacheCanvas.getContext();n.save(),e.save(),e.setTransform(1,0,0,1,0,0),n.setTransform(1,0,0,1,0,0),e.drawImage(this._cacheCanvas.getCanvasEle(),0,0),e.restore(),n.restore()}_initialCacheCanvas(){if(this._cacheCanvas!=null)return;const e=this.getScene();if(e==null)return;this._cacheCanvas=new qi;const n=e.getEngine();this._cacheCanvas.setSize(n.width,n.height),n.onTransformChange$.subscribeEvent(()=>{var r;(r=this._cacheCanvas)==null||r.setSize(n.width,n.height),this.makeDirty(!0)})}}var Da=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},nt=(t,e)=>(n,r)=>e(n,r,t);let rn=class extends ge{constructor(t,e,n,r,i,s){super(),Ae(this,"_sceneListenerOnImageMap",new WeakSet),this._commandService=t,this._drawingManagerService=e,this._renderManagerService=n,this._univerInstanceService=r,this._messageService=i,this._localeService=s,this._init()}_init(){this._initOpenCrop(),this._initCloseCrop(),this._initAutoCrop()}_initAutoCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==en.id)return;const e=t.params;if(e==null)return;const{cropType:n}=e,r=this._drawingManagerService.getFocusDrawings();if(r.length!==1)return;const i=r[0],{unitId:s,subUnitId:a,drawingId:o}=i,d=this._renderManagerService.getRenderById(s),l=d==null?void 0:d.scene;if(l==null)return!0;this._searchCropObject(l)!=null&&this._commandService.syncExecuteCommand(Fe.id,{isAuto:!0});const c=J({unitId:s,subUnitId:a,drawingId:o}),u=l.getObject(c);if(!(u instanceof xn)){this._messageService.show({type:Me.Error,content:this._localeService.t("image-cropper.error")});return}u!=null&&(this._updateCropperObject(n,u),this._commandService.executeCommand(Qt.id,{unitId:s,subUnitId:a,drawingId:o}))}))}_calculateSrcRectByRatio(t,e,n,r,i,s){const a=n/r,o=i/s;let d=n,l=r;a>o?d=r*o:l=n/o;const c=(n-d)/2,u=(r-l)/2;return{left:Pe(c,1),top:Pe(u,1),right:Pe(n-(c+d),1),bottom:Pe(r-(u+l),1)}}_updateCropperObject(t,e){const{left:n,top:r,width:i,height:s}=e.calculateTransformWithSrcRect();let a;switch(t){case te.R1_1:a=this._calculateSrcRectByRatio(n,r,i,s,1,1);break;case te.R16_9:a=this._calculateSrcRectByRatio(n,r,i,s,16,9);break;case te.R9_16:a=this._calculateSrcRectByRatio(n,r,i,s,9,16);break;case te.R5_4:a=this._calculateSrcRectByRatio(n,r,i,s,5,4);break;case te.R4_5:a=this._calculateSrcRectByRatio(n,r,i,s,4,5);break;case te.R4_3:a=this._calculateSrcRectByRatio(n,r,i,s,4,3);break;case te.R3_4:a=this._calculateSrcRectByRatio(n,r,i,s,3,4);break;case te.R3_2:a=this._calculateSrcRectByRatio(n,r,i,s,3,2);break;case te.R2_3:a=this._calculateSrcRectByRatio(n,r,i,s,2,3);break;case te.FREE:}if(a==null)return;e.setSrcRect(a);const{left:o=0,top:d=0,bottom:l=0,right:c=0}=a;e.transformByStateCloseCropper({left:n+o,top:r+d,width:i-c-o,height:s-l-d})}_initOpenCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==Qt.id)return;const e=t.params;if(e==null)return;const{unitId:n,subUnitId:r,drawingId:i}=e,s=this._renderManagerService.getRenderById(n),a=s==null?void 0:s.scene;if(a==null)return!0;if(this._sceneListenerOnImageMap.has(a)||(this._addListenerOnImage(a),this._sceneListenerOnImageMap.add(a)),this._drawingManagerService.getDrawingByParam({unitId:n,subUnitId:r,drawingId:i})==null)return;const o=J({unitId:n,subUnitId:r,drawingId:i}),d=a.getObject(o);if(d==null)return;if(!(d instanceof xn)){this._messageService.show({type:Me.Error,content:this._localeService.t("image-cropper.error")});return}const l=a.getTransformer();l==null||l.clearControls();const c=new yt(`${o}-crop`,{srcRect:d.srcRect,prstGeom:d.prstGeom,applyTransform:d.calculateTransformWithSrcRect()});a.addObject(c,d.getLayerIndex()+1).attachTransformerTo(c),l==null||l.createControlForCopper(c),this._addHoverForImageCopper(c),d.openRenderByCropper(),l==null||l.refreshControls(),c.makeDirty(!0),this._commandService.syncExecuteCommand(We.id,[{unitId:n,subUnitId:r,drawingId:i}])}))}_searchCropObject(t){const e=t.getAllObjectsByOrder();for(const n of e)if(n instanceof yt)return n}_initCloseCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==Fe.id)return;const n=this._univerInstanceService.getFocusedUnit();if(n==null)return;const r=n.getUnitId(),i=this._renderManagerService.getRenderById(r),s=i==null?void 0:i.scene;if(s==null)return!0;const a=this._searchCropObject(s);if(a==null)return;const o=this._getApplyObjectByCropObject(a);if(o==null)return;const d=s.getTransformerByCreate();d.detachFrom(a),d.clearCopperControl();const l=this._getSrcRectByTransformState(o,a),c=this._drawingManagerService.getDrawingOKey(o.oKey);if(c!=null){const{left:u,top:g,height:h,width:m}=a;this._drawingManagerService.featurePluginUpdateNotification([{...c,transform:{...c.transform,left:u,top:g,height:h,width:m},srcRect:l.srcRectAngle}])}o.setSrcRect({...l.srcRectAngle}),o.closeRenderByCropper(),o.makeDirty(!0),a==null||a.dispose()}));const t=this._univerInstanceService.getCurrentTypeOfUnit$(W.UNIVER_SHEET).pipe(De(e=>e?e.activeSheet$:Pn(null)));this.disposeWithMe(t.subscribe(()=>{this._commandService.syncExecuteCommand(Fe.id)}))}_getApplyObjectByCropObject(t){const e=t.oKey,n=e.slice(0,e.length-5),r=t.getScene();if(!r)return null;const i=r.getObject(n);return i??null}_addListenerOnImage(t){const e=t.getTransformerByCreate();let n=null;this.disposeWithMe(e.changeStart$.subscribe(r=>{const{objects:i}=r,s=i.values().next().value;if(s==null||!(s instanceof yt))return;const{left:a,top:o,height:d,width:l,angle:c}=s;n={left:a,top:o,height:d,width:l,angle:c},e.clearCopperControl()})),this.disposeWithMe(e.changeEnd$.subscribe(r=>{const{objects:i}=r,s=i.values().next().value;if(s==null||!(s instanceof yt))return;const{left:a,top:o,height:d,width:l,angle:c}=s;if(!pi({left:a,top:o,height:d,width:l,angle:c},n))return;const u=this._getApplyObjectByCropObject(s);if(u==null)return;const g=this._getSrcRectByTransformState(u,s);s.refreshSrcRect(g.srcRect,u.getState()),e.createControlForCopper(s)})),this._endCropListener(t)}_addHoverForImageCopper(t){this.disposeWithMe(t.onPointerEnter$.subscribeEvent(()=>{t.cursor=Ut.MOVE})),this.disposeWithMe(t.onPointerLeave$.subscribeEvent(()=>{t.cursor=Ut.DEFAULT}))}_endCropListener(t){const e=t.getTransformerByCreate();this.disposeWithMe(e.clearControl$.subscribe(n=>{n===!0&&this._commandService.syncExecuteCommand(Fe.id)}))}_getSrcRectByTransformState(t,e){const{left:n,top:r,height:i,width:s,strokeWidth:a,angle:o}=e,{left:d,top:l,width:c,height:u,angle:g,strokeWidth:h}=t,m=n-d,p=r-l,f={left:m,top:p,right:c-m-s,bottom:u-p-i},w={...f};if(g!==0){const v=n+s/2,b=r+i/2,C=new Rn(v,b),_=c/2+d,S=u/2+l,I=new Rn(_,S),y=new Rn(d,l);y.rotateByPoint(or(g),I);const M=y.clone();M.rotateByPoint(or(-g),C);const D=n-M.x,E=r-M.y;w.left=D,w.top=E,w.right=c-D-s,w.bottom=u-E-i}return{srcRect:f,srcRectAngle:w}}};rn=Da([nt(0,X),nt(1,q),nt(2,ce),nt(3,ve),nt(4,Fn),nt(5,j(Ie))],rn);var Oa=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Tn=(t,e)=>(n,r)=>e(n,r,t);let gt=class{constructor(t,e,n){this._drawingManagerService=t,this._imageIoService=e,this._galleryService=n}async renderImages(t,e){const{transform:n,drawingType:r,source:i,imageSourceType:s,srcRect:a,prstGeom:o,groupId:d,unitId:l,subUnitId:c,drawingId:u,isMultiTransform:g,transforms:h}=t;if(r!==B.DRAWING_IMAGE||!this._drawingManagerService.getDrawingVisible()||n==null)return;const m=g&&h?h:[n],p=[];for(const f of m){const{left:w,top:v,width:b,height:C,angle:_,flipX:S,flipY:I,skewX:y,skewY:M}=f,D=m.indexOf(f),E=J({unitId:l,subUnitId:c,drawingId:u},g?D:void 0),U=e.getObject(E);if(U!=null){U.transformByState({left:w,top:v,width:b,height:C,angle:_,flipX:S,flipY:I,skewX:y,skewY:M});continue}const T=this._drawingManagerService.getDrawingOrder(l,c),A=T.indexOf(u),$={...f,zIndex:A===-1?T.length-1:A},re=this._imageIoService.getImageSourceCache(i,s);let Q=!1;if(re!=null)$.image=re;else{if(s===ht.UUID)try{$.url=await this._imageIoService.getImage(i)}catch(K){console.error(K);continue}else $.url=i;Q=!0}if(e.getObject(E))continue;$.printable=!0;const L=new xn(E,$);Q&&this._imageIoService.addImageSourceCache(i,s,L.getNative()),this._drawingManagerService.getDrawingVisible()&&(e.addObject(L,ze),this._drawingManagerService.getDrawingEditable()&&e.attachTransformerTo(L),d&&Nr({drawingId:d,unitId:l,subUnitId:c},L,e,this._drawingManagerService),o!=null&&L.setPrstGeom(o),a!=null&&L.setSrcRect(a),p.push(L))}return p}renderFloatDom(t,e){const{transform:n,drawingType:r,groupId:i,unitId:s,subUnitId:a,drawingId:o,isMultiTransform:d,transforms:l}=t;if(r!==B.DRAWING_DOM||!this._drawingManagerService.getDrawingVisible()||n==null)return;const c=d&&l?l:[n],u=[];for(const g of c){const{left:h,top:m,width:p,height:f,angle:w,flipX:v,flipY:b,skewX:C,skewY:_}=g,S=c.indexOf(g),I=J({unitId:s,subUnitId:a,drawingId:o},d?S:void 0),y=e.getObject(I);if(y!=null){y.transformByState({left:h,top:m,width:p,height:f,angle:w,flipX:v,flipY:b,skewX:C,skewY:_});continue}const M=this._drawingManagerService.getDrawingOrder(s,a),D=M.indexOf(o),E={...g,zIndex:D===-1?M.length-1:D};if(e.getObject(I))continue;E.printable=!1;const U=new ke(I,E);this._drawingManagerService.getDrawingVisible()&&(e.addObject(U,ze),this._drawingManagerService.getDrawingEditable()&&t.allowTransform!==!1&&e.attachTransformerTo(U),i&&Nr({drawingId:i,unitId:s,subUnitId:a},U,e,this._drawingManagerService),u.push(U))}return u}renderDrawing(t,e){const n=this._drawingManagerService.getDrawingByParam(t);if(n!=null)switch(n.drawingType){case B.DRAWING_IMAGE:return this.renderImages(n,e)}}previewImage(t,e,n,r){this._galleryService.open({images:[e],onOpenChange:i=>{i||this._galleryService.close()}})}_adjustImageSize(t,e,n,r){if(t<=n&&e<=r)return{width:t,height:e};const i=n/t,s=r/e,a=Math.min(i,s);return{width:Math.floor(t*a),height:Math.floor(e*a)}}};gt=Oa([Tn(0,q),Tn(1,In),Tn(2,Qi)],gt);var xa=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},He=(t,e)=>(n,r)=>e(n,r,t);let sn=class extends ge{constructor(t,e,n,r,i,s,a){super(),this._commandService=t,this._renderManagerService=e,this._drawingManagerService=n,this._dialogService=r,this._imageIoService=i,this._currentUniverService=s,this._drawingRenderService=a,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddListener(),this._commandExecutedListener(),this._imageUpdateListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===Qn.id){const e=t.params;if(e==null)return;this._resetImageSize(e)}}))}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const e=this._renderManagerService.getRenderById(t),n=e==null?void 0:e.scene;if(n==null)return null;const r=n.getTransformerByCreate();return{scene:n,transformer:r}}_resetImageSize(t){const e=[],n=[];t.forEach(r=>{const{unitId:i,subUnitId:s,drawingId:a}=r,o=this._getSceneAndTransformerByDrawingSearch(i);if(o==null)return;const{scene:d}=o,l=J({unitId:i,subUnitId:s,drawingId:a}),c=d.getObject(l);if(c==null)return!0;const u=this._drawingManagerService.getDrawingByParam(r);if(u==null)return!0;if(u.drawingType!==B.DRAWING_IMAGE)return;c.resetSize();const{width:g,height:h}=c.getNativeSize();n.includes(d)===!1&&n.push(d),e.push({...u,transform:{...u.transform,height:h,width:g,angle:0},srcRect:null,prstGeom:null})}),this._drawingManagerService.featurePluginUpdateNotification(e),n.forEach(r=>{r.getTransformerByCreate().refreshControls().changeNotification()}),this._commandService.syncExecuteCommand(We.id,t)}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{this._insertImages(t)}))}_insertImages(t){t.forEach(async e=>{var n;const{unitId:r,subUnitId:i}=e,s=this._getSceneAndTransformerByDrawingSearch(r),a=(n=ji(this._currentUniverService,r))==null?void 0:n.subUnitId;if(s==null||a!==i)return;const o=this._drawingManagerService.getDrawingByParam(e);if(o==null)return;const d=await this._drawingRenderService.renderImages(o,s.scene);if(this._drawingManagerService.refreshTransform([o]),!(d==null||d.length===0))for(const l of d)this._addHoverForImage(l),this._addDialogForImage(l)})}_imageUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(e=>{const{unitId:n,subUnitId:r,drawingId:i}=e,s=this._drawingManagerService.getDrawingByParam(e);if(s==null)return;const{transform:a,drawingType:o,srcRect:d,prstGeom:l,source:c,imageSourceType:u}=s;if(o!==B.DRAWING_IMAGE)return;const g=this._getSceneAndTransformerByDrawingSearch(n);if(g==null)return;const{scene:h,transformer:m}=g;if(a==null)return!0;const p=J({unitId:n,subUnitId:r,drawingId:i}),f=h.getObject(p);if(f==null)return!0;f.setSrcRect(d),f.setPrstGeom(l),c!=null&&c.length>0&&(u===ht.BASE64||u===ht.URL)&&f.changeSource(c)})}))}_addHoverForImage(t){this.disposeWithMe(Mt(t.onPointerEnter$.subscribeEvent(()=>{t.cursor=Ut.GRAB}))),this.disposeWithMe(Mt(t.onPointerLeave$.subscribeEvent(()=>{t.cursor=Ut.DEFAULT})))}_addDialogForImage(t){this.disposeWithMe(Mt(t.onDblclick$.subscribeEvent(()=>{const e=`${t.oKey}-viewer-dialog`;this._drawingRenderService.previewImage(e,t.getNative().src,t.getNativeSize().width,t.getNativeSize().height)})))}};sn=xa([He(0,X),He(1,ce),He(2,q),He(3,Xr),He(4,In),He(5,ve),He(6,j(gt))],sn);var ja=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Ar=(t,e)=>(n,r)=>e(n,r,t);const ka="UNIVER_DRAWING_UI_PLUGIN";var Dn;let Ln=(Dn=class extends mn{constructor(t=jr,e,n){super(),this._config=t,this._injector=e,this._configService=n;const{menu:r,...i}=wn({},jr,this._config);r&&this._configService.setConfig("menu",r,{merge:!0}),this._configService.setConfig(fa,i)}onStarting(){this._initDependencies()}onRendered(){this._injector.get(nn),this._injector.get(tn),this._injector.get(rn),this._injector.get(sn)}_initDependencies(){[[gt],[nn],[tn],[rn],[sn]].forEach(t=>this._injector.add(t))}},Ae(Dn,"pluginName",ka),Dn);Ln=ja([Ar(1,j(Oe)),Ar(2,vn)],Ln);const Na=t=>{const e=ne(X),n=ne(Ie),{alignShow:r}=t,[i,s]=x.useState(G.default),a=[{label:n.t("image-panel.align.default"),value:G.default},{options:[{label:n.t("image-panel.align.left"),value:G.left},{label:n.t("image-panel.align.center"),value:G.center},{label:n.t("image-panel.align.right"),value:G.right}]},{options:[{label:n.t("image-panel.align.top"),value:G.top},{label:n.t("image-panel.align.middle"),value:G.middle},{label:n.t("image-panel.align.bottom"),value:G.bottom}]},{options:[{label:n.t("image-panel.align.horizon"),value:G.horizon},{label:n.t("image-panel.align.vertical"),value:G.vertical}]}];function o(d){s(d),e.executeCommand(qn.id,{alignType:d})}return R.jsxs("div",{className:Ue("univer-relative univer-w-full",{"univer-hidden":!r}),children:[R.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:R.jsx("div",{children:n.t("image-panel.align.title")})}),R.jsx("div",{className:"univer-relative univer-mt-2.5 univer-flex univer-h-full",children:R.jsx("div",{className:"univer-w-full univer-text-gray-900 dark:!univer-text-white",children:R.jsx(Ii,{value:i,options:a,onChange:o})})})]})},Aa=t=>{const{arrangeShow:e,drawings:n}=t,r=ne(Ie),i=ne(q),[s,a]=x.useState(n);x.useEffect(()=>{const d=i.focus$.subscribe(l=>{a(l)});return()=>{d.unsubscribe()}},[]);const o=d=>{const l=s[0].unitId,c=s[0].subUnitId,u=s.map(g=>g.drawingId);i.featurePluginOrderUpdateNotification({unitId:l,subUnitId:c,drawingIds:u,arrangeType:d})};return R.jsxs("div",{className:Ue("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!e}),children:[R.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:R.jsx("div",{children:r.t("image-panel.arrange.title")})}),R.jsxs("div",{className:"univer-grid univer-grid-cols-2 univer-gap-2",children:[R.jsxs(Xe,{onClick:()=>{o($e.forward)},children:[R.jsx(Ti,{}),r.t("image-panel.arrange.forward")]}),R.jsxs(Xe,{onClick:()=>{o($e.backward)},children:[R.jsx(Ei,{}),r.t("image-panel.arrange.backward")]}),R.jsxs(Xe,{onClick:()=>{o($e.front)},children:[R.jsx(Di,{}),r.t("image-panel.arrange.front")]}),R.jsxs(Xe,{onClick:()=>{o($e.back)},children:[R.jsx(yi,{}),r.t("image-panel.arrange.back")]})]})]})},Pa=t=>{const e=ne(Ie),n=ne(ce),r=ne(q),{hasGroup:i,drawings:s}=t,[a,o]=x.useState(!1),[d,l]=x.useState(!0),[c,u]=x.useState(!0),g=()=>{const p=r.getFocusDrawings(),{unitId:f,subUnitId:w}=p[0],v=Ke(10),b=Gr(0,0,p.map(S=>S.transform||{})),C={unitId:f,subUnitId:w,drawingId:v,drawingType:B.DRAWING_GROUP,transform:b},_=p.map(S=>{const I=S.transform||{left:0,top:0},{unitId:y,subUnitId:M,drawingId:D}=S;return{unitId:y,subUnitId:M,drawingId:D,transform:{...I,left:I.left-b.left,top:I.top-b.top},groupId:v}});r.featurePluginGroupUpdateNotification([{parent:C,children:_}])},h=p=>{if(p.drawingType!==B.DRAWING_GROUP)return;const{unitId:f,subUnitId:w,drawingId:v,transform:b={width:0,height:0}}=p;if(b==null)return;const C=r.getDrawingsByGroup({unitId:f,subUnitId:w,drawingId:v});if(C.length===0)return;const _=C.map(S=>{const{transform:I}=S,{unitId:y,subUnitId:M,drawingId:D}=S,E=Yr(I||{},b,b.width||0,b.height||0);return{unitId:y,subUnitId:M,drawingId:D,transform:{...I,...E},groupId:void 0}});return{parent:p,children:_}},m=()=>{const p=r.getFocusDrawings().map(f=>h(f)).filter(f=>f!=null);p.length!==0&&r.featurePluginUngroupUpdateNotification(p)};return x.useEffect(()=>{const p=s[0];if(p==null)return;const{unitId:f}=p,w=n.getRenderById(f),v=w==null?void 0:w.scene;if(v==null)return;const b=v.getTransformerByCreate(),C=b.clearControl$.subscribe(S=>{S===!0&&o(!1)}),_=b.changeStart$.subscribe(S=>{const{objects:I}=S,y=_n(I,r),M=y.filter(U=>(U==null?void 0:U.drawingType)===B.DRAWING_GROUP);let D=!1,E=!1;y.length>1&&(D=!0),M.length>0&&(E=!0),o(D||E),l(D),u(E)});return()=>{_.unsubscribe(),C.unsubscribe()}},[]),R.jsxs("div",{className:Ue("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":i===!0&&a===!1||i===!1}),children:[R.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:R.jsx("div",{children:e.t("image-panel.group.title")})}),R.jsxs("div",{className:"univer-flex univer-items-center univer-justify-center univer-gap-2",children:[R.jsxs(Xe,{className:Ue({"univer-hidden":!d}),onClick:g,children:[R.jsx(Mi,{}),e.t("image-panel.group.group")]}),R.jsxs(Xe,{className:Ue({"univer-hidden":!c}),onClick:m,children:[R.jsx(Oi,{}),e.t("image-panel.group.unGroup")]})]})]})},Yt=20,Xt=20,Pr=[-360,360],Ft=300,$a=t=>{var e;const n=ne(Ie),r=ne(q),i=ne(ce),{drawings:s,transformShow:a}=t,o=s[0];if(o==null)return;const d=o.transform;if(d==null)return;const{unitId:l,subUnitId:c,drawingId:u,drawingType:g}=o,h=i.getRenderById(l),m=h==null?void 0:h.scene;if(m==null)return;const p=(e=m.getEngine())==null?void 0:e.activeScene;if(p==null)return;const f=m.getTransformerByCreate(),{width:w=0,height:v=0,left:b=0,top:C=0,angle:_=0}=d,[S,I]=x.useState(w),[y,M]=x.useState(v),[D,E]=x.useState(b),[U,T]=x.useState(C),[A,$]=x.useState(_),[re,Q]=x.useState(f.keepRatio),L=(O,H,ie,se)=>{const{width:z,height:de}=p,{ancestorLeft:ue,ancestorTop:Z}=m;let pe=O,ae=H,be=ie,we=se;return O+ue<0&&(pe=-ue),H+Z<0&&(ae=-Z),be=z-pe-ue,be<Yt&&(be=Yt),we=de-ae-Z,we<Xt&&(we=Xt),O+be+ue>z&&(pe=z-ie-ue),H+we+Z>de&&(ae=de-se-Z),{limitLeft:pe,limitTop:ae,limitWidth:be,limitHeight:we}},K=O=>{const{objects:H}=O,ie=_n(H,r);if(ie.length!==1)return;const se=ie[0];if(se==null)return;const{transform:z}=se;if(z==null)return;const{width:de,height:ue,left:Z,top:pe,angle:ae}=z;de!=null&&I(de),ue!=null&&M(ue),Z!=null&&E(Z),pe!=null&&T(pe),ae!=null&&$(ae)};x.useEffect(()=>{const O=[f.changeStart$.subscribe(H=>{K(H)}),f.changing$.subscribe(H=>{K(H)}),f.changeEnd$.subscribe(H=>{K(H)}),r.focus$.subscribe(H=>{if(H.length!==1)return;const ie=r.getDrawingByParam(H[0]);if(ie==null)return;const se=ie.transform;if(se==null)return;const{width:z,height:de,left:ue,top:Z,angle:pe}=se;z!=null&&I(z),de!=null&&M(de),ue!=null&&E(ue),Z!=null&&T(Z),pe!=null&&$(pe)})];return()=>{O.forEach(H=>H.unsubscribe())}},[]);const V=Bt(O=>{if(O==null)return;const{limitWidth:H,limitHeight:ie}=L(D,U,O,y);O=Math.min(O,H);const se={unitId:l,subUnitId:c,drawingId:u,drawingType:g,transform:{width:O}};if(re){let z=O/S*y;if(z=Math.max(z,Xt),z>ie)return;M(z),se.transform.height=z}I(O),r.featurePluginUpdateNotification([se]),f.refreshControls().changeNotification()},Ft),_e=Bt(O=>{if(O==null)return;const{limitHeight:H,limitWidth:ie}=L(D,U,S,O);O=Math.min(O,H);const se={unitId:l,subUnitId:c,drawingId:u,drawingType:g,transform:{height:O}};if(re){let z=O/y*S;if(z=Math.max(z,Yt),z>ie)return;I(z),se.transform.width=z}M(O),r.featurePluginUpdateNotification([se]),f.refreshControls().changeNotification()},Ft),Ze=Bt(O=>{if(O==null)return;const{limitLeft:H}=L(O,U,S,y);O=H;const ie={unitId:l,subUnitId:c,drawingId:u,drawingType:g,transform:{left:O}};E(O),r.featurePluginUpdateNotification([ie]),f.refreshControls().changeNotification()},Ft),Je=Bt(O=>{if(O==null)return;const{limitTop:H}=L(D,O,S,y);O=H;const ie={unitId:l,subUnitId:c,drawingId:u,drawingType:g,transform:{top:O}};T(O),r.featurePluginUpdateNotification([ie]),f.refreshControls().changeNotification()},Ft),qe=O=>{if(O==null)return;const H={unitId:l,subUnitId:c,drawingId:u,drawingType:g,transform:{angle:O}};$(O),r.featurePluginUpdateNotification([H]),f.refreshControls().changeNotification()},Qe=O=>{Q(O),f.keepRatio=O};return R.jsxs("div",{className:Ue("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!a}),children:[R.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:R.jsx("div",{children:n.t("image-panel.transform.title")})}),R.jsxs("div",{className:"univer-grid univer-grid-cols-3 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[R.jsxs("div",{children:[R.jsx("span",{children:n.t("image-panel.transform.width")}),R.jsx(vt,{precision:1,value:S,min:Yt,onChange:O=>{V(O)}})]}),R.jsxs("div",{children:[R.jsx("span",{children:n.t("image-panel.transform.height")}),R.jsx(vt,{precision:1,value:y,min:Xt,onChange:O=>{_e(O)}})]}),R.jsxs("div",{children:[R.jsx("span",{children:n.t("image-panel.transform.lock")}),R.jsx("div",{className:"univer-text-center",children:R.jsx(ra,{checked:re,onChange:Qe})})]})]}),R.jsxs("div",{className:"univer-grid univer-grid-cols-3 univer-gap-2 [&>div]:univer-grid [&>div]:univer-gap-2",children:[R.jsxs("div",{children:[R.jsx("span",{children:n.t("image-panel.transform.x")}),R.jsx(vt,{precision:1,value:D,onChange:O=>{Ze(O)}})]}),R.jsxs("div",{children:[R.jsx("span",{children:n.t("image-panel.transform.y")}),R.jsx(vt,{precision:1,value:U,onChange:O=>{Je(O)}})]}),R.jsxs("div",{children:[R.jsx("span",{children:n.t("image-panel.transform.rotate")}),R.jsx(vt,{precision:1,value:A,min:Pr[0],max:Pr[1],onChange:qe})]})]})]})},Ba=t=>{const e=ne(X),n=ne(Ie),{drawings:r,cropperShow:i}=t;if(r[0]==null)return;const[s,a]=x.useState(te.FREE),o=x.useRef(!1),d=[{label:n.t("image-panel.crop.mode"),value:te.FREE},{label:"1:1",value:te.R1_1},{label:"16:9",value:te.R16_9},{label:"9:16",value:te.R9_16},{label:"5:4",value:te.R5_4},{label:"4:5",value:te.R4_5},{label:"4:3",value:te.R4_3},{label:"3:4",value:te.R3_4},{label:"3:2",value:te.R3_2},{label:"2:3",value:te.R2_3}];x.useEffect(()=>{const u=e.onCommandExecuted(g=>{if(g.id===Fe.id){const h=g.params;h!=null&&h.isAuto||(o.current=!1)}});return()=>{u==null||u.dispose()}},[]);function l(u){a(u),o.current&&e.executeCommand(en.id,{cropType:u})}const c=u=>{e.executeCommand(en.id,{cropType:u}),o.current=!0};return R.jsxs("div",{className:Ue("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!i}),children:[R.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:R.jsx("div",{children:n.t("image-panel.crop.title")})}),R.jsxs("div",{className:"univer-flex univer-items-center univer-justify-center univer-gap-2",children:[R.jsxs(Xe,{onClick:()=>{c(s)},children:[R.jsx(Ri,{}),n.t("image-panel.crop.start")]}),R.jsx(Ii,{value:s,options:d,onChange:l})]})]})},Wa=t=>{const e=ne(q),n=ne(ce),r=ne(Ie),{drawings:i,hasArrange:s=!0,hasTransform:a=!0,hasAlign:o=!0,hasCropper:d=!0,hasGroup:l=!0}=t,c=i[0];if(c==null)return;const{unitId:u}=c,g=n.getRenderById(u),h=g==null?void 0:g.scene;if(h==null)return;const m=h.getTransformerByCreate(),[p,f]=x.useState(!0),[w,v]=x.useState(!0),[b,C]=x.useState(!1),[_,S]=x.useState(!0),[I,y]=x.useState(!1);return x.useEffect(()=>{const M=m.clearControl$.subscribe(U=>{U===!0&&(f(!1),v(!1),C(!1),S(!1),y(!0))}),D=m.changeStart$.subscribe(U=>{const{objects:T}=U,A=_n(T,e);A.length===0?(f(!1),v(!1),C(!1),S(!1),y(!0)):A.length===1?(f(!0),v(!0),C(!1),S(!0),y(!1)):(f(!0),v(!1),C(!0),S(!1),y(!1))}),E=e.focus$.subscribe(U=>{U.length===0?(f(!1),v(!1),C(!1),S(!1),y(!0)):U.length===1?(f(!0),v(!0),C(!1),S(!0),y(!1)):(f(!0),v(!1),C(!0),S(!1),y(!1))});return()=>{D.unsubscribe(),M.unsubscribe(),E.unsubscribe()}},[]),R.jsxs(R.Fragment,{children:[R.jsx("div",{className:Ue("univer-h-full",{"univer-hidden":!I}),children:R.jsx("div",{className:"univer-flex univer-h-full univer-items-center univer-justify-center",children:R.jsx("span",{children:r.t("image-panel.null")})})}),R.jsx(Aa,{arrangeShow:s===!0?p:!1,drawings:i}),R.jsx($a,{transformShow:a===!0?w:!1,drawings:i}),R.jsx(Na,{alignShow:o===!0?b:!1,drawings:i}),R.jsx(Ba,{cropperShow:d===!0?_:!1,drawings:i}),R.jsx(Pa,{hasGroup:l,drawings:i})]})};var P=(t=>(t.Position="0",t.Both="1",t.None="2",t))(P||{});class La extends Vr{}const me=gi("sheets-drawing.sheet-drawing.service");var k=(t=>(t[t.INSERT=0]="INSERT",t[t.REMOVE=1]="REMOVE",t[t.UPDATE=2]="UPDATE",t[t.ARRANGE=3]="ARRANGE",t[t.GROUP=4]="GROUP",t[t.UNGROUP=5]="UNGROUP",t))(k||{});const N={id:"sheet.mutation.set-drawing-apply",type:le.MUTATION,handler:(t,e)=>{const n=t.get(q),r=t.get(me),{op:i,unitId:s,subUnitId:a,type:o,objects:d}=e;switch(n.applyJson1(s,a,i),r.applyJson1(s,a,i),o){case 0:n.addNotification(d),r.addNotification(d);break;case 1:n.removeNotification(d),r.removeNotification(d);break;case 2:n.updateNotification(d),r.updateNotification(d);break;case 3:n.orderNotification(d),r.orderNotification(d);break;case 4:n.groupUpdateNotification(d);break;case 5:n.ungroupUpdateNotification(d);break}return!0}};var Ha=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},rt=(t,e)=>(n,r)=>e(n,r,t);const ki="SHEET_DRAWING_PLUGIN";let an=class extends ge{constructor(t,e,n,r,i,s){super(),this._sheetInterceptorService=t,this._univerInstanceService=e,this._commandService=n,this._sheetDrawingService=r,this._drawingManagerService=i,this._resourceManagerService=s,this._initSnapshot(),this._initSheetChange(),this.disposeWithMe(this._commandService.registerCommand(N))}_initSnapshot(){const t=(n,r)=>{const i=r||this._sheetDrawingService.getDrawingDataForUnit(n);return i?JSON.stringify(i):""},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:ki,businesses:[W.UNIVER_SHEET],toJson:(n,r)=>t(n,r),parseJson:n=>e(n),onUnLoad:n=>{this._sheetDrawingService.removeDrawingDataForUnit(n),this._drawingManagerService.removeDrawingDataForUnit(n)},onLoad:(n,r)=>{this._sheetDrawingService.registerDrawingData(n,r),this._drawingManagerService.registerDrawingData(n,r)}}))}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:t=>{var e;if(t.id===es.id){const n=t.params,r=n.unitId||this._univerInstanceService.getCurrentUnitOfType(W.UNIVER_SHEET).getUnitId(),i=n.subUnitId||((e=this._univerInstanceService.getCurrentUnitOfType(W.UNIVER_SHEET).getActiveSheet())==null?void 0:e.getSheetId());if(!r||!i)return{redos:[],undos:[]};const s=this._sheetDrawingService.getDrawingData(r,i),a=Object.values(s).filter(h=>h.drawingType!==B.DRAWING_CHART);if(a.length===0)return{redos:[],undos:[]};const o=this._sheetDrawingService.getBatchRemoveOp(a),{unitId:d,subUnitId:l,undo:c,redo:u,objects:g}=o;return{redos:[{id:N.id,params:{op:u,unitId:d,subUnitId:l,objects:g,type:k.REMOVE}}],undos:[{id:N.id,params:{op:c,unitId:d,subUnitId:l,objects:g,type:k.INSERT}}]}}else if(t.id===ts.id){const n=t.params,{unitId:r,subUnitId:i,targetSubUnitId:s}=n;if(!r||!i||!s)return{redos:[],undos:[]};const a=this._sheetDrawingService.getDrawingData(r,i),o=Object.values(a).filter(m=>m.drawingType!==B.DRAWING_CHART).map(m=>({...m,subUnitId:s,drawingId:Ke(6)}));if(o.length===0)return{redos:[],undos:[]};const d=this._sheetDrawingService.getBatchAddOp(o),{unitId:l,subUnitId:c,undo:u,redo:g,objects:h}=d;return{redos:[{id:N.id,params:{op:g,unitId:l,subUnitId:c,objects:h,type:k.INSERT}}],undos:[{id:N.id,params:{op:u,unitId:l,subUnitId:c,objects:h,type:k.REMOVE}}]}}return{redos:[],undos:[]}}}))}};an=Ha([rt(0,j(xt)),rt(1,j(ve)),rt(2,X),rt(3,me),rt(4,q),rt(5,fi)],an);const Va="sheets-drawing.config",$r={};var Ga=Object.defineProperty,Ya=(t,e,n)=>e in t?Ga(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,Xa=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Br=(t,e)=>(n,r)=>e(n,r,t),Ni=(t,e,n)=>Ya(t,typeof e!="symbol"?e+"":e,n);let Tt=class extends mn{constructor(e=$r,n,r){super(),this._config=e,this._injector=n,this._configService=r;const{...i}=wn({},$r,this._config);this._configService.setConfig(Va,i)}onStarting(){[[an],[me,{useClass:La}]].forEach(e=>this._injector.add(e)),this._injector.get(an)}};Ni(Tt,"pluginName",ki);Ni(Tt,"type",W.UNIVER_SHEET);Tt=Xa([mi(Fr),Br(1,j(Oe)),Br(2,vn)],Tt);var Fa=Object.defineProperty,za=(t,e,n)=>e in t?Fa(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,ye=(t,e,n)=>za(t,typeof e!="symbol"?e+"":e,n);function fe(t,e,n){const{from:r,to:i,flipY:s=!1,flipX:a=!1,angle:o=0,skewX:d=0,skewY:l=0}=t,c=n.getCurrent();if(c==null)return;const u=os(c.unitId,c.sheetId,{from:r,to:i},n);let{left:g,top:h,width:m,height:p}=u;const f=n.getCurrentSkeleton(),w=f.rowHeaderWidth+f.columnTotalWidth,v=f.columnHeaderHeight+f.rowTotalHeight;return g+m>w&&(g=w-m),h+p>v&&(h=v-p),{flipY:s,flipX:a,angle:o,skewX:d,skewY:l,left:g,top:h,width:m,height:p}}function ee(t,e){const{left:n=0,top:r=0,width:i=0,height:s=0,flipY:a=!1,flipX:o=!1,angle:d=0,skewX:l=0,skewY:c=0}=t,u=e.getCellWithCoordByOffset(n,r);if(u==null)return;const g={column:u.actualColumn,columnOffset:Pe(n-u.startX,1),row:u.actualRow,rowOffset:Pe(r-u.startY,1)},h=e.getCellWithCoordByOffset(n+i,r+s);if(h==null)return;const m={column:h.actualColumn,columnOffset:Pe(n+i-h.startX,1),row:h.actualRow,rowOffset:Pe(r+s-h.startY,1)};return{flipY:a,flipX:o,angle:d,skewX:l,skewY:c,from:g,to:m}}const oe={id:"sheet.operation.clear-drawing-transformer",type:le.MUTATION,handler:(t,e)=>{const n=t.get(ce);return e.forEach(r=>{var i,s;(s=(i=n.getRenderById(r))==null?void 0:i.scene.getTransformer())==null||s.debounceRefreshControls()}),!0}},jt={id:"sheet.command.remove-sheet-image",type:le.COMMAND,handler:(t,e)=>{var n,r,i;const s=t.get(X),a=t.get(pt),o=t.get(xt),d=t.get(me);if(!e)return!1;const{drawings:l}=e,c=[];l.forEach(C=>{const{unitId:_}=C;c.push(_)});const u=d.getBatchRemoveOp(l),{unitId:g,subUnitId:h,undo:m,redo:p,objects:f}=u,w=o.onCommandExecute({id:jt.id,params:e}),v={id:N.id,params:{unitId:g,subUnitId:h,op:p,objects:f,type:k.REMOVE}},b={id:N.id,params:{unitId:g,subUnitId:h,op:m,objects:f,type:k.INSERT}};return wi([...(n=w.preRedos)!=null?n:[],v,...w.redos],s)?(a.pushUndoRedo({unitID:g,undoMutations:[...(r=w.preUndos)!=null?r:[],b,...w.undos,{id:oe.id,params:c}],redoMutations:[...(i=w.preRedos)!=null?i:[],v,...w.redos,{id:oe.id,params:c}]}),!0):!1}},Ai={id:"sheet.command.delete-drawing",type:le.COMMAND,handler:t=>{const e=t.get(X),n=t.get(me).getFocusDrawings();if(n.length===0)return!1;const r=n[0].unitId,i=n.map(s=>{const{unitId:a,subUnitId:o,drawingId:d,drawingType:l}=s;return{unitId:a,subUnitId:o,drawingId:d,drawingType:l}});return e.executeCommand(jt.id,{unitId:r,drawings:i})}};function Ka(t){const e=[];return t.forEach(n=>{const{parent:r,children:i}=n,{unitId:s,subUnitId:a,drawingId:o}=r,d=Gr(0,0,i.map(u=>u.transform||{})),l=i.map(u=>{const g=u.transform||{left:0,top:0},{unitId:h,subUnitId:m,drawingId:p}=u;return{unitId:h,subUnitId:m,drawingId:p,transform:{...g,left:g.left-d.left,top:g.top-d.top},groupId:o}}),c={unitId:s,subUnitId:a,drawingId:o,drawingType:B.DRAWING_GROUP,transform:d};e.push({parent:c,children:l})}),e}function Za(t){const e=[];return t.forEach(n=>{const{parent:r,children:i}=n,{unitId:s,subUnitId:a,drawingId:o,transform:d={width:0,height:0}}=r;if(d==null)return;const l=i.map(u=>{const{transform:g}=u,{unitId:h,subUnitId:m,drawingId:p}=u,f=Yr(g||{},d,d.width||0,d.height||0);return{unitId:h,subUnitId:m,drawingId:p,transform:f,groupId:void 0}}),c={unitId:s,subUnitId:a,drawingId:o,drawingType:B.DRAWING_GROUP,transform:{left:0,top:0}};e.push({parent:c,children:l})}),e}const Pi={id:"sheet.command.group-sheet-image",type:le.COMMAND,handler:(t,e)=>{const n=t.get(X),r=t.get(pt),i=t.get(me);if(!e)return!1;const s=[];e.forEach(({parent:g,children:h})=>{s.push(g.unitId),h.forEach(m=>{s.push(m.unitId)})});const a=i.getGroupDrawingOp(e),{unitId:o,subUnitId:d,undo:l,redo:c,objects:u}=a;return n.syncExecuteCommand(N.id,{op:c,unitId:o,subUnitId:d,objects:u,type:k.GROUP})?(r.pushUndoRedo({unitID:o,undoMutations:[{id:N.id,params:{op:l,unitId:o,subUnitId:d,objects:Za(u),type:k.UNGROUP}},{id:oe.id,params:s}],redoMutations:[{id:N.id,params:{op:c,unitId:o,subUnitId:d,objects:u,type:k.GROUP}},{id:oe.id,params:s}]}),!0):!1}},Sn={id:"sheet.command.insert-sheet-image",type:le.COMMAND,handler:(t,e)=>{var n,r,i;const s=t.get(X),a=t.get(pt),o=t.get(me),d=t.get(xt);if(!e)return!1;const l=e.drawings,c=l.map(C=>C.unitId),u=o.getBatchAddOp(l),{unitId:g,subUnitId:h,undo:m,redo:p,objects:f}=u,w=d.onCommandExecute({id:Sn.id,params:e}),v={id:N.id,params:{op:p,unitId:g,subUnitId:h,objects:f,type:k.INSERT}},b={id:N.id,params:{op:m,unitId:g,subUnitId:h,objects:f,type:k.REMOVE}};return wi([...(n=w.preRedos)!=null?n:[],v,...w.redos],s)?(a.pushUndoRedo({unitID:g,undoMutations:[...(r=w.preUndos)!=null?r:[],b,...w.undos,{id:oe.id,params:c}],redoMutations:[...(i=w.preRedos)!=null?i:[],v,...w.redos,{id:oe.id,params:c}]}),!0):!1}},$i={id:"sheet.command.set-drawing-arrange",type:le.COMMAND,handler:(t,e)=>{const n=t.get(X),r=t.get(pt);if(!e)return!1;const i=t.get(me),{unitId:s,subUnitId:a,drawingIds:o,arrangeType:d}=e,l={unitId:s,subUnitId:a,drawingIds:o};let c;if(d===$e.forward?c=i.getForwardDrawingsOp(l):d===$e.backward?c=i.getBackwardDrawingOp(l):d===$e.front?c=i.getFrontDrawingsOp(l):d===$e.back&&(c=i.getBackDrawingsOp(l)),c==null)return!1;const{objects:u,redo:g,undo:h}=c;return n.syncExecuteCommand(N.id,{op:g,unitId:s,subUnitId:a,objects:u,type:k.ARRANGE})?(r.pushUndoRedo({unitID:s,undoMutations:[{id:N.id,params:{op:h,unitId:s,subUnitId:a,objects:u,type:k.ARRANGE}}],redoMutations:[{id:N.id,params:{op:g,unitId:s,subUnitId:a,objects:u,type:k.ARRANGE}}]}),!0):!1}},bn={id:"sheet.command.set-sheet-image",type:le.COMMAND,handler:(t,e)=>{const n=t.get(X),r=t.get(pt),i=t.get(me);if(!e)return!1;const{drawings:s}=e,a=i.getBatchUpdateOp(s),{unitId:o,subUnitId:d,undo:l,redo:c,objects:u}=a;return n.syncExecuteCommand(N.id,{unitId:o,subUnitId:d,op:c,objects:u,type:k.UPDATE})?(r.pushUndoRedo({unitID:o,undoMutations:[{id:N.id,params:{unitId:o,subUnitId:d,op:l,objects:u,type:k.UPDATE}},{id:oe.id,params:[o]}],redoMutations:[{id:N.id,params:{unitId:o,subUnitId:d,op:c,objects:u,type:k.UPDATE}},{id:oe.id,params:[o]}]}),!0):!1}},Bi={id:"sheet.command.ungroup-sheet-image",type:le.COMMAND,handler:(t,e)=>{const n=t.get(X),r=t.get(pt),i=t.get(me);if(!e)return!1;const s=[];e.forEach(({parent:g,children:h})=>{s.push(g.unitId),h.forEach(m=>{s.push(m.unitId)})});const a=i.getUngroupDrawingOp(e),{unitId:o,subUnitId:d,undo:l,redo:c,objects:u}=a;return n.syncExecuteCommand(N.id,{op:c,unitId:o,subUnitId:d,objects:u,type:k.UNGROUP})?(r.pushUndoRedo({unitID:o,undoMutations:[{id:N.id,params:{op:l,unitId:o,subUnitId:d,objects:Ka(u),type:k.GROUP}},{id:oe.id,params:s}],redoMutations:[{id:N.id,params:{op:c,unitId:o,subUnitId:d,objects:u,type:k.UNGROUP}},{id:oe.id,params:s}]}),!0):!1}};var Ja=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Se=(t,e)=>(n,r)=>e(n,r,t);function qa(t,e,n){const r=n*Math.PI/180,i=Math.abs(t*Math.cos(r))+Math.abs(e*Math.sin(r)),s=Math.abs(t*Math.sin(r))+Math.abs(e*Math.cos(r));return{rotatedWidth:i,rotatedHeight:s}}function Hn(t,e,n,r,i){var s;const{rotatedHeight:a,rotatedWidth:o}=qa(n,r,i),d=t.get(ce).getRenderById(e.unitId);if(!d)return!1;const l=(s=d.with(he).getSkeletonParam(e.subUnitId))==null?void 0:s.skeleton;if(l==null)return!1;const c=l.getCellByIndex(e.row,e.col),u=c.mergeInfo.endX-c.mergeInfo.startX-2,g=c.mergeInfo.endY-c.mergeInfo.startY-2,h=o/a,m=Math.ceil(Math.min(u,g*h))/o,p=!m||Number.isNaN(m)?.001:m;return{width:n*p,height:r*p}}let Dt=class extends ge{constructor(t,e,n,r,i,s,a,o,d,l,c,u,g){super(),ye(this,"_workbookSelections"),this._context=t,this._skeletonManagerService=e,this._commandService=n,this._selectionRenderService=r,this._imageIoService=i,this._fileOpenerService=s,this._sheetDrawingService=a,this._drawingManagerService=o,this._contextService=d,this._messageService=l,this._localeService=c,this._injector=g,this._workbookSelections=u.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){const t=await this._fileOpenerService.openFile({multiple:!0,accept:lr.map(n=>`.${n.replace("image/","")}`).join(",")}),e=t.length;return e>ur?(this._messageService.show({type:Me.Error,content:this._localeService.t("update-status.exceedMaxCount",String(ur))}),!1):e===0?!1:(t.forEach(async n=>await this.insertFloatImageByFile(n)),!0)}async insertCellImage(){const t=(await this._fileOpenerService.openFile({multiple:!1,accept:lr.map(e=>`.${e.replace("image/","")}`).join(",")}))[0];return t?(await this._insertCellImage(t),!0):!1}insertCellImageByFile(t,e){return this._insertCellImage(t,e)}async insertFloatImageByFile(t){let e;try{e=await this._imageIoService.saveImage(t)}catch(w){const v=w.message;v===tt.ERROR_EXCEED_SIZE?this._messageService.show({type:Me.Error,content:this._localeService.t("update-status.exceedMaxSize",String(hr/(1024*1024)))}):v===tt.ERROR_IMAGE_TYPE?this._messageService.show({type:Me.Error,content:this._localeService.t("update-status.invalidImageType")}):v===tt.ERROR_IMAGE&&this._messageService.show({type:Me.Error,content:this._localeService.t("update-status.invalidImage")})}if(e==null)return;const n=this._getUnitInfo(),{unitId:r,subUnitId:i}=n,{imageId:s,imageSourceType:a,source:o,base64Cache:d}=e,{width:l,height:c,image:u}=await Mn(d||""),{width:g,height:h}=this._context.scene;this._imageIoService.addImageSourceCache(o,a,u);let m=1;if(l>pr||c>mr){const w=pr/l,v=mr/c;m=Math.max(w,v)}const p=this._getImagePosition(l*m,c*m,g,h);if(p==null)return;const f={unitId:r,subUnitId:i,drawingId:s,drawingType:B.DRAWING_IMAGE,imageSourceType:a,source:o,transform:fe(p,this._selectionRenderService,this._skeletonManagerService),sheetTransform:p};return this._commandService.executeCommand(Sn.id,{unitId:r,drawings:[f]})}async _insertCellImage(t,e){var n,r;let i;try{i=await this._imageIoService.saveImage(t)}catch(C){const _=C.message;_===tt.ERROR_EXCEED_SIZE?this._messageService.show({type:Me.Error,content:this._localeService.t("update-status.exceedMaxSize",String(hr/(1024*1024)))}):_===tt.ERROR_IMAGE_TYPE?this._messageService.show({type:Me.Error,content:this._localeService.t("update-status.invalidImageType")}):_===tt.ERROR_IMAGE&&this._messageService.show({type:Me.Error,content:this._localeService.t("update-status.invalidImage")})}if(i==null)return!1;const{imageId:s,imageSourceType:a,source:o,base64Cache:d}=i,{width:l,height:c,image:u}=await Mn(d||"");this._imageIoService.addImageSourceCache(o,a,u);const g=this._workbookSelections.getCurrentLastSelection();if(!g)return!1;let h=g.primary.actualRow,m=g.primary.actualColumn;g.primary.isMerged&&(h=g.primary.startRow,m=g.primary.startColumn);const p=$n("",{}),f=Hn(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:h,col:m},l,c,0);if(!f)return!1;const w={size:{width:f.width,height:f.height},positionH:{relativeFrom:Cr.PAGE,posOffset:0},positionV:{relativeFrom:br.PARAGRAPH,posOffset:0},angle:0},v={unitId:p.getUnitId(),subUnitId:p.getUnitId(),drawingId:s,drawingType:B.DRAWING_IMAGE,imageSourceType:a,source:o,transform:gr(w),docTransform:w,behindDoc:Mr.FALSE,title:"",description:"",layoutType:Rr.INLINE,wrapText:yr.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},b=Bn.drawing.add({documentDataModel:p,drawings:[v],selection:{collapsed:!0,startOffset:0,endOffset:0}});return b?(p.apply(b),this._commandService.syncExecuteCommand(fr.id,{value:{[(n=e==null?void 0:e.row)!=null?n:h]:{[(r=e==null?void 0:e.col)!=null?r:m]:{p:p.getSnapshot(),t:1}}},unitId:e==null?void 0:e.unitId,subUnitId:e==null?void 0:e.subUnitId})):!1}async insertCellImageByUrl(t,e){var n,r;const{width:i,height:s,image:a}=await Mn(t||"");this._imageIoService.addImageSourceCache(t,ht.URL,a);const o=this._workbookSelections.getCurrentLastSelection();if(!o)return!1;const d=$n("",{}),l=Hn(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:o.primary.actualRow,col:o.primary.actualColumn},i,s,0);if(!l)return!1;const c={size:{width:l.width,height:l.height},positionH:{relativeFrom:Cr.PAGE,posOffset:0},positionV:{relativeFrom:br.PARAGRAPH,posOffset:0},angle:0},u={unitId:d.getUnitId(),subUnitId:d.getUnitId(),drawingId:Ke(),drawingType:B.DRAWING_IMAGE,imageSourceType:ht.URL,source:t,transform:gr(c),docTransform:c,behindDoc:Mr.FALSE,title:"",description:"",layoutType:Rr.INLINE,wrapText:yr.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},g=Bn.drawing.add({documentDataModel:d,drawings:[u],selection:{collapsed:!0,startOffset:0,endOffset:0}});return g?(d.apply(g),this._commandService.syncExecuteCommand(fr.id,{value:{[(n=e==null?void 0:e.row)!=null?n:o.primary.actualRow]:{[(r=e==null?void 0:e.col)!=null?r:o.primary.actualColumn]:{p:d.getSnapshot(),t:1}}},unitId:e==null?void 0:e.unitId,subUnitId:e==null?void 0:e.subUnitId})):!1}_getUnitInfo(){const t=this._context.unit,e=t.getActiveSheet(),n=t.getUnitId(),r=e.getSheetId();return{unitId:n,subUnitId:r}}_getImagePosition(t,e,n,r){const i=this._workbookSelections.getCurrentSelections();let s={startRow:0,endRow:0,startColumn:0,endColumn:0};i&&i.length>0&&(s=i[i.length-1].range);const a=zr(this._skeletonManagerService.getCurrent().skeleton,s);if(a==null)return;let{startColumn:o,startRow:d,startX:l,startY:c}=a,u=!1;if(l+t>n&&(l=n-t,l<0&&(l=0,t=n),u=!0),c+e>r&&(c=r-e,c<0&&(c=0,e=r),u=!0),u){const p=this._selectionRenderService.getCellWithCoordByOffset(l,c);if(p==null)return;l=p.startX,c=p.startY,o=p.actualColumn,d=p.actualRow}const g={column:o,columnOffset:0,row:d,rowOffset:0},h=this._selectionRenderService.getCellWithCoordByOffset(l+t,c+e);if(h==null)return;const m={column:h.actualColumn,columnOffset:l+t-h.startX,row:h.actualRow,rowOffset:c+e-h.startY};return{from:g,to:m}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(t=>{const{unitId:e,subUnitId:n,drawingIds:r,arrangeType:i}=t;this._commandService.executeCommand($i.id,{unitId:e,subUnitId:n,drawingIds:r,arrangeType:i})}))}_updateImageListener(){this.disposeWithMe(this._drawingManagerService.featurePluginUpdate$.subscribe(t=>{const e=[];t.length!==0&&(t.forEach(n=>{const{unitId:r,subUnitId:i,drawingId:s,drawingType:a,transform:o}=n;if(o==null)return;const d=this._sheetDrawingService.getDrawingByParam({unitId:r,subUnitId:i,drawingId:s});if(d==null||d.unitId!==this._context.unitId)return;const l=ee({...d.transform,...o},this._selectionRenderService);if(l==null)return;const c={...n,transform:{...d.transform,...o,...fe(l,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...l}};e.push(c)}),e.length>0&&this._commandService.executeCommand(bn.id,{unitId:t[0].unitId,drawings:e}))}))}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(t=>{this._commandService.executeCommand(Pi.id,t);const{unitId:e,subUnitId:n,drawingId:r}=t[0].parent;this._commandService.syncExecuteCommand(We.id,[{unitId:e,subUnitId:n,drawingId:r}])})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(t=>{this._commandService.executeCommand(Bi.id,t)}))}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(t=>{t==null||t.length===0?(this._contextService.setContextValue(lt,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(lt,!0),this._sheetDrawingService.focusDrawing(t))}))}};Dt=Ja([Se(1,j(he)),Se(2,X),Se(3,ft),Se(4,In),Se(5,Us),Se(6,me),Se(7,q),Se(8,vi),Se(9,Fn),Se(10,j(Ie)),Se(11,j(Jn)),Se(12,j(Oe))],Dt);const Cn={id:"sheet.command.insert-float-image",type:le.COMMAND,handler:async(t,e)=>{var n,r;const i=t.get(ve),s=t.get(ce),a=(n=zn(W.UNIVER_SHEET,i,s))==null?void 0:n.with(Dt);if(!a)return!1;const o=e==null?void 0:e.files;if(o){const d=o.map(l=>a.insertFloatImageByFile(l));return(await Promise.all(d)).every(l=>l)}else return(r=a.insertFloatImage())!=null?r:!1}},er={id:"sheet.command.insert-cell-image",type:le.COMMAND,handler:t=>{var e,n;const r=t.get(ve),i=t.get(ce);return(n=(e=zn(W.UNIVER_SHEET,r,i))==null?void 0:e.with(Dt).insertCellImage())!=null?n:!1}},kt={id:"sheet.command.move-drawing",type:le.COMMAND,handler:(t,e)=>{const n=t.get(X),r=t.get(me),i=t.get(ft),{direction:s}=e,a=r.getFocusDrawings();if(a.length===0)return!1;const o=a[0].unitId,d=a.map(l=>{const{transform:c}=l;if(c==null)return null;const u={...c},{left:g=0,top:h=0}=c;return s===Be.UP?u.top=h-1:s===Be.DOWN?u.top=h+1:s===Be.LEFT?u.left=g-1:s===Be.RIGHT&&(u.left=g+1),{...l,transform:u,sheetTransform:ee(u,i)}}).filter(l=>l!=null);return n.syncExecuteCommand(bn.id,{unitId:o,drawings:d})?(n.syncExecuteCommand(oe.id,[o]),!0):!1}},Wi="COMPONENT_SHEET_DRAWING_PANEL",Li={id:"sidebar.operation.sheet-image",type:le.COMMAND,handler:async(t,e)=>{const n=t.get(as),r=t.get(Ie),i=t.get(ve),s=t.get(X);if(!Ce(i))return!1;switch(e.value){case"open":n.open({header:{title:r.t("sheetImage.panel.title")},children:{label:Wi},onClose:()=>{s.syncExecuteCommand(We.id,[])},width:360});break;case"close":default:n.close();break}return!0}},Hi={id:"sheet.operation.edit-sheet-image",type:le.OPERATION,handler:(t,e)=>{const n=t.get(X);return e==null?!1:(n.syncExecuteCommand(We.id,[e]),n.executeCommand(Li.id,{value:"open"}),!0)}},Qa="sheets-drawing-ui.config",Wr={};var eo=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Re=(t,e)=>(n,r)=>e(n,r,t);let on=class extends Hs{constructor(t,e,n,r,i,s,a,o,d,l){super(),ye(this,"_initImagePopupMenu",new Set),this._injector=t,this._localeService=e,this._drawingManagerService=n,this._canvasPopManagerService=r,this._renderManagerService=i,this._univerInstanceService=s,this._messageService=a,this._contextService=o,this._ioService=d,this._commandService=l,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(W.UNIVER_SHEET).pipe(wr(this.dispose$)).subscribe(t=>this._create(t)),this._univerInstanceService.getTypeOfUnitDisposed$(W.UNIVER_SHEET).pipe(wr(this.dispose$)).subscribe(t=>this._dispose(t)),this._univerInstanceService.getAllUnitsForType(W.UNIVER_SHEET).forEach(t=>this._create(t)),this._setupLoadingStatus()}_setupLoadingStatus(){const t="image-upload-loading";let e;this.disposeWithMe(this._ioService.change$.subscribe(n=>{n>0&&!e?e=this._messageService.show({id:t,type:Me.Loading,content:`${this._localeService.t("uploadLoading.loading")}: ${n}`,duration:0}):n===0&&(e==null||e.dispose(),e=void 0)}))}_dispose(t){super.dispose();const e=t.getUnitId();this._renderManagerService.removeRender(e)}_create(t){if(!t)return;const e=t.getUnitId();this._renderManagerService.has(e)&&!this._initImagePopupMenu.has(e)&&(this._popupMenuListener(e),this._initImagePopupMenu.add(e))}_hasCropObject(t){const e=t.getAllObjectsByOrder();for(const n of e)if(n instanceof yt)return!0;return!1}_popupMenuListener(t){var e;const n=(e=this._renderManagerService.getRenderById(t))==null?void 0:e.scene;if(!n)return;const r=n.getTransformerByCreate();if(!r)return;let i;this.disposeWithMe(r.createControl$.subscribe(()=>{if(this._contextService.setContextValue(lt,!0),this._hasCropObject(n))return;const s=r.getSelectedObjectMap();if(s.size>1){i==null||i.dispose();return}const a=s.values().next().value;if(!a)return;const o=a.oKey,d=this._drawingManagerService.getDrawingOKey(o);if(!d)return;const{unitId:l,subUnitId:c,drawingId:u,drawingType:g}=d,h=d.data;if(h&&h.disablePopup)return;i==null||i.dispose();const m=this._canvasPopManagerService.getFeatureMenu(l,c,u,g);i=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(a,{componentKey:bi,direction:"horizontal",offset:[2,0],extraProps:{menuItems:m||this._getImageMenuItems(l,c,u,g)}}))})),this.disposeWithMe(r.clearControl$.subscribe(()=>{i==null||i.dispose(),this._contextService.setContextValue(lt,!1),this._commandService.syncExecuteCommand(We.id,[])})),this.disposeWithMe(this._contextService.contextChanged$.subscribe(s=>{s[lt]===!1&&(i==null||i.dispose())})),this.disposeWithMe(r.changing$.subscribe(()=>{i==null||i.dispose()}))}_getImageMenuItems(t,e,n,r){return[{label:"image-popup.edit",index:0,commandId:Hi.id,commandParams:{unitId:t,subUnitId:e,drawingId:n},disable:r===B.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:jt.id,commandParams:{unitId:t,drawings:[{unitId:t,subUnitId:e,drawingId:n}]},disable:!1},{label:"image-popup.crop",index:2,commandId:Qt.id,commandParams:{unitId:t,subUnitId:e,drawingId:n},disable:r===B.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:Qn.id,commandParams:[{unitId:t,subUnitId:e,drawingId:n}],disable:r===B.DRAWING_DOM}]}};on=eo([Re(0,j(Oe)),Re(1,j(Ie)),Re(2,q),Re(3,j(Es)),Re(4,ce),Re(5,ve),Re(6,Fn),Re(7,vi),Re(8,In),Re(9,X)],on);var to=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},zt=(t,e)=>(n,r)=>e(n,r,t);let Vn=class extends ge{constructor(t,e,n,r,i){super(),ye(this,"_isSetCursor",!1),this._context=t,this._hoverManagerService=e,this._selectionsService=n,this._drawingRenderService=r,this._sheetSkeletonManagerService=i,this._initHover(),this._initImageClick()}_initHover(){this.disposeWithMe(this._hoverManagerService.currentRichTextNoDistinct$.pipe(bs(33)).subscribe(t=>{var e,n;let r=[];t!==null&&(r=this._selectionsService.getWorkbookSelections(this._context.unitId).getCurrentSelections()),r.length>0&&(t==null?void 0:t.unitId)===this._context.unitId&&t!=null&&t.drawing&&r.length===1&&((e=r[0].primary)==null?void 0:e.actualRow)===t.row&&((n=r[0].primary)==null?void 0:n.actualColumn)===t.col?(this._isSetCursor=!0,this._context.scene.setCursor(Ut.ZOOM_IN)):this._isSetCursor&&(this._isSetCursor=!1,this._context.scene.resetCursor())}))}_initImageClick(){this.disposeWithMe(this._hoverManagerService.currentClickedCell$.subscribe(t=>{var e;if(t!=null&&t.drawing&&this._isSetCursor){const n=t.drawing.drawing.drawingOrigin,r=(e=this._sheetSkeletonManagerService.getCurrentSkeleton())==null?void 0:e.imageCacheMap.getImage(n.imageSourceType,n.source);if(!r)return;this._drawingRenderService.previewImage("preview-cell-image",r.src,r.width,r.height),this._context.scene.resetCursor(),this._isSetCursor=!1}}))}};Vn=to([zt(1,j(Ts)),zt(2,j(Jn)),zt(3,j(gt)),zt(4,j(he))],Vn);var no=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Kt=(t,e)=>(n,r)=>e(n,r,t);let Gn=class extends ge{constructor(t,e,n,r,i){super(),this._context=t,this._sheetDrawingService=e,this._drawingManagerService=n,this._sheetSelectionRenderService=r,this._sheetSkeletonManagerService=i,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){this._sheetDrawingService.initializeNotification(this._context.unitId);const t=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(const e in t){const n=t[e];for(const r in n.data){const i=n.data[r];i.sheetTransform&&(i.transform=fe(i.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService))}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}};Gn=no([Kt(1,me),Kt(2,q),Kt(3,j(ft)),Kt(4,j(he))],Gn);var ro=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},it=(t,e)=>(n,r)=>e(n,r,t);function Vi(t,e,n){var r,i,s,a;if(((i=(r=n==null?void 0:n.p)==null?void 0:r.body)==null?void 0:i.dataStream.length)===3&&((a=(s=n.p)==null?void 0:s.drawingsOrder)==null?void 0:a.length)===1){const o=n.p.drawings[n.p.drawingsOrder[0]],d=Hn(t,{unitId:e.unitId,subUnitId:e.subUnitId,row:e.row,col:e.col},o.docTransform.size.width,o.docTransform.size.height,o.docTransform.angle);if(d)return o.transform.width=d.width,o.transform.height=d.height,o.docTransform.size.width=d.width,o.docTransform.size.height=d.height,o.transform.left=0,o.transform.top=0,o.docTransform.positionH.posOffset=0,o.docTransform.positionV.posOffset=0,n.p.documentStyle.pageSize.width=1/0,n.p.documentStyle.pageSize.height=1/0,!0}return!1}let dn=class extends ge{constructor(t,e,n,r,i,s){super(),this._commandService=t,this._sheetInterceptorService=e,this._injector=n,this._drawingManagerService=r,this._docDrawingController=i,this._editorBridgeService=s,this._handleInitEditor(),this._initCellContentInterceptor()}_handleInitEditor(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(t=>{t.visible?t.visible&&(this._drawingManagerService.removeDrawingDataForUnit(Ct),this._docDrawingController.loadDrawingDataForUnit(Ct),this._drawingManagerService.initializeNotification(Ct)):this._drawingManagerService.removeDrawingDataForUnit(Ct)})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{t.id===ls.id&&t.params.unitId===ct&&(this._drawingManagerService.removeDrawingDataForUnit(ct),this._docDrawingController.loadDrawingDataForUnit(ct),this._drawingManagerService.initializeNotification(ct))}))}_initCellContentInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(us.CELL_CONTENT,{effect:Gs.Style,priority:hs.CELL_IMAGE,handler:(t,e,n)=>{var r;return t!=null&&t.p&&(r=t.p.drawingsOrder)!=null&&r.length&&(t===e.rawData&&(t={...e.rawData}),t.interceptorStyle||(t.interceptorStyle={}),t.interceptorStyle.tr={a:0},Vi(this._injector,{unitId:e.unitId,subUnitId:e.subUnitId,row:e.row,col:e.col},t)),n(t)}}))}};dn=ro([it(0,X),it(1,j(xt)),it(2,j(Oe)),it(3,q),it(4,j(Et)),it(5,j(Ds))],dn);var io=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Lr=(t,e)=>(n,r)=>e(n,r,t);let cn=class extends ge{constructor(t,e){super(),this._autoFillService=t,this._injector=e,this._initAutoFillHooks()}_initAutoFillHooks(){this.disposeWithMe(this._autoFillService.addHook({id:"sheet-cell-image-autofill",onBeforeSubmit:(t,e,n,r)=>{new Ys(r).forValue((i,s,a)=>{Vi(this._injector,{unitId:t.unitId,subUnitId:t.subUnitId,row:i,col:s},a)})}}))}};cn=io([Lr(0,j(Os)),Lr(1,j(Oe))],cn);var so=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},It=(t,e)=>(n,r)=>e(n,r,t);const ao=[Ct,Xs,ct];let ln=class extends ge{constructor(t,e,n,r,i){super(),this._commandService=t,this._univerInstanceService=e,this._dialogService=n,this._renderManagerService=r,this._localeService=i,this._initDocImageCopyPasteHooks()}_setCellImage(t){var e;const n=$n("",{}),r=(e=zn(W.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:e.with(gs),i=Bn.drawing.add({documentDataModel:n,drawings:[t],selection:{collapsed:!0,startOffset:0,endOffset:0}});i&&(n.apply(i),r&&r.submitCellData(n))}_initDocImageCopyPasteHooks(){this.disposeWithMe(this._commandService.beforeCommandExecuted(t=>{var e,n;if(t.id===fs.id){const r=t.params,{doc:i}=r,s=this._univerInstanceService.getCurrentUnitOfType(W.UNIVER_DOC);if(s==null||!Object.keys((e=i.drawings)!=null?e:{}).length)return;const a=s.getUnitId();if(ao.includes(a)){if(a!==ct){const o=()=>{this._dialogService.close("sheet-cell-image-copy-paste"),this._commandService.syncExecuteCommand(Sr.id,{visible:!1})};((n=s.getBody())==null?void 0:n.dataStream)===`\r
`?(this._commandService.syncExecuteCommand(Sr.id,{visible:!1}),this._setCellImage(Object.values(i.drawings)[0])):this._dialogService.open({id:"sheet-cell-image-copy-paste",title:{label:this._localeService.t("cell-image.pasteTitle")},children:{label:this._localeService.t("cell-image.pasteContent")},width:320,destroyOnClose:!0,onClose:o,showOk:!0,showCancel:!0,onOk:()=>{o(),this._setCellImage(Object.values(i.drawings)[0])},onCancel:o})}throw new Error("Sheet cell image copy paste is not supported in this unit")}}}))}};ln=so([It(0,X),It(1,ve),It(2,Xr),It(3,ce),It(4,j(Ie))],ln);var oo=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},_t=(t,e)=>(n,r)=>e(n,r,t);const Gi="image/png";function co(t){const e=t.split(","),n=atob(e[1]),r=n.length,i=new Uint8Array(r);for(let s=0;s<r;s++)i[s]=n.charCodeAt(s);return new Blob([i],{type:Gi})}function lo(t){const e=new ClipboardItem({[Gi]:co(t)});navigator.clipboard.write([e]).catch(n=>{console.error("Could not copy image using clipboard API: ",n)})}function uo(){function t(){const r=document.createElement("input");return r.style.position="absolute",r.style.height="1px",r.style.width="1px",r.style.opacity="0",r}const e=document.activeElement,n=t();return document.body.appendChild(n),n.focus(),()=>{n.blur(),document.body.removeChild(n),e instanceof HTMLElement&&e.focus()}}const Hr=[ot.SPECIAL_PASTE_COL_WIDTH,ot.SPECIAL_PASTE_VALUE,ot.SPECIAL_PASTE_FORMAT,ot.SPECIAL_PASTE_FORMULA];let un=class extends ge{constructor(t,e,n,r,i){super(),ye(this,"_copyInfo"),this._sheetClipboardService=t,this._renderManagerService=e,this._drawingService=n,this._clipboardInterfaceService=r,this._commandService=i,this._initCopyPaste()}get _focusedDrawings(){return this._drawingService.getFocusDrawings()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:(t,e,n,r)=>{const i=this._focusedDrawings;if(i.length>0){const[s]=i;if(r===Le.CUT){const o={unitId:t,drawings:[s]};this._commandService.executeCommand(jt.id,o)}setTimeout(()=>{const o=uo();s.drawingType===B.DRAWING_IMAGE&&s.imageSourceType===ht.BASE64?lo(s.source):this._clipboardInterfaceService.writeText(""),o()},200);const a={unitId:s.unitId,subUnitId:s.subUnitId,drawings:[s]};this._copyInfo=a}else{const s=this._createDrawingsCopyInfoByRange(t,e,n);this._copyInfo=s}},onPasteCells:(t,e,n,r)=>{if(!this._copyInfo)return{redos:[],undos:[]};const{copyType:i=Le.COPY,pasteType:s}=r,{range:a}=t||{},{range:o,unitId:d,subUnitId:l}=e;return this._copyInfo.copyRange?this._generateRangeDrawingsPasteMutations({pasteType:s,unitId:d,subUnitId:l,pasteRange:o},{copyRange:a,copyType:i}):this._generateSingleDrawingPasteMutations({pasteTo:e,pasteType:s},Le.COPY)},onPastePlainText:(t,e)=>({undos:[],redos:[]}),onPasteUnrecognized:t=>this._copyInfo?this._generateSingleDrawingPasteMutations({pasteTo:t,pasteType:ot.DEFAULT_PASTE},Le.COPY):{undos:[],redos:[]},onPasteFiles:(t,e)=>{if(this._copyInfo)return this._generateSingleDrawingPasteMutations({pasteTo:t,pasteType:ot.DEFAULT_PASTE},Le.COPY);{const n=e.filter(r=>r.type.includes("image"));if(n.length)return{undos:[],redos:[{id:Cn.id,params:{files:n}}]}}return{undos:[],redos:[]}}})}_createDrawingsCopyInfoByRange(t,e,n){var r;const i=(r=this._renderManagerService.getRenderById(t))==null?void 0:r.with(he);if(!i)return;const s=i.attachRangeWithCoord(n);if(!s)return;const{startX:a,endX:o,startY:d,endY:l}=s,c=this._drawingService.getDrawingData(t,e),u=this._focusedDrawings.slice();if(Object.keys(c).forEach(g=>{const h=c[g],{transform:m}=h;if(h.anchorType!==P.Both||!m)return;const{left:p=0,top:f=0,width:w=0,height:v=0}=m,{drawingStartX:b,drawingEndX:C,drawingStartY:_,drawingEndY:S}={drawingStartX:p,drawingEndX:p+w,drawingStartY:f,drawingEndY:f+v};a<=b&&C<=o&&d<=_&&S<=l&&u.push(h)}),u.length)return{copyRange:n,drawings:u,unitId:t,subUnitId:e}}_generateSingleDrawingPasteMutations(t,e){const{pasteType:n,pasteTo:r}=t;if(Hr.includes(n))return{redos:[],undos:[]};const{unitId:i,subUnitId:s,range:a}=r,o=this._renderManagerService.getRenderById(i),d=o==null?void 0:o.with(he),l=o==null?void 0:o.with(ft),c=this._copyInfo;if(!d||!l)return{redos:[],undos:[]};const{drawings:u}=c,g=_r(a);return this._generateMutations(u,{unitId:i,subUnitId:s,isCut:e===Le.CUT,getTransform:(h,m)=>{var p;const f=d.attachRangeWithCoord({startRow:g.startRow,endRow:g.endRow,startColumn:g.startColumn,endColumn:g.endColumn}),w={...h,left:f==null?void 0:f.startX,top:f==null?void 0:f.startY};return{transform:w,sheetTransform:(p=ee(w,l))!=null?p:m}}})}_generateMutations(t,e){const{unitId:n,subUnitId:r,getTransform:i,isCut:s}=e,a=[],o=[],{_drawingService:d}=this;return t.forEach(l=>{const{transform:c,sheetTransform:u}=l;if(!c)return;const g=i(c,u),h={...l,unitId:n,subUnitId:r,drawingId:s?l.drawingId:Ke(),transform:g.transform,sheetTransform:g.sheetTransform};if(s){const{undo:m,redo:p,objects:f}=d.getBatchUpdateOp([h]);a.push({id:N.id,params:{unitId:n,subUnitId:r,type:k.UPDATE,op:p,objects:f}}),o.push({id:N.id,params:{unitId:n,subUnitId:r,type:k.UPDATE,op:m,objects:f}})}else{const{undo:m,redo:p,objects:f}=d.getBatchAddOp([h]);a.push({id:N.id,params:{op:p,unitId:n,subUnitId:r,objects:f,type:k.INSERT}}),o.push({id:N.id,params:{op:m,unitId:n,subUnitId:r,objects:f,type:k.REMOVE}})}}),{redos:a,undos:o}}_generateRangeDrawingsPasteMutations(t,e){var n;const{unitId:r,subUnitId:i,pasteType:s,pasteRange:a}=t,{copyRange:o,copyType:d}=e;if(Hr.includes(s))return{redos:[],undos:[]};const l=(n=this._renderManagerService.getRenderById(r))==null?void 0:n.with(he);if(!l||!this._copyInfo)return{redos:[],undos:[]};const{drawings:c}=this._copyInfo;if(!o)return this._generateSingleDrawingPasteMutations({pasteTo:{unitId:r,subUnitId:i,range:_r(a)},pasteType:s},d);const{ranges:[u,g],mapFunc:h}=cs([o,a]),{row:m,col:p}=h(u.startRow,u.startColumn),{row:f,col:w}=h(g.startRow,g.startColumn),v=l.attachRangeWithCoord({startRow:m,endRow:m,startColumn:p,endColumn:p}),b=l.attachRangeWithCoord({startRow:f,endRow:f,startColumn:w,endColumn:w});if(!v||!b||!this._copyInfo)return{redos:[],undos:[]};const C=b.startX-v.startX,_=b.startY-v.startY,S=f-m,I=w-p;return this._generateMutations(c,{unitId:r,subUnitId:i,getTransform:(y,M)=>{var D,E;return{transform:{...y,left:((D=y==null?void 0:y.left)!=null?D:0)+C,top:((E=y==null?void 0:y.top)!=null?E:0)+_},sheetTransform:{...M,to:{...M.to,row:M.to.row+S,column:M.to.column+I},from:{...M.from,row:M.from.row+S,column:M.from.column+I}}}},isCut:d===Le.CUT})}};un=oo([_t(0,xs),_t(1,ce),_t(2,q),_t(3,js),_t(4,X)],un);var ho=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},St=(t,e)=>(n,r)=>e(n,r,t);let hn=class extends ge{constructor(t,e,n,r,i){super(),this._drawingManagerService=t,this._renderManagerService=e,this._permissionService=n,this._univerInstanceService=r,this._userManagerService=i,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){const t=this._univerInstanceService.getCurrentTypeOfUnit$(W.UNIVER_SHEET),e=this._userManagerService.currentUser$,n=Lt([t,e]);this.disposeWithMe(n.pipe(De(([r,i])=>r?r.activeSheet$.pipe(Ur(s=>{if(!s){this._drawingManagerService.setDrawingVisible(!1);return}const a=r.getUnitId(),o=s.getSheetId();this._permissionService.composePermission([new vr(a).id,new Ir(a,o).id]).every(d=>d.value)?this._drawingManagerService.setDrawingVisible(!0):this._handleDrawingVisibilityFalse(r,s)})):(this._drawingManagerService.setDrawingVisible(!1),xe))).subscribe())}_handleDrawingVisibilityFalse(t,e){this._drawingManagerService.setDrawingVisible(!1);const n=t.getUnitId(),r=e.getSheetId(),i=this._drawingManagerService.getDrawingData(n,r),s=Object.values(i),a=this._renderManagerService.getRenderById(n),o=a==null?void 0:a.scene;o&&o.getAllObjectsByOrder().forEach(d=>{d.classType===Ne.IMAGE&&s.some(l=>d.oKey.includes(l.drawingId))&&o.removeObject(d)})}_initDrawingEditable(){const t=this._univerInstanceService.getCurrentTypeOfUnit$(W.UNIVER_SHEET),e=this._userManagerService.currentUser$,n=Lt([t,e]);this.disposeWithMe(n.pipe(De(([r,i])=>r?r.activeSheet$.pipe(Ur(s=>{if(!s){this._drawingManagerService.setDrawingEditable(!1);return}const a=r.getUnitId(),o=s.getSheetId();this._permissionService.composePermission([new jn(a).id,new kn(a,o).id]).every(d=>d.value)?this._drawingManagerService.setDrawingEditable(!0):this._handleDrawingEditableFalse(r,s)})):(this._drawingManagerService.setDrawingEditable(!1),xe))).subscribe())}_handleDrawingEditableFalse(t,e){this._drawingManagerService.setDrawingEditable(!1);const n=t.getUnitId(),r=e.getSheetId(),i=this._drawingManagerService.getDrawingData(n,r),s=Object.values(i),a=this._renderManagerService.getRenderById(n),o=a==null?void 0:a.scene;o&&o.getAllObjectsByOrder().forEach(d=>{d.classType===Ne.IMAGE&&s.some(l=>d.oKey.includes(l.drawingId))&&o.detachTransformerFrom(d)})}_initViewPermissionChange(){const t=this._univerInstanceService.getCurrentTypeOfUnit$(W.UNIVER_SHEET),e=this._userManagerService.currentUser$;this.disposeWithMe(Lt([t,e]).pipe(De(([n,r])=>n?n.activeSheet$.pipe(De(i=>{if(!i)return xe;const s=n.getUnitId(),a=i.getSheetId(),o=this._renderManagerService.getRenderById(s),d=o==null?void 0:o.scene;if(!d)return xe;const l=d.getTransformerByCreate();return this._permissionService.composePermission$([new vr(s).id,new Ir(s,a).id]).pipe(Ye(c=>c.every(u=>u.value)),Er()).pipe(Ye(c=>({permission:c,scene:d,transformer:l,unitId:s,subUnitId:a})))})):xe)).subscribe({next:({permission:n,scene:r,transformer:i,unitId:s,subUnitId:a})=>{this._drawingManagerService.setDrawingVisible(n);const o=r.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(s,a),l=Object.values(d);n?this._drawingManagerService.addNotification(l):(o.forEach(c=>{c.classType===Ne.IMAGE&&l.some(u=>c.oKey.includes(u.drawingId))&&r.removeObject(c)}),i.clearSelectedObjects())},complete:()=>{this._drawingManagerService.setDrawingVisible(!0);const n=this._univerInstanceService.getCurrentUnitForType(W.UNIVER_SHEET),r=n==null?void 0:n.getActiveSheet(),i=n==null?void 0:n.getUnitId(),s=r==null?void 0:r.getSheetId();if(!i||!s)return;const a=this._drawingManagerService.getDrawingData(i,s),o=Object.values(a);this._drawingManagerService.addNotification(o)}}))}_initEditPermissionChange(){const t=this._univerInstanceService.getCurrentTypeOfUnit$(W.UNIVER_SHEET),e=this._userManagerService.currentUser$;this.disposeWithMe(Lt([t,e]).pipe(De(([n,r])=>n?n.activeSheet$.pipe(De(i=>{if(!i)return xe;const s=n.getUnitId(),a=i.getSheetId(),o=this._renderManagerService.getRenderById(s),d=o==null?void 0:o.scene;if(!d)return xe;const l=d.getTransformerByCreate();return this._permissionService.composePermission$([new jn(s).id,new kn(s,a).id]).pipe(Ye(c=>c.every(u=>u.value)),Er()).pipe(Ye(c=>({permission:c,scene:d,transformer:l,unitId:s,subUnitId:a})))})):xe)).subscribe({next:({permission:n,scene:r,transformer:i,unitId:s,subUnitId:a})=>{this._drawingManagerService.setDrawingEditable(n);const o=r.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(s,a),l=Object.values(d);n?(o.forEach(c=>{c.classType===Ne.IMAGE&&l.some(u=>c.oKey.includes(u.drawingId))&&r.attachTransformerTo(c)}),this._drawingManagerService.addNotification(l)):(o.forEach(c=>{c.classType===Ne.IMAGE&&l.some(u=>c.oKey.includes(u.drawingId))&&r.detachTransformerFrom(c)}),i.clearSelectedObjects())},complete:()=>{const n=this._univerInstanceService.getCurrentUnitForType(W.UNIVER_SHEET);if(!n)return;const r=n.getUnitId(),i=n.getActiveSheet();if(!i)return;const s=i.getSheetId(),a=this._renderManagerService.getRenderById(r),o=a==null?void 0:a.scene;if(!o)return;const d=this._drawingManagerService.getDrawingData(r,s),l=Object.values(d);this._drawingManagerService.setDrawingEditable(!0),o.getAllObjectsByOrder().forEach(c=>{c.classType===Ne.IMAGE&&l.some(u=>c.oKey.includes(u.drawingId))&&o.detachTransformerFrom(c)})}}))}};hn=ho([St(0,q),St(1,ce),St(2,qs),St(3,ve),St(4,j(Qs))],hn);var go=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Ve=(t,e)=>(n,r)=>e(n,r,t);function Yi(t,e,n,r,i,s=!1){const{scaleX:a,scaleY:o}=e.getAncestorScale(),d=e.getViewport(Kr.VIEW_MAIN),l=r.getFreeze(),{startColumn:c,startRow:u,xSplit:g,ySplit:h}=l,m={left:!0,top:!0};if(!d)return{...t,absolute:m};const{left:p,right:f,top:w,bottom:v}=t;let{top:b,left:C,viewportScrollX:_,viewportScrollY:S}=d;const{boundsOfViewArea:I,scrollDirectionResponse:y}=i||{},{rowHeaderWidth:M,columnHeaderHeight:D}=n,E={top:s?0:D,left:s?0:M};I&&(dt.isDefine(E.top)&&(E.top=I.top),dt.isDefine(E.left)&&(E.left=I.left)),y==="HORIZONTAL"&&(S=0),y==="VERTICAL"&&(_=0);let U=0,T=0;const A=n.rowStartY(u-h)+D,$=n.colStartX(c-g)+M,re=n.rowStartY(u)+D,Q=n.colStartX(c)+M;if(g===0)m.left=!1,U=(p-_)*a,T=(f-_)*a;else{const V=p-($-M),_e=f-($-M);f<Q?(U=V*a,T=_e*a):p<=Q&&f>=Q?(U=V*a,T=Math.max(C,(f-_)*a)):p>Q&&(m.left=!1,U=Math.max((p-_)*a,C),T=Math.max((f-_)*a,C))}let L=0,K=0;if(h===0)m.top=!1,L=(w-S)*o,K=(v-S)*o;else{const V=w-(A-D),_e=v-(A-D);v<re?(L=V*o,K=_e*o):w<=re&&v>=re?(L=V*o,K=Math.max(b,(v-S)*o)):w>re&&(m.top=!1,L=Math.max((w-S)*o,b),K=Math.max((v-S)*o,b))}return U=Math.max(U,E.left),L=Math.max(L,E.top),T=Math.max(T,E.left),K=Math.max(K,E.top),{left:U,right:T,top:L,bottom:K,absolute:m}}const Te=(t,e,n,r,i)=>{const{left:s,top:a,width:o,height:d,angle:l}=t,c={left:s,right:s+o,top:a,bottom:a+d},u=Yi(c,e,n,r,i),{scaleX:g,scaleY:h}=e.getAncestorScale();return{startX:u.left,endX:u.right,startY:u.top,endY:u.bottom,rotate:l,width:o*g,height:d*h,absolute:u.absolute}};let Ot=class extends ge{constructor(t,e,n,r,i,s,a){super(),ye(this,"_domLayerInfoMap",new Map),ye(this,"_transformChange$",new Un),ye(this,"transformChange$",this._transformChange$.asObservable()),ye(this,"_add$",new Un),ye(this,"add$",this._add$.asObservable()),ye(this,"_remove$",new Un),ye(this,"remove$",this._remove$.asObservable()),this._renderManagerService=t,this._univerInstanceService=e,this._commandService=n,this._drawingManagerService=r,this._canvasFloatDomService=i,this._sheetDrawingService=s,this._lifecycleService=a,this._drawingAddListener(),this._featureUpdateListener(),this._deleteListener(),this._bindScrollEvent()}_bindScrollEvent(){this._lifecycleService.lifecycle$.pipe($s(t=>t===Js.Rendered),Bs(1)).subscribe(()=>{this._scrollUpdateListener()})}getFloatDomInfo(t){return this._domLayerInfoMap.get(t)}getFloatDomsBySubUnitId(t,e){return Array.from(this._domLayerInfoMap.values()).filter(n=>n.subUnitId===e&&n.unitId===t)}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const e=this._renderManagerService.getRenderById(t),n=e==null?void 0:e.scene;if(e==null||n==null)return null;const r=n.getTransformerByCreate(),i=e.engine.getCanvasElement();return{scene:n,transformer:r,renderUnit:e,canvas:i}}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{t.forEach(e=>{var n;const{unitId:r,subUnitId:i,drawingId:s}=e,a=Ce(this._univerInstanceService,{unitId:r,subUnitId:i}),o=this._drawingManagerService.getDrawingByParam(e),d=this._univerInstanceService.getUnit(r,W.UNIVER_SHEET);if(!d)return;const l=d.getActiveSheet().getSheetId();if(!o||!a)return;const c=(n=this._renderManagerService.getRenderById(r))==null?void 0:n.with(he).getSkeletonParam(i);if(!c)return;const{transform:u,drawingType:g,data:h}=o;if(g!==B.DRAWING_DOM&&g!==B.DRAWING_CHART)return;const m=this._getSceneAndTransformerByDrawingSearch(r);if(m==null)return;const{scene:p,canvas:f}=m;if(u==null)return!0;if(l!==i)return;const{left:w,top:v,width:b,height:C,angle:_,flipX:S,flipY:I,skewX:y,skewY:M}=u,D=J({unitId:r,subUnitId:i,drawingId:s}),E=p.getObject(D);if(E!=null){E.transformByState({left:w,top:v,width:b,height:C,angle:_,flipX:S,flipY:I,skewX:y,skewY:M});return}const U={left:w,top:v,width:b,height:C,zIndex:this._drawingManagerService.getDrawingOrder(r,i).length-1},T=g===B.DRAWING_CHART;if(U.rotateEnabled=!1,T){const V=h?h.backgroundColor:"white";U.fill=V,h&&h.border&&(U.stroke=h.border),U.paintFirst="stroke",U.strokeWidth=1,U.borderEnabled=!1,U.radius=8}const A=new ke(D,U);T&&A.setObjectType(dr.CHART),p.addObject(A,ze),o.allowTransform!==!1&&p.attachTransformerTo(A);const $=new Wt,re=Te(A,m.renderUnit.scene,c.skeleton,a.worksheet),Q=new at(re),L={dispose:$,rect:A,position$:Q,unitId:r,subUnitId:i,id:s};this._canvasFloatDomService.addFloatDom({position$:Q,id:s,componentKey:o.componentKey,onPointerDown:V=>{f.dispatchEvent(new PointerEvent(V.type,V))},onPointerMove:V=>{f.dispatchEvent(new PointerEvent(V.type,V))},onPointerUp:V=>{f.dispatchEvent(new PointerEvent(V.type,V))},onWheel:V=>{f.dispatchEvent(new WheelEvent(V.type,V))},data:h,unitId:r});const K=A.onTransformChange$.subscribeEvent(()=>{const V=Te(A,m.renderUnit.scene,c.skeleton,a.worksheet);Q.next(V)});$.add(()=>{this._canvasFloatDomService.removeFloatDom(s)}),K&&$.add(K),this._domLayerInfoMap.set(s,L)})})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(e=>{var n;const{unitId:r,subUnitId:i,drawingId:s}=e,a=J({unitId:r,subUnitId:i,drawingId:s}),o=this._getSceneAndTransformerByDrawingSearch(r);if(o==null)return;const{transformer:d,scene:l}=o,c=l.getObject(a);c!=null&&c.oKey&&(d.clearControlByIds([c==null?void 0:c.oKey]),(n=l.getTransformer())==null||n.clearSelectedObjects())})}))}_scrollUpdateListener(){const t=(e,n)=>{var r;const i=this._getSceneAndTransformerByDrawingSearch(e),s=Array.from(this._domLayerInfoMap.keys()).map(d=>({id:d,...this._domLayerInfoMap.get(d)})).filter(d=>d.subUnitId===n&&d.unitId===e).map(d=>d.id),a=Ce(this._univerInstanceService,{unitId:e,subUnitId:n}),o=(r=this._renderManagerService.getRenderById(e))==null?void 0:r.with(he).getSkeletonParam(n);!i||!a||!o||s.forEach(d=>{const l=this._domLayerInfoMap.get(d);if(l){const c=Te(l.rect,i.renderUnit.scene,o.skeleton,a.worksheet,l);l.position$.next(c)}})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(W.UNIVER_SHEET).pipe(De(e=>e?e.activeSheet$:Pn(null)),Ye(e=>{if(!e)return null;const n=e.getUnitId(),r=this._renderManagerService.getRenderById(n);return r?{render:r,unitId:n,subUnitId:e.getSheetId()}:null}),De(e=>e?Ls(e.render.scene.getViewport(Kr.VIEW_MAIN).onScrollAfter$).pipe(Ye(()=>({unitId:e.unitId,subUnitId:e.subUnitId}))):Pn(null))).subscribe(e=>{if(!e)return;const{unitId:n,subUnitId:r}=e;t(n,r)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===cr.id){const n=e.params,{unitId:r}=n;Array.from(this._domLayerInfoMap.values()).filter(i=>i.unitId===r).map(i=>i.subUnitId).forEach(i=>{t(r,i)})}else if(e.id===ns.id){const{unitId:n,subUnitId:r}=e.params;t(n,r)}}))}updateFloatDomProps(t,e,n,r){const i=this._domLayerInfoMap.get(n),s=this._getSceneAndTransformerByDrawingSearch(t);if(i&&s){const{scene:a}=s,o=J({unitId:t,subUnitId:e,drawingId:n}),d=a.getObject(o);d&&d instanceof ke&&d.setProps(r)}}_getPosition(t,e){var n;const{startX:r,endX:i,startY:s,endY:a}=t,o=(n=this._renderManagerService.getRenderById(e))==null?void 0:n.with(ft);if(o==null)return;const d=o.getCellWithCoordByOffset(r,s);if(d==null)return;const l={column:d.actualColumn,columnOffset:r-d.startX,row:d.actualRow,rowOffset:s-d.startY},c=o.getCellWithCoordByOffset(i,a);if(c==null)return;const u={column:c.actualColumn,columnOffset:i-c.startX,row:c.actualRow,rowOffset:a-c.startY};return{from:l,to:u}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(e=>{const n=this._drawingManagerService.getDrawingByParam(e);if(!n||n.drawingType!==B.DRAWING_DOM&&n.drawingType!==B.DRAWING_CHART)return;const r={...n.transform};this._transformChange$.next({id:e.drawingId,value:r}),this._canvasFloatDomService.updateFloatDom(e.drawingId,{...n});const i=this._getSceneAndTransformerByDrawingSearch(e.unitId);if(i&&n.drawingType!==B.DRAWING_CHART){const{scene:s}=i,a=this._domLayerInfoMap.get(e.drawingId);a!=null&&a.rect&&(n.allowTransform===!1?s.detachTransformerFrom(a.rect):s.attachTransformerTo(a.rect))}})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(e=>{this._removeDom(e.drawingId)})}))}addFloatDomToPosition(t,e){const n=Ce(this._univerInstanceService,{unitId:t.unitId,subUnitId:t.subUnitId});if(!n)throw new Error("cannot find current target!");const{unitId:r,subUnitId:i}=n,{initPosition:s,componentKey:a,data:o,allowTransform:d=!0}=t,l=e??Ke(),c=this._getPosition(s,r);if(c==null)return;const u={unitId:r,subUnitId:i,drawingId:l,drawingType:t.type||B.DRAWING_DOM,componentKey:a,sheetTransform:c,transform:{left:s.startX,top:s.startY,width:s.endX-s.startX,height:s.endY-s.startY},data:o,allowTransform:d};return this._commandService.executeCommand(Sn.id,{unitId:r,drawings:[u]}),this._add$.next({unitId:r,subUnitId:i,id:l}),{id:l,dispose:()=>{this._removeDom(l,!0)}}}_removeDom(t,e=!1){const n=this._domLayerInfoMap.get(t);if(!n)return;const{unitId:r,subUnitId:i}=n;this._domLayerInfoMap.delete(t),n.dispose.dispose();const s=this._getSceneAndTransformerByDrawingSearch(r);if(s&&s.scene.removeObject(n.rect),e){const a=this._drawingManagerService.getDrawingByParam({unitId:r,subUnitId:i,drawingId:t});if(!a)return;const o=this._sheetDrawingService.getBatchRemoveOp([a]),{redo:d,objects:l}=o;this._commandService.syncExecuteCommand(N.id,{unitId:r,subUnitId:i,op:d,objects:l,type:k.REMOVE})}}addFloatDomToRange(t,e,n,r){var i,s,a;const o=Ce(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!o)throw new Error("cannot find current target!");const{unitId:d,subUnitId:l}=o,c=this._getSceneAndTransformerByDrawingSearch(d);if(!c)return;const u=this._renderManagerService.getRenderById(d);if(!u)return;const g=(i=this._renderManagerService.getRenderById(d))==null?void 0:i.with(he).getWorksheetSkeleton(l);if(!g)return;const{componentKey:h,data:m,allowTransform:p=!0}=e,f=r??Ke(),{position:w,position$:v}=this._createRangePositionObserver(t,u,g.skeleton);if(this._getPosition(w,d)==null)return;const b=c.scene,{scaleX:C}=b.getAncestorScale(),_=Zt(w,n,C),S={unitId:d,subUnitId:l,drawingId:f,drawingType:e.type||B.DRAWING_DOM,componentKey:h,transform:{left:_.startX,top:_.startY,width:_.width,height:_.height},data:m,allowTransform:p};{const{unitId:I,subUnitId:y,drawingId:M}=S,D=Ce(this._univerInstanceService,{unitId:I,subUnitId:y}),E=S,U=this._univerInstanceService.getUnit(I,W.UNIVER_SHEET);if(!U)return;const T=U.getActiveSheet().getSheetId();if(!E||!D)return;const A=(s=this._renderManagerService.getRenderById(I))==null?void 0:s.with(he);if(!A)return;const $=A.getWorksheetSkeleton(y);if(!$)return;const{transform:re,drawingType:Q,data:L}=E;if(Q!==B.DRAWING_DOM&&Q!==B.DRAWING_CHART)return;const K=this._getSceneAndTransformerByDrawingSearch(I);if(K==null)return;const{scene:V,canvas:_e}=K;if(re==null||T!==y)return;const{left:Ze,top:Je,width:qe,height:Qe,angle:O,flipX:H,flipY:ie,skewX:se,skewY:z}=re,de=J({unitId:I,subUnitId:y,drawingId:M}),ue=V.getObject(de);if(ue!=null){ue.transformByState({left:Ze,top:Je,width:qe,height:Qe,angle:O,flipX:H,flipY:ie,skewX:se,skewY:z});return}const Z={left:Ze,top:Je,width:qe,height:Qe,zIndex:this._drawingManagerService.getDrawingOrder(I,y).length-1},pe=Q===B.DRAWING_CHART;if(pe){const Y=L?L.backgroundColor:"white";Z.fill=Y,Z.rotateEnabled=!1,L&&L.border&&(Z.stroke=L.border),Z.paintFirst="stroke",Z.strokeWidth=1,Z.borderEnabled=!1,Z.radius=8}const ae=new ke(de,Z);pe&&ae.setObjectType(dr.CHART),V.addObject(ae,ze),E.allowTransform!==!1&&V.attachTransformerTo(ae);const be=new Wt,we=V.getMainViewport(),{rowHeaderWidth:mt,columnHeaderHeight:At}=$.skeleton,Pt={top:At,left:mt,bottom:we.bottom,right:we.right},F={dispose:be,rect:ae,boundsOfViewArea:Pt,domAnchor:n,unitId:I,subUnitId:y},yn=Te(ae,K.renderUnit.scene,$.skeleton,D.worksheet,F),et=new at(yn);F.position$=et;let wt={position$:et,id:M,componentKey:E.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:Y=>{_e.dispatchEvent(new WheelEvent(Y.type,Y))},data:L,unitId:I};e.eventPassThrough&&(wt={...wt,onPointerDown:Y=>{_e.dispatchEvent(new PointerEvent(Y.type,Y))},onPointerMove:Y=>{_e.dispatchEvent(new PointerEvent(Y.type,Y))},onPointerUp:Y=>{_e.dispatchEvent(new PointerEvent(Y.type,Y))}}),this._canvasFloatDomService.addFloatDom(wt),this.disposeWithMe(v.subscribe(Y=>{var nr,rr,ir,sr;const ar=Zt({startX:Y.startX,startY:Y.startY,endX:Y.endX,endY:Y.endY,width:(nr=n.width)!=null?nr:Y.width,height:(rr=n.height)!=null?rr:Y.height,absolute:{left:w.absolute.left,top:w.absolute.top}},n),zi=J({unitId:I,subUnitId:y,drawingId:M}),Ki=new ke(zi,{left:ar.startX,top:ar.startY,width:(ir=n.width)!=null?ir:Y.width,height:(sr=n.height)!=null?sr:Y.height,zIndex:this._drawingManagerService.getDrawingOrder(I,y).length-1}),Zi=Te(Ki,K.renderUnit.scene,$.skeleton,D.worksheet,F);et.next(Zi)}));const $t=(a=this._renderManagerService.getRenderById(I))==null?void 0:a.with(he);$t==null||$t.currentSkeleton$.subscribe(Y=>{Y&&$.sheetId!==Y.sheetId&&this._removeDom(f,!0)});const tr=ae.onTransformChange$.subscribeEvent(()=>{const Y=Te(ae,K.renderUnit.scene,$.skeleton,D.worksheet,F);et.next(Y)});be.add(()=>{this._canvasFloatDomService.removeFloatDom(M)}),tr&&be.add(tr),this._domLayerInfoMap.set(M,F)}return{id:f,dispose:()=>{this._removeDom(f,!0)}}}addFloatDomToColumnHeader(t,e,n,r){var i,s,a;const o=Ce(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!o)throw new Error("cannot find current target!");const{unitId:d,subUnitId:l}=o;if(!this._getSceneAndTransformerByDrawingSearch(d))return;const c=this._renderManagerService.getRenderById(d);if(!c)return;const u=(i=this._renderManagerService.getRenderById(d))==null?void 0:i.with(he).getWorksheetSkeleton(l);if(!u)return;const{componentKey:g,data:h,allowTransform:m=!0}=e,p=r??Ke(),{position:f,position$:w}=this._createRangePositionObserver({startRow:0,endRow:0,startColumn:t,endColumn:t},c,u.skeleton),v=f;if(v.startY=0,this._getPosition(f,d)==null)return;const b={unitId:d,subUnitId:l,drawingId:p,drawingType:e.type||B.DRAWING_DOM,componentKey:g,transform:{left:v.startX,top:v.startY,width:v.width,height:v.height},data:h,allowTransform:m};{const{unitId:C,subUnitId:_,drawingId:S}=b,I=Ce(this._univerInstanceService,{unitId:C,subUnitId:_}),y=b,M=this._univerInstanceService.getUnit(C,W.UNIVER_SHEET);if(!M)return;const D=M.getActiveSheet().getSheetId();if(!y||!I)return;const E=(s=this._renderManagerService.getRenderById(C))==null?void 0:s.with(he);if(!E)return;const U=E.getWorksheetSkeleton(_);if(!U)return;const{transform:T,data:A}=y,$=this._getSceneAndTransformerByDrawingSearch(C);if($==null)return;const{scene:re,canvas:Q}=$;if(T==null||D!==_)return;const{left:L,top:K,width:V,height:_e,angle:Ze,flipX:Je,flipY:qe,skewX:Qe,skewY:O}=T,H=J({unitId:C,subUnitId:_,drawingId:S}),ie=re.getObject(H);if(ie!=null){ie.transformByState({left:L,top:K,width:V,height:_e,angle:Ze,flipX:Je,flipY:qe,skewX:Qe,skewY:O});return}const se=Zt({startX:v.startX,startY:0,endX:f.endX,endY:f.endY,width:n.width,height:n.height,absolute:{left:f.absolute.left,top:f.absolute.top}},n),z={left:se.startX,top:se.startY,width:se.width,height:se.height,zIndex:this._drawingManagerService.getDrawingOrder(C,_).length-1},de=new ke(H,z);re.addObject(de,ze),y.allowTransform!==!1&&re.attachTransformerTo(de);const ue=new Wt,Z=re.getMainViewport(),pe={top:0,left:Z.left,bottom:Z.bottom,right:Z.right},ae={dispose:ue,rect:de,unitId:C,subUnitId:_,boundsOfViewArea:pe,domAnchor:n,scrollDirectionResponse:"HORIZONTAL"},be=Te(de,$.renderUnit.scene,U.skeleton,I.worksheet,ae),we=new at(be);ae.position$=we;let mt={position$:we,id:S,componentKey:y.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:F=>{Q.dispatchEvent(new WheelEvent(F.type,F))},data:A,unitId:C};e.eventPassThrough&&(mt={...mt,onPointerDown:F=>{Q.dispatchEvent(new PointerEvent(F.type,F))},onPointerMove:F=>{Q.dispatchEvent(new PointerEvent(F.type,F))},onPointerUp:F=>{Q.dispatchEvent(new PointerEvent(F.type,F))}}),this._canvasFloatDomService.addFloatDom(mt);const At=de.onTransformChange$.subscribeEvent(()=>{const F=Te(de,$.renderUnit.scene,U.skeleton,I.worksheet,ae);we.next(F)});this.disposeWithMe(w.subscribe(F=>{const yn=Zt({startX:F.startX,startY:0,endX:F.endX,endY:F.endY,width:n.width,height:n.height,absolute:{left:f.absolute.left,top:f.absolute.top}},n),et=J({unitId:C,subUnitId:_,drawingId:S}),wt=new ke(et,{left:yn.startX,top:0,width:n.width,height:n.height,zIndex:this._drawingManagerService.getDrawingOrder(C,_).length-1}),$t=Te(wt,$.renderUnit.scene,U.skeleton,I.worksheet,ae);we.next($t)}));const Pt=(a=this._renderManagerService.getRenderById(C))==null?void 0:a.with(he);Pt==null||Pt.currentSkeleton$.subscribe(F=>{F&&u.sheetId!==F.sheetId&&this._removeDom(p,!0)}),ue.add(()=>{this._canvasFloatDomService.removeFloatDom(S)}),At&&ue.add(At),this._domLayerInfoMap.set(S,ae)}return{id:p,dispose:()=>{this._removeDom(p,!0)}}}_createRangePositionObserver(t,e,n){let{startRow:r,startColumn:i}=t;const s=bt(r,i,n),a=new at(s),o=bt(t.endRow,t.endColumn,n),d=new at(o),l=()=>{const p=bt(r,i,n),f=bt(t.endRow,t.endColumn,n);a.next(p),d.next(f)},c=new Wt;c.add(e.engine.clientRect$.subscribe(()=>l())),c.add(this._commandService.onCommandExecuted(p=>{if(p.id===rs.id&&p.params.rowsAutoHeightInfo.findIndex(f=>f.row===r)>-1){l();return}(is.indexOf(p.id)>-1||p.id===ss.id||p.id===cr.id)&&l()}));const u=(p,f)=>{r=p,i=f,l()},g=()=>({rotate:0,width:o.right-s.left,height:o.bottom-s.top,absolute:{left:!0,top:!0},startX:s.left,startY:s.top,endX:o.right,endY:o.bottom}),h=a.pipe(Ye(p=>{const f=bt(t.endRow,t.endColumn,n);return{rotate:0,width:f.right-p.left,height:f.bottom-p.top,absolute:{left:!0,top:!0},startX:p.left,startY:p.top,endX:f.right,endY:f.bottom}})),m=g();return{position$:h,position:m,updateRowCol:u,topLeftPos$:a,rightBottomPos$:d,disposable:c}}};Ot=go([Ve(0,j(ce)),Ve(1,ve),Ve(2,j(X)),Ve(3,q),Ve(4,j(ks)),Ve(5,me),Ve(6,j(ea))],Ot);function bt(t,e,n){const r=n.getCellWithCoordByIndex(t,e),i=r.isMergedMainCell?r.mergeInfo:r;return{left:i.startX,right:i.endX,top:i.startY,bottom:i.endY}}function Zt(t,e,n){var r,i;n=n??1;const s=t.endX-t.startX,a=t.endY-t.startY,o=(r=e==null?void 0:e.width)!=null?r:s,d=(i=e==null?void 0:e.height)!=null?i:a;let l=0,c=0;if(e){if(e.horizonOffsetAlign==="right"){const u=Jt(e.marginX,s*n);l=t.endX-u-o}else l=t.startX+Jt(e.marginX,s);if(e.verticalOffsetAlign==="bottom"){const u=Jt(e.marginY,a*n);c=t.endY-u-d}else c=t.startY+Jt(e.marginY,a)}return{rotate:0,startX:l,startY:c,endX:t.endX,endY:t.endY,width:o,height:d,absolute:{left:t.absolute.left,top:t.absolute.top}}}function Jt(t,e){if(t===void 0)return 0;if(typeof t=="number")return t;const n=Number.parseFloat(t);return e*n/100}const fo=t=>{const{floatDomInfos:e,scene:n,skeleton:r,worksheet:i}=t,s=x.useMemo(()=>e.map(a=>{const{width:o,height:d,angle:l,left:c,top:u}=a.transform,g=Yi({left:c??0,right:(c??0)+(o??0),top:u??0,bottom:(u??0)+(d??0)},n,r,i,void 0,!0),{scaleX:h,scaleY:m}=n.getAncestorScale(),p={startX:g.left,endX:g.right,startY:g.top,endY:g.bottom,rotate:l,width:o*h,height:d*m,absolute:g.absolute},f={position$:new at(p),position:p,id:a.drawingId,componentKey:a.componentKey,onPointerMove:()=>{},onPointerDown:()=>{},onPointerUp:()=>{},onWheel:()=>{},unitId:a.unitId,data:a.data};return[a.drawingId,f]}),[e,n,r,i]);return R.jsx("div",{style:{position:"absolute",top:0,left:0},children:s.map(([a,o])=>R.jsx(Rs,{layer:o,id:a,position:o.position},a))})};var po=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},Ge=(t,e)=>(n,r)=>e(n,r,t);let gn=class extends ge{constructor(t,e,n,r,i,s,a){super(),this._sheetPrintInterceptorService=t,this._drawingRenderService=e,this._drawingManagerService=n,this._renderManagerService=r,this._canvasFloatDomManagerService=i,this._componetManager=s,this._injector=a,this._initPrinting(),this._initPrintingDom()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(t,e,n)=>{const{unitId:r,scene:i,subUnitId:s}=e,a=this._drawingManagerService.getDrawingDataForUnit(r),o=a==null?void 0:a[s];return o&&o.order.forEach(d=>{const l=o.data[d];l.drawingType!==B.DRAWING_CHART&&l.drawingType!==B.DRAWING_DOM&&this._drawingRenderService.renderDrawing(l,i)}),n()}})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:(t,e,n)=>{const{unitId:r,subUnitId:i}=e,s=this._renderManagerService.getRenderById(r);if(!s)return n(t);const a=s.with(he).getSkeletonParam(i);if(!a)return n(t);const o=this._drawingManagerService.getDrawingDataForUnit(r),d=o==null?void 0:o[e.subUnitId];if(!d)return n(t);const{scaleX:l,scaleY:c}=s.scene,u=t?{...t}:{startColumn:0,endColumn:0,endRow:0,startRow:0},g=d.order.map(h=>d.data[h]);return g.length?(g.forEach(h=>{if(!h.groupId&&h.transform&&dt.isDefine(h.transform.left)&&dt.isDefine(h.transform.top)&&dt.isDefine(h.transform.width)&&dt.isDefine(h.transform.height)){const m=a.skeleton.getCellIndexByOffset(h.transform.left,h.transform.top,l,c,{x:0,y:0}),p=a.skeleton.getCellIndexByOffset(h.transform.left+h.transform.width,h.transform.top+h.transform.height,l,c,{x:0,y:0});m.column<u.startColumn&&(u.startColumn=m.column),m.row<u.startRow&&(u.startRow=m.row),u.endRow<p.row&&(u.endRow=p.row),u.endColumn<p.column&&(u.endColumn=p.column)}}),n(u)):n(t)}}))}_initPrintingDom(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_DOM_COLLECT,{handler:(t,e,n)=>{const{unitId:r,subUnitId:i}=e,s=this._drawingManagerService.getDrawingDataForUnit(r),a=s==null?void 0:s[i];if(a){const o=a.order.map(l=>{const c=a.data[l];if(c.drawingType===B.DRAWING_CHART)return{...c,componentKey:this._componetManager.get(Vs)};if(c.drawingType===B.DRAWING_DOM){const u=this._sheetPrintInterceptorService.getPrintComponent(c.componentKey);return{...c,componentKey:this._componetManager.get(u||c.componentKey)}}return null}).filter(Boolean),d=ds(fo,this._injector);return ia(R.jsx(d,{floatDomInfos:o,scene:e.scene,skeleton:e.skeleton,worksheet:e.worksheet}),e.root),t==null||t.add(()=>{sa(e.root)}),n(t)}}}))}};gn=po([Ge(0,j(Ns)),Ge(1,j(gt)),Ge(2,q),Ge(3,ce),Ge(4,j(Ot)),Ge(5,j(Xn)),Ge(6,j(Oe))],gn);var mo=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},je=(t,e)=>(n,r)=>e(n,r,t);const wo=[Zr.id,Jr.id,qr.id,Qr.id,ei.id,ti.id,ni.id,ri.id,Nn.id,An.id,ii.id,si.id,ai.id,oi.id,di.id,ci.id,li.id,ui.id,hi.id],vo=[ms.id,ws.id,vs.id,Is.id,_s.id,Ss.id];let Yn=class extends ge{constructor(t,e,n,r,i,s,a,o,d){super(),this._context=t,this._renderManagerService=e,this._commandService=n,this._selectionRenderService=r,this._skeletonManagerService=i,this._sheetInterceptorService=s,this._sheetDrawingService=a,this._drawingManagerService=o,this._univerInstanceService=d,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptAfterCommand({getMutations:t=>{if(!wo.includes(t.id))return{redos:[],undos:[]};if(t.params==null)return{redos:[],undos:[]};const e=t.id;if(e===Zr.id)return this._moveRowInterceptor(t.params,"insert");if([li.id,ui.id,hi.id].includes(e))return this._moveRangeInterceptor(t.params);if(e===Jr.id)return this._moveColInterceptor(t.params,"insert");if(e===qr.id)return this._moveRowInterceptor(t.params,"remove");if(e===Qr.id)return this._moveColInterceptor(t.params,"remove");if(e===ei.id){const{range:n}=t.params;return this._getRangeMoveUndo(n,0)}else if(e===ti.id){const{range:n}=t.params;return this._getRangeMoveUndo(n,1)}else if(e===ni.id){const{range:n}=t.params;return this._getRangeMoveUndo(n,2)}else if(e===ri.id){const{range:n}=t.params;return this._getRangeMoveUndo(n,3)}else if(e===ai.id||e===oi.id){const n=t.params,{unitId:r,subUnitId:i,ranges:s}=n;return this._getDrawingUndoForRowVisible(r,i,s)}else if(e===di.id||e===ci.id){const n=t.params,{unitId:r,subUnitId:i,ranges:s}=n;return this._getDrawingUndoForColVisible(r,i,s)}else if(e===Nn.id||e===An.id||e===ii.id||e===si.id){const n=t.params,{unitId:r,subUnitId:i,ranges:s}=n,a=e===Nn.id||e===An.id;return this._getDrawingUndoForRowAndColSize(r,i,s,a)}return{redos:[],undos:[]}}}))}_getRangeMoveUndo(t,e){const n=Ce(this._univerInstanceService);if(n==null)return{redos:[],undos:[]};const r=n.unitId,i=n.subUnitId,s=[],a=[],o=this._sheetDrawingService.getDrawingData(r,i),d=[],l=[];if(Object.keys(o).forEach(c=>{const u=o[c],{updateDrawings:g,deleteDrawings:h}=this._getUpdateOrDeleteDrawings(t,e,u);d.push(...g),l.push(...h)}),d.length===0&&l.length===0)return{redos:[],undos:[]};if(d.length>0){const c=this._sheetDrawingService.getBatchUpdateOp(d),{undo:u,redo:g,objects:h}=c;s.push({id:N.id,params:{unitId:r,subUnitId:i,op:g,objects:h,type:k.UPDATE}}),a.push({id:N.id,params:{unitId:r,subUnitId:i,op:u,objects:h,type:k.UPDATE}})}if(l.length>0){const c=this._sheetDrawingService.getBatchRemoveOp(l),u=c.undo,g=c.redo,h=c.objects;s.push({id:N.id,params:{unitId:r,subUnitId:i,op:g,objects:h,type:k.REMOVE}}),a.push({id:N.id,params:{unitId:r,subUnitId:i,op:u,objects:h,type:k.INSERT}})}return s.push({id:oe.id,params:[r]}),a.push({id:oe.id,params:[r]}),{redos:s,undos:a}}_getUpdateOrDeleteDrawings(t,e,n){const r=[],i=[],{sheetTransform:s,anchorType:a=P.Position,transform:o,unitId:d,subUnitId:l,drawingId:c}=n,{from:u,to:g}=s,{row:h,column:m}=u,{row:p,column:f}=g;if(s==null||o==null)return{updateDrawings:r,deleteDrawings:i};const{startRow:w,endRow:v,startColumn:b,endColumn:C}=t;let _=null,S=null;if(e===0&&h>=w&&p<=v)if(m>=b&&f<=C)i.push({unitId:d,subUnitId:l,drawingId:c});else{const I=this._shrinkCol(s,o,b,C,a);_=I==null?void 0:I.newSheetTransform,S=I==null?void 0:I.newTransform}else if(e===1&&m>=b&&f<=C)if(h>=w&&p<=v)i.push({unitId:d,subUnitId:l,drawingId:c});else{const I=this._shrinkRow(s,o,w,v,a);_=I==null?void 0:I.newSheetTransform,S=I==null?void 0:I.newTransform}else if(e===2){const I=this._expandRow(s,o,w,v,a);_=I==null?void 0:I.newSheetTransform,S=I==null?void 0:I.newTransform}else if(e===3){const I=this._expandCol(s,o,b,C,a);_=I==null?void 0:I.newSheetTransform,S=I==null?void 0:I.newTransform}if(_!=null&&S!=null){const I=fe(_,this._selectionRenderService,this._skeletonManagerService);r.push({...n,sheetTransform:_,transform:I})}return{updateDrawings:r,deleteDrawings:i}}_remainDrawingSize(t,e,n){const r=ee({...t},this._selectionRenderService);r!=null&&e.push({...n,sheetTransform:r})}_getDrawingUndoForColVisible(t,e,n){const r=this._drawingManagerService.getDrawingData(t,e),i=[],s=[];if(Object.keys(r).forEach(c=>{const u=r[c],{sheetTransform:g,transform:h,anchorType:m=P.Position}=u;if(m===P.None)this._remainDrawingSize(h,i,u);else{const{from:p,to:f}=g,{row:w,column:v}=p,{row:b,column:C}=f;for(let _=0;_<n.length;_++){const S=n[_],{startRow:I,endRow:y,startColumn:M,endColumn:D}=S;if(C<M)continue;if(m===P.Position){let T=null,A=null;if(v>=M&&v<=D){const $=this._skeletonManagerService.attachRangeWithCoord({startColumn:v,endColumn:D,startRow:p.row,endRow:f.row});if($==null)return;A={...h,left:$.startX}}if(A!=null&&(T=ee(A,this._selectionRenderService),T!=null&&A!=null)){i.push({...u,sheetTransform:T,transform:A});break}this._remainDrawingSize(h,i,u);continue}if(v>=M&&C<=D)continue;let E=null,U=null;if(v>=M&&v<=D){const T=this._skeletonManagerService.attachRangeWithCoord({startColumn:v,endColumn:D,startRow:p.row,endRow:f.row});if(T==null)return;U={...h,left:(T==null?void 0:T.startX)||0,width:((h==null?void 0:h.width)||0)-T.endX+T.startX}}else if(C>=M&&C<=D){const T=this._skeletonManagerService.attachRangeWithCoord({startColumn:M,endColumn:C,startRow:p.row,endRow:f.row});if(T==null)return;U={...h,left:T.startX-((h==null?void 0:h.width)||0)}}else{const T=this._skeletonManagerService.attachRangeWithCoord({startColumn:M,endColumn:D,startRow:p.row,endRow:f.row});if(T==null)return;if(U={...h,width:((h==null?void 0:h.width)||0)-T.endX+T.startX},E=ee(U,this._selectionRenderService),E!=null&&U!=null){s.push({...u,sheetTransform:E,transform:U});break}}if(U!=null&&(E=ee(U,this._selectionRenderService)),U!=null&&E!=null){i.push({...u,sheetTransform:E,transform:U});break}else this._remainDrawingSize(h,i,u)}}}),i.length===0&&s.length===0)return{redos:[],undos:[]};const{redos:a,undos:o}=this._createUndoAndRedoMutation(t,e,i),d=[],l=[];if(s.length>0){const{redos:c,undos:u}=this._createUndoAndRedoMutation(t,e,s);d.push(...c),l.push(...u)}return{redos:a,undos:o,preRedos:d,preUndos:l}}_createUndoAndRedoMutation(t,e,n){const r=this._sheetDrawingService.getBatchUpdateOp(n),{undo:i,redo:s,objects:a}=r,o=[{id:N.id,params:{unitId:t,subUnitId:e,op:s,objects:a,type:k.UPDATE}},{id:oe.id,params:[t]}],d=[{id:N.id,params:{unitId:t,subUnitId:e,op:i,objects:a,type:k.UPDATE}},{id:oe.id,params:[t]}];return{redos:o,undos:d}}_getDrawingUndoForRowVisible(t,e,n){const r=this._drawingManagerService.getDrawingData(t,e),i=[],s=[];if(Object.keys(r).forEach(c=>{const u=r[c],{sheetTransform:g,transform:h,anchorType:m=P.Position}=u;if(m===P.None)this._remainDrawingSize(h,i,u);else{const{from:p,to:f}=g,{row:w,column:v}=p,{row:b,column:C}=f;for(let _=0;_<n.length;_++){const S=n[_],{startRow:I,endRow:y,startColumn:M,endColumn:D}=S;if(b<I)continue;if(m===P.Position){let T=null,A=null;if(w>=I&&w<=y){const $=this._skeletonManagerService.attachRangeWithCoord({startColumn:p.column,endColumn:f.column,startRow:w,endRow:y});if($==null)return;A={...h,top:$.startY}}if(A!=null&&(T=ee(A,this._selectionRenderService),T!=null&&A!=null)){i.push({...u,sheetTransform:T,transform:A});break}this._remainDrawingSize(h,i,u);continue}if(w>=I&&b<=y)continue;let E=null,U=null;if(w>=I&&w<=y){const T=this._skeletonManagerService.attachRangeWithCoord({startColumn:p.column,endColumn:f.column,startRow:w,endRow:y});if(T==null)return;U={...h,top:(T==null?void 0:T.startY)||0,height:((h==null?void 0:h.height)||0)-T.endY+T.startY}}else if(b>=I&&b<=y){const T=this._skeletonManagerService.attachRangeWithCoord({startColumn:p.column,endColumn:f.column,startRow:I,endRow:b});if(T==null)return;U={...h,top:T.startY-((h==null?void 0:h.height)||0)}}else{const T=this._skeletonManagerService.attachRangeWithCoord({startColumn:p.column,endColumn:f.column,startRow:I,endRow:y});if(T==null)return;if(U={...h,height:((h==null?void 0:h.height)||0)-T.endY+T.startY},E=ee(U,this._selectionRenderService),E!=null&&U!=null){s.push({...u,sheetTransform:E,transform:U});break}}if(U!=null&&(E=ee(U,this._selectionRenderService)),U!=null&&E!=null){i.push({...u,sheetTransform:E,transform:U});break}else this._remainDrawingSize(h,i,u)}}}),i.length===0&&s.length===0)return{redos:[],undos:[]};const{redos:a,undos:o}=this._createUndoAndRedoMutation(t,e,i),d=[],l=[];if(s.length>0){const{redos:c,undos:u}=this._createUndoAndRedoMutation(t,e,s);d.push(...c),l.push(...u)}return{redos:a,undos:o,preRedos:d,preUndos:l}}_getDrawingUndoForRowAndColSize(t,e,n,r){const i=this._drawingManagerService.getDrawingData(t,e),s=[];return Object.keys(i).forEach(a=>{const o=i[a],{sheetTransform:d,transform:l,anchorType:c=P.Position}=o;if(c===P.None)this._remainDrawingSize(l,s,o);else{const{from:u,to:g}=d,{row:h,column:m}=u,{row:p,column:f}=g;for(let w=0;w<n.length;w++){const v=n[w],{startRow:b,endRow:C,startColumn:_,endColumn:S}=v;if(p<b||f<_)continue;if(c===P.Position&&(h<=b&&p>=C||m<=_&&f>=S)){this._remainDrawingSize(l,s,o);continue}const I=fe({...d},this._selectionRenderService,this._skeletonManagerService);if(I!=null){s.push({...o,transform:I});break}}}}),s.length===0?{redos:[],undos:[]}:this._createUndoAndRedoMutation(t,e,s)}_getUnitIdAndSubUnitId(t,e){let n,r;if(e==="insert")n=t.unitId,r=t.subUnitId;else{const i=Ce(this._univerInstanceService);if(i==null)return;n=i.unitId,r=i.subUnitId}return{unitId:n,subUnitId:r}}_moveRangeInterceptor(t){var e,n;const{toRange:r,fromRange:i}=t,s=Ce(this._univerInstanceService);if(!s)return{redos:[],undos:[]};const{unitId:a,subUnitId:o}=s,d=(n=(e=this._renderManagerService.getRenderById(a))==null?void 0:e.with(he))==null?void 0:n.getCurrentSkeleton();if(!d)return{redos:[],undos:[]};const l=zr(d,i);if(!l)return{redos:[],undos:[]};const{startX:c,endX:u,startY:g,endY:h}=l,m=this._sheetDrawingService.getDrawingData(a,o),p=[];Object.keys(m).forEach(_=>{const S=m[_];if(S.anchorType!==P.Both)return;const{transform:I}=S;if(!I)return;const{left:y=0,top:M=0,width:D=0,height:E=0}=I,{drawingStartX:U,drawingEndX:T,drawingStartY:A,drawingEndY:$}={drawingStartX:y,drawingEndX:y+D,drawingStartY:M,drawingEndY:M+E};c<=U&&T<=u&&g<=A&&$<=h&&p.push(S)});const f=[],w=[],v=r.startRow-i.startRow,b=r.startColumn-i.startColumn,C=p.map(_=>{const S=_.sheetTransform,I={to:{...S.to,row:S.to.row+v,column:S.to.column+b},from:{...S.from,row:S.from.row+v,column:S.from.column+b}},y=fe(I,this._selectionRenderService,this._skeletonManagerService);return{unitId:a,subUnitId:o,drawingId:_.drawingId,transform:y,sheetTransform:I}});if(C.length){const _=this._sheetDrawingService.getBatchUpdateOp(C),{undo:S,redo:I,objects:y}=_;f.push({id:N.id,params:{unitId:a,subUnitId:o,op:I,objects:y,type:k.UPDATE}}),w.push({id:N.id,params:{unitId:a,subUnitId:o,op:S,objects:y,type:k.UPDATE}})}return{redos:f,undos:w}}_moveRowInterceptor(t,e){const n=this._getUnitIdAndSubUnitId(t,e);if(n==null)return{redos:[],undos:[]};const{unitId:r,subUnitId:i}=n,{range:s}=t,a=s.startRow,o=s.endRow,d=[],l=[],c=this._sheetDrawingService.getDrawingData(r,i),u=[],g=[];if(Object.keys(c).forEach(h=>{const m=c[h],{sheetTransform:p,transform:f,anchorType:w=P.Position}=m;if(p==null||f==null)return;let v,b;if(e==="insert"){const _=this._expandRow(p,f,a,o,w);v=_==null?void 0:_.newSheetTransform,b=_==null?void 0:_.newTransform}else{const{from:_,to:S}=p,{row:I}=_,{row:y}=S;if(w===P.Both&&I>=a&&y<=o)g.push({unitId:r,subUnitId:i,drawingId:h});else{const M=this._shrinkRow(p,f,a,o,w);v=M==null?void 0:M.newSheetTransform,b=M==null?void 0:M.newTransform}}if(!v||!b)return;const C={unitId:r,subUnitId:i,drawingId:h,transform:b,sheetTransform:v};u.push(C)}),u.length===0&&g.length===0)return{redos:[],undos:[]};if(u.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(u),{undo:m,redo:p,objects:f}=h;d.push({id:N.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:k.UPDATE}}),l.push({id:N.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:k.UPDATE}})}if(g.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(g),m=h.undo,p=h.redo,f=h.objects;d.push({id:N.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:k.REMOVE}}),l.push({id:N.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:k.INSERT}})}return d.push({id:oe.id,params:[r]}),l.push({id:oe.id,params:[r]}),{redos:d,undos:l}}_moveColInterceptor(t,e){const n=this._getUnitIdAndSubUnitId(t,e);if(n==null)return{redos:[],undos:[]};const{unitId:r,subUnitId:i}=n,{range:s}=t,a=s.startColumn,o=s.endColumn,d=[],l=[],c=this._sheetDrawingService.getDrawingData(r,i),u=[],g=[];if(Object.keys(c).forEach(h=>{const m=c[h],{sheetTransform:p,transform:f,anchorType:w=P.Position}=m;if(p==null||f==null)return;let v,b;if(e==="insert"){const _=this._expandCol(p,f,a,o,w);v=_==null?void 0:_.newSheetTransform,b=_==null?void 0:_.newTransform}else{const{from:_,to:S}=p,{column:I}=_,{column:y}=S;if(w===P.Both&&I>=a&&y<=o)g.push({unitId:r,subUnitId:i,drawingId:h});else{const M=this._shrinkCol(p,f,a,o,w);v=M==null?void 0:M.newSheetTransform,b=M==null?void 0:M.newTransform}}if(!v||!b)return;const C={unitId:r,subUnitId:i,drawingId:h,transform:b,sheetTransform:v};u.push(C)}),u.length===0&&g.length===0)return{redos:[],undos:[]};if(u.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(u),{undo:m,redo:p,objects:f}=h;d.push({id:N.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:k.UPDATE}}),l.push({id:N.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:k.UPDATE}})}if(g.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(g),m=h.undo,p=h.redo,f=h.objects;d.push({id:N.id,params:{unitId:r,subUnitId:i,op:p,objects:f,type:k.REMOVE}}),l.push({id:N.id,params:{unitId:r,subUnitId:i,op:m,objects:f,type:k.INSERT}})}return d.push({id:oe.id,params:[r]}),l.push({id:oe.id,params:[r]}),{redos:d,undos:l}}_expandCol(t,e,n,r,i=P.Position){const s=r-n+1,{from:a,to:o}=t,{column:d}=a,{column:l}=o;if(i===P.None)return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};let c=null,u=null;if(d>=n){const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:n,endColumn:r,startRow:a.row,endRow:o.row});if(g==null)return;u={...e,left:(e.left||0)+g.endX-g.startX},c=ee(u,this._selectionRenderService)}else if(l>=r)if(i===P.Both)c={from:{...a},to:{...o,column:l+s}},u=fe(c,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};return c!=null&&u!=null?{newSheetTransform:c,newTransform:u}:null}_shrinkCol(t,e,n,r,i=P.Position){const s=r-n+1,{from:a,to:o}=t,{column:d}=a,{column:l}=o;if(i===P.None)return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};let c=null,u=null;if(d>r)c={from:{...a,column:d-s},to:{...o,column:l-s}},u=fe(c,this._selectionRenderService,this._skeletonManagerService);else{if(d>=n&&l<=r)return null;if(d<n&&l>r)if(i===P.Both)c={from:{...a},to:{...o,column:l-s}},u=fe(c,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};else if(d>=n&&d<=r){if(d===n)u={...e,left:(e.left||0)-t.from.columnOffset};else{const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:n,endColumn:d-1,startRow:a.row,endRow:o.row});if(g==null)return;u={...e,left:(e.left||0)-g.endX+g.startX-t.from.columnOffset}}c=ee(u,this._selectionRenderService)}else if(l>=n&&l<=r&&i===P.Both){const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:n-1,endColumn:n-1,startRow:a.row,endRow:o.row});if(g==null)return;c={from:{...a},to:{...o,column:n-1,columnOffset:g.endX-g.startX}},u=fe(c,this._selectionRenderService,this._skeletonManagerService)}}return c!=null&&u!=null?{newSheetTransform:c,newTransform:u}:null}_expandRow(t,e,n,r,i=P.Position){const s=r-n+1,{from:a,to:o}=t,{row:d}=a,{row:l}=o;if(i===P.None)return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};let c=null,u=null;if(d>=n){const g=this._skeletonManagerService.attachRangeWithCoord({startRow:n,endRow:r,startColumn:a.column,endColumn:o.column});if(g==null)return;u={...e,top:(e.top||0)+g.endY-g.startY},c=ee(u,this._selectionRenderService)}else if(l>=r)if(i===P.Both)c={from:{...a},to:{...o,row:l+s}},u=fe(c,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};return c!=null&&u!=null?{newSheetTransform:c,newTransform:u}:null}_shrinkRow(t,e,n,r,i=P.Position){const s=r-n+1,{from:a,to:o}=t,{row:d}=a,{row:l}=o;if(i===P.None)return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};let c=null,u=null;if(d>r)c={from:{...a,row:d-s},to:{...o,row:l-s}},u=fe(c,this._selectionRenderService,this._skeletonManagerService);else{if(d>=n&&l<=r)return null;if(d<n&&l>r)if(i===P.Both)c={from:{...a},to:{...o,row:l-s}},u=fe(c,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:ee({...e},this._selectionRenderService),newTransform:e};else if(d>=n&&d<=r){if(d===n)u={...e,top:(e.top||0)-t.from.rowOffset};else{const g=this._skeletonManagerService.attachRangeWithCoord({startRow:n,endRow:d-1,startColumn:a.column,endColumn:o.column});if(g==null)return;u={...e,top:(e.top||0)-g.endY+g.startY-t.from.rowOffset}}c=ee(u,this._selectionRenderService)}else if(l>=n&&l<=r&&i===P.Both){const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:a.column,endColumn:a.column,startRow:n-1,endRow:n-1});if(g==null)return;c={from:{...a},to:{...o,row:n-1,rowOffset:g.endY-g.startY}},u=fe(c,this._selectionRenderService,this._skeletonManagerService)}}return c!=null&&u!=null?{newSheetTransform:c,newTransform:u}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===ps.id){const{unitId:e,subUnitId:n}=t.params;this._updateDrawings(e,n)}})),this.disposeWithMe(this._context.activated$.subscribe(t=>{const{unit:e,unitId:n}=this._context;if(t){const r=e.getActiveSheet().getSheetId();this._updateDrawings(n,r)}else this._clearDrawings(n)}))}_clearDrawings(t){setTimeout(()=>{const e=this._drawingManagerService.drawingManagerData,n=[];Object.keys(e).forEach(r=>{const i=e[r];i!=null&&Object.keys(i).forEach(s=>{const a=i[s].data;a!=null&&Object.keys(a).forEach(o=>{r===t&&n.push(a[o])})})}),this._drawingManagerService.removeNotification(n)})}_updateDrawings(t,e){setTimeout(()=>{const n=this._drawingManagerService.drawingManagerData,r=[],i=[];Object.keys(n).forEach(s=>{const a=n[s];a!=null&&Object.keys(a).forEach(o=>{const d=a[o].data;d!=null&&Object.keys(d).forEach(l=>{if(s===t&&o===e){const c=d[l];c.transform=fe(c.sheetTransform,this._selectionRenderService,this._skeletonManagerService),r.push(d[l])}else i.push(d[l])})})}),this._drawingManagerService.removeNotification(i),this._drawingManagerService.addNotification(r)},0)}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{vo.includes(t.id)&&requestIdleCallback(()=>{const e=t.params,{unitId:n,subUnitId:r,ranges:i}=e;this._refreshDrawingTransform(n,r,i)})}))}_refreshDrawingTransform(t,e,n){const r=this._drawingManagerService.getDrawingData(t,e),i=[];Object.keys(r).forEach(s=>{const a=r[s],{sheetTransform:o,transform:d,anchorType:l=P.Position}=a;if(l===P.None)return!0;const{from:c,to:u}=o,{row:g,column:h}=c,{row:m,column:p}=u;for(let f=0;f<n.length;f++){const w=n[f],{startRow:v,endRow:b,startColumn:C,endColumn:_}=w;if(Fs.intersects({startRow:v,endRow:b,startColumn:C,endColumn:_},{startRow:g,endRow:m,startColumn:h,endColumn:p})||g>b||h>_){const S=l===P.Position,I=fe(o,this._selectionRenderService,this._skeletonManagerService);i.push({...a,transform:{...I,width:S?d==null?void 0:d.width:I==null?void 0:I.width,height:S?d==null?void 0:d.height:I==null?void 0:I.height}});break}}}),i.length!==0&&(this._drawingManagerService.refreshTransform(i),this._commandService.syncExecuteCommand(oe.id,[t]))}};Yn=mo([je(1,ce),je(2,X),je(3,ft),je(4,j(he)),je(5,j(xt)),je(6,me),je(7,q),je(8,ve)],Yn);const Io=t=>{var e;const n=ne(X),r=ne(Ie),i=ne(q),s=ne(ce),{drawings:a}=t,o=a[0];if(o==null)return;const{unitId:d}=o,l=s.getRenderById(d),c=l==null?void 0:l.scene;if(c==null)return;const u=c.getTransformerByCreate(),[g,h]=x.useState(!0),m=(e=o.anchorType)!=null?e:P.Position,[p,f]=x.useState(m);function w(b,C){const _=[];return b.forEach(S=>{const{oKey:I}=S,y=C.getDrawingOKey(I);if(y==null)return _.push(null),!0;const{unitId:M,subUnitId:D,drawingId:E,drawingType:U,anchorType:T,sheetTransform:A}=y;_.push({unitId:M,subUnitId:D,drawingId:E,anchorType:T,sheetTransform:A,drawingType:U})}),_}x.useEffect(()=>{const b=u.clearControl$.subscribe(_=>{_===!0&&h(!1)}),C=u.changeStart$.subscribe(_=>{var S;const{objects:I}=_,y=w(I,i);if(y.length===0)h(!1);else if(y.length>=1){h(!0);const M=((S=y[0])==null?void 0:S.anchorType)||P.Position;f(M)}});return()=>{C.unsubscribe(),b.unsubscribe()}},[]);function v(b){f(b);const C=i.getFocusDrawings();if(C.length===0)return;const _=C.map(S=>({unitId:S.unitId,subUnitId:S.subUnitId,drawingId:S.drawingId,anchorType:b}));n.executeCommand(bn.id,{unitId:C[0].unitId,drawings:_})}return R.jsxs("div",{className:Ue("univer-grid univer-gap-2 univer-py-2 univer-text-gray-400",{"univer-hidden":!g}),children:[R.jsx("header",{className:"univer-text-gray-600 dark:!univer-text-gray-200",children:R.jsx("div",{children:r.t("drawing-anchor.title")})}),R.jsx("div",{children:R.jsxs(aa,{value:p,onChange:v,direction:"vertical",children:[R.jsx(En,{value:P.Both,children:r.t("drawing-anchor.both")}),R.jsx(En,{value:P.Position,children:r.t("drawing-anchor.position")}),R.jsx(En,{value:P.None,children:r.t("drawing-anchor.none")})]})})]})},_o=()=>{const t=ne(q),e=t.getFocusDrawings(),[n,r]=x.useState(e);return x.useEffect(()=>{const i=t.focus$.subscribe(s=>{r(s)});return()=>{i.unsubscribe()}},[]),!!(n!=null&&n.length)&&R.jsxs("div",{className:"univer-text-sm",children:[R.jsx(Wa,{drawings:n}),R.jsx(Io,{drawings:n})]})},Xi="sheet.menu.image";function So(t){return{id:Xi,type:Zn.SUBITEMS,icon:"AddImageIcon",tooltip:"sheetImage.title",hidden$:Kn(t,W.UNIVER_SHEET),disabled$:ys(t,{workbookTypes:[jn],worksheetTypes:[kn],rangeTypes:[Ms]})}}function bo(t){return{id:Cn.id,title:"sheetImage.upload.float",type:Zn.BUTTON,hidden$:Kn(t,W.UNIVER_SHEET)}}function Co(t){return{id:er.id,title:"sheetImage.upload.cell",type:Zn.BUTTON,hidden$:Kn(t,W.UNIVER_SHEET)}}const yo={[Cs.MEDIA]:{[Xi]:{order:0,menuItemFactory:So,[Cn.id]:{order:0,menuItemFactory:bo},[er.id]:{order:1,menuItemFactory:Co}}}};function Nt(t){return!t.getContextValue(zs)&&!t.getContextValue(Ks)&&!t.getContextValue(Zs)&&t.getContextValue(lt)}const Ro={id:kt.id,description:"shortcut.drawing-move-down",group:"4_drawing-view",binding:ut.ARROW_DOWN,priority:100,preconditions:Nt,staticParameters:{direction:Be.DOWN}},Mo={id:kt.id,description:"shortcut.drawing-move-up",group:"4_drawing-view",binding:ut.ARROW_UP,priority:100,preconditions:Nt,staticParameters:{direction:Be.UP}},Uo={id:kt.id,description:"shortcut.drawing-move-left",group:"4_drawing-view",binding:ut.ARROW_LEFT,priority:100,preconditions:Nt,staticParameters:{direction:Be.LEFT}},Eo={id:kt.id,description:"shortcut.drawing-move-right",group:"4_drawing-view",binding:ut.ARROW_RIGHT,priority:100,preconditions:Nt,staticParameters:{direction:Be.RIGHT}},To={id:Ai.id,description:"shortcut.drawing-delete",group:"4_drawing-view",preconditions:Nt,binding:ut.DELETE,mac:ut.BACKSPACE};var Do=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},st=(t,e)=>(n,r)=>e(n,r,t);let fn=class extends ge{constructor(t,e,n,r,i,s){super(),this._componentManager=t,this._menuManagerService=e,this._commandService=n,this._shortcutService=r,this._drawingManagerService=i,this._sheetsSelectionsService=s,this._init()}_initCustomComponents(){const t=this._componentManager;this.disposeWithMe(t.register(Wi,_o))}_initMenus(){this._menuManagerService.mergeMenu(yo)}_initCommands(){[Cn,er,Sn,jt,bn,Li,oe,Hi,Pi,Bi,kt,Ai,$i].forEach(t=>this.disposeWithMe(this._commandService.registerCommand(t)))}_initShortcuts(){[Ro,Mo,Uo,Eo,To].forEach(t=>{this.disposeWithMe(this._shortcutService.registerShortcut(t))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};fn=Do([st(0,j(Xn)),st(1,As),st(2,X),st(3,Ps),st(4,q),st(5,j(Jn))],fn);var Oo=Object.defineProperty,xo=(t,e,n)=>e in t?Oo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,jo=(t,e,n,r)=>{for(var i=e,s=t.length-1,a;s>=0;s--)(a=t[s])&&(i=a(i)||i);return i},On=(t,e)=>(n,r)=>e(n,r,t),Fi=(t,e,n)=>xo(t,typeof e!="symbol"?e+"":e,n);const ko="SHEET_IMAGE_UI_PLUGIN";let pn=class extends mn{constructor(t=Wr,e,n,r){super(),this._config=t,this._injector=e,this._renderManagerService=n,this._configService=r;const{menu:i,...s}=wn({},Wr,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(Qa,s)}onStarting(){Ws(this._injector,[[Ot],[fn],[on],[gn],[hn],[un],[dn],[cn],[ln]]),qt(this._injector,[[Ot]])}onReady(){qt(this._injector,[[un],[ln]])}onRendered(){this._registerRenderModules(),qt(this._injector,[[hn],[gn],[fn],[dn],[cn]])}onSteady(){this._injector.get(on)}_registerRenderModules(){[[Dt],[Yn],[Gn],[Vn]].forEach(t=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(W.UNIVER_SHEET,t))})}};Fi(pn,"type",W.UNIVER_SHEET);Fi(pn,"pluginName",ko);pn=jo([mi(Fr,Wn,Ln,Tt),On(1,j(Oe)),On(2,ce),On(3,vn)],pn);export{ee as $,Wa as A,Cn as B,Xi as C,Et as D,me as E,yt as I,_n as L,pn as P,ki as R,gt as U,bn as W,bi as X,P as Y,Qt as Z,Hi as _,Tt as a,en as b,Ua as c,Dr as d,Dt as e,$i as f,k as g,Wn as h,N as i,oe as j,Sn as k,_i as l,Ai as m,Ln as n,Fe as o,Pi as p,kt as q,jt as r,Li as s,Ot as t,Qn as u,Bi as v,Si as w,Te as x,fe as y,qn as z};
