import{O as Li,o as Ui,M as Qe,w as X,V as Ce,a5 as gi,ah as Sn,n as ei,W as bn,af as Rn,dK as oe,d as xn,e as Ai,a0 as We,a6 as ti,s as Oi,a3 as F,ac as Pi,ai as pt,S as gt,da as Wt,v as se,L as te,e2 as Mn,a2 as nt,dr as Et,k as Ni,j as En,ak as Vn,F as de,cM as xe,C as mi,f as Tn,K as kn,D as Dn,_ as jn,e5 as Ln,u as ye,al as le,b6 as we,bh as ee,b7 as ge,e6 as fi,y as $i,U as Un,q as An,I as V,x as ii,B as On}from"./TeamSpreadsheet-DqPQXi__.js";import{M as Le,S as it,pv as ot,I as lt,fq as st,p as Pn,h as Bi,jX as Wi,u as rt,te as Hi,V as Ht,y as Ft,L as Yt,P as Xt,or as Ii,o9 as Nn,p7 as dt,q_ as Zt,qO as _i,nJ as Fi,w as Yi,ms as $n,qE as Bn,of as Je,f as Wn,H as ni,c as Hn,B as Fn,d as P,t6 as Ve,sY as Xi,sV as Kt,k as ri,z as Zi,e4 as Yn,eK as Ki,nh as Xn,hg as wi,gU as Zn,f4 as Kn,hn as He,f0 as Fe,hr as Me,ft as et,gT as Ci,gj as zi,oW as zn,gD as qn,fJ as Gn,G as ai,r as Qn,j as qi,oX as Jn,q as Gi,i as er,D as tr,oS as ir,oY as nr,mb as rr,n as ar,oo as Qi}from"./index--BQDx9CP.js";import{z as Vt,h as ne,b as Ji,g as oi,m as en,U as zt,J as tn,e as bt,t as li,a as nn,Z as rn,k as an,T as or,d as lr,F as re,V as sr,E as dr,o as Tt,C as yi,l as ur,p as Si,f as cr,S as on,R as hr,I as vr,w as pr,Q as ln,K as gr}from"./index-R4J-DW51.js";import{V as ve,h as si,F as Se,p as mr,a as fr,j as bi,Q as Ri}from"./index-DT5UJx9J.js";import{s as Ir}from"./index-HOPa4z_M.js";import{r as b,v as Ye,j as p,ab as Y,b as di,T as Te,e as Rt,i as De,k as mt,V as ke,h as _r,L as xi,c as wr}from"./facade-DLk4o3Z_.js";import{C as sn,W as Cr}from"./index-DNSnhRIr.js";var yr=Object.defineProperty,Sr=(e,t,i)=>t in e?yr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,T=(e,t,i)=>Sr(e,typeof t!="symbol"?t+"":t,i),br=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Mi=(e,t)=>(i,r)=>t(i,r,e);let me=class extends Ce{constructor(e,t){super(),T(this,"_open$",new gi(!1)),T(this,"open$",this._open$.pipe(Sn())),T(this,"_activeRule"),T(this,"_activeRule$",new gi(void 0)),T(this,"activeRule$",this._activeRule$.asObservable()),T(this,"_closeDisposable",null),this._univerInstanceService=e,this._sidebarService=t,this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(X.UNIVER_SHEET).pipe(ei(i=>!i)).subscribe(()=>{this.close()})),this.disposeWithMe(this._sidebarService.sidebarOptions$.subscribe(i=>{i.id===It&&(i.visible||setTimeout(()=>{this._sidebarService.sidebarOptions$.next({visible:!1})}))}))}get activeRule(){return this._activeRule}get isOpen(){return this._open$.getValue()}dispose(){var e;super.dispose(),this._open$.next(!1),this._open$.complete(),this._activeRule$.complete(),(e=this._closeDisposable)==null||e.dispose()}open(){this._open$.next(!0)}close(){var e;this._open$.next(!1),(e=this._closeDisposable)==null||e.dispose()}setCloseDisposable(e){this._closeDisposable=bn(()=>{e.dispose(),this._closeDisposable=null})}setActiveRule(e){this._activeRule=e,this._activeRule$.next(e)}};me=br([Mi(0,se),Mi(1,Yi)],me);const Ee="#ECECEC",ui="sheets-data-validation-ui.config",ft={};var Rr=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Oe=(e,t)=>(i,r)=>t(i,r,e);let Xe=class extends Ce{constructor(e,t,i,r,n,a){super(),this._sheetInterceptorService=e,this._dataValidationModel=t,this._dataValidatorRegistryService=i,this._dialogService=r,this._localeService=n,this._sheetsDataValidationValidatorService=a,this._initEditorBridgeInterceptor()}_initEditorBridgeInterceptor(){this.disposeWithMe(this._sheetInterceptorService.writeCellInterceptor.intercept($n,{handler:async(e,t,i)=>{const r=await e,{row:n,col:a,unitId:o,subUnitId:l}=t,s=this._dataValidationModel.getRuleIdByLocation(o,l,n,a),d=s?this._dataValidationModel.getRuleById(o,l,s):void 0;if(r===!1)return i(Promise.resolve(!1));if(!d||d.errorStyle!==nt.STOP)return i(Promise.resolve(!0));const c=this._dataValidatorRegistryService.getValidatorItem(d.type);return!c||await this._sheetsDataValidationValidatorService.validatorCell(o,l,n,a)===We.VALID?i(Promise.resolve(!0)):(this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:c.getRuleFinalError(d,{row:n,col:a,unitId:o,subUnitId:l})},footer:{title:b.createElement(Ye,{variant:"primary",onClick:()=>this._dialogService.close("reject-input-dialog")},this._localeService.t("dataValidation.alert.ok"))},onClose:()=>{this._dialogService.close("reject-input-dialog")}}),i(Promise.resolve(!1)))}}))}showReject(e){this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:e},footer:{title:b.createElement(Ye,{variant:"primary",onClick:()=>this._dialogService.close("reject-input-dialog")},this._localeService.t("dataValidation.alert.ok"))},onClose:()=>{this._dialogService.close("reject-input-dialog")}})}};Xe=Rr([Oe(0,V(ai)),Oe(1,V(re)),Oe(2,V(Se)),Oe(3,Qn),Oe(4,V(de)),Oe(5,V(pr))],Xe);var xr=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},ce=(e,t)=>(i,r)=>t(i,r,e);const kt=e=>{if(e==null||typeof e=="boolean")return;if(e==="")return Et();if(typeof e=="number"||!Number.isNaN(+e))return Et(Ni.format("yyyy-MM-dd HH:mm:ss",Number(e)));const t=Et(e);if(t.isValid())return t};function Mr(e,t){const i=Ir(t);if(e===i)return t;switch(e){case"datetime":return"yyyy-MM-dd hh:mm:ss";case"date":return"yyyy-MM-dd";case"time":return"HH:mm:ss"}}let je=class extends Ce{constructor(e,t,i,r,n,a,o,l,s,d,c){super(),T(this,"_activeDropdown"),T(this,"_activeDropdown$",new Rn),T(this,"_currentPopup",null),T(this,"activeDropdown$",this._activeDropdown$.asObservable()),T(this,"_zenVisible",!1),this._univerInstanceService=e,this._dataValidatorRegistryService=t,this._zenZoneService=i,this._dataValidationModel=r,this._sheetsSelectionsService=n,this._cellDropdownManagerService=a,this._sheetDataValidationModel=o,this._commandService=l,this._editorBridgeService=s,this._injector=d,this._configService=c,this._init(),this._initSelectionChange(),this.disposeWithMe(()=>{this._activeDropdown$.complete()})}get activeDropdown(){return this._activeDropdown}_init(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{this._zenVisible=e,e&&this.hideDropdown()}))}_getDropdownByCell(e,t,i,r){const n=e?this._univerInstanceService.getUnit(e,X.UNIVER_SHEET):this._univerInstanceService.getCurrentUnitForType(X.UNIVER_SHEET);if(!n)return;const a=t?n.getSheetBySheetId(t):n.getActiveSheet();if(!a)return;const o=this._dataValidationModel.getRuleByLocation(n.getUnitId(),a.getSheetId(),i,r);if(!o)return;const l=this._dataValidatorRegistryService.getValidatorItem(o.type);return l==null?void 0:l.dropdownType}_initSelectionChange(){this.disposeWithMe(this._sheetsSelectionsService.selectionMoveEnd$.subscribe(e=>{e&&e.every(t=>!(t.primary&&this._getDropdownByCell(t.primary.unitId,t.primary.sheetId,t.primary.actualRow,t.primary.actualColumn)))&&this.hideDropdown()}))}showDropdown(e){var t,i,r,n;const{location:a}=e,{row:o,col:l,unitId:s,subUnitId:d,workbook:c,worksheet:v}=a;if(this._currentPopup&&this._currentPopup.dispose(),this._zenVisible)return;this._activeDropdown=e,this._activeDropdown$.next(this._activeDropdown);const u=this._sheetDataValidationModel.getRuleByLocation(s,d,o,l);if(!u)return;const g=this._dataValidatorRegistryService.getValidatorItem(u.type);if(!(g!=null&&g.dropdownType))return;let w;const I=async(m,C)=>{var M,R,y;if(!m)return!0;const k=m,D=v.getCell(o,l),S=k.format(C==="date"?"YYYY-MM-DD 00:00:00":"YYYY-MM-DD HH:mm:ss"),U=(M=Ni.parseDate(S))==null?void 0:M.v,E=C==="time"?U%1:U,L=c.getStyles().getStyleByCell(D),O=(y=(R=L==null?void 0:L.n)==null?void 0:R.pattern)!=null?y:"";return u.errorStyle!==nt.STOP||await g.validator({value:E,unitId:s,subUnitId:d,row:o,column:l,worksheet:v,workbook:c,interceptValue:S.replace("Z","").replace("T"," "),t:Tn.NUMBER},u)?(await this._commandService.executeCommand(it.id,{unitId:s,subUnitId:d,range:{startColumn:l,endColumn:l,startRow:o,endRow:o},value:{v:E,t:2,p:null,f:null,si:null,s:{n:{pattern:Mr(C,O)}}}}),await this._commandService.executeCommand(ot.id,{visible:!1,eventType:st.Keyboard,unitId:s,keycode:lt.ESC}),!0):(this._injector.has(Xe)&&this._injector.get(Xe).showReject(g.getRuleFinalError(u,{row:o,col:l,unitId:s,subUnitId:d})),!1)};let f;switch(g.dropdownType){case ve.DATE:{const m=ne(v.getCellRaw(o,l)),C=kt(m),M=!!((t=u.bizInfo)!=null&&t.showTime);f={location:a,type:"datepicker",props:{showTime:M,onChange:R=>I(R,M?"datetime":"date"),defaultValue:C,patternType:"date"}};break}case ve.TIME:{const m=ne(v.getCellRaw(o,l)),C=kt(m);f={location:a,type:"datepicker",props:{onChange:M=>I(M,"time"),defaultValue:C,patternType:"time"}};break}case ve.DATETIME:{const m=ne(v.getCellRaw(o,l)),C=kt(m);f={location:a,type:"datepicker",props:{onChange:M=>I(M,"datetime"),defaultValue:C,patternType:"datetime"}};break}case ve.LIST:case ve.MULTIPLE_LIST:{const m=g.dropdownType===ve.MULTIPLE_LIST,C=async S=>{const U=an(S),E={unitId:s,subUnitId:d,range:{startColumn:l,endColumn:l,startRow:o,endRow:o},value:{v:U,p:null,f:null,si:null}};return this._commandService.executeCommand(it.id,E),this._editorBridgeService.isVisible().visible&&await this._commandService.executeCommand(ot.id,{visible:!1,eventType:st.Keyboard,unitId:s,keycode:lt.ESC}),!m},M=(u==null?void 0:u.renderMode)===oe.CUSTOM||(u==null?void 0:u.renderMode)===void 0,R=g.getListWithColor(u,s,d),y=Vt(v.getCellRaw(o,l)),k=()=>{this._commandService.executeCommand(Ue.id,{ruleId:u.uid}),w==null||w.dispose()},D=R.map(S=>({label:S.label,value:S.label,color:M||S.color?S.color||Ee:"transparent"}));f={location:a,type:"list",props:{onChange:S=>C(S),options:D,onEdit:k,defaultValue:y,multiple:m,showEdit:(r=(i=this._configService.getConfig(ui))==null?void 0:i.showEditOnDropdown)!=null?r:!0}};break}case ve.CASCADE:{f={type:"cascader",props:{onChange:m=>{const C={unitId:s,subUnitId:d,range:{startColumn:l,endColumn:l,startRow:o,endRow:o},value:{v:m.join("/"),p:null,f:null,si:null}};return this._commandService.syncExecuteCommand(it.id,C),this._editorBridgeService.isVisible().visible&&this._commandService.syncExecuteCommand(ot.id,{visible:!1,eventType:st.Keyboard,unitId:s,keycode:lt.ESC}),!0},defaultValue:Vt(v.getCellRaw(o,l)).split("/"),options:JSON.parse((n=u.formula1)!=null?n:"[]")},location:a};break}case ve.COLOR:{f={type:"color",props:{onChange:m=>{const C={unitId:s,subUnitId:d,range:{startColumn:l,endColumn:l,startRow:o,endRow:o},value:{v:m,p:null,f:null,si:null}};return this._commandService.syncExecuteCommand(it.id,C),this._editorBridgeService.isVisible().visible&&this._commandService.syncExecuteCommand(ot.id,{visible:!1,eventType:st.Keyboard,unitId:s,keycode:lt.ESC}),!0},defaultValue:Vt(v.getCellRaw(o,l))},location:a};break}default:throw new Error("[DataValidationDropdownManagerService]: unknown type!")}if(w=this._cellDropdownManagerService.showDropdown({...f,onHide:()=>{this._activeDropdown=null,this._activeDropdown$.next(null)}}),!w)throw new Error("[DataValidationDropdownManagerService]: cannot show dropdown!");const h=new xn;h.add(w),h.add({dispose:()=>{var m,C;(C=(m=this._activeDropdown)==null?void 0:m.onHide)==null||C.call(m)}}),this._currentPopup=h}hideDropdown(){this._activeDropdown&&(this._currentPopup&&this._currentPopup.dispose(),this._currentPopup=null,this._activeDropdown=null,this._activeDropdown$.next(null))}showDataValidationDropdown(e,t,i,r,n){const a=this._univerInstanceService.getUnit(e,X.UNIVER_SHEET);if(!a)return;const o=a.getSheetBySheetId(t);if(!o)return;const l=this._dataValidationModel.getRuleByLocation(a.getUnitId(),o.getSheetId(),i,r);if(!l)return;const s=this._dataValidatorRegistryService.getValidatorItem(l.type);if(!s||!s.dropdownType){this.hideDropdown();return}this.showDropdown({location:{workbook:a,worksheet:o,row:i,col:r,unitId:e,subUnitId:t},onHide:n})}};je=xr([ce(0,se),ce(1,V(Se)),ce(2,qi),ce(3,V(re)),ce(4,V(Zi)),ce(5,V(Jn)),ce(6,V(re)),ce(7,te),ce(8,Gi),ce(9,V(ye)),ce(10,ii)],je);const It="DataValidationPanel",Ue={id:"data-validation.operation.open-validation-panel",type:Qe.OPERATION,handler(e,t){if(!t)return!1;const{ruleId:i,isAdd:r}=t,n=e.get(me),a=e.get(si),o=e.get(se),l=e.get(Yi),s=Fi(o);if(!s)return!1;const{unitId:d,subUnitId:c}=s,v=i?a.getRuleById(d,c,i):void 0;n.open(),n.setActiveRule(v&&{unitId:d,subUnitId:c,rule:v});const u=l.open({id:It,header:{title:r?"dataValidation.panel.addTitle":"dataValidation.panel.title"},children:{label:It},width:312,onClose:()=>n.close()});return n.setCloseDisposable(u),!0}},ci={id:"data-validation.operation.close-validation-panel",type:Qe.OPERATION,handler(e){return e.get(me).close(),!0}},dn={id:"data-validation.operation.toggle-validation-panel",type:Qe.OPERATION,handler(e){const t=e.get(te),i=e.get(me);return i.open(),i.isOpen?t.executeCommand(ci.id):t.executeCommand(Ue.id),!0}},xt={type:Qe.OPERATION,id:"sheet.operation.show-data-validation-dropdown",handler(e,t){if(!t)return!1;const i=e.get(je),{unitId:r,subUnitId:n,row:a,column:o}=t,l=i.activeDropdown,s=l==null?void 0:l.location;return s&&s.unitId===r&&s.subUnitId===n&&s.row===a&&s.col===o||i.showDataValidationDropdown(r,n,a,o),!0}},un={type:Qe.OPERATION,id:"sheet.operation.hide-data-validation-dropdown",handler(e,t){return t?(e.get(je).hideDropdown(),!0):!1}},Mt={type:Qe.COMMAND,id:"data-validation.command.addRuleAndOpen",handler(e){const t=e.get(se),i=Fi(t);if(!i)return!1;const{workbook:r,worksheet:n}=i,a=rn(e),o=e.get(te),l=r.getUnitId(),s=n.getSheetId(),d={rule:a,unitId:l,subUnitId:s};return o.syncExecuteCommand(oi.id,d)?(o.syncExecuteCommand(Ue.id,{ruleId:a.uid,isAdd:!0}),!0):!1}};var Er=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Pe=(e,t)=>(i,r)=>t(i,r,e);const be="SHEET_DATA_VALIDATION_ALERT";let at=class extends Ce{constructor(e,t,i,r,n,a){super(),this._hoverManagerService=e,this._cellAlertManagerService=t,this._univerInstanceService=i,this._localeService=r,this._zenZoneService=n,this._dataValidationModel=a,this._init()}_init(){this._initCellAlertPopup(),this._initZenService()}_initCellAlertPopup(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe(Ai(100)).subscribe(e=>{var t;if(e){const i=this._univerInstanceService.getUnit(e.location.unitId,X.UNIVER_SHEET),r=i.getSheetBySheetId(e.location.subUnitId);if(!r)return;const n=this._dataValidationModel.getRuleByLocation(e.location.unitId,e.location.subUnitId,e.location.row,e.location.col);if(!n){this._cellAlertManagerService.removeAlert(be);return}if(this._dataValidationModel.validator(n,{...e.location,workbook:i,worksheet:r})===We.INVALID){const a=this._cellAlertManagerService.currentAlert.get(be),o=(t=a==null?void 0:a.alert)==null?void 0:t.location;if(o&&o.row===e.location.row&&o.col===e.location.col&&o.subUnitId===e.location.subUnitId&&o.unitId===e.location.unitId){this._cellAlertManagerService.removeAlert(be);return}const l=this._dataValidationModel.getValidator(n.type);if(!l){this._cellAlertManagerService.removeAlert(be);return}this._cellAlertManagerService.showAlert({type:Pn.ERROR,title:this._localeService.t("dataValidation.error.title"),message:l==null?void 0:l.getRuleFinalError(n,e.location),location:e.location,width:200,height:74,key:be});return}}this._cellAlertManagerService.removeAlert(be)}))}_initZenService(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&this._cellAlertManagerService.removeAlert(be)}))}};at=Er([Pe(0,V(er)),Pe(1,V(tr)),Pe(2,se),Pe(3,V(de)),Pe(4,qi),Pe(5,V(re))],at);var Vr=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Dt=(e,t)=>(i,r)=>t(i,r,e);let Ze=class extends Ce{constructor(e,t,i){super(),this._autoFillService=e,this._sheetDataValidationModel=t,this._injector=i,this._initAutoFill()}_initAutoFill(){const e=()=>({redos:[],undos:[]}),t=(r,n)=>{const{source:a,target:o,unitId:l,subUnitId:s}=r,d=this._sheetDataValidationModel.getRuleObjectMatrix(l,s).clone(),c=Zt([a,o]),[v,u]=c.ranges,{mapFunc:g}=c,w={row:v.startRow,col:v.startColumn},I=Bn(v,u),f=new pt,h=new Set;I.forEach(y=>{const k=y.repeatStartCell,D=y.relativeRange,S={startRow:w.row,startColumn:w.col,endColumn:w.col,endRow:w.row},U={startRow:k.row,startColumn:k.col,endColumn:k.col,endRow:k.row};En.foreach(D,(E,L)=>{const O=gt.getPositionRange({startRow:E,startColumn:L,endColumn:L,endRow:E},S),{row:N,col:W}=g(O.startRow,O.startColumn),Z=this._sheetDataValidationModel.getRuleIdByLocation(l,s,N,W)||"",ue=gt.getPositionRange({startRow:E,startColumn:L,endColumn:L,endRow:E},U),{row:G,col:z}=g(ue.startRow,ue.startColumn);f.setValue(G,z,Z),h.add(Z)})});const m=Array.from(h).map(y=>({id:y,ranges:Wt(f,k=>k===y)}));d.addRangeRules(m);const C=d.diff(this._sheetDataValidationModel.getRules(l,s)),{redoMutations:M,undoMutations:R}=zt(l,s,C,this._injector,"patched",n===Je.ONLY_FORMAT);return{undos:R,redos:M}},i={id:Ji,onBeforeFillData:r=>{const{source:n,unitId:a,subUnitId:o}=r;for(const l of n.rows)for(const s of n.cols){const d=this._sheetDataValidationModel.getRuleByLocation(a,o,l,s);if(d&&d.type===F.CHECKBOX){this._autoFillService.setDisableApplyType(Je.SERIES,!0);return}}},onFillData:(r,n,a)=>a===Je.COPY||a===Je.ONLY_FORMAT||a===Je.SERIES?t(r,a):e(),onAfterFillData:()=>{}};this.disposeWithMe(this._autoFillService.addHook(i))}};Ze=Vr([Dt(0,ir),Dt(1,V(re)),Dt(2,V(ye))],Ze);var Tr=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},jt=(e,t)=>(i,r)=>t(i,r,e);let Ke=class extends Ce{constructor(e,t,i){super(),T(this,"_copyInfo"),this._sheetClipboardService=e,this._sheetDataValidationModel=t,this._injector=i,this._initCopyPaste()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:Ji,onBeforeCopy:(e,t,i)=>this._collect(e,t,i),onPasteCells:(e,t,i,r)=>{const{copyType:n=Ii.COPY,pasteType:a}=r,{range:o}=e||{},{range:l,unitId:s,subUnitId:d}=t;return this._generateMutations(l,{copyType:n,pasteType:a,copyRange:o,unitId:s,subUnitId:d})}})}_collect(e,t,i){const r=new pt;this._copyInfo={unitId:e,subUnitId:t,matrix:r};const n=this._injector.invoke(l=>Nn(i,l,e,t));if(!n)return;const{rows:a,cols:o}=n;a.forEach((l,s)=>{o.forEach((d,c)=>{const v=this._sheetDataValidationModel.getRuleIdByLocation(e,t,l,d);r.setValue(s,c,v??"")})})}_generateMutations(e,t){if(!this._copyInfo)return{redos:[],undos:[]};if(t.copyType===Ii.CUT)return this._copyInfo=null,{redos:[],undos:[]};if(!this._copyInfo||!this._copyInfo.matrix.getSizeOf()||!t.copyRange)return{redos:[],undos:[]};if([dt.SPECIAL_PASTE_COL_WIDTH,dt.SPECIAL_PASTE_VALUE,dt.SPECIAL_PASTE_FORMAT,dt.SPECIAL_PASTE_FORMULA].includes(t.pasteType))return{redos:[],undos:[]};const{unitId:i,subUnitId:r}=this._copyInfo;if(t.unitId!==i||r!==t.subUnitId){const n=this._sheetDataValidationModel.getRuleObjectMatrix(t.unitId,t.subUnitId).clone(),a=new pt,o=new Set,{ranges:[l,s],mapFunc:d}=Zt([t.copyRange,e]),c=_i(l,s,!0),v=new Map;c.forEach(({startRange:I})=>{var f;(f=this._copyInfo)==null||f.matrix.forValue((h,m,C)=>{const M=gt.getPositionRange({startRow:h,endRow:h,startColumn:m,endColumn:m},I),R=`${r}-${C}`,y=this._sheetDataValidationModel.getRuleById(i,r,C);!this._sheetDataValidationModel.getRuleById(t.unitId,t.subUnitId,R)&&y&&v.set(R,{...y,uid:R});const{row:k,col:D}=d(M.startRow,M.startColumn);o.add(R),a.setValue(k,D,R)})});const u=Array.from(o).map(I=>({id:I,ranges:Wt(a,f=>f===I)}));n.addRangeRules(u);const{redoMutations:g,undoMutations:w}=zt(t.unitId,t.subUnitId,n.diffWithAddition(this._sheetDataValidationModel.getRules(t.unitId,t.subUnitId),v.values()),this._injector,"patched",!1);return{redos:g,undos:w}}else{const n=this._sheetDataValidationModel.getRuleObjectMatrix(i,r).clone(),a=new pt,o=new Set,{ranges:[l,s],mapFunc:d}=Zt([t.copyRange,e]);_i(l,s,!0).forEach(({startRange:g})=>{var w;(w=this._copyInfo)==null||w.matrix.forValue((I,f,h)=>{const m=gt.getPositionRange({startRow:I,endRow:I,startColumn:f,endColumn:f},g),{row:C,col:M}=d(m.startRow,m.startColumn);a.setValue(C,M,h),o.add(h)})});const c=Array.from(o).map(g=>({id:g,ranges:Wt(a,w=>w===g)}));n.addRangeRules(c);const{redoMutations:v,undoMutations:u}=zt(i,r,n.diff(this._sheetDataValidationModel.getRules(i,r)),this._injector,"patched",!1);return{redos:v,undos:u}}}};Ke=Tr([jt(0,nr),jt(1,V(re)),jt(2,V(ye))],Ke);var kr=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Lt=(e,t)=>(i,r)=>t(i,r,e);let ze=class extends Ce{constructor(e,t,i){super(),this._localeService=e,this._commandService=t,this._sheetPermissionCheckController=i,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{e.id===oi.id&&(this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[Xt],rangeTypes:[Yt],worksheetTypes:[Ht,Ft]})||this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.setStyleErr"))),e.id===en.id&&(this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[Xt],rangeTypes:[Yt],worksheetTypes:[Ht,Ft]},e.params.ranges)||this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.setStyleErr")))}))}};ze=kr([Lt(0,V(de)),Lt(1,te),Lt(2,V(rr))],ze);const cn="sheet.menu.data-validation";function Dr(e){return{id:cn,type:ni.SUBITEMS,icon:"DataValidationIcon",tooltip:"dataValidation.title",hidden$:Fn(e,X.UNIVER_SHEET),disabled$:Hn(e,{workbookTypes:[Xt],worksheetTypes:[Ft,Ht],rangeTypes:[Yt]})}}function jr(e){return{id:Ue.id,title:"dataValidation.panel.title",type:ni.BUTTON}}function Lr(e){return{id:Mt.id,title:"dataValidation.panel.add",type:ni.BUTTON}}const Ur={[Wn.RULES]:{[cn]:{order:0,menuItemFactory:Dr,[Ue.id]:{order:0,menuItemFactory:jr},[Mt.id]:{order:1,menuItemFactory:Lr}}}};var hn=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},K=(e,t)=>(i,r)=>t(i,r,e);const vn={tr:{size:6,color:"#fe4b4b"}};let qe=class extends ti{constructor(e,t,i,r,n,a,o,l,s,d,c){super(),this._commandService=e,this._menuManagerService=t,this._renderManagerService=i,this._univerInstanceService=r,this._autoHeightController=n,this._dropdownManagerService=a,this._sheetDataValidationModel=o,this._dataValidatorRegistryService=l,this._sheetInterceptorService=s,this._dataValidationCacheService=d,this._editorBridgeService=c,this._initMenu(),this._initDropdown(),this._initViewModelIntercept(),this._initAutoHeight()}_initMenu(){this._menuManagerService.mergeMenu(Ur)}_initDropdown(){this._editorBridgeService&&this.disposeWithMe(this._editorBridgeService.visible$.subscribe(e=>{var t;if(!e.visible){((t=this._dropdownManagerService.activeDropdown)==null?void 0:t.trigger)==="editor-bridge"&&this._dropdownManagerService.hideDropdown();return}const i=this._editorBridgeService.getEditCellState();if(i){const{unitId:r,sheetId:n,row:a,column:o}=i,l=this._univerInstanceService.getUniverSheetInstance(r);if(!l)return;const s=this._sheetDataValidationModel.getRuleByLocation(r,n,a,o);if(!s)return;const d=this._dataValidatorRegistryService.getValidatorItem(s.type);if(!(d!=null&&d.dropdownType))return;const c=l.getActiveSheet();if(!c)return;const v=this._dropdownManagerService.activeDropdown,u=v==null?void 0:v.location;if(u&&u.unitId===r&&u.subUnitId===n&&u.row===a&&u.col===o)return;this._dropdownManagerService.showDropdown({location:{unitId:r,subUnitId:n,row:a,col:o,workbook:l,worksheet:c},trigger:"editor-bridge",closeOnOutSide:!1})}}))}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(Bi.CELL_CONTENT,{effect:Oi.Style,priority:Wi.DATA_VALIDATION,handler:(e,t,i)=>{var r,n,a,o,l;const{row:s,col:d,unitId:c,subUnitId:v,workbook:u,worksheet:g}=t,w=this._sheetDataValidationModel.getRuleIdByLocation(c,v,s,d);if(!w)return i(e);const I=this._sheetDataValidationModel.getRuleById(c,v,w);if(!I)return i(e);const f=(r=this._dataValidationCacheService.getValue(c,v,s,d))!=null?r:We.VALID,h=this._dataValidatorRegistryService.getValidatorItem(I.type),m=t.rawData;let C;const M={get value(){var y;return C!==void 0||(C=(y=ne(m))!=null?y:null),C}},R={get value(){var y;return`${(y=M.value)!=null?y:""}`}};return(!e||e===t.rawData)&&(e={...t.rawData}),e.markers={...e==null?void 0:e.markers,...f===We.INVALID?vn:null},e.customRender=[...(n=e==null?void 0:e.customRender)!=null?n:[],...h!=null&&h.canvasRender?[h.canvasRender]:[]],e.fontRenderExtension={...e==null?void 0:e.fontRenderExtension,isSkip:((a=e==null?void 0:e.fontRenderExtension)==null?void 0:a.isSkip)||((o=h==null?void 0:h.skipDefaultFontRender)==null?void 0:o.call(h,I,M.value,t))},e.interceptorStyle={...e==null?void 0:e.interceptorStyle,...h==null?void 0:h.getExtraStyle(I,R.value,{get style(){const y=u.getStyles();return(typeof(e==null?void 0:e.s)=="string"?y.get(e==null?void 0:e.s):e==null?void 0:e.s)||{}}},s,d)},e.interceptorAutoHeight=()=>{var y,k,D,S,U,E;const L=(k=(y=this._renderManagerService.getRenderById(c))==null?void 0:y.with(rt).getSkeletonParam(v))==null?void 0:k.skeleton;if(!L)return;const O=L.worksheet.getMergedCell(s,d),N={data:e,style:L.getStyles().getStyleByCell(e),primaryWithCoord:L.getCellWithCoordByIndex((D=O==null?void 0:O.startRow)!=null?D:s,(S=O==null?void 0:O.startColumn)!=null?S:d),unitId:c,subUnitId:v,row:s,col:d,workbook:u,worksheet:g};return(E=(U=h==null?void 0:h.canvasRender)==null?void 0:U.calcCellAutoHeight)==null?void 0:E.call(U,N)},e.interceptorAutoWidth=()=>{var y,k,D,S,U,E;const L=(k=(y=this._renderManagerService.getRenderById(c))==null?void 0:y.with(rt).getSkeletonParam(v))==null?void 0:k.skeleton;if(!L)return;const O=L.worksheet.getMergedCell(s,d),N={data:e,style:L.getStyles().getStyleByCell(e),primaryWithCoord:L.getCellWithCoordByIndex((D=O==null?void 0:O.startRow)!=null?D:s,(S=O==null?void 0:O.startColumn)!=null?S:d),unitId:c,subUnitId:v,row:s,col:d,workbook:u,worksheet:g};return(E=(U=h==null?void 0:h.canvasRender)==null?void 0:U.calcCellAutoWidth)==null?void 0:E.call(U,N)},e.coverable=((l=e==null?void 0:e.coverable)!=null?l:!0)&&!(I.type===F.LIST||I.type===F.LIST_MULTIPLE),i(e)}}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe(ei(e=>e.source==="command"),Hi(100)).subscribe(e=>{if(e.length===0)return;const t=[];if(e.forEach(i=>{var r;(i.rule.type===F.LIST_MULTIPLE||i.rule.type===F.LIST)&&(r=i.rule)!=null&&r.ranges&&t.push(...i.rule.ranges)}),t.length){const i=this._autoHeightController.getUndoRedoParamsOfAutoHeight(t);Pi(i.redos,this._commandService)}})}};qe=hn([K(0,te),K(1,ar),K(2,Le),K(3,se),K(4,V(Qi)),K(5,V(je)),K(6,V(re)),K(7,V(Se)),K(8,V(ai)),K(9,V(ln)),K(10,On(Gi))],qe);let Ei=class extends ti{constructor(e,t,i,r,n,a,o){super(),this._commandService=e,this._renderManagerService=t,this._autoHeightController=i,this._dataValidatorRegistryService=r,this._sheetInterceptorService=n,this._sheetDataValidationModel=a,this._dataValidationCacheService=o,this._initViewModelIntercept(),this._initAutoHeight()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(Bi.CELL_CONTENT,{effect:Oi.Style,priority:Wi.DATA_VALIDATION,handler:(e,t,i)=>{var r,n,a,o,l;const{row:s,col:d,unitId:c,subUnitId:v,workbook:u,worksheet:g}=t,w=this._sheetDataValidationModel.getRuleIdByLocation(c,v,s,d);if(!w)return i(e);const I=this._sheetDataValidationModel.getRuleById(c,v,w);if(!I)return i(e);const f=(r=this._dataValidationCacheService.getValue(c,v,s,d))!=null?r:We.VALID,h=this._dataValidatorRegistryService.getValidatorItem(I.type),m=g.getCellRaw(s,d),C=ne(m),M=`${C??""}`;return(!e||e===t.rawData)&&(e={...t.rawData}),e.markers={...e==null?void 0:e.markers,...f===We.INVALID?vn:null},e.customRender=[...(n=e==null?void 0:e.customRender)!=null?n:[],...h!=null&&h.canvasRender?[h.canvasRender]:[]],e.fontRenderExtension={...e==null?void 0:e.fontRenderExtension,isSkip:((a=e==null?void 0:e.fontRenderExtension)==null?void 0:a.isSkip)||((o=h==null?void 0:h.skipDefaultFontRender)==null?void 0:o.call(h,I,C,t))},e.interceptorStyle={...e==null?void 0:e.interceptorStyle,...h==null?void 0:h.getExtraStyle(I,M,{get style(){const R=u.getStyles();return(typeof(e==null?void 0:e.s)=="string"?R.get(e==null?void 0:e.s):e==null?void 0:e.s)||{}}},s,d)},e.interceptorAutoHeight=()=>{var R,y,k,D,S,U;const E=(y=(R=this._renderManagerService.getRenderById(c))==null?void 0:R.with(rt).getSkeletonParam(v))==null?void 0:y.skeleton;if(!E)return;const L=E.worksheet.getMergedCell(s,d),O={data:e,style:E.getStyles().getStyleByCell(e),primaryWithCoord:E.getCellWithCoordByIndex((k=L==null?void 0:L.startRow)!=null?k:s,(D=L==null?void 0:L.startColumn)!=null?D:d),unitId:c,subUnitId:v,row:s,col:d,workbook:u,worksheet:g};return(U=(S=h==null?void 0:h.canvasRender)==null?void 0:S.calcCellAutoHeight)==null?void 0:U.call(S,O)},e.interceptorAutoWidth=()=>{var R,y,k,D,S,U;const E=(y=(R=this._renderManagerService.getRenderById(c))==null?void 0:R.with(rt).getSkeletonParam(v))==null?void 0:y.skeleton;if(!E)return;const L=E.worksheet.getMergedCell(s,d),O={data:e,style:E.getStyles().getStyleByCell(e),primaryWithCoord:E.getCellWithCoordByIndex((k=L==null?void 0:L.startRow)!=null?k:s,(D=L==null?void 0:L.startColumn)!=null?D:d),unitId:c,subUnitId:v,row:s,col:d,workbook:u,worksheet:g};return(U=(S=h==null?void 0:h.canvasRender)==null?void 0:S.calcCellAutoWidth)==null?void 0:U.call(S,O)},e.coverable=((l=e==null?void 0:e.coverable)!=null?l:!0)&&!(I.type===F.LIST||I.type===F.LIST_MULTIPLE),i(e)}}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe(ei(e=>e.source==="command"),Hi(16)).subscribe(e=>{const t=[];if(e.forEach(i=>{var r;(i.rule.type===F.LIST_MULTIPLE||i.rule.type===F.LIST)&&(r=i.rule)!=null&&r.ranges&&t.push(...i.rule.ranges)}),t.length){const i=this._autoHeightController.getUndoRedoParamsOfAutoHeight(t);Pi(i.redos,this._commandService)}})}};Ei=hn([K(0,te),K(1,Le),K(2,V(Qi)),K(3,V(Se)),K(4,V(ai)),K(5,V(re)),K(6,V(ln))],Ei);var Ar=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Vi=(e,t)=>(i,r)=>t(i,r,e);let _t=class extends Ce{constructor(e,t,i){super(),this._context=e,this._sheetDataValidationModel=t,this._sheetSkeletonManagerService=i,this._initSkeletonChange()}_initSkeletonChange(){const e=t=>{var i;if(!t.length)return;const r=new Set;t.forEach(n=>{r.add(n.subUnitId)}),r.forEach(n=>{var a;(a=this._sheetSkeletonManagerService.getSkeletonParam(n))==null||a.skeleton.makeDirty(!0)}),(i=this._context.mainComponent)==null||i.makeForceDirty()};this.disposeWithMe(this._sheetDataValidationModel.validStatusChange$.pipe(Mn(16)).subscribe(e))}};_t=Ar([Vi(1,V(re)),Vi(2,V(rt))],_t);function Ae({ref:e,...t}){const{icon:i,id:r,className:n,extend:a,...o}=t,l=`univerjs-icon univerjs-icon-${r} ${n||""}`.trim(),s=b.useRef(`_${Nr()}`);return pn(i,`${r}`,{defIds:i.defIds,idSuffix:s.current},{ref:e,className:l,...o},a)}function pn(e,t,i,r,n){return b.createElement(e.tag,{key:t,...Or(e,i,n),...r},(Pr(e,i).children||[]).map((a,o)=>pn(a,`${t}-${e.tag}-${o}`,i,void 0,n)))}function Or(e,t,i){const r={...e.attrs};i!=null&&i.colorChannel1&&r.fill==="colorChannel1"&&(r.fill=i.colorChannel1),e.tag==="mask"&&r.id&&(r.id=r.id+t.idSuffix),Object.entries(r).forEach(([a,o])=>{a==="mask"&&typeof o=="string"&&(r[a]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))});const{defIds:n}=t;return!n||n.length===0||(e.tag==="use"&&r["xlink:href"]&&(r["xlink:href"]=r["xlink:href"]+t.idSuffix),Object.entries(r).forEach(([a,o])=>{typeof o=="string"&&(r[a]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))})),r}function Pr(e,t){var i;const{defIds:r}=t;return!r||r.length===0?e:e.tag==="defs"&&(i=e.children)!=null&&i.length?{...e,children:e.children.map(n=>typeof n.attrs.id=="string"&&r&&r.includes(n.attrs.id)?{...n,attrs:{...n.attrs,id:n.attrs.id+t.idSuffix}}:n)}:e}function Nr(){return Math.random().toString(36).substring(2,8)}Ae.displayName="UniverIcon";const $r={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.4917 3.07803C1.4917 2.19437 2.20804 1.47803 3.0917 1.47803H5.6917C6.57536 1.47803 7.2917 2.19437 7.2917 3.07803V5.67803C7.2917 6.56168 6.57535 7.27803 5.6917 7.27803H3.0917C2.20804 7.27803 1.4917 6.56168 1.4917 5.67803V3.07803ZM3.0917 2.67803C2.87078 2.67803 2.6917 2.85711 2.6917 3.07803V5.67803C2.6917 5.89894 2.87079 6.07803 3.0917 6.07803H5.6917C5.91261 6.07803 6.0917 5.89894 6.0917 5.67803V3.07803C6.0917 2.85711 5.91261 2.67803 5.6917 2.67803H3.0917Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.6175 2.45279C14.8518 2.68711 14.8518 3.06701 14.6175 3.30132L11.6151 6.30365C11.3957 6.52307 11.0451 6.53897 10.8067 6.34031L8.80915 4.67566C8.55458 4.46352 8.52019 4.08518 8.73233 3.83062C8.94447 3.57605 9.32281 3.54166 9.57737 3.7538L11.154 5.06767L13.769 2.45278C14.0033 2.21847 14.3832 2.21848 14.6175 2.45279Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.1175 9.19746C14.3518 9.43178 14.3518 9.81168 14.1175 10.046L12.5418 11.6217L14.1175 13.1975C14.3518 13.4318 14.3518 13.8117 14.1175 14.046C13.8832 14.2803 13.5033 14.2803 13.269 14.046L11.6933 12.4703L10.1175 14.046C9.88321 14.2803 9.50331 14.2803 9.269 14.046C9.03468 13.8117 9.03468 13.4318 9.269 13.1975L10.8447 11.6217L9.269 10.046C9.03468 9.81168 9.03468 9.43178 9.269 9.19746C9.50331 8.96315 9.88321 8.96315 10.1175 9.19746L11.6933 10.7732L13.269 9.19746C13.5033 8.96315 13.8832 8.96315 14.1175 9.19746Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.0917 8.72168C2.20804 8.72168 1.4917 9.43802 1.4917 10.3217V12.9217C1.4917 13.8053 2.20804 14.5217 3.0917 14.5217H5.6917C6.57535 14.5217 7.2917 13.8053 7.2917 12.9217V10.3217C7.2917 9.43802 6.57536 8.72168 5.6917 8.72168H3.0917ZM2.6917 10.3217C2.6917 10.1008 2.87078 9.92168 3.0917 9.92168H5.6917C5.91261 9.92168 6.0917 10.1008 6.0917 10.3217V12.9217C6.0917 13.1426 5.91261 13.3217 5.6917 13.3217H3.0917C2.87079 13.3217 2.6917 13.1426 2.6917 12.9217V10.3217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},gn=b.forwardRef(function(e,t){return b.createElement(Ae,Object.assign({},e,{id:"data-validation-icon",ref:t,icon:$r}))});gn.displayName="DataValidationIcon";const Br={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993 0.866699 5.9313 0.866699H10.069C10.4004 0.866699 10.669 1.13533 10.669 1.4667C10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443C14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928L9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171C10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778L9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539C9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263L6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539C5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778L6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},hi=b.forwardRef(function(e,t){return b.createElement(Ae,Object.assign({},e,{id:"delete-icon",ref:t,icon:Br}))});hi.displayName="DeleteIcon";const Wr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},mn=b.forwardRef(function(e,t){return b.createElement(Ae,Object.assign({},e,{id:"increase-icon",ref:t,icon:Wr}))});mn.displayName="IncreaseIcon";const Hr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},vi=b.forwardRef(function(e,t){return b.createElement(Ae,Object.assign({},e,{id:"more-down-icon",ref:t,icon:Hr}))});vi.displayName="MoreDownIcon";const Fr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.64645 9.85355C4.45118 9.65829 4.45118 9.34171 4.64645 9.14645L7.64645 6.14645C7.84171 5.95118 8.15829 5.95118 8.35355 6.14645L11.3536 9.14645C11.5488 9.34171 11.5488 9.65829 11.3536 9.85355C11.1583 10.0488 10.8417 10.0488 10.6464 9.85355L8 7.20711L5.35355 9.85355C5.15829 10.0488 4.84171 10.0488 4.64645 9.85355Z",fillRule:"evenodd",clipRule:"evenodd"}}]},fn=b.forwardRef(function(e,t){return b.createElement(Ae,Object.assign({},e,{id:"more-up-icon",ref:t,icon:Fr}))});fn.displayName="MoreUpIcon";const Yr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M6 5C6.55228 5 7 4.55228 7 4C7 3.44772 6.55228 3 6 3C5.44772 3 5 3.44772 5 4C5 4.55228 5.44772 5 6 5Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M6 9C6.55228 9 7 8.55229 7 8C7 7.44772 6.55228 7 6 7C5.44772 7 5 7.44772 5 8C5 8.55229 5.44772 9 6 9Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M7 12C7 12.5523 6.55228 13 6 13C5.44772 13 5 12.5523 5 12C5 11.4477 5.44772 11 6 11C6.55228 11 7 11.4477 7 12Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M10 5C10.5523 5 11 4.55228 11 4C11 3.44772 10.5523 3 10 3C9.44771 3 9 3.44772 9 4C9 4.55228 9.44771 5 10 5Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M11 8C11 8.55229 10.5523 9 10 9C9.44771 9 9 8.55229 9 8C9 7.44772 9.44771 7 10 7C10.5523 7 11 7.44772 11 8Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M10 13C10.5523 13 11 12.5523 11 12C11 11.4477 10.5523 11 10 11C9.44771 11 9 11.4477 9 12C9 12.5523 9.44771 13 10 13Z"}}]},In=b.forwardRef(function(e,t){return b.createElement(Ae,Object.assign({},e,{id:"sequence-icon",ref:t,icon:Yr}))});In.displayName="SequenceIcon";function Xr(e){var t;const i=P(de),r=P(ri),{value:n,onChange:a,extraComponent:o}=e,[l,s]=b.useState(!1),d=o?r.get(o):null;return p.jsxs(p.Fragment,{children:[p.jsxs("div",{className:"univer-mb-3 univer-flex univer-cursor-pointer univer-items-center univer-text-sm univer-text-gray-900 dark:!univer-text-white",onClick:()=>s(!l),children:[i.t("dataValidation.panel.options"),l?p.jsx(fn,{className:"univer-ml-1"}):p.jsx(vi,{className:"univer-ml-1"})]}),l&&p.jsxs(p.Fragment,{children:[d?p.jsx(d,{value:n,onChange:a}):null,p.jsx(Y,{label:i.t("dataValidation.panel.invalid"),children:p.jsxs(di,{value:`${(t=n.errorStyle)!=null?t:nt.WARNING}`,onChange:c=>a({...n,errorStyle:+c}),children:[p.jsx(Te,{value:`${nt.WARNING}`,children:i.t("dataValidation.panel.showWarning")}),p.jsx(Te,{value:`${nt.STOP}`,children:i.t("dataValidation.panel.rejectInput")})]})}),p.jsx(Y,{label:i.t("dataValidation.panel.messageInfo"),children:p.jsx(Rt,{checked:n.showErrorMessage,onChange:()=>a({...n,showErrorMessage:!n.showErrorMessage}),children:i.t("dataValidation.panel.showInfo")})}),n.showErrorMessage?p.jsx(Y,{children:p.jsx(ke,{value:n.error,onChange:c=>a({...n,error:c})})}):null]})]})}const Zr=e=>kn(async(t,i,r,n)=>{const a=await e.executeCommand(t,i,r);n==null||n(a)},1e3);function Kr(e,t,i){var r,n,a,o;return t?((n=(r=e.getUnit(t))==null?void 0:r.getSheetBySheetName(i))==null?void 0:n.getSheetId())||"":((o=(a=e.getCurrentUnitForType(X.UNIVER_SHEET))==null?void 0:a.getSheetBySheetName(i))==null?void 0:o.getSheetId())||""}function zr(){var e,t;const[i,r]=b.useState(0),n=P(me),a=Ve(n.activeRule$,n.activeRule),{unitId:o,subUnitId:l,rule:s}=a||{},d=s.uid,c=P(Se),v=P(se),u=P(ri),g=P(te),w=P(si),I=P(de),[f,h]=b.useState(s),m=c.getValidatorItem(f.type),[C,M]=b.useState(!1),R=c.getValidatorsByScope(mr.SHEET),[y,k]=b.useState(()=>f.ranges.map(_=>({unitId:"",sheetId:"",range:_}))),D=b.useMemo(()=>Zr(g),[g]),[S,U]=b.useState(!1),[E,L]=b.useState(!1),O=b.useRef(null),N=P(Zi);if(b.useEffect(()=>()=>{const _=N.getCurrentLastSelection();_&&N.setSelections([_])},[N]),b.useEffect(()=>{g.onCommandExecuted(_=>{(_.id===Dn.id||_.id===jn.id)&&setTimeout(()=>{const j=w.getRuleById(o,l,d);r($=>$+1),j&&(h(j),k(j.ranges.map($=>({unitId:"",sheetId:"",range:$}))))},20)})},[g,w,d,l,o]),!m)return null;const W=m.operators,Z=m.operatorNames,ue=f.operator?fr.includes(f.operator):!1,G=()=>{var _,j,$;(j=(_=O.current)==null?void 0:_.editor)!=null&&j.isFocus()&&z(($=O.current)==null?void 0:$.getValue()),!(!f.ranges.length||S)&&(m.validatorFormula(f,o,l).success?n.setActiveRule(null):M(!0))},z=Kt(_=>{const j=_.split(",").filter(Boolean).map(Yn).map(J=>{const pi=J.sheetName;if(pi){const yn=Kr(v,J.unitId,pi);return{...J,sheetId:yn}}return{...J,sheetId:""}});if(Ln(j,y))return;k(j);const $=j.filter(J=>(!J.unitId||J.unitId===o)&&(!J.sheetId||J.sheetId===l)).map(J=>J.range);if(h({...f,ranges:$}),$.length===0)return;const Ie={unitId:o,subUnitId:l,ruleId:d,ranges:$};D(en.id,Ie)}),B=_=>{if(fi(_,Ri(f)))return;h({...f,..._});const j={unitId:o,subUnitId:l,ruleId:d,setting:_};D(Si.id,j,void 0)},ie=async()=>{await g.executeCommand(on.id,{ruleId:d,unitId:o,subUnitId:l}),n.setActiveRule(null)},ae={type:f.type,operator:f.operator,formula1:f.formula1,formula2:f.formula2,allowBlank:f.allowBlank},q=_=>{const j=c.getValidatorItem(_);if(!j)return;const $=j.operators,Ie=w.getRuleById(o,l,d),J=_===(Ie==null?void 0:Ie.type)||_.includes("list")&&Ie!=null&&Ie.type.includes("list")?{...Ie,type:_}:{...f,type:_,operator:$[0],formula1:void 0,formula2:void 0};h(J),g.executeCommand(Si.id,{unitId:o,subUnitId:l,ruleId:f.uid,setting:Ri(J)})},H=u.get(m.formulaInput),pe=b.useMemo(()=>y.map(_=>Ki(_.range)).join(","),[]),Q=bi(f),x=_=>{fi(_,bi(f))||(h({...f,..._}),D(cr.id,{unitId:o,subUnitId:l,ruleId:d,options:_}))},A=W.length&&!f.operator;return p.jsxs("div",{"data-u-comp":"data-validation-detail",className:"univer-py-2",children:[p.jsx(Y,{label:I.t("dataValidation.panel.range"),error:!f.ranges.length||S?I.t("dataValidation.panel.rangeError"):"",children:p.jsx(Cr,{selectorRef:O,unitId:o,subUnitId:l,initialValue:pe,onChange:(_,j)=>{var $;!E&&($=O.current)!=null&&$.verify()&&z(j)},onFocusChange:(_,j)=>{var $;L(_),!_&&j&&($=O.current)!=null&&$.verify()&&z(j)},onVerify:_=>U(!_)})}),p.jsx(Y,{label:I.t("dataValidation.panel.type"),children:p.jsx(xi,{className:"univer-w-full",value:f.type,options:(e=R==null?void 0:R.sort((_,j)=>_.order-j.order))==null?void 0:e.map(_=>({label:I.t(_.title),value:_.id})),onChange:q})}),W!=null&&W.length?p.jsx(Y,{label:I.t("dataValidation.panel.operator"),children:p.jsx(xi,{className:"univer-w-full",value:`${f.operator}`,options:[{value:"",label:I.t("dataValidation.operators.legal")},...W.map((_,j)=>({value:`${_}`,label:Z[j]}))],onChange:_=>{B({...ae,operator:_})}})}):null,H&&!A?p.jsx(H,{isTwoFormula:ue,value:{formula1:f.formula1,formula2:f.formula2},onChange:_=>{B({...ae,..._})},showError:C,validResult:m.validatorFormula(f,o,l),unitId:o,subUnitId:l,ruleId:d},i+f.type):null,p.jsx(Y,{children:p.jsx(Rt,{checked:(t=f.allowBlank)!=null?t:!0,onChange:()=>{var _;return B({...ae,allowBlank:!((_=f.allowBlank)==null||_)})},children:I.t("dataValidation.panel.allowBlank")})}),p.jsx(Xr,{value:Q,onChange:x,extraComponent:m.optionsInput}),p.jsxs("div",{className:"univer-mt-5 univer-flex univer-flex-row univer-justify-end",children:[p.jsx(Ye,{className:"univer-ml-3",onClick:ie,children:I.t("dataValidation.panel.removeRule")}),p.jsx(Ye,{className:"univer-ml-3",variant:"primary",onClick:G,children:I.t("dataValidation.panel.done")})]})]})}const qr=e=>{const{rule:t,onClick:i,unitId:r,subUnitId:n,disable:a}=e,o=P(Se),l=P(te),s=P(zn),d=o.getValidatorItem(t.type),c=b.useRef(void 0),[v,u]=b.useState(!1),g=P($i),w=Ve(g.currentTheme$),I=b.useMemo(()=>{var h;const m=g.getColorFromTheme("primary.600"),C=g.getColorFromTheme("loop-color.2"),M=(h=g.getColorFromTheme(C))!=null?h:m,R=new Un(M).toRgb();return{fill:`rgba(${R.r}, ${R.g}, ${R.b}, 0.1)`,stroke:M}},[w]),f=h=>{l.executeCommand(on.id,{ruleId:t.uid,unitId:r,subUnitId:n}),h.stopPropagation()};return b.useEffect(()=>()=>{var h;c.current&&((h=c.current)==null||h.forEach(m=>{m&&s.removeShape(m)}))},[s]),p.jsxs("div",{className:De(`
                  univer-bg-secondary univer-relative univer--ml-2 univer--mr-2 univer-box-border univer-flex
                  univer-w-[287px] univer-cursor-pointer univer-flex-col univer-justify-between univer-overflow-hidden
                  univer-rounded-md univer-p-2 univer-pr-9
                `,{"hover:univer-bg-gray-50 dark:hover:!univer-bg-gray-700":!a,"univer-opacity-50":a}),onClick:i,onMouseEnter:()=>{a||(u(!0),c.current=t.ranges.map(h=>s.addShape({range:h,style:I,primary:null})))},onMouseLeave:()=>{var h;u(!1),(h=c.current)==null||h.forEach(m=>{m&&s.removeShape(m)}),c.current=void 0},children:[p.jsx("div",{className:"univer-truncate univer-text-sm univer-font-medium univer-leading-[22px] univer-text-gray-900 dark:!univer-text-white",children:d==null?void 0:d.generateRuleName(t)}),p.jsx("div",{className:"univer-text-secondary univer-truncate univer-text-xs univer-leading-[18px] dark:!univer-text-gray-300",children:t.ranges.map(h=>Ki(h)).join(",")}),v?p.jsx("div",{className:"univer-absolute univer-right-2 univer-top-[19px] univer-flex univer-h-5 univer-w-5 univer-items-center univer-justify-center univer-rounded hover:univer-bg-gray-200 dark:!univer-text-gray-300 dark:hover:!univer-bg-gray-700",onClick:f,children:p.jsx(hi,{})}):null]})};function Gr(e){const t=P(re),i=P(se),r=P(te),n=P(ye),a=P(me),o=P(de),[l,s]=b.useState([]),{workbook:d}=e,c=Ve(d.activeSheet$,void 0,!0),v=d.getUnitId(),u=c==null?void 0:c.getSheetId();b.useEffect(()=>{s(t.getRules(v,u));const h=t.ruleChange$.subscribe(m=>{m.unitId===v&&m.subUnitId===u&&s(t.getRules(v,u))});return()=>{h.unsubscribe()}},[v,u,t]);const g=async()=>{const h=rn(n),m={unitId:v,subUnitId:u,rule:h};await r.executeCommand(oi.id,m),a.setActiveRule({unitId:v,subUnitId:u,rule:h})},w=()=>{r.executeCommand(hr.id,{unitId:v,subUnitId:u})},I=(h=>{const m=i.getCurrentUnitForType(X.UNIVER_SHEET),C=m.getActiveSheet(),M=m.getUnitId(),R=C.getSheetId();return h.map(y=>Xn(n,M,R,y.ranges)?{...y}:{...y,disable:!0})})(l),f=I==null?void 0:I.some(h=>h.disable);return p.jsxs("div",{className:"univer-pb-4",children:[I==null?void 0:I.map(h=>{var m;return p.jsx(qr,{unitId:v,subUnitId:u,onClick:()=>{h.disable||a.setActiveRule({unitId:v,subUnitId:u,rule:h})},rule:h,disable:(m=h.disable)!=null?m:!1},h.uid)}),p.jsxs("div",{className:"univer-mt-4 univer-flex univer-flex-row univer-justify-end univer-gap-2",children:[l.length&&!f?p.jsx(Ye,{onClick:w,children:o.t("dataValidation.panel.removeAll")}):null,p.jsx(Ye,{variant:"primary",onClick:g,children:o.t("dataValidation.panel.add")})]})]})}const Qr=()=>{const e=P(me),t=Ve(e.activeRule$,e.activeRule),i=P(se),r=Ve(()=>i.getCurrentTypeOfUnit$(X.UNIVER_SHEET),void 0,void 0,[]),n=Ve(()=>{var a;return(a=r==null?void 0:r.activeSheet$)!=null?a:Vn(null)},void 0,void 0,[]);return!r||!n?null:t&&t.subUnitId===n.getSheetId()?p.jsx(zr,{},t.rule.uid):p.jsx(Gr,{workbook:r})},Jr=e=>{const{isTwoFormula:t=!1,value:i,onChange:r,showError:n,validResult:a}=e,o=P(de),l=n?a==null?void 0:a.formula1:"",s=n?a==null?void 0:a.formula2:"";return t?p.jsxs(p.Fragment,{children:[p.jsx(Y,{error:l,children:p.jsx(ke,{className:"univer-w-full",placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:i==null?void 0:i.formula1,onChange:d=>{r==null||r({...i,formula1:d})}})}),p.jsx("div",{className:"-univer-mt-2 univer-mb-1 univer-text-sm univer-text-gray-400",children:o.t("dataValidation.panel.formulaAnd")}),p.jsx(Y,{error:s,children:p.jsx(ke,{className:"univer-w-full",placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:i==null?void 0:i.formula2,onChange:d=>{r==null||r({...i,formula2:d})}})})]}):p.jsx(Y,{error:l,children:p.jsx(ke,{className:"univer-w-full",placeholder:o.t("dataValidation.panel.formulaPlaceholder"),value:i==null?void 0:i.formula1,onChange:d=>{r==null||r({formula1:d})}})})};function ea(e){const{value:t,onChange:i,showError:r,validResult:n}=e,a=P(de),o=r?n==null?void 0:n.formula1:"",l=r?n==null?void 0:n.formula2:"",[s,d]=b.useState(!((t==null?void 0:t.formula1)===void 0&&(t==null?void 0:t.formula2)===void 0));return p.jsxs(p.Fragment,{children:[p.jsx(Y,{children:p.jsx(Rt,{checked:s,onChange:c=>{c?d(!0):(d(!1),i==null||i({...t,formula1:void 0,formula2:void 0}))},children:a.t("dataValidation.checkbox.tips")})}),s?p.jsx(Y,{label:a.t("dataValidation.checkbox.checked"),error:o,children:p.jsx(ke,{className:"univer-w-full",placeholder:a.t("dataValidation.panel.valuePlaceholder"),value:t==null?void 0:t.formula1,onChange:c=>{i==null||i({...t,formula1:c||void 0})}})}):null,s?p.jsx(Y,{label:a.t("dataValidation.checkbox.unchecked"),error:l,children:p.jsx(ke,{className:"univer-w-full",placeholder:a.t("dataValidation.panel.valuePlaceholder"),value:t==null?void 0:t.formula2,onChange:c=>{i==null||i({...t,formula2:c||void 0})}})}):null]})}function ta(e){var t;const{unitId:i,subUnitId:r,value:n,onChange:a,showError:o,validResult:l}=e,s=o?l==null?void 0:l.formula1:void 0,d=b.useRef(null),[c,v]=b.useState(!1);return Xi(u=>{var g;(g=d.current)!=null&&g.isClickOutSide(u)&&v(!1)}),p.jsx(Y,{error:s,children:p.jsx(sn,{ref:d,className:De("univer-box-border univer-h-8 univer-w-full univer-cursor-pointer univer-items-center univer-rounded-lg univer-bg-white univer-pt-2 univer-transition-colors hover:univer-border-primary-600 dark:!univer-bg-gray-700 dark:!univer-text-white [&>div:first-child]:univer-px-2.5 [&>div]:univer-h-5 [&>div]:univer-ring-transparent",mt),initValue:(t=n==null?void 0:n.formula1)!=null?t:"=",unitId:i,subUnitId:r,isFocus:c,isSupportAcrossSheet:!0,onChange:u=>{const g=(u??"").trim();g!==(n==null?void 0:n.formula1)&&(a==null||a({...n,formula1:g}))},onFocus:()=>v(!0)})})}const ia=["#FFFFFF","#FEE7E7","#FEF0E6","#EFFBD0","#E4F4FE","#E8ECFD","#F1EAFA","#FDE8F3","#E5E5E5","#FDCECE","#FDC49B","#DEF6A2","#9FDAFF","#D0D9FB","#E3D5F6","#FBD0E8","#656565","#FE4B4B","#FF8C51","#8BBB11","#0B9EFB","#3A60F7","#9E6DE3","#F248A6"],na=e=>{const{value:t,onChange:i,disabled:r}=e,[n,a]=b.useState(!1);return p.jsx(wr,{align:"start",disabled:r,open:n,onOpenChange:a,overlay:p.jsx("div",{className:"univer-box-border univer-grid univer-w-fit univer-grid-cols-6 univer-flex-wrap univer-gap-2 univer-p-1.5",children:ia.map(o=>p.jsx("div",{className:De("univer-box-border univer-size-4 univer-cursor-pointer univer-rounded",mt),style:{background:o},onClick:()=>{i(o),a(!1)}},o))}),children:p.jsxs("div",{className:De("univer-box-border univer-inline-flex univer-h-8 univer-w-16 univer-cursor-pointer univer-items-center univer-justify-between univer-gap-2 univer-rounded-lg univer-bg-white univer-px-2.5 univer-transition-colors univer-duration-200 hover:univer-border-primary-600 dark:!univer-bg-gray-700 dark:!univer-text-white",mt),children:[p.jsx("div",{className:"univer-box-border univer-h-4 univer-w-4 univer-rounded univer-text-base",style:{background:t}}),p.jsx(vi,{})]})})},Ti=e=>{const{item:t,commonProps:i,className:r}=e,{onItemChange:n,onItemDelete:a}=i;return p.jsxs("div",{className:De("univer-flex univer-items-center univer-gap-2",r),children:[!t.isRef&&p.jsx("div",{className:De("univer-cursor-move","draggableHandle"),children:p.jsx(In,{})}),p.jsx(na,{value:t.color,onChange:o=>{n(t.id,t.label,o)}}),p.jsx(ke,{disabled:t.isRef,value:t.label,onChange:o=>{n(t.id,o,t.color)}}),t.isRef?null:p.jsx("div",{className:"univer-ml-1 univer-cursor-pointer univer-rounded univer-text-base hover:univer-bg-gray-200",children:p.jsx(hi,{onClick:()=>a(t.id)})})]})};function ra(e){const{value:t,onChange:i=()=>{},unitId:r,subUnitId:n,validResult:a,showError:o,ruleId:l}=e,{formula1:s="",formula2:d=""}=t||{},[c,v]=b.useState(()=>xe(s)?"1":"0"),[u,g]=b.useState(c==="1"?s:"="),[w,I]=b.useState(c==="1"?s:"="),f=P(de),h=P(Se),m=P(si),C=P(or),[M,R]=b.useState(()=>d.split(",")),y=h.getValidatorItem(F.LIST),[k,D]=b.useState([]),[S,U]=b.useState(""),E=o?a==null?void 0:a.formula1:"",L=b.useMemo(()=>m.ruleChange$.pipe(Ai(16)),[]),O=Ve(L),N=Kt(i);b.useEffect(()=>{(async()=>{await new Promise(_=>{setTimeout(()=>_(!0),100)});const x=m.getRuleById(r,n,l),A=x==null?void 0:x.formula1;if(xe(A)&&y&&x){const _=await y.getListAsync(x,r,n);D(_)}})()},[m,O,y,l,n,r]),b.useEffect(()=>{xe(s)&&s!==w&&(g(s),I(w))},[w,s]);const[W,Z]=b.useState(()=>{const x=c!=="1"?lr(s):[],A=d.split(",");return x.map((_,j)=>({label:_,color:A[j]||Ee,isRef:!1,id:mi(4)}))}),ue=(x,A,_)=>{const j=W.find($=>$.id===x);j&&(j.label=A,j.color=_,Z([...W]))},G=x=>{const A=W.findIndex(_=>_.id===x);A!==-1&&(W.splice(A,1),Z([...W]))},z=d.split(","),B=b.useMemo(()=>k.map((x,A)=>({label:x,color:z[A]||Ee,id:`${A}`,isRef:!0})),[z,k]),ie=(x,A,_)=>{const j=[...M];j[+x]=_,R(j),N({formula1:s,formula2:j.join(",")})},ae=()=>{Z([...W,{label:"",color:Ee,isRef:!1,id:mi(4)}])};b.useEffect(()=>{if(c==="1")return;const x=new Set,A=[];W.map(_=>({labelList:_.label.split(","),item:_})).forEach(({item:_,labelList:j})=>{j.forEach($=>{x.has($)||(x.add($),A.push({label:$,color:_.color}))})}),N({formula1:an(A.map(_=>_.label)),formula2:A.map(_=>_.color===Ee?"":_.color).join(",")})},[W,N,c,w,M]);const q=Kt(async x=>{if(!xe(x)){N==null||N({formula1:"",formula2:d});return}C.getFormulaRefCheck(x)?(N==null||N({formula1:xe(x)?x:"",formula2:d}),U("")):(N==null||N({formula1:"",formula2:d}),g("="),U(f.t("dataValidation.validFail.formulaError")))}),H=b.useRef(null),[pe,Q]=b.useState(!1);return Xi(x=>{var A;(A=H.current)!=null&&A.isClickOutSide(x)&&Q(!1)}),p.jsxs(p.Fragment,{children:[p.jsx(Y,{label:f.t("dataValidation.list.options"),children:p.jsxs(di,{value:c,onChange:x=>{v(x),g(w),x==="1"&&N({formula1:w==="="?"":w,formula2:M.join(",")})},children:[p.jsx(Te,{value:"0",children:f.t("dataValidation.list.customOptions")}),p.jsx(Te,{value:"1",children:f.t("dataValidation.list.refOptions")})]})}),c==="1"?p.jsxs(Y,{error:E||S||void 0,children:[p.jsx(sn,{ref:H,className:De("univer-box-border univer-h-8 univer-w-full univer-cursor-pointer univer-items-center univer-rounded-lg univer-bg-white univer-pt-2 univer-transition-colors hover:univer-border-primary-600 dark:!univer-bg-gray-700 dark:!univer-text-white [&>div:first-child]:univer-px-2.5 [&>div]:univer-h-5 [&>div]:univer-ring-transparent",mt),initValue:u,unitId:r,subUnitId:n,isFocus:pe,isSupportAcrossSheet:!0,onFocus:()=>Q(!0),onChange:(x="")=>{const A=(x??"").trim();I(A),q(A)}}),B.length>0&&p.jsx("div",{className:"univer-mt-3",children:B.map(x=>p.jsx(Ti,{className:"univer-mb-3",item:x,commonProps:{onItemChange:ie}},x.id))})]}):p.jsx(Y,{error:E,children:p.jsxs("div",{className:"-univer-mt-3",children:[p.jsx(_r,{list:W,onListChange:Z,rowHeight:28,margin:[0,12],draggableHandle:".draggableHandle",itemRender:x=>p.jsx(Ti,{item:x,commonProps:{onItemChange:ue,onItemDelete:G}},x.id),idKey:"id"}),p.jsxs("a",{className:"univer-text-primary univer-flex univer-w-fit univer-cursor-pointer univer-flex-row univer-items-center univer-rounded univer-p-1 univer-px-2 univer-text-sm hover:univer-bg-primary-50 dark:hover:!univer-bg-gray-800",onClick:ae,children:[p.jsx(mn,{className:"univer-mr-1"}),f.t("dataValidation.list.add")]})]})})]})}const aa=[[tn,ta],[bt,Jr],[li,ra],[nn,ea]],oa="LIST_RENDER_MODE_OPTION_INPUT";function wt(e){var t;const{value:i,onChange:r}=e,n=P(de);return p.jsx(Y,{label:n.t("dataValidation.renderMode.label"),children:p.jsxs(di,{value:`${(t=i.renderMode)!=null?t:oe.CUSTOM}`,onChange:a=>r({...i,renderMode:+a}),children:[p.jsx(Te,{value:`${oe.CUSTOM}`,children:n.t("dataValidation.renderMode.chip")}),p.jsx(Te,{value:`${oe.ARROW}`,children:n.t("dataValidation.renderMode.arrow")}),p.jsx(Te,{value:`${oe.TEXT}`,children:n.t("dataValidation.renderMode.text")})]})})}wt.componentKey=oa;const la="DATE_SHOW_TIME_OPTION";function Ct(e){var t;const{value:i,onChange:r}=e,n=P(de);return p.jsx(Y,{children:p.jsx(Rt,{checked:(t=i.bizInfo)==null?void 0:t.showTime,onChange:a=>{r({...i,bizInfo:{...i.bizInfo,showTime:a}})},children:n.t("dataValidation.showTime.label")})})}Ct.componentKey=la;var sa=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Ne=(e,t)=>(i,r)=>t(i,r,e);const ut=6;let qt=class{constructor(e,t,i,r,n,a){this._commandService=e,this._univerInstanceService=t,this._formulaService=i,this._themeService=r,this._renderManagerService=n,this._dataValidationModel=a}_calc(e,t){var i,r,n;const{vt:a,ht:o}=t||{},l=e.endX-e.startX-ut*2,s=e.endY-e.startY,d=((i=t==null?void 0:t.fs)!=null?i:10)*1.6;let c=0,v=0;switch(a){case le.TOP:v=0;break;case le.BOTTOM:v=0+(s-d);break;default:v=0+(s-d)/2;break}switch(o){case we.LEFT:c=ut;break;case we.RIGHT:c=ut+(l-d);break;default:c=ut+(l-d)/2;break}return{left:e.startX+c,top:e.startY+v,width:((r=t==null?void 0:t.fs)!=null?r:10)*1.6,height:((n=t==null?void 0:t.fs)!=null?n:10)*1.6}}calcCellAutoHeight(e){var t;const{style:i}=e;return((t=i==null?void 0:i.fs)!=null?t:10)*1.6}calcCellAutoWidth(e){var t;const{style:i}=e;return((t=i==null?void 0:i.fs)!=null?t:10)*1.6}async _parseFormula(e,t,i){var r,n,a,o,l,s,d,c,v;const{formula1:u=dr,formula2:g=sr}=e,w=await this._formulaService.getRuleFormulaResult(t,i,e.uid),I=Tt((a=(n=(r=w==null?void 0:w[0])==null?void 0:r.result)==null?void 0:n[0])==null?void 0:a[0]),f=Tt((s=(l=(o=w==null?void 0:w[1])==null?void 0:o.result)==null?void 0:l[0])==null?void 0:s[0]),h=yi(String(I))&&yi(String(f));return{formula1:xe(u)?Tt((v=(c=(d=w==null?void 0:w[0])==null?void 0:d.result)==null?void 0:c[0])==null?void 0:v[0]):u,formula2:xe(g)?f:g,isFormulaValid:h}}drawWith(e,t){var i,r,n,a;const{style:o,primaryWithCoord:l,unitId:s,subUnitId:d,worksheet:c,row:v,col:u}=t,g=l.isMergedMainCell?l.mergeInfo:l,w=ne(c.getCellRaw(v,u)),I=this._dataValidationModel.getRuleByLocation(s,d,v,u);if(!I)return;const f=this._dataValidationModel.getValidator(I.type);if(!f||!((i=f.skipDefaultFontRender)!=null&&i.call(f,I,w,{unitId:s,subUnitId:d,row:v,column:u})))return;const h=f.parseFormulaSync(I,s,d),{formula1:m}=h,C=this._calc(g,o),{a:M,d:R}=e.getTransform(),y=wi(C.left,M),k=wi(C.top,R),D=Zn.create().composeMatrix({left:y,top:k,scaleX:1,scaleY:1,angle:0,skewX:0,skewY:0,flipX:!1,flipY:!1}),S=g.endX-g.startX,U=g.endY-g.startY;e.save(),e.beginPath(),e.rect(g.startX,g.startY,S,U),e.clip();const E=D.getMatrix();e.transform(E[0],E[1],E[2],E[3],E[4],E[5]);const L=((r=o==null?void 0:o.fs)!=null?r:10)*1.6,O=String(w)===String(m),N=this._themeService.getColorFromTheme("primary.600");Kn.drawWith(e,{checked:O,width:L,height:L,fill:(a=(n=o==null?void 0:o.cl)==null?void 0:n.rgb)!=null?a:N}),e.restore()}isHit(e,t){const i=t.primaryWithCoord.isMergedMainCell?t.primaryWithCoord.mergeInfo:t.primaryWithCoord,r=this._calc(i,t.style),n=r.top,a=r.top+r.height,o=r.left,l=r.left+r.width,{x:s,y:d}=e;return s<=l&&s>=o&&d<=a&&d>=n}async onPointerDown(e,t){var i;if(t.button===2)return;const{primaryWithCoord:r,unitId:n,subUnitId:a,worksheet:o,row:l,col:s}=e,d=ne(o.getCellRaw(l,s)),c=this._dataValidationModel.getRuleByLocation(n,a,l,s);if(!c)return;const v=this._dataValidationModel.getValidator(c.type);if(!v||!((i=v.skipDefaultFontRender)!=null&&i.call(v,c,d,{unitId:n,subUnitId:a,row:l,column:s})))return;const{formula1:u,formula2:g}=await this._parseFormula(c,n,a),w={range:{startColumn:r.actualColumn,endColumn:r.actualColumn,startRow:r.actualRow,endRow:r.actualRow},value:{v:String(d)===ur(String(u))?g:u,p:null}};this._commandService.executeCommand(it.id,w)}onPointerEnter(e,t){var i,r;(r=(i=He(X.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:i.mainComponent)==null||r.setCursor(Fe.POINTER)}onPointerLeave(e,t){var i,r;(r=(i=He(X.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:i.mainComponent)==null||r.setCursor(Fe.DEFAULT)}};qt=sa([Ne(0,te),Ne(1,se),Ne(2,V(gr)),Ne(3,V($i)),Ne(4,V(Le)),Ne(5,V(re))],qt);var da=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},ua=(e,t)=>(i,r)=>t(i,r,e);let fe=class{constructor(e){T(this,"canvasRender",null),T(this,"dropdownType"),T(this,"optionsInput"),T(this,"formulaInput",li),this.injector=e}};fe=da([ua(0,V(ye))],fe);class ca extends fe{constructor(){super(...arguments),T(this,"id",F.CHECKBOX),T(this,"canvasRender",this.injector.createInstance(qt)),T(this,"formulaInput",nn)}}class ha extends fe{constructor(){super(...arguments),T(this,"id",F.CUSTOM),T(this,"formulaInput",tn)}}const va="data-validation.formula-input";class pa extends fe{constructor(){super(...arguments),T(this,"id",F.DATE),T(this,"formulaInput",va),T(this,"optionsInput",Ct.componentKey),T(this,"dropdownType",ve.DATE)}}class ga extends fe{constructor(){super(...arguments),T(this,"id",F.DECIMAL),T(this,"formulaInput",bt)}}const _n=4,ma=0,Ut=4,wn=4,Gt=6,yt=6,Re=14;function fa(e,t){const i=Gn.getTextSize(e,t),r=i.width+_n*2,{ba:n,bd:a}=i,o=n+a;return{width:r,height:o+ma*2,ba:n}}function At(e,t,i,r){const n=Re+Gt*2,a=i-n,o=r-yt*2,l=e.map(u=>({layout:fa(u,t),text:u}));let s;const d=[];l.forEach(u=>{const{layout:g}=u,{width:w,height:I}=g;!s||s.width+w+Ut>a?(s={width:w,height:I,items:[{...u,left:0}]},d.push(s)):(s.items.push({...u,left:s.width+Ut}),s.width=s.width+w+Ut)});let c=0,v=0;return d.forEach((u,g)=>{v=Math.max(v,u.width),g===d.length-1?c+=u.height:c+=u.height+wn}),{lines:d,totalHeight:c,contentWidth:a,contentHeight:o,cellAutoHeight:c+yt*2,calcAutoWidth:v+n}}const Ia=8;class _a extends qn{static drawWith(t,i){const{fontString:r,info:n,fill:a,color:o}=i,{layout:l,text:s}=n;t.save(),zi.drawWith(t,{width:l.width,height:l.height,radius:Ia,fill:a||Ee}),t.translateWithPrecision(_n,l.ba),t.font=r,t.fillStyle=o,t.fillText(s,0,0),t.restore()}}var wa=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},ct=(e,t)=>(i,r)=>t(i,r,e);const Ca=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z");let Qt=class{constructor(e,t,i,r){T(this,"zIndex"),T(this,"_dropdownInfoMap",new Map),this._commandService=e,this._univerInstanceService=t,this._renderManagerService=i,this._dataValidationModel=r}_ensureMap(e){let t=this._dropdownInfoMap.get(e);return t||(t=new Map,this._dropdownInfoMap.set(e,t)),t}_generateKey(e,t){return`${e}.${t}`}_drawDownIcon(e,t,i,r,n){const a=i-Re+4;let o=4;switch(n){case le.MIDDLE:o=(r-Re)/2+4;break;case le.BOTTOM:o=r-Re+4;break}e.save(),e.translateWithPrecision(t.startX+a,t.startY+o),e.fillStyle="#565656",e.fill(Ca),e.restore()}drawWith(e,t,i,r){var n,a;const{primaryWithCoord:o,row:l,col:s,style:d,data:c,subUnitId:v}=t,u=o.isMergedMainCell?o.mergeInfo:o,g=c==null?void 0:c.fontRenderExtension,{leftOffset:w=0,rightOffset:I=0,topOffset:f=0,downOffset:h=0}=g||{},m=this._ensureMap(v),C=this._generateKey(l,s),M=o.isMergedMainCell?o.mergeInfo.startRow:l,R=o.isMergedMainCell?o.mergeInfo.startColumn:s,y=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,M,R);if(!y)return;const k=this._dataValidationModel.getValidator(y.type);if(!k)return;const D={startX:u.startX+w,endX:u.endX-I,startY:u.startY+f,endY:u.endY-h},S=D.endX-D.startX,U=D.endY-D.startY,{cl:E}=d||{},L=(n=typeof E=="object"?E==null?void 0:E.rgb:E)!=null?n:"#000",O=Me(d??void 0),{vt:N,ht:W}=d||{},Z=N??le.MIDDLE,ue=(a=ne(c))!=null?a:"",G=k.parseCellValue(ue),z=k.getListWithColorMap(y),B=At(G,O,S,U);this._drawDownIcon(e,D,S,U,Z),e.save(),e.translateWithPrecision(D.startX,D.startY),e.beginPath(),e.rect(0,0,S-Re,U),e.clip(),e.translateWithPrecision(Gt,yt);let ie=0;switch(Z){case le.MIDDLE:ie=(B.contentHeight-B.totalHeight)/2;break;case le.BOTTOM:ie=B.contentHeight-B.totalHeight;break}e.translateWithPrecision(0,ie),B.lines.forEach((ae,q)=>{e.save();const{width:H,height:pe,items:Q}=ae;let x=0;switch(W){case we.RIGHT:x=B.contentWidth-H;break;case we.CENTER:x=(B.contentWidth-H)/2;break}e.translate(x,q*(pe+wn)),Q.forEach(A=>{e.save(),e.translateWithPrecision(A.left,0),_a.drawWith(e,{...O,info:A,color:L,fill:z[A.text]}),e.restore()}),e.restore()}),e.restore(),m.set(C,{left:D.startX,top:D.startY,width:B.contentWidth+Gt+Re,height:B.contentHeight+yt*2})}calcCellAutoHeight(e){var t;const{primaryWithCoord:i,style:r,data:n,row:a,col:o}=e,l=n==null?void 0:n.fontRenderExtension,{leftOffset:s=0,rightOffset:d=0,topOffset:c=0,downOffset:v=0}=l||{},u=i.isMergedMainCell?i.mergeInfo:i,g={startX:u.startX+s,endX:u.endX-d,startY:u.startY+c,endY:u.endY-v},w=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,a,o);if(!w)return;const I=this._dataValidationModel.getValidator(w.type);if(!I)return;const f=g.endX-g.startX,h=g.endY-g.startY,m=(t=ne(n))!=null?t:"",C=I.parseCellValue(m),M=Me(r??void 0);return At(C,M,f,h).cellAutoHeight}calcCellAutoWidth(e){var t;const{primaryWithCoord:i,style:r,data:n,row:a,col:o}=e,l=n==null?void 0:n.fontRenderExtension,{leftOffset:s=0,rightOffset:d=0,topOffset:c=0,downOffset:v=0}=l||{},u=i.isMergedMainCell?i.mergeInfo:i,g={startX:u.startX+s,endX:u.endX-d,startY:u.startY+c,endY:u.endY-v},w=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,a,o);if(!w)return;const I=this._dataValidationModel.getValidator(w.type);if(!I)return;const f=g.endX-g.startX,h=g.endY-g.startY,m=(t=ne(n))!=null?t:"",C=I.parseCellValue(m),M=Me(r??void 0);return At(C,M,f,h).calcAutoWidth}isHit(e,t){const{primaryWithCoord:i}=t,r=i.isMergedMainCell?i.mergeInfo:i,{endX:n}=r,{x:a}=e;return a>=n-Re&&a<=n}onPointerDown(e,t){if(t.button===2)return;const{unitId:i,subUnitId:r,row:n,col:a}=e,o={unitId:i,subUnitId:r,row:n,column:a};this._commandService.executeCommand(xt.id,o)}onPointerEnter(e,t){var i,r;return(r=(i=He(X.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:i.mainComponent)==null?void 0:r.setCursor(Fe.POINTER)}onPointerLeave(e,t){var i,r;return(r=(i=He(X.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:i.mainComponent)==null?void 0:r.setCursor(Fe.DEFAULT)}};Qt=wa([ct(0,te),ct(1,se),ct(2,V(Le)),ct(3,V(re))],Qt);class ya extends fe{constructor(){super(...arguments),T(this,"id",F.LIST_MULTIPLE),T(this,"canvasRender",this.injector.createInstance(Qt)),T(this,"dropdownType",ve.MULTIPLE_LIST)}}var Sa=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},tt=(e,t)=>(i,r)=>t(i,r,e);const $e=4,ht=4,he=14,Ot=1,_e=6,Be=3,Pt=8,ba="#565656",ki=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z");function Di(e,t,i,r,n,a,o=!0){let l=0;const s=o?Be:0;switch(n){case le.BOTTOM:l=t-r-s;break;case le.MIDDLE:l=(t-r)/2;break;default:l=s;break}l=Math.max(Be,l);let d=0;switch(a){case we.CENTER:d=(e-i)/2;break;case we.RIGHT:d=e-i;break}return d=Math.max(_e,d),{paddingLeft:d,paddingTop:l}}let Jt=class{constructor(e,t,i,r,n){T(this,"_dropdownInfoMap",new Map),T(this,"zIndex"),this._univerInstanceService=e,this._localeService=t,this._commandService=i,this._renderManagerService=r,this._dataValidationModel=n}_ensureMap(e){let t=this._dropdownInfoMap.get(e);return t||(t=new Map,this._dropdownInfoMap.set(e,t)),t}_generateKey(e,t){return`${e}.${t}`}_drawDownIcon(e,t,i,r,n,a,o){const{t:l=ee.pd.t,b:s=ee.pd.b}=o,d=i-he;let c;switch(a){case le.MIDDLE:c=(r-ht)/2;break;case le.BOTTOM:c=r-s-n-Be+(n/2-ht/2);break;default:c=l+Be+(n/2-ht/2);break}e.save(),e.translateWithPrecision(t.startX+d,t.startY+c),e.fillStyle="#565656",e.fill(ki),e.restore()}drawWith(e,t,i){var r,n,a,o,l,s;const{primaryWithCoord:d,row:c,col:v,style:u,data:g,subUnitId:w}=t,I=d.isMergedMainCell?d.mergeInfo:d,f=d.isMergedMainCell?d.mergeInfo.startRow:c,h=d.isMergedMainCell?d.mergeInfo.startColumn:v,m=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,f,h);if(!m)return;const C=this._dataValidationModel.getValidator(m.type);if(!C)return;const M=g==null?void 0:g.fontRenderExtension,{leftOffset:R=0,rightOffset:y=0,topOffset:k=0,downOffset:D=0}=M||{};if(!m||!C||!C||C.id.indexOf(F.LIST)!==0||!C.skipDefaultFontRender(m))return;const S={startX:I.startX+R,endX:I.endX-y,startY:I.startY+k,endY:I.endY-D},U=S.endX-S.startX,E=S.endY-S.startY,L=this._ensureMap(w),O=this._generateKey(c,v),N=C.getListWithColor(m),W=ne(g),Z=`${W??""}`,ue=N.find(q=>q.label===Z);let{tb:G,vt:z,ht:B,pd:ie}=u||{};G=G??ge.WRAP,z=z??le.BOTTOM,B=B??ee.ht,ie=ie??ee.pd;const ae=Me(u).fontCache;if(m.renderMode===oe.ARROW){const{l:q=ee.pd.l,t:H=ee.pd.t,r:pe=ee.pd.r,b:Q=ee.pd.b}=ie,x=U-q-pe-he-4,A=new et(Z,ae,G===ge.WRAP,x,1/0);A.calculate();const _=A.getTotalWidth(),j=A.getTotalHeight(),{paddingTop:$,paddingLeft:Ie}=Di(x,E-H-Q,_,j,z,B,!0);this._drawDownIcon(e,S,U,E,j,z,ie),e.save(),e.translateWithPrecision(S.startX+q,S.startY+H),e.beginPath(),e.rect(0,0,U-q-pe,E-H-Q),e.clip(),e.translateWithPrecision(0,$),e.save(),e.translateWithPrecision(Ie,0),e.beginPath(),e.rect(0,0,x,j),e.clip(),Ci.drawWith(e,{text:Z,fontStyle:ae,width:x,height:j,color:(r=u==null?void 0:u.cl)==null?void 0:r.rgb,strokeLine:!!((n=u==null?void 0:u.st)!=null&&n.s),underline:!!((a=u==null?void 0:u.ul)!=null&&a.s),warp:G===ge.WRAP,hAlign:we.LEFT},A),e.restore(),e.restore(),L.set(O,{left:S.endX-he+i.rowHeaderWidth,top:S.startY+H+i.columnHeaderHeight,width:he,height:E-H-Q})}else{e.save(),e.translateWithPrecision(S.startX,S.startY),e.beginPath(),e.rect(0,0,U,E),e.clip();const q=U-_e*2-$e-he-4,H=new et(Z,ae,G===ge.WRAP,q,1/0);H.calculate();const pe=H.getTotalWidth(),Q=H.getTotalHeight(),x=Q+Ot*2,A=Math.max(U-_e*2,1),{paddingTop:_}=Di(A,E,pe,x,z,B);e.translateWithPrecision(_e,_),zi.drawWith(e,{width:A,height:x,fill:(ue==null?void 0:ue.color)||Ee,radius:Pt}),e.save(),e.translateWithPrecision($e,Ot),e.beginPath(),e.rect(0,0,q,Q),e.clip(),Ci.drawWith(e,{text:Z,fontStyle:ae,width:q,height:Q,color:(o=u==null?void 0:u.cl)==null?void 0:o.rgb,strokeLine:!!((l=u==null?void 0:u.st)!=null&&l.s),underline:!!((s=u==null?void 0:u.ul)!=null&&s.s),warp:G===ge.WRAP,hAlign:we.LEFT},H),e.restore(),e.translateWithPrecision(q+$e+4,(Q-ht)/2),e.fillStyle=ba,e.fill(ki),e.restore(),L.set(O,{left:S.startX+_e+i.rowHeaderWidth,top:S.startY+_+i.columnHeaderHeight,width:A,height:x})}}calcCellAutoHeight(e){const{primaryWithCoord:t,style:i,data:r,row:n,col:a}=e,o=t.isMergedMainCell?t.mergeInfo:t,l=r==null?void 0:r.fontRenderExtension,{leftOffset:s=0,rightOffset:d=0,topOffset:c=0,downOffset:v=0}=l||{},u=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,n,a);if(!u||u.renderMode===oe.TEXT)return;const g={startX:o.startX+s,endX:o.endX-d,startY:o.startY+c,endY:o.endY-v},w=g.endX-g.startX,I=ne(r),f=`${I??""}`;let{tb:h,pd:m}=i||{};const{t:C=ee.pd.t,b:M=ee.pd.b}=m??{};if(h=h??ge.WRAP,u.renderMode===oe.ARROW){const{l:R=ee.pd.l,r:y=ee.pd.r}=m??{},k=w-R-y-he-4,D=new et(f,Me(i).fontCache,h===ge.WRAP,k,1/0);return D.calculate(),D.getTotalHeight()+C+M+Be*2}else{const R=Math.max(w-_e*2-$e-he-4,10),y=new et(f,Me(i).fontCache,h===ge.WRAP,R,1/0);return y.calculate(),y.getTotalHeight()+Be*2+Ot*2}}calcCellAutoWidth(e){const{primaryWithCoord:t,style:i,data:r,row:n,col:a}=e,o=t.isMergedMainCell?t.mergeInfo:t,l=r==null?void 0:r.fontRenderExtension,{leftOffset:s=0,rightOffset:d=0,topOffset:c=0,downOffset:v=0}=l||{},u=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,n,a);if(!u||u.renderMode===oe.TEXT)return;const g={startX:o.startX+s,endX:o.endX-d,startY:o.startY+c,endY:o.endY-v},w=g.endX-g.startX,I=ne(r),f=`${I??""}`;let{tb:h,pd:m}=i||{};const{l:C=ee.pd.l,r:M=ee.pd.r}=m??{};h=h??ge.WRAP;let R=_e*2+he;switch(u.renderMode){case oe.ARROW:R=he+4+M+C;break;case oe.CUSTOM:R=he+_e*2+$e*2+M+C+Pt/2+1;break;default:R=he+_e*2+$e*2+M+C+Pt/2+1}const y=w-R,k=new et(f,Me(i).fontCache,h===ge.WRAP,y,1/0);return k.calculate(),k.getTotalWidth()+R}isHit(e,t){const{subUnitId:i,row:r,col:n}=t,a=this._ensureMap(i).get(this._generateKey(r,n)),o=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,r,n);if(!o||!a||o.renderMode===oe.TEXT)return!1;const{top:l,left:s,width:d,height:c}=a,{x:v,y:u}=e;return v>=s&&v<=s+d&&u>=l&&u<=l+c}onPointerDown(e,t){if(t.button===2)return;const{unitId:i,subUnitId:r,row:n,col:a}=e,o={unitId:i,subUnitId:r,row:n,column:a};this._commandService.executeCommand(xt.id,o)}onPointerEnter(e,t){var i,r;(r=(i=He(X.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:i.mainComponent)==null||r.setCursor(Fe.POINTER)}onPointerLeave(e,t){var i,r;(r=(i=He(X.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:i.mainComponent)==null||r.setCursor(Fe.DEFAULT)}};Jt=Sa([tt(0,se),tt(1,V(de)),tt(2,te),tt(3,V(Le)),tt(4,V(re))],Jt);class Ra extends fe{constructor(){super(...arguments),T(this,"id",F.LIST),T(this,"canvasRender",this.injector.createInstance(Jt)),T(this,"dropdownType",ve.LIST),T(this,"optionsInput",wt.componentKey),T(this,"formulaInput",li)}}class xa extends fe{constructor(){super(...arguments),T(this,"id",F.TEXT_LENGTH),T(this,"formulaInput",bt)}}class Ma extends fe{constructor(){super(...arguments),T(this,"id",F.WHOLE),T(this,"formulaInput",bt)}}var Ea=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Nt=(e,t)=>(i,r)=>t(i,r,e);let Ge=class extends ti{constructor(e,t,i){super(),this._injector=e,this._componentManger=t,this._dataValidatorRegistryService=i,this._initComponents(),this._registerValidatorViews()}_initComponents(){[["DataValidationIcon",gn],[It,Qr],[wt.componentKey,wt],[Ct.componentKey,Ct],...aa].forEach(([e,t])=>{this.disposeWithMe(this._componentManger.register(e,t))})}_registerValidatorViews(){[ga,Ma,xa,pa,ca,Ra,ya,ha].forEach(e=>{const t=this._injector.createInstance(e),i=this._dataValidatorRegistryService.getValidatorItem(t.id);i&&(i.formulaInput=t.formulaInput,i.canvasRender=t.canvasRender,i.dropdownType=t.dropdownType,i.optionsInput=t.optionsInput)})}};Ge=Ea([Nt(0,V(ye)),Nt(1,V(ri)),Nt(2,V(Se))],Ge);var Va=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},$t=(e,t)=>(i,r)=>t(i,r,e);const Ta="SHEET_DATA_VALIDATION_UI_PLUGIN";var vt;let ji=(vt=class extends Li{constructor(e=ft,t,i,r){super(),this._config=e,this._injector=t,this._commandService=i,this._configService=r;const{menu:n,...a}=Ui({},ft,this._config);n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(ui,a)}onStarting(){[[me],[je],[at],[Ze],[qe],[ze],[Ke],[Ge]].forEach(e=>{this._injector.add(e)}),[Mt,xt,un,ci,Ue,dn].forEach(e=>{this._commandService.registerCommand(e)})}onReady(){this._injector.get(Ke),this._injector.get(ze),this._injector.get(Le).registerRenderModule(X.UNIVER_SHEET,[_t])}onRendered(){this._injector.get(Ge),this._injector.get(qe)}onSteady(){this._injector.get(Ze)}},T(vt,"pluginName",Ta),T(vt,"type",X.UNIVER_SHEET),vt);ji=Va([$t(1,V(ye)),$t(2,te),$t(3,ii)],ji);var ka=Object.defineProperty,Da=(e,t,i)=>t in e?ka(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,ja=(e,t,i,r)=>{for(var n=t,a=e.length-1,o;a>=0;a--)(o=e[a])&&(n=o(n)||n);return n},Bt=(e,t)=>(i,r)=>t(i,r,e),Cn=(e,t,i)=>Da(e,typeof t!="symbol"?t+"":t,i);const La="SHEET_DATA_VALIDATION_UI_PLUGIN";let St=class extends Li{constructor(e=ft,t,i,r){super(),this._config=e,this._injector=t,this._commandService=i,this._configService=r;const{menu:n,...a}=Ui({},ft,this._config);n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(ui,a)}onStarting(){[[me],[je],[at],[Ze],[qe],[ze],[Ke],[Xe],[Ge]].forEach(e=>{this._injector.add(e)}),[Mt,xt,un,ci,Ue,dn].forEach(e=>{this._commandService.registerCommand(e)})}onReady(){this._injector.get(Ke),this._injector.get(ze),this._injector.get(Xe),this._injector.get(at),this._injector.get(Le).registerRenderModule(X.UNIVER_SHEET,[_t])}onRendered(){this._injector.get(Ge),this._injector.get(qe)}onSteady(){this._injector.get(Ze)}};Cn(St,"pluginName",La);Cn(St,"type",X.UNIVER_SHEET);St=ja([An(vr),Bt(1,V(ye)),Bt(2,te),Bt(3,ii)],St);export{ji as B,St as T,fe as f};
