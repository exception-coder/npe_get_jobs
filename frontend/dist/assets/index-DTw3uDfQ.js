import{M as nt,v as Z,L as X,cm as T,V as G,j as hi,ai as Wi,S as ge,C as St,af as Zi,a5 as Gi,bV as pe,bC as Le,w as x,bQ as he,cP as gi,O as Ki,o as Yi,J as Ve,F as rt,am as zi,y as qi,b0 as ei,U as Ji,d as Xi,dk as vt,a9 as ti,s as Qi,e as $e,b as wt,a as en,ak as ne,c as tn,bR as nn,a3 as mt,q as rn,I as b,u as st,x as vi,an as sn}from"./TeamSpreadsheet-DqPQXi__.js";import{r0 as on,nJ as bt,q as J,z as Rt,I as _t,s2 as an,q_ as yt,or as ln,o9 as un,p7 as Me,qO as dn,M as Ne,bY as cn,qK as pn,qJ as hn,e4 as je,lr as mi,pp as fi,lG as Ii,d as E,dg as _i,t6 as gn,j as ot,oW as vn,a9 as Te,eM as mn,X as yi,sV as fn,eL as In,aL as _n,h as yn,kg as Cn,na as En,mR as Sn,L as Lt,V as Pt,mZ as xt,P as kt,mv as wn,mS as bn,oR as Rn,u as ii,s as Pe,aQ as ni,jc as Ln,jb as Pn,jd as xn,B as at,H as Ci,n6 as Ei,v as Si,rb as kn,ra as Tn,sd as Nn,c as Un,qE as Mn,of as Se,eK as On,a3 as Hn,pV as Vn,aM as $n,oY as jn,oS as Dn,mb as wi,i as Bn,G as An,k as Fn,n as Wn,R as Zn}from"./index--BQDx9CP.js";import{m as be,r as f,j as g,i as De,ab as de,V as ri,L as ft,v as si,k as bi,R as Oe}from"./facade-DLk4o3Z_.js";import{W as Gn}from"./index-DNSnhRIr.js";import{N as xe,D as ke,E as C,t as Kn,v as Tt,M as Yn,I as zn,w as qn,C as Jn,R as Xn,S as Qn,d as er,a as lt}from"./index-DhqLArvi.js";import{F as oi}from"./index-R4J-DW51.js";var tr=Object.defineProperty,ir=(e,t,i)=>t in e?tr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,F=(e,t,i)=>ir(e,typeof t!="symbol"?t+"":t,i),v=(e=>(e.EDITING="editing",e.VIEWING="viewing",e.ZEN_EDITOR="zen_mode",e))(v||{});function Ae(e){return Ve.isLegalUrl(e)}function nr(e){return/^[a-zA-Z]+:\/\//.test(e)}function rr(e){return/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(e)}function sr(e){if(Ae(e)){const t=nr(e)?e:rr(e)?`mailto://${e}`:`http://${e}`;let i;try{i=new URL(t)}catch{return e}return i.hostname===location.hostname&&i.port===location.port&&i.protocol===location.protocol&&i.pathname===location.pathname&&i.hash&&!i.search?i.hash:t}return e}const Ri="sheets-hyper-link-ui.config",ai={};var or=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},ce=(e,t)=>(i,r)=>t(i,r,e);function ar(e,t){const i=t.getMergeData(),r=t.getMaxColumns()-1,n=t.getMaxRows()-1;if(r<e.endColumn&&(e.endColumn=r),n<e.endRow&&(e.endRow=n),e.rangeType===ti.COLUMN||ti.ROW)return e;const s=[];return i.forEach(o=>{ge.intersects(e,o)&&s.push(o)}),ge.realUnion(e,...s)}let se=class{constructor(e,t,i,r,n,s){this._univerInstanceService=e,this._commandService=t,this._definedNamesService=i,this._messageService=r,this._localeService=n,this._configService=s}navigate(e){switch(e.type){case C.URL:this.navigateToOtherWebsite(e.url);break;default:this._navigateToUniver(e.searchObj)}}_navigateToUniver(e){const{gid:t,range:i,rangeid:r}=e,n=this._univerInstanceService.getCurrentUnitForType(x.UNIVER_SHEET);if(!n)return;const s=n.getUnitId();if(r){const o=this._definedNamesService.getValueById(s,r);if(!o)return;const{formulaOrRefString:u}=o,d=this._definedNamesService.getWorksheetByRef(s,u);if(!d){this._messageService.show({content:this._localeService.t("hyperLink.message.refError"),type:be.Error});return}if(d.isSheetHidden()){this._messageService.show({content:this._localeService.t("hyperLink.message.hiddenSheet"),type:be.Error});return}this.navigateToDefineName(s,r)}if(t){if(i){const o=je(i);gi(o.range)&&i!==Kn&&this.navigateToRange(s,t,o.range);return}this.navigateToSheetById(s,t)}}async navigateToRange(e,t,i,r){const n=await this.navigateToSheetById(e,t);if(n){const s=ar(i,n);await this._commandService.executeCommand(mi.id,{unitId:e,subUnitId:t,selections:[{range:s,primary:null}]}),await this._commandService.executeCommand(fi.id,{range:s,forceTop:r})}}async navigateToSheetById(e,t){const i=this._univerInstanceService.getUnit(e,x.UNIVER_SHEET);if(!i)return!1;const r=i.getActiveSheet();if(!r)return!1;if(r.getSheetId()===t)return r;const n=i.getSheetBySheetId(t);return n?i.getHiddenWorksheets().indexOf(t)>-1?(this._messageService.show({content:this._localeService.t("hyperLink.message.hiddenSheet"),type:be.Error}),!1):await this._commandService.executeCommand(Ii.id,{unitId:e,subUnitId:t})?n:!1:(this._messageService.show({content:this._localeService.t("hyperLink.message.noSheet"),type:be.Error}),!1)}async navigateToDefineName(e,t){return this._definedNamesService.focusRange(e,t),!0}async navigateToOtherWebsite(e){var t;const i=this._configService.getConfig(Ri);if((t=i==null?void 0:i.urlHandler)!=null&&t.navigateToOtherWebsite)return i.urlHandler.navigateToOtherWebsite(e);window.open(e,"_blank","noopener noreferrer")}};se=or([ce(0,Z),ce(1,X),ce(2,_i),ce(3,Si),ce(4,b(rt)),ce(5,vi)],se);class Li extends G{constructor(){super(...arguments),F(this,"_customHyperLinks",new Map)}isBuiltInLinkType(t){return t!==C.URL}getOptions(){return Array.from(this._customHyperLinks.values()).map(({option:t})=>t)}findCustomHyperLink(t){return Array.from(this._customHyperLinks.values()).find(i=>i.match(t))}registerCustomHyperLink(t){this._customHyperLinks.set(t.type,t)}getCustomHyperLink(t){return this._customHyperLinks.get(t)}removeCustomHyperLink(t){const{_customHyperLinks:i}=this;i.delete(t)}dispose(){super.dispose(),this._customHyperLinks.clear()}}const Fe=()=>{var e;const[t,i]=f.useState(""),[r,n]=f.useState(!1),[s,o]=f.useState(""),[u,d]=f.useState(!0),[l,h]=f.useState(C.URL),[c,m]=f.useState(""),I=E(rt),R=E(_i),_=E(J),y=E(Z),L=E(W),a=gn(L.currentEditing$),k=E(Tt),O=E(se),N=E(X),M=E(Li),Y=f.useMemo(()=>M.getOptions(),[M]),j=E(ot),ae=E(Ne),ve=E(vn),me=E(Te),Q=E(zi),fe=E(qi),Ie=E(Te),[_e,le]=f.useState(!1),Vi=E(Rt),$i=f.useMemo(()=>Vi.getCurrentSelections(),[]),ut=f.useMemo(()=>{if(!M.isBuiltInLinkType(l))return M.getCustomHyperLink(l)},[M,l]),[ue,ji]=f.useState(!1),[ye,$t]=f.useState(!1),H=f.useRef(!1),K=y.getCurrentUnitForType(x.UNIVER_SHEET),Di=(K==null?void 0:K.getActiveSheet().getSheetId())||"",z=f.useCallback(p=>{o(p.replaceAll(ei.CUSTOM_RANGE_START,"").replaceAll(ei.CUSTOM_RANGE_END,""))},[o]);f.useEffect(()=>{var p,S,w,P,V,D,Dt,Bt,At,Ft,Wt,Zt,Gt,Kt,Yt,zt,qt;if((a==null?void 0:a.row)!==void 0&&a.col!==void 0){const{customRange:Ce,row:ht,col:gt}=a;let{label:ee}=a;typeof ee=="number"&&(ee=`${ee}`);let B;if(Ce)B={id:(p=Ce==null?void 0:Ce.rangeId)!=null?p:"",display:ee??"",payload:(w=(S=Ce==null?void 0:Ce.properties)==null?void 0:S.url)!=null?w:"",row:ht,column:gt};else if(a.type===v.VIEWING){const U=y.getUnit(a.unitId),te=U==null?void 0:U.getSheetBySheetId(a.subUnitId),$=te==null?void 0:te.getCellRaw(a.row,a.col),Ee=(D=(V=(P=$==null?void 0:$.p)==null?void 0:P.body)==null?void 0:V.customRanges)==null?void 0:D.find(Xt=>{var Qt;return Xt.rangeType===Le.HYPERLINK&&((Qt=Xt.properties)==null?void 0:Qt.url)}),Ue=$==null?void 0:$.v;$&&(!pe.transform.isEmptyDocument((Bt=(Dt=$.p)==null?void 0:Dt.body)==null?void 0:Bt.dataStream)||Ve.isDefine(Ue))&&d(!1),B={id:"",display:"",payload:(Ft=(At=Ee==null?void 0:Ee.properties)==null?void 0:At.url)!=null?Ft:"",row:ht,column:gt}}else{const U=y.getCurrentUnitForType(x.UNIVER_DOC),te=me.getActiveTextRange(),$=U==null?void 0:U.getBody(),Ee=te&&$?te:null,Ue=Ee&&((Zt=pe.customRange.getCustomRangesInterestsWithSelection(Ee,(Wt=$==null?void 0:$.customRanges)!=null?Wt:[]))==null?void 0:Zt[0]);d(!1),B={id:"",display:ee??"",payload:(Kt=(Gt=Ue==null?void 0:Ue.properties)==null?void 0:Gt.url)!=null?Kt:"",row:ht,column:gt}}i(B.id);const Jt=M.findCustomHyperLink(B);if(Jt){const U=Jt.convert(B);h(U.type),m(U.payload),z(U.display);return}z(B.display);const q=k.parseHyperLink(B.payload);switch(h(q.type===C.INVALID?C.RANGE:q.type),q.type){case C.URL:{m(q.url),q.url===B.display&&(H.current=!0);break}case C.RANGE:{const U=q.searchObj,te=U.gid&&(qt=(zt=(Yt=y.getUnit(a.unitId))==null?void 0:Yt.getSheetBySheetId(U.gid))==null?void 0:zt.getName())!=null?qt:"",$=mn(te,je(U.range).range);m($),$===B.display&&(H.current=!0);break}case C.SHEET:{const U=q.searchObj;m(U.gid);break}case C.DEFINE_NAME:{const U=q.searchObj;m(U.rangeid);break}default:m("");break}}},[a,O,M,me,y]),f.useEffect(()=>{let p=null;if(a&&!a.customRangeId&&a.type===v.VIEWING&&Ve.isDefine(a.row)&&Ve.isDefine(a.col)){const S=y.getUnit(a.unitId,x.UNIVER_SHEET),w=S==null?void 0:S.getSheetBySheetId(a.subUnitId),P=w==null?void 0:w.getMergedCell(a.row,a.col),V=new Ji(fe.getColorFromTheme("primary.600")).toRgb();p=ve.addShape({range:P??{startColumn:a.col,endColumn:a.col,startRow:a.row,endRow:a.row},style:{fill:`rgb(${V.r}, ${V.g}, ${V.b}, 0.12)`,strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null},[],-1)}return()=>{p&&ve.removeShape(p)}},[a,ve,fe,y]),f.useEffect(()=>{$t(l===C.RANGE)},[l]),f.useEffect(()=>{const p=(a==null?void 0:a.type)===v.ZEN_EDITOR?ae.getRenderById(T):ae.getRenderById(_.getCurrentEditorId()),S=new Xi;if(p){const w=p.with(yi);w.setReserveRangesStatus(!0),S.add(()=>{w.setReserveRangesStatus(!1)})}return()=>{_.disableForceKeepVisible(),S.dispose()}},[a==null?void 0:a.type,_,ae]),f.useEffect(()=>(ye&&L.setIsKeepVisible(ye),L.setIsKeepVisible(_e),()=>{L.setIsKeepVisible(!1)}),[ye,_e,L]),f.useEffect(()=>()=>{j.temporaryHidden&&(j.show(),Q.setContextValue(vt,!1))},[Q,j]),f.useEffect(()=>{if(ye)return _.enableForceKeepVisible(),()=>{_.disableForceKeepVisible()}},[ye,_]);const Bi=[{label:I.t("hyperLink.form.link"),value:C.URL},{label:I.t("hyperLink.form.range"),value:C.RANGE},{label:I.t("hyperLink.form.worksheet"),value:C.SHEET},{label:I.t("hyperLink.form.definedName"),value:C.DEFINE_NAME},...Y];if(!K)return;const Ai=K.getHiddenWorksheets(),dt=K.getSheets().map(p=>({label:p.getName(),value:p.getSheetId()})).filter(p=>Ai.indexOf(p.value)===-1),ct=Object.values((e=R.getDefinedNameMap(K.getUnitId()))!=null?e:{}).map(p=>({label:p.name,value:p.id})),jt=(p,S)=>{if(p===C.URL)return sr(S);if(p===C.RANGE){const w=je(S),P=K.getSheetBySheetName(w.sheetName);if(P)return`#gid=${P.getSheetId()}&range=${On(w.range)}`}return`#${p}=${S}`},Fi=fn(p=>{var S;const w=p.split(",").map(je)[0];if(!w||!gi(w.range))return;w.sheetName||(w.sheetName=((S=K.getActiveSheet())==null?void 0:S.getName())||"");const P=In(w);m(P),P&&(H.current||!s)&&(z(P),H.current=!0)}),pt=async()=>{if(u&&!s||!c||l===C.URL&&!Ae(c)){ji(!0);return}if(a)if(t){const p=a.type===v.ZEN_EDITOR||a.type===v.EDITING?qn.id:Jn.id;await N.executeCommand(p,{id:t,unitId:a.unitId,subUnitId:a.subUnitId,payload:{display:u?s:"",payload:jt(l,c)},row:a.row,column:a.col,documentId:a.type===v.ZEN_EDITOR?T:_.getCurrentEditorId()})}else{const p=a.type===v.ZEN_EDITOR||a.type===v.EDITING?Xn.id:Qn.id;await N.executeCommand(p,{unitId:a.unitId,subUnitId:a.subUnitId,link:{id:St(),row:a.row,column:a.col,payload:jt(l,c),display:u?s:""},documentId:a.type===v.ZEN_EDITOR?T:_.getCurrentEditorId()})}if((a==null?void 0:a.type)===v.VIEWING){await N.executeCommand(Ii.id,{unitId:a.unitId,subUnitId:a.subUnitId});const p=1;await N.executeCommand(fi.id,{range:{startRow:Math.max(a.row-p,0),endRow:a.row+p,startColumn:Math.max(a.col-p,0),endColumn:a.col+p}})}N.executeCommand(Ze.id)};return a?g.jsxs("div",{className:De("univer-box-border univer-w-[296px] univer-rounded-xl univer-bg-white univer-p-4 univer-shadow-md dark:!univer-bg-gray-900",bi),children:[u?g.jsx(de,{label:I.t("hyperLink.form.label"),error:ue&&!s?I.t("hyperLink.form.inputError"):"",children:g.jsx(ri,{value:s,onChange:p=>{z(p),H.current=!1},placeholder:I.t("hyperLink.form.labelPlaceholder"),autoFocus:!0,onKeyDown:p=>{p.keyCode===_t.ENTER&&pt()}})}):null,g.jsx(de,{label:I.t("hyperLink.form.type"),children:g.jsx(ft,{className:"univer-w-full",options:Bi,value:l,onChange:p=>{h(p),m("")}})}),l===C.URL&&g.jsx(de,{error:ue?c?Ae(c)?"":I.t("hyperLink.form.linkError"):I.t("hyperLink.form.inputError"):"",children:g.jsx(ri,{value:c,onChange:p=>{m(p),p&&(H.current||!s||s===p)&&(z(p),H.current=!0)},placeholder:I.t("hyperLink.form.linkPlaceholder"),autoFocus:!0,onKeyDown:p=>{p.keyCode===_t.ENTER&&pt()}})}),l===C.RANGE&&g.jsx(de,{error:ue&&!c?I.t("hyperLink.form.inputError"):"",children:g.jsx(Gn,{unitId:K.getUnitId(),subUnitId:Di,maxRangeCount:1,supportAcrossSheet:!0,initialValue:c,resetRange:$i,onChange:(p,S)=>Fi(S),onRangeSelectorDialogVisibleChange:async p=>{var S,w;if(le(p),p)a.type===v.ZEN_EDITOR&&(j.hide(),Q.setContextValue(vt,!0)),a.type!==v.VIEWING&&_.enableForceKeepVisible(),n(!0);else{if(await O.navigateToRange(a.unitId,a.subUnitId,{startRow:a.row,endRow:a.row,startColumn:a.col,endColumn:a.col},!0),a.type===v.ZEN_EDITOR){await N.executeCommand(mi.id,{unitId:a.unitId,subUnitId:a.subUnitId,selections:[{range:{startRow:a.row,endRow:a.row,startColumn:a.col,endColumn:a.col}}]}),j.show(),Q.setContextValue(vt,!1);const P=(S=ae.getRenderById(T))==null?void 0:S.with(_n),V=(w=Ie.getTextRanges({unitId:T,subUnitId:T}))==null?void 0:w[0];P&&V&&(P.scrollToRange(V),Ie.refreshSelection({unitId:T,subUnitId:T}))}_.disableForceKeepVisible(),n(!1)}},onFocusChange:p=>$t(p)})}),l===C.SHEET&&g.jsx(de,{error:ue&&!c?I.t("hyperLink.form.selectError"):"",children:g.jsx(ft,{className:"univer-w-full",options:dt,value:c,onChange:p=>{var S,w;m(p);const P=(S=dt.find(D=>D.value===p))==null?void 0:S.label,V=(w=dt.find(D=>D.value===c))==null?void 0:w.label;P&&(H.current||!s||s===V)&&(z(P),H.current=!0)}})}),l===C.DEFINE_NAME&&g.jsx(de,{error:ue&&!c?I.t("hyperLink.form.selectError"):"",children:g.jsx(ft,{className:"univer-w-full",options:ct,value:c,onChange:p=>{var S,w;m(p);const P=(S=ct.find(D=>D.value===p))==null?void 0:S.label,V=(w=ct.find(D=>D.value===c))==null?void 0:w.label;P&&(H.current||!s||s===V)&&(z(P),H.current=!0)}})}),(ut==null?void 0:ut.Form)&&g.jsx(ut.Form,{linkId:t,payload:c,display:s,showError:ue,setByPayload:H,setDisplay:p=>{z(p),H.current=!0},setPayload:m}),g.jsxs("div",{className:"univer-flex univer-flex-row univer-justify-end univer-gap-2",children:[g.jsx(si,{onClick:()=>{a&&O.navigateToRange(a.unitId,a.subUnitId,{startRow:a.row,endRow:a.row,startColumn:a.col,endColumn:a.col},!0),N.executeCommand(Ze.id)},children:I.t("hyperLink.form.cancel")}),g.jsx(si,{variant:"primary",onClick:async()=>{pt()},children:I.t("hyperLink.form.ok")})]})]}):null};Fe.componentKey="univer.sheet.cell-link-edit";function oe({ref:e,...t}){const{icon:i,id:r,className:n,extend:s,...o}=t,u=`univerjs-icon univerjs-icon-${r} ${n||""}`.trim(),d=f.useRef(`_${dr()}`);return Pi(i,`${r}`,{defIds:i.defIds,idSuffix:d.current},{ref:e,className:u,...o},s)}function Pi(e,t,i,r,n){return f.createElement(e.tag,{key:t,...lr(e,i,n),...r},(ur(e,i).children||[]).map((s,o)=>Pi(s,`${t}-${e.tag}-${o}`,i,void 0,n)))}function lr(e,t,i){const r={...e.attrs};i!=null&&i.colorChannel1&&r.fill==="colorChannel1"&&(r.fill=i.colorChannel1),e.tag==="mask"&&r.id&&(r.id=r.id+t.idSuffix),Object.entries(r).forEach(([s,o])=>{s==="mask"&&typeof o=="string"&&(r[s]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))});const{defIds:n}=t;return!n||n.length===0||(e.tag==="use"&&r["xlink:href"]&&(r["xlink:href"]=r["xlink:href"]+t.idSuffix),Object.entries(r).forEach(([s,o])=>{typeof o=="string"&&(r[s]=o.replace(/url\(#(.*)\)/,`url(#$1${t.idSuffix})`))})),r}function ur(e,t){var i;const{defIds:r}=t;return!r||r.length===0?e:e.tag==="defs"&&(i=e.children)!=null&&i.length?{...e,children:e.children.map(n=>typeof n.attrs.id=="string"&&r&&r.includes(n.attrs.id)?{...n,attrs:{...n.attrs,id:n.attrs.id+t.idSuffix}}:n)}:e}function dr(){return Math.random().toString(36).substring(2,8)}oe.displayName="UniverIcon";const cr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.9999 1.12915C8.03875 1.12915 8.07673 1.13284 8.11352 1.13989H12.2599C13.6958 1.13989 14.8599 2.30395 14.8599 3.73989V7.88619C14.867 7.92301 14.8707 7.96102 14.8707 7.9999C14.8707 8.03878 14.867 8.0768 14.8599 8.11362V12.2599C14.8599 13.6958 13.6958 14.8599 12.2599 14.8599H8.11362C8.0768 14.867 8.03878 14.8707 7.9999 14.8707C7.96102 14.8707 7.92301 14.867 7.88619 14.8599H3.73989C2.30396 14.8599 1.13989 13.6958 1.13989 12.2599V8.11352C1.13284 8.07673 1.12915 8.03875 1.12915 7.9999C1.12915 7.96106 1.13284 7.92308 1.13989 7.88629V3.73989C1.13989 2.30396 2.30395 1.13989 3.73989 1.13989H7.88629C7.92308 1.13284 7.96106 1.12915 7.9999 1.12915ZM2.33989 8.5999V12.2599C2.33989 13.0331 2.9667 13.6599 3.73989 13.6599H7.3999V8.5999H2.33989ZM7.3999 7.3999H2.33989V3.73989C2.33989 2.9667 2.96669 2.33989 3.73989 2.33989H7.3999V7.3999ZM8.5999 8.5999V13.6599H12.2599C13.0331 13.6599 13.6599 13.0331 13.6599 12.2599V8.5999H8.5999ZM13.6599 7.3999H8.5999V2.33989H12.2599C13.0331 2.33989 13.6599 2.96669 13.6599 3.73989V7.3999Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Be=f.forwardRef(function(e,t){return f.createElement(oe,Object.assign({},e,{id:"all-border-icon",ref:t,icon:cr}))});Be.displayName="AllBorderIcon";const pr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.1302 12.4251C4.25802 13.7417 5.36779 14.7708 6.71792 14.7708H11.7179C13.1539 14.7708 14.3179 13.6067 14.3179 12.1708V6.1708C14.3179 4.78586 13.2351 3.65383 11.8698 3.57517C11.742 2.25858 10.6323 1.22949 9.28213 1.22949H4.28213C2.84619 1.22949 1.68213 2.39355 1.68213 3.82949V9.82949C1.68213 11.2144 2.76497 12.3465 4.1302 12.4251ZM10.6583 3.5708H6.71792C5.28198 3.5708 4.11792 4.73486 4.11792 6.1708V11.22C3.4221 11.1387 2.88213 10.5471 2.88213 9.82949V3.82949C2.88213 3.05629 3.50893 2.42949 4.28213 2.42949H9.28213C9.96695 2.42949 10.5369 2.92119 10.6583 3.5708ZM13.1179 6.1708C13.1179 5.3976 12.4911 4.7708 11.7179 4.7708H6.71792C5.94472 4.7708 5.31792 5.3976 5.31792 6.1708V12.1708C5.31792 12.944 5.94472 13.5708 6.71792 13.5708H11.7179C12.4911 13.5708 13.1179 12.944 13.1179 12.1708V6.1708Z",fillRule:"evenodd",clipRule:"evenodd"}}]},xi=f.forwardRef(function(e,t){return f.createElement(oe,Object.assign({},e,{id:"copy-icon",ref:t,icon:pr}))});xi.displayName="CopyIcon";const hr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M9.8816 1.97978C11.0177 0.843607 12.862 0.884962 14.0004 2.02342C15.1389 3.16188 15.1803 5.00612 14.0441 6.14228L11.399 8.78737C11.1608 9.02559 10.7746 9.02559 10.5363 8.78737C10.2981 8.54915 10.2981 8.16292 10.5363 7.9247L13.1814 5.2796C13.8195 4.64155 13.8217 3.57006 13.1378 2.8861C12.4538 2.20211 11.3823 2.20438 10.7443 2.84245L7.6976 5.88911L7.69317 5.89349C7.05959 6.53211 7.05894 7.60014 7.74132 8.28252C7.97954 8.52074 7.97954 8.90697 7.74132 9.14519C7.5031 9.38341 7.11687 9.38341 6.87865 9.14519C5.74016 8.00671 5.69884 6.16251 6.83497 5.02633L6.84021 5.02116L9.8816 1.97978Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.61426 7.2364C4.85248 6.99818 5.23871 6.99818 5.47693 7.2364C5.71515 7.47462 5.71515 7.86085 5.47693 8.09907L2.83183 10.7442C2.19375 11.3823 2.1915 12.4537 2.87547 13.1377C3.55945 13.8217 4.6309 13.8194 5.26899 13.1813L8.31566 10.1347C8.32262 10.1277 8.32971 10.121 8.33691 10.1144C8.34408 10.1064 8.3515 10.0986 8.35916 10.091C8.99721 9.45291 8.99949 8.38145 8.3155 7.69746C8.07728 7.45924 8.07728 7.07301 8.3155 6.83479C8.55372 6.59657 8.93995 6.59657 9.17817 6.83479C10.3166 7.97327 10.358 9.81748 9.22183 10.9536C9.21487 10.9606 9.20779 10.9673 9.20058 10.9739C9.19341 10.9819 9.18599 10.9897 9.17833 10.9973L6.13166 14.044C4.99548 15.1802 3.15127 15.1389 2.01279 14.0004C0.874362 12.8619 0.83297 11.0177 1.96916 9.8815L4.61426 7.2364Z"}}]},Nt=f.forwardRef(function(e,t){return f.createElement(oe,Object.assign({},e,{id:"link-icon",ref:t,icon:hr}))});Nt.displayName="LinkIcon";const gr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.5935 3.47302C11.6354 2.51492 10.082 2.51492 9.12388 3.47302L7.83534 4.76157C7.60102 4.99588 7.22112 4.99588 6.98681 4.76157C6.75249 4.52725 6.75249 4.14735 6.98681 3.91304L8.27535 2.62449C9.70209 1.19776 12.0153 1.19776 13.442 2.62449C14.8688 4.05123 14.8688 6.36442 13.442 7.79116L12.1535 9.0797C11.9192 9.31402 11.5393 9.31402 11.3049 9.0797C11.0706 8.84539 11.0706 8.46549 11.3049 8.23117L12.5935 6.94263C13.5516 5.98452 13.5516 4.43113 12.5935 3.47302Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.40637 12.6606C2.44827 11.7025 2.44827 10.1491 3.40637 9.19102L4.69492 7.90248C4.92923 7.66816 4.92923 7.28826 4.69492 7.05395C4.4606 6.81963 4.0807 6.81963 3.84639 7.05395L2.55784 8.34249C1.13111 9.76923 1.13111 12.0824 2.55784 13.5092C3.98458 14.9359 6.29777 14.9359 7.72451 13.5092L9.01305 12.2206C9.24737 11.9863 9.24737 11.6064 9.01305 11.3721C8.77874 11.1378 8.39884 11.1378 8.16452 11.3721L6.87598 12.6606C5.91787 13.6187 4.36448 13.6187 3.40637 12.6606Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.5852 2.80332C3.35088 2.569 2.97098 2.569 2.73667 2.80332C2.50235 3.03763 2.50235 3.41753 2.73667 3.65185L12.4151 13.3302C12.6494 13.5646 13.0293 13.5646 13.2636 13.3302C13.4979 13.0959 13.4979 12.716 13.2636 12.4817L3.5852 2.80332Z"}}]},ki=f.forwardRef(function(e,t){return f.createElement(oe,Object.assign({},e,{id:"unlink-icon",ref:t,icon:gr}))});ki.displayName="UnlinkIcon";const vr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.6551 1.98906C11.7476 1.08113 10.2757 1.08149 9.3686 1.98987L4.82542 6.53955C4.75087 6.61421 4.69336 6.70411 4.65682 6.80309L3.2461 10.625C3.16506 10.8446 3.21909 11.0912 3.3845 11.2568C3.54991 11.4224 3.79651 11.4767 4.01616 11.3959L7.85031 9.98517C7.94979 9.94856 8.04014 9.89077 8.11508 9.81579L12.6552 5.27327C13.5618 4.36621 13.5618 2.89607 12.6551 1.98906ZM10.2177 2.83779C10.6562 2.39869 11.3677 2.39851 11.8064 2.8374C12.2447 3.27584 12.2447 3.9865 11.8065 4.42497L7.3392 8.89457L4.82213 9.82068L5.74706 7.31487L10.2177 2.83779Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.79238 13.2999C1.46101 13.2999 1.19238 13.5685 1.19238 13.8999C1.19238 14.2313 1.46101 14.4999 1.79238 14.4999H14.4924C14.8238 14.4999 15.0924 14.2313 15.0924 13.8999C15.0924 13.5685 14.8238 13.2999 14.4924 13.2999H1.79238Z"}}]},Ti=f.forwardRef(function(e,t){return f.createElement(oe,Object.assign({},e,{id:"write-icon",ref:t,icon:vr}))});Ti.displayName="WriteIcon";const mr={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"#35BD4B",d:"M3.4535 1.12549C2.7002 1.12549 2.08954 1.73615 2.08954 2.48945V13.5104C2.08954 14.2637 2.7002 14.8744 3.4535 14.8744H12.5465C13.2998 14.8744 13.9105 14.2637 13.9105 13.5104V5.0992L10.0091 1.12549H3.4535Z"}},{tag:"path",attrs:{fill:"#32A846",d:"M10.0075 1.12549L13.9104 5.09842H10.6742C10.306 5.09842 10.0075 4.79994 10.0075 4.43175V1.12549Z"}},{tag:"path",attrs:{fill:"white",d:"M7.8088 10.2949L6.3764 12.403C6.26259 12.5705 6.03455 12.614 5.86705 12.5002C5.69955 12.3864 5.65603 12.1584 5.76984 11.9909L7.3655 9.64252L5.94042 7.54519C5.82661 7.37769 5.87013 7.14964 6.03763 7.03583C6.20512 6.92202 6.43317 6.96555 6.54698 7.13304L7.8088 8.9901L9.07062 7.13304C9.18443 6.96555 9.41248 6.92202 9.57997 7.03583C9.74747 7.14964 9.79099 7.37769 9.67718 7.54519L8.2521 9.64252L9.84776 11.9909C9.96157 12.1584 9.91805 12.3864 9.75055 12.5002C9.58305 12.614 9.35501 12.5705 9.2412 12.403L7.8088 10.2949Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ni=f.forwardRef(function(e,t){return f.createElement(oe,Object.assign({},e,{id:"xlsx-multi-icon",ref:t,icon:mr}))});Ni.displayName="XlsxMultiIcon";const fr={[C.URL]:g.jsx(Nt,{}),[C.SHEET]:g.jsx(Ni,{className:"univer-text-green-500"}),[C.RANGE]:g.jsx(Be,{}),[C.DEFINE_NAME]:g.jsx(Be,{}),[C.INVALID]:g.jsx(Be,{})},li=e=>{var t,i;const r=E(W),n=E(X),s=E(Si),o=E(rt),u=E(se),d=E(J),l=E(Tt),h=E(ot),{customRange:c,row:m,col:I,unitId:R,subUnitId:_,editPermission:y,copyPermission:L,type:a}=e;if(!((t=c==null?void 0:c.properties)!=null&&t.url))return null;const k=l.parseHyperLink((i=c.properties.url)!=null?i:""),O=k.type===C.INVALID;return g.jsxs("div",{className:De("univer-mb-1 univer-flex univer-max-w-80 univer-flex-row univer-items-center univer-justify-between univer-overflow-hidden univer-rounded-lg univer-bg-white univer-p-3 univer-shadow-md dark:!univer-bg-gray-900",bi),onClick:()=>r.hideCurrentPopup(),children:[g.jsxs("div",{className:De("univer-flex univer-h-6 univer-flex-1 univer-cursor-pointer univer-flex-row univer-items-center univer-truncate univer-text-sm univer-leading-5 univer-text-primary-600",{"univer-text-red-500":O}),onClick:()=>{h.visible||O||u.navigate(k)},children:[g.jsx("div",{className:"univer-mr-2 univer-flex univer-h-5 univer-w-5 univer-flex-none univer-items-center univer-justify-center univer-text-base univer-text-gray-900 dark:!univer-text-white",children:fr[k.type]}),g.jsx(Oe,{showIfEllipsis:!0,title:k.name,asChild:!0,children:g.jsx("span",{className:"univer-flex-1 univer-truncate",children:k.name})})]}),g.jsxs("div",{className:"univer-flex univer-h-6 univer-flex-none univer-flex-row univer-items-center univer-justify-center",children:[L&&g.jsx("div",{className:De("univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-flex-row univer-items-center univer-justify-center univer-rounded univer-text-base hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-700",{"univer-text-red-500":O}),onClick:()=>{if(!O){if(k.type!==C.URL){const N=new URL(window.location.href);N.hash=k.url.slice(1),navigator.clipboard.writeText(N.href)}else navigator.clipboard.writeText(k.url);s.show({content:o.t("hyperLink.message.coped"),type:be.Info})}},children:g.jsx(Oe,{placement:"bottom",title:o.t("hyperLink.popup.copy"),children:g.jsx(xi,{className:"dark:!univer-text-white"})})}),y&&g.jsxs(g.Fragment,{children:[g.jsx("div",{className:"univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-flex-row univer-items-center univer-justify-center univer-rounded univer-text-base hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-700",onClick:()=>{n.executeCommand(Mt.id,{unitId:R,subUnitId:_,row:m,col:I,customRangeId:c.rangeId,type:a})},children:g.jsx(Oe,{placement:"bottom",title:o.t("hyperLink.popup.edit"),children:g.jsx(Ti,{className:"dark:!univer-text-white"})})}),g.jsx("div",{className:"univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-flex-row univer-items-center univer-justify-center univer-rounded univer-text-base hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-700",onClick:()=>{const N=a===v.EDITING||a===v.ZEN_EDITOR?Yn.id:zn.id;n.syncExecuteCommand(N,{unitId:R,subUnitId:_,id:c.rangeId,row:m,column:I,documentId:a===v.ZEN_EDITOR?T:d.getCurrentEditorId()})&&r.hideCurrentPopup(void 0,!0)},children:g.jsx(Oe,{placement:"bottom",title:o.t("hyperLink.popup.cancel"),children:g.jsx(ki,{className:"dark:!univer-text-white"})})})]})]})]})},We=()=>{var e,t;const i=E(W),[r,n]=f.useState(null),s=E(Z);if(f.useEffect(()=>{n(i.currentPopup);const o=i.currentPopup$.subscribe(u=>{n(u)});return()=>{o.unsubscribe()}},[i.currentPopup,i.currentPopup$]),!r)return null;if(r.showAll){const o=s.getUnit(r.unitId,x.UNIVER_SHEET),u=o==null?void 0:o.getSheetBySheetId(r.subUnitId),d=u==null?void 0:u.getCell(r.row,r.col),l=(t=(e=d==null?void 0:d.p)==null?void 0:e.body)==null?void 0:t.customRanges;return l!=null&&l.length?g.jsx("div",{children:l.map(h=>g.jsx(li,{...r,customRange:h},h.rangeId))}):null}return g.jsx(li,{...r})};We.componentKey="univer.sheet.cell-link-popup";var Ir=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},ie=(e,t)=>(i,r)=>t(i,r,e);const ui=(e,t)=>{var i,r;return e.unitId===t.unitId&&e.subUnitId===t.subUnitId&&e.row===t.row&&e.col===t.col&&((i=e.customRange)==null?void 0:i.rangeId)===((r=t.customRange)==null?void 0:r.rangeId)&&e.type===t.type};let W=class extends G{constructor(e,t,i,r,n,s,o){super(),F(this,"_currentPopup",null),F(this,"_currentPopup$",new Zi),F(this,"currentPopup$",this._currentPopup$.asObservable()),F(this,"_currentEditingPopup",null),F(this,"_currentEditing$",new Gi(null)),F(this,"currentEditing$",this._currentEditing$.asObservable()),F(this,"_isKeepVisible",!1),this._sheetCanvasPopManagerService=e,this._injector=t,this._univerInstanceService=i,this._editorBridgeService=r,this._textSelectionManagerService=n,this._docCanvasPopManagerService=s,this._zenZoneService=o,this.disposeWithMe(()=>{this.hideCurrentPopup(),this.endEditing(),this._currentEditing$.complete(),this._currentPopup$.complete()})}get currentPopup(){return this._currentPopup}get currentEditing(){return this._currentEditing$.getValue()}setIsKeepVisible(e){this._isKeepVisible=e}getIsKeepVisible(){return this._isKeepVisible}showPopup(e){var t;if(this._currentPopup&&ui(e,this._currentPopup)||(this.hideCurrentPopup(void 0,!0),e.type!==v.ZEN_EDITOR&&this._zenZoneService.visible))return;const i=this._currentEditing$.getValue();if(i&&ui(e,i))return;const{unitId:r,subUnitId:n,row:s,col:o,customRangeRect:u,customRange:d}=e;let l;const h={componentKey:We.componentKey,direction:"bottom",onClickOutside:()=>{this.hideCurrentPopup()},onClick:()=>{this.hideCurrentPopup(e.type,!0)}};if(e.type===v.EDITING){if(!d)return;l=u&&this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(u,h)}else if(e.type===v.ZEN_EDITOR){if(!d)return;l=this._docCanvasPopManagerService.attachPopupToRange({startOffset:d.startIndex,endOffset:d.endIndex+1,collapsed:!1},h,T)}else if(e.showAll)l=this._sheetCanvasPopManagerService.attachPopupToCell(e.row,e.col,h,r,n);else{if(!d)return;l=u&&this._sheetCanvasPopManagerService.attachPopupByPosition(u,h,e)}l&&(this._currentPopup&&((t=this._currentPopup.disposable)==null||t.dispose()),this._currentPopup={unitId:r,subUnitId:n,disposable:l,row:s,col:o,editPermission:!!e.editPermission,copyPermission:!!e.copyPermission,customRange:d,type:e.type,showAll:e.showAll},this._currentPopup$.next(this._currentPopup))}hideCurrentPopup(e,t){var i,r;this._currentPopup&&((!e||e===this._currentPopup.type)&&this._currentPopup.disposable.canDispose()||t)&&((r=(i=this._currentPopup)==null?void 0:i.disposable)==null||r.dispose(),this._currentPopup=null,this._currentPopup$.next(null))}dispose(){super.dispose(),this.hideCurrentPopup(),this.endEditing(),this._currentPopup$.complete(),this._currentEditing$.complete()}_getEditingRange(){var e,t,i;const r=this._editorBridgeService.isVisible().visible,n=this._editorBridgeService.getEditCellState();if(r&&n){const s=this._textSelectionManagerService.getActiveTextRange(),o=(e=n.documentLayoutObject.documentModel)==null?void 0:e.getBody();if(!o)return null;if(!s||s.collapsed)return{startOffset:0,endOffset:o.dataStream.length-2,collapsed:o.dataStream.length-2===0,label:pe.transform.getPlainText(o.dataStream)};const u=pe.customRange.getCustomRangesInterestsWithSelection(s,(i=(t=o.customRanges)==null?void 0:t.filter(h=>h.rangeType===Le.HYPERLINK))!=null?i:[]);let d=s.startOffset,l=s.endOffset;return u.forEach(h=>{d=Math.min(d,h.startIndex),l=Math.max(l,h.endIndex+1)}),{startOffset:d,endOffset:l,collapsed:d===l,label:pe.transform.getPlainText(o.dataStream.slice(d,l))}}return null}get _editPopup(){return{componentKey:Fe.componentKey,direction:"vertical",onClickOutside:()=>{this.endEditing()},onContextMenu:()=>{this.endEditing()},hiddenType:"hide"}}startAddEditing(e){var t,i,r,n,s;const{unitId:o,subUnitId:u,type:d}=e;if(d===v.ZEN_EDITOR){const l=this._univerInstanceService.getUnit(T,x.UNIVER_DOC);if(!l)return;const h=this._textSelectionManagerService.getActiveTextRange();if(!h)return;this._currentEditingPopup=this._docCanvasPopManagerService.attachPopupToRange(h,this._editPopup,T);const c=(t=l.getBody())==null?void 0:t.dataStream.slice(h.startOffset,h.endOffset);this._currentEditing$.next({...e,label:c})}else if(d===v.EDITING){const l=this._getEditingRange();if(!l)return;this._textSelectionManagerService.replaceDocRanges([{...l}],{unitId:he,subUnitId:he});const h=this._injector.get(Ne).getRenderById(he);if(!h)return;const c=cn(l,h);if(!(c!=null&&c.length))return;this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(c.pop(),this._editPopup,o,u),this._currentEditing$.next({...e,label:(i=l==null?void 0:l.label)!=null?i:""})}else{this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToCell(e.row,e.col,this._editPopup,o,u);const l=this._univerInstanceService.getUnit(o,x.UNIVER_SHEET),h=l==null?void 0:l.getSheetBySheetId(u),c=h==null?void 0:h.getCellRaw(e.row,e.col);this._currentEditing$.next({...e,label:c!=null&&c.p?pe.transform.getPlainText((n=(r=c.p.body)==null?void 0:r.dataStream)!=null?n:""):((s=c==null?void 0:c.v)!=null?s:"").toString()})}}startEditing(e){var t,i,r,n,s,o;(t=this._currentEditingPopup)==null||t.dispose(),this.hideCurrentPopup(void 0,!0);const{unitId:u,subUnitId:d}=e;let l,h;if(e.type===v.ZEN_EDITOR){const c=this._univerInstanceService.getUnit(T,x.UNIVER_DOC);if(l=(r=(i=c==null?void 0:c.getBody())==null?void 0:i.customRanges)==null?void 0:r.find(m=>m.rangeId===e.customRangeId),h=l?(n=c==null?void 0:c.getBody())==null?void 0:n.dataStream.slice(l.startIndex,l.endIndex+1):"",!l||!h)return;this._textSelectionManagerService.replaceTextRanges([{startOffset:l.startIndex,endOffset:l.endIndex+1}]),this._currentEditingPopup=this._docCanvasPopManagerService.attachPopupToRange({startOffset:l.startIndex,endOffset:l.endIndex,collapsed:!1},this._editPopup,T)}else if(e.type===v.EDITING){const c=pn(this._injector,e.unitId,e.subUnitId,e.row,e.col,e.customRangeId);if(!c||!((s=c.rects)!=null&&s.length))return;l=c.customRange,h=c.label,this._textSelectionManagerService.replaceTextRanges([{startOffset:l.startIndex,endOffset:l.endIndex+1}]),this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(c.rects.pop(),this._editPopup,u,d)}else{const c=this._univerInstanceService.getUnit(u,x.UNIVER_SHEET),m=c==null?void 0:c.getSheetBySheetId(d),I=m==null?void 0:m.getCellRaw(e.row,e.col),R=c==null?void 0:c.getStyles().getStyleByCell(I),_=R==null?void 0:R.tr,y=hn(this._injector,e.unitId,e.subUnitId,e.row,e.col,e.customRangeId);if(!y||!((o=y.rects)!=null&&o.length))return;l=y.customRange,h=y.label,_?this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToCell(e.row,e.col,this._editPopup,u,d):this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupByPosition(y.rects.pop(),this._editPopup,{unitId:u,subUnitId:d,row:e.row,col:e.col})}this._currentEditing$.next({...e,customRange:l,label:h})}endEditing(e){var t;if(this.getIsKeepVisible())return;const i=this._currentEditing$.getValue();i&&(!e||e===i.type)&&((t=this._currentEditingPopup)==null||t.dispose(),this._currentEditing$.next(null))}};W=Ir([ie(0,b(Vn)),ie(1,b(st)),ie(2,Z),ie(3,J),ie(4,b(Te)),ie(5,b($n)),ie(6,ot)],W);var Re=(e=>(e[e.ALLOWED=0]="ALLOWED",e[e.DISABLED_BY_CELL=1]="DISABLED_BY_CELL",e[e.ALLOW_ON_EDITING=2]="ALLOW_ON_EDITING",e))(Re||{});const _r=new Set([mt.CHECKBOX,mt.LIST,mt.LIST_MULTIPLE]),Ut=(e,t,i,r)=>{var n,s,o,u,d;const l=t.getCell(i,r);if(l!=null&&l.f||l!=null&&l.si||(o=(s=(n=l==null?void 0:l.p)==null?void 0:n.body)==null?void 0:s.customBlocks)!=null&&o.length)return 1;const h=e.has(oi)?e.get(oi):null,c=h==null?void 0:h.getRuleByLocation(t.getUnitId(),t.getSheetId(),i,r);return c&&_r.has(c.type)?!0:(d=(u=l==null?void 0:l.p)==null?void 0:u.drawingsOrder)!=null&&d.length?2:0},yr=e=>{const t=e.get(Z).getCurrentUnitForType(x.UNIVER_SHEET);if(!t)return!0;const i=t.getActiveSheet(),r=e.get(Rt).getCurrentSelections();if(!r.length)return!0;const n=r[0].range.startRow,s=r[0].range.startColumn;return Ut(e,i,n,s)===1},Cr=e=>{const t=e.get(Te),i=e.get(Z),r=t.getTextRanges();if(!(r!=null&&r.length))return!0;const n=i.getCurrentUnitForType(x.UNIVER_DOC);return!!(!n||r.every(s=>s.collapsed)||!n.getSelfOrHeaderFooterModel(r[0].segmentId).getBody())},Mt={type:nt.OPERATION,id:"sheet.operation.open-hyper-link-edit-panel",handler(e,t){if(!t)return!1;const i=e.get(W);return t.customRangeId?i.startEditing(t):i.startAddEditing(t),!0}},Ze={type:nt.OPERATION,id:"sheet.operation.close-hyper-link-popup",handler(e){return e.get(W).endEditing(),!0}},Ot={type:nt.OPERATION,id:"sheet.operation.insert-hyper-link",handler(e){var t;const i=e.get(Z),r=bt(i),n=e.get(J);if(!r)return!1;const s=e.get(X),o=e.get(Rt).getCurrentLastSelection();if(!o)return!1;const u=o.range.startRow,d=o.range.startColumn,l=n.isVisible(),h=((t=i.getFocusedUnit())==null?void 0:t.getUnitId())===T;return s.executeCommand(Mt.id,{unitId:r.unitId,subUnitId:r.subUnitId,row:u,col:d,type:h?v.ZEN_EDITOR:l.visible?v.EDITING:v.VIEWING})}},re={type:nt.OPERATION,id:"sheet.operation.insert-hyper-link-toolbar",handler(e){if(yr(e))return!1;const t=e.get(X);return e.get(W).currentEditing?t.executeCommand(Ze.id):t.executeCommand(Ot.id)}},Ht="SHEET_HYPER_LINK_UI_PLUGIN";var Er=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},He=(e,t)=>(i,r)=>t(i,r,e);let Ge=class extends G{constructor(e,t,i,r){super(),F(this,"_plainTextFilter",new Set),F(this,"_copyInfo"),this._sheetClipboardService=e,this._hyperLinkModel=t,this._injector=i,this._resolverService=r,this._initCopyPaste(),this.disposeWithMe(()=>{this._plainTextFilter.clear()})}registerPlainTextFilter(e){this._plainTextFilter.add(e)}removePlainTextFilter(e){this._plainTextFilter.delete(e)}_filterPlainText(e){return Array.from(this._plainTextFilter).every(t=>t(e))}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:Ht,onBeforeCopy:(e,t,i)=>this._collect(e,t,i),onPasteCells:(e,t,i,r)=>{const{copyType:n=ln.COPY,pasteType:s}=r,{range:o}=e||{},{range:u,unitId:d,subUnitId:l}=t;return this._generateMutations(u,{copyType:n,pasteType:s,copyRange:o,unitId:d,subUnitId:l})},onPastePlainText:(e,t)=>{const i=this._filterPlainText(t);if(Ae(t)&&i){const{range:r,unitId:n,subUnitId:s}=e,{ranges:[o],mapFunc:u}=yt([r]),d=[],l=[];return hi.foreach(o,(h,c)=>{const{row:m,col:I}=u(h,c),R=this._hyperLinkModel.getHyperLinkByLocation(n,s,m,I);R&&d.push({id:xe.id,params:{unitId:n,subUnitId:s,id:R.id}}),R&&l.push({id:ke.id,params:{unitId:n,subUnitId:s,link:R}})}),{redos:d,undos:l}}return{undos:[],redos:[]}},priority:99})}_collect(e,t,i){const r=new Wi;this._copyInfo={unitId:e,subUnitId:t,matrix:r};const n=this._injector.invoke(u=>un(i,u,e,t));if(!n)return;const{rows:s,cols:o}=n;s.forEach((u,d)=>{o.forEach((l,h)=>{var c;const m=this._hyperLinkModel.getHyperLinkByLocation(e,t,u,l);r.setValue(d,h,(c=m==null?void 0:m.id)!=null?c:"")})})}_generateMutations(e,t){if(!this._copyInfo)return{redos:[],undos:[]};if(!this._copyInfo||!this._copyInfo.matrix.getSizeOf()||!t.copyRange)return{redos:[],undos:[]};if([Me.SPECIAL_PASTE_COL_WIDTH,Me.SPECIAL_PASTE_VALUE,Me.SPECIAL_PASTE_FORMAT,Me.SPECIAL_PASTE_FORMULA].includes(t.pasteType))return{redos:[],undos:[]};const{unitId:i,subUnitId:r}=this._copyInfo,n=[],s=[],{ranges:[o,u],mapFunc:d}=yt([t.copyRange,e]);return dn(o,u,!0).forEach(({startRange:l})=>{var h;(h=this._copyInfo)==null||h.matrix.forValue((c,m,I)=>{const R=ge.getPositionRange({startRow:c,endRow:c,startColumn:m,endColumn:m},l),_=this._hyperLinkModel.getHyperLink(i,r,I),{row:y,col:L}=d(R.startRow,R.startColumn),a=this._hyperLinkModel.getHyperLinkByLocation(t.unitId,t.subUnitId,y,L),k=St();a&&n.push({id:xe.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,id:a.id}}),_&&(n.push({id:ke.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,link:{..._,id:k,row:y,column:L}}}),s.push({id:xe.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,id:k}})),a&&s.push({id:ke.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,link:a}})})}),{redos:n,undos:s}}};Ge=Er([He(0,jn),He(1,b(lt)),He(2,b(st)),He(3,b(se))],Ge);const Vt=(e,t=T)=>{var i;const r=e.get(Z),n=(i=e.get(Ne).getRenderById(t))==null?void 0:i.with(yi);return n?n.textSelectionInner$.pipe(wt(()=>{const s=e.get(J).getEditCellState();if(!s)return!0;const o=bt(r,{unitId:s.unitId,subUnitId:s.sheetId});return!(o!=null&&o.worksheet)||Ut(e,o.worksheet,s.row,s.column)===1?!0:Cr(e)})):ne(!0)},Ui=e=>{var t;const i=e.get(Z),r=e.has(J)?e.get(J):null;return((t=r==null?void 0:r.currentEditCellState$.pipe(wt(n=>{if(!n)return Re.DISABLED_BY_CELL;const s=bt(i,{unitId:n.unitId,subUnitId:n.sheetId});return s?Ut(e,s.worksheet,n.row,n.column):Re.DISABLED_BY_CELL}),Pe(n=>{if(n===Re.DISABLED_BY_CELL)return ne(!0);const s=r?r.visible$:ne(null);return tn([s,i.getCurrentTypeOfUnit$(x.UNIVER_DOC)]).pipe(Pe(([o,u])=>o!=null&&o.visible?(u==null?void 0:u.getUnitId())===nn?ne(!0):Vt(e,he):ne(n!==Re.ALLOWED)))})))!=null?t:ne(!0)).pipe(Pe(n=>n?ne(!0):Un(e,{workbookTypes:[kt],worksheetTypes:[Pt,Ei,xt],rangeTypes:[Lt]},!0)))},Ke={commandId:Ot.id,type:Ci.BUTTON,title:"hyperLink.menu.add",icon:"LinkIcon"},Ye=e=>`${e}-zen-editor`,Sr=e=>({...Ke,id:Ke.commandId,hidden$:at(e,x.UNIVER_SHEET),disabled$:Ui(e)}),wr=e=>({...Ke,id:Ye(Ke.commandId),hidden$:at(e,x.UNIVER_DOC,T),disabled$:Vt(e)}),ze={tooltip:"hyperLink.form.addTitle",commandId:re.id,type:Ci.BUTTON,icon:"LinkIcon"},br=e=>({...ze,id:ze.commandId,hidden$:at(e,x.UNIVER_SHEET),disabled$:Ui(e)}),Rr=e=>({...ze,id:Ye(ze.commandId),hidden$:at(e,x.UNIVER_DOC,T),disabled$:Vt(e)}),Mi={id:re.id,binding:_t.K|an.CTRL_COMMAND,preconditions:on};var Lr=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},di=(e,t)=>(i,r)=>t(i,r,e);let qe=class extends G{constructor(e,t){super(),this._autoFillService=e,this._hyperLinkModel=t,this._initAutoFill()}_initAutoFill(){const e=()=>({redos:[],undos:[]}),t=(r,n)=>{const{source:s,target:o,unitId:u,subUnitId:d}=r,l=yt([s,o]),[h,c]=l.ranges,{mapFunc:m}=l,I={row:h.startRow,col:h.startColumn},R=Mn(h,c),_=[],y=[];return R.forEach(L=>{const a=L.repeatStartCell,k=L.relativeRange,O={startRow:I.row,startColumn:I.col,endColumn:I.col,endRow:I.row},N={startRow:a.row,startColumn:a.col,endColumn:a.col,endRow:a.row};hi.foreach(k,(M,Y)=>{const j=ge.getPositionRange({startRow:M,startColumn:Y,endColumn:Y,endRow:M},O),{row:ae,col:ve}=m(j.startRow,j.startColumn),me=this._hyperLinkModel.getHyperLinkByLocation(u,d,ae,ve),Q=ge.getPositionRange({startRow:M,startColumn:Y,endColumn:Y,endRow:M},N),{row:fe,col:Ie}=m(Q.startRow,Q.startColumn),_e=St(),le=this._hyperLinkModel.getHyperLinkByLocation(u,d,fe,Ie);le&&_.push({id:xe.id,params:{unitId:u,subUnitId:d,id:le.id}}),(Se.COPY===n||Se.SERIES===n)&&me&&(_.push({id:ke.id,params:{unitId:u,subUnitId:d,link:{...me,id:_e,row:fe,column:Ie}}}),y.push({id:xe.id,params:{unitId:u,subUnitId:d,id:_e}})),le&&y.push({id:ke.id,params:{unitId:u,subUnitId:d,link:le}})})}),{undos:y,redos:_}},i={id:Ht,onFillData:(r,n,s)=>s===Se.COPY||s===Se.ONLY_FORMAT||s===Se.SERIES?t(r,s):e()};this.disposeWithMe(this._autoFillService.addHook(i))}};qe=Lr([di(0,Dn),di(1,b(lt))],qe);var Pr=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},It=(e,t)=>(i,r)=>t(i,r,e);let Je=class extends G{constructor(e,t,i){super(),this._localeService=e,this._commandService=t,this._sheetPermissionCheckController=i,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{e.id===Mi.id&&(this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[kt],rangeTypes:[Lt],worksheetTypes:[Pt,Ei,xt]})||this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.hyperLinkErr")))}))}};Je=Pr([It(0,b(rt)),It(1,X),It(2,b(wi))],Je);var xr=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},A=(e,t)=>(i,r)=>t(i,r,e);let Xe=class extends G{constructor(e,t,i,r,n,s,o,u,d,l){super(),this._hoverManagerService=e,this._sheetsHyperLinkPopupService=t,this._renderManagerService=i,this._permissionService=r,this._sheetPermissionCheckController=n,this._commandService=s,this._editorBridgeService=o,this._textSelectionManagerService=u,this._univerInstanceService=d,this._zenZoneService=l,this._initHoverListener(),this._initCommandListener(),this._initHoverEditingListener(),this._initTextSelectionListener(),this._initZenEditor()}_getLinkPermission(e){const{unitId:t,subUnitId:i,row:r,col:n}=e,s=this._univerInstanceService.getUnit(t,x.UNIVER_SHEET),o=s==null?void 0:s.getSheetBySheetId(i);if(!o)return{viewPermission:!1,editPermission:!1,copyPermission:!1};const u=this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[Sn],worksheetTypes:[En],rangeTypes:[Cn]},[{startRow:r,startColumn:n,endRow:r,endColumn:n}]);let d=this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[kt],worksheetTypes:[Pt,xt],rangeTypes:[Lt]},[{startRow:r,startColumn:n,endRow:r,endColumn:n}]);const l=o.getCellRaw(r,n);l!=null&&l.f&&l.f.startsWith("=HYPERLINK(")&&(d=!1);const h=this._permissionService.composePermission([new wn(t).id,new bn(t,i).id]).every(c=>c.value);return{viewPermission:u,editPermission:d,copyPermission:h}}_initHoverListener(){this.disposeWithMe(this._hoverManagerService.currentRichText$.pipe($e(200)).subscribe(e=>{var t,i,r;if(!e||((t=e.customRange)==null?void 0:t.rangeType)!==Le.HYPERLINK){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}const{unitId:n,subUnitId:s,row:o,col:u}=e,d=this._renderManagerService.getRenderById(n);if(!d)return;const l=this._univerInstanceService.getUnit(n,x.UNIVER_SHEET),h=l==null?void 0:l.getSheetBySheetId(s);if(!h)return;if(!d.with(Rn).active){this._sheetsHyperLinkPopupService.hideCurrentPopup(v.VIEWING);return}const c=(i=d==null?void 0:d.with(ii).getSkeletonParam(s))==null?void 0:i.skeleton,m=u,I=o;let R=I,_=m;c&&c.overflowCache.forValue((M,Y,j)=>{ge.contains(j,{startColumn:m,endColumn:m,startRow:I,endRow:I})&&(R=M,_=Y)});const{viewPermission:y,editPermission:L,copyPermission:a}=this._getLinkPermission(e);if(!y){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}const k=h.getCellStyleOnly(R,_),O=l.getStyles().getStyleByCell(k),N=(r=O==null?void 0:O.tr)==null?void 0:r.a;if(!N&&!e.customRange){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}this._sheetsHyperLinkPopupService.showPopup({row:R,col:_,editPermission:L,copyPermission:a,customRange:e.customRange,customRangeRect:e.rect,type:v.VIEWING,unitId:n,subUnitId:s,showAll:!!N})}))}_initHoverEditingListener(){let e=null;this.disposeWithMe(this._editorBridgeService.currentEditCellState$.pipe(Pe(t=>this._editorBridgeService.visible$.pipe(wt(i=>({visible:i,state:t}))))).subscribe(({visible:t,state:i})=>{if(!i||i.editorUnitId!==he)return;if(!t.visible){e==null||e.unsubscribe(),this._sheetsHyperLinkPopupService.hideCurrentPopup(v.EDITING),this._sheetsHyperLinkPopupService.endEditing(v.EDITING);return}const{editorUnitId:r,unitId:n,sheetId:s,row:o,column:u}=i,d=this._renderManagerService.getRenderById(r);if(!d)return;const{editPermission:l,viewPermission:h,copyPermission:c}=this._getLinkPermission({unitId:n,subUnitId:s,row:o,col:u}),m=d.with(ni);h&&(e==null||e.unsubscribe(),e=m.hoverCustomRanges$.pipe($e(200)).subscribe(I=>{var R,_;const y=I.find(k=>k.range.rangeType===Le.HYPERLINK);if(!y){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}const L=y.rects[y.rects.length-1];if(!((_=(R=this._renderManagerService.getRenderById(n))==null?void 0:R.with(ii).getSkeletonParam(s))!=null&&_.skeleton)||!L)return;const a=d.engine.getCanvasElement().getBoundingClientRect();this._sheetsHyperLinkPopupService.showPopup({unitId:n,subUnitId:s,row:o,col:u,customRange:y.range,customRangeRect:{left:L.left+a.left,top:L.top+a.top,bottom:L.bottom+a.top,right:L.right+a.left},editPermission:l,copyPermission:c,type:v.EDITING})}))})),this.disposeWithMe(()=>{e==null||e.unsubscribe()})}_initZenEditor(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e?(this._sheetsHyperLinkPopupService.hideCurrentPopup(v.VIEWING),this._sheetsHyperLinkPopupService.hideCurrentPopup(v.EDITING),this._sheetsHyperLinkPopupService.endEditing(v.EDITING),this._sheetsHyperLinkPopupService.hideCurrentPopup(v.VIEWING)):(this._sheetsHyperLinkPopupService.hideCurrentPopup(v.ZEN_EDITOR),this._sheetsHyperLinkPopupService.endEditing(v.ZEN_EDITOR))})),this.disposeWithMe(this._univerInstanceService.focused$.pipe(Pe(e=>{const t=e===T?this._renderManagerService.getRenderById(e):null;return t?t.with(ni).hoverCustomRanges$.pipe($e(200)):new en(i=>{i.next(null)})})).subscribe(e=>{const t=e==null?void 0:e.find(r=>r.range.rangeType===Le.HYPERLINK),i=this._editorBridgeService.getEditCellState();if(t&&i){const{unitId:r,sheetId:n,row:s,column:o}=i,{editPermission:u,viewPermission:d,copyPermission:l}=this._getLinkPermission({unitId:r,subUnitId:n,row:s,col:o});d&&this._sheetsHyperLinkPopupService.showPopup({type:v.ZEN_EDITOR,unitId:r,subUnitId:n,row:s,col:o,customRange:t.range,editPermission:u,copyPermission:l})}else this._sheetsHyperLinkPopupService.hideCurrentPopup(v.ZEN_EDITOR)}))}_initTextSelectionListener(){this.disposeWithMe(this._textSelectionManagerService.textSelection$.subscribe(e=>{e&&e.unitId===he&&this._sheetsHyperLinkPopupService.endEditing(v.EDITING)}))}_initCommandListener(){const e=[Ln.id,Pn.id,xn.id];this.disposeWithMe(this._commandService.onCommandExecuted(t=>{e.includes(t.id)&&this._sheetsHyperLinkPopupService.hideCurrentPopup()}))}};Xe=xr([A(0,b(Bn)),A(1,b(W)),A(2,b(Ne)),A(3,b(sn)),A(4,b(wi)),A(5,X),A(6,J),A(7,b(Te)),A(8,Z),A(9,ot)],Xe);var Oi=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},Ct=(e,t)=>(i,r)=>t(i,r,e);let Et=class extends G{constructor(e,t){super(),this._context=e,this._hyperLinkModel=t,this._initSkeletonChange()}_initSkeletonChange(){const e=()=>{var t;(t=this._context.mainComponent)==null||t.makeForceDirty()};this.disposeWithMe(this._hyperLinkModel.linkUpdate$.pipe($e(16)).subscribe(()=>{e()}))}};Et=Oi([Ct(1,b(lt))],Et);let Qe=class extends G{constructor(e,t){super(),this._sheetInterceptorService=e,this._hyperLinkModel=t,this._initViewModelIntercept()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(yn.CELL_CONTENT,{effect:Qi.Value,priority:100,handler:(e,t,i)=>{const{row:r,col:n,unitId:s,subUnitId:o}=t,u=this._hyperLinkModel.getHyperLinkByLocation(s,o,r,n);return u&&e&&(e===t.rawData&&(e={...t.rawData}),e.linkUrl=u.payload,e.linkId=u.id),i(e)}}))}};Qe=Oi([Ct(0,b(An)),Ct(1,b(lt))],Qe);const kr={[Nn.MEDIA]:{[re.id]:{order:1,menuItemFactory:br},[Ye(re.id)]:{order:1,menuItemFactory:Rr}},[kn.MAIN_AREA]:{[Tn.OTHERS]:{order:1,[re.id]:{order:0,menuItemFactory:Sr},[Ye(re.id)]:{order:0,menuItemFactory:wr}}}};var Tr=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},we=(e,t)=>(i,r)=>t(i,r,e);let et=class extends G{constructor(e,t,i,r,n){super(),this._componentManager=e,this._commandService=t,this._menuManagerService=i,this._injector=r,this._shortcutService=n,this._initComponents(),this._initCommands(),this._initMenus(),this._initShortCut()}_initComponents(){[[We.componentKey,We],[Fe.componentKey,Fe],["LinkIcon",Nt]].forEach(([e,t])=>{this._componentManager.register(e,t)})}_initCommands(){[Mt,Ze,Ot,re].forEach(e=>{this._commandService.registerCommand(e)})}_initMenus(){this._menuManagerService.mergeMenu(kr)}_initShortCut(){this._shortcutService.registerShortcut(Mi)}};et=Tr([we(0,b(Fn)),we(1,X),we(2,Wn),we(3,b(st)),we(4,b(Zn))],et);var Nr=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},ci=(e,t)=>(i,r)=>t(i,r,e);let tt=class extends G{constructor(e,t){super(),this._parserService=e,this._resolverService=t,this._handleInitUrl()}_handleInitUrl(){const e=location.hash;if(e){const t=this._parserService.parseHyperLink(e);this._resolverService.navigate(t)}}};tt=Nr([ci(0,b(Tt)),ci(1,b(se))],tt);var Ur=Object.defineProperty,Mr=(e,t,i)=>t in e?Ur(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Or=(e,t,i,r)=>{for(var n=t,s=e.length-1,o;s>=0;s--)(o=e[s])&&(n=o(n)||n);return n},pi=(e,t)=>(i,r)=>t(i,r,e),Hi=(e,t,i)=>Mr(e,typeof t!="symbol"?t+"":t,i);let it=class extends Ki{constructor(e=ai,t,i){super(),this._config=e,this._injector=t,this._configService=i;const{menu:r,...n}=Yi({},ai,this._config);r&&this._configService.setConfig("menu",r,{merge:!0}),this._configService.setConfig(Ri,n)}onStarting(){[[se],[W],[Li],[Qe],[Xe],[et],[qe],[Ge],[Je],[tt]].forEach(e=>this._injector.add(e)),this._injector.get(Qe)}onReady(){this._injector.get(Ne).registerRenderModule(x.UNIVER_SHEET,[Et]),this._injector.get(qe),this._injector.get(Ge),this._injector.get(et)}onRendered(){this._injector.get(Je),this._injector.get(tt),this._injector.get(Xe)}};Hi(it,"pluginName",Ht);Hi(it,"type",x.UNIVER_SHEET);it=Or([rn(er,Hn),pi(1,b(st)),pi(2,vi)],it);export{Mt as A,Mi as F,Li as U,Ot as V,Ze as X,W as Z,it as a,se as c,Ge as q};
