import{M as R,aT as Tt,V as D,a6 as Pt,W as te,a5 as q,d as Et,c as Ye,e as Ke,af as ie,F as oe,O as Qe,o as Je,am as Y,c1 as we,dk as Ze,b as Nt,w as ke,L as E,v as K,I as M,u as W,x as Xe,ab as At,n as X,l as _e,m as Ot,d1 as Dt,U as Wt,e9 as Pe,ea as jt,ai as Bt,J as Lt,eb as Ht,S as Vt,q as qt,y as Gt}from"./TeamSpreadsheet-DqPQXi__.js";import{I as U,t8 as Ee,tb as et,rU as zt,v as tt,s2 as O,d as y,g as it,t6 as V,tg as Yt,f as Kt,B as Qt,H as Jt,gh as nt,sU as Zt,n as Xt,R as ei,r as ti,k as ii,S as st,u as ni,kO as si,qG as Ne,qP as ai,lF as ri,po as oi,gD as ci,gj as li,lG as hi,lr as di,a6 as Ae,M as at,z as ui}from"./index--BQDx9CP.js";import{r as f,m as ee,j as u,ab as T,V as rt,L as me,ag as Oe,e as De,v as ve,ah as gi,I as ot}from"./facade-DLk4o3Z_.js";import{k as fi}from"./facade-DJ8otAmv.js";import"./index-mJOBftNs.js";import"./VRow-C6N6h8s9.js";import"./VCard-DFIDGoOa.js";import"./VSelect-CO5xudFf.js";import"./VTextField-tFIcna6m.js";import"./VTabs-BYSgCciz.js";import"./VAlert-CfJUBCCM.js";import"./VDialog-C4Wnh1zS.js";import"./VFileInput-DBMVcNlc.js";import"./VTextarea-34QBZFhW.js";var pi=Object.defineProperty,_i=(t,e,i)=>e in t?pi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,g=(t,e,i)=>_i(t,typeof e!="symbol"?e+"":e,i);const ct="FIND_REPLACE_INPUT_FOCUS",lt="FIND_REPLACE_DIALOG_FOCUS",ht="FIND_REPLACE_REPLACE_REVEALED";var dt=(t,e,i,n)=>{for(var s=e,a=t.length-1,r;a>=0;a--)(r=t[a])&&(s=r(s)||s);return s},ne=(t,e)=>(i,n)=>e(i,n,t);class mi extends D{}const b=Tt("find-replace.service");function vi(t){return typeof t.findString<"u"||typeof t.inputtingFindString<"u"||typeof t.findDirection<"u"||typeof t.matchesTheWholeCell<"u"||typeof t.caseSensitive<"u"||typeof t.findScope<"u"||typeof t.findBy<"u"}let se=class extends D{constructor(e,i,n,s){super(),g(this,"currentMatch$",new q(null)),g(this,"replaceables$",new q([])),g(this,"_findModels",[]),g(this,"_matchingModel",null),g(this,"_matches",[]),g(this,"_currentSearchingDisposables",null),this._state=e,this._providers=i,this._univerInstanceService=n,this._commandService=s,this.disposeWithMe(this._state.stateUpdates$.pipe(et(200,void 0,{leading:!0,trailing:!0})).subscribe(async a=>{const r=this._state.state;vi(a)&&(r.findString!==""&&!r.replaceRevealed?(await this._startSearching(),this._state.changeState({findCompleted:!0})):a.replaceRevealed!==!0&&this._stopSearching())}))}get searched(){return this._findModels.length>0}dispose(){super.dispose(),this._stopSearching(),this.currentMatch$.complete(),this.replaceables$.complete(),this._state.changeState({...ce(),revealed:!1})}async start(){if(!this._state.findString)return{results:[]};const e=await this._startSearching();return this._state.changeState({findCompleted:!0}),e}focusSelection(){var e;(e=this._matchingModel)==null||e.focusSelection()}async _startSearching(){if(!this._state.findString)return{results:[]};const e=Array.from(this._providers),i=this._findModels=(await Promise.all(e.map(s=>s.find({findString:this._state.findString,findDirection:this._state.findDirection,findScope:this._state.findScope,findBy:this._state.findBy,replaceRevealed:this._state.replaceRevealed,caseSensitive:this._state.caseSensitive,matchesTheWholeCell:this._state.matchesTheWholeCell})))).flat();this._subscribeToModelsChanges(i);const n=this._matches=i.map(s=>s.getMatches()).flat();return this.replaceables$.next(n.filter(s=>s.replaceable)),n.length?(this._moveToInitialMatch(i),this._state.changeState({matchesCount:n.length}),{results:n}):(this._state.changeState({matchesCount:0,matchesPosition:0}),{results:[]})}_stopSearching(){var e;this._providers.forEach(i=>i.terminate()),this._findModels=[],this._matches=[],this._matchingModel=null,(e=this._currentSearchingDisposables)==null||e.dispose(),this._currentSearchingDisposables=null,this.currentMatch$.next(null),this.replaceables$.next([]),this._state.changeState({findCompleted:!1,matchesCount:0,matchesPosition:0})}_subscribeToModelsChanges(e){const i=this._currentSearchingDisposables=new Et,n=Ye(e.map(s=>s.matchesUpdate$)).pipe(Ke(220)).subscribe(([...s])=>{const a=this._matches=s.flat();a.length?(this._moveToInitialMatch(this._findModels,!0),this._state.changeState({matchesCount:a.length}),this.replaceables$.next(a.filter(r=>r.replaceable))):(this._state.changeState({matchesCount:0,matchesPosition:0}),this.replaceables$.next([]))});e.forEach(s=>i.add(te(s.activelyChangingMatch$.subscribe(a=>{const r=this._matches.findIndex(o=>o===a);this._state.changeState({matchesPosition:r+1})})))),i.add(te(n))}async replace(){return this._matchingModel?this._matchingModel.replace(this._state.replaceString):!1}async replaceAll(){const e=await Promise.all(this._findModels.map(i=>i.replaceAll(this._state.replaceString))).then(i=>i.reduce((n,s)=>(n.success+=s.success,n.failure+=s.failure,n),{success:0,failure:0}));return e.failure===0&&this._stopSearching(),e}getCurrentMatch(){return this._state.matchesPosition>0?this._matches[this._state.matchesPosition-1]:null}_markMatch(e){const i=this._matches.findIndex(n=>n===e);this.currentMatch$.next(e),this._state.changeState({matchesPosition:i+1})}moveToNextMatch(){if(!this._matchingModel)return;const e=this._findModels.length===1,i=this._matchingModel.moveToNextMatch({loop:e});if(i)return this._markMatch(i),i;{const n=this._findModels.findIndex(s=>s===this._matchingModel);return this._moveToNextUnitMatch(n)}}_moveToNextUnitMatch(e){const i=this._findModels.length;for(let n=(e+1)%i;n!==e;){const s=this._findModels[n],a=s.moveToNextMatch({ignoreSelection:!0});if(a)return this._matchingModel=s,this._markMatch(a),a;n=(n+1)%i}if(this._matchingModel){const n=this._matchingModel.moveToNextMatch({ignoreSelection:!0});return n&&this._markMatch(n),n}}moveToPreviousMatch(){if(!this._matchingModel)return;const e=this._findModels.length===1,i=this._matchingModel.moveToPreviousMatch({loop:e});if(i){const n=this._matches.findIndex(s=>s===i);return this.currentMatch$.next(i),this._state.changeState({matchesPosition:n+1}),i}else{const n=this._findModels.length,s=this._findModels.findIndex(r=>r===this._matchingModel);for(let r=(s-1+n)%n;r!==s;){const o=this._findModels[r],c=o.moveToPreviousMatch({ignoreSelection:!0});if(c)return this._matchingModel=o,this._markMatch(c),c;r=(r-1)%n}const a=this._matchingModel.moveToPreviousMatch({ignoreSelection:!0});return a&&this._markMatch(a),a}}_moveToInitialMatch(e,i=!1){var n;const s=(n=this._univerInstanceService.getFocusedUnit())==null?void 0:n.getUnitId();if(!s)return-1;const a=e.findIndex(r=>r.unitId===s);if(a!==-1){this._matchingModel=e[a];const r=this._matchingModel.moveToNextMatch({stayIfOnMatch:!0,noFocus:i});if(r)return this._markMatch(r),a}return this._moveToNextUnitMatch(a),0}};se=dt([ne(2,K),ne(3,E)],se);var P=(t=>(t.ROW="row",t.COLUMN="column",t))(P||{}),$=(t=>(t.VALUE="value",t.FORMULA="formula",t))($||{}),k=(t=>(t.SUBUNIT="subunit",t.UNIT="unit",t))(k||{});function ce(){return{caseSensitive:!1,findBy:"value",findCompleted:!1,findDirection:"row",findScope:"subunit",findString:"",inputtingFindString:"",matchesCount:0,matchesPosition:0,matchesTheWholeCell:!1,replaceRevealed:!1,replaceString:"",revealed:!0}}class ut{constructor(){g(this,"_stateUpdates$",new ie),g(this,"stateUpdates$",this._stateUpdates$.asObservable()),g(this,"_state$",new q(ce())),g(this,"state$",this._state$.asObservable()),g(this,"_findString",""),g(this,"_inputtingFindString",""),g(this,"_replaceString",""),g(this,"_revealed",!1),g(this,"_replaceRevealed",!1),g(this,"_matchesPosition",0),g(this,"_matchesCount",0),g(this,"_caseSensitive",!0),g(this,"_matchesTheWholeCell",!1),g(this,"_findDirection","row"),g(this,"_findScope","subunit"),g(this,"_findBy","value"),g(this,"_findCompleted",!1)}get state(){return this._state$.getValue()}get inputtingFindString(){return this._inputtingFindString}get findString(){return this._findString}get revealed(){return this._revealed}get replaceRevealed(){return this._replaceRevealed}get matchesPosition(){return this._matchesPosition}get matchesCount(){return this._matchesCount}get replaceString(){return this._replaceString}get caseSensitive(){return this._caseSensitive}get matchesTheWholeCell(){return this._matchesTheWholeCell}get findDirection(){return this._findDirection}get findScope(){return this._findScope}get findBy(){return this._findBy}get findCompleted(){return this._findCompleted}changeState(e){let i=!1;const n={};typeof e.findString<"u"&&e.findString!==this._findString&&(this._findString=e.findString,n.findString=this._findString,i=!0),typeof e.revealed<"u"&&e.revealed!==this._revealed&&(this._revealed=e.revealed,n.revealed=e.revealed,i=!0),typeof e.replaceRevealed<"u"&&e.replaceRevealed!==this._replaceRevealed&&(this._replaceRevealed=e.replaceRevealed,n.replaceRevealed=e.replaceRevealed,i=!0),typeof e.replaceString<"u"&&e.replaceString!==this._replaceString&&(this._replaceString=e.replaceString,n.replaceString=e.replaceString,i=!0),typeof e.matchesCount<"u"&&e.matchesCount!==this._matchesCount&&(this._matchesCount=e.matchesCount,n.matchesCount=e.matchesCount,i=!0),typeof e.matchesPosition<"u"&&e.matchesPosition!==this._matchesPosition&&(this._matchesPosition=e.matchesPosition,n.matchesPosition=e.matchesPosition,i=!0),typeof e.findBy<"u"&&e.findBy!==this._findBy&&(this._findBy=e.findBy,n.findBy=e.findBy,i=!0),typeof e.findScope<"u"&&e.findScope!==this._findScope&&(this._findScope=e.findScope,n.findScope=e.findScope,i=!0),typeof e.findDirection<"u"&&e.findDirection!==this._findDirection&&(this._findDirection=e.findDirection,n.findDirection=e.findDirection,i=!0),typeof e.caseSensitive<"u"&&e.caseSensitive!==this._caseSensitive&&(this._caseSensitive=e.caseSensitive,n.caseSensitive=e.caseSensitive,i=!0),typeof e.matchesTheWholeCell<"u"&&e.matchesTheWholeCell!==this._matchesTheWholeCell&&(this._matchesTheWholeCell=e.matchesTheWholeCell,n.matchesTheWholeCell=e.matchesTheWholeCell,i=!0),typeof e.inputtingFindString<"u"&&e.inputtingFindString!==this._inputtingFindString&&(this._inputtingFindString=e.inputtingFindString,n.inputtingFindString=e.inputtingFindString,i=!0),typeof e.findCompleted<"u"&&e.findCompleted!==this._findCompleted&&(this._findCompleted=e.findCompleted,n.findCompleted=e.findCompleted,i=!0),i&&(this._state$.next({caseSensitive:this._caseSensitive,findBy:this._findBy,findCompleted:this._findCompleted,findDirection:this._findDirection,findScope:this._findScope,findString:this._findString,inputtingFindString:this._inputtingFindString,matchesCount:this._matchesCount,matchesPosition:this._matchesPosition,matchesTheWholeCell:this._matchesTheWholeCell,replaceRevealed:this._replaceRevealed,revealed:this._revealed}),this._stateUpdates$.next(n))}}let ye=class extends D{constructor(e,i){super(),g(this,"_providers",new Set),g(this,"_state",new ut),g(this,"_model"),g(this,"_currentMatch$",new q(null)),g(this,"currentMatch$",this._currentMatch$.asObservable()),g(this,"_replaceables$",new q([])),g(this,"replaceables$",this._replaceables$.asObservable()),g(this,"_focusSignal$",new ie),g(this,"focusSignal$",this._focusSignal$.asObservable()),this._injector=e,this._contextService=i}get stateUpdates$(){return this._state.stateUpdates$}get state$(){return this._state.state$}get revealed(){return this._state.revealed}get replaceRevealed(){return this._state.replaceRevealed}dispose(){super.dispose(),this._currentMatch$.next(null),this._currentMatch$.complete(),this._replaceables$.next([]),this._replaceables$.complete(),this._focusSignal$.complete()}getProviders(){return this._providers}getCurrentMatch(){var e;return(e=this._model)==null?void 0:e.getCurrentMatch()}getFindString(){return this._state.findString}changeFindString(e){this._state.changeState({findString:e})}focusFindInput(){this._focusSignal$.next()}changeInputtingFindString(e){e?this._state.changeState({inputtingFindString:e}):this._state.changeState({inputtingFindString:"",findString:""})}changeReplaceString(e){this._state.changeState({replaceString:e})}changeMatchesTheWholeCell(e){this._state.changeState({matchesTheWholeCell:e})}changeCaseSensitive(e){this._state.changeState({caseSensitive:e})}changeFindBy(e){this._state.changeState({findBy:e}),this._toggleDisplayRawFormula(e==="formula")}changeFindScope(e){this._state.changeState({findScope:e})}changeFindDirection(e){this._state.changeState({findDirection:e})}moveToNextMatch(){this._model&&(this._state.replaceRevealed&&!this._model.searched?(this._state.changeState({findString:this._state.inputtingFindString}),this._model.start()):this._model.moveToNextMatch(),this._focusSignal$.next())}moveToPreviousMatch(){this._model&&(this._state.replaceRevealed&&!this._model.searched?(this._state.changeState({findString:this._state.inputtingFindString}),this._model.start()):this._model.moveToPreviousMatch(),this._focusSignal$.next())}async replace(){return this._model?this._model.replace():!1}async replaceAll(){if(!this._model)throw new Error("[FindReplaceService] replaceAll: model is not initialized!");return this._model.replaceAll()}revealReplace(){this._state.changeState({replaceRevealed:!0,inputtingFindString:this._state.findString}),this._toggleRevealReplace(!0)}focusSelection(){var e;(e=this._model)==null||e.focusSelection()}start(e=!1){if(this._providers.size===0)return!1;this._model=this._injector.createInstance(se,this._state,this._providers),this._model.currentMatch$.subscribe(n=>this._currentMatch$.next(n)),this._model.replaceables$.subscribe(n=>this._replaceables$.next(n));const i=ce();return e&&(i.replaceRevealed=!0),this._state.changeState(i),this._toggleRevealReplace(e),!0}find(){var e;(e=this._model)==null||e.start()}terminate(){var e;(e=this._model)==null||e.dispose(),this._model=null,this._toggleDisplayRawFormula(!1),this._toggleRevealReplace(!1)}registerFindReplaceProvider(e){return this._providers.add(e),te(()=>this._providers.delete(e))}_toggleRevealReplace(e){this._contextService.setContextValue(ht,e)}_toggleDisplayRawFormula(e){this._contextService.setContextValue(nt,e)}};ye=dt([ne(0,M(W)),ne(1,Y)],ye);const gt={id:"ui.command.replace-current-match",type:R.COMMAND,handler:t=>t.get(b).replace()},Si="CONFIRM_REPLACE_ALL",ft={id:"ui.command.replace-all-matches",type:R.COMMAND,handler:async t=>{const e=t.get(zt),i=t.get(oe),n=t.get(tt);if(!await e.confirm({id:Si,title:{title:i.t("find-replace.replace.confirm.title")},cancelText:i.t("button.cancel"),confirmText:i.t("button.confirm")}))return!1;const s=await t.get(b).replaceAll(),{success:a,failure:r}=s;return r>0?(a===0?n.show({type:ee.Error,content:i.t("find-replace.replace.all-failure")}):n.show({type:ee.Warning,content:i.t("find-replace.replace.partial-success",`${a}`,`${r}`)}),!1):(n.show({type:ee.Success,content:i.t("find-replace.replace.all-success",`${a}`)}),!0)}},Q={id:"ui.operation.open-find-dialog",type:R.OPERATION,handler:t=>{const e=t.get(b);return e.revealed?e.focusFindInput():e.start(),!0}},$e={id:"ui.operation.open-replace-dialog",type:R.OPERATION,handler:t=>{const e=t.get(b);return e.revealed?e.replaceRevealed?e.focusFindInput():e.revealReplace():e.start(!0),!0}},pt={type:R.OPERATION,id:"ui.operation.go-to-next-match",handler:t=>(t.get(b).moveToNextMatch(),!0)},_t={type:R.OPERATION,id:"ui.operation.go-to-previous-match",handler:t=>(t.get(b).moveToPreviousMatch(),!0)},mt={type:R.OPERATION,id:"ui.operation.focus-selection",handler:t=>(t.get(b).focusSelection(),!0)};function vt({ref:t,...e}){const{icon:i,id:n,className:s,extend:a,...r}=e,o=`univerjs-icon univerjs-icon-${n} ${s||""}`.trim(),c=f.useRef(`_${Mi()}`);return St(i,`${n}`,{defIds:i.defIds,idSuffix:c.current},{ref:t,className:o,...r},a)}function St(t,e,i,n,s){return f.createElement(t.tag,{key:e,...Ci(t,i,s),...n},(bi(t,i).children||[]).map((a,r)=>St(a,`${e}-${t.tag}-${r}`,i,void 0,s)))}function Ci(t,e,i){const n={...t.attrs};i!=null&&i.colorChannel1&&n.fill==="colorChannel1"&&(n.fill=i.colorChannel1),t.tag==="mask"&&n.id&&(n.id=n.id+e.idSuffix),Object.entries(n).forEach(([a,r])=>{a==="mask"&&typeof r=="string"&&(n[a]=r.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))});const{defIds:s}=e;return!s||s.length===0||(t.tag==="use"&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+e.idSuffix),Object.entries(n).forEach(([a,r])=>{typeof r=="string"&&(n[a]=r.replace(/url\(#(.*)\)/,`url(#$1${e.idSuffix})`))})),n}function bi(t,e){var i;const{defIds:n}=e;return!n||n.length===0?t:t.tag==="defs"&&(i=t.children)!=null&&i.length?{...t,children:t.children.map(s=>typeof s.attrs.id=="string"&&n&&n.includes(s.attrs.id)?{...s,attrs:{...s.attrs,id:s.attrs.id+e.idSuffix}}:s)}:t}function Mi(){return Math.random().toString(36).substring(2,8)}vt.displayName="UniverIcon";const yi={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.71899 1.36938C4.37604 1.36938 1.66602 4.07941 1.66602 7.42236C1.66602 10.7653 4.37604 13.4753 7.71899 13.4753C9.16744 13.4753 10.4971 12.9666 11.5389 12.118L13.6598 14.4109C13.8848 14.6542 14.2644 14.669 14.5077 14.444C14.7509 14.219 14.7657 13.8393 14.5407 13.5961L12.3906 11.2716C13.2536 10.2254 13.772 8.88442 13.772 7.42236C13.772 4.07941 11.0619 1.36938 7.71899 1.36938ZM2.86602 7.42236C2.86602 4.74215 5.03878 2.56938 7.71899 2.56938C10.3992 2.56938 12.572 4.74215 12.572 7.42236C12.572 10.1026 10.3992 12.2753 7.71899 12.2753C5.03878 12.2753 2.86602 10.1026 2.86602 7.42236Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ct=f.forwardRef(function(t,e){return f.createElement(vt,Object.assign({},t,{id:"search-icon",ref:e,icon:yi}))});Ct.displayName="SearchIcon";function bt(t){const{findCompleted:e,localeService:i,matchesCount:n,matchesPosition:s,initialFindString:a,findReplaceService:r,onChange:o,...c}=t,[h,l]=f.useState(a),d=e&&n===0?i.t("find-replace.dialog.no-result"):n===0?" ":void 0;function p(_){s===n&&_===1?r.moveToNextMatch():s===1&&_===n||_<s?r.moveToPreviousMatch():r.moveToNextMatch()}return u.jsx("div",{className:"univer-relative univer-flex univer-items-center univer-gap-2",onDrag:_=>_.stopPropagation(),children:u.jsx(rt,{"data-u-comp":"search-input",autoFocus:!0,placeholder:i.t("find-replace.dialog.find-placeholder"),value:h,onChange:_=>{l(_),o==null||o(_)},slot:u.jsx(gi,{loop:!0,text:d,value:s,total:n,onChange:p}),...c})})}function Mt(t,e){const i=f.useCallback(()=>{var s;(s=document.querySelector(".univer-find-input input"))==null||s.focus()},[]),n=f.useCallback(()=>{const s=document.querySelectorAll("[data-u-comp=find-replace-dialog] [data-u-comp=search-input]");return Array.from(s).some(a=>a===document.activeElement)},[]);return f.useImperativeHandle(e,()=>({focus:i,selectHasFocus:n})),f.useEffect(()=>{const s=t.focusSignal$.subscribe(()=>i());return()=>s.unsubscribe()},[t,i]),{focus:i,selectHasFocus:n}}const Ri=f.forwardRef(function(t,e){const i=y(oe),n=y(b),s=y(E),a=V(n.state$,void 0,!0),{findCompleted:r,findString:o,matchesCount:c,matchesPosition:h}=a,l=f.useCallback(()=>{s.executeCommand($e.id)},[s]),d=Zt(p=>n.changeFindString(p),500);return Mt(n,e),u.jsxs(u.Fragment,{children:[u.jsx(bt,{findCompleted:r,matchesCount:c,matchesPosition:h,findReplaceService:n,localeService:i,initialFindString:o,onChange:d}),u.jsx("div",{className:"univer-mt-4 univer-text-center",children:u.jsx("a",{className:"hover:univer-text-primary-500/80 univer-cursor-pointer univer-text-sm univer-text-primary-500 univer-transition-colors",onClick:l,children:i.t("find-replace.dialog.advanced-finding")})})]})}),xi=f.forwardRef(function(t,e){const i=y(b),n=y(oe),s=y(E),a=y(tt),r=V(i.currentMatch$,void 0,!0),o=V(i.replaceables$,void 0,!0),c=V(i.state$,void 0,!0),{matchesCount:h,matchesPosition:l,findString:d,inputtingFindString:p,replaceString:_,caseSensitive:F,matchesTheWholeCell:x,findDirection:N,findScope:B,findBy:le,findCompleted:A}=c,Z=p.length===0,he=h===0||!(r!=null&&r.replaceable),de=o.length===0,L=f.useCallback(S=>i.changeInputtingFindString(S),[i]),H=f.useCallback(S=>i.changeReplaceString(S),[i]),{focus:ue}=Mt(i,e),ge=f.useCallback(()=>{d===p?i.moveToNextMatch():(i.changeFindString(p),i.find())},[d,p,i]),fe=f.useCallback(()=>s.executeCommand(gt.id),[s]),pe=f.useCallback(async()=>{await s.executeCommand(ft.id),ue()},[s]),I=f.useCallback(S=>{i.changeFindDirection(S)},[i]),wt=f.useCallback(S=>{i.changeFindScope(S)},[i]),kt=f.useCallback(S=>{i.changeFindBy(S)},[i]),$t=wi(n),Ft=ki(n),Ut=$i(n);return f.useEffect(()=>{A&&h===0&&a.show({content:n.t("find-replace.dialog.no-match"),type:ee.Warning,duration:5e3})},[A,h,a,n]),u.jsxs("div",{children:[u.jsx(T,{label:n.t("find-replace.dialog.find"),children:u.jsx(bt,{findCompleted:A,className:"univer-find-input",matchesCount:h,matchesPosition:l,findReplaceService:i,localeService:n,initialFindString:p,onChange:L})}),u.jsx(T,{label:n.t("find-replace.dialog.replace"),children:u.jsx(rt,{placeholder:n.t("find-replace.dialog.replace-placeholder"),value:_,onChange:S=>H(S)})}),u.jsx(T,{label:n.t("find-replace.dialog.find-direction.title"),children:u.jsx(me,{value:N,options:Ft,onChange:I})}),u.jsx(Oe,{children:u.jsxs(u.Fragment,{children:[u.jsx(T,{label:n.t("find-replace.dialog.find-scope.title"),children:u.jsx(me,{value:B,options:$t,onChange:wt})}),u.jsx(T,{label:n.t("find-replace.dialog.find-by.title"),children:u.jsx(me,{value:le,options:Ut,onChange:kt})})]})}),u.jsx(Oe,{children:u.jsxs(u.Fragment,{children:[u.jsx(T,{children:u.jsx(De,{checked:F,onChange:S=>{i.changeCaseSensitive(S)},children:n.t("find-replace.dialog.case-sensitive")})}),u.jsx(T,{children:u.jsx(De,{checked:x,onChange:S=>{i.changeMatchesTheWholeCell(S)},children:n.t("find-replace.dialog.match-the-whole-cell")})})]})}),u.jsxs("div",{className:"univer-mt-6 univer-flex univer-justify-between",children:[u.jsx(ve,{variant:"primary",onClick:ge,disabled:Z,children:n.t("find-replace.dialog.find")}),u.jsxs("span",{className:"univer-inline-flex univer-gap-2",children:[u.jsx(ve,{disabled:he,onClick:fe,children:n.t("find-replace.dialog.replace")}),u.jsx(ve,{disabled:de,onClick:pe,children:n.t("find-replace.dialog.replace-all")})]})]})]})});function Ii(){const t=y(b),e=y(it),i=y(Y),n=V(t.state$,void 0,!0),s=f.useRef(null);f.useEffect(()=>{let c;return s.current&&(c=e.registerContainerElement(s.current)),()=>c==null?void 0:c.dispose()},[e]);const a=f.useRef(null),r=f.useCallback(c=>i.setContextValue(lt,c),[i]),o=f.useCallback(c=>i.setContextValue(ct,c),[i]);return f.useEffect(()=>{var c;const h=Yt(document,"focusin").subscribe(l=>{var d;l.target&&(d=s.current)!=null&&d.contains(l.target)?r(!0):r(!1),!a.current||!a.current.selectHasFocus()?o(!1):o(!0)});return(c=a.current)==null||c.focus(),r(!0),o(!0),()=>{h.unsubscribe(),r(!1)}},[r,o]),u.jsx("div",{ref:s,"data-u-comp":"find-replace-dialog",children:n.replaceRevealed?u.jsx(xi,{ref:a}):u.jsx(Ri,{ref:a})})}function wi(t){const e=t.getCurrentLocale();return f.useMemo(()=>[{label:t.t("find-replace.dialog.find-scope.current-sheet"),value:k.SUBUNIT},{label:t.t("find-replace.dialog.find-scope.workbook"),value:k.UNIT}],[e])}function ki(t){const e=t.getCurrentLocale();return f.useMemo(()=>[{label:t.t("find-replace.dialog.find-direction.row"),value:P.ROW},{label:t.t("find-replace.dialog.find-direction.column"),value:P.COLUMN}],[e])}function $i(t){const e=t.getCurrentLocale();return f.useMemo(()=>[{label:t.t("find-replace.dialog.find-by.value"),value:$.VALUE},{label:t.t("find-replace.dialog.find-by.formula"),value:$.FORMULA}],[e])}function j(t){return t.getContextValue(lt)}function Fi(t){return t.getContextValue(ht)}function yt(t){return t.getContextValue(ct)}const J="7_find-replace-shortcuts";function Fe(t){return t.getContextValue(Ze)}function Ue(t){return!t.getContextValue(we)}const Ui={id:Q.id,description:"find-replace.shortcut.open-find-dialog",binding:U.F|O.CTRL_COMMAND,group:J,preconditions(t){return!j(t)&&Fe(t)&&Ue(t)}},Ti={id:Q.id,description:"find-replace.shortcut.open-find-dialog",binding:U.F|O.CTRL_COMMAND,mac:U.F|O.MAC_CTRL,preconditions(t){return!j(t)&&Fe(t)&&Ue(t)}},Pi={id:$e.id,description:"find-replace.shortcut.open-replace-dialog",binding:U.H|O.CTRL_COMMAND,mac:U.H|O.MAC_CTRL,group:J,preconditions(t){return Fe(t)&&Ue(t)&&(!j(t)||!Fi(t))}},Ei={id:pt.id,description:"find-replace.shortcut.go-to-next-match",binding:U.ENTER,group:J,priority:1e3,preconditions(t){return yt(t)&&j(t)}},Ni={id:_t.id,description:"find-replace.shortcut.go-to-previous-match",binding:U.ENTER|O.SHIFT,group:J,priority:1e3,preconditions(t){return yt(t)&&j(t)}},Ai={id:mt.id,description:"find-replace.shortcut.focus-selection",binding:U.ESC,group:J,priority:1e3,preconditions(t){return j(t)}};function Oi(t){const e=t.get(Y);return{id:Q.id,icon:"SearchIcon",tooltip:"find-replace.toolbar",type:Jt.BUTTON,hidden$:Qt(t,ke.UNIVER_SHEET),disabled$:Ye([e.subscribeContextValue$(we),e.subscribeContextValue$(Ze)]).pipe(Nt(([i,n])=>i||!n))}}const Di={[Kt.ORGANIZATION]:{[Q.id]:{order:2,menuItemFactory:Oi}}};var Wi=(t,e,i,n)=>{for(var s=e,a=t.length-1,r;a>=0;a--)(r=t[a])&&(s=r(s)||s);return s},w=(t,e)=>(i,n)=>e(i,n,t);const We="DESKTOP_FIND_REPLACE_DIALOG",Rt=350,ji=20,Bi=64;let G=class extends Pt{constructor(t,e,i,n,s,a,r,o,c){super(),g(this,"_closingListenerDisposable"),this._univerInstanceService=t,this._menuManagerService=e,this._shortcutService=i,this._commandService=n,this._findReplaceService=s,this._dialogService=a,this._layoutService=r,this._localeService=o,this._componentManager=c,this._initCommands(),this._initUI(),this._initShortcuts()}dispose(){var t;super.dispose(),(t=this._closingListenerDisposable)==null||t.dispose(),this._closingListenerDisposable=null}_initCommands(){[Q,$e,pt,_t,ft,gt,mt].forEach(t=>{this.disposeWithMe(this._commandService.registerCommand(t))})}_initShortcuts(){[Pi,Ui,Ti,Ni,Ei,Ai].forEach(t=>this.disposeWithMe(this._shortcutService.registerShortcut(t)))}_initUI(){[["FindReplaceDialog",Ii],["SearchIcon",Ct]].forEach(([t,e])=>{this.disposeWithMe(this._componentManager.register(t,e))}),this._menuManagerService.mergeMenu(Di),this._findReplaceService.stateUpdates$.pipe(Ee(this.dispose$)).subscribe(t=>{t.revealed===!0&&this._openPanel()})}_openPanel(){this._dialogService.open({id:We,draggable:!0,width:Rt,title:{title:this._localeService.t("find-replace.dialog.title")},children:{label:"FindReplaceDialog"},destroyOnClose:!0,mask:!1,maskClosable:!1,defaultPosition:Li(),preservePositionOnDestroy:!0,onClose:()=>this.closePanel()}),this._closingListenerDisposable=te(this._univerInstanceService.focused$.pipe(Ee(this.dispose$)).subscribe(t=>{(!t||!this._univerInstanceService.getUniverSheetInstance(t))&&this.closePanel()}))}closePanel(){this._closingListenerDisposable&&(this._closingListenerDisposable.dispose(),this._closingListenerDisposable=null,this._dialogService.close(We),this._findReplaceService.terminate(),queueMicrotask(()=>this._layoutService.focus()))}};G=Wi([w(0,K),w(1,Xt),w(2,ei),w(3,E),w(4,b),w(5,ti),w(6,it),w(7,M(oe)),w(8,M(ii))],G);function Li(){const{innerWidth:t}=window;return{x:t-Rt-ji,y:Bi}}const Hi="find-replace.config",je={};var Vi=(t,e,i,n)=>{for(var s=e,a=t.length-1,r;a>=0;a--)(r=t[a])&&(s=r(s)||s);return s},Be=(t,e)=>(i,n)=>e(i,n,t);const qi="UNIVER_FIND_REPLACE_PLUGIN";var Se;let ae=(Se=class extends Qe{constructor(t=je,e,i){super(),this._config=t,this._injector=e,this._configService=i;const{...n}=Je({},je,this._config);this._configService.setConfig(Hi,n)}onStarting(){[[G],[b,{useClass:ye}]].forEach(t=>this._injector.add(t))}onRendered(){this._injector.get(G)}},g(Se,"pluginName",qi),Se);ae=Vi([Be(1,M(W)),Be(2,Xe)],ae);var Gi=Object.defineProperty,zi=(t,e,i)=>e in t?Gi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,v=(t,e,i)=>zi(t,typeof e!="symbol"?e+"":e,i);const xt={id:"sheet.command.replace",type:R.COMMAND,handler:async(t,e)=>{const i=t.get(At),n=t.get(E),{unitId:s,replacements:a}=e,r=i.__tempBatchingUndoRedo(s),o=await Promise.all(a.map(c=>n.executeCommand(st.id,{unitId:s,subUnitId:c.subUnitId,value:c.value})));return r.dispose(),Yi(o,a)}};function Yi(t,e){let i=0,n=0;return t.forEach((s,a)=>{const r=e[a].count;s?i+=r:n+=r}),{success:i,failure:n}}class Ki extends ci{constructor(e,i){super(e,i),v(this,"_activated",!1),v(this,"_inHiddenRange",!1),v(this,"_color"),i&&this.setShapeProps(i)}setShapeProps(e){this._activated=!!e.activated,typeof e.inHiddenRange<"u"&&(this._inHiddenRange=e.inHiddenRange),typeof e.color<"u"&&(this._color=e.color),this.transformByState({width:e.width,height:e.height})}_draw(e){const i=this._activated,n=`rgba(${this._color.r}, ${this._color.g}, ${this._color.b}, 0.35)`,s=`rgb(${this._color.r}, ${this._color.g}, ${this._color.b})`;li.drawWith(e,{width:this.width,height:this.height,fill:n,stroke:i?s:void 0,strokeWidth:i?2:0,evented:!1})}}function Le(t,e){return t.startRow===e.startRow&&t.startColumn===e.startColumn}function He(t,e){return t.startRow<e.startRow||t.startRow===e.startRow&&t.startColumn<=e.startColumn}function Ve(t,e){return t.startColumn<e.startColumn||t.startColumn===e.startColumn&&t.startRow<=e.startRow}function Qi(t,e){return t.startRow>e.startRow||t.startRow===e.startRow&&t.startColumn>=e.startColumn}function Ji(t,e){return t.startColumn>e.startColumn||t.startColumn===e.startColumn&&t.startRow>=e.startRow}function Zi(t,e){const{range:i}=t,{startRow:n,startColumn:s}=i,a=e.getMergedCell(n,s);return a?Vt.equals(i,a):i.endRow===i.startRow&&i.endColumn===i.startColumn}var Te=(t,e,i,n)=>{for(var s=e,a=t.length-1,r;a>=0;a--)(r=t[a])&&(s=r(s)||s);return s},C=(t,e)=>(i,n)=>e(i,n,t);let re=class extends D{constructor(t,e,i,n,s){super(),v(this,"_provider"),this._injector=t,this._findReplaceController=e,this._contextService=i,this._findReplaceService=n,this._commandService=s,this._init(),this._initCommands()}dispose(){super.dispose(),this._findReplaceController.closePanel(),this._provider.dispose()}_init(){const t=this._injector.createInstance(xe);this._provider=t,this.disposeWithMe(this._findReplaceService.registerFindReplaceProvider(t)),this.disposeWithMe(this._contextService.subscribeContextValue$(we).pipe(X(e=>!!e)).subscribe(()=>this._findReplaceController.closePanel()))}_initCommands(){[xt].forEach(t=>this.disposeWithMe(this._commandService.registerCommand(t)))}};re=Te([C(0,M(W)),C(1,M(G)),C(2,Y),C(3,b),C(4,E)],re);const Xi="sheets-find-replace-provider",en=1e4;let Re=class extends mi{constructor(t,e,i,n,s,a,r,o){super(),v(this,"_matchesUpdate$",new ie),v(this,"matchesUpdate$",this._matchesUpdate$.asObservable()),v(this,"_activelyChangingMatch$",new ie),v(this,"activelyChangingMatch$",this._activelyChangingMatch$.asObservable()),v(this,"_matchesByWorksheet",new Map),v(this,"_matches",[]),v(this,"_matchesPosition",0),v(this,"_activeHighlightIndex",-1),v(this,"_highlightShapes",[]),v(this,"_currentHighlightShape",null),v(this,"_query",null),v(this,"_workbookSelections"),this._workbook=t,this._sheetSkeletonManagerService=e,this._univerInstanceService=i,this._renderManagerService=n,this._commandService=s,this._contextService=a,this._themeService=r,this._workbookSelections=o.getWorkbookSelections(this.unitId)}get _matchesCount(){return this._matches.length}get unitId(){return this._workbook.getUnitId()}get matchesCount(){return this._matchesCount}get matchesPosition(){return this._matchesPosition}get currentMatch(){return this._matchesPosition>0?this._matches[this._matchesPosition-1]:null}dispose(){super.dispose(),this._disposeHighlights(),this._toggleDisplayRawFormula(!1)}getMatches(){return this._matches}start(t){switch(this._query=t,t.findBy===$.FORMULA?this._toggleDisplayRawFormula(!0):this._toggleDisplayRawFormula(!1),t.findScope){case k.UNIT:this.findInWorkbook(t);break;case k.SUBUNIT:default:this.findInActiveWorksheet(t);break}}focusSelection(){const t=this.currentMatch;t&&this._commandService.executeCommand(si.id,{unitId:t.unitId,subUnit:t.range.subUnitId,range:t.range.range})}_toggleDisplayRawFormula(t){this._contextService.setContextValue(nt,t)}findInWorkbook(t){const e=this._workbook.getUnitId();let i,n=!0;const s=()=>{const a=this._workbook.getSheets().filter(r=>!r.isSheetHidden()).map(r=>{const o=this._findInWorksheet(r,t,e),c=r.getSheetId(),{results:h}=o;return h.length?this._matchesByWorksheet.set(c,o.results):this._matchesByWorksheet.delete(c),o});this._matches=a.map(r=>r.results).flat(),this._updateFindHighlight(),n?(i={results:this._matches},n=!1):this._matchesUpdate$.next(this._matches)};return this.disposeWithMe(this._sheetSkeletonManagerService.currentSkeleton$.subscribe(()=>{this._updateFindHighlight(),this._updateCurrentHighlightShape(this._activeHighlightIndex)})),this.disposeWithMe(_e(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(X(([a,r])=>a.id===hi.id&&!(r!=null&&r.fromFindReplace))).subscribe(()=>{const a=this._workbook.getActiveSheet();if(!a)return;const r=a.getSheetId();this._matchesByWorksheet.has(r)&&this._findNextMatchOnActiveSheetChange(a)})),this.disposeWithMe(_e(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(X(([a])=>a.type===R.MUTATION&&a.params.unitId===this._workbook.getUnitId()),et(600,void 0,{leading:!1,trailing:!0})).subscribe(()=>s())),s(),i}_findNextMatchOnActiveSheetChange(t){let e,i,n=0;const s=this._matchesByWorksheet.get(t.getSheetId()),a=this._workbookSelections.getCurrentSelections();a!=null&&a.length?([e,n]=this._findNextMatchByRange(s,a[0].range),i=s.findIndex(r=>r===e)):(e=s[0],i=0,n=this._matches.findIndex(r=>r===e)),this._matchesPosition=n+1,this._activelyChangingMatch$.next(e),this._activeHighlightIndex=i,this._updateFindHighlight(),this._updateCurrentHighlightShape(i)}findInActiveWorksheet(t){const e=this._workbook.getUnitId(),i=()=>{var o;const c=this._workbook.getActiveSheet();if(!c)return!1;const h=this._workbookSelections.getCurrentSelections();return(o=h==null?void 0:h.some(l=>!Zi(l,c)))!=null?o:!1};let n,s=!0,a=!1;const r=()=>{const o=this._workbook.getActiveSheet();if(!o)return{results:[]};const c=this.currentMatch;a=i();const h=this._workbookSelections.getCurrentSelections(),l=a?this._findInSelections(o,h,t,e):this._findInWorksheet(o,t,e);return this._matches=l.results,this._matchesPosition=this._tryRestoreLastMatchesPosition(c,this._matches),s?(n=l,s=!1):this._matchesUpdate$.next(this._matches),this._updateFindHighlight(),l};return this.disposeWithMe(this._sheetSkeletonManagerService.currentSkeleton$.subscribe(()=>this._updateFindHighlight())),this.disposeWithMe(Ot(_e(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(X(([o])=>{if(o.type===R.MUTATION&&o.params.unitId===this._workbook.getUnitId())return!0;if(o.id===di.id&&o.params.unitId===e){const c=i();return c===!1&&a===!1?!1:(a=c,!0)}return!1})),this._workbook.activeSheet$.pipe(Dt(1))).pipe(Ke(200)).subscribe(()=>r())),r(),n}_findInRange(t,e,i,n,s){const a=[],r=t.getSheetId(),o=(e.findDirection===P.COLUMN?t.iterateByColumn:t.iterateByRow).bind(t)(i);for(const c of o){const{row:h,col:l,colSpan:d,rowSpan:p,value:_}=c;if(s!=null&&s(h,l)||!_||t.getRowFiltered(h))continue;const{hit:F,replaceable:x,isFormula:N}=tn(t,h,l,e,_);if(F){const B={provider:Xi,unitId:n,replaceable:x,isFormula:N,range:{subUnitId:r,range:{startRow:h,startColumn:l,endColumn:l+(d??1)-1,endRow:h+(p??1)-1}}};a.push(B)}}return{results:a}}_findInSelections(t,e,i,n){const{findDirection:s}=i,a=s===P.ROW?He:Ve,r=new Set;return{results:e.map(o=>this._findInRange(t,i,o.range,n,(c,h)=>{const l=`${c}-${h}`;return r.has(l)?!0:(r.add(l),!1)}).results).flat().sort((o,c)=>a(o.range.range,c.range.range)?-1:1)}}_findInWorksheet(t,e,i){const n=t.getRowCount(),s=t.getColumnCount(),a={startRow:0,startColumn:0,endRow:n-1,endColumn:s-1};return this._findInRange(t,e,a,i)}_disposeHighlights(){var t;this._highlightShapes.forEach(e=>{var i;(i=e.getScene())==null||i.makeDirty(),e.dispose()}),this._highlightShapes=[],(t=this._currentHighlightShape)==null||t.dispose(),this._currentHighlightShape=null}_updateFindHighlight(){var t;this._disposeHighlights();const e=(t=this._sheetSkeletonManagerService.getCurrent())==null?void 0:t.skeleton;if(!e)return;const i=this._workbook.getUnitId(),n=this._renderManagerService.getRenderById(i);if(n==null)return;const{scene:s}=n,a=this._matches,r=this._themeService.getColorFromTheme("yellow.400"),o=new Wt(r).toRgb(),c=this._workbook.getActiveSheet();if(!c)return;const h=c.getSheetId(),l=a.filter(d=>d.range.subUnitId===h).map((d,p)=>{const{startColumn:_,startRow:F,endColumn:x,endRow:N}=d.range.range,B=Ne(F,_,s,e),le=Ne(N,x,s,e),{startX:A,startY:Z}=B,{endX:he,endY:de}=le;let L=!0;for(let I=F;I<=N;I++)if(c.getRowRawVisible(I)){L=!1;break}let H=!0;for(let I=_;I<=x;I++)if(c.getColVisible(I)){H=!1;break}const ue=L||H,ge=H?2:he-A,fe=L?2:de-Z,pe={left:A,top:Z,color:o,width:ge,height:fe,evented:!1,inHiddenRange:ue,zIndex:en};return new Ki(`find-highlight-${p}`,pe)});s.addObjects(l),this._highlightShapes=l,s.makeDirty()}_updateCurrentHighlightShape(t){var e;if((e=this._currentHighlightShape)==null||e.setShapeProps({activated:!1}),this._currentHighlightShape=null,t!==void 0){const i=this._highlightShapes[t];if(!i)return;this._currentHighlightShape=i,i.setShapeProps({activated:!0})}}_getSheetObject(){return ai(this._univerInstanceService,this._renderManagerService)}_focusMatch(t){var e;const i=t.range.subUnitId;i!==((e=this._workbook.getActiveSheet())==null?void 0:e.getSheetId())&&this._commandService.executeCommand(ri.id,{unitId:this._workbook.getUnitId(),subUnitId:i},{fromFindReplace:!0}),this._commandService.executeCommand(oi.id,{range:t.range.range},{fromFindReplace:!0})}_tryRestoreLastMatchesPosition(t,e){if(!t)return 0;const{subUnitId:i}=t.range,{startColumn:n,startRow:s}=t.range.range,a=e.findIndex(r=>{if(i!==r.range.subUnitId)return!1;const{startColumn:o,startRow:c}=r.range.range;return o===n&&c===s});return a>-1?a+1:0}moveToNextMatch(t){var e,i,n,s,a;if(!this._matches.length)return null;const r=(e=t==null?void 0:t.loop)!=null?e:!1,o=(i=t==null?void 0:t.stayIfOnMatch)!=null?i:!1,c=(n=t==null?void 0:t.noFocus)!=null?n:!1,h=(s=t==null?void 0:t.ignoreSelection)!=null?s:!1,l=this._findNextMatch(r,o,h);if(l){const[d,p]=l;return this._matchesPosition=p+1,this._query.findScope===k.UNIT?this._activeHighlightIndex=this._matchesByWorksheet.get(d.range.subUnitId).findIndex(_=>_===d):this._activeHighlightIndex=p,c||this._focusMatch(d),((a=this._workbook.getActiveSheet())==null?void 0:a.getSheetId())===d.range.subUnitId&&this._updateCurrentHighlightShape(this._activeHighlightIndex),d}return this._matchesPosition=0,this._updateCurrentHighlightShape(),null}moveToPreviousMatch(t){var e,i,n,s,a;if(!this._matches.length)return null;const r=(e=t==null?void 0:t.loop)!=null?e:!1,o=(i=t==null?void 0:t.stayIfOnMatch)!=null?i:!1,c=(n=t==null?void 0:t.noFocus)!=null?n:!1,h=(s=t==null?void 0:t.ignoreSelection)!=null?s:!1,l=this._findPreviousMatch(r,o,h);if(l){const[d,p]=l;return this._matchesPosition=p+1,this._query.findScope===k.UNIT?this._activeHighlightIndex=this._matchesByWorksheet.get(d.range.subUnitId).findIndex(_=>_===d):this._activeHighlightIndex=p,c||this._focusMatch(d),((a=this._workbook.getActiveSheet())==null?void 0:a.getSheetId())===d.range.subUnitId&&this._updateCurrentHighlightShape(this._activeHighlightIndex),d}return this._matchesPosition=0,this._updateCurrentHighlightShape(),null}_findPreviousMatch(t=!1,e=!1,i=!1){var n;if(this.currentMatch){const o=this._matches.findIndex(d=>d===this.currentMatch);if(e)return[this.currentMatch,o];const c=o-1;if(!t&&c<0)return null;const h=this._matches.length,l=(c+h)%h;return[this._matches[l],l]}const s=this._workbookSelections.getCurrentLastSelection();if(i||!s){const o=this._matches.length-1;return[this._matches[o],o]}if(this._query.findScope!==k.UNIT)return this._findPreviousMatchByRange(this._matches,s.range);const a=(n=this._workbook.getActiveSheet())==null?void 0:n.getSheetId();if(!a)return null;const r=this._findPreviousWorksheetThatHasAMatch(a,t);return r?this._findPreviousMatchByRange(this._matchesByWorksheet.get(r),s.range):null}_findNextMatch(t=!1,e=!1,i=!1){var n;if(this.currentMatch){const o=this._matches.findIndex(d=>d===this.currentMatch);if(e)return[this.currentMatch,o];const c=o+1,h=this._matches.length;if(!t&&c>=h)return null;const l=c%h;return[this._matches[l],l]}const s=this._workbookSelections.getCurrentLastSelection();if(i||!s)return[this._matches[0],0];if(this._query.findScope!==k.UNIT)return this._findNextMatchByRange(this._matches,s.range,e);const a=(n=this._workbook.getActiveSheet())==null?void 0:n.getSheetId();if(!a)return null;const r=this._findNextWorksheetThatHasAMatch(a,t);return r?this._findNextMatchByRange(this._matchesByWorksheet.get(r),s.range):null}_findPreviousWorksheetThatHasAMatch(t,e=!1){const i=this._workbook.getSheetOrders(),n=i.findIndex(a=>a===t),s=(e?Pe(i,n+1):i.slice(0,n+1)).findLast(a=>this._matchesByWorksheet.has(a));return s??null}_findNextWorksheetThatHasAMatch(t,e=!1){const i=this._workbook.getSheetOrders(),n=i.findIndex(a=>a===t),s=(e?Pe(i,n):i.slice(n)).find(a=>this._matchesByWorksheet.has(a));return s??null}_findNextMatchByRange(t,e,i=!1){const n=this._query.findDirection===P.ROW;let s=t.findIndex(r=>{const o=r.range.range;if(!(n?He(e,o):Ve(e,o)))return!1;const c=Le(e,o);return i?c:!c});s===-1&&(s=t.length-1);const a=t[s];return[a,this._matches.findIndex(r=>r===a)]}_findPreviousMatchByRange(t,e,i=!1){const n=this._query.findDirection===P.ROW;let s=this._matches.findLastIndex(r=>{const o=r.range.range;if(!(n?Qi(e,o):Ji(e,o)))return!1;const c=Le(e,o);return i?c:!c});s===-1&&(s=0);const a=t[s];return[a,this._matches.findIndex(r=>r===a)]}async replace(t){if(this._matchesCount===0||!this.currentMatch||!this._query||!this.currentMatch.replaceable)return!1;const e=this.currentMatch.range,i=this._workbook.getSheetBySheetId(this.currentMatch.range.subUnitId),n=this._getReplacedCellData(this.currentMatch,i,this._query.findBy===$.FORMULA,this._query.findString,t,this._query.caseSensitive?"g":"ig"),s={unitId:this.currentMatch.unitId,subUnitId:e.subUnitId,value:{[e.range.startRow]:{[e.range.startColumn]:n}}};return this._commandService.executeCommand(st.id,s)}async replaceAll(t){if(this._matchesCount===0||!this._query)return{success:0,failure:0};const e=this._workbook.getUnitId(),{findString:i,caseSensitive:n,findBy:s}=this._query,a=s===$.FORMULA,r=n?"g":"ig",o=[];return jt(this._matches.filter(c=>c.replaceable),c=>c.range.subUnitId).forEach((c,h)=>{const l=new Bt,d=this._workbook.getSheetBySheetId(h);c.forEach(p=>{const{startColumn:_,startRow:F}=p.range.range,x=this._getReplacedCellData(p,d,a,i,t,r);x&&l.setValue(F,_,x)}),o.push({count:c.length,subUnitId:h,value:l.getMatrix()})}),o?this._commandService.executeCommand(xt.id,{unitId:e,replacements:o}):{success:0,failure:0}}_getReplacedCellData(t,e,i,n,s,a){var r;const o=t.range.range,{startRow:c,startColumn:h}=o,l=e.getCellRaw(c,h);if(t.isFormula)return i?{f:l.f.replace(new RegExp(qe(n),a),s),v:null}:null;if((r=l.p)!=null&&r.body){const d=Lt.deepClone(l.p);return Ht(d.body,n,s,this._query.caseSensitive),{p:d}}return{v:l.v.toString().replace(new RegExp(qe(n),a),s)}}};Re=Te([C(2,K),C(3,at),C(4,E),C(5,Y),C(6,M(Gt)),C(7,M(ui))],Re);function qe(t){return t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}let xe=class extends D{constructor(t,e,i){super(),v(this,"_findModelsByUnitId",new Map),this._univerInstanceService=t,this._renderManagerService=e,this._injector=i}async find(t){this._terminate();const e=this._univerInstanceService.getCurrentUnitOfType(ke.UNIVER_SHEET);if(!e)return[];const i=this._preprocessQuery(t),n=this._renderManagerService.getRenderById(e.getUnitId()).with(ni),s=this._injector.createInstance(Re,e,n);return this._findModelsByUnitId.set(e.getUnitId(),s),s.start(i),[s]}terminate(){this._terminate()}_terminate(){this._findModelsByUnitId.forEach(t=>t.dispose()),this._findModelsByUnitId.clear()}_preprocessQuery(t){let e=t.caseSensitive?t.findString:t.findString.toLowerCase();return e=e.trim(),{...t,findString:e}}};xe=Te([C(0,K),C(1,at),C(2,M(W))],xe);const m={hit:!1,replaceable:!1,isFormula:!1,rawData:null};function tn(t,e,i,n,s){const{findBy:a}=n,r=a===$.FORMULA,o=t.getCellRaw(e,i);return m.rawData=o,o!=null&&o.f?(m.isFormula=!0,r?Ce({v:o.f},n)?(m.hit=!0,m.replaceable=!0,m):(m.hit=!1,m.replaceable=!1,m):(m.replaceable=!1,Ce(s,n)?m.hit=!0:m.hit=!1,m)):(m.isFormula=!1,Ce(s,n)?o?(m.hit=!0,m.replaceable=!0):(m.hit=!0,m.replaceable=!1):(m.hit=!1,m.replaceable=!1),m)}function Ce(t,e){let i=nn(t);return i?e.matchesTheWholeCell?(i=sn(i),e.caseSensitive?i===e.findString:i.toLowerCase()===e.findString):e.caseSensitive?i.indexOf(e.findString)>-1:i.toLowerCase().indexOf(e.findString)>-1:!1}function nn(t){var e,i,n;const s=(n=(i=(e=t==null?void 0:t.p)==null?void 0:e.body)==null?void 0:i.dataStream)!=null?n:t==null?void 0:t.v;return typeof s=="number"?`${s}`:typeof s=="boolean"?s?"1":"0":s}function sn(t){return t.replace(/^ +/g,"").replace(/ +$/g,"")}const an="sheets-find-replace.config",Ge={};var rn=Object.defineProperty,on=(t,e,i)=>e in t?rn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,cn=(t,e,i,n)=>{for(var s=e,a=t.length-1,r;a>=0;a--)(r=t[a])&&(s=r(s)||s);return s},ze=(t,e)=>(i,n)=>e(i,n,t),It=(t,e,i)=>on(t,typeof e!="symbol"?e+"":e,i);const ln="SHEET_FIND_REPLACE_PLUGIN";let z=class extends Qe{constructor(t=Ge,e,i){super(),this._config=t,this._injector=e,this._configService=i;const{...n}=Je({},Ge,this._config);this._configService.setConfig(an,n)}onStarting(){[[re]].forEach(t=>this._injector.add(t))}onSteady(){this._injector.get(re)}};It(z,"pluginName",ln);It(z,"type",ke.UNIVER_SHEET);z=cn([qt(Ae,Ae,ae),ze(1,M(W)),ze(2,Xe)],z);var hn=Object.defineProperty,dn=(t,e,i)=>e in t?hn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,be=(t,e,i)=>dn(t,typeof e!="symbol"?e+"":e,i),un=(t,e,i,n)=>{for(var s=e,a=t.length-1,r;a>=0;a--)(r=t[a])&&(s=r(s)||s);return s},Me=(t,e)=>(i,n)=>e(i,n,t);let Ie=class extends D{constructor(t,e,i,n){super(),be(this,"_state",new ut),be(this,"_model"),be(this,"_complete"),this._injector=e,this._univerInstanceService=i,this._findReplaceService=n;const s=this._findReplaceService.getProviders();this._model=this._injector.createInstance(se,this._state,s);const a={...ce(),...t};this._state.changeState(a)}findAll(){return!this._state.findCompleted||!this._complete?[]:this._complete.results.map(t=>this._findMatchToFRange(t))}findNext(){var t;if(!this._state.findCompleted||!this._complete)return null;const e=(t=this._model)==null?void 0:t.moveToNextMatch();return e?this._findMatchToFRange(e):null}findPrevious(){var t;const e=(t=this._model)==null?void 0:t.moveToPreviousMatch();return e?this._findMatchToFRange(e):null}getCurrentMatch(){var t;if(!this._state.findCompleted||!this._complete)throw new Error("Find operation is not completed.");const e=(t=this._model)==null?void 0:t.currentMatch$.value;return e?this._findMatchToFRange(e):null}async matchCaseAsync(t){return this._state.changeState({caseSensitive:t,findCompleted:!1}),new Promise(e=>{const i=this._state.stateUpdates$.subscribe(async n=>{n.findCompleted===!0&&(i.unsubscribe(),await this.ensureCompleteAsync(),e(this))})})}async matchEntireCellAsync(t){return this._state.changeState({matchesTheWholeCell:t,findCompleted:!1}),new Promise(e=>{const i=this._state.stateUpdates$.subscribe(async n=>{n.findCompleted===!0&&(i.unsubscribe(),await this.ensureCompleteAsync(),e(this))})})}async matchFormulaTextAsync(t){return this._state.changeState({findBy:t?$.FORMULA:$.VALUE,findCompleted:!1}),new Promise(e=>{const i=this._state.stateUpdates$.subscribe(async n=>{n.findCompleted===!0&&(i.unsubscribe(),await this.ensureCompleteAsync(),e(this))})})}async replaceAllWithAsync(t){var e,i,n;await this._state.changeState({replaceRevealed:!0,replaceString:t});const s=(n=(i=await((e=this._model)==null?void 0:e.replaceAll()))==null?void 0:i.success)!=null?n:0;return this._state.changeState({replaceRevealed:!1}),s}async replaceWithAsync(t){var e;return await this._state.changeState({replaceRevealed:!0,replaceString:t}),await((e=this._model)==null?void 0:e.replace()),this._state.changeState({replaceRevealed:!1}),!0}async ensureCompleteAsync(){var t;this._complete=await((t=this._model)==null?void 0:t.start())}_findMatchToFRange(t){const{unitId:e}=t,{subUnitId:i,range:n}=t.range,s=this._univerInstanceService.getUnit(e),a=s.getSheetBySheetId(i);return this._injector.createInstance(fi,s,a,n)}};Ie=un([Me(1,M(W)),Me(2,K),Me(3,b)],Ie);class gn extends ot{async createTextFinderAsync(e){const i={findString:e},n=this._injector.createInstance(Ie,i);return await n.ensureCompleteAsync(),n}}ot.extend(gn);function Fn(t={}){return{plugins:[[ae],[z]].filter(e=>!!e)}}export{$ as FindBy,P as FindDirection,mi as FindModel,G as FindReplaceController,se as FindReplaceModel,ut as FindReplaceState,k as FindScope,pt as GoToNextMatchOperation,_t as GoToPreviousMatchOperation,b as IFindReplaceService,Q as OpenFindDialogOperation,$e as OpenReplaceDialogOperation,ft as ReplaceAllMatchesCommand,gt as ReplaceCurrentMatchCommand,xt as SheetReplaceCommand,re as SheetsFindReplaceController,ae as UniverFindReplacePlugin,z as UniverSheetsFindReplacePlugin,Fn as UniverSheetsFindReplacePreset,ce as createInitFindReplaceState};
