import{M as G,V as N,S,v as U,L as _,ac as P,O as q,o as H,f as g,w as W,q as J,I as R,u as z,x as K}from"./TeamSpreadsheet-DqPQXi__.js";import{nJ as M,kE as Q,a5 as X,a6 as Y,_ as Z}from"./index--BQDx9CP.js";var ee=Object.defineProperty,ne=(e,n,t)=>n in e?ee(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,te=(e,n,t)=>ne(e,n+"",t),f=(e=>(e.DESC="desc",e.ASC="asc",e))(f||{});const y=e=>e.replace(/-/gi,"").replace(/'/gi,""),re=(e,n)=>{const t=e===null||e==="",o=n===null||n==="";return t&&o?0:t?1:o?-1:null},oe=(e,n,t)=>{const o=typeof e=="number",r=typeof n=="number";return o&&r?e<n?t===f.ASC?-1:1:e>n?t===f.ASC?1:-1:0:o?t===f.ASC?1:-1:r?t===f.ASC?-1:1:null},se=(e,n,t)=>{const o=typeof e=="string",r=typeof n=="string";if(o&&(e=y(e.toLocaleLowerCase())),r&&(n=y(n.toLocaleLowerCase())),!o&&!r)return null;if(o&&r){const s=e,l=n;return s<l?t===f.ASC?-1:1:s>l?t===f.ASC?1:-1:0}return o?t===f.ASC?1:-1:r?t===f.ASC?-1:1:null},x=e=>!e||Object.keys(e).length===0||(e==null?void 0:e.v)==null&&(e==null?void 0:e.p)==null;var le=(e,n,t,o)=>{for(var r=n,s=e.length-1,l;s>=0;s--)(l=e[s])&&(r=l(r)||r);return r},p=(e,n)=>(t,o)=>n(t,o,e);let m=class extends N{constructor(e,n,t){super(),te(this,"_compareFns",[]),this._univerInstanceService=e,this._commandService=n,this._formulaDataModel=t}mergeCheck(e){var n;const{unitId:t,subUnitId:o,range:r}=e,s=(n=this._univerInstanceService.getUnit(t))==null?void 0:n.getSheetBySheetId(o);if(!s)return!1;const l=s.getMergeData().filter(a=>S.contains(r,a));return l.length===0?!0:ae(r,l)}emptyCheck(e){var n;const{unitId:t,subUnitId:o,range:r}=e,s=(n=this._univerInstanceService.getUnit(t))==null?void 0:n.getSheetBySheetId(o);if(!s)return!1;for(let l=r.startRow;l<=r.endRow;l++)for(let a=r.startColumn;a<=r.endColumn;a++)if(!x(s.getCellRaw(l,a)))return!0;return!1}singleCheck(e){return e.range.startRow!==e.range.endRow}formulaCheck(e){var n,t;const{unitId:o,subUnitId:r,range:s}=e,l=(t=(n=this._formulaDataModel.getArrayFormulaRange())==null?void 0:n[o])==null?void 0:t[r];for(const a in l){const i=l[Number(a)];for(const c in i){const d=i[Number(c)];if(d&&S.intersects(s,d))return!1}}return!0}registerCompareFn(e){this._compareFns.unshift(e)}getAllCompareFns(){return this._compareFns}applySort(e,n,t){var o;const{unitId:r,subUnitId:s}=M(this._univerInstanceService)||{};this._commandService.executeCommand(O.id,{orderRules:e.orderRules,range:e.range,hasTitle:(o=e.hasTitle)!=null?o:!1,unitId:n||r,subUnitId:t||s})}};m=le([p(0,U),p(1,_),p(2,R(Z))],m);function ae(e,n){const t=e.endRow-e.startRow+1,o=e.endColumn-e.startColumn+1;let r=null,s=null;const l=t*o;let a=0;for(const i of n)if(i.startRow>=e.startRow&&i.endRow<=e.endRow&&i.startColumn>=e.startColumn&&i.endColumn<=e.endColumn){const c=i.endRow-i.startRow+1,d=i.endColumn-i.startColumn+1;if(r===null&&s===null)r=c,s=d;else if(c!==r||d!==s)return!1;a+=c*d}return a===l}const O={id:"sheet.command.sort-range",type:G.COMMAND,handler:(e,n)=>{const{range:t,orderRules:o,hasTitle:r,unitId:s,subUnitId:l}=n,a=e.get(m),i=e.get(U),{worksheet:c}=M(i,n)||{};if(!c)return!1;const d=c.getMergeData().filter(u=>S.contains(t,u)),L=d.map(u=>u.startRow),{startRow:I,endRow:T}=t,V=r?I+1:I,C=[],b=[];for(let u=V;u<=T;u++)c.getRowFiltered(u)||c.getRowRawVisible(u)!==!1&&(d.length&&!L.includes(u)||(C.push({index:u,value:ie(c,u,o)}),b.push(u)));const $=a.getAllCompareFns();C.sort(ce(o,ue($)));const w={};C.forEach(({index:u,value:Ce},B)=>{w[b[B]]=u});const k={id:Q.id,params:{unitId:s,subUnitId:l,range:t,order:w}},D=e.get(_);return P([k],D).result}};function ie(e,n,t){const o=[];return t.forEach(({colIndex:r})=>{o.push(e.getCellRaw(n,r))}),o}function ue(e){return(n,t,o)=>{for(let r=0;r<e.length;r++){const s=e[r](n,t,o);if(s!=null)return s}return 0}}function ce(e,n){return function(t,o){let r=null;for(let s=0;s<e.length;s++){const l=t.value[s],a=o.value[s];if(r=n(e[s].type,l,a),r!==0&&r!==null&&r!==void 0)return r}return 0}}const de="sheets-sort.config",E={};var fe=(e,n,t,o)=>{for(var r=n,s=e.length-1,l;s>=0;s--)(l=e[s])&&(r=l(r)||r);return r},A=(e,n)=>(t,o)=>n(t,o,e);let v=class extends N{constructor(e,n){super(),this._commandService=e,this._sortService=n,this._initCommands(),this._registerCompareFns()}_initCommands(){[O].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_registerCompareFns(){const e=(n,t,o)=>{const r=this._getCommonValue(t),s=this._getCommonValue(o),l=[re,se,oe];for(let a=0;a<l.length;a++){const i=l[a](r,s,n);if(i!==null)return i}return null};this._sortService.registerCompareFn(e)}_getCommonValue(e){var n,t;return x(e)?null:((t=(n=e==null?void 0:e.p)==null?void 0:n.body)==null?void 0:t.dataStream)||((e==null?void 0:e.t)===g.NUMBER?Number.parseFloat(`${e.v}`):(e==null?void 0:e.t)===g.STRING?typeof e.v=="number"?e.v:`${e.v}`:(e==null?void 0:e.t)===g.BOOLEAN?`${e.v}`:(e==null?void 0:e.t)===g.FORCE_STRING?Number.parseFloat(`${e.v}`):`${e==null?void 0:e.v}`)}};v=fe([A(0,_),A(1,R(m))],v);var me=Object.defineProperty,ge=(e,n,t)=>n in e?me(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,ve=(e,n,t,o)=>{for(var r=n,s=e.length-1,l;s>=0;s--)(l=e[s])&&(r=l(r)||r);return r},F=(e,n)=>(t,o)=>n(t,o,e),j=(e,n,t)=>ge(e,typeof n!="symbol"?n+"":n,t);const he="SHEET_SORT_PLUGIN";let h=class extends q{constructor(e=E,n,t){super(),this._config=e,this._injector=n,this._configService=t;const{...o}=H({},E,this._config);this._configService.setConfig(de,o)}onStarting(){[[v],[m]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(v)}};j(h,"type",W.UNIVER_SHEET);j(h,"pluginName",he);h=ve([J(Y,X),F(1,R(z)),F(2,K)],h);export{h as C,O as M,m as g,f as m};
