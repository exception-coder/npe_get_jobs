import{M as b,ab as P,L as E,v as O,ac as j,V as L,J as ne,b8 as Ne,a5 as $,S as re,e7 as X,ao as xe,F as $e,w as B,m as Te,l as Le,n as ze,d as me,O as Be,o as ke,z as He,ag as fe,f as Q,ak as De,cT as se,U as ie,e8 as Ve,H as We,I as U,B as je,x as ge,u as Qe}from"./TeamSpreadsheet-DqPQXi__.js";import{nJ as D,s as Ge,jF as _e,ks as Ie,k1 as Ce,z as Je,o7 as qe,np as pe,lG as Pe,je as Ze,kz as Ye,h as Xe,ky as Ke,jS as et,lg as tt,k5 as rt,e$ as nt,k3 as st,jt as oe,kx as it,kr as ot,jE as lt,jR as at,G as dt,km as ut,iI as ct,nb as ht,de as mt,dq as ft}from"./index--BQDx9CP.js";var gt=Object.defineProperty,_t=(e,t,r)=>t in e?gt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,_=(e,t,r)=>_t(e,typeof t!="symbol"?t+"":t,r);const Re="sheet.mutation.set-filter-range",we="sheet.mutation.set-filter-criteria",ve="sheet.mutation.remove-filter",Fe="sheet.mutation.re-calc-filter",be=new Set([Re,we,ve,Fe]);var x=(e=>(e[e.VALUES=0]="VALUES",e[e.COLORS=1]="COLORS",e[e.CONDITIONS=2]="CONDITIONS",e))(x||{}),A=(e=>(e.EQUAL="equal",e.GREATER_THAN="greaterThan",e.GREATER_THAN_OR_EQUAL="greaterThanOrEqual",e.LESS_THAN="lessThan",e.LESS_THAN_OR_EQUAL="lessThanOrEqual",e.NOT_EQUALS="notEqual",e))(A||{});const It={operator:A.GREATER_THAN,fn:(e,t)=>z(e)?e>t:!1},Ct={operator:A.GREATER_THAN_OR_EQUAL,fn:(e,t)=>z(e)?e>=t:!1},pt={operator:A.LESS_THAN,fn:(e,t)=>z(e)?e<t:!1},Rt={operator:A.LESS_THAN_OR_EQUAL,fn:(e,t)=>z(e)?e<=t:!1},wt={operator:A.EQUAL,fn:(e,t)=>z(e)?e===t:!1},Se={operator:A.NOT_EQUALS,fn:(e,t)=>{if(typeof t=="string"){if(t===" ")return e!=null;const r=Ue(e);return r&&St(t)?!fe(t).test(r):r!==t}return z(e)?e!==t:!0}},Me=new Map([]),vt=[It,Ct,pt,Rt,wt,Se];vt.forEach(e=>{Me.set(e.operator,e)});function Ft(e){return!!e}const bt={fn:(e,t)=>{const r=Ue(e);return r===null?t==="":fe(t).test(r)}};function le(e){return e?Me.get(e):bt}function z(e){return typeof e=="number"}function ae(e){return!!(typeof e=="number"||typeof e=="string"&&Ve(e))}function Ue(e){return typeof e=="boolean"||e==null?null:typeof e=="string"?e:e.toString()}function St(e){return typeof e=="number"?!1:e.indexOf("*")!==-1||e.indexOf("?")!==-1}const K=()=>new Set;class G extends L{constructor(t,r,n){super(),_(this,"_filteredOutRows$",new $(K())),_(this,"filteredOutRows$",this._filteredOutRows$.asObservable()),_(this,"_hasCriteria$",new $(!1)),_(this,"hasCriteria$",this._hasCriteria$.asObservable()),_(this,"_filterColumnByIndex",new Map),_(this,"_alreadyFilteredOutRows",K()),_(this,"_range"),this.unitId=t,this.subUnitId=r,this._worksheet=n}get filteredOutRows(){return this._filteredOutRows$.getValue()}set filteredOutRows(t){this._alreadyFilteredOutRows=t,this._filteredOutRows$.next(t)}dispose(){super.dispose(),this._filteredOutRows$.complete(),this._hasCriteria$.complete(),this._worksheet=null}serialize(){const t={ref:re.clone(this._range),filterColumns:this._getAllFilterColumns(!0).sort(([r],[n])=>r-n).map(([r,n])=>n.serialize())};return this._alreadyFilteredOutRows&&(t.cachedFilteredOut=Array.from(this._alreadyFilteredOutRows).sort()),t}static deserialize(t,r,n,s){const i=new G(t,r,n);return i._dump(s),i}_dump(t){var r;this.setRange(t.ref),(r=t.filterColumns)==null||r.filter(n=>!(!n.filters&&!n.colorFilters&&!n.customFilters)).forEach(n=>this._setCriteriaWithoutReCalc(n.colId,n)),t.cachedFilteredOut?(this._alreadyFilteredOutRows=new Set(t.cachedFilteredOut),this._emit()):t.filterColumns&&t.filterColumns.length>0&&(this._reCalcAllColumns(),this._emit()),this._emitHasCriteria()}isRowFiltered(t){return this._alreadyFilteredOutRows.has(t)}getRange(){if(!this._range)throw new Error("[FilterModel] could not get range before a range is set!");return this._range}getFilteredOutRowsExceptCol(t){return this._getAllFilterColumns(!0).filter(([r])=>r!==t).reduce((r,[,n])=>{const s=n.calc({getAlreadyFilteredOutRows:()=>r});return s?X(r,s):r},new Set)}setRange(t){this._range=t,this._getAllFilterColumns(!0).forEach(([r,n])=>{n.setRangeAndColumn({startRow:t.startRow,endRow:t.endRow,startColumn:r,endColumn:r},r)})}setCriteria(t,r,n=!1){if(!this._range)throw new Error("[FilterModel] could not set criteria before a range is set!");if(!r){this._removeCriteria(t),this._rebuildAlreadyFilteredOutRowsWithCache(),n&&this._reCalcAllColumns(),this._emit(),this._emitHasCriteria();return}this._setCriteriaWithoutReCalc(t,r),n&&(this._rebuildAlreadyFilteredOutRowsWithCache(),this._getAllFilterColumns().forEach(s=>s.__clearCache()),this._reCalcWithNoCacheColumns(),this._emit(),this._emitHasCriteria())}getAllFilterColumns(){return this._getAllFilterColumns(!0)}getFilterColumn(t){var r;return(r=this._filterColumnByIndex.get(t))!=null?r:null}reCalc(){this._reCalcAllColumns(),this._emit()}_getAllFilterColumns(t=!1){const r=Array.from(this._filterColumnByIndex.entries());return t?r:r.map(([n,s])=>s)}_reCalcAllColumns(){this._alreadyFilteredOutRows=K(),this._getAllFilterColumns().forEach(t=>t.__clearCache()),this._reCalcWithNoCacheColumns()}_setCriteriaWithoutReCalc(t,r){const n=this._range;if(!n)throw new Error("[FilterModel] could not set criteria before a range is set!");const{startColumn:s,endColumn:i}=n;if(t>i||t<s)throw new Error(`[FilterModel] could not set criteria on column ${t} which is out of range!`);let o;this._filterColumnByIndex.has(t)?o=this._filterColumnByIndex.get(t):(o=new Mt(this.unitId,this.subUnitId,this._worksheet,r,{getAlreadyFilteredOutRows:()=>this._alreadyFilteredOutRows}),o.setRangeAndColumn(n,t),this._filterColumnByIndex.set(t,o)),o.setCriteria(r)}_removeCriteria(t){const r=this._filterColumnByIndex.get(t);r&&(r.dispose(),this._filterColumnByIndex.delete(t))}_emit(){this._filteredOutRows$.next(this._alreadyFilteredOutRows)}_emitHasCriteria(){this._hasCriteria$.next(this._filterColumnByIndex.size>0)}_rebuildAlreadyFilteredOutRowsWithCache(){const t=this._getAllFilterColumns().filter(r=>r.hasCache()).reduce((r,n)=>X(r,n.filteredOutRows),new Set);this._alreadyFilteredOutRows=t}_reCalcWithNoCacheColumns(){const t=this._getAllFilterColumns().filter(r=>!r.hasCache());for(const r of t){const n=r.reCalc();n&&(this._alreadyFilteredOutRows=X(this._alreadyFilteredOutRows,n))}}}class Mt extends L{constructor(t,r,n,s,i){super(),_(this,"_filteredOutRows",null),_(this,"_filterFn",null),_(this,"_range",null),_(this,"_column",0),_(this,"_filterBy",x.VALUES),this.unitId=t,this.subUnitId=r,this._worksheet=n,this._criteria=s,this._filterColumnContext=i}get filteredOutRows(){return this._filteredOutRows}get filterBy(){return this._filterBy}dispose(){super.dispose(),this._filteredOutRows=null}__clearCache(){this._filteredOutRows=null}serialize(){if(!this._criteria)throw new Error("[FilterColumn]: could not serialize without a filter column!");return ne.deepClone({...this._criteria,colId:this._column})}hasCache(){return this._filteredOutRows!==null}setRangeAndColumn(t,r){this._range=t,this._column=r}setCriteria(t){this._criteria=t,this._generateFilterFn(),this._filteredOutRows=null}getColumnData(){return ne.deepClone(this._criteria)}reCalc(){return this._filteredOutRows=this.calc(this._filterColumnContext),this._filteredOutRows}calc(t){if(!this._filterFn)throw new Error("[FilterColumn] cannot calculate without a filter fn!");if(!this._range)throw new Error("[FilterColumn] cannot calculate without a range!");if(typeof this._column!="number")throw new TypeError("[FilterColumn] cannot calculate without a column offset!");const r=this._column,n={startColumn:r,endColumn:r,startRow:this._range.startRow+1,endRow:this._range.endRow},s=new Set,i=t.getAlreadyFilteredOutRows();for(const o of this._worksheet.iterateByColumn(n,!1,!1)){const{row:a,rowSpan:l,col:u}=o;if(!(i.has(a)&&(!l||l===1))&&!(this._filterBy===x.VALUES?this._filterFn(Ne(this._worksheet.getCell(a,u))):this._filterBy===x.COLORS?this._filterFn(this._worksheet.getComposedCellStyle(a,u)):this._filterFn(Tt(this._worksheet,a,u)))&&(s.add(a),l))for(let d=1;d<l;d++)s.add(a+d)}return s}_generateFilterFn(){this._criteria&&(this._filterFn=Ut(this._criteria),this._filterBy=this._criteria.filters?x.VALUES:this._criteria.colorFilters?x.COLORS:x.CONDITIONS)}}function Ut(e){if(e.filters)return Et(e.filters);if(e.colorFilters)return yt(e.colorFilters);if(e.customFilters)return Ot(e.customFilters);throw new Error("[FilterModel]: other types of filters are not supported yet.")}function Et(e){const t=!!e.blank,r=new Set(e.filters);return n=>n===void 0||n===""?t:r.has(typeof n=="string"?n:`${n}`)}function yt(e){if(e.cellFillColors){const t=new Set(e.cellFillColors);return r=>{var n;if(!r||!((n=r.bg)!=null&&n.rgb))return!!t.has(null);const s=new ie(r.bg.rgb).toRgbString();return t.has(s)}}if(e.cellTextColors){const t=new Set(e.cellTextColors);return r=>{var n;if(!r||!((n=r.cl)!=null&&n.rgb))return!!t.has(nt);const s=new ie(r.cl.rgb).toRgbString();return t.has(s)}}throw new Error("[FilterModel]: color filters are not supported yet.")}function Ot(e){const t=e.customFilters.map(r=>$t(r));return xt(t)?e.and?At(t):Nt(t):t[0]}function At(e){const[t,r]=e;return n=>t(n)&&r(n)}function Nt(e){const[t,r]=e;return n=>t(n)||r(n)}function xt(e){return e.length===2}function $t(e){const t=e.val;if(e.operator===A.NOT_EQUALS&&!ae(t))return n=>Se.fn(n,t);if(Ft(e.operator)){if(!ae(t))return()=>!1;const n=le(e.operator),s=Number(t);return i=>n.fn(i,s)}const r=le(e.operator);return n=>r.fn(n,t)}function Tt(e,t,r){const n=e.getCell(t,r);if(!n)return null;const s=e.getCellRaw(t,r);return n&&!s?de(n):s?n.t===Q.NUMBER&&typeof n.v=="string"?s.v:n.t===Q.NUMBER?Number(s.v):de(s):null}function de(e){var t,r;const n=(r=(t=e.p)==null?void 0:t.body)==null?void 0:r.dataStream;if(n)return n.trimEnd();const s=e.v;return typeof s=="string"?e.t===Q.BOOLEAN?s.toUpperCase():s:typeof s=="number"?e.t===Q.BOOLEAN?s?"TRUE":"FALSE":s:typeof s=="boolean"?s?"TRUE":"FALSE":""}var Lt=(e,t,r,n)=>{for(var s=t,i=e.length-1,o;i>=0;i--)(o=e[i])&&(s=o(s)||s);return s},ee=(e,t)=>(r,n)=>t(r,n,e);const Ee="SHEET_FILTER_PLUGIN";let F=class extends L{constructor(e,t,r){super(),_(this,"_filterModels",new Map),_(this,"_loadedUnitId$",new $(null)),_(this,"loadedUnitId$",this._loadedUnitId$.asObservable()),_(this,"_errorMsg$",new $(null)),_(this,"errorMsg$",this._errorMsg$.asObservable()),_(this,"_activeFilterModel$",new $(null)),_(this,"activeFilterModel$",this._activeFilterModel$.asObservable()),this._resourcesManagerService=e,this._univerInstanceService=t,this._commandService=r,this._initModel(),this._initActiveFilterModel()}get activeFilterModel(){return this._activeFilterModel$.getValue()}ensureFilterModel(e,t){const r=this.getFilterModel(e,t);if(r)return r;const n=this._univerInstanceService.getUniverSheetInstance(e);if(!n)throw new Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing workbook ${e}!`);const s=n.getSheetBySheetId(t);if(!s)throw new Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing worksheet ${t}!`);const i=new G(e,t,s);return this._cacheFilterModel(e,t,i),i}getFilterModel(e,t){var r,n;return(n=(r=this._filterModels.get(e))==null?void 0:r.get(t))!=null?n:null}removeFilterModel(e,t){const r=this.getFilterModel(e,t);return r?(r.dispose(),this._filterModels.get(e).delete(t),!0):!1}setFilterErrorMsg(e){this._errorMsg$.next(e)}_updateActiveFilterModel(){let e;try{if(e=this._univerInstanceService.getCurrentUnitForType(B.UNIVER_SHEET),!e){this._activeFilterModel$.next(null);return}}catch(i){console.error("[SheetsFilterService]: could not get active workbook!",i);return}const t=e.getActiveSheet(!0);if(!t){this._activeFilterModel$.next(null);return}const r=t.getUnitId(),n=t.getSheetId(),s=this.getFilterModel(r,n);this._activeFilterModel$.next(s)}_initActiveFilterModel(){this.disposeWithMe(Te(Le(this._commandService.onCommandExecuted.bind(this._commandService)).pipe(ze(([e])=>e.type===b.MUTATION&&be.has(e.id))),this._univerInstanceService.getCurrentTypeOfUnit$(B.UNIVER_SHEET).pipe(Ge(e=>{var t;return(t=e==null?void 0:e.activeSheet$)!=null?t:De(null)}))).subscribe(()=>this._updateActiveFilterModel()))}_serializeAutoFiltersForUnit(e){const t=this._filterModels.get(e);if(!t)return"{}";const r={};return t.forEach((n,s)=>{r[s]=n.serialize()}),JSON.stringify(r)}_deserializeAutoFiltersForUnit(e,t){const r=this._univerInstanceService.getUniverSheetInstance(e);Object.keys(t).forEach(n=>{const s=t[n],i=G.deserialize(e,n,r.getSheetBySheetId(n),s);this._cacheFilterModel(e,n,i)})}dispose(){super.dispose(),this._loadedUnitId$.complete(),this._errorMsg$.complete(),this._activeFilterModel$.complete(),this._filterModels.forEach(e=>{e.forEach(t=>t.dispose()),e.clear()}),this._filterModels.clear()}_initModel(){this._resourcesManagerService.registerPluginResource({pluginName:Ee,businesses:[B.UNIVER_SHEET],toJson:e=>this._serializeAutoFiltersForUnit(e),parseJson:e=>JSON.parse(e),onLoad:(e,t)=>{this._deserializeAutoFiltersForUnit(e,t),this._loadedUnitId$.next(e),this._updateActiveFilterModel()},onUnLoad:e=>{const t=this._filterModels.get(e);t&&(t.forEach(r=>r.dispose()),this._filterModels.delete(e))}})}_cacheFilterModel(e,t,r){this._filterModels.has(e)||this._filterModels.set(e,new Map),this._filterModels.get(e).set(t,r)}};F=Lt([ee(0,We),ee(1,O),ee(2,E)],F);const C={id:Re,type:b.MUTATION,handler:(e,t)=>{const{subUnitId:r,unitId:n,range:s}=t;return e.get(F).ensureFilterModel(n,r).setRange(s),!0}},p={id:we,type:b.MUTATION,handler:(e,t)=>{const{subUnitId:r,unitId:n,criteria:s,col:i,reCalc:o=!0}=t,a=e.get(F).getFilterModel(n,r);return a?(a.setCriteria(i,s,o),!0):!1}},M={id:ve,type:b.MUTATION,handler:(e,t)=>{const{unitId:r,subUnitId:n}=t;return e.get(F).removeFilterModel(r,n)}},k={id:Fe,type:b.MUTATION,handler:(e,t)=>{const{unitId:r,subUnitId:n}=t,s=e.get(F).getFilterModel(r,n);return s?(s.reCalc(),!0):!1}},zt={id:"sheet.command.set-filter-range",type:b.COMMAND,handler:(e,t)=>{const r=e.get(F),n=e.get(E),s=e.get(P),i=e.get(O),{unitId:o,subUnitId:a,range:l}=t;if(!D(i,t)||r.getFilterModel(o,a))return!1;if(l.endRow===l.startRow){const c=e.get(xe),m=e.get($e);return c.emit(m.t("sheets-filter.command.not-valid-filter-range")),!1}const u={id:C.id,params:{unitId:o,subUnitId:a,range:l}},d=n.syncExecuteCommand(u.id,u.params);return d&&s.pushUndoRedo({unitID:o,undoMutations:[{id:M.id,params:{unitId:o,subUnitId:a}}],redoMutations:[u]}),d}},Bt={id:"sheet.command.remove-sheet-filter",type:b.COMMAND,handler:(e,t)=>{const r=e.get(O),n=e.get(F),s=e.get(E),i=e.get(P),o=D(r,t);if(!o)return!1;const{unitId:a,subUnitId:l}=o,u=n.getFilterModel(a,l);if(!u)return!1;const d=u==null?void 0:u.serialize(),c=kt(a,l,d),m=s.syncExecuteCommand(M.id,{unitId:a,subUnitId:l});return m&&i.pushUndoRedo({unitID:a,undoMutations:c,redoMutations:[{id:M.id,params:{unitId:a,subUnitId:l}}]}),m}},Yt={id:"sheet.command.smart-toggle-filter",type:b.COMMAND,handler:async e=>{const t=e.get(O),r=e.get(F),n=e.get(E),s=t.getCurrentUnitForType(B.UNIVER_SHEET),i=s==null?void 0:s.getActiveSheet();if(!i||!s)return!1;const o=s.getUnitId(),a=i.getSheetId();if(r.getFilterModel(o,a))return n.executeCommand(Bt.id,{unitId:o,subUnitId:a});const l=e.get(Je).getCurrentLastSelection();if(!l)return!1;const u=l.range,d=qe(l)?pe(u,{left:!0,right:!0,up:!0,down:!0},i):u;return n.executeCommand(zt.id,{unitId:o,subUnitId:a,range:d})}},Xt={id:"sheet.command.set-filter-criteria",type:b.COMMAND,handler:(e,t)=>{const r=e.get(F),n=e.get(E),s=e.get(P),{unitId:i,subUnitId:o,col:a,criteria:l}=t,u=r.getFilterModel(i,o);if(!u)return!1;const d=u.getRange();if(!d||a<d.startColumn||a>d.endColumn)return!1;const c=u.getFilterColumn(a),m=Dt(i,o,a,c),g={id:p.id,params:{unitId:i,subUnitId:o,col:a,criteria:l}},I=n.syncExecuteCommand(g.id,g.params);return I&&s.pushUndoRedo({unitID:i,undoMutations:[m],redoMutations:[g]}),I}},Kt={id:"sheet.command.clear-filter-criteria",type:b.COMMAND,handler:(e,t)=>{const r=e.get(F),n=e.get(P),s=e.get(E),i=e.get(O),o=D(i,t);if(!o)return!1;const{unitId:a,subUnitId:l}=o,u=r.getFilterModel(o.unitId,o.subUnitId);if(!u)return!1;const d=u.serialize(),c=ye(a,l,d),m=Ht(a,l,d);return j(m,s).result?(n.pushUndoRedo({unitID:a,undoMutations:c,redoMutations:m}),!0):!1}},er={id:"sheet.command.re-calc-filter",type:b.COMMAND,handler:(e,t)=>{const r=e.get(F),n=e.get(E),s=e.get(O),i=D(s,t);if(!i)return!1;const{unitId:o,subUnitId:a}=i;return r.getFilterModel(i.unitId,i.subUnitId)?n.executeCommand(k.id,{unitId:o,subUnitId:a}):!1}};function kt(e,t,r){const n=[],s={id:C.id,params:{unitId:e,subUnitId:t,range:r.ref}};return n.push(s),ye(e,t,r).forEach(i=>n.push(i)),n}function ye(e,t,r){var n;const s=[];return(n=r.filterColumns)==null||n.forEach(i=>{const o={id:p.id,params:{unitId:e,subUnitId:t,col:i.colId,criteria:i}};s.push(o)}),s}function Ht(e,t,r){var n;const s=[];return(n=r.filterColumns)==null||n.forEach(i=>{const o={id:p.id,params:{unitId:e,subUnitId:t,col:i.colId,criteria:null}};s.push(o)}),s}function Dt(e,t,r,n){if(!n)return{id:p.id,params:{unitId:e,subUnitId:t,col:r,criteria:null}};const s=n.serialize();return{id:p.id,params:{unitId:e,subUnitId:t,col:r,criteria:s}}}const Oe="sheets-filter.config",ue={};function Vt(e,t){for(let r=0;r<e.length;r++){let n=r;if(e[r])for(let s=r+1;s<e.length;s++)e[n]&&e[s]&&t(e[n],e[s])&&(e[n]=null,n=s)}return e.filter(r=>r!==null)}function T(e){return Vt(e,(t,r)=>t.id===p.id&&r.id===p.id&&t.params.unitId===r.params.unitId&&t.params.subUnitId===r.params.subUnitId&&t.params.col===r.params.col)}var Wt=(e,t,r,n)=>{for(var s=t,i=e.length-1,o;i>=0;i--)(o=e[i])&&(s=o(s)||s);return s},N=(e,t)=>(r,n)=>t(r,n,e);let H=class extends L{constructor(e,t,r,n,s,i,o){super(),_(this,"_disposableCollection",new me),this._commandService=e,this._sheetInterceptorService=t,this._sheetsFilterService=r,this._univerInstanceService=n,this._refRangeService=s,this._dataSyncPrimaryController=i,this._zebraCrossingCacheController=o,this._initCommands(),this._initRowFilteredInterceptor(),this._initInterceptors(),this._commandExecutedListener(),this._initErrorHandling(),this._initZebraCrossingCacheListener()}_initZebraCrossingCacheListener(){this.disposeWithMe(this._sheetsFilterService.activeFilterModel$.subscribe(e=>{e&&this.disposeWithMe(e.filteredOutRows$.subscribe(()=>{this._zebraCrossingCacheController.updateZebraCrossingCache(e.unitId,e.subUnitId)}))}))}_initCommands(){[p,C,k,M].forEach(e=>{var t;this.disposeWithMe(this._commandService.registerCommand(e)),(t=this._dataSyncPrimaryController)==null||t.registerSyncingMutations(e)})}_initInterceptors(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:e=>this._getUpdateFilter(e)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===Pe.id){const t=e.params,r=t.subUnitId,n=t.unitId;if(!r||!n)return;this._registerRefRange(n,r)}if(e.id===C.id){const t=e.params,r=t.subUnitId,n=t.unitId;if(!r||!n)return;this._registerRefRange(t.unitId,t.subUnitId)}})),this.disposeWithMe(this._sheetsFilterService.loadedUnitId$.subscribe(e=>{if(e){const t=this._univerInstanceService.getUniverSheetInstance(e),r=t==null?void 0:t.getActiveSheet();r&&this._registerRefRange(e,r.getSheetId())}}))}_registerRefRange(e,t){var r;this._disposableCollection.dispose();const n=this._univerInstanceService.getUniverSheetInstance(e),s=n==null?void 0:n.getSheetBySheetId(t);if(!n||!s)return;const i=(r=this._sheetsFilterService.getFilterModel(e,t))==null?void 0:r.getRange(),o=a=>{switch(a.id){case at.id:{const l=a.params,u=l.unitId||e,d=l.subUnitId||t;return this._handleInsertRowCommand(l,u,d)}case lt.id:{const l=a.params,u=l.unitId||e,d=l.subUnitId||t;return this.handleInsertColCommand(l.range,u,d)}case ot.id:{const l=a.params;return this.handleRemoveColCommand(l.range,e,t)}case it.id:{const l=a.params;return this._handleRemoveRowCommand(l,e,t)}case oe.MoveColsCommandId:{const l=a.params;return this.handleMoveColsCommand({fromRange:l.fromRange,toRange:l.toRange},e,t)}case oe.MoveRowsCommandId:{const l=a.params;return this._handleMoveRowsCommand(l,e,t)}case st.id:{const l=a.params;return this._handleMoveRangeCommand(l,e,t)}}return{redos:[],undos:[]}};i&&this._disposableCollection.add(this._refRangeService.registerRefRange(i,o,e,t))}_getUpdateFilter(e){const{id:t}=e;switch(t){case Ye.id:{const r=e.params;return this._handleRemoveSheetCommand(r,r.unitId,r.subUnitId)}case Ze.id:{const r=e.params,{targetSubUnitId:n,unitId:s,subUnitId:i}=r;return!s||!i||!n?this._handleNull():this._handleCopySheetCommand(s,i,n)}}return{redos:[],undos:[]}}handleInsertColCommand(e,t,r){var n;const s=this._sheetsFilterService.getFilterModel(t,r),i=(n=s==null?void 0:s.getRange())!=null?n:null;if(!s||!i)return this._handleNull();const{startColumn:o,endColumn:a}=i,{startColumn:l,endColumn:u}=e,d=u-l+1;if(u>a)return this._handleNull();const c=[],m=[],g=l,I={unitId:t,subUnitId:r,range:{...i,startColumn:l<=o?o+d:o,endColumn:a+d}},w={unitId:t,subUnitId:r,range:i};c.push({id:C.id,params:I}),m.push({id:C.id,params:w});const R=s.getAllFilterColumns().filter(h=>h[0]>=g);if(R.length!==0){const{newRange:h,oldRange:f}=this._moveCriteria(t,r,R,d);c.push(...f.redos,...h.redos),m.push(...h.undos,...f.undos)}return{redos:T(c),undos:T(m)}}_handleInsertRowCommand(e,t,r){var n;const s=this._sheetsFilterService.getFilterModel(t,r),i=(n=s==null?void 0:s.getRange())!=null?n:null;if(!s||!i)return this._handleNull();const{startRow:o,endRow:a}=i,{startRow:l,endRow:u}=e.range,d=u-l+1;if(u>a)return this._handleNull();const c=[],m=[],g={unitId:t,subUnitId:r,range:{...i,startRow:l<=o?o+d:o,endRow:a+d}},I={unitId:t,subUnitId:r,range:i};return c.push({id:C.id,params:g}),m.push({id:C.id,params:I}),{redos:T(c),undos:T(m)}}handleRemoveColCommand(e,t,r){var n;const s=this._sheetsFilterService.getFilterModel(t,r),i=(n=s==null?void 0:s.getRange())!=null?n:null;if(!s||!i)return this._handleNull();const{startColumn:o,endColumn:a}=i,{startColumn:l,endColumn:u}=e;if(l>a)return this._handleNull();const d=[],c=[],m=u<o?0:Math.min(u,a)-Math.max(l,o)+1,g=u-l+1,I=s.getAllFilterColumns();I.forEach(h=>{const[f,v]=h;f<=u&&f>=l&&(d.push({id:p.id,params:{unitId:t,subUnitId:r,col:f,criteria:null}}),c.push({id:p.id,params:{unitId:t,subUnitId:r,col:f,criteria:{...v.serialize(),colId:f}}}))});const w=I.filter(h=>{const[f,v]=h;return f>u});let R={undos:[],redos:[]};if(w.length>0){const{oldRange:h,newRange:f}=this._moveCriteria(t,r,w,-g);R=f,d.push(...h.redos),c.unshift(...h.undos)}if(m===a-o+1){const h={unitId:t,subUnitId:r};d.push({id:M.id,params:h}),c.unshift({id:C.id,params:{range:i,unitId:t,subUnitId:r}})}else{const h=o<=l?o:m===0?o-g:l,f=o<=l?a-m:a-g,v={unitId:t,subUnitId:r,range:{...i,startColumn:h,endColumn:f}};d.push({id:C.id,params:v}),c.unshift({id:C.id,params:{range:i,unitId:t,subUnitId:r}}),d.push(...R.redos),c.unshift(...R.undos)}return{undos:c,redos:d}}_handleRemoveRowCommand(e,t,r){var n;const s=this._sheetsFilterService.getFilterModel(t,r);if(!s)return this._handleNull();const i=s.getRange(),{startRow:o,endRow:a}=i,{startRow:l,endRow:u}=e.range;if(l>a)return this._handleNull();if(u<o)return{undos:[{id:C.id,params:{range:i,unitId:t,subUnitId:r}}],redos:[{id:C.id,params:{range:{...i,startRow:o-(u-l+1),endRow:a-(u-l+1)},unitId:t,subUnitId:r}}]};const d=[],c=[],m=s.getAllFilterColumns(),g=o<=u&&o>=l;c.push({id:C.id,params:{range:i,unitId:t,subUnitId:r}});const I=Math.min(u,a)-Math.max(l,o)+1;if(I===a-o+1||g){const w={unitId:t,subUnitId:r};d.push({id:M.id,params:w}),m.forEach(R=>{const[h,f]=R,v={unitId:t,subUnitId:r,col:h,criteria:{...f.serialize(),colId:h}};c.push({id:p.id,params:v})})}else{const w=(n=this._univerInstanceService.getUniverSheetInstance(t))==null?void 0:n.getSheetBySheetId(r);if(!w)return this._handleNull();const R=[];for(let S=l;S<=u;S++)w.getRowFiltered(S)&&R.push(S);const h=Math.min(o,l),f=h+(a-o)-I+R.length,v={unitId:t,subUnitId:r,range:{...i,startRow:h,endRow:f}};d.push({id:C.id,params:v})}return{undos:T(c),redos:T(d)}}handleMoveColsCommand({fromRange:e,toRange:t},r,n){var s;const i=this._sheetsFilterService.getFilterModel(r,n),o=(s=i==null?void 0:i.getRange())!=null?s:null;if(!i||!o)return this._handleNull();const{startColumn:a,endColumn:l}=o;if(e.endColumn<a&&t.startColumn<=a||e.startColumn>l&&t.endColumn>l)return this._handleNull();const u=[],d=[],c={};for(let h=a;h<=l;h++)c[h]={colIndex:h,filter:i.getFilterColumn(h)};se(e.startColumn,e.endColumn-e.startColumn+1,t.startColumn,c);let m=o.startColumn,g=o.endColumn;a>=e.startColumn&&a<=e.endColumn&&t.startColumn>e.startColumn&&e.endColumn<l&&(m=e.endColumn+1),l>=e.startColumn&&l<=e.endColumn&&t.startColumn<e.startColumn&&e.startColumn>a&&(g=e.startColumn-1);const I=Object.keys(c).map(h=>Number(h)),w=I.find(h=>c[h].colIndex===g),R=I.find(h=>c[h].colIndex===m);if(I.forEach(h=>{var f,v;const{colIndex:S,filter:Z}=c[h],y=h;if(Z){if(y>=R&&y<=w){const Y={unitId:r,subUnitId:n,col:y,criteria:{...Z.serialize(),colId:y}},Ae={unitId:r,subUnitId:n,col:y,criteria:i.getFilterColumn(y)?{...(f=i.getFilterColumn(y))==null?void 0:f.serialize(),colId:y}:null};u.push({id:p.id,params:Y}),d.push({id:p.id,params:Ae})}if(!((v=c[S])!=null&&v.filter)){const Y={unitId:r,subUnitId:n,col:S,criteria:null};u.push({id:p.id,params:Y}),d.push({id:p.id,params:{unitId:r,subUnitId:n,col:S,criteria:{...Z.serialize(),colId:S}}})}}}),a!==R||l!==w){const h={unitId:r,subUnitId:n,range:{...o,startColumn:R,endColumn:w}};u.unshift({id:C.id,params:h}),d.unshift({id:C.id,params:{range:o,unitId:r,subUnitId:n}})}return{undos:d,redos:u}}_handleMoveRowsCommand(e,t,r){var n;const s=this._sheetsFilterService.getFilterModel(t,r),i=(n=s==null?void 0:s.getRange())!=null?n:null;if(!s||!i)return this._handleNull();const{startRow:o,endRow:a}=i,{fromRange:l,toRange:u}=e;if(l.endRow<o&&u.startRow<=o||l.startRow>a&&u.endRow>a)return this._handleNull();const d=[],c=[],m={};for(let f=o;f<=a;f++)m[f]={oldIndex:f};const g=o;let I=a;a>=l.startRow&&a<=l.endRow&&u.startRow<l.startRow&&l.startRow>o&&(I=l.startRow-1),se(l.startRow,l.endRow-l.startRow+1,u.startRow,m);const w=Object.keys(m).map(f=>Number(f)),R=w.find(f=>m[f].oldIndex===I),h=w.find(f=>m[f].oldIndex===g);if(o!==h||a!==R){const f={unitId:t,subUnitId:r,range:{...i,startRow:h,endRow:R}};d.push({id:C.id,params:f},{id:k.id,params:{unitId:t,subUnitId:r}}),c.push({id:C.id,params:{range:i,unitId:t,subUnitId:r}},{id:k.id,params:{unitId:t,subUnitId:r}})}return{redos:d,undos:c}}_handleMoveRangeCommand(e,t,r){const{fromRange:n,toRange:s}=e,i=this._sheetsFilterService.getFilterModel(t,r);if(!i)return this._handleNull();const o=i.getRange();if(!o)return this._handleNull();const a=[],l=[];if(re.contains(n,o)){const u=o.startRow-n.startRow,d=o.startColumn-n.startColumn,c={startRow:s.startRow+u,startColumn:s.startColumn+d,endRow:s.startRow+u+(o.endRow-o.startRow),endColumn:s.startColumn+d+(o.endColumn-o.startColumn)},m={id:M.id,params:{unitId:t,subUnitId:r}},g={id:C.id,params:{unitId:t,subUnitId:r,range:c}},I={id:C.id,params:{unitId:t,subUnitId:r,range:o}};a.push(m,g),l.push(m,I);const w=i.getAllFilterColumns(),R=s.startColumn-n.startColumn;w.forEach(h=>{const[f,v]=h;v&&(a.push({id:p.id,params:{unitId:t,subUnitId:r,col:f+R,criteria:{...v.serialize(),colId:f+R}}}),l.push({id:p.id,params:{unitId:t,subUnitId:r,col:f,criteria:{...v.serialize(),colId:f}}}))})}else if(re.intersects(s,o)){const u={...o,endRow:Math.max(o.endRow,s.endRow)};a.push({id:C.id,params:{unitId:t,subUnitId:r,range:u}}),l.push({id:C.id,params:{unitId:t,subUnitId:r,range:o}})}return{redos:a,undos:l}}_handleRemoveSheetCommand(e,t,r){const n=this._sheetsFilterService.getFilterModel(t,r);if(!n)return this._handleNull();const s=n.getRange();if(!s)return this._handleNull();const i=[],o=[];return n.getAllFilterColumns().forEach(([a,l])=>{o.push({id:p.id,params:{unitId:t,subUnitId:r,col:a,criteria:{...l.serialize(),colId:a}}})}),i.push({id:M.id,params:{unitId:t,subUnitId:r,range:s}}),o.unshift({id:C.id,params:{range:s,unitId:t,subUnitId:r}}),{undos:o,redos:i}}_handleCopySheetCommand(e,t,r){const n=this._sheetsFilterService.getFilterModel(e,t);if(!n)return this._handleNull();const s=n.getRange();if(!s)return this._handleNull();const i=[],o=[],a=[],l=[];return n.getAllFilterColumns().forEach(([u,d])=>{i.push({id:p.id,params:{unitId:e,subUnitId:r,col:u,criteria:{...d.serialize(),colId:u}}}),a.push({id:p.id,params:{unitId:e,subUnitId:r,col:u,criteria:null}})}),a.push({id:M.id,params:{unitId:e,subUnitId:r,range:s}}),i.unshift({id:C.id,params:{range:s,unitId:e,subUnitId:r}}),{undos:o,redos:i,preUndos:a,preRedos:l}}_handleNull(){return{redos:[],undos:[]}}_initRowFilteredInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(Xe.ROW_FILTERED,{handler:(e,t)=>{var r,n;return e?!0:(n=(r=this._sheetsFilterService.getFilterModel(t.unitId,t.subUnitId))==null?void 0:r.isRowFiltered(t.row))!=null?n:!1}}))}_moveCriteria(e,t,r,n){const s={unitId:e,subUnitId:t,criteria:null,col:-1},i=[],o=[],a=[],l=[];return r.forEach(u=>{const[d,c]=u;o.push({id:p.id,params:{...s,col:d}}),i.push({id:p.id,params:{...s,col:d,criteria:{...c.serialize(),colId:d}}})}),r.forEach(u=>{const[d,c]=u;l.push({id:p.id,params:{...s,col:d+n,criteria:{...c.serialize(),colId:d+n}}}),a.push({id:p.id,params:{...s,col:d+n,criteria:null}})}),{newRange:{redos:l,undos:a},oldRange:{redos:o,undos:i}}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((e,t)=>{var r,n;const{unitId:s,subUnitId:i}=e.params||{},o=this._sheetsFilterService.getFilterModel(s,i);if(!o)return;const a=Array.from(o.filteredOutRows).sort((d,c)=>d-c),l=[];let u=!1;if(e.id===Ke.id){const{startRow:d,endRow:c}=e.params.range,m=a.filter(g=>g>=d&&g<=c);a.forEach(g=>{if(g<d)l.push(g);else if(u=!0,g<=c){const I=Math.max(d,l.length?l[l.length-1]+1:d);l.push(I)}else l.push(g-(c-d+1-m.length))})}if(e.id===et.id){const{startRow:d,endRow:c}=e.params.range;a.forEach(m=>{m>=d?(u=!0,l.push(m+(c-d+1))):l.push(m)})}if(u&&(o.filteredOutRows=new Set(l)),e.id===tt.id&&!(t!=null&&t.onlyLocal)){const d=this._getExtendRegion(s,i);if(d){const c=e.params.cellValue;if(c)for(let m=d.startColumn;m<=d.endColumn;m++){const g=(r=c==null?void 0:c[d.startRow])==null?void 0:r[m];if(g&&this._cellHasValue(g)){const I=(n=this._univerInstanceService.getUnit(s))==null?void 0:n.getSheetBySheetId(i);if(I){const w=pe(d,{down:!0},I),R=this._sheetsFilterService.getFilterModel(s,i),h=R.getRange();R.setRange({...h,endRow:w.endRow}),this._registerRefRange(s,i)}}}}}}))}_getExtendRegion(e,t){var r;const n=this._sheetsFilterService.getFilterModel(e,t);if(!n)return null;const s=(r=this._univerInstanceService.getUnit(e))==null?void 0:r.getSheetBySheetId(t);if(!s)return null;const i=n.getRange();if(!i)return null;const o=s.getRowCount()-1,a=s.getRowManager();for(let l=i.endRow+1;l<=o;l++)if(a.getRowRawVisible(l))return{startRow:l,endRow:l,startColumn:i.startColumn,endColumn:i.endColumn};return null}_initErrorHandling(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{const t=e.params,r=D(this._univerInstanceService);if(!r)return;const{subUnitId:n,unitId:s}=r,i=this._sheetsFilterService.getFilterModel(s,n);if(!i)return;const o=i.getRange();if(e.id===rt.id&&t.fromRange.startRow<=o.startRow&&t.fromRange.endRow<o.endRow&&t.fromRange.endRow>=o.startRow)throw this._sheetsFilterService.setFilterErrorMsg("sheets-filter.msg.filter-header-forbidden"),new Error("[SheetsFilterController]: Cannot move header row of filter")}))}_cellHasValue(e){const t=Object.values(e);return!(t.length===0||t.every(r=>r==null))}};H=Wt([N(0,E),N(1,U(dt)),N(2,U(F)),N(3,O),N(4,U(ut)),N(5,je(ct)),N(6,U(ht))],H);var jt=(e,t,r,n)=>{for(var s=t,i=e.length-1,o;i>=0;i--)(o=e[i])&&(s=o(s)||s);return s},te=(e,t)=>(r,n)=>t(r,n,e);const Qt=[p.id,k.id],Gt=[_e.id,Ie.id,Ce.id];let J=class extends L{constructor(e,t,r){var n;super(),_(this,"_d",new me),_(this,"_visible$",new $(!1)),_(this,"visible$",this._visible$.asObservable()),_(this,"_enabled$",new $(!0)),_(this,"enabled$",this._enabled$.asObservable()),this._sheetsFilterController=e,this._commandService=t,this._configService=r;const s=this._configService.getConfig(Oe);s!=null&&s.enableSyncSwitch&&(this._visible$.next(!0),typeof s.enableSyncSwitch=="object"&&this.setEnabled((n=s.enableSyncSwitch.defaultValue)!=null?n:!0))}get visible(){return this._visible$.getValue()}get enabled(){return this._enabled$.getValue()}setEnabled(e){this._enabled$.next(e),e?this._d.dispose():this._initOnlyLocalListener()}_initOnlyLocalListener(){this._d.add(this._commandService.beforeCommandExecuted((e,t)=>{Qt.includes(e.id)&&(t||(t={}),t.onlyLocal=!0)})),this._d.add(this._commandService.onCommandExecuted((e,t)=>{if(Gt.includes(e.id)&&t!=null&&t.fromCollab){if(e.id===_e.id){const{range:r,unitId:n,subUnitId:s}=e.params,{redos:i}=this._sheetsFilterController.handleInsertColCommand(r,n,s);j(i,this._commandService,t)}else if(e.id===Ie.id){const{range:r,unitId:n,subUnitId:s}=e.params,{redos:i}=this._sheetsFilterController.handleRemoveColCommand(r,n,s);j(i,this._commandService,t)}else if(e.id===Ce.id){const{sourceRange:r,targetRange:n,unitId:s,subUnitId:i}=e.params,{redos:o}=this._sheetsFilterController.handleMoveColsCommand({fromRange:r,toRange:n},s,i);j(o,this._commandService,t)}}}))}};J=jt([te(0,U(H)),te(1,E),te(2,ge)],J);var Jt=(e,t,r,n)=>{for(var s=t,i=e.length-1,o;i>=0;i--)(o=e[i])&&(s=o(s)||s);return s},V=(e,t)=>(r,n)=>t(r,n,e);let q=class extends L{constructor(e,t,r,n){super(),this._activeDirtyManagerService=e,this._sheetRowFilteredService=t,this._sheetsFilterService=r,this._univerInstanceService=n,this._initFormulaDirtyRange(),this._registerSheetRowFiltered()}_initFormulaDirtyRange(){be.forEach(e=>{this._activeDirtyManagerService.register(e,{commandId:e,getDirtyData:t=>{const r=t.params,{unitId:n,subUnitId:s}=r;return{dirtyRanges:this._getHideRowMutation(n,s),clearDependencyTreeCache:{[n]:{[s]:"1"}}}}})})}_getHideRowMutation(e,t){var r,n;const s=(r=this._sheetsFilterService.getFilterModel(e,t))==null?void 0:r.getRange(),i=(n=this._univerInstanceService.getUnit(e))==null?void 0:n.getSheetBySheetId(t);if(s==null||i==null)return[];const{startRow:o,endRow:a}=s;return[{unitId:e,sheetId:t,range:{startRow:o,startColumn:0,endRow:a,endColumn:i.getColumnCount()-1}}]}_registerSheetRowFiltered(){this._sheetRowFilteredService.register((e,t,r)=>{var n,s;return(s=(n=this._sheetsFilterService.getFilterModel(e,t))==null?void 0:n.isRowFiltered(r))!=null?s:!1})}};q=Jt([V(0,U(mt)),V(1,U(ft)),V(2,U(F)),V(3,O)],q);var qt=(e,t,r,n)=>{for(var s=t,i=e.length-1,o;i>=0;i--)(o=e[i])&&(s=o(s)||s);return s},ce=(e,t)=>(r,n)=>t(r,n,e),W;let he=(W=class extends Be{constructor(e=ue,t,r){super(),this._config=e,this._injector=t,this._configService=r;const{...n}=ke({},ue,this._config);this._configService.setConfig(Oe,n)}onStarting(){[[q],[F],[H],[J]].forEach(e=>this._injector.add(e))}onReady(){He(this._injector,[[q],[H],[J]])}},_(W,"type",B.UNIVER_SHEET),_(W,"pluginName",Ee),W);he=qt([ce(1,U(Qe)),ce(2,ge)],he);export{zt as B,be as E,Rt as F,J as G,A as I,F as M,Ee as N,Se as O,C as R,pt as S,k as a,x as b,Xt as c,Kt as d,M as e,he as f,Yt as g,le as h,It as i,Ct as j,p,G as q,er as u,wt as w,Mt as y,Bt as z};
