import{M as E,a4 as s,V as G,af as J,e as z,J as Y,w as Q,a5 as K,W as X,O as Z,o as ee,P as T,L as v,ab as f,H as ae,v as te,I as y,u as q,x as re,F as ie}from"./TeamSpreadsheet-DqPQXi__.js";var ne=Object.defineProperty,oe=(e,a,t)=>a in e?ne(e,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[a]=t,c=(e,a,t)=>oe(e,typeof a!="symbol"?a+"":a,t);function $(e){return{type:e.type,operator:e.operator,formula1:e.formula1,formula2:e.formula2,allowBlank:e.allowBlank}}function j(e){return{error:e.error,errorStyle:e.errorStyle,errorTitle:e.errorTitle,imeMode:e.imeMode,prompt:e.prompt,promptTitle:e.promptTitle,showDropDown:e.showDropDown,showErrorMessage:e.showErrorMessage,showInputMessage:e.showInputMessage,renderMode:e.renderMode,bizInfo:e.bizInfo}}var p=(e=>(e[e.SETTING=0]="SETTING",e[e.RANGE=1]="RANGE",e[e.OPTIONS=2]="OPTIONS",e[e.ALL=3]="ALL",e))(p||{}),se=(e,a,t,r)=>{for(var i=a,n=e.length-1,o;n>=0;n--)(o=e[n])&&(i=o(i)||i);return i},de=(e,a)=>(t,r)=>a(t,r,e);let h=class extends G{constructor(e){super(),c(this,"_model",new Map),c(this,"_ruleChange$",new J),c(this,"ruleChange$",this._ruleChange$.asObservable()),c(this,"ruleChangeDebounce$",this.ruleChange$.pipe(z(20))),this._logService=e,this.disposeWithMe({dispose:()=>{this._ruleChange$.complete()}})}_ensureMap(e,a){this._model.has(e)||this._model.set(e,new Map);const t=this._model.get(e);if(t.has(a))return t.get(a);const r={map:new Map,list:[]};return t.set(a,r),r}_addSubUnitRule(e,a,t){const{map:r,list:i}=e,n=(Array.isArray(a)?a:[a]).filter(o=>!r.has(o.uid));typeof t=="number"&&t<i.length?i.splice(t,0,...n):i.push(...n),n.forEach(o=>{r.set(o.uid,o)})}_removeSubUnitRule(e,a){const{map:t,list:r}=e,i=r.findIndex(n=>n.uid===a);i>-1&&(r.splice(i,1),t.delete(a))}_updateSubUnitRule(e,a,t){const{map:r,list:i}=e,n=r.get(a),o=i.findIndex(l=>a===l.uid);if(!n)throw new Error(`Data validation rule is not found, ruleId: ${a}.`);const d={...n};switch(t.type){case p.RANGE:{d.ranges=t.payload;break}case p.SETTING:{Object.assign(d,$(t.payload));break}case p.OPTIONS:{Object.assign(d,j(t.payload));break}case p.ALL:{Object.assign(d,t.payload);break}}return i[o]=d,r.set(a,d),d}_addRuleSideEffect(e,a,t,r){if(!this._ensureMap(e,a).map.get(t.uid))return{rule:t,type:"add",unitId:e,subUnitId:a,source:r}}addRule(e,a,t,r,i){try{const n=this._ensureMap(e,a),o=(Array.isArray(t)?t:[t]).map(d=>this._addRuleSideEffect(e,a,d,r));this._addSubUnitRule(n,t,i),o.forEach(d=>{d&&this._ruleChange$.next(d)})}catch(n){this._logService.error(n)}}updateRule(e,a,t,r,i){try{const n=this._ensureMap(e,a),o=Y.deepClone(n.map.get(t));if(!o)throw new Error(`Data validation rule is not found, ruleId: ${t}.`);const d=this._updateSubUnitRule(n,t,r);this._ruleChange$.next({rule:d,type:"update",unitId:e,subUnitId:a,source:i,updatePayload:r,oldRule:o})}catch(n){this._logService.error(n)}}removeRule(e,a,t,r){try{const i=this._ensureMap(e,a),n=i.map.get(t);n&&(this._removeSubUnitRule(i,t),this._ruleChange$.next({rule:n,type:"remove",unitId:e,subUnitId:a,source:r}))}catch(i){this._logService.error(i)}}getRuleById(e,a,t){return this._ensureMap(e,a).map.get(t)}getRuleIndex(e,a,t){return this._ensureMap(e,a).list.findIndex(r=>r.uid===t)}getRules(e,a){return[...this._ensureMap(e,a).list]}getUnitRules(e){const a=this._model.get(e);if(!a)return[];const t=[];return a.forEach((r,i)=>{t.push([i,r.list])}),t}deleteUnitRules(e){this._model.delete(e)}getSubUnitIds(e){var a,t;return Array.from((t=(a=this._model.get(e))==null?void 0:a.keys())!=null?t:[])}getAll(){return Array.from(this._model.keys()).map(e=>[e,this.getUnitRules(e)])}};h=se([de(0,T)],h);const I={type:E.MUTATION,id:"data-validation.mutation.addRule",handler(e,a){if(!a)return!1;const{unitId:t,subUnitId:r,rule:i,index:n,source:o="command"}=a;return e.get(h).addRule(t,r,i,o,n),!0}},N={type:E.MUTATION,id:"data-validation.mutation.removeRule",handler(e,a){if(!a)return!1;const{unitId:t,subUnitId:r,ruleId:i,source:n="command"}=a,o=e.get(h);return Array.isArray(i)?i.forEach(d=>{o.removeRule(t,r,d,n)}):o.removeRule(t,r,i,n),!0}},_={type:E.MUTATION,id:"data-validation.mutation.updateRule",handler(e,a){if(!a)return!1;const{unitId:t,subUnitId:r,ruleId:i,payload:n,source:o="command"}=a;return e.get(h).updateRule(t,r,i,n,o),!0}};var le=(e,a,t,r)=>{for(var i=a,n=e.length-1,o;n>=0;n--)(o=e[n])&&(i=o(i)||i);return i},O=(e,a)=>(t,r)=>a(t,r,e);const ue="SHEET_DATA_VALIDATION_PLUGIN";let M=class extends G{constructor(e,a,t){super(),this._resourceManagerService=e,this._univerInstanceService=a,this._dataValidationModel=t,this._initSnapshot()}_initSnapshot(){const e=t=>{const r=this._dataValidationModel.getUnitRules(t),i={};return r?(r.forEach(([n,o])=>{i[n]=o}),JSON.stringify(i)):""},a=t=>{if(!t)return{};try{return JSON.parse(t)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:ue,businesses:[Q.UNIVER_SHEET],toJson:t=>e(t),parseJson:t=>a(t),onUnLoad:t=>{this._dataValidationModel.deleteUnitRules(t)},onLoad:(t,r)=>{Object.keys(r).forEach(i=>{r[i].forEach(n=>{this._dataValidationModel.addRule(t,i,n,"patched")})})}}))}};M=le([O(0,ae),O(1,te),O(2,y(h))],M);var ce=(e=>(e.SHEET="sheet",e))(ce||{});class W{constructor(){c(this,"_validatorByScopes",new Map),c(this,"_validatorMap",new Map),c(this,"_validatorsChange$",new K(void 0)),c(this,"validatorsChange$",this._validatorsChange$.asObservable())}_addValidatorToScope(a,t){this._validatorByScopes.has(t)||this._validatorByScopes.set(t,[]);const r=this._validatorByScopes.get(t);if(r.findIndex(i=>i.id===a.id)>-1)throw new Error(`Validator item with the same id ${a.id} has already been added!`);r.push(a)}_removeValidatorFromScope(a,t){const r=this._validatorByScopes.get(t);if(!r)return;const i=r.findIndex(n=>n.id===a.id);i>-1&&r.splice(i,1)}register(a){return this._validatorMap.set(a.id,a),Array.isArray(a.scopes)?a.scopes.forEach(t=>{this._addValidatorToScope(a,t)}):this._addValidatorToScope(a,a.scopes),this._validatorsChange$.next(),X(()=>{this._validatorMap.delete(a.id),Array.isArray(a.scopes)?a.scopes.forEach(t=>{this._removeValidatorFromScope(a,t)}):this._removeValidatorFromScope(a,a.scopes),this._validatorsChange$.next()})}getValidatorItem(a){return this._validatorMap.get(a)}getValidatorsByScope(a){return this._validatorByScopes.get(a)}}const he={type:E.COMMAND,id:"data-validation.command.addRule",async handler(e,a){if(e.get(T).error("[Deprecated]: `AddDataValidationCommand` is deprecated, please use `AddSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const{rule:t,unitId:r,subUnitId:i}=a,n=e.get(v),o=e.get(f),d={...a,rule:{...a.rule,ranges:[a.rule.range]}},l=[{id:I.id,params:d}],u=[{id:N.id,params:{unitId:r,subUnitId:i,ruleId:t.uid}}];return o.pushUndoRedo({unitID:r,redoMutations:l,undoMutations:u}),await n.executeCommand(I.id,d),!0}},pe={type:E.COMMAND,id:"data-validation.command.removeRule",handler(e,a){if(e.get(T).error("[Deprecated]: `RemoveDataValidationCommand` is deprecated, please use `RemoveSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const{unitId:t,subUnitId:r,ruleId:i}=a,n=e.get(v),o=e.get(f),d=e.get(h),l=[{id:N.id,params:a}],u=[{id:I.id,params:{unitId:t,subUnitId:r,rule:{...d.getRuleById(t,r,i)},index:d.getRuleIndex(t,r,i)}}];return o.pushUndoRedo({undoMutations:u,redoMutations:l,unitID:a.unitId}),n.executeCommand(N.id,a),!0}},me={type:E.COMMAND,id:"data-validation.command.updateDataValidationSetting",handler(e,a){if(e.get(T).warn("[Deprecated]: `UpdateDataValidationOptionsCommand` is deprecated, please use `UpdateSheetDataValidationOptionsCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const t=e.get(v),r=e.get(f),i=e.get(h),{unitId:n,subUnitId:o,ruleId:d,options:l}=a,u=i.getRuleById(n,o,d);if(!u)return!1;const m={unitId:n,subUnitId:o,ruleId:d,payload:{type:p.OPTIONS,payload:l}},g=[{id:_.id,params:m}],A={unitId:n,subUnitId:o,ruleId:d,payload:{type:p.OPTIONS,payload:j(u)}},S=[{id:_.id,params:A}];return r.pushUndoRedo({unitID:n,redoMutations:g,undoMutations:S}),t.executeCommand(_.id,m),!0}},Ee={type:E.COMMAND,id:"data-validation.command.updateDataValidationOptions",handler(e,a){if(e.get(T).error("[Deprecated]: `UpdateDataValidationSettingCommand` is deprecated, please use `UpdateSheetDataValidationSettingCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const t=e.get(v),r=e.get(f),i=e.get(h),n=e.get(W),{unitId:o,subUnitId:d,ruleId:l,setting:u}=a,m=n.getValidatorItem(u.type);if(!m)return!1;const g=i.getRuleById(o,d,l);if(!g)return!1;const A={...g,...u};if(!m.validatorFormula(A,o,d).success)return!1;const S={unitId:o,subUnitId:d,ruleId:l,payload:{type:p.SETTING,payload:{...u,...m.normalizeFormula(A,o,d)}}},F=[{id:_.id,params:S}],P={unitId:o,subUnitId:d,ruleId:l,payload:{type:p.SETTING,payload:$(g)}},k=[{id:_.id,params:P}];return r.pushUndoRedo({unitID:o,redoMutations:F,undoMutations:k}),t.executeCommand(_.id,S),!0}},ge={type:E.COMMAND,id:"data-validation.command.removeAll",handler(e,a){if(e.get(T).error("[Deprecated]: `RemoveAllDataValidationCommand` is deprecated, please use `RemoveSheetAllDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const{unitId:t,subUnitId:r}=a,i=e.get(v),n=e.get(h),o=e.get(f),d=[...n.getRules(t,r)],l={unitId:t,subUnitId:r,ruleId:d.map(g=>g.uid)},u=[{id:N.id,params:l}],m=[{id:I.id,params:{unitId:t,subUnitId:r,rule:d}}];return o.pushUndoRedo({redoMutations:u,undoMutations:m,unitID:t}),i.executeCommand(N.id,l),!0}},_e="data-validation.config",V={};var Ne=(e,a,t,r)=>{for(var i=a,n=e.length-1,o;n>=0;n--)(o=e[n])&&(i=o(i)||i);return i},U=(e,a)=>(t,r)=>a(t,r,e);const Te="UNIVER_DATA_VALIDATION_PLUGIN";var R;let L=(R=class extends Z{constructor(e=V,a,t,r){super(),this._config=e,this._injector=a,this._commandService=t,this._configService=r;const{...i}=ee({},V,this._config);this._configService.setConfig(_e,i)}onStarting(){[[h],[W],[M]].forEach(e=>this._injector.add(e)),[he,ge,me,Ee,pe,I,_,N].forEach(e=>{this._commandService.registerCommand(e)})}onReady(){this._injector.get(M)}},c(R,"pluginName",Te),c(R,"type",Q.UNIVER_SHEET),R);L=Ne([U(1,y(q)),U(2,v),U(3,re)],L);s.BETWEEN+"",s.EQUAL+"",s.GREATER_THAN+"",s.GREATER_THAN_OR_EQUAL+"",s.LESS_THAN+"",s.LESS_THAN_OR_EQUAL+"",s.NOT_BETWEEN+"",s.NOT_EQUAL+"";const b={[s.BETWEEN]:"dataValidation.ruleName.between",[s.EQUAL]:"dataValidation.ruleName.equal",[s.GREATER_THAN]:"dataValidation.ruleName.greaterThan",[s.GREATER_THAN_OR_EQUAL]:"dataValidation.ruleName.greaterThanOrEqual",[s.LESS_THAN]:"dataValidation.ruleName.lessThan",[s.LESS_THAN_OR_EQUAL]:"dataValidation.ruleName.lessThanOrEqual",[s.NOT_BETWEEN]:"dataValidation.ruleName.notBetween",[s.NOT_EQUAL]:"dataValidation.ruleName.notEqual",NONE:"dataValidation.ruleName.legal"},w={[s.BETWEEN]:"dataValidation.errorMsg.between",[s.EQUAL]:"dataValidation.errorMsg.equal",[s.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[s.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[s.LESS_THAN]:"dataValidation.errorMsg.lessThan",[s.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[s.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[s.NOT_EQUAL]:"dataValidation.errorMsg.notEqual",NONE:"dataValidation.errorMsg.legal"},Se={[s.BETWEEN]:"dataValidation.textLength.errorMsg.between",[s.EQUAL]:"dataValidation.textLength.errorMsg.equal",[s.GREATER_THAN]:"dataValidation.textLength.errorMsg.greaterThan",[s.GREATER_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.greaterThanOrEqual",[s.LESS_THAN]:"dataValidation.textLength.errorMsg.lessThan",[s.LESS_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.lessThanOrEqual",[s.NOT_BETWEEN]:"dataValidation.textLength.errorMsg.notBetween",[s.NOT_EQUAL]:"dataValidation.textLength.errorMsg.notEqual"},Re=[s.BETWEEN,s.NOT_BETWEEN];var ve=(e,a,t,r)=>{for(var i=a,n=e.length-1,o;n>=0;n--)(o=e[n])&&(i=o(i)||i);return i},C=(e,a)=>(t,r)=>a(t,r,e);const D="{FORMULA1}",B="{FORMULA2}",x="{TYPE}",Ie={[s.BETWEEN]:"dataValidation.operators.between",[s.EQUAL]:"dataValidation.operators.equal",[s.GREATER_THAN]:"dataValidation.operators.greaterThan",[s.GREATER_THAN_OR_EQUAL]:"dataValidation.operators.greaterThanOrEqual",[s.LESS_THAN]:"dataValidation.operators.lessThan",[s.LESS_THAN_OR_EQUAL]:"dataValidation.operators.lessThanOrEqual",[s.NOT_BETWEEN]:"dataValidation.operators.notBetween",[s.NOT_EQUAL]:"dataValidation.operators.notEqual"};var fe=(e=>(e.DATE="date",e.TIME="time",e.DATETIME="datetime",e.LIST="list",e.MULTIPLE_LIST="multipleList",e.COLOR="color",e.CASCADE="cascade",e))(fe||{});let H=class{constructor(e,a){c(this,"offsetFormulaByRange",!0),c(this,"formulaInput"),c(this,"canvasRender",null),c(this,"dropdownType"),c(this,"optionsInput"),c(this,"skipDefaultFontRender"),this.localeService=e,this.injector=a}get operatorNames(){return this.operators.map(e=>this.localeService.t(Ie[e]))}get titleStr(){return this.localeService.t(this.title)}generateRuleName(e){var a,t;if(!e.operator)return this.localeService.t(b.NONE).replace(x,this.titleStr);const r=this.localeService.t(b[e.operator]).replace(D,(a=e.formula1)!=null?a:"").replace(B,(t=e.formula2)!=null?t:"");return`${this.titleStr} ${r}`}generateRuleErrorMessage(e,a){var t,r;return e.operator?`${this.localeService.t(w[e.operator]).replace(D,(t=e.formula1)!=null?t:"").replace(B,(r=e.formula2)!=null?r:"")}`:this.localeService.t(w.NONE).replace(x,this.titleStr)}getExtraStyle(e,a,t,r,i){}getRuleFinalError(e,a){return e.showErrorMessage&&e.error?e.error:this.generateRuleErrorMessage(e,a)}isEmptyCellValue(e){return e===""||e===void 0||e===null}normalizeFormula(e,a,t){return{formula1:e.formula1,formula2:e.formula2}}async isValidType(e,a,t){return!0}transform(e,a,t){return e}async validatorIsEqual(e,a,t){const{formula1:r}=a,{value:i}=e;return Number.isNaN(r)?!0:i===r}async validatorIsNotEqual(e,a,t){const{formula1:r}=a;return Number.isNaN(r)?!0:e.value!==r}async validatorIsBetween(e,a,t){const{formula1:r,formula2:i}=a;if(Number.isNaN(r)||Number.isNaN(i))return!0;const n=Math.min(r,i),o=Math.max(r,i);return e.value>=n&&e.value<=o}async validatorIsNotBetween(e,a,t){const{formula1:r,formula2:i}=a;if(Number.isNaN(r)||Number.isNaN(i))return!0;const n=Math.min(r,i),o=Math.max(r,i);return e.value<n||e.value>o}async validatorIsGreaterThan(e,a,t){const{formula1:r}=a;return Number.isNaN(r)?!0:e.value>r}async validatorIsGreaterThanOrEqual(e,a,t){const{formula1:r}=a;return Number.isNaN(r)?!0:e.value>=r}async validatorIsLessThan(e,a,t){const{formula1:r}=a;return Number.isNaN(r)?!0:e.value<r}async validatorIsLessThanOrEqual(e,a,t){const{formula1:r}=a;return Number.isNaN(r)?!0:e.value<=r}async validator(e,a){const{value:t,unitId:r,subUnitId:i}=e,n=this.isEmptyCellValue(t),{allowBlank:o=!0,operator:d}=a;if(n)return o;const l=await this.parseFormula(a,r,i,e.row,e.column);if(!l.isFormulaValid||!await this.isValidType(e,l,a))return!1;if(!d)return!0;const u=this.transform(e,l,a);switch(d){case s.BETWEEN:return this.validatorIsBetween(u,l,a);case s.EQUAL:return this.validatorIsEqual(u,l,a);case s.GREATER_THAN:return this.validatorIsGreaterThan(u,l,a);case s.GREATER_THAN_OR_EQUAL:return this.validatorIsGreaterThanOrEqual(u,l,a);case s.LESS_THAN:return this.validatorIsLessThan(u,l,a);case s.LESS_THAN_OR_EQUAL:return this.validatorIsLessThanOrEqual(u,l,a);case s.NOT_BETWEEN:return this.validatorIsNotBetween(u,l,a);case s.NOT_EQUAL:return this.validatorIsNotEqual(u,l,a);default:throw new Error("Unknown operator.")}}};H=ve([C(0,y(ie)),C(1,y(q))],H);export{D as B,L as C,W as F,H as G,M as I,N,x as P,$ as Q,I as S,Se as U,fe as V,Re as a,p as b,h,j,ce as p,_ as v,B as x};
