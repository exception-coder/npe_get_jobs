import{a as g,aw as V,aF as W,aI as N,aD as X,aC as j,aR as te,aQ as re,aT as z,V as J,W as _,ba as K,ak as M,cI as se,O as ne,o as oe,bW as ae,dz as ie,G as ue,c4 as ce,d as le,P as F,I as de,u as he,x as pe}from"./TeamSpreadsheet-DqPQXi__.js";import{ta as P}from"./index--BQDx9CP.js";function fe(e,r){var t=V(e)?e:function(){return e},s=function(n){return n.error(t())};return new g(s)}function Q(e){return W(function(r,t){var s=null,n=!1,o;s=r.subscribe(N(t,void 0,void 0,function(a){o=X(e(a,Q(e)(r))),s?(s.unsubscribe(),s=null,o.subscribe(t)):n=!0})),n&&(s.unsubscribe(),s=null,o.subscribe(t))})}function O(e,r){return V(r)?j(e,r,1):j(e,1)}function me(e){e===void 0&&(e=1/0);var r;e&&typeof e=="object"?r=e:r={count:e};var t=r.count,s=t===void 0?1/0:t,n=r.delay,o=r.resetOnSuccess,a=o===void 0?!1:o;return s<=0?te:W(function(l,c){var d=0,i,u=function(){var m=!1;i=l.subscribe(N(c,function(h){a&&(d=0),c.next(h)},void 0,function(h){if(d++<s){var p=function(){i?(i.unsubscribe(),i=null,u()):m=!0};if(n!=null){var y=typeof n=="number"?re(n):X(n(h,d)),f=N(c,function(){f.unsubscribe(),p()},function(){c.complete()});y.subscribe(f)}else p()}else c.error(h)})),m&&(i.unsubscribe(),i=null,u())};u()})}var ve=Object.defineProperty,ye=(e,r,t)=>r in e?ve(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t,v=(e,r,t)=>ye(e,typeof r!="symbol"?r+"":r,t);const ge="network.config",$={},U="application/json";function we(e){return Array.isArray(e)?e.some(r=>r.includes(U)):e.includes(U)}class E{constructor(r){v(this,"_headers",new Map),typeof r=="string"?this._handleHeadersString(r):r instanceof Headers?this._handleHeaders(r):r&&this._handleHeadersConstructorProps(r)}forEach(r){this._headers.forEach((t,s)=>r(s,t))}has(r){return!!this._headers.has(r.toLowerCase())}get(r){const t=r.toLowerCase();return this._headers.has(t)?this._headers.get(t):null}set(r,t){this._setHeader(r,t)}toHeadersInit(r){const t={};return this._headers.forEach((s,n)=>{t[n]=s.join(",")}),t.accept!=null||(t.accept="application/json, text/plain, */*"),r instanceof FormData||t["content-type"]!=null||(t["content-type"]="application/json;charset=UTF-8"),t}_setHeader(r,t){const s=r.toLowerCase();this._headers.has(s)?this._headers.get(s).push(t.toString()):this._headers.set(s,[t.toString()])}_handleHeadersString(r){r.split(`
`).forEach(t=>{const[s,n]=t.split(":");s&&n&&this._setHeader(s,n)})}_handleHeadersConstructorProps(r){Object.entries(r).forEach(([t,s])=>this._setHeader(t,s))}_handleHeaders(r){r.forEach((t,s)=>this._setHeader(s,t))}}const Y=z("network.http-implementation");class D{constructor(r){this.params=r}toString(){return this.params?Object.keys(this.params).map(r=>{const t=this.params[r];return Array.isArray(t)?t.map(s=>`${r}=${s}`).join("&"):`${r}=${t}`}).join("&"):""}}let Te=0;class G{constructor(r,t,s){v(this,"uid",Te++),this.method=r,this.url=t,this.requestParams=s}get headers(){return this.requestParams.headers}get withCredentials(){return this.requestParams.withCredentials}get responseType(){return this.requestParams.responseType}getUrlWithParams(){var r,t;const s=(t=(r=this.requestParams)==null?void 0:r.params)==null?void 0:t.toString();return s?`${this.url}${this.url.includes("?")?"&":"?"}${s}`:this.url}getBody(){var r,t;const s=(r=this.headers.get("Content-Type"))!=null?r:U,n=(t=this.requestParams)==null?void 0:t.body;return n instanceof FormData?n:we(s)&&n&&typeof n=="object"?JSON.stringify(n):n?`${n}`:null}getHeadersInit(){var r;return this.headers.toHeadersInit((r=this.requestParams)==null?void 0:r.body)}}var be=(e,r,t,s)=>{for(var n=r,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},_e=(e,r)=>(t,s)=>r(t,s,e);let x=class extends J{constructor(e){super(),v(this,"_interceptors",[]),v(this,"_pipe"),this._http=e}registerHTTPInterceptor(e){if(this._interceptors.indexOf(e)!==-1)throw new Error("[HTTPService]: The interceptor has already been registered!");return this._interceptors.push(e),this._interceptors=this._interceptors.sort((r,t)=>{var s,n;return((s=r.priority)!=null?s:0)-((n=t.priority)!=null?n:0)}),this._pipe=null,_(()=>K(this._interceptors,e))}get(e,r){return this.request("GET",e,r)}post(e,r){return this.request("POST",e,r)}put(e,r){return this.request("PUT",e,r)}delete(e,r){return this.request("DELETE",e,r)}patch(e,r){return this.request("PATCH",e,r)}async request(e,r,t){var s,n;const o=new E(t==null?void 0:t.headers),a=new D(t==null?void 0:t.params),l=new G(e,r,{headers:o,params:a,withCredentials:(s=t==null?void 0:t.withCredentials)!=null?s:!1,responseType:(n=t==null?void 0:t.responseType)!=null?n:"json",body:["GET","DELETE"].includes(e)||t==null?void 0:t.body}),c=M(l).pipe(O(d=>this._runInterceptorsAndImplementation(d)));return await se(c)}stream(e,r,t){return this.getSSE(e,r,t)}getSSE(e,r,t){var s,n;const o=new E(t==null?void 0:t.headers),a=new D(t==null?void 0:t.params),l=new G(e,r,{headers:o,params:a,withCredentials:(s=t==null?void 0:t.withCredentials)!=null?s:!1,reportProgress:!0,responseType:(n=t==null?void 0:t.responseType)!=null?n:"json",body:["GET","DELETE"].includes(e)||t==null?void 0:t.body});return M(l).pipe(O(c=>this._runInterceptorsAndImplementation(c)))}_runInterceptorsAndImplementation(e){return this._pipe||(this._pipe=this._interceptors.map(r=>r.interceptor).reduceRight((r,t)=>Ee(r,t),(r,t)=>t(r))),this._pipe(e,r=>this._http.send(r))}};x=be([_e(0,Y)],x);function Ee(e,r){return(t,s)=>r(t,n=>e(n,s))}const Pe=200,xe=300;var R=(e=>(e[e.Continue=100]="Continue",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.Processing=102]="Processing",e[e.EarlyHints=103]="EarlyHints",e[e.Ok=200]="Ok",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.ImUsed=226]="ImUsed",e[e.MultipleChoices=300]="MultipleChoices",e[e.MovedPermanently=301]="MovedPermanently",e[e.Found=302]="Found",e[e.SeeOther=303]="SeeOther",e[e.NotModified=304]="NotModified",e[e.UseProxy=305]="UseProxy",e[e.Unused=306]="Unused",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.PaymentRequired=402]="PaymentRequired",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.NotAcceptable=406]="NotAcceptable",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.LengthRequired=411]="LengthRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.PayloadTooLarge=413]="PayloadTooLarge",e[e.UriTooLong=414]="UriTooLong",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.RangeNotSatisfiable=416]="RangeNotSatisfiable",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.ImATeapot=418]="ImATeapot",e[e.MisdirectedRequest=421]="MisdirectedRequest",e[e.UnprocessableEntity=422]="UnprocessableEntity",e[e.Locked=423]="Locked",e[e.FailedDependency=424]="FailedDependency",e[e.TooEarly=425]="TooEarly",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.PreconditionRequired=428]="PreconditionRequired",e[e.TooManyRequests=429]="TooManyRequests",e[e.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",e[e.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented",e[e.BadGateway=502]="BadGateway",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",e[e.InsufficientStorage=507]="InsufficientStorage",e[e.LoopDetected=508]="LoopDetected",e[e.NotExtended=510]="NotExtended",e[e.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired",e))(R||{}),Z=(e=>(e[e.DownloadProgress=0]="DownloadProgress",e[e.Response=1]="Response",e))(Z||{});class k{constructor({body:r,headers:t,status:s,statusText:n}){v(this,"type",1),v(this,"body"),v(this,"headers"),v(this,"status"),v(this,"statusText"),this.body=r,this.headers=t,this.status=s,this.statusText=n}}class Re{constructor(r,t,s){v(this,"type",0),this.total=r,this.loaded=t,this.partialText=s}}class Se{constructor(r,t,s){this.headers=r,this.status=t,this.statusText=s}}class w{constructor({request:r,headers:t,status:s,statusText:n,error:o}){v(this,"request"),v(this,"headers"),v(this,"status"),v(this,"statusText"),v(this,"error"),this.request=r,this.headers=t,this.status=s,this.statusText=n,this.error=o}}function ee(e){return{method:e.method,headers:e.getHeadersInit(),body:e.getBody(),credentials:e.withCredentials?"include":void 0}}var qe=(e,r,t,s)=>{for(var n=r,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},Ie=(e,r)=>(t,s)=>r(t,s,e);let S=class{constructor(e){this._logService=e}send(e){return new g(r=>{const t=new AbortController;return this._send(e,r,t).catch(s=>{r.error(new w({error:s,request:e}))}),()=>t.abort()})}async _send(e,r,t){var s,n;let o;try{const i=ee(e),u=e.getUrlWithParams(),m=fetch(u,{signal:t.signal,...i});this._logService.debug(`[FetchHTTPImplementation]: sending request to url ${u} with params ${i}`),o=await m}catch(i){const u=new w({request:e,error:i,status:(s=i.status)!=null?s:0,statusText:(n=i.statusText)!=null?n:"Unknown Error",headers:i.headers});this._logService.error("[FetchHTTPImplementation]: network error",u),r.error(u);return}const a=new E(o.headers),l=o.status,c=o.statusText;let d=null;if(o.body&&(d=await this._readBody(e,o,r)),l>=R.Ok&&l<R.MultipleChoices)r.next(new k({body:d,headers:a,status:l,statusText:c}));else{const i=new w({request:e,error:d,status:l,statusText:c,headers:a});this._logService.error("[FetchHTTPImplementation]: network error",i),r.error(i)}r.complete()}async _readBody(e,r,t){var s,n;const o=[],a=r.body.getReader(),l=r.headers.get("content-length");let c=0;const d=(s=e.requestParams)==null?void 0:s.reportProgress,i=e.responseType;let u,m;for(;;){const{done:p,value:y}=await a.read();if(p)break;o.push(y),c+=y.length,d&&i==="text"&&(u=(u??"")+(m??(m=new TextDecoder)).decode(y,{stream:!0}),t.next(new Re(l?Number.parseInt(l,10):void 0,c,u)))}const h=Le(o,c);try{const p=(n=r.headers.get("content-type"))!=null?n:"";return Ne(e,h,p)}catch(p){const y=new w({request:e,error:p,status:r.status,statusText:r.statusText,headers:new E(r.headers)});return this._logService.error("[FetchHTTPImplementation]: network error",y),t.error(y),null}}};S=qe([Ie(0,F)],S);function Le(e,r){const t=new Uint8Array(r);let s=0;for(const n of e)t.set(n,s),s+=n.length;return t}const He=/^\)\]\}',?\n/;function Ne(e,r,t){switch(e.responseType){case"json":const s=new TextDecoder().decode(r).replace(He,"");return s===""?null:JSON.parse(s);case"text":return new TextDecoder().decode(r);case"blob":return new Blob([r.buffer],{type:t});case"arraybuffer":return r.buffer;default:throw new Error(`[FetchHTTPImplementation]: unknown response type: ${e.responseType}.`)}}var Ue=(e,r,t,s)=>{for(var n=r,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},Ce=(e,r)=>(t,s)=>r(t,s,e);let C=class{constructor(e){this._logService=e}send(e){return new g(r=>{const t=new XMLHttpRequest,s=e.getUrlWithParams(),n=ee(e),{responseType:o}=e;t.open(e.method,s),e.withCredentials&&(t.withCredentials=!0),n.headers&&Object.entries(n.headers).forEach(([i,u])=>t.setRequestHeader(i,u));const a=()=>{const i=t.statusText||"OK",u=new E(t.getAllResponseHeaders());return new Se(u,t.status,i)},l=()=>{const{headers:i,statusText:u,status:m}=a();let h=null,p=null;m!==R.NoContent&&(h=typeof t.response>"u"?t.responseText:t.response);let y=m>=Pe&&m<xe;if(o==="json"&&typeof h=="string"){const f=h;try{h=h?JSON.parse(h):null}catch(T){y=!1,h=f,p=T}}if(o==="blob"&&!(h instanceof Blob)&&(y=!1,p=new Error("Response is not a Blob object")),y)r.next(new k({body:h,headers:i,status:m,statusText:u}));else{const f=new w({request:e,error:p,headers:i,status:m,statusText:u});this._logService.error("[XHRHTTPImplementation]: network error",f),r.error(f)}},c=i=>{const u=new w({request:e,error:i,status:t.status||0,statusText:t.statusText||"Unknown Error",headers:a().headers});this._logService.error("[XHRHTTPImplementation]: network error",u),r.error(u)};t.responseType=o||"",t.addEventListener("load",l),t.addEventListener("error",c),t.addEventListener("abort",c),t.addEventListener("timeout",c);const d=e.getBody();return t.send(d),this._logService.debug("[XHRHTTPImplementation]",`sending request to url ${s} with params ${n}`),()=>{t.readyState!==t.DONE&&t.abort(),t.removeEventListener("load",l),t.removeEventListener("error",c),t.removeEventListener("abort",c),t.removeEventListener("timeout",c)}})}};C=Ue([Ce(0,F)],C);var Fe=(e,r,t,s)=>{for(var n=r,o=e.length-1,a;o>=0;o--)(a=e[o])&&(n=a(n)||n);return n},L=(e,r)=>(t,s)=>r(t,s,e),H;let B=(H=class extends ne{constructor(e=$,r,t,s){super(),this._config=e,this._logger=r,this._injector=t,this._configService=s;const{...n}=oe({},$,this._config);this._configService.setConfig(ge,n)}onStarting(){var e,r,t;if(this._injector.get(x,ae.OPTIONAL,ie.SKIP_SELF)&&!((e=this._config)!=null&&e.forceUseNewInstance)){this._logger.warn("[UniverNetworkPlugin]",'HTTPService is already registered in an ancestor interceptor. Skipping registration. If you want to force a new instance, set "forceUseNewInstance" to true in the plugin configuration.');return}const s=(r=this._config)!=null&&r.useFetchImpl?S:typeof window<"u"?C:S;ue(this._injector,ce([[x],[Y,{useClass:s}]],(t=this._config)==null?void 0:t.override))}},v(H,"pluginName","UNIVER_NETWORK_PLUGIN"),H);B=Fe([L(1,F),L(2,de(he)),L(3,pe)],B);const De=e=>{const{errorStatusCodes:r,onAuthError:t}=e;return(s,n)=>n(s).pipe(Q(o=>(o instanceof w&&r.some(a=>a===o.status)&&t(),fe(()=>o))))},ke=(e=300)=>{let r=()=>{};return t=>new Promise(s=>{r();const n=setTimeout(()=>{s(!0)},e);r=()=>{clearTimeout(n),s(!1)}})},Ae=()=>(e,r)=>r.map(t=>({config:t,result:e})),Ge=(e,r={})=>{const{isMatch:t,getParamsFromRequest:s,mergeParamsToRequest:n}=e,{fetchCheck:o=ke(300),distributeResult:a=Ae()}=r,l=[],c=d=>d.map(i=>i.config);return(d,i)=>t(d)?new g(u=>{const m=s(d);l.push({next:p=>u.next(p),error:p=>u.error(p),config:m});const h=c(l);o(d).then(p=>{if(p){const y=[];h.forEach(f=>{const T=l.findIndex(b=>b.config===f);if(T>=0){const[b]=l.splice(T,1);y.push(b)}}),i(n(h,d)).subscribe({next:f=>{if(f.type===Z.Response){const T=f.body,b=a(T,h);y.forEach(q=>{const A=b.find(I=>I.config===q.config);if(A){const I=new k({body:A.result,headers:f.headers,status:f.status,statusText:f.statusText});q.next(I)}else q.error("batch error")})}},complete:()=>u.complete(),error:f=>u.error(f)})}})}):i(d)},je=3,Me=1e3,Be=e=>{var r,t;const s=(r=e==null?void 0:e.maxRetryAttempts)!=null?r:je,n=(t=e==null?void 0:e.delayInterval)!=null?t:Me;return(o,a)=>a(o).pipe(me({delay:n,count:s}))},Ve=e=>{const r=[],t=new Set,s=()=>{for(var n;t.size<((n=e==null?void 0:e.maxParallel)!=null?n:1)&&r.length>0;){const o=r.shift();t.add(o),o()}};return(n,o)=>new g(a=>{const l=()=>o(n).subscribe({next:d=>a.next(d),error:d=>a.error(d),complete:()=>a.complete()}),c=()=>{t.delete(l),K(r,l),s()};return r.push(l),s(),c})},We=z("univer.network.socket.service");class Xe extends J{createSocket(r){try{const t=new WebSocket(r),s=new le;return{URL:r,close:(n,o)=>{t.close(n,o),s.dispose()},send:n=>{t.send(n)},open$:new g(n=>{const o=a=>n.next(a);t.addEventListener("open",o),s.add(_(()=>t.removeEventListener("open",o)))}).pipe(P()),close$:new g(n=>{const o=a=>n.next(a);t.addEventListener("close",o),s.add(_(()=>t.removeEventListener("close",o)))}).pipe(P()),error$:new g(n=>{const o=a=>n.next(a);t.addEventListener("error",o),s.add(_(()=>t.removeEventListener("error",o)))}).pipe(P()),message$:new g(n=>{const o=a=>n.next(a);t.addEventListener("message",o),s.add(_(()=>t.removeEventListener("message",o)))}).pipe(P())}}catch(t){return console.error(t),null}}}export{C as D,Se as E,E as I,Be as J,Ve as K,R as L,S as N,Z as Q,B as V,De as X,Xe as Y,Re as _,G as a,Y as b,Ge as c,O as d,k as q,w as v,x,We as z};
