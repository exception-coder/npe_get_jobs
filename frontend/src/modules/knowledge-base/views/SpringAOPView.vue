<template>
  <div class="spring-aop-view">
    <v-container fluid class="pa-4">
      <!-- æ ‡é¢˜åŒºåŸŸ - å°çº¢ä¹¦é£æ ¼ -->
      <v-card class="mb-4 title-card" elevation="0">
        <v-card-text class="text-center pa-6">
          <div class="text-h4 font-weight-bold mb-2">
            ğŸŒŸ Spring AOP å®Œå…¨æŒ‡å—
          </div>
          <div class="text-subtitle-1 text-medium-emphasis">
            é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œè®©ä½ çš„ä»£ç æ›´ä¼˜é›…ï¼âœ¨
          </div>
        </v-card-text>
      </v-card>

      <v-row>
        <!-- å·¦ä¾§ï¼šæ ¸å¿ƒæ¦‚å¿µå¡ç‰‡ -->
        <v-col cols="12" md="4">
          <!-- ä»€ä¹ˆæ˜¯ AOP -->
          <v-card class="mb-4 concept-card" elevation="2">
            <v-card-title class="d-flex align-center">
              <span class="text-h6">ğŸ’¡ ä»€ä¹ˆæ˜¯ AOPï¼Ÿ</span>
            </v-card-title>
            <v-card-text>
              <p class="text-body-1 mb-3">
                <strong>AOP = é¢å‘åˆ‡é¢ç¼–ç¨‹</strong>ï¼Œæ˜¯ OOP çš„å®Œç¾è¡¥å……ï¼
              </p>
              <v-alert type="info" density="compact" class="mb-3">
                <strong>ç®€å•ç†è§£ï¼š</strong>æŠŠæ¨ªåˆ‡é€»è¾‘ï¼ˆæ—¥å¿—ã€äº‹åŠ¡ã€æƒé™ï¼‰ä»ä¸šåŠ¡ä»£ç ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œç»Ÿä¸€ç®¡ç† ğŸ¯
              </v-alert>
              <div class="example-box">
                <div class="text-subtitle-2 mb-2">âŒ æ²¡æœ‰ AOP æ—¶ï¼š</div>
                <pre class="code-snippet">æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™æ—¥å¿—
æ¯ä¸ªæ–¹æ³•éƒ½è¦å†™äº‹åŠ¡
ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾ ğŸ˜«</pre>
              </div>
              <div class="example-box mt-3">
                <div class="text-subtitle-2 mb-2">âœ… æœ‰äº† AOP åï¼š</div>
                <pre class="code-snippet">ä¸€ä¸ªåˆ‡é¢æå®šæ‰€æœ‰
ä»£ç ç®€æ´ï¼Œä¸“æ³¨ä¸šåŠ¡ ğŸ‰</pre>
              </div>
            </v-card-text>
          </v-card>

          <!-- æ ¸å¿ƒæœ¯è¯­ -->
          <v-card class="mb-4 concept-card" elevation="2">
            <v-card-title class="d-flex align-center">
              <span class="text-h6">ğŸ“š æ ¸å¿ƒæœ¯è¯­</span>
            </v-card-title>
            <v-card-text>
              <v-list density="compact">
                <v-list-item>
                  <template #prepend>
                    <v-icon color="primary">mdi-target</v-icon>
                  </template>
                  <v-list-item-title><strong>JoinPointï¼ˆè¿æ¥ç‚¹ï¼‰</strong></v-list-item-title>
                  <v-list-item-subtitle>å“ªä¸ªæ–¹æ³•å¯ä»¥è¢«å¢å¼º</v-list-item-subtitle>
                </v-list-item>
                <v-list-item>
                  <template #prepend>
                    <v-icon color="primary">mdi-scissors-cutting</v-icon>
                  </template>
                  <v-list-item-title><strong>PointCutï¼ˆåˆ‡å…¥ç‚¹ï¼‰</strong></v-list-item-title>
                  <v-list-item-subtitle>åŒ¹é…å“ªäº›æ–¹æ³•éœ€è¦ç»‡å…¥</v-list-item-subtitle>
                </v-list-item>
                <v-list-item>
                  <template #prepend>
                    <v-icon color="primary">mdi-lightbulb-on</v-icon>
                  </template>
                  <v-list-item-title><strong>Adviceï¼ˆé€šçŸ¥ï¼‰</strong></v-list-item-title>
                  <v-list-item-subtitle>åšä»€ä¹ˆå¢å¼ºï¼ˆbefore/after/aroundï¼‰</v-list-item-subtitle>
                </v-list-item>
                <v-list-item>
                  <template #prepend>
                    <v-icon color="primary">mdi-package-variant</v-icon>
                  </template>
                  <v-list-item-title><strong>Aspectï¼ˆåˆ‡é¢ï¼‰</strong></v-list-item-title>
                  <v-list-item-subtitle>åˆ‡ç‚¹å®šä¹‰ + é€šçŸ¥é€»è¾‘</v-list-item-subtitle>
                </v-list-item>
              </v-list>
            </v-card-text>
          </v-card>

          <!-- å¸¸è§åœºæ™¯ -->
          <v-card class="mb-4 concept-card" elevation="2">
            <v-card-title class="d-flex align-center">
              <span class="text-h6">ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯</span>
            </v-card-title>
            <v-card-text>
              <v-chip-group>
                <v-chip color="primary" variant="tonal">ğŸ“ æ—¥å¿—è®°å½•</v-chip>
                <v-chip color="success" variant="tonal">ğŸ”’ æƒé™æ ¡éªŒ</v-chip>
                <v-chip color="warning" variant="tonal">ğŸ’¼ äº‹åŠ¡ç®¡ç†</v-chip>
                <v-chip color="info" variant="tonal">ğŸ“Š æ€§èƒ½ç›‘æ§</v-chip>
                <v-chip color="purple" variant="tonal">ğŸš¦ é™æµæ§åˆ¶</v-chip>
                <v-chip color="orange" variant="tonal">âš ï¸ å¼‚å¸¸å¤„ç†</v-chip>
              </v-chip-group>
            </v-card-text>
          </v-card>
        </v-col>

        <!-- å³ä¾§ï¼šåŠ¨ç”»æ¼”ç¤ºå’Œè¯¦ç»†è¯´æ˜ -->
        <v-col cols="12" md="8">
          <!-- å·¥ä½œåŸç†åŠ¨ç”» -->
          <v-card class="mb-4" elevation="2">
            <v-card-title class="d-flex align-center justify-space-between">
              <div class="d-flex align-center">
                <v-icon color="primary" class="mr-2">mdi-animation-play</v-icon>
                <span>ğŸ¬ AOP å·¥ä½œåŸç†</span>
              </div>
              <v-btn
                color="primary"
                size="small"
                prepend-icon="mdi-play"
                @click="playAnimation"
                :disabled="isAnimating"
              >
                æ’­æ”¾åŠ¨ç”»
              </v-btn>
            </v-card-title>
            <v-card-text>
              <div class="animation-container" ref="animationContainer">
                <div class="flow-diagram">
                  <!-- ä¸šåŠ¡ä»£ç  -->
                  <div
                    class="flow-step"
                    :class="{ 'active': currentStep >= 1 }"
                    style="left: 50px; top: 50px;"
                  >
                    <div class="step-icon">ğŸ“</div>
                    <div class="step-label">ä¸šåŠ¡ä»£ç </div>
                    <div class="step-detail">UserService.save()</div>
                  </div>

                  <!-- ç®­å¤´ -->
                  <div
                    class="flow-arrow"
                    :class="{ 'active': currentStep >= 2 }"
                    style="left: 200px; top: 100px;"
                  >
                    â†’
                  </div>

                  <!-- AOP ä»£ç† -->
                  <div
                    class="flow-step proxy-step"
                    :class="{ 'active': currentStep >= 2 }"
                    style="left: 300px; top: 50px;"
                  >
                    <div class="step-icon">ğŸ›¡ï¸</div>
                    <div class="step-label">AOP ä»£ç†</div>
                    <div class="step-detail">æ‹¦æˆªæ–¹æ³•è°ƒç”¨</div>
                  </div>

                  <!-- ç®­å¤´ -->
                  <div
                    class="flow-arrow"
                    :class="{ 'active': currentStep >= 3 }"
                    style="left: 500px; top: 100px;"
                  >
                    â†’
                  </div>

                  <!-- åˆ‡é¢å¢å¼º -->
                  <div
                    class="flow-step aspect-step"
                    :class="{ 'active': currentStep >= 3 }"
                    style="left: 600px; top: 50px;"
                  >
                    <div class="step-icon">âœ¨</div>
                    <div class="step-label">åˆ‡é¢å¢å¼º</div>
                    <div class="step-detail">Before â†’ Around â†’ After</div>
                  </div>

                  <!-- æ‰§è¡Œç»“æœ -->
                  <div
                    class="flow-step result-step"
                    :class="{ 'active': currentStep >= 4 }"
                    style="left: 350px; top: 200px;"
                  >
                    <div class="step-icon">âœ…</div>
                    <div class="step-label">æ‰§è¡Œå®Œæˆ</div>
                    <div class="step-detail">æ—¥å¿—å·²è®°å½•<br/>äº‹åŠ¡å·²æäº¤</div>
                  </div>
                </div>
              </div>
            </v-card-text>
          </v-card>

          <!-- ä»£ç ç¤ºä¾‹ -->
          <v-card class="mb-4" elevation="2">
            <v-card-title>
              <v-icon color="primary" class="mr-2">mdi-code-tags</v-icon>
              <span>ğŸ’» ä»£ç ç¤ºä¾‹</span>
            </v-card-title>
            <v-card-text>
              <v-tabs v-model="codeTab" color="primary">
                <v-tab value="aspect">åˆ‡é¢å®šä¹‰</v-tab>
                <v-tab value="usage">ä½¿ç”¨æ–¹å¼</v-tab>
                <v-tab value="proxy">ä»£ç†æœºåˆ¶</v-tab>
              </v-tabs>
              <v-window v-model="codeTab" class="mt-4">
                <v-window-item value="aspect">
                  <pre class="code-block"><code>@Aspect
@Component
public class LogAspect {
    
    // å®šä¹‰åˆ‡å…¥ç‚¹ï¼šæ‰€æœ‰ Service çš„æ–¹æ³•
    @Pointcut("execution(* com.example.service.*.*(..))")
    public void servicePointcut() {}
    
    // å‰ç½®é€šçŸ¥ï¼šæ–¹æ³•æ‰§è¡Œå‰
    @Before("servicePointcut()")
    public void before(JoinPoint joinPoint) {
        System.out.println("æ–¹æ³•æ‰§è¡Œå‰ï¼š" + 
            joinPoint.getSignature().getName());
    }
    
    // ç¯ç»•é€šçŸ¥ï¼šæœ€çµæ´»
    @Around("servicePointcut()")
    public Object around(ProceedingJoinPoint pjp) 
            throws Throwable {
        long start = System.currentTimeMillis();
        Object result = pjp.proceed(); // æ‰§è¡ŒåŸæ–¹æ³•
        long time = System.currentTimeMillis() - start;
        System.out.println("è€—æ—¶ï¼š" + time + "ms");
        return result;
    }
}</code></pre>
                </v-window-item>
                <v-window-item value="usage">
                  <pre class="code-block"><code>// ä¸šåŠ¡ä»£ç ï¼šå®Œå…¨ä¸éœ€è¦å…³å¿ƒæ—¥å¿—
@Service
public class UserService {
    
    public void saveUser(User user) {
        // ä¸šåŠ¡é€»è¾‘
        userDao.save(user);
    }
}

// AOP è‡ªåŠ¨å¢å¼ºï¼š
// âœ… è‡ªåŠ¨è®°å½•æ—¥å¿—
// âœ… è‡ªåŠ¨å¼€å¯äº‹åŠ¡
// âœ… è‡ªåŠ¨æ€§èƒ½ç›‘æ§
// ä¸šåŠ¡ä»£ç ä¿æŒç®€æ´ï¼</code></pre>
                </v-window-item>
                <v-window-item value="proxy">
                  <pre class="code-block"><code>// Spring AOP åŸºäºåŠ¨æ€ä»£ç†
// 1. JDK åŠ¨æ€ä»£ç†ï¼ˆæœ‰æ¥å£ï¼‰
UserService proxy = (UserService) 
    Proxy.newProxyInstance(
        classLoader,
        new Class[]{UserService.class},
        new InvocationHandler() {
            @Override
            public Object invoke(...) {
                // æ‰§è¡Œåˆ‡é¢é€»è¾‘
                // è°ƒç”¨åŸæ–¹æ³•
            }
        }
    );

// 2. CGLIB ä»£ç†ï¼ˆæ— æ¥å£ï¼‰
// é€šè¿‡ç»§æ‰¿ç”Ÿæˆå­ç±»ï¼Œè¦†ç›–æ–¹æ³•</code></pre>
                </v-window-item>
              </v-window>
            </v-card-text>
          </v-card>

          <!-- å¸¸è§é—®é¢˜ -->
          <v-card class="mb-4" elevation="2">
            <v-card-title>
              <v-icon color="warning" class="mr-2">mdi-alert-circle</v-icon>
              <span>âš ï¸ AOP å¤±æ•ˆåœºæ™¯</span>
            </v-card-title>
            <v-card-text>
              <v-expansion-panels>
                <v-expansion-panel
                  v-for="(issue, idx) in commonIssues"
                  :key="idx"
                  :title="issue.title"
                >
                  <v-expansion-panel-text>
                    <div class="text-body-2 mb-2">
                      <strong>åŸå› ï¼š</strong>{{ issue.reason }}
                    </div>
                    <div class="text-body-2">
                      <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>{{ issue.solution }}
                    </div>
                  </v-expansion-panel-text>
                </v-expansion-panel>
              </v-expansion-panels>
            </v-card-text>
          </v-card>

          <!-- æœ€ä½³å®è·µ -->
          <v-card elevation="2">
            <v-card-title>
              <v-icon color="success" class="mr-2">mdi-star</v-icon>
              <span>â­ æœ€ä½³å®è·µ</span>
            </v-card-title>
            <v-card-text>
              <v-list>
                <v-list-item
                  v-for="(tip, idx) in bestPractices"
                  :key="idx"
                  :prepend-icon="tip.icon"
                >
                  <v-list-item-title>{{ tip.text }}</v-list-item-title>
                </v-list-item>
              </v-list>
            </v-card-text>
          </v-card>
        </v-col>
      </v-row>
    </v-container>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';

const isAnimating = ref(false);
const currentStep = ref(0);
const codeTab = ref('aspect');
const animationContainer = ref<HTMLElement | null>(null);

const commonIssues = ref([
  {
    title: 'âŒ åŒç±»å†…éƒ¨è°ƒç”¨å¤±æ•ˆ',
    reason: 'this.method() è°ƒç”¨ä¸èµ°ä»£ç†å¯¹è±¡ï¼ŒAOP æ— æ³•æ‹¦æˆª',
    solution: 'ä½¿ç”¨ AopContext.currentProxy() æˆ–æ‹†åˆ†åˆ°å…¶ä»– Bean',
  },
  {
    title: 'âŒ private æ–¹æ³•æ— æ³•ä»£ç†',
    reason: 'private æ–¹æ³•æ— æ³•è¢«ç»§æ‰¿æˆ–å®ç°ï¼Œä»£ç†æœºåˆ¶æ— æ³•è¦†ç›–',
    solution: 'æ”¹ä¸º public æˆ– protectedï¼Œæˆ–ä½¿ç”¨ AspectJ ç¼–è¯‘æœŸç»‡å…¥',
  },
  {
    title: 'âŒ final/static æ–¹æ³•å¤±æ•ˆ',
    reason: 'final æ— æ³•è¦†å†™ï¼Œstatic å±äºç±»ä¸å±äºå®ä¾‹',
    solution: 'é¿å…åœ¨éœ€è¦ AOP çš„æ–¹æ³•ä¸Šä½¿ç”¨ final/static',
  },
]);

const bestPractices = ref([
  {
    icon: 'mdi-check-circle',
    text: 'ğŸ¯ ä½¿ç”¨ @Around æ—¶è®°å¾—è°ƒç”¨ proceed()ï¼Œå¦åˆ™åŸæ–¹æ³•ä¸ä¼šæ‰§è¡Œ',
  },
  {
    icon: 'mdi-check-circle',
    text: 'ğŸ“ åˆ‡ç‚¹è¡¨è¾¾å¼è¦ç²¾ç¡®ï¼Œé¿å…è¯¯æ‹¦æˆªå…¶ä»–æ–¹æ³•',
  },
  {
    icon: 'mdi-check-circle',
    text: 'âš¡ æ€§èƒ½æ•æ„Ÿåœºæ™¯æ³¨æ„åˆ‡é¢é€»è¾‘çš„æ‰§è¡Œæ—¶é—´',
  },
  {
    icon: 'mdi-check-circle',
    text: 'ğŸ” ä½¿ç”¨ @Order æ§åˆ¶å¤šä¸ªåˆ‡é¢çš„æ‰§è¡Œé¡ºåº',
  },
  {
    icon: 'mdi-check-circle',
    text: 'âœ… ä¼˜å…ˆä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼ˆæœ‰æ¥å£æ—¶ï¼‰ï¼Œæ€§èƒ½æ›´å¥½',
  },
]);

const playAnimation = async () => {
  if (isAnimating.value) return;
  isAnimating.value = true;
  currentStep.value = 0;

  for (let i = 1; i <= 4; i++) {
    await new Promise(resolve => setTimeout(resolve, 800));
    currentStep.value = i;
  }

  await new Promise(resolve => setTimeout(resolve, 1000));
  isAnimating.value = false;
};
</script>

<style scoped lang="scss">
.spring-aop-view {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px 0;
}

.title-card {
  background: rgba(255, 255, 255, 0.95) !important;
  border-radius: 20px !important;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
}

.concept-card {
  border-radius: 16px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  
  &:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
  }
}

.example-box {
  background: #f5f5f5;
  border-left: 4px solid #667eea;
  padding: 12px;
  border-radius: 8px;
  
  .code-snippet {
    margin: 0;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    color: #333;
  }
}

.animation-container {
  position: relative;
  height: 400px;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border-radius: 12px;
  overflow: hidden;
  
  .flow-diagram {
    position: relative;
    width: 100%;
    height: 100%;
  }
  
  .flow-step {
    position: absolute;
    width: 150px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    opacity: 0.5;
    transform: scale(0.9);
    transition: all 0.5s ease;
    
    &.active {
      opacity: 1;
      transform: scale(1);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }
    
    .step-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .step-label {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .step-detail {
      font-size: 12px;
      color: #666;
    }
    
    &.proxy-step.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      
      .step-detail {
        color: rgba(255, 255, 255, 0.9);
      }
    }
    
    &.aspect-step.active {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      
      .step-detail {
        color: rgba(255, 255, 255, 0.9);
      }
    }
    
    &.result-step.active {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      
      .step-detail {
        color: rgba(255, 255, 255, 0.9);
      }
    }
  }
  
  .flow-arrow {
    position: absolute;
    font-size: 32px;
    color: #999;
    opacity: 0.3;
    transition: all 0.5s ease;
    
    &.active {
      opacity: 1;
      color: #667eea;
      animation: arrowPulse 1s ease-in-out infinite;
    }
  }
}

@keyframes arrowPulse {
  0%, 100% {
    transform: translateX(0);
  }
  50% {
    transform: translateX(10px);
  }
}

.code-block {
  background: #263238;
  color: #aed581;
  padding: 20px;
  border-radius: 8px;
  overflow-x: auto;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.6;
  margin: 0;
}

// å“åº”å¼è®¾è®¡
@media (max-width: 960px) {
  .animation-container {
    height: 300px;
  }
  
  .flow-step {
    width: 120px !important;
    padding: 12px !important;
  }
}
</style>

