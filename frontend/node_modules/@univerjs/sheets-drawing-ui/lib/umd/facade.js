(function(c,l){typeof exports=="object"&&typeof module<"u"?l(require("@univerjs/core"),require("@univerjs/core/facade"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/sheets-drawing-ui"),require("@univerjs/sheets-ui"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-ui/facade"),require("@univerjs/sheets/facade"),require("@univerjs/ui")):typeof define=="function"&&define.amd?define(["@univerjs/core","@univerjs/core/facade","@univerjs/drawing","@univerjs/engine-render","@univerjs/sheets-drawing-ui","@univerjs/sheets-ui","@univerjs/sheets-drawing","@univerjs/sheets-ui/facade","@univerjs/sheets/facade","@univerjs/ui"],l):(c=typeof globalThis<"u"?globalThis:c||self,l(c.UniverCore,c.UniverCoreFacade,c.UniverDrawing,c.UniverEngineRender,c.UniverSheetsDrawingUi,c.UniverSheetsUi,c.UniverSheetsDrawing,c.UniverSheetsUiFacade,c.UniverSheetsFacade,c.UniverUi))})(this,(function(c,l,v,E,g,D,w,b,C,F){"use strict";var H=Object.defineProperty;var K=(c,l,v)=>l in c?H(c,l,{enumerable:!0,configurable:!0,writable:!0,value:v}):c[l]=v;var B=(c,l,v)=>K(c,typeof l!="symbol"?l+"":l,v);var j=Object.getOwnPropertyDescriptor,O=(o,i,t,e)=>{for(var r=e>1?void 0:e?j(i,t):i,n=o.length-1,a;n>=0;n--)(a=o[n])&&(r=a(r)||r);return r},R=(o,i)=>(t,e)=>i(t,e,o);function A(o,i){const{from:t,to:e,flipY:r=!1,flipX:n=!1,angle:a=0,skewX:s=0,skewY:d=0}=o.sheetTransform,{column:u,columnOffset:m,row:h,rowOffset:I}=t,_=D.convertPositionSheetOverGridToAbsolute(o.unitId,o.subUnitId,{from:t,to:e},i),{width:f,height:S}=_;return{...o,column:u,columnOffset:m,row:h,rowOffset:I,width:f,height:S,flipY:r,flipX:n,angle:a,skewX:s,skewY:d}}function G(o,i,t){const{column:e,columnOffset:r,row:n,rowOffset:a,flipY:s=!1,flipX:d=!1,angle:u=0,skewX:m=0,skewY:h=0,width:I,height:_}=o,f=D.convertPositionCellToSheetOverGrid(o.unitId,o.subUnitId,{column:e,columnOffset:r,row:n,rowOffset:a},I,_,i,t),{sheetTransform:S,transform:T}=f;return{...o,sheetTransform:{...S,flipY:s,flipX:d,angle:u,skewX:m,skewY:h},transform:{...T,flipY:s,flipX:d,angle:u,skewX:m,skewY:h}}}let y=class{constructor(o,i,t){B(this,"_image");this._injector=t,this._image={drawingId:c.generateRandomId(6),drawingType:c.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:c.ImageSourceType.BASE64,source:"",unitId:o,subUnitId:i,column:0,columnOffset:0,row:0,rowOffset:0,width:0,height:0}}setImage(o){const t=this._injector.get(E.IRenderManagerService).getRenderById(o.unitId);if(!t)throw new Error(`Render Unit with unitId ${o.unitId} not found`);const e=t.with(D.SheetSkeletonManagerService);return o.sheetTransform==null&&(o.sheetTransform={from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}),this._image=A(o,e),this}setSource(o,i){const t=i!=null?i:c.ImageSourceType.URL;return this._image.source=o,this._image.imageSourceType=t,this}getSource(){return this._image.source}getSourceType(){return this._image.imageSourceType}setColumn(o){return this._image.column=o,this}setRow(o){return this._image.row=o,this}setColumnOffset(o){return this._image.columnOffset=o,this}setRowOffset(o){return this._image.rowOffset=o,this}setWidth(o){return this._image.width=o,this}setHeight(o){return this._image.height=o,this}setAnchorType(o){return this._image.anchorType=o,this}setCropTop(o){return this._initializeSrcRect(),this._image.srcRect.top=o,this}setCropLeft(o){return this._initializeSrcRect(),this._image.srcRect.left=o,this}setCropBottom(o){return this._initializeSrcRect(),this._image.srcRect.bottom=o,this}setCropRight(o){return this._initializeSrcRect(),this._image.srcRect.right=o,this}_initializeSrcRect(){this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0})}setRotate(o){return this._image.angle=o,this}setUnitId(o){return this._image.unitId=o,this}setSubUnitId(o){return this._image.subUnitId=o,this}async buildAsync(){const i=this._injector.get(E.IRenderManagerService).getRenderById(this._image.unitId);if(!i)throw new Error(`Render Unit with unitId ${this._image.unitId} not found`);const t=i.with(D.ISheetSelectionRenderService),e=i.with(D.SheetSkeletonManagerService);if(this._image.width===0||this._image.height===0){const r=await v.getImageSize(this._image.source),n=r.width,a=r.height;this._image.width===0&&(this._image.width=n),this._image.height===0&&(this._image.height=a)}return G(this._image,t,e)}};y=O([R(2,c.Inject(c.Injector))],y);let p=class extends l.FBase{constructor(o,i,t){super(),this._image=o,this._commandService=i,this._injector=t}getId(){return this._image.drawingId}getType(){return this._image.drawingType}remove(){return this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}toBuilder(){const o=this._injector.createInstance(y);return o.setImage(this._image),o}setSource(o,i){const t=i!=null?i:c.ImageSourceType.URL;return this._image.source=o,this._image.imageSourceType=t,this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}async setPositionAsync(o,i,t,e){const r=this.toBuilder();r.setColumn(i),r.setRow(o),t!=null&&r.setRowOffset(t),e!=null&&r.setColumnOffset(e);const n=await r.buildAsync();return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[n]})}async setSizeAsync(o,i){const t=this.toBuilder();t.setWidth(o),t.setHeight(i);const e=await t.buildAsync();return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[e]})}setCrop(o,i,t,e){return this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0}),o!=null&&(this._image.srcRect.top=o),i!=null&&(this._image.srcRect.left=i),t!=null&&(this._image.srcRect.bottom=t),e!=null&&(this._image.srcRect.right=e),this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setRotate(o){return this._image.sheetTransform.angle=o,this._image.transform&&(this._image.transform.angle=o),this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setForward(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:c.ArrangeTypeEnum.forward})}setBackward(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:c.ArrangeTypeEnum.backward})}setBack(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:c.ArrangeTypeEnum.back})}setFront(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:c.ArrangeTypeEnum.front})}};p=O([R(1,c.ICommandService),R(2,c.Inject(c.Injector))],p);class M extends C.FWorksheet{getFloatDomById(i){const e=this._injector.get(g.SheetCanvasFloatDomManagerService).getFloatDomInfo(i);if(!e)return null;const{unitId:r,subUnitId:n}=e,{rect:a}=e,s=a.getState(),{left:d=0,top:u=0,width:m=0,height:h=0,flipX:I=!1,flipY:_=!1,angle:f=0,skewX:S=0,skewY:T=0}=s,k=this._injector.get(w.ISheetDrawingService).getDrawingByParam({drawingId:e.id,unitId:r,subUnitId:n});return k?{position:{left:d,top:u,width:m,height:h,flipX:I,flipY:_,angle:f,skewX:S,skewY:T},componentKey:k.componentKey,allowTransform:k.allowTransform,data:k.data,id:e.id}:null}getAllFloatDoms(){const i=this._injector.get(g.SheetCanvasFloatDomManagerService),t=this._workbook.getUnitId(),e=this._worksheet.getSheetId();return Array.from(i.getFloatDomsBySubUnitId(t,e).values()).map(r=>{const{rect:n}=r,a=this._injector.get(w.ISheetDrawingService).getDrawingByParam({drawingId:r.id,unitId:t,subUnitId:e}),{left:s,top:d,width:u,height:m,flipX:h,flipY:I,angle:_,skewX:f,skewY:S}=n.getState();return{position:{left:s,top:d,width:u,height:m,flipX:h,flipY:I,angle:_,skewX:f,skewY:S},componentKey:a.componentKey,allowTransform:a.allowTransform,data:a.data,id:r.id}})}updateFloatDom(i,t){var f,S;const r=this._injector.get(g.SheetCanvasFloatDomManagerService).getFloatDomInfo(i);if(!r)return this;const{unitId:n,subUnitId:a}=r,s=this._injector.get(w.ISheetDrawingService).getDrawingByParam({unitId:n,subUnitId:a,drawingId:i}),d=this._injector.get(E.IRenderManagerService);if(!d.getRenderById(n))return this;if(!this.getSkeleton())return this;const h=(f=d.getRenderById(this.getWorkbook().getUnitId()))==null?void 0:f.with(D.ISheetSelectionRenderService);if(!h)return this;const I={...s,componentKey:t.componentKey||s.componentKey,allowTransform:t.allowTransform!==void 0?t.allowTransform:s.allowTransform,data:t.data||s.data,sheetTransform:t.position&&(S=g.transformToDrawingPosition(t.position,h))!=null?S:s.sheetTransform,transform:{...s.transform,...t.position}};if(!this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:n,subUnitId:a,drawings:[I]}))throw new Error("updateFloatDom failed");return this}batchUpdateFloatDoms(i){var a;const t=this._injector.get(g.SheetCanvasFloatDomManagerService),e=this._injector.get(w.ISheetDrawingService),r=this._injector.get(E.IRenderManagerService),n=[];for(const s of i){const d=t.getFloatDomInfo(s.id);if(!d)continue;const{unitId:u,subUnitId:m}=d,h=e.getDrawingByParam({unitId:u,subUnitId:m,drawingId:s.id});if(!h)continue;const I=r.getRenderById(u);if(!I||!this.getSkeleton())continue;const f=I.with(D.ISheetSelectionRenderService);if(!f)return this;const S={...h,componentKey:s.config.componentKey||h.componentKey,allowTransform:s.config.allowTransform!==void 0?s.config.allowTransform:h.allowTransform,data:s.config.data||h.data,sheetTransform:s.config.position&&(a=g.transformToDrawingPosition(s.config.position,f))!=null?a:h.sheetTransform,transform:{...h.transform,...s.config.position}};n.push(S)}if(n.length>0){const s=this._workbook.getUnitId(),d=this._worksheet.getSheetId();if(!this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:s,subUnitId:d,drawings:n}))throw new Error("batchUpdateFloatDoms failed")}return this}removeFloatDom(i){const e=this._injector.get(g.SheetCanvasFloatDomManagerService).getFloatDomInfo(i);if(!e)return this;const{unitId:r,subUnitId:n}=e,s=this._injector.get(w.ISheetDrawingService).getDrawingByParam({unitId:r,subUnitId:n,drawingId:i});if(!s)return this;if(!this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:r,drawings:[s]}))throw new Error("removeFloatDom failed");return this}addFloatDomToPosition(i,t){const e=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),{key:n,disposableCollection:a}=b.transformComponentKey(i,this._injector.get(F.ComponentManager)),d=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToPosition({...i,componentKey:n,unitId:e,subUnitId:r},t);return d?(a.add(d.dispose),{id:d.id,dispose:()=>{a.dispose(),d.dispose()}}):(a.dispose(),null)}addFloatDomToRange(i,t,e,r){const n=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:s,disposableCollection:d}=b.transformComponentKey(t,this._injector.get(F.ComponentManager)),m=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToRange(i.getRange(),{...t,componentKey:s,unitId:n,subUnitId:a},e,r);return m?(d.add(m.dispose),{id:m.id,dispose:()=>{d.dispose(),m.dispose()}}):(d.dispose(),null)}addFloatDomToColumnHeader(i,t,e,r){const n=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:s,disposableCollection:d}=b.transformComponentKey(t,this._injector.get(F.ComponentManager)),m=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToColumnHeader(i,{...t,componentKey:s,unitId:n,subUnitId:a},e,r);return m?(d.add(m.dispose),{id:m.id,dispose:()=>{d.dispose(),m.dispose()}}):(d.dispose(),null)}async insertImage(i,t,e,r,n){const a=this.newOverGridImage();if(typeof i=="string")a.setSource(i);else{const u=await i.getBlob().getDataAsString();a.setSource(u,c.ImageSourceType.BASE64)}t!==void 0?a.setColumn(t):a.setColumn(0),e!==void 0?a.setRow(e):a.setRow(0),r!==void 0?a.setColumnOffset(r):a.setColumnOffset(0),n!==void 0?a.setRowOffset(n):a.setRowOffset(0);const s=await a.buildAsync();return this._commandService.syncExecuteCommand(g.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:[s]})}insertImages(i){const t=i.map(e=>(e.unitId=this._fWorkbook.getId(),e.subUnitId=this.getSheetId(),e));return this._commandService.syncExecuteCommand(g.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}deleteImages(i){const t=i.map(e=>({unitId:this._fWorkbook.getId(),drawingId:e.getId(),subUnitId:this.getSheetId(),drawingType:e.getType()}));return this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}getImages(){const t=this._injector.get(w.ISheetDrawingService).getDrawingData(this._fWorkbook.getId(),this.getSheetId()),e=[];for(const r in t){const n=t[r];n.drawingType===c.DrawingTypeEnum.DRAWING_IMAGE&&e.push(this._injector.createInstance(p,n))}return e}getImageById(i){const e=this._injector.get(w.ISheetDrawingService).getDrawingByParam({unitId:this._fWorkbook.getId(),subUnitId:this.getSheetId(),drawingId:i});return e&&e.drawingType===c.DrawingTypeEnum.DRAWING_IMAGE?this._injector.createInstance(p,e):null}getActiveImages(){const t=this._injector.get(w.ISheetDrawingService).getFocusDrawings(),e=[];for(const r in t){const n=t[r];e.push(this._injector.createInstance(p,n))}return e}updateImages(i){return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:i}),this}onImageInserted(i){const t=this._injector.get(w.ISheetDrawingService);return c.toDisposable(t.add$.subscribe(e=>{const r=e.map(n=>this._injector.createInstance(p,t.getDrawingByParam(n)));i(r)}))}onImageDeleted(i){const t=this._injector.get(w.ISheetDrawingService);return c.toDisposable(t.remove$.subscribe(e=>{const r=e.map(n=>this._injector.createInstance(p,t.getDrawingByParam(n)));i(r)}))}onImageChanged(i){const t=this._injector.get(w.ISheetDrawingService);return c.toDisposable(t.update$.subscribe(e=>{const r=e.map(n=>this._injector.createInstance(p,t.getDrawingByParam(n)));i(r)}))}newOverGridImage(){const i=this._fWorkbook.getId(),t=this.getSheetId();return this._injector.createInstance(y,i,t)}}C.FWorksheet.extend(M);class x extends l.FEnum{get DrawingType(){return c.DrawingTypeEnum}get ImageSourceType(){return c.ImageSourceType}get SheetDrawingAnchorType(){return w.SheetDrawingAnchorType}}l.FEnum.extend(x);class P extends l.FEventName{get BeforeFloatDomAdd(){return"BeforeFloatDomAdd"}get FloatDomAdded(){return"FloatDomAdded"}get BeforeFloatDomUpdate(){return"BeforeFloatDomUpdate"}get FloatDomUpdated(){return"FloatDomUpdated"}get BeforeFloatDomDelete(){return"BeforeFloatDomDelete"}get FloatDomDeleted(){return"FloatDomDeleted"}get BeforeOverGridImageChange(){return"BeforeOverGridImageChange"}get OverGridImageChanged(){return"OverGridImageChanged"}get BeforeOverGridImageInsert(){return"BeforeOverGridImageInsert"}get OverGridImageInserted(){return"OverGridImageInserted"}get BeforeOverGridImageRemove(){return"BeforeOverGridImageRemove"}get OverGridImageRemoved(){return"OverGridImageRemoved"}get BeforeOverGridImageSelect(){return"BeforeOverGridImageSelect"}get OverGridImageSelected(){return"OverGridImageSelected"}}l.FEventName.extend(P);class W extends l.FUniver{_initialize(i){const t=i.get(c.ICommandService);this.registerEventHandler(this.Event.BeforeFloatDomAdd,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r,s=a.filter(u=>u.drawingType===c.DrawingTypeEnum.DRAWING_DOM);if(s.length===0)return;const d={workbook:n,drawings:s};if(this.fireEvent(this.Event.BeforeFloatDomAdd,d),d.cancel)throw new c.CanceledError})),this.registerEventHandler(this.Event.FloatDomAdded,()=>t.onCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r,s=a.filter(d=>d.drawingType===c.DrawingTypeEnum.DRAWING_DOM);s.length!==0&&this.fireEvent(this.Event.FloatDomAdded,{workbook:n,drawings:s})})),this.registerEventHandler(this.Event.BeforeOverGridImageInsert,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r,s={workbook:n,insertImageParams:a};if(this.fireEvent(this.Event.BeforeOverGridImageInsert,s),s.cancel)throw new c.CanceledError})),this.registerEventHandler(this.Event.BeforeOverGridImageRemove,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const a=i.get(v.IDrawingManagerService),{drawings:s}=r,d=s.map(m=>a.getDrawingByParam(m)),u={workbook:n,images:this._createFOverGridImage(d)};if(this.fireEvent(this.Event.BeforeOverGridImageRemove,u),u.cancel)throw new c.CanceledError})),this.registerEventHandler(this.Event.BeforeOverGridImageChange,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r,s=i.get(v.IDrawingManagerService),d=[];a.forEach(m=>{const h=s.getDrawingByParam(m);h!=null&&d.push({changeParam:m,image:this._injector.createInstance(p,h)})});const u={workbook:n,images:d};if(this.fireEvent(this.Event.BeforeOverGridImageChange,u),u.cancel)throw s.updateNotification(a),new c.CanceledError})),this.registerEventHandler(this.Event.BeforeFloatDomUpdate,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r,s=i.get(v.IDrawingManagerService),d=[];if(a.forEach(m=>{const h=s.getDrawingByParam(m);(h==null?void 0:h.drawingType)===c.DrawingTypeEnum.DRAWING_DOM&&d.push(h)}),d.length===0)return;const u={workbook:n,drawings:d};if(this.fireEvent(this.Event.BeforeFloatDomUpdate,u),u.cancel)throw s.updateNotification(a),new c.CanceledError})),this.registerEventHandler(this.Event.FloatDomUpdated,()=>t.onCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r,s=i.get(v.IDrawingManagerService),d=[];a.forEach(u=>{const m=s.getDrawingByParam(u);(m==null?void 0:m.drawingType)===c.DrawingTypeEnum.DRAWING_DOM&&d.push(m)}),d.length!==0&&this.fireEvent(this.Event.FloatDomUpdated,{workbook:n,drawings:d})})),this.registerEventHandler(this.Event.BeforeFloatDomDelete,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const a=i.get(v.IDrawingManagerService),{drawings:s}=r,d=s.map(m=>a.getDrawingByParam(m)).filter(m=>(m==null?void 0:m.drawingType)===c.DrawingTypeEnum.DRAWING_DOM);if(d.length===0)return;const u={workbook:n,drawings:d};if(this.fireEvent(this.Event.BeforeFloatDomDelete,u),u.cancel)throw new c.CanceledError})),this.registerEventHandler(this.Event.FloatDomDeleted,()=>t.onCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r;this.fireEvent(this.Event.FloatDomDeleted,{workbook:n,drawings:a.filter(s=>s.drawingType===c.DrawingTypeEnum.DRAWING_DOM).map(s=>s.drawingId)})})),this.registerEventHandler(this.Event.BeforeOverGridImageSelect,()=>t.beforeCommandExecuted(e=>{if(e.id!==v.SetDrawingSelectedOperation.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null)return;const a=i.get(v.IDrawingManagerService),s=a.getFocusDrawings(),d=r.map(m=>a.getDrawingByParam(m)),u={workbook:n,selectedImages:this._createFOverGridImage(d),oldSelectedImages:this._createFOverGridImage(s)};if(this.fireEvent(this.Event.BeforeOverGridImageSelect,u),u.cancel)throw new c.CanceledError})),this.registerEventHandler(this.Event.OverGridImageInserted,()=>t.onCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r;this.fireEvent(this.Event.OverGridImageInserted,{workbook:n,images:this._createFOverGridImage(a)})})),this.registerEventHandler(this.Event.OverGridImageRemoved,()=>t.onCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r;this.fireEvent(this.Event.OverGridImageRemoved,{workbook:n,removeImageParams:a})})),this.registerEventHandler(this.Event.OverGridImageChanged,()=>t.onCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null||r==null)return;const{drawings:a}=r,s=i.get(v.IDrawingManagerService),d=a.map(u=>this._injector.createInstance(p,s.getDrawingByParam(u)));this.fireEvent(this.Event.OverGridImageChanged,{workbook:n,images:d})})),this.registerEventHandler(this.Event.OverGridImageSelected,()=>t.onCommandExecuted(e=>{if(e.id!==v.SetDrawingSelectedOperation.id)return;const r=e.params,n=this.getActiveWorkbook();if(n==null)return;const a=i.get(v.IDrawingManagerService),s=r.map(d=>a.getDrawingByParam(d));this.fireEvent(this.Event.OverGridImageSelected,{workbook:n,selectedImages:this._createFOverGridImage(s)})}))}_createFOverGridImage(i){return i.map(t=>this._injector.createInstance(p,t))}}l.FUniver.extend(W);class U extends C.FRange{async insertCellImageAsync(i){var n;const t=this._injector.get(E.IRenderManagerService),e=(n=E.getCurrentTypeOfRenderer(c.UniverInstanceType.UNIVER_SHEET,this._injector.get(c.IUniverInstanceService),t))==null?void 0:n.with(g.SheetDrawingUpdateController);if(!e)return!1;const r={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this.getRow(),col:this.getColumn()};return typeof i=="string"?e.insertCellImageByUrl(i,r):e.insertCellImageByFile(i,r)}}C.FRange.extend(U)}));
