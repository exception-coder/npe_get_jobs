"use strict";var U=Object.defineProperty;var A=(o,r,t)=>r in o?U(o,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[r]=t;var T=(o,r,t)=>A(o,typeof r!="symbol"?r+"":r,t);const h=require("@univerjs/core"),_=require("@univerjs/core/facade"),I=require("@univerjs/drawing"),E=require("@univerjs/engine-render"),g=require("@univerjs/sheets-drawing-ui"),p=require("@univerjs/sheets-ui"),v=require("@univerjs/sheets-drawing"),R=require("@univerjs/sheets-ui/facade"),y=require("@univerjs/sheets/facade"),F=require("@univerjs/ui");var G=Object.getOwnPropertyDescriptor,B=(o,r,t,e)=>{for(var n=e>1?void 0:e?G(r,t):r,i=o.length-1,a;i>=0;i--)(a=o[i])&&(n=a(n)||n);return n},O=(o,r)=>(t,e)=>r(t,e,o);function M(o,r){const{from:t,to:e,flipY:n=!1,flipX:i=!1,angle:a=0,skewX:s=0,skewY:d=0}=o.sheetTransform,{column:m,columnOffset:c,row:u,rowOffset:w}=t,D=p.convertPositionSheetOverGridToAbsolute(o.unitId,o.subUnitId,{from:t,to:e},r),{width:l,height:f}=D;return{...o,column:m,columnOffset:c,row:u,rowOffset:w,width:l,height:f,flipY:n,flipX:i,angle:a,skewX:s,skewY:d}}function x(o,r,t){const{column:e,columnOffset:n,row:i,rowOffset:a,flipY:s=!1,flipX:d=!1,angle:m=0,skewX:c=0,skewY:u=0,width:w,height:D}=o,l=p.convertPositionCellToSheetOverGrid(o.unitId,o.subUnitId,{column:e,columnOffset:n,row:i,rowOffset:a},w,D,r,t),{sheetTransform:f,transform:b}=l;return{...o,sheetTransform:{...f,flipY:s,flipX:d,angle:m,skewX:c,skewY:u},transform:{...b,flipY:s,flipX:d,angle:m,skewX:c,skewY:u}}}let k=class{constructor(o,r,t){T(this,"_image");this._injector=t,this._image={drawingId:h.generateRandomId(6),drawingType:h.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:h.ImageSourceType.BASE64,source:"",unitId:o,subUnitId:r,column:0,columnOffset:0,row:0,rowOffset:0,width:0,height:0}}setImage(o){const t=this._injector.get(E.IRenderManagerService).getRenderById(o.unitId);if(!t)throw new Error(`Render Unit with unitId ${o.unitId} not found`);const e=t.with(p.SheetSkeletonManagerService);return o.sheetTransform==null&&(o.sheetTransform={from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}),this._image=M(o,e),this}setSource(o,r){const t=r!=null?r:h.ImageSourceType.URL;return this._image.source=o,this._image.imageSourceType=t,this}getSource(){return this._image.source}getSourceType(){return this._image.imageSourceType}setColumn(o){return this._image.column=o,this}setRow(o){return this._image.row=o,this}setColumnOffset(o){return this._image.columnOffset=o,this}setRowOffset(o){return this._image.rowOffset=o,this}setWidth(o){return this._image.width=o,this}setHeight(o){return this._image.height=o,this}setAnchorType(o){return this._image.anchorType=o,this}setCropTop(o){return this._initializeSrcRect(),this._image.srcRect.top=o,this}setCropLeft(o){return this._initializeSrcRect(),this._image.srcRect.left=o,this}setCropBottom(o){return this._initializeSrcRect(),this._image.srcRect.bottom=o,this}setCropRight(o){return this._initializeSrcRect(),this._image.srcRect.right=o,this}_initializeSrcRect(){this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0})}setRotate(o){return this._image.angle=o,this}setUnitId(o){return this._image.unitId=o,this}setSubUnitId(o){return this._image.subUnitId=o,this}async buildAsync(){const r=this._injector.get(E.IRenderManagerService).getRenderById(this._image.unitId);if(!r)throw new Error(`Render Unit with unitId ${this._image.unitId} not found`);const t=r.with(p.ISheetSelectionRenderService),e=r.with(p.SheetSkeletonManagerService);if(this._image.width===0||this._image.height===0){const n=await I.getImageSize(this._image.source),i=n.width,a=n.height;this._image.width===0&&(this._image.width=i),this._image.height===0&&(this._image.height=a)}return x(this._image,t,e)}};k=B([O(2,h.Inject(h.Injector))],k);let S=class extends _.FBase{constructor(o,r,t){super(),this._image=o,this._commandService=r,this._injector=t}getId(){return this._image.drawingId}getType(){return this._image.drawingType}remove(){return this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}toBuilder(){const o=this._injector.createInstance(k);return o.setImage(this._image),o}setSource(o,r){const t=r!=null?r:h.ImageSourceType.URL;return this._image.source=o,this._image.imageSourceType=t,this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}async setPositionAsync(o,r,t,e){const n=this.toBuilder();n.setColumn(r),n.setRow(o),t!=null&&n.setRowOffset(t),e!=null&&n.setColumnOffset(e);const i=await n.buildAsync();return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[i]})}async setSizeAsync(o,r){const t=this.toBuilder();t.setWidth(o),t.setHeight(r);const e=await t.buildAsync();return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[e]})}setCrop(o,r,t,e){return this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0}),o!=null&&(this._image.srcRect.top=o),r!=null&&(this._image.srcRect.left=r),t!=null&&(this._image.srcRect.bottom=t),e!=null&&(this._image.srcRect.right=e),this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setRotate(o){return this._image.sheetTransform.angle=o,this._image.transform&&(this._image.transform.angle=o),this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setForward(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:h.ArrangeTypeEnum.forward})}setBackward(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:h.ArrangeTypeEnum.backward})}setBack(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:h.ArrangeTypeEnum.back})}setFront(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:h.ArrangeTypeEnum.front})}};S=B([O(1,h.ICommandService),O(2,h.Inject(h.Injector))],S);class P extends y.FWorksheet{getFloatDomById(r){const e=this._injector.get(g.SheetCanvasFloatDomManagerService).getFloatDomInfo(r);if(!e)return null;const{unitId:n,subUnitId:i}=e,{rect:a}=e,s=a.getState(),{left:d=0,top:m=0,width:c=0,height:u=0,flipX:w=!1,flipY:D=!1,angle:l=0,skewX:f=0,skewY:b=0}=s,C=this._injector.get(v.ISheetDrawingService).getDrawingByParam({drawingId:e.id,unitId:n,subUnitId:i});return C?{position:{left:d,top:m,width:c,height:u,flipX:w,flipY:D,angle:l,skewX:f,skewY:b},componentKey:C.componentKey,allowTransform:C.allowTransform,data:C.data,id:e.id}:null}getAllFloatDoms(){const r=this._injector.get(g.SheetCanvasFloatDomManagerService),t=this._workbook.getUnitId(),e=this._worksheet.getSheetId();return Array.from(r.getFloatDomsBySubUnitId(t,e).values()).map(n=>{const{rect:i}=n,a=this._injector.get(v.ISheetDrawingService).getDrawingByParam({drawingId:n.id,unitId:t,subUnitId:e}),{left:s,top:d,width:m,height:c,flipX:u,flipY:w,angle:D,skewX:l,skewY:f}=i.getState();return{position:{left:s,top:d,width:m,height:c,flipX:u,flipY:w,angle:D,skewX:l,skewY:f},componentKey:a.componentKey,allowTransform:a.allowTransform,data:a.data,id:n.id}})}updateFloatDom(r,t){var l,f;const n=this._injector.get(g.SheetCanvasFloatDomManagerService).getFloatDomInfo(r);if(!n)return this;const{unitId:i,subUnitId:a}=n,s=this._injector.get(v.ISheetDrawingService).getDrawingByParam({unitId:i,subUnitId:a,drawingId:r}),d=this._injector.get(E.IRenderManagerService);if(!d.getRenderById(i))return this;if(!this.getSkeleton())return this;const u=(l=d.getRenderById(this.getWorkbook().getUnitId()))==null?void 0:l.with(p.ISheetSelectionRenderService);if(!u)return this;const w={...s,componentKey:t.componentKey||s.componentKey,allowTransform:t.allowTransform!==void 0?t.allowTransform:s.allowTransform,data:t.data||s.data,sheetTransform:t.position&&(f=g.transformToDrawingPosition(t.position,u))!=null?f:s.sheetTransform,transform:{...s.transform,...t.position}};if(!this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:i,subUnitId:a,drawings:[w]}))throw new Error("updateFloatDom failed");return this}batchUpdateFloatDoms(r){var a;const t=this._injector.get(g.SheetCanvasFloatDomManagerService),e=this._injector.get(v.ISheetDrawingService),n=this._injector.get(E.IRenderManagerService),i=[];for(const s of r){const d=t.getFloatDomInfo(s.id);if(!d)continue;const{unitId:m,subUnitId:c}=d,u=e.getDrawingByParam({unitId:m,subUnitId:c,drawingId:s.id});if(!u)continue;const w=n.getRenderById(m);if(!w||!this.getSkeleton())continue;const l=w.with(p.ISheetSelectionRenderService);if(!l)return this;const f={...u,componentKey:s.config.componentKey||u.componentKey,allowTransform:s.config.allowTransform!==void 0?s.config.allowTransform:u.allowTransform,data:s.config.data||u.data,sheetTransform:s.config.position&&(a=g.transformToDrawingPosition(s.config.position,l))!=null?a:u.sheetTransform,transform:{...u.transform,...s.config.position}};i.push(f)}if(i.length>0){const s=this._workbook.getUnitId(),d=this._worksheet.getSheetId();if(!this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:s,subUnitId:d,drawings:i}))throw new Error("batchUpdateFloatDoms failed")}return this}removeFloatDom(r){const e=this._injector.get(g.SheetCanvasFloatDomManagerService).getFloatDomInfo(r);if(!e)return this;const{unitId:n,subUnitId:i}=e,s=this._injector.get(v.ISheetDrawingService).getDrawingByParam({unitId:n,subUnitId:i,drawingId:r});if(!s)return this;if(!this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:n,drawings:[s]}))throw new Error("removeFloatDom failed");return this}addFloatDomToPosition(r,t){const e=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),{key:i,disposableCollection:a}=R.transformComponentKey(r,this._injector.get(F.ComponentManager)),d=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToPosition({...r,componentKey:i,unitId:e,subUnitId:n},t);return d?(a.add(d.dispose),{id:d.id,dispose:()=>{a.dispose(),d.dispose()}}):(a.dispose(),null)}addFloatDomToRange(r,t,e,n){const i=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:s,disposableCollection:d}=R.transformComponentKey(t,this._injector.get(F.ComponentManager)),c=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToRange(r.getRange(),{...t,componentKey:s,unitId:i,subUnitId:a},e,n);return c?(d.add(c.dispose),{id:c.id,dispose:()=>{d.dispose(),c.dispose()}}):(d.dispose(),null)}addFloatDomToColumnHeader(r,t,e,n){const i=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:s,disposableCollection:d}=R.transformComponentKey(t,this._injector.get(F.ComponentManager)),c=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToColumnHeader(r,{...t,componentKey:s,unitId:i,subUnitId:a},e,n);return c?(d.add(c.dispose),{id:c.id,dispose:()=>{d.dispose(),c.dispose()}}):(d.dispose(),null)}async insertImage(r,t,e,n,i){const a=this.newOverGridImage();if(typeof r=="string")a.setSource(r);else{const m=await r.getBlob().getDataAsString();a.setSource(m,h.ImageSourceType.BASE64)}t!==void 0?a.setColumn(t):a.setColumn(0),e!==void 0?a.setRow(e):a.setRow(0),n!==void 0?a.setColumnOffset(n):a.setColumnOffset(0),i!==void 0?a.setRowOffset(i):a.setRowOffset(0);const s=await a.buildAsync();return this._commandService.syncExecuteCommand(g.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:[s]})}insertImages(r){const t=r.map(e=>(e.unitId=this._fWorkbook.getId(),e.subUnitId=this.getSheetId(),e));return this._commandService.syncExecuteCommand(g.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}deleteImages(r){const t=r.map(e=>({unitId:this._fWorkbook.getId(),drawingId:e.getId(),subUnitId:this.getSheetId(),drawingType:e.getType()}));return this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}getImages(){const t=this._injector.get(v.ISheetDrawingService).getDrawingData(this._fWorkbook.getId(),this.getSheetId()),e=[];for(const n in t){const i=t[n];i.drawingType===h.DrawingTypeEnum.DRAWING_IMAGE&&e.push(this._injector.createInstance(S,i))}return e}getImageById(r){const e=this._injector.get(v.ISheetDrawingService).getDrawingByParam({unitId:this._fWorkbook.getId(),subUnitId:this.getSheetId(),drawingId:r});return e&&e.drawingType===h.DrawingTypeEnum.DRAWING_IMAGE?this._injector.createInstance(S,e):null}getActiveImages(){const t=this._injector.get(v.ISheetDrawingService).getFocusDrawings(),e=[];for(const n in t){const i=t[n];e.push(this._injector.createInstance(S,i))}return e}updateImages(r){return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:r}),this}onImageInserted(r){const t=this._injector.get(v.ISheetDrawingService);return h.toDisposable(t.add$.subscribe(e=>{const n=e.map(i=>this._injector.createInstance(S,t.getDrawingByParam(i)));r(n)}))}onImageDeleted(r){const t=this._injector.get(v.ISheetDrawingService);return h.toDisposable(t.remove$.subscribe(e=>{const n=e.map(i=>this._injector.createInstance(S,t.getDrawingByParam(i)));r(n)}))}onImageChanged(r){const t=this._injector.get(v.ISheetDrawingService);return h.toDisposable(t.update$.subscribe(e=>{const n=e.map(i=>this._injector.createInstance(S,t.getDrawingByParam(i)));r(n)}))}newOverGridImage(){const r=this._fWorkbook.getId(),t=this.getSheetId();return this._injector.createInstance(k,r,t)}}y.FWorksheet.extend(P);class j extends _.FEnum{get DrawingType(){return h.DrawingTypeEnum}get ImageSourceType(){return h.ImageSourceType}get SheetDrawingAnchorType(){return v.SheetDrawingAnchorType}}_.FEnum.extend(j);class W extends _.FEventName{get BeforeFloatDomAdd(){return"BeforeFloatDomAdd"}get FloatDomAdded(){return"FloatDomAdded"}get BeforeFloatDomUpdate(){return"BeforeFloatDomUpdate"}get FloatDomUpdated(){return"FloatDomUpdated"}get BeforeFloatDomDelete(){return"BeforeFloatDomDelete"}get FloatDomDeleted(){return"FloatDomDeleted"}get BeforeOverGridImageChange(){return"BeforeOverGridImageChange"}get OverGridImageChanged(){return"OverGridImageChanged"}get BeforeOverGridImageInsert(){return"BeforeOverGridImageInsert"}get OverGridImageInserted(){return"OverGridImageInserted"}get BeforeOverGridImageRemove(){return"BeforeOverGridImageRemove"}get OverGridImageRemoved(){return"OverGridImageRemoved"}get BeforeOverGridImageSelect(){return"BeforeOverGridImageSelect"}get OverGridImageSelected(){return"OverGridImageSelected"}}_.FEventName.extend(W);class H extends _.FUniver{_initialize(r){const t=r.get(h.ICommandService);this.registerEventHandler(this.Event.BeforeFloatDomAdd,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n,s=a.filter(m=>m.drawingType===h.DrawingTypeEnum.DRAWING_DOM);if(s.length===0)return;const d={workbook:i,drawings:s};if(this.fireEvent(this.Event.BeforeFloatDomAdd,d),d.cancel)throw new h.CanceledError})),this.registerEventHandler(this.Event.FloatDomAdded,()=>t.onCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n,s=a.filter(d=>d.drawingType===h.DrawingTypeEnum.DRAWING_DOM);s.length!==0&&this.fireEvent(this.Event.FloatDomAdded,{workbook:i,drawings:s})})),this.registerEventHandler(this.Event.BeforeOverGridImageInsert,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n,s={workbook:i,insertImageParams:a};if(this.fireEvent(this.Event.BeforeOverGridImageInsert,s),s.cancel)throw new h.CanceledError})),this.registerEventHandler(this.Event.BeforeOverGridImageRemove,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const a=r.get(I.IDrawingManagerService),{drawings:s}=n,d=s.map(c=>a.getDrawingByParam(c)),m={workbook:i,images:this._createFOverGridImage(d)};if(this.fireEvent(this.Event.BeforeOverGridImageRemove,m),m.cancel)throw new h.CanceledError})),this.registerEventHandler(this.Event.BeforeOverGridImageChange,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n,s=r.get(I.IDrawingManagerService),d=[];a.forEach(c=>{const u=s.getDrawingByParam(c);u!=null&&d.push({changeParam:c,image:this._injector.createInstance(S,u)})});const m={workbook:i,images:d};if(this.fireEvent(this.Event.BeforeOverGridImageChange,m),m.cancel)throw s.updateNotification(a),new h.CanceledError})),this.registerEventHandler(this.Event.BeforeFloatDomUpdate,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n,s=r.get(I.IDrawingManagerService),d=[];if(a.forEach(c=>{const u=s.getDrawingByParam(c);(u==null?void 0:u.drawingType)===h.DrawingTypeEnum.DRAWING_DOM&&d.push(u)}),d.length===0)return;const m={workbook:i,drawings:d};if(this.fireEvent(this.Event.BeforeFloatDomUpdate,m),m.cancel)throw s.updateNotification(a),new h.CanceledError})),this.registerEventHandler(this.Event.FloatDomUpdated,()=>t.onCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n,s=r.get(I.IDrawingManagerService),d=[];a.forEach(m=>{const c=s.getDrawingByParam(m);(c==null?void 0:c.drawingType)===h.DrawingTypeEnum.DRAWING_DOM&&d.push(c)}),d.length!==0&&this.fireEvent(this.Event.FloatDomUpdated,{workbook:i,drawings:d})})),this.registerEventHandler(this.Event.BeforeFloatDomDelete,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const a=r.get(I.IDrawingManagerService),{drawings:s}=n,d=s.map(c=>a.getDrawingByParam(c)).filter(c=>(c==null?void 0:c.drawingType)===h.DrawingTypeEnum.DRAWING_DOM);if(d.length===0)return;const m={workbook:i,drawings:d};if(this.fireEvent(this.Event.BeforeFloatDomDelete,m),m.cancel)throw new h.CanceledError})),this.registerEventHandler(this.Event.FloatDomDeleted,()=>t.onCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n;this.fireEvent(this.Event.FloatDomDeleted,{workbook:i,drawings:a.filter(s=>s.drawingType===h.DrawingTypeEnum.DRAWING_DOM).map(s=>s.drawingId)})})),this.registerEventHandler(this.Event.BeforeOverGridImageSelect,()=>t.beforeCommandExecuted(e=>{if(e.id!==I.SetDrawingSelectedOperation.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null)return;const a=r.get(I.IDrawingManagerService),s=a.getFocusDrawings(),d=n.map(c=>a.getDrawingByParam(c)),m={workbook:i,selectedImages:this._createFOverGridImage(d),oldSelectedImages:this._createFOverGridImage(s)};if(this.fireEvent(this.Event.BeforeOverGridImageSelect,m),m.cancel)throw new h.CanceledError})),this.registerEventHandler(this.Event.OverGridImageInserted,()=>t.onCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n;this.fireEvent(this.Event.OverGridImageInserted,{workbook:i,images:this._createFOverGridImage(a)})})),this.registerEventHandler(this.Event.OverGridImageRemoved,()=>t.onCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n;this.fireEvent(this.Event.OverGridImageRemoved,{workbook:i,removeImageParams:a})})),this.registerEventHandler(this.Event.OverGridImageChanged,()=>t.onCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null||n==null)return;const{drawings:a}=n,s=r.get(I.IDrawingManagerService),d=a.map(m=>this._injector.createInstance(S,s.getDrawingByParam(m)));this.fireEvent(this.Event.OverGridImageChanged,{workbook:i,images:d})})),this.registerEventHandler(this.Event.OverGridImageSelected,()=>t.onCommandExecuted(e=>{if(e.id!==I.SetDrawingSelectedOperation.id)return;const n=e.params,i=this.getActiveWorkbook();if(i==null)return;const a=r.get(I.IDrawingManagerService),s=n.map(d=>a.getDrawingByParam(d));this.fireEvent(this.Event.OverGridImageSelected,{workbook:i,selectedImages:this._createFOverGridImage(s)})}))}_createFOverGridImage(r){return r.map(t=>this._injector.createInstance(S,t))}}_.FUniver.extend(H);class K extends y.FRange{async insertCellImageAsync(r){var i;const t=this._injector.get(E.IRenderManagerService),e=(i=E.getCurrentTypeOfRenderer(h.UniverInstanceType.UNIVER_SHEET,this._injector.get(h.IUniverInstanceService),t))==null?void 0:i.with(g.SheetDrawingUpdateController);if(!e)return!1;const n={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this.getRow(),col:this.getColumn()};return typeof r=="string"?e.insertCellImageByUrl(r,n):e.insertCellImageByFile(r,n)}}y.FRange.extend(K);
