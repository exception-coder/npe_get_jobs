"use strict";var R=Object.defineProperty;var S=(n,e,r)=>e in n?R(n,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[e]=r;var d=(n,e,r)=>S(n,typeof e!="symbol"?e+"":e,r);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const p=require("node:child_process"),u=require("node:process"),s=require("@univerjs/core"),i=require("@univerjs/rpc"),g=require("rxjs"),N="rpc-node.main-thread.config",h={},I="rpc-node.worker-thread.config",v={};var m=Object.getOwnPropertyDescriptor,C=(n,e,r,o)=>{for(var t=o>1?void 0:o?m(e,r):e,c=n.length-1,a;c>=0;c--)(a=n[c])&&(t=a(t)||t);return t},l=(n,e)=>(r,o)=>e(r,o,n),P;exports.UniverRPCNodeMainPlugin=(P=class extends s.Plugin{constructor(e=h,r,o){super(),this._config=e,this._injector=r,this._configService=o;const{...t}=s.merge({},h,this._config);this._configService.setConfig(N,t)}onStarting(){const{workerSrc:e}=this._config;if(!e)throw new Error("[UniverRPCNodeMainPlugin] workerSrc is required for UniverRPCNodeMainPlugin");const r=y(this._injector,e);[[i.IRPCChannelService,{useFactory:()=>new i.ChannelService(r)}],[i.DataSyncPrimaryController],[i.IRemoteSyncService,{useClass:i.RemoteSyncPrimaryService}]].forEach(t=>this._injector.add(t)),this._injector.get(i.DataSyncPrimaryController)}},d(P,"pluginName","UNIVER_RPC_NODE_MAIN_PLUGIN"),P);exports.UniverRPCNodeMainPlugin=C([l(1,s.Inject(s.Injector)),l(2,s.IConfigService)],exports.UniverRPCNodeMainPlugin);var _;exports.UniverRPCNodeWorkerPlugin=(_=class extends s.Plugin{constructor(e=v,r,o){super(),this._config=e,this._injector=r,this._configService=o;const{...t}=s.merge({},v,this._config);this._configService.setConfig(I,t)}onStarting(){[[i.DataSyncReplicaController],[i.IRPCChannelService,{useFactory:()=>new i.ChannelService(U())}],[i.IRemoteInstanceService,{useClass:i.WebWorkerRemoteInstanceService}]].forEach(e=>this._injector.add(e)),this._injector.get(i.DataSyncReplicaController)}},d(_,"pluginName","UNIVER_RPC_NODE_WORKER_PLUGIN"),_);exports.UniverRPCNodeWorkerPlugin=C([l(1,s.Inject(s.Injector)),l(2,s.IConfigService)],exports.UniverRPCNodeWorkerPlugin);function y(n,e){const r=n.get(s.ILogService),o=p.fork(e);return o.on("spawn",()=>r.log("Child computing process spawned!")),o.on("error",c=>r.error(c)),{send(c){o.send(c)},onMessage:new g.Observable(c=>{const a=f=>{c.next(f)};return o.on("message",a),()=>o.off("message",a)}).pipe(g.shareReplay(1))}}function U(){return{send(n){u.send(n)},onMessage:new g.Observable(n=>{const e=r=>{n.next(r)};return u.on("message",e),()=>u.off("message",e)}).pipe(g.shareReplay(1))}}
