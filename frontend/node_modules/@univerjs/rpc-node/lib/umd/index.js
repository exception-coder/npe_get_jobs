(function(e,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("node:child_process"),require("node:process"),require("@univerjs/core"),require("@univerjs/rpc"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","node:child_process","node:process","@univerjs/core","@univerjs/rpc","rxjs"],o):(e=typeof globalThis<"u"?globalThis:e||self,o(e.UniverRpcNode={},e.node_child_process,e.process,e.UniverCore,e.UniverRpc,e.rxjs))})(this,(function(e,o,g,c,t,l){"use strict";var j=Object.defineProperty;var y=(e,o,g)=>o in e?j(e,o,{enumerable:!0,configurable:!0,writable:!0,value:g}):e[o]=g;var _=(e,o,g)=>y(e,typeof o!="symbol"?o+"":o,g);var P,v;const S="rpc-node.main-thread.config",h={},N="rpc-node.worker-thread.config",C={};var m=Object.getOwnPropertyDescriptor,R=(s,n,i,r)=>{for(var a=r>1?void 0:r?m(n,i):n,d=s.length-1,u;d>=0;d--)(u=s[d])&&(a=u(a)||a);return a},f=(s,n)=>(i,r)=>n(i,r,s);e.UniverRPCNodeMainPlugin=(P=class extends c.Plugin{constructor(n=h,i,r){super(),this._config=n,this._injector=i,this._configService=r;const{...a}=c.merge({},h,this._config);this._configService.setConfig(S,a)}onStarting(){const{workerSrc:n}=this._config;if(!n)throw new Error("[UniverRPCNodeMainPlugin] workerSrc is required for UniverRPCNodeMainPlugin");const i=I(this._injector,n);[[t.IRPCChannelService,{useFactory:()=>new t.ChannelService(i)}],[t.DataSyncPrimaryController],[t.IRemoteSyncService,{useClass:t.RemoteSyncPrimaryService}]].forEach(a=>this._injector.add(a)),this._injector.get(t.DataSyncPrimaryController)}},_(P,"pluginName","UNIVER_RPC_NODE_MAIN_PLUGIN"),P),e.UniverRPCNodeMainPlugin=R([f(1,c.Inject(c.Injector)),f(2,c.IConfigService)],e.UniverRPCNodeMainPlugin),e.UniverRPCNodeWorkerPlugin=(v=class extends c.Plugin{constructor(n=C,i,r){super(),this._config=n,this._injector=i,this._configService=r;const{...a}=c.merge({},C,this._config);this._configService.setConfig(N,a)}onStarting(){[[t.DataSyncReplicaController],[t.IRPCChannelService,{useFactory:()=>new t.ChannelService(p())}],[t.IRemoteInstanceService,{useClass:t.WebWorkerRemoteInstanceService}]].forEach(n=>this._injector.add(n)),this._injector.get(t.DataSyncReplicaController)}},_(v,"pluginName","UNIVER_RPC_NODE_WORKER_PLUGIN"),v),e.UniverRPCNodeWorkerPlugin=R([f(1,c.Inject(c.Injector)),f(2,c.IConfigService)],e.UniverRPCNodeWorkerPlugin);function I(s,n){const i=s.get(c.ILogService),r=o.fork(n);return r.on("spawn",()=>i.log("Child computing process spawned!")),r.on("error",d=>i.error(d)),{send(d){r.send(d)},onMessage:new l.Observable(d=>{const u=U=>{d.next(U)};return r.on("message",u),()=>r.off("message",u)}).pipe(l.shareReplay(1))}}function p(){return{send(s){g.send(s)},onMessage:new l.Observable(s=>{const n=i=>{s.next(i)};return g.on("message",n),()=>g.off("message",n)}).pipe(l.shareReplay(1))}}Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}));
