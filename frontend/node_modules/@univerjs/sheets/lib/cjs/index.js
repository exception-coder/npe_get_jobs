"use strict";var Wi=Object.defineProperty;var Vi=(o,t,e)=>t in o?Wi(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var S=(o,t,e)=>Vi(o,typeof t!="symbol"?t+"":t,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("@univerjs/core"),O=require("rxjs"),Nt=require("rxjs/operators"),Y=require("@univerjs/engine-formula"),$i=require("@univerjs/rpc");function Li(o,t,e){var r,a,c;if(t.t)return t.t;if(t.v===null)return null;const n=o.getStyleByCell(t),s=o.getStyleByCell(e);if(e.t===i.CellValueType.FORCE_STRING){if(!i.isTextFormat((r=s==null?void 0:s.n)==null?void 0:r.pattern)&&t.v!==void 0){if(i.isRealNum(t.v))return i.CellValueType.NUMBER;if(i.isBooleanString(`${t.v}`))return i.CellValueType.BOOLEAN}return i.CellValueType.FORCE_STRING}return Bi(n)?i.isTextFormat((a=n==null?void 0:n.n)==null?void 0:a.pattern)?i.CellValueType.STRING:es(t,e):i.isTextFormat((c=s==null?void 0:s.n)==null?void 0:c.pattern)?i.CellValueType.STRING:es(t,e)}function es(o,t){return o.v!==void 0?Fn(o.v,o.t):Fn(t.v,t.t)}function Bi(o){var t;return!!((t=o==null?void 0:o.n)!=null&&t.pattern)}function Fn(o,t){return o===null?null:typeof o=="string"?i.isRealNum(o)?(+o==0||+o==1)&&t===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:t!==i.CellValueType.STRING&&t!==i.CellValueType.FORCE_STRING&&i.willLoseNumericPrecision(o)?i.CellValueType.FORCE_STRING:i.CellValueType.NUMBER:i.isBooleanString(o)?i.CellValueType.BOOLEAN:i.CellValueType.STRING:typeof o=="number"?(o===0||o===1)&&t===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:i.CellValueType.NUMBER:typeof o=="boolean"?i.CellValueType.BOOLEAN:i.CellValueType.FORCE_STRING}const he=(o,t)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:i.Tools.deepClone(t.ranges)}},F={id:"sheet.mutation.add-worksheet-merge",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(!s)return!1;const a=s.getConfig().mergeData,c=t.ranges;for(let l=0;l<c.length;l++)a.push(c[l]);return s.getSpanModel().rebuild(a),!0}},Fi=i.createInterceptorKey("CELL_CONTENT"),Hi=i.createInterceptorKey("ROW_FILTERED"),De={CELL_CONTENT:Fi,ROW_FILTERED:Hi};var ps=(o=>(o[o.DATA_VALIDATION=9]="DATA_VALIDATION",o[o.NUMFMT=10]="NUMFMT",o[o.CELL_IMAGE=11]="CELL_IMAGE",o))(ps||{});const Is="sheet.interceptor.range-theme-id",ts="sheet.interceptor.ignore-range-theme";var ji=Object.getOwnPropertyDescriptor,Gi=(o,t,e,n)=>{for(var s=n>1?void 0:n?ji(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},zi=(o,t)=>(e,n)=>t(e,n,o);const Hn=i.createInterceptorKey("BEFORE_CELL_EDIT"),tn=i.createInterceptorKey("AFTER_CELL_EDIT"),nn=i.createInterceptorKey("VALIDATE_CELL");exports.SheetInterceptorService=class extends i.Disposable{constructor(e){super();S(this,"_interceptorsByName",new Map);S(this,"_commandInterceptors",[]);S(this,"_rangeInterceptors",[]);S(this,"_autoHeightInterceptors",[]);S(this,"_beforeCommandInterceptor",[]);S(this,"_afterCommandInterceptors",[]);S(this,"_workbookDisposables",new Map);S(this,"_worksheetDisposables",new Map);S(this,"_interceptorsDirty",!1);S(this,"_composedInterceptorByKey",new Map);S(this,"writeCellInterceptor",new i.InterceptorManager({BEFORE_CELL_EDIT:Hn,AFTER_CELL_EDIT:tn,VALIDATE_CELL:nn}));this._univerInstanceService=e,this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._interceptWorkbook(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>this._disposeWorkbookInterceptor(n))),this.intercept(De.CELL_CONTENT,{priority:-1,effect:i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value,handler:n=>n}),this.disposeWithMe(this.writeCellInterceptor.intercept(tn,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept(Hn,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept(nn,{priority:-1,handler:n=>n}))}dispose(){super.dispose(),this._workbookDisposables.forEach(e=>e.dispose()),this._workbookDisposables.clear(),this._worksheetDisposables.forEach(e=>e.dispose()),this._worksheetDisposables.clear(),this._interceptorsByName.clear()}interceptCommand(e){if(this._commandInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._commandInterceptors.push(e),this._commandInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._commandInterceptors,e)))}onCommandExecute(e){const n=this._commandInterceptors.map(s=>s.getMutations(e));return{preUndos:n.map(s=>{var r;return(r=s.preUndos)!=null?r:[]}).flat(),undos:n.map(s=>s.undos).flat(),preRedos:n.map(s=>{var r;return(r=s.preRedos)!=null?r:[]}).flat(),redos:n.map(s=>s.redos).flat()}}interceptAfterCommand(e){if(this._afterCommandInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._afterCommandInterceptors.push(e),this._afterCommandInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._afterCommandInterceptors,e)))}afterCommandExecute(e){const n=this._afterCommandInterceptors.map(s=>s.getMutations(e));return{undos:n.map(s=>s.undos).flat(),redos:n.map(s=>s.redos).flat()}}interceptAutoHeight(e){if(this._autoHeightInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._autoHeightInterceptors.push(e),this._autoHeightInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._autoHeightInterceptors,e)))}generateMutationsOfAutoHeight(e){const n=this._autoHeightInterceptors.map(s=>s.getMutations(e));return{preUndos:n.map(s=>{var r;return(r=s.preUndos)!=null?r:[]}).flat(),undos:n.map(s=>s.undos).flat(),preRedos:n.map(s=>{var r;return(r=s.preRedos)!=null?r:[]}).flat(),redos:n.map(s=>s.redos).flat()}}interceptBeforeCommand(e){if(this._beforeCommandInterceptor.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._beforeCommandInterceptor.push(e),this._beforeCommandInterceptor.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._beforeCommandInterceptor,e)))}async beforeCommandExecute(e){return(await Promise.all(this._beforeCommandInterceptor.map(s=>s.performCheck(e)))).every(s=>s)}interceptRanges(e){if(this._rangeInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._rangeInterceptors.push(e),this._rangeInterceptors.sort((n,s)=>{var r,a;return((r=s.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._rangeInterceptors,e)))}generateMutationsByRanges(e){const n=this._rangeInterceptors.map(s=>s.getMutations(e));return{preUndos:n.map(s=>{var r;return(r=s.preUndos)!=null?r:[]}).flat(),undos:n.map(s=>s.undos).flat(),preRedos:n.map(s=>{var r;return(r=s.preRedos)!=null?r:[]}).flat(),redos:n.map(s=>s.redos).flat()}}onWriteCell(e,n,s,r,a){const c={subUnitId:n.getSheetId(),unitId:e.getUnitId(),workbook:e,worksheet:n,row:s,col:r,origin:i.Tools.deepClone(a)};return this.writeCellInterceptor.fetchThroughInterceptors(tn)(a,c)}onValidateCell(e,n,s,r){const a={subUnitId:n.getSheetId(),unitId:e.getUnitId(),workbook:e,worksheet:n,row:s,col:r};return this.writeCellInterceptor.fetchThroughInterceptors(nn)(Promise.resolve(!0),a)}intercept(e,n){const s=e;this._interceptorsByName.has(s)||this._interceptorsByName.set(s,[]);const r=this._interceptorsByName.get(s);r.push(n);const a=r.sort((c,l)=>{var u,d;return((u=l.priority)!=null?u:0)-((d=c.priority)!=null?d:0)});if(this._interceptorsDirty=!0,s===De.CELL_CONTENT){const c=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;this._interceptorsByName.set(`${s}-${c}`,a);const l=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;return this._interceptorsByName.set(`${s}-${i.InterceptorEffectEnum.Style}`,a.filter(u=>((u.effect||l)&i.InterceptorEffectEnum.Style)>0)),this._interceptorsByName.set(`${s}-${i.InterceptorEffectEnum.Value}`,a.filter(u=>((u.effect||l)&i.InterceptorEffectEnum.Value)>0)),this.disposeWithMe(i.toDisposable(()=>{i.remove(this._interceptorsByName.get(s),n),i.remove(this._interceptorsByName.get(`${s}-${c}`),n),i.remove(this._interceptorsByName.get(`${s}-${i.InterceptorEffectEnum.Style}`),n),i.remove(this._interceptorsByName.get(`${s}-${i.InterceptorEffectEnum.Value}`),n)}))}else return this._interceptorsByName.set(s,a),this.disposeWithMe(i.toDisposable(()=>i.remove(this._interceptorsByName.get(s),n)))}fetchThroughInterceptors(e,n,s,r){const a=n===void 0?e:`${e}-${n}`,c=s!=null?s:a;let l=this._composedInterceptorByKey.get(c);if(!l||this._interceptorsDirty){let u=this._interceptorsByName.get(a);u&&r&&(u=u.filter(r)),l=i.composeInterceptors(u||[]),this._composedInterceptorByKey.set(c,l)}return l}_interceptWorkbook(e){const n=new i.DisposableCollection,s=e.getUnitId(),r=this,a=c=>{const l=c.getSheetId();c.__interceptViewModel(u=>{const d=new i.DisposableCollection;r._worksheetDisposables.set(ns(s,c),d),d.add(u.registerCellContentInterceptor({getCell(m,h,g,R,C){const f=c.getCellRaw(m,h);return r.fetchThroughInterceptors(De.CELL_CONTENT,g,R,C)(f,{unitId:s,subUnitId:l,row:m,col:h,worksheet:c,workbook:e,rawData:f})}})),d.add(u.registerRowFilteredInterceptor({getRowFiltered(m){return!!r.fetchThroughInterceptors(De.ROW_FILTERED)(!1,{unitId:s,subUnitId:l,row:m,workbook:e,worksheet:c})}}))})};e.getSheets().forEach(c=>a(c)),n.add(e.sheetCreated$.subscribe(c=>a(c))),n.add(i.toDisposable(()=>e.getSheets().forEach(c=>this._disposeSheetInterceptor(s,c)))),n.add(e.sheetDisposed$.subscribe(c=>this._disposeSheetInterceptor(s,c))),this._workbookDisposables.set(s,n)}_disposeWorkbookInterceptor(e){const n=e.getUnitId(),s=this._workbookDisposables.get(n);s&&(s.dispose(),this._workbookDisposables.delete(n))}_disposeSheetInterceptor(e,n){const s=ns(e,n),r=this._worksheetDisposables.get(s);r&&(r.dispose(),this._worksheetDisposables.delete(s))}};exports.SheetInterceptorService=Gi([zi(0,i.IUniverInstanceService)],exports.SheetInterceptorService);function ns(o,t){return`${o}|${t.getSheetId()}`}const X=o=>{const t={};return o.bg&&(t.bg={...o.bg}),o.ol&&(t.ol={...o.ol}),o.bd&&(t.bd={...o.bd}),o.cl&&(t.cl={...o.cl}),o.ht&&(t.ht=o.ht),o.vt&&(t.vt=o.vt),o.bl!==void 0&&(t.bl=o.bl),t};function qi(o){const t={};if(o.length===1)return o[0];for(const e of o)e.bg&&(t.bg=e.bg),e.ol&&(t.ol=e.ol),e.bd&&(t.bd={...t.bd,...e.bd}),e.cl&&(t.cl=e.cl),e.ht&&(t.ht=e.ht),e.vt&&(t.vt=e.vt),e.bl!==void 0&&(t.bl=e.bl);return t}const K={wholeStyle:1,headerRowStyle:2,headerColumnStyle:4,firstRowStyle:8,secondRowStyle:16,lastRowStyle:32,firstColumnStyle:128,secondColumnStyle:256,lastColumnStyle:512};class We{constructor(t,e){S(this,"_name");S(this,"wholeStyle",null);S(this,"headerRowStyle",null);S(this,"headerColumnStyle",null);S(this,"firstRowStyle",null);S(this,"secondRowStyle",null);S(this,"lastRowStyle",null);S(this,"firstColumnStyle",null);S(this,"secondColumnStyle",null);S(this,"lastColumnStyle",null);S(this,"_mergeCacheMap",new Map);e&&this.fromJson({...e,name:t}),this._name=t}getName(){return this._name}getWholeStyle(){return this.wholeStyle}setWholeStyle(t){this.wholeStyle=t,this._resetStyleCache()}getFirstRowStyle(){return this.firstRowStyle}setFirstRowStyle(t){this.firstRowStyle=t,this._resetStyleCache()}getSecondRowStyle(){return this.secondRowStyle}setSecondRowStyle(t){this.secondRowStyle=t,this._resetStyleCache()}getLastRowStyle(){return this.lastRowStyle}setLastRowStyle(t){this.lastRowStyle=t,this._resetStyleCache()}getFirstColumnStyle(){return this.firstColumnStyle}setFirstColumnStyle(t){this.firstColumnStyle=t,this._resetStyleCache()}getSecondColumnStyle(){return this.secondColumnStyle}setSecondColumnStyle(t){this.secondColumnStyle=t,this._resetStyleCache()}getLastColumnStyle(){return this.lastColumnStyle}setLastColumnStyle(t){this.lastColumnStyle=t,this._resetStyleCache()}getHeaderRowStyle(){return this.headerRowStyle}setHeaderRowStyle(t){this.headerRowStyle=t,this._resetStyleCache()}getHeaderColumnStyle(){return this.headerColumnStyle}setHeaderColumnStyle(t){this.headerColumnStyle=t,this._resetStyleCache()}getStyle(t,e,n,s,r){let a=0;return n&&(a=a|K.lastRowStyle),s&&(a=a|K.lastColumnStyle),t>=0&&e>=0&&(a=a|K.wholeStyle),t%2===1&&(a=a|(r?K.secondRowStyle:K.firstRowStyle)),t%2===0&&(a=a|(r?K.firstRowStyle:K.secondRowStyle)),t===0&&(a=a|K.headerRowStyle),e===0&&(a=a|K.headerColumnStyle),e%2===1&&(a=a|K.firstColumnStyle),e%2===0&&(a=a|K.secondColumnStyle),a===0?null:this._getMergeStyle(a)}_getMergeStyle(t){let e=this._mergeCacheMap.get(t);return e||(e=this._mergeStyle(t),this._mergeCacheMap.set(t,e)),e}_mergeStyle(t){const e=[];return this.wholeStyle&&t&K.wholeStyle&&e.push(this.wholeStyle),this.firstColumnStyle&&t&K.firstColumnStyle&&e.push(this.firstColumnStyle),this.secondColumnStyle&&t&K.secondColumnStyle&&e.push(this.secondColumnStyle),this.firstRowStyle&&t&K.firstRowStyle&&e.push(this.firstRowStyle),this.secondRowStyle&&t&K.secondRowStyle&&e.push(this.secondRowStyle),this.headerColumnStyle&&t&K.headerColumnStyle&&e.push(this.headerColumnStyle),this.lastColumnStyle&&t&K.lastColumnStyle&&e.push(this.lastColumnStyle),this.headerRowStyle&&t&K.headerRowStyle&&e.push(this.headerRowStyle),this.lastRowStyle&&t&K.lastRowStyle&&e.push(this.lastRowStyle),qi(e)}_resetStyleCache(){this._mergeCacheMap.clear()}toJson(){const t={name:this._name};return this.wholeStyle&&(t.wholeStyle=X(this.wholeStyle)),this.headerRowStyle&&(t.headerRowStyle=X(this.headerRowStyle)),this.headerColumnStyle&&(t.headerColumnStyle=X(this.headerColumnStyle)),this.firstRowStyle&&(t.firstRowStyle=X(this.firstRowStyle)),this.secondRowStyle&&(t.secondRowStyle=X(this.secondRowStyle)),this.lastRowStyle&&(t.lastRowStyle=X(this.lastRowStyle)),this.firstColumnStyle&&(t.firstColumnStyle=X(this.firstColumnStyle)),this.secondColumnStyle&&(t.secondColumnStyle=X(this.secondColumnStyle)),this.lastColumnStyle&&(t.lastColumnStyle=X(this.lastColumnStyle)),t}fromJson(t){this._name=t.name,t.wholeStyle&&(this.wholeStyle=X(t.wholeStyle)),t.headerRowStyle&&(this.headerRowStyle=X(t.headerRowStyle)),t.headerColumnStyle&&(this.headerColumnStyle=X(t.headerColumnStyle)),t.firstRowStyle&&(this.firstRowStyle=X(t.firstRowStyle)),t.secondRowStyle&&(this.secondRowStyle=X(t.secondRowStyle)),t.lastRowStyle&&(this.lastRowStyle=X(t.lastRowStyle)),t.firstColumnStyle&&(this.firstColumnStyle=X(t.firstColumnStyle)),t.secondColumnStyle&&(this.secondColumnStyle=X(t.secondColumnStyle)),t.lastColumnStyle&&(this.lastColumnStyle=X(t.lastColumnStyle))}dispose(){this._mergeCacheMap.clear()}}const Yi=(o,t,e)=>new We(`light-${o}`,{headerRowStyle:{bg:{rgb:t}},firstColumnStyle:{bg:{rgb:"rgb(255, 255, 255)"}},secondColumnStyle:{bg:{rgb:e}},lastRowStyle:{bg:{rgb:t}}}),Ki=(o,t,e)=>new We(`middle-${o}`,{headerRowStyle:{bg:{rgb:t}},headerColumnStyle:{bg:{rgb:e}},secondRowStyle:{bg:{rgb:e}},lastRowStyle:{bg:{rgb:t}},lastColumnStyle:{bg:{rgb:e}}}),Ji=(o,t,e,n)=>new We(`dark-${o}`,{headerRowStyle:{bg:{rgb:t},cl:{rgb:"rgb(255, 255, 255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:e}},secondRowStyle:{bg:{rgb:n}},lastRowStyle:{bg:{rgb:t}}}),Xi=[{baseName:"blue",header:"rgb(164, 202, 254)",color:"rgb(225, 239, 254)"},{baseName:"grey",header:"rgb(205, 208, 216)",color:"rgb(238, 239, 241)"},{baseName:"red",header:"rgb(248, 180, 180)",color:"rgb(253, 232, 232)"},{baseName:"orange",header:"rgb(253, 186, 140)",color:"rgb(254, 236, 220)"},{baseName:"yellow",header:"rgb(250, 200, 21)",color:"rgb(255, 244, 185)"},{baseName:"green",header:"rgb(132, 225, 188)",color:"rgb(222, 247, 236)"},{baseName:"azure",header:"rgb(126, 220, 226)",color:"rgb(213, 245, 246)"},{baseName:"indigo",header:"rgb(186, 198, 248)",color:"rgb(233, 237, 255)"},{baseName:"purple",header:"rgb(202, 191, 253)",color:"rgb(237, 235, 254)"},{baseName:"magenta",header:"rgb(248, 180, 217)",color:"rgb(252, 232, 243)"}],Zi=[{baseName:"blue",rowHeader:"rgb(63, 131, 248)",colHeader:"rgb(195, 221, 253)"},{baseName:"grey",rowHeader:"rgb(95, 101, 116)",colHeader:"rgb(227, 229, 234)"},{baseName:"red",rowHeader:"rgb(240, 82, 82)",colHeader:"rgb(251, 213, 213)"},{baseName:"orange",rowHeader:"rgb(255, 90, 31)",colHeader:"rgb(252, 217, 189)"},{baseName:"yellow",rowHeader:"rgb(212, 157, 15)",colHeader:"rgb(252, 220, 106)"},{baseName:"green",rowHeader:"rgb(13, 164, 113)",colHeader:"rgb(188, 240, 218)"},{baseName:"azure",rowHeader:"rgb(6, 148, 162)",colHeader:"rgb(175, 236, 239)"},{baseName:"indigo",rowHeader:"rgb(70, 106, 247)",colHeader:"rgb(210, 218, 250)"},{baseName:"purple",rowHeader:"rgb(144, 97, 249)",colHeader:"rgb(220, 215, 254)"},{baseName:"magenta",rowHeader:"rgb(231, 70, 148)",colHeader:"rgb(250, 209, 232)"}],Qi=[{baseName:"blue",rowHeader:"rgb(30, 66, 159)",firstRow:"rgb(195, 221, 253)",secondRow:"rgb(118, 169, 250)"},{baseName:"grey",rowHeader:"rgb(44, 48, 64)",firstRow:"rgb(227, 229, 234)",secondRow:"rgb(151, 157, 172)"},{baseName:"red",rowHeader:"rgb(155, 28, 28)",firstRow:"rgb(251, 213, 213)",secondRow:"rgb(249, 128, 128)"},{baseName:"orange",rowHeader:"rgb(180, 52, 3)",firstRow:"rgb(252, 217, 189)",secondRow:"rgb(255, 138, 76)"},{baseName:"yellow",rowHeader:"rgb(154, 109, 21)",firstRow:"rgb(252, 220, 106)",secondRow:"rgb(212, 157, 15)"},{baseName:"green",rowHeader:"rgb(4, 108, 78)",firstRow:"rgb(188, 240, 218)",secondRow:"rgb(49, 196, 141)"},{baseName:"azure",rowHeader:"rgb(3, 102, 114)",firstRow:"rgb(175, 236, 239)",secondRow:"rgb(22, 189, 202)"},{baseName:"indigo",rowHeader:"rgb(16, 51, 191)",firstRow:"rgb(210, 218, 250)",secondRow:"rgb(98, 128, 249)"},{baseName:"purple",rowHeader:"rgb(74, 29, 150)",firstRow:"rgb(220, 215, 254)",secondRow:"rgb(172, 148, 250)"},{baseName:"magenta",rowHeader:"rgb(153, 21, 75)",firstRow:"rgb(250, 209, 232)",secondRow:"rgb(241, 126, 184)"}],ea=Xi.map(({baseName:o,header:t,color:e})=>Yi(o,t,e)),ta=Zi.map(({baseName:o,rowHeader:t,colHeader:e})=>Ki(o,t,e)),na=Qi.map(({baseName:o,rowHeader:t,firstRow:e,secondRow:n})=>Ji(o,t,e,n)),oa=[...ea,...ta,...na],vs={headerRowStyle:{bg:{rgb:"rgb(68,114,196)"},cl:{rgb:"rgb(255,255,255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:"rgb(217,225,242)"}}},sa=new We("default",vs),ra=new We("default-last-row",{...vs,lastRowStyle:{bd:{t:{s:i.BorderStyleTypes.THIN,cl:{rgb:"rgb(68,114,196)"}}},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE}});class ia{constructor(){S(this,"_toggleRanges",[])}refresh(t,e){const{startRow:n,endRow:s}=t,r=[];let a=0,c=!1,l=-1;for(let u=n;u<=s;u++){if(!e(u)){a++,a%2===1?c=!0:(c=!1,l!==-1&&(r.push([l,u-1]),l=-1));continue}a%2===1?c?l===-1&&(l=u):(c=!0,l=u):c&&(r.push([l,u-2]),c=!1,l=-1),u===s&&c&&r.push([l,u])}this._toggleRanges=r}getToggleRanges(){return this._toggleRanges.concat()}getIsToggled(t){let e=0,n=this._toggleRanges.length-1;for(;e<=n;){const s=Math.floor((e+n)/2),[r,a]=this._toggleRanges[s];if(t<r)n=s-1;else if(t>a)e=s+1;else return!0}return!1}}var aa=Object.getOwnPropertyDescriptor,ca=(o,t,e,n)=>{for(var s=n>1?void 0:n?aa(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},xn=(o,t)=>(e,n)=>t(e,n,o);const la="SHEET_RANGE_THEME_MODEL_PLUGIN";exports.SheetRangeThemeModel=class extends i.Disposable{constructor(e,n,s){super();S(this,"_rangeThemeStyleMap",new Map);S(this,"_rangeThemeStyleRuleMap",new Map);S(this,"_rTreeCollection",new Map);S(this,"_defaultRangeThemeMap",new Map);S(this,"_zebraCrossingCacheMap",new Map);S(this,"_rowVisibleFuncSet",new Map);S(this,"_rangeThemeMapChanged$",new O.Subject);S(this,"rangeThemeMapChange$",this._rangeThemeMapChanged$.asObservable());this._sheetInterceptorService=e,this._resourceManagerService=n,this._univerInstanceService=s,this._registerIntercept(),this._initSnapshot(),this._initDefaultTheme()}_initDefaultTheme(){this.registerDefaultRangeTheme(sa),this.registerDefaultRangeTheme(ra);for(const e of oa)this.registerDefaultRangeTheme(e)}_ensureRangeThemeStyleMap(e){return this._rangeThemeStyleMap.has(e)||this._rangeThemeStyleMap.set(e,new Map),this._rangeThemeStyleMap.get(e)}_ensureRangeThemeStyleRuleMap(e){return this._rangeThemeStyleRuleMap.has(e)||this._rangeThemeStyleRuleMap.set(e,new Map),this._rangeThemeStyleRuleMap.get(e)}_ensureRTreeCollection(e){return this._rTreeCollection.has(e)||this._rTreeCollection.set(e,new i.RTree),this._rTreeCollection.get(e)}getDefaultRangeThemeStyle(e){return this._defaultRangeThemeMap.get(e)}getCustomRangeThemeStyle(e,n){return this._ensureRangeThemeStyleMap(e).get(n)}_getSheetRowVisibleFuncSet(e,n){this._rowVisibleFuncSet.has(e)||this._rowVisibleFuncSet.set(e,new Map);const s=this._rowVisibleFuncSet.get(e);return s.has(n)||s.set(n,new Set),s.get(n)}_getSheetRowVisibleHasInit(e,n){var s;return!!(this._rowVisibleFuncSet.has(e)&&((s=this._rowVisibleFuncSet.get(e))!=null&&s.has(n)))}refreshSheetRowVisibleFuncSet(e,n){const s=this._getSheetRowVisibleFuncSet(e,n);s.clear();const r=this._univerInstanceService.getUnit(e);if(r){const a=r.getSheetBySheetId(n);if(a){const c=a.getRowCount(),l=a.getRowManager();for(let u=1;u<=c;u++)a.getRowVisible(u)?l.getRowHeight(u)===0&&s.add(u):s.add(u)}}}_ensureZebraCrossingCache(e,n,s){this._zebraCrossingCacheMap.has(e)||this._zebraCrossingCacheMap.set(e,new Map);const r=this._zebraCrossingCacheMap.get(e);r.has(n)||r.set(n,new Map);const a=r.get(n);return a.has(s)||a.set(s,new ia),a.get(s)}registerRangeThemeRule(e,n){const{unitId:s,subUnitId:r,range:a}=n,c=i.generateRandomId(),l=this._ensureRangeThemeStyleRuleMap(s),u=this._ensureRTreeCollection(s);l.set(c,{rangeInfo:n,themeName:e}),u.insert({unitId:s,sheetId:r,range:a,id:c}),this._getSheetRowVisibleHasInit(s,r)||this.refreshSheetRowVisibleFuncSet(s,r);const d=this._ensureZebraCrossingCache(s,r,c),m=this._getSheetRowVisibleFuncSet(s,r);d.refresh(a,h=>!m.has(h))}getRegisteredRangeThemeStyle(e){const{unitId:n,subUnitId:s,range:r}=e,a=this._ensureRTreeCollection(n),c=Array.from(a.bulkSearch([{unitId:n,sheetId:s,range:r}]));if(c[0]){const u=this._ensureRangeThemeStyleRuleMap(n).get(c[0]);if(u)return u.themeName}}refreshZebraCrossingCacheBySheet(e,n){this._zebraCrossingCacheMap.has(e)||this._zebraCrossingCacheMap.set(e,new Map);const s=this._zebraCrossingCacheMap.get(e);s.has(n)||s.set(n,new Map);const r=s.get(n);r&&r.forEach((a,c)=>{const u=this._ensureRangeThemeStyleRuleMap(e).get(c);u?a.refresh(u.rangeInfo.range,d=>!this._getSheetRowVisibleFuncSet(e,n).has(d)):r.delete(c)})}removeRangeThemeRule(e,n){const{unitId:s,subUnitId:r,range:a}=n,c=this._ensureRTreeCollection(s),l=Array.from(c.bulkSearch([{unitId:s,sheetId:r,range:a}])),u=this._ensureRangeThemeStyleRuleMap(s);for(let d=0;d<l.length;d++){const m=u.get(l[d]);if(m&&m.themeName===e){u.delete(l[d]),c.remove({unitId:s,sheetId:r,range:a,id:l[d]});const h=this._zebraCrossingCacheMap.get(s);if(h){const g=h.get(r);g&&g.delete(l[d])}break}}}registerDefaultRangeTheme(e){this._defaultRangeThemeMap.set(e.getName(),e),this._rangeThemeMapChanged$.next({type:"add",styleName:e.getName()})}unRegisterDefaultRangeTheme(e){this._defaultRangeThemeMap.delete(e),this._rangeThemeMapChanged$.next({type:"remove",styleName:e})}getRegisteredRangeThemes(){return Array.from(this._defaultRangeThemeMap.keys())}registerRangeThemeStyle(e,n){this._ensureRangeThemeStyleMap(e).set(n.getName(),n),this._rangeThemeMapChanged$.next({type:"add",styleName:n.getName()})}unregisterRangeThemeStyle(e,n){this._ensureRangeThemeStyleMap(e).delete(n),this._rangeThemeMapChanged$.next({type:"remove",styleName:n})}getALLRegisteredTheme(e){return Array.from(this._ensureRangeThemeStyleMap(e).keys())}getRangeThemeStyle(e,n){return this._defaultRangeThemeMap.has(n)?this._defaultRangeThemeMap.get(n):this._ensureRangeThemeStyleMap(e).get(n)}getCellStyle(e,n,s,r){const a={startRow:s,startColumn:r,endRow:s,endColumn:r},c=this._ensureRTreeCollection(e),l=Array.from(c.bulkSearch([{unitId:e,sheetId:n,range:a}]));if(l[0]){const d=this._ensureRangeThemeStyleRuleMap(e).get(l[0]);if(d){const{rangeInfo:m,themeName:h}=d,g=s-m.range.startRow,R=r-m.range.startColumn,C=this.getRangeThemeStyle(e,h),p=this._ensureZebraCrossingCache(e,n,l[0]).getIsToggled(s);if(C)return C.getStyle(g,R,s===m.range.endRow,r===m.range.endColumn,p)}}}_registerIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{id:Is,effect:i.InterceptorEffectEnum.Style,handler:(e,n,s)=>{const{row:r,col:a,unitId:c,subUnitId:l}=n,u=this.getCellStyle(c,l,r,a);if(u){const d=!e||e===n.rawData?{...n.rawData}:e;return d.themeStyle=u,s(d)}return s(e)}}))}toJson(e){const n=this._ensureRangeThemeStyleRuleMap(e),s=this._ensureRangeThemeStyleMap(e);if(s.size===0&&n.size===0)return"{}";const r={};n.forEach((c,l)=>{r[l]=c});const a={};return s.forEach((c,l)=>{a[l]=c.toJson()}),JSON.stringify({rangeThemeStyleRuleMap:r,rangeThemeStyleMapJson:a})}fromJSON(e,n){const{rangeThemeStyleRuleMap:s,rangeThemeStyleMapJson:r}=n;s&&Object.keys(s).forEach(a=>{const c=s[a],{themeName:l,rangeInfo:u}=c;l.startsWith("table")||(this.registerRangeThemeRule(l,u),this._ensureRTreeCollection(u.unitId).insert({unitId:a,sheetId:u.subUnitId,range:u.range,id:a}))}),r&&Object.keys(r).forEach(a=>{const c=r[a],l=new We(c.name);l.fromJson(c),this._ensureRangeThemeStyleMap(e).set(l.getName(),l)})}deleteUnitId(e){this._rangeThemeStyleMap.delete(e),this._rangeThemeStyleRuleMap.delete(e),this._rTreeCollection.delete(e)}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e=>this.toJson(e),parseJson:e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},businesses:[i.UniverInstanceType.UNIVER_SHEET],pluginName:la,onLoad:(e,n)=>{this.fromJSON(e,n)},onUnLoad:e=>{this.deleteUnitId(e)}}))}dispose(){super.dispose(),this._rangeThemeStyleMap.clear(),this._rangeThemeStyleRuleMap.clear(),this._defaultRangeThemeMap.clear(),this._rTreeCollection.clear(),this._zebraCrossingCacheMap.clear(),this._rowVisibleFuncSet.clear()}};exports.SheetRangeThemeModel=ca([xn(0,i.Inject(exports.SheetInterceptorService)),xn(1,i.Inject(i.IResourceManagerService)),xn(2,i.Inject(i.IUniverInstanceService))],exports.SheetRangeThemeModel);function qn(o,t){const{unitId:e}=t,n=e?o.getUnit(e,i.UniverInstanceType.UNIVER_SHEET):o.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);return n?{workbook:n,unitId:n.getUnitId()}:null}function P(o,t={}){const{unitId:e,subUnitId:n}=t,s=e?o.getUnit(e,i.UniverInstanceType.UNIVER_SHEET):o.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);if(!s)return null;const r=n?s.getSheetBySheetId(n):s.getActiveSheet(!0);return r?{worksheet:r,workbook:s,unitId:s.getUnitId(),subUnitId:r.getSheetId()}:null}function _e(o,t){const{unitId:e,subUnitId:n}=t,s=o.getUnit(e,i.UniverInstanceType.UNIVER_SHEET);if(!s)return null;const r=s.getSheetBySheetId(n);return r?{worksheet:r,workbook:s}:null}const gt={id:"sheet.mutation.set-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,range:s,themeName:r}=t,a=o.get(i.IUniverInstanceService),c=P(a),l=o.get(exports.SheetRangeThemeModel);return c?(l.registerRangeThemeRule(r,{range:s,unitId:e,subUnitId:n}),!0):!1}},ws=(o,t)=>{const e=_e(o.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetRangeThemeStyleMutation]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,subUnitId:n.getSheetId(),range:t.range,themeName:t.themeName}},Rt={id:"sheet.mutation.remove-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,range:s,themeName:r}=t,a=o.get(i.IUniverInstanceService),c=P(a),l=o.get(exports.SheetRangeThemeModel);return c?(l.removeRangeThemeRule(r,{range:s,unitId:e,subUnitId:n}),!0):!1}},Ms=(o,t)=>{const e=_e(o.get(i.IUniverInstanceService),t);if(!e)throw new Error("[DeleteWorksheetRangeThemeStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,subUnitId:n.getSheetId(),range:t.range,themeName:t.themeName}},pn=(o,t)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},ae={id:"sheet.mutation.insert-row",type:i.CommandType.MUTATION,handler:(o,t)=>{var R;const{unitId:e,subUnitId:n,range:s,rowInfo:r}=t,c=o.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(c==null)throw new Error("universheet is null error!");const l=c.getSheetBySheetId(n);if(l==null)throw new Error("worksheet is null error!");const u=l.getRowManager().getRowData(),d={h:l.getConfig().defaultRowHeight,hd:0},m=s.startRow,h=s.endRow-s.startRow+1;for(let C=m;C<m+h;C++)r?i.insertMatrixArray(C,(R=r[C-s.startRow])!=null?R:d,u):i.insertMatrixArray(C,d,u);return l.setRowCount(l.getRowCount()+h),l.getCellMatrix().insertRows(s.startRow,h),!0}},Ht=(o,t)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},ce={id:"sheet.mutation.insert-col",type:i.CommandType.MUTATION,handler:(o,t)=>{var R;const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(!s)return!1;const r=s.getColumnManager(),{range:a,colInfo:c}=t,u=r.getColumnData(),d=a.startColumn,m=a.endColumn-a.startColumn+1,h=s.getConfig().defaultColumnWidth;for(let C=d;C<d+m;C++){const f={w:h,hd:0};c?i.insertMatrixArray(C,(R=c[C-a.startColumn])!=null?R:f,u):i.insertMatrixArray(C,f,u)}return s.setColumnCount(s.getColumnCount()+a.endColumn-a.startColumn+1),s.getCellMatrix().insertColumns(a.startColumn,m),!0}},He={id:"sheet.mutation.move-range",type:i.CommandType.MUTATION,handler:(o,t)=>{const{from:e,to:n}=t;if(!e||!n)return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getSheetBySheetId(t.from.subUnitId),c=r.getSheetBySheetId(t.to.subUnitId);if(!a||!c)return!1;const l=a.getCellMatrix(),u=c.getCellMatrix();return new i.ObjectMatrix(e.value).forValue((d,m,h)=>{h==null?l.realDeleteValue(d,m):l.setValue(d,m,h)}),new i.ObjectMatrix(n.value).forValue((d,m,h)=>{h==null?u.realDeleteValue(d,m):u.setValue(d,m,h)}),!0}};function ys(o,t){const{unitId:e,subUnitId:n,sourceRange:s,targetRange:r}=t,a=s.startRow>r.startRow,c=s.endRow-s.startRow+1;return a?{unitId:e,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...s,endRow:s.endRow+c,startRow:s.startRow+c}}:{unitId:e,subUnitId:n,targetRange:i.Rectangle.clone(s),sourceRange:{...r,endRow:r.endRow-c,startRow:r.startRow-c}}}const ve={id:"sheet.mutation.move-rows",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,sourceRange:s,targetRange:r}=t,c=o.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(!c)throw new Error("[MoveRowMutation] univerSheet is null!");const l=c.getSheetBySheetId(n);if(!l)throw new Error("[MoveRowMutation] worksheet is null!");const u=s.startRow,d=s.endRow-s.startRow+1,m=r.startRow,h=l.getRowManager().getRowData();return i.moveMatrixArray(u,d,m,h),l.getCellMatrix().moveRows(u,d,m),!0}};function _s(o,t){const{unitId:e,subUnitId:n,sourceRange:s,targetRange:r}=t,a=s.startColumn>r.startColumn,c=s.endColumn-s.startColumn+1;return a?{unitId:e,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...s,endColumn:s.endColumn+c,startColumn:s.startColumn+c}}:{unitId:e,subUnitId:n,targetRange:i.Rectangle.clone(s),sourceRange:{...r,startColumn:r.startColumn-c,endColumn:r.endColumn-c}}}const we={id:"sheet.mutation.move-columns",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,sourceRange:s,targetRange:r}=t,c=o.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(!c)throw new Error("[MoveColumnMutation] univerSheet is null!");const l=c.getSheetBySheetId(n);if(!l)throw new Error("[MoveColumnMutation] worksheet is null!");const u=s.startColumn,d=s.endColumn-s.startColumn+1,m=r.startColumn,h=l.getColumnManager().getColumnData();return i.moveMatrixArray(u,d,m,h),l.getCellMatrix().moveColumns(u,d,m),!0}},ua=(o,t)=>{const s=t.getRowManager().getRowData(),r={},a=o.range,c=i.sliceMatrixArray(a.startRow,a.endRow,s),l=i.concatMatrixArray(r,c);return{unitId:o.unitId,subUnitId:o.subUnitId,range:o.range,rowInfo:l}},le={id:"sheet.mutation.remove-rows",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(!s)return!1;const r=t.range,c=s.getRowManager().getRowData();for(let d=r.startRow;d<=r.endRow;d++)s.getRowFiltered(d);const l=r.endRow-r.startRow+1;return i.spliceArray(r.startRow,l,c),s.getCellMatrix().removeRows(r.startRow,l),s.setRowCount(s.getRowCount()-l),!0}},da=(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(s==null)throw new Error("worksheet is null error!");const c=s.getColumnManager().getColumnData(),l={},u=t.range,d=i.sliceMatrixArray(u.startColumn,u.endColumn,c),m=i.concatMatrixArray(l,d);return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,colInfo:m}},ne={id:"sheet.mutation.remove-col",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(!s)return!1;const r=t.range,c=s.getColumnManager().getColumnData(),l=r.endColumn-r.startColumn+1;return i.spliceArray(r.startColumn,l,c),s.setColumnCount(s.getColumnCount()-l),s.getCellMatrix().removeColumns(r.startColumn,l),!0}},se=(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(s==null)throw new Error("worksheet is null error!");const a=s.getConfig().mergeData,c=t.ranges,l=[];for(let u=0;u<c.length;u++)for(let d=a.length-1;d>=0;d--){const m=a[d],h=c[u];i.Rectangle.intersects(m,h)&&l.push(a[d])}return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:l}},H={id:"sheet.mutation.remove-worksheet-merge",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(!s)return!1;const a=s.getConfig().mergeData,c=t.ranges;for(let l=0;l<c.length;l++)for(let u=a.length-1;u>=0;u--){const d=a[u],m=c[l];i.Rectangle.intersects(d,m)&&a.splice(u,1)}return s.getSpanModel().rebuild(a),!0}},bs=o=>{const{order:t}=o,e={};return Object.keys(t).forEach(n=>{e[t[Number(n)]]=Number(n)}),{...o,order:e}},At={id:"sheet.mutation.reorder-range",type:i.CommandType.MUTATION,handler:(o,t)=>{const{subUnitId:e,unitId:n,range:s,order:r}=t,l=o.get(i.IUniverInstanceService).getUnit(n).getSheetBySheetId(e);if(!l)return!1;const u=new i.ObjectMatrix;i.Range.foreach(s,(m,h)=>{if(r.hasOwnProperty(m)){const g=r[m],R=i.Tools.deepClone(l.getCellRaw(g,h));u.setValue(m,h,R)}});const d=l.getCellMatrix();return u.forValue((m,h,g)=>{d.setValue(m,h,g)}),!0}};function ma(o,t){if(o==null)return o;const e=i.Tools.deepClone(o);if(t==null)return e;const n={};return"h"in t&&(n.h=e.h),"ia"in t&&(n.ia=e.ia),"ah"in t&&(n.ah=e.ah),"hd"in t&&(n.hd=e.hd),"s"in t&&(n.s=e.s),"custom"in t&&(n.custom=e.custom),n}function ha(o,t){if(o==null)return o;const e=i.Tools.deepClone(o);if(t==null)return e;const n={};return"w"in t&&(n.w=e.w),"hd"in t&&(n.hd=e.hd),"s"in t&&(n.s=e.s),"custom"in t&&(n.custom=e.custom),n}const Es=(o,t)=>{const{unitId:e,subUnitId:n,columnData:s}=o,r={},a=t.getColumnManager();for(const c in s){const l=s[c],u=a.getColumn(Number(c));r[c]=ha(u,l)}return{unitId:e,subUnitId:n,columnData:r}},rt={id:"sheet.mutation.set-col-data",type:i.CommandType.MUTATION,handler:(o,t)=>{const{columnData:e}=t,n=o.get(i.IUniverInstanceService),s=P(n,t);if(!s)return!1;const{worksheet:r}=s,a=r.getColumnManager();for(const c in e){const l=e[c];if(l==null){a.removeColumn(Number(c));continue}const u=a.getColumnOrCreate(Number(c));Object.assign(u,l)}return!0}},ga=(o,t)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},Ct={id:"sheet.mutation.set-col-hidden",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;const s=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let c=a.startColumn;c<a.endColumn+1;c++){const l=s.getColumnOrCreate(c);l!=null&&(l.hd=i.BooleanNumber.TRUE)}}return!0}},Ra=(o,t)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},St={id:"sheet.mutation.set-col-visible",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;const s=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let c=a.startColumn;c<a.endColumn+1;c++){const l=s.getColumnOrCreate(c);l!=null&&(l.hd=i.BooleanNumber.FALSE)}}return!0}},it={id:"sheet.mutation.set-gridlines-color",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=P(o.get(i.IUniverInstanceService),t);if(!e)return!1;const{worksheet:n}=e,s=n.getConfig();return s.gridlinesColor=t.color,!0}};function Ca(o,t,e){var a;const n=o.getStyleByCell(t);n==null&&delete t.s,typeof e.s=="string"&&(e.s=o.get(e.s));const s=on(n,e.s?e.s:null);s&&(i.Tools.removeNull(s),Object.entries(s).forEach(([c,l])=>{typeof l=="object"&&l!==null&&Object.keys(l).length===0&&delete s[c]})),i.Tools.isEmptyObject(s)?delete t.s:t.s=o.setValue(s);const r=e.v?`${e.v}\r
`:"";!e.p&&t.p&&(r&&r!==((a=t.p.body)==null?void 0:a.dataStream)?delete t.p:pa(t.p,e.s?e.s:null))}function Sa(o,t){if(!t||!Object.keys(t).length)return o;const e=i.Tools.deepClone(o!=null?o:{});for(const n in t)n==="bd"?e[n]=fa(e[n]||{},t[n]):n in e||(e[n]=null);return e}function fa(o,t){if(!t||!Object.keys(t).length)return o;for(const e in t)e in o||(o[e]=null);return o}function on(o,t,e=!1){if(t===null)return t;if(t===void 0)return o;const n=i.Tools.deepClone(o)||{};for(const s in t)e&&["bd","tr","td","ht","vt","tb","pd","bg"].includes(s)||(s in n&&s==="bd"?n[s]=Object.assign(n[s],t[s]):n[s]=t[s]);return"cl"in n&&("ul"in n&&n.ul&&(n.ul.cl=n.cl),"ol"in n&&n.ol&&(n.ol.cl=n.cl),"st"in n&&n.st&&(n.st.cl=n.cl)),n}function Ts(o,t){return o.some(e=>e.startIndex===t)?Ts(o,t+1):t}function pa(o,t){var a;if(o.body==null)return;Array.isArray(o.body.textRuns)||(o.body.textRuns=[]);let e=0;const n=[],s=((a=o.body)==null?void 0:a.paragraphs)||[];for(const c of o.body.textRuns){const{st:l,ed:u,ts:d={}}=c;if(e<l){const h={st:e,ed:l},g=on({},t,!0);g&&i.Tools.removeNull(g),i.Tools.isEmptyObject(g)||(h.ts=g),n.push(h)}const m=on(d,t,!0);m&&i.Tools.removeNull(m),i.Tools.isEmptyObject(m)?delete c.ts:c.ts=m,n.push(c),e=Ts(s,u)}const r=o.body.dataStream.endsWith(`\r
`)?o.body.dataStream.length-2:o.body.dataStream.length;if(e<r){const c={st:e,ed:r},l=on({},t,!0);l&&i.Tools.removeNull(l),i.Tools.isEmptyObject(l)||(c.ts=l),n.push(c)}o.body.textRuns=i.normalizeTextRuns(n)}function os(o,t){return t.v===void 0||t.v===null?t.v:o===i.CellValueType.NUMBER?Number(t.v):o===i.CellValueType.BOOLEAN?Ia(t.v)?1:0:o===i.CellValueType.STRING||o===i.CellValueType.FORCE_STRING?`${t.v}`:t.v}function Ia(o){if(typeof o=="string"){if(o.toUpperCase()==="TRUE")return!0;if(o.toUpperCase()==="FALSE")return!1;if(i.isSafeNumeric(o)){if(Number(o)===0)return!1;if(Number(o)===1)return!0}}if(typeof o=="number"){if(o===0)return!1;if(o===1)return!0}return typeof o=="boolean"?o:null}function va(o){return o==null?null:(o.f===void 0&&(o.f=null),o.si===void 0&&(o.si=null),o.p===void 0&&(o.p=null),o.v===void 0&&(o.v=null),o.t===void 0&&(o.t=null),o.s===void 0&&(o.s=null),o.custom===void 0&&(o.custom=null),o)}const me=(o,t)=>{const{unitId:e,subUnitId:n,cellValue:s}=t,a=o.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(a==null)throw new Error("workbook is null error!");const c=a.getSheetBySheetId(n);if(c==null)throw new Error("worksheet is null error!");const l=c.getCellMatrix(),u=a.getStyles(),d=new i.ObjectMatrix;return new i.ObjectMatrix(s).forValue((h,g,R)=>{const C=i.Tools.deepClone(l==null?void 0:l.getValue(h,g))||{},f=u.getStyleByCell(C),p=u.getStyleByCell(R);C.s=Sa(f,p),d.setValue(h,g,va(C))}),{...t,options:{},cellValue:d.getMatrix()}},B={id:"sheet.mutation.set-range-values",type:i.CommandType.MUTATION,handler:(o,t)=>{const{cellValue:e,subUnitId:n,unitId:s}=t,a=o.get(i.IUniverInstanceService).getUnit(s);if(!a)return!1;const c=a.getSheetBySheetId(n);if(!c)return!1;const l=c.getCellMatrix(),u=a.getStyles();return new i.ObjectMatrix(e).forValue((m,h,g)=>{if(!g)l.realDeleteValue(m,h);else{let R=l.getValue(m,h)||{};R=Ma(g,R,u),i.Tools.isEmptyObject(R)?l.realDeleteValue(m,h):l.setValue(m,h,R)}}),!0}},wa=new Set(["f","p","si","custom","ref"]);function Ma(o,t,e){const n=Li(e,o,t);return Object.keys(o).forEach(s=>{const r=s;if(wa.has(r)){const a=o[r];ya(t,r,a)}else r==="v"?o.v!==void 0&&(t.v=os(n,o)):r==="s"&&Ca(e,t,o)}),t.v!==void 0&&(t.t=n,t.v=os(n,t)),t.v===null&&(delete t.t,delete t.v),t}function ya(o,t,e){e===void 0||(e===null?delete o[t]:o[t]=e)}const Us=(o,t)=>{const{unitId:e,subUnitId:n,rowData:s}=o,r={},a=t.getRowManager();for(const c in s){const l=s[c],u=a.getRow(Number(c));r[c]=ma(u,l)}return{unitId:e,subUnitId:n,rowData:r}},at={id:"sheet.mutation.set-row-data",type:i.CommandType.MUTATION,handler:(o,t)=>{const{rowData:e}=t,n=o.get(i.IUniverInstanceService),s=P(n,t);if(!s)return!1;const{worksheet:r}=s,a=r.getRowManager();for(const c in e){const l=e[c];if(l==null){a.removeRow(Number(c));continue}const u=a.getRowOrCreate(Number(c));Object.assign(u,l)}return!0}},_a=(o,t)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},Ke={id:"sheet.mutation.set-row-visible",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let c=a.startRow;c<a.endRow+1;c++){const l=s.getRowOrCreate(c);l!=null&&(l.hd=0)}}return!0}},ba=(o,t)=>{if(o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},Je={id:"sheet.mutation.set-row-hidden",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let c=a.startRow;c<a.endRow+1;c++){const l=s.getRowOrCreate(c);l!=null&&(l.hd=1)}}return!0}},Yn=(o,t)=>{const{unitId:e,subUnitId:n,ranges:s}=o,r={},a=t.getColumnManager();for(let c=0;c<s.length;c++){const l=s[c];for(let u=l.startColumn;u<l.endColumn+1;u++)r[u]=a.getColumnWidth(u)}return{unitId:e,subUnitId:n,ranges:s,colWidth:r}},Ae={id:"sheet.mutation.set-worksheet-col-width",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{worksheet:s}=n,r=s.getColumnManager(),a=t.ranges;for(let c=0;c<a.length;c++){const l=a[c];for(let u=l.startColumn;u<l.endColumn+1;u++)s.getColVisible(u)&&(typeof t.colWidth=="number"?r.setColumnWidth(u,t.colWidth):i.Tools.isDefine(t.colWidth[u])&&r.setColumnWidth(u,t.colWidth[u]))}return!0}},Ps=(o,t)=>{const e=_e(o.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetColumnCountUndoMutationFactory]: worksheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,columnCount:e.worksheet.getColumnCount()}},ct={id:"sheet.mutation.set-worksheet-column-count",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService),n=_e(e,t);return n?(n.worksheet.setColumnCount(t.columnCount),!0):!1}},lt={id:"sheet.mutation.set-worksheet-default-style",type:i.CommandType.MUTATION,handler:(o,t)=>{const{defaultStyle:e}=t,n=o.get(i.IUniverInstanceService),s=P(n);if(!s)return!1;const{worksheet:r}=s;return r?(r.setDefaultCellStyle(e),!0):!1}},ks=(o,t)=>{const e=_e(o.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetDefaultStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,subUnitId:n.getSheetId(),defaultStyle:n.getDefaultCellStyle()}},Ns=(o,t)=>{const e=_e(o.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetRowCountUndoMutationFactory]: worksheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,rowCount:e.worksheet.getRowCount()}},ut={id:"sheet.mutation.set-worksheet-row-count",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService),n=_e(e,t);return n?(n.worksheet.setRowCount(t.rowCount),!0):!1}},Os=(o,t)=>{var c,l;const{unitId:e,subUnitId:n,ranges:s}=o,r={},a=t.getRowManager();for(const{startRow:u,endRow:d}of s)for(let m=u;m<d+1;m++)r[m]=(l=(c=a.getRow(m))==null?void 0:c.h)!=null?l:t.getConfig().defaultRowHeight;return{unitId:e,subUnitId:n,ranges:s,rowHeight:r}},Kn=(o,t)=>{var c;const{unitId:e,subUnitId:n,ranges:s}=o,r={},a=t.getRowManager();for(const{startRow:l,endRow:u}of s)for(let d=l;d<=u;d++)r[d]=(c=a.getRow(d))==null?void 0:c.ia;return{unitId:e,subUnitId:n,ranges:s,autoHeightInfo:r}},Ea=(o,t)=>{var c,l;const{unitId:e,subUnitId:n,rowsAutoHeightInfo:s}=o,r=[],a=t.getRowManager();for(const u of s){const{row:d}=u;r.push({row:d,autoHeight:(l=(c=a.getRow(d))==null?void 0:c.ah)!=null?l:t.getConfig().defaultRowHeight})}return{unitId:e,subUnitId:n,rowsAutoHeightInfo:r}},Te={id:"sheet.mutation.set-worksheet-row-height",type:i.CommandType.MUTATION,handler:(o,t)=>{const{ranges:e,rowHeight:n}=t,s=o.get(i.IUniverInstanceService),r=P(s,t);if(!r)return!1;const{worksheet:a}=r,c=a.getRowManager();for(const{startRow:l,endRow:u}of e)for(let d=l;d<=u;d++)typeof n=="number"?c.setRowHeight(d,n):i.Tools.isDefine(n[d])&&c.setRowHeight(d,n[d]);return!0}},Se={id:"sheet.mutation.set-worksheet-row-is-auto-height",type:i.CommandType.MUTATION,handler:(o,t)=>{var c;const{ranges:e,autoHeightInfo:n}=t,s=o.get(i.IUniverInstanceService),r=P(s,t);if(!r)return!1;const a=r.worksheet.getRowManager();for(const{startRow:l,endRow:u}of e)for(let d=l;d<=u;d++){const m=a.getRowOrCreate(d);typeof n=="number"?m.ia=n:m.ia=(c=n[d])!=null?c:void 0}return!0}},Jn={id:"sheet.mutation.set-worksheet-row-auto-height",type:i.CommandType.MUTATION,handler:(o,t)=>{const{rowsAutoHeightInfo:e}=t,n=o.get(i.IUniverInstanceService),s=P(n,t);if(!s)return!1;const r=s.worksheet.getRowManager();for(const{row:a,autoHeight:c}of e){const l=r.getRowOrCreate(a);l.ah=c}return!0}},dt={id:"sheet.mutation.toggle-gridlines",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=P(o.get(i.IUniverInstanceService),t);if(!e)return!1;const{worksheet:n}=e,s=n.getConfig();return s.showGridlines=t.showGridlines,!0}},bt={id:"sheet.operation.set-worksheet-active",type:i.CommandType.OPERATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getWorksheets();for(const[,s]of n)if(s.getSheetId()===t.subUnitId)return e.setActiveSheet(s),!0;return!1}};var Ds=(o=>(o.SET_WORKSHEET_ROW_HEIGHT="sheet.mutation.set-worksheet-row-height",o.SET_WORKSHEET_ROW_IS_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-is-auto-height",o.SET_WORKSHEET_ROW_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-auto-height",o.SET_WORKSHEET_COL_WIDTH="sheet.mutation.set-worksheet-col-width",o.SET_WORKSHEET_ACTIVE="sheet.operation.set-worksheet-active",o.MOVE_ROWS="sheet.mutation.move-rows",o.MOVE_COLUMNS="sheet.mutation.move-columns",o.SET_COL_HIDDEN="sheet.mutation.set-col-hidden",o.SET_COL_VISIBLE="sheet.mutation.set-col-visible",o.SET_ROW_HIDDEN="sheet.mutation.set-row-hidden",o.SET_ROW_VISIBLE="sheet.mutation.set-row-visible",o.INSERT_COL="sheet.mutation.insert-col",o.INSERT_ROW="sheet.mutation.insert-row",o.REMOVE_COL="sheet.mutation.remove-col",o.REMOVE_ROW="sheet.mutation.remove-rows",o.TOGGLE_GRIDLINES="sheet.mutation.toggle-gridlines",o.SET_GRIDLINES_COLOR="sheet.mutation.set-gridlines-color",o))(Ds||{}),As=(o=>(o.SET_RANGE_VALUES="sheet.mutation.set-range-values",o.MOVE_RANGE="sheet.mutation.move-range",o.REMOVE_WORKSHEET_MERGE="sheet.mutation.remove-worksheet-merge",o.ADD_WORKSHEET_MERGE="sheet.mutation.add-worksheet-merge",o.REORDER_RANGE="sheet.mutation.reorder-range",o.SET_WORKSHEET_DEFAULT_STYLE="sheet.mutation.set-worksheet-default-style",o.SET_ROW_DATA="sheet.mutation.set-row-data",o.SET_COL_DATA="sheet.mutation.set-col-data",o.SET_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.set-worksheet-range-theme-style",o.DELETE_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.delete-worksheet-range-theme-style",o))(As||{});const Ta=[Te.id,Se.id,Jn.id,Ae.id,bt.id,ve.id,we.id,Ct.id,St.id,Je.id,Ke.id,ce.id,ae.id,ne.id,le.id,dt.id,it.id,ut.id,ct.id],Ua=[B.id,He.id,H.id,F.id,At.id,lt.id,at.id,rt.id,gt.id,Rt.id];function Pa(o){switch(o.id){case"sheet.mutation.set-range-values":{const t=o.params,e=new i.ObjectMatrix(t.cellValue).getDataRange();return e.endRow===-1?[]:t.cellValue?[{unitId:t.unitId,subUnitId:t.subUnitId,range:e}]:[]}case"sheet.mutation.move-range":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.from.subUnitId,range:new i.ObjectMatrix(t.from.value).getRange()},{unitId:t.unitId,subUnitId:t.to.subUnitId,range:new i.ObjectMatrix(t.to.value).getRange()}]}case"sheet.mutation.remove-worksheet-merge":{const t=o.params;return t.ranges.map(e=>({unitId:t.unitId,subUnitId:t.subUnitId,range:e}))}case"sheet.mutation.add-worksheet-merge":{const t=o.params;return t.ranges.map(e=>({unitId:t.unitId,subUnitId:t.subUnitId,range:e}))}case"sheet.mutation.reorder-range":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}]}case"sheet.mutation.set-worksheet-default-style":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-row-data":{const t=o.params,e=Object.keys(t.rowData).map(Number);return e.length===0?[]:[{unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:Math.min(...e),endRow:Math.max(...e),startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-col-data":{const t=o.params,e=Object.keys(t.columnData).map(Number);return e.length===0?[]:[{unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:Math.min(...e),endColumn:Math.max(...e)}}]}case"sheet.mutation.set-worksheet-range-theme-style":case"sheet.mutation.delete-worksheet-range-theme-style":{const t=o.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}]}default:return[]}}function ka(o,t){switch(o.id){case"sheet.mutation.set-worksheet-row-height":case"sheet.mutation.set-worksheet-row-is-auto-height":{const e=o.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-row-auto-height":{const e=o.params;return e.rowsAutoHeightInfo.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:n.row,endRow:n.row,startColumn:0,endColumn:t-1,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-col-width":{const e=o.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.move-rows":case"sheet.mutation.move-columns":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:e.targetRange},{unitId:e.unitId,subUnitId:e.subUnitId,range:e.sourceRange}]}case"sheet.mutation.set-col-hidden":case"sheet.mutation.set-col-visible":{const e=o.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.set-row-hidden":case"sheet.mutation.set-row-visible":{const e=o.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.insert-col":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.insert-row":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.remove-col":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.remove-rows":{const e=o.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.toggle-gridlines":case"sheet.mutation.set-gridlines-color":return[];default:return[]}}function ss(o){return o==null?!1:o.v!==void 0&&o.v!==null&&o.v!==""||o.p!==void 0}function In(o,t){return o&&o.spanAnchor?ss(t.getValue(o.spanAnchor.startRow,o.spanAnchor.startColumn)):ss(o)}function Na(o,t,e,n,s){const r=o.getCellMatrix(),a=o.getSpanModel().getMergedCellRange(t,e,n,s),c=new i.ObjectMatrix;return r.forValue((l,u)=>{const d=r.getValue(l,u);d&&c.setValue(l,u,d)}),a.forEach(l=>{const{startColumn:u,startRow:d,endColumn:m,endRow:h}=l;i.createRowColIter(d,h,u,m).forEach((g,R)=>{g===d&&R===u&&c.setValue(g,R,{...r.getValue(g,R),spanAnchor:{startRow:d,endRow:h,startColumn:u,endColumn:m}}),(g!==d||R!==u)&&(c.realDeleteValue(g,R),c.setValue(g,R,{spanAnchor:{startRow:d,endRow:h,startColumn:u,endColumn:m}}))})}),c}function Oa(o,t,e,n){const{startRow:s,startColumn:r,endRow:a}=o;let c=null,l=!1;for(let u=s;u<=a;u++){const d=t.getValue(u,r-e);if(l=l||In(d,t),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.startColumn=o.startColumn-e,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function Da(o,t,e,n){const{startRow:s,endColumn:r,endRow:a}=o;let c=null,l=!1;for(let u=s;u<=a;u++){const d=t.getValue(u,r+e);if(l=l||In(d,t),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.endColumn=o.endColumn+e,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function Aa(o,t,e,n){const{startRow:s,startColumn:r,endColumn:a}=o;let c=null,l=!1;for(let u=r;u<=a;u++){const d=t.getValue(s-e,u);if(l=l||In(d,t),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.startRow=o.startRow-e,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function xa(o,t,e,n){const{startColumn:s,endColumn:r,endRow:a}=o;let c=null,l=!1;for(let u=s;u<=r;u++){const d=t.getValue(a+e,u);if(l=l||In(d,t),!n&&l)break;d&&d.spanAnchor&&(c?c={startRow:Math.min(d.spanAnchor.startRow,c.startRow),startColumn:Math.min(d.spanAnchor.startColumn,c.startColumn),endRow:Math.max(d.spanAnchor.endRow,c.endRow),endColumn:Math.max(d.spanAnchor.endColumn,c.endColumn)}:c={startRow:d.spanAnchor.startRow,startColumn:d.spanAnchor.startColumn,endRow:d.spanAnchor.endRow,endColumn:d.spanAnchor.endColumn})}return l?(o.endRow=o.endRow+e,{spanAnchor:c,hasValue:!0,range:o}):{spanAnchor:null,hasValue:!1,range:o}}function Wa(o,t,e){const n=e.getMaxRows(),s=e.getMaxColumns(),r=Na(e,0,0,n-1,s-1),a=e.getSnapshot().mergeData.length>0,{left:c,right:l,up:u,down:d}=t;let m=!0,h={...o};const g=[];for(;m;){if(m=!1,u&&h.startRow!==0){const{hasValue:R,range:C,spanAnchor:f}=Aa(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}if(d&&h.endRow!==n-1){const{hasValue:R,range:C,spanAnchor:f}=xa(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}if(c&&h.startColumn!==0){const{hasValue:R,range:C,spanAnchor:f}=Oa(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}if(l&&h.endColumn!==s-1){const{hasValue:R,range:C,spanAnchor:f}=Da(h,r,1,a);if(f&&g.push(f),R){h=C,m=!0;continue}}}return g.length>0&&(h=i.Rectangle.union(h,...g)),h}const xs=o=>{const t=new i.ObjectMatrix;return o.forEach(e=>{i.Range.foreach(e,(n,s)=>{t.setValue(n,s,1)})}),t.forValue((e,n)=>{const s=t.getValue(e-1,n);s&&t.setValue(e,n,s+1)}),t},Ws=o=>{const t=o;return t.forValue((e,n)=>{const s=o.getValue(e-1,n);s&&t.setValue(e,n,s+1)}),t},rs=o=>{const t={area:0},e=(n,s)=>t.area<n?(t.area=n,t.range=s,!0):!1;return o.forValue((n,s,r)=>{let a=1,c=r;e(a*c,{startRow:n-c+1,endRow:n,startColumn:s,endColumn:s});const l={startRow:n-c+1,endRow:n,startColumn:0,endColumn:s};for(let u=s-1;u>=0&&o.getValue(n,u);u--){c=Math.min(o.getValue(n,u)||0,c),a++;const d=c*a;l.startColumn=u,l.startRow=n-c+1,e(d,l)}}),t},Va=(o,t)=>{i.Range.foreach(t,(e,n)=>{o.realDeleteValue(e,n)});for(let e=t.startColumn;e<=t.endColumn;e++){const n=t.endRow+1;if(o.getValue(n,e)>0){o.setValue(n,e,1);let r=n+1;for(;o.getValue(r,e)>0;)o.setValue(r,e,o.getValue(r-1,e)+1),r++}}return o},Xn=o=>{const t=[];let e=rs(o);for(;e.area>0;)e.range&&(t.push(e.range),Va(o,e.range)),e=rs(o);return t},Zn=o=>{const t=xs(o);return Xn(t)};class $a{constructor(){S(this,"_matrix",new i.ObjectMatrix)}add(...t){return t.forEach(e=>{i.Range.foreach(e,(n,s)=>{this._matrix.setValue(n,s,1)})}),this}subtract(...t){return t.forEach(e=>{i.Range.foreach(e,(n,s)=>{this._matrix.realDeleteValue(n,s)})}),this}merge(){const t=Ws(this._matrix);return Xn(t)}}const La=1.5,Ba="rgba(255, 255, 255, 0.01)";function Fa(o){const{rangeWithCoord:t,primaryWithCoord:e,style:n}=o,s={range:{startRow:t.startRow,startColumn:t.startColumn,endRow:t.endRow,endColumn:t.endColumn,rangeType:t.rangeType,unitId:t.unitId,sheetId:t.sheetId},primary:null,style:n};return e!=null&&(s.primary=Vs(e)),s}function Vs(o){const{actualRow:t,actualColumn:e,isMerged:n,isMergedMainCell:s}=o,{startRow:r,startColumn:a,endRow:c,endColumn:l}=o.mergeInfo;return{actualRow:t,actualColumn:e,isMerged:n,isMergedMainCell:s,startRow:r,startColumn:a,endRow:c,endColumn:l}}var $s=(o=>(o[o.Tab=1]="Tab",o[o.Comma=2]="Comma",o[o.Semicolon=4]="Semicolon",o[o.Space=8]="Space",o[o.Custom=16]="Custom",o))($s||{});class Ha{constructor(){S(this,"_tabCount",0);S(this,"_commaCount",0);S(this,"_semicolonCount",0);S(this,"_spaceCount",0)}add(t){switch(t){case"	":this._tabCount++;break;case",":this._commaCount++;break;case";":this._semicolonCount++;break;case" ":this._spaceCount++;break}}update(t){t&&typeof t=="string"&&(t.includes("	")&&this._tabCount++,t.includes(",")&&this._commaCount++,t.includes(";")&&this._semicolonCount++,t.trim().includes(" ")&&this._spaceCount++)}getDelimiter(){const t=Math.max(this._tabCount,this._commaCount,this._semicolonCount,this._spaceCount);return t===0||t===this._tabCount?1:t===this._commaCount?2:t===this._semicolonCount?4:t===this._spaceCount?8:1}}function ja(o,t,e){const n=[];e!==void 0&&(o&16)>0&&n.push(e),(o&1)>0&&n.push("	"),(o&2)>0&&n.push(","),(o&4)>0&&n.push(";"),(o&8)>0&&n.push(" ");let s="";for(const a of n)s+=Ga(a);let r="[".concat(s,"]");return t&&(r+="+"),new RegExp(r)}function Ga(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const za=o=>{var e;return((e=o.body)==null?void 0:e.dataStream.replace(/\r\n$/,""))||""};function qa(o){if(o!=null){if(o.p)return za(o.p);if(o.v&&typeof o.v=="string")return o.v;if(o.t&&(o.t===i.CellValueType.FORCE_STRING||o.t===i.CellValueType.STRING))return String(o.v)}}function Ls(o,t,e,n,s=!1){const r=i.Range.transformRange(t,o),{startColumn:a,startRow:c,endColumn:l,endRow:u}=r;if(a!==l)throw new Error("The range must be in the same column.");if(e&&(e&16)>0&&(n===void 0||n.length!==1))throw new Error("The custom delimiter must a character.");const d=e===void 0,m=d?new Ha:null,h=[];for(let I=c;I<=u;I++){const v=o.getCell(I,a),M=qa(v);h.push(M),m&&m.update(M)}const g=d?m.getDelimiter():e,R=ja(g,s,n);let C=-1,f=0,p=0;const w=[];for(const I of h){if(I!==void 0){const v=String(I).split(R);C<0?C=v.length:C=Math.max(C,v.length),w.push(v),f=p}else w.push(void 0);p++}return{rs:w,maxLength:C===-1?0:C,lastRow:f}}const Ya=(o,t,e="")=>o.reduce((n,s)=>{const r=s&&s[t];return typeof r!="string"?(console.warn(s,`${t} is not string`),n):(r?(n[r]||(n[r]=[]),n[r].push(s)):n[e].push(s),n)},{}),Ka=(o=0)=>{let t=o;return function(){return t++}};function Ja(o){return o==null?!1:o.v!==void 0&&o.v!==null&&o.v!==""||o.p!==void 0}function Xa(o,t){for(let e=o.startRow;e<=o.endRow;e++)for(let n=o.startColumn;n<=o.endColumn;n++){const s=t.getCell(e,n);if(Ja(s))return{startRow:e,startColumn:n,endRow:e,endColumn:n}}return null}function Qn(o){const t=new i.ObjectMatrix;return o.forEach(e=>{const{startRow:n,startColumn:s,endRow:r,endColumn:a}=e;for(let c=n;c<=r;c++)for(let l=s;l<=a;l++)t.setValue(c,l,null)}),t.clone()}function Bs(o){const t=new i.ObjectMatrix;return o.forEach(e=>{const{startRow:n,startColumn:s,endRow:r,endColumn:a}=e;for(let c=n;c<=r;c++)for(let l=s;l<=a;l++)t.setValue(c,l,{v:null,p:null,f:null,si:null,custom:null})}),t.clone()}function Za(o){const t=new i.ObjectMatrix;return o.forEach(e=>{const{startRow:n,startColumn:s,endRow:r,endColumn:a}=e;for(let c=n;c<=r;c++)for(let l=s;l<=a;l++)t.setValue(c,l,{s:null})}),t.clone()}function Fs(o,t,e,n){const s=t.get(i.IUniverInstanceService),r=e?s.getUnit(e,i.UniverInstanceType.UNIVER_SHEET):s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=n?r==null?void 0:r.getSheetBySheetId(n):r==null?void 0:r.getActiveSheet();if(!a)return null;const{startRow:c,endRow:l,startColumn:u,endColumn:d}=o,m=[],h=[];for(let g=c;g<=l;g++)a.getRowFiltered(g)||m.push(g);for(let g=u;g<=d;g++)h.push(g);return{rows:m,cols:h}}function jt(o,t,e,n){const s=[],r=[];for(const h of o){const g=Fs(h,t,e,n);g&&(s.push(...g.rows),r.push(...g.cols))}const a=Array.from(new Set(s)).sort((h,g)=>h-g),c=Array.from(new Set(r)).sort((h,g)=>h-g),l=[];function u(h){const g=[];let R=h[0];for(let C=1;C<h.length;C++)h[C]!==h[C-1]+1&&(g.push([R,h[C-1]]),R=h[C]);return g.push([R,h[h.length-1]]),g}const d=u(a),m=u(c);for(const[h,g]of d)for(const[R,C]of m)l.push({startRow:h,endRow:g,startColumn:R,endColumn:C});return l}var Hs=(o=>(o.OthersCanView="othersCanView",o.NoOneElseCanView="noOneElseCanView",o))(Hs||{}),js=(o=>(o.DesignedUserCanEdit="designedUserCanEdit",o.OnlyMe="onlyMe",o))(js||{});class J{constructor(){S(this,"_model",new Map);S(this,"_ruleChange$",new O.Subject);S(this,"ruleChange$",this._ruleChange$.asObservable());S(this,"_ruleRefresh$",new O.Subject);S(this,"ruleRefresh$",this._ruleRefresh$.asObservable());S(this,"_rangeRuleInitStateChange",new O.BehaviorSubject(!1));S(this,"rangeRuleInitStateChange$",this._rangeRuleInitStateChange.asObservable())}dispose(){this._ruleChange$.complete(),this._ruleRefresh$.complete()}ruleRefresh(t){this._ruleRefresh$.next(t)}getRangeRuleInitState(){return this._rangeRuleInitStateChange.value}changeRuleInitState(t){this._rangeRuleInitStateChange.next(t)}addRule(t,e,n){this._ensureRuleMap(t,e).set(n.id,n),this._ruleChange$.next({unitId:t,subUnitId:e,rule:n,type:"add"})}deleteRule(t,e,n){var r,a,c,l;const s=(a=(r=this._model.get(t))==null?void 0:r.get(e))==null?void 0:a.get(n);s&&((l=(c=this._model.get(t))==null?void 0:c.get(e))==null||l.delete(n),this._ruleChange$.next({unitId:t,subUnitId:e,rule:s,type:"delete"}))}setRule(t,e,n,s){var a,c;const r=this.getRule(t,e,n);r&&((c=(a=this._model.get(t))==null?void 0:a.get(e))==null||c.set(n,s),this._ruleChange$.next({unitId:t,subUnitId:e,oldRule:r,rule:s,type:"set"}))}getRule(t,e,n){var s,r;return(r=(s=this._model.get(t))==null?void 0:s.get(e))==null?void 0:r.get(n)}getSubunitRuleList(t,e){var s;return[...(((s=this._model.get(t))==null?void 0:s.get(e))||new Map).values()]}getSubunitRuleListLength(t,e){var s;const n=(s=this._model.get(t))==null?void 0:s.get(e);return n?n.size:0}_ensureRuleMap(t,e){let n=this._model.get(t);n||(n=new Map,this._model.set(t,n));let s=n.get(e);return s||(s=new Map,n.set(e,s)),s}toObject(){const t={};return[...this._model.keys()].forEach(n=>{const s=this._model.get(n),r=[...s.keys()];t[n]={},r.forEach(a=>{const c=s.get(a);t[n][a]=[...c.values()]})}),t}fromObject(t){const e=new Map;Object.keys(t).forEach(n=>{const s=t[n],r=new Map;Object.keys(s).forEach(a=>{const c=s[a].reduce((l,u)=>(l.set(u.id,u),l),new Map);r.set(a,c)}),e.set(n,r)}),this._model=e}deleteUnitModel(t){this._model.delete(t)}createRuleId(t,e){let n=i.generateRandomId(4);const s=this._ensureRuleMap(t,e);for(;s.has(n);)n=i.generateRandomId(4);return n}getTargetByPermissionId(t,e){const n=this._model.get(t);if(!n)return null;for(const[s,r]of n)for(const a of r.values())if(a.permissionId===e)return[t,s];return null}}const Qa=(o,t)=>{const e=o.get(J),n=t.ruleIds.map(r=>e.getRule(t.unitId,t.subUnitId,r)).filter(r=>!!r);return{id:fe.id,params:{subUnitId:t.subUnitId,unitId:t.unitId,rules:n}}},ke={id:"sheet.mutation.delete-range-protection",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,ruleIds:s}=t,r=o.get(J);return s.forEach(a=>{r.deleteRule(e,n,a)}),!0}},ec=o=>{const t={...o,ruleIds:o.rules.map(e=>e.id)};return{id:ke.id,params:t}},fe={id:"sheet.mutation.add-range-protection",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,rules:s}=t,r=o.get(J);return s.forEach(a=>{r.addRule(e,n,a)}),!0}},Gs={type:i.CommandType.COMMAND,id:"sheet.command.add-range-protection",async handler(o,t){if(!t)return!1;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(J),{rule:r,permissionId:a}=t,{unitId:c,subUnitId:l,ranges:u,description:d,viewState:m,editState:h}=r,g=[{ranges:u,permissionId:a,id:s.createRuleId(c,l),description:d,unitType:r.unitType,unitId:c,subUnitId:l,viewState:m,editState:h}];if(await e.executeCommand(fe.id,{unitId:c,subUnitId:l,rules:g})){const C=[{id:fe.id,params:{unitId:c,subUnitId:l,rules:g}}],f=[{id:ke.id,params:{unitId:c,subUnitId:l,ruleIds:g.map(p=>p.id)}}];n.pushUndoRedo({unitID:c,redoMutations:C,undoMutations:f})}return!0}};var ee=(o=>(o[o.MOVE_START=0]="MOVE_START",o[o.MOVING=1]="MOVING",o[o.MOVE_END=2]="MOVE_END",o[o.ONLY_SET=3]="ONLY_SET",o))(ee||{});class zs extends i.Disposable{constructor(e){super();S(this,"_worksheetSelections",new Map);S(this,"_selectionMoveStart$",new O.Subject);S(this,"selectionMoveStart$",this._selectionMoveStart$.asObservable());S(this,"_selectionMoving$",new O.Subject);S(this,"selectionMoving$",this._selectionMoving$.asObservable());S(this,"_selectionMoveEnd$",new O.BehaviorSubject([]));S(this,"selectionMoveEnd$",this._selectionMoveEnd$.asObservable());S(this,"_selectionSet$",new O.BehaviorSubject([]));S(this,"selectionSet$",this._selectionSet$.asObservable());S(this,"selectionChanged$");S(this,"_beforeSelectionMoveEnd$",new O.BehaviorSubject([]));S(this,"beforeSelectionMoveEnd$",this._beforeSelectionMoveEnd$.asObservable());this._workbook=e,this.selectionChanged$=O.merge(this._selectionMoveEnd$,this._selectionSet$)}dispose(){super.dispose(),this._beforeSelectionMoveEnd$.complete(),this._selectionMoveEnd$.complete(),this._selectionMoving$.complete(),this._selectionMoveStart$.complete(),this._selectionSet$.complete(),this._workbook=null}addSelections(e,n){const s=this.getSelectionsOfWorksheet(e);s.push(...n),this._selectionSet$.next(s)}setSelections(e,n=[],s){switch(this.setSelectionsOfWorksheet(e,n),s){case ee.MOVE_START:this._selectionMoveStart$.next(n);break;case ee.MOVING:this._selectionMoving$.next(n);break;case ee.MOVE_END:this._beforeSelectionMoveEnd$.next(n),this._selectionMoveEnd$.next(n);break;case ee.ONLY_SET:{this._selectionSet$.next(n);break}default:this._selectionSet$.next(n);break}}getCurrentSelections(){return this._getCurrentSelections()}getSelectionOfWorksheet(e){return this.getSelectionsOfWorksheet(e)}getSelectionsOfWorksheet(e){return this._worksheetSelections.has(e)||this._worksheetSelections.set(e,[]),this._worksheetSelections.get(e)}setSelectionsOfWorksheet(e,n){this._worksheetSelections.set(e,[...n])}deleteSheetSelection(e){this._worksheetSelections.set(e,[])}clear(){this._worksheetSelections.clear(),this._selectionSet$.next([])}_getCurrentSelections(){return this.getSelectionsOfWorksheet(this._workbook.getActiveSheet().getSheetId())}getCurrentLastSelection(){const e=this._getCurrentSelections();return e[e.length-1]}}var tc=Object.getOwnPropertyDescriptor,nc=(o,t,e,n)=>{for(var s=n>1?void 0:n?tc(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},oc=(o,t)=>(e,n)=>t(e,n,o);exports.SheetsSelectionsService=class extends i.RxDisposable{constructor(e){super();S(this,"_cellStylesCache",new Map);S(this,"selectionMoveStart$");S(this,"selectionMoving$");S(this,"selectionMoveEnd$");S(this,"selectionSet$");S(this,"selectionChanged$");S(this,"_workbookSelections",new Map);this._instanceSrv=e,this._init()}get _currentSelectionPos(){const e=this._instanceSrv.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!e)return null;const n=e.getActiveSheet();return{unitId:e.getUnitId(),sheetId:n.getSheetId()}}get currentSelectionParam(){return this._currentSelectionPos}_init(){const e=this._instanceSrv.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.shareReplay(1),O.takeUntil(this.dispose$));this.selectionMoveStart$=e.pipe().pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveStart$:O.of())).pipe(O.takeUntil(this.dispose$)),this.selectionMoving$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoving$:O.of())).pipe(O.takeUntil(this.dispose$)),this.selectionMoveEnd$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveEnd$:O.of([]))).pipe(O.takeUntil(this.dispose$)),this.selectionSet$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionSet$:O.of([]))).pipe(O.takeUntil(this.dispose$)),this.selectionChanged$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionChanged$:O.of([]))).pipe(O.distinctUntilChanged((n,s)=>n.length!==s.length?!1:n.length===0&&s.length===0?!0:n.every((r,a)=>JSON.stringify(r)===JSON.stringify(s[a]))),O.skip(1)).pipe(O.takeUntil(this.dispose$)),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.takeUntil(this.dispose$)).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId())})),this.disposeWithMe(this.selectionChanged$.pipe(O.takeUntil(this.dispose$)).subscribe(()=>{this._cellStylesCache.clear()}))}dispose(){super.dispose(),this._cellStylesCache.clear(),this._workbookSelections.forEach(e=>e.dispose()),this._workbookSelections.clear(),this.selectionMoveStart$=O.of(null),this.selectionMoving$=O.of(null),this.selectionMoveEnd$=O.of([]),this.selectionSet$=O.of(null),this.selectionChanged$=O.of(null)}clear(){this._workbookSelections.forEach(e=>e.clear())}getCurrentSelections(){return this._getCurrentSelections()}getCurrentLastSelection(){const e=this._getCurrentSelections();return e==null?void 0:e[e.length-1]}addSelections(e,n,s){if(typeof e=="string"){this._ensureWorkbookSelection(e).addSelections(n,s);return}const r=this._currentSelectionPos;if(!r)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:a,sheetId:c}=r;this._ensureWorkbookSelection(a).addSelections(c,e)}setSelections(e,n,s,r){if(typeof e=="string"&&typeof n=="string"){const u=e;this._ensureWorkbookSelection(u).setSelections(n,s||[],r!=null?r:ee.ONLY_SET);return}const a=this._currentSelectionPos;if(!a)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:c,sheetId:l}=a;if(typeof e=="object"){const u=e!=null?e:s,d=n!=null?n:ee.ONLY_SET;this._ensureWorkbookSelection(c).setSelections(l,u,d)}}clearCurrentSelections(){this._getCurrentSelections().splice(0)}isOverlapping(){const e=this.getCurrentSelections();return e==null?!1:e.some(({range:n},s)=>e.some(({range:r},a)=>s===a?!1:n.startRow<=r.endRow&&n.endRow>=r.startRow&&n.startColumn<=r.endColumn&&n.endColumn>=r.startColumn))}_getCurrentSelections(){const e=this._currentSelectionPos;if(!e)return[];const{unitId:n,sheetId:s}=e;return this._ensureWorkbookSelection(n).getSelectionsOfWorksheet(s)}getWorkbookSelections(e){return this._ensureWorkbookSelection(e)}_ensureWorkbookSelection(e){let n=this._workbookSelections.get(e);if(!n){const s=this._instanceSrv.getUnit(e);if(!s)throw new Error(`[SheetsSelectionsService]: cannot resolve unit with id "${e}"!`);n=new zs(s),this._workbookSelections.set(e,n)}return n}_removeWorkbookSelection(e){this._workbookSelections.delete(e)}getCellStylesProperty(e){var a;const n=(a=this._instanceSrv.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:a.getActiveSheet(),s=this.getCurrentSelections();if(!n||s.length===0)return{isAllValuesSame:!1,value:null};let r=null;for(let c=0;c<s.length;c++){const l=s[c],{startRow:u,endRow:d,startColumn:m,endColumn:h}=l.range;for(let g=u;g<=d;g++)for(let R=m;R<=h;R++){const C=`${g}_${R}`;let f;this._cellStylesCache.has(C)?f=this._cellStylesCache.get(C):(f=n.getComposedCellStyle(g,R),this._cellStylesCache.set(C,f));const p=f[e];if(r!=null&&!i.Tools.diffValue(r,p))return{isAllValuesSame:!1,value:null};r=p}}return{isAllValuesSame:!0,value:r}}};exports.SheetsSelectionsService=nc([oc(0,i.IUniverInstanceService)],exports.SheetsSelectionsService);const sc="DISABLE_NORMAL_SELECTIONS",rc="SELECTIONS_ENABLED",qs="REF_SELECTIONS_ENABLED",vn={id:"sheet.command.clear-selection-all",type:i.CommandType.COMMAND,handler:(o,t)=>{var I;const e=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUndoRedoService),a=o.get(exports.SheetInterceptorService),c=e.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!c)return!1;const l=(t==null?void 0:t.unitId)||c.getUnitId(),u=c.getActiveSheet();if(!u)return!1;const d=(t==null?void 0:t.subUnitId)||u.getSheetId(),m=(t==null?void 0:t.ranges)||((I=s.getCurrentSelections())==null?void 0:I.map(v=>v.range));if(!(m!=null&&m.length))return!1;const h=jt(m,o,l,d),g=[],R=[],C={subUnitId:d,unitId:l,cellValue:Qn(h)},f=me(o,C);g.push({id:B.id,params:C}),R.push({id:B.id,params:f});const p=a.onCommandExecute({id:vn.id});return g.push(...p.redos),R.unshift(...p.undos),i.sequenceExecute(g,n)?(r.pushUndoRedo({unitID:l,undoMutations:R,redoMutations:g}),!0):!1}},wn={id:"sheet.command.clear-selection-format",type:i.CommandType.COMMAND,handler:(o,t)=>{var I;const e=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUndoRedoService),a=o.get(exports.SheetInterceptorService),c=e.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!c)return!1;const l=(t==null?void 0:t.unitId)||c.getUnitId(),u=c.getActiveSheet();if(!u)return!1;const d=(t==null?void 0:t.subUnitId)||u.getSheetId(),m=(t==null?void 0:t.ranges)||((I=s.getCurrentSelections())==null?void 0:I.map(v=>v.range));if(!(m!=null&&m.length))return!1;const h=jt(m,o,l,d),g=[],R=[],C={subUnitId:d,unitId:l,cellValue:Za(h)},f=me(o,C);g.push({id:B.id,params:C}),R.push({id:B.id,params:f});const p=a.onCommandExecute({id:wn.id});return g.push(...p.redos),R.unshift(...p.undos),i.sequenceExecute(g,n)?(r.pushUndoRedo({unitID:l,undoMutations:R,redoMutations:g}),!0):!1}};function Gt(o,t,e=!0){const n=t.getMatrixWithMergedCells(...i.selectionToArray(o)),s=[];if(n.forValue((a,c,l)=>{if(l.colSpan!==void 0&&l.rowSpan!==void 0){const u={startRow:a,startColumn:c,endRow:a+l.rowSpan-1,endColumn:c+l.colSpan-1};i.Rectangle.contains(o,u)||s.push(u)}}),s.length===0)return o;const r=i.Rectangle.union(o,...s);return e?Gt(r,t,e):r}function ic(o,t,e){let n=null;return e.getMatrixWithMergedCells(o,t,o,t).forValue((r,a,c)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:c.rowSpan!==void 0||c.colSpan!==void 0,isMergedMainCell:c.rowSpan!==void 0&&c.colSpan!==void 0,endRow:r+(c.rowSpan!==void 0?c.rowSpan-1:0),endColumn:a+(c.colSpan!==void 0?c.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:t,actualRow:o,startRow:o,startColumn:t,endRow:o,endColumn:t,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}function ac(o,t,e){const{startRow:n,startColumn:s,endRow:r,endColumn:a}=o;return Number.isNaN(n)&&(o.startRow=0),Number.isNaN(r)&&(o.endRow=t-1),Number.isNaN(s)&&(o.startColumn=0),Number.isNaN(a)&&(o.endColumn=e-1),o}function oe(o,t){const e=Number.isNaN(o.startRow)?0:o.startRow,n=Number.isNaN(o.startColumn)?0:o.startColumn,s=t.getMergedCell(e,n);return s?{...s,actualRow:e,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!0,isMergedMainCell:!0}:{startRow:e,startColumn:n,endRow:o.startRow,endColumn:o.startColumn,actualRow:e,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!1,isMergedMainCell:!1}}const Ne=(o,t,e)=>({id:G.id,params:{unitId:t.getUnitId(),subUnitId:e.getSheetId(),reveal:!0,selections:[{range:o,primary:oe(o,e)}]}});function cc(o){if(!o)return!1;const{range:t,primary:e}=o;return i.Rectangle.equals(t,e)}function lc(o){function t(e,n){function s(r){for(let a=r.startRow;a<=r.endRow;a++)if(!o.getRowFiltered(a))for(let c=r.startColumn;c<=r.endColumn;c++)n(a,c,r)}s(e)}return{forOperableEach:t}}const is=o=>o.id!==Is;function Ve(o,t,e,n,s,r,a){const c={};for(let l=t;l<=e;l++)for(let u=n;u<=s;u++){const d=r?o.getCellWithFilteredInterceptors(a,u,ts,is):o.getCellWithFilteredInterceptors(l,a,ts,is);!d||!d.s||(c[l]||(c[l]={}),c[l][u]={s:d.s})}return c}var uc=Object.getOwnPropertyDescriptor,dc=(o,t,e,n)=>{for(var s=n>1?void 0:n?uc(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},mc=(o,t)=>(e,n)=>t(e,n,o);const Ys=i.createIdentifier("sheets-formula.ref-selections.service");exports.RefSelectionsService=class extends exports.SheetsSelectionsService{constructor(t){super(t)}_init(){const t=this._getAliveWorkbooks$().pipe(O.takeUntil(this.dispose$));this.selectionMoveStart$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionMoveStart$)))),this.selectionMoving$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionMoving$)))),this.selectionMoveEnd$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionMoveEnd$)))),this.selectionSet$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionSet$))))}dispose(){super.dispose(),this.selectionMoveStart$=O.of(null),this.selectionMoving$=O.of(null),this.selectionMoveEnd$=O.of(null),this.selectionSet$=O.of(null),delete this._instanceSrv,this._workbookSelections.clear()}_getAliveWorkbooks$(){const t=this._instanceSrv.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET);t.forEach(n=>this._ensureWorkbookSelection(n.getUnitId()));const e=new O.BehaviorSubject(t);return this.disposeWithMe(this._instanceSrv.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._ensureWorkbookSelection(n.getUnitId()),e.next([...e.getValue(),n])})),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId()),e.next(e.getValue().filter(s=>s!==n))})),e.pipe(O.map(n=>n.map(s=>this._ensureWorkbookSelection(s.getUnitId()))))}};exports.RefSelectionsService=dc([mc(0,i.IUniverInstanceService)],exports.RefSelectionsService);function Ks(o,t){const n=o.get(i.IContextService).getContextValue(qs);return o.get(n&&!t?Ys:exports.SheetsSelectionsService)}const G={id:"sheet.operation.set-selections",type:i.CommandType.OPERATION,handler:(o,t)=>{if(!t)return!1;const{selections:e,type:n,unitId:s,subUnitId:r}=t;return Ks(o).setSelections(s,r,[...e],n),!0}},Js={id:"sheet.command.select-range",type:i.CommandType.COMMAND,handler:(o,t)=>{if(!t)return!1;const{unitId:e,subUnit:n,range:s}=t,r=o.get(i.ICommandService),a=P(o.get(i.IUniverInstanceService),t);if(!a)return!1;const c=[{range:s,primary:oe(s,a.worksheet),style:null}];return r.syncExecuteCommand(G.id,{unitId:e,subUnitId:n,selections:c})}},Xs="sheet.command.move-range",qe={type:i.CommandType.COMMAND,id:Xs,handler:async(o,t)=>{var w,I;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(i.ErrorService),a=o.get(i.LocaleService),c=o.get(exports.SheetInterceptorService),l=P(s);if(!l||!await c.beforeCommandExecute({id:qe.id,params:t}))return!1;const{worksheet:d,subUnitId:m,unitId:h}=l,g=Mn(o,{unitId:h,subUnitId:m,range:t.fromRange},{subUnitId:m,range:t.toRange});if(g===null)return r.emit(a.t("sheets.info.acrossMergedCell")),!1;const R=c.onCommandExecute({id:qe.id,params:t}),C=[...(w=R.preRedos)!=null?w:[],...g.redos,...R.redos,{id:G.id,params:{unitId:h,subUnitId:m,selections:[{range:t.toRange,primary:hc(t.fromRange,t.toRange,d)}],type:ee.MOVE_END}}],f=[...(I=R.preUndos)!=null?I:[],...g.undos,...R.undos,{id:G.id,params:{unitId:h,subUnitId:m,selections:[{range:t.fromRange,primary:oe(t.fromRange,d)}],type:ee.MOVE_END}}];if(i.sequenceExecute(C,e).result){const{undos:v,redos:M}=c.generateMutationsOfAutoHeight({unitId:h,subUnitId:m,ranges:[t.fromRange,t.toRange]}),_=c.afterCommandExecute({id:qe.id,params:t});return i.sequenceExecute([..._.redos,...M],e),n.pushUndoRedo({unitID:h,undoMutations:[...f,..._.undos,...v],redoMutations:[...C,..._.redos,...M]}),!0}return!1}};function Mn(o,t,e,n=!1){const s=[],r=[],{range:a,subUnitId:c,unitId:l}=t,{range:u,subUnitId:d}=e,h=o.get(i.IUniverInstanceService).getUniverSheetInstance(l),g=h==null?void 0:h.getSheetBySheetId(d),R=h==null?void 0:h.getSheetBySheetId(c),C=g==null?void 0:g.getCellMatrix(),f=R==null?void 0:R.getCellMatrix();if(g&&R&&C&&f){const p=Gt(u,g,!1);if(!i.Rectangle.equals(u,p)&&!n)return null;const w=new i.ObjectMatrix,I=new i.ObjectMatrix,v=new i.ObjectMatrix;i.Range.foreach(a,(U,b)=>{const k=f.getValue(U,b);if(w.setValue(U,b,i.Tools.deepClone(k)),k){const A=h==null?void 0:h.getStyles().get(k.s);v.setValue(U,b,i.Tools.deepClone(A))}I.setValue(U,b,null)});const M=new i.ObjectMatrix,_=new i.ObjectMatrix;i.Range.foreach(u,(U,b)=>{M.setValue(U,b,i.Tools.deepClone(C.getValue(U,b)))}),i.Range.foreach(a,(U,b)=>{const k=i.cellToRange(U,b),A=i.Rectangle.getRelativeRange(k,a),x=i.Rectangle.getPositionRange(A,u),W=i.Tools.deepClone(v.getValue(U,b)),V=i.Tools.deepClone(w.getValue(U,b));V&&W&&(V.s=W),_.setValue(x.startRow,x.startColumn,V)});const E={fromRange:t.range,toRange:e.range,from:{value:I.getMatrix(),subUnitId:c},to:{value:_.getMatrix(),subUnitId:d},unitId:l},T={fromRange:e.range,toRange:t.range,from:{value:w.getMatrix(),subUnitId:c},to:{value:M.getMatrix(),subUnitId:d},unitId:l};s.push({id:He.id,params:E}),r.push({id:He.id,params:T})}return{redos:s,undos:r}}function hc(o,t,e){const n=o.startRow,s=o.startColumn,r=e.getMergedCell(n,s),a=oe(t,e);if(r){const c=r.endRow-r.startRow+1,l=r.endColumn-r.startColumn+1;a.endRow=a.startRow+c-1,a.endColumn=a.startColumn+l-1,a.actualRow=a.startRow,a.actualColumn=a.startColumn,a.isMerged=!1,a.isMergedMainCell=!0}return a}var an=(o=>(o[o.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",o[o.UNIVER_DOC=1]="UNIVER_DOC",o[o.UNIVER_SHEET=2]="UNIVER_SHEET",o[o.UNIVER_SLIDE=3]="UNIVER_SLIDE",o[o.UNIVER_PROJECT=4]="UNIVER_PROJECT",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o))(an||{}),y=(o=>(o[o.View=0]="View",o[o.Edit=1]="Edit",o[o.ManageCollaborator=2]="ManageCollaborator",o[o.Print=3]="Print",o[o.Duplicate=4]="Duplicate",o[o.Comment=5]="Comment",o[o.Copy=6]="Copy",o[o.Share=7]="Share",o[o.Export=8]="Export",o[o.MoveWorksheet=9]="MoveWorksheet",o[o.DeleteWorksheet=10]="DeleteWorksheet",o[o.HideWorksheet=11]="HideWorksheet",o[o.RenameWorksheet=12]="RenameWorksheet",o[o.CreateWorksheet=13]="CreateWorksheet",o[o.SetWorksheetStyle=14]="SetWorksheetStyle",o[o.EditWorksheetCell=15]="EditWorksheetCell",o[o.InsertHyperlink=16]="InsertHyperlink",o[o.Sort=17]="Sort",o[o.Filter=18]="Filter",o[o.PivotTable=19]="PivotTable",o[o.FloatImg=20]="FloatImg",o[o.History=21]="History",o[o.RwHgtClWdt=22]="RwHgtClWdt",o[o.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",o[o.ViewFilter=24]="ViewFilter",o[o.MoveSheet=25]="MoveSheet",o[o.DeleteSheet=26]="DeleteSheet",o[o.HideSheet=27]="HideSheet",o[o.CopySheet=28]="CopySheet",o[o.RenameSheet=29]="RenameSheet",o[o.CreateSheet=30]="CreateSheet",o[o.SelectProtectedCells=31]="SelectProtectedCells",o[o.SelectUnProtectedCells=32]="SelectUnProtectedCells",o[o.SetCellStyle=33]="SetCellStyle",o[o.SetCellValue=34]="SetCellValue",o[o.SetRowStyle=35]="SetRowStyle",o[o.SetColumnStyle=36]="SetColumnStyle",o[o.InsertRow=37]="InsertRow",o[o.InsertColumn=38]="InsertColumn",o[o.DeleteRow=39]="DeleteRow",o[o.DeleteColumn=40]="DeleteColumn",o[o.EditExtraObject=41]="EditExtraObject",o[o.Delete=42]="Delete",o[o.RecoverHistory=43]="RecoverHistory",o[o.ViewHistory=44]="ViewHistory",o[o.CreatePermissionObject=45]="CreatePermissionObject",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o))(y||{}),N=(o=>(o[o.Unkonwn=0]="Unkonwn",o[o.Workbook=1]="Workbook",o[o.Worksheet=2]="Worksheet",o[o.SelectRange=3]="SelectRange",o[o.Document=4]="Document",o[o.Slide=5]="Slide",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o))(N||{});class ge{constructor(t,e,n){S(this,"type",N.SelectRange);S(this,"subType",y.Edit);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!0);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${N.SelectRange}.${y.Edit}.${n}`}}class yn{constructor(t,e,n){S(this,"type",N.SelectRange);S(this,"subType",y.View);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!0);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${N.SelectRange}.${y.View}.${n}`}}class eo{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Comment);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.Comment}_${t}`}}class to{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Copy);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.Copy}_${t}`}}class Zs{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"subType",y.CopySheet);S(this,"status",i.PermissionStatus.INIT);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.CopySheet}_${t}`}}class no{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.CreatePermissionObject);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.CreatePermissionObject}_${t}`}}class oo{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.CreateSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.CreateSheet}_${t}`}}class Qs{constructor(t){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteColumn);this.unitId=t,this.id=`${this.type}.${y.DeleteColumn}_${t}`}}class er{constructor(t){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteRow);this.unitId=t,this.id=`${this.type}.${y.DeleteRow}_${t}`}}class so{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.DeleteSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.DeleteSheet}_${t}`}}class ro{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Duplicate);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.Duplicate}_${t}`}}class ue{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Edit);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.Edit}_${t}`}}class io{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Export);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.Export}_${t}`}}class _n{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.HideSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.HideSheet}_${t}`}}class tr{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.History);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.History}_${t}`}}class nr{constructor(t){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertColumn);this.unitId=t,this.id=`${this.type}.${y.InsertColumn}_${t}`}}class or{constructor(t){S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertRow);this.unitId=t,this.id=`${this.type}.${y.InsertRow}_${t}`}}class bn{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.ManageCollaborator);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.ManageCollaborator}_${t}`}}class En{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.MoveSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.MoveSheet}_${t}`}}class ao{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Print);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.Print}_${t}`}}class co{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.RecoverHistory);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.RecoverHistory}_${t}`}}class Tn{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.RenameSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.RenameSheet}_${t}`}}class lo{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.Share);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.Share}_${t}`}}class uo{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.View);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.View}_${t}`}}class mo{constructor(t){S(this,"id");S(this,"value",!0);S(this,"type",N.Workbook);S(this,"status",i.PermissionStatus.INIT);S(this,"subType",y.ViewHistory);this.unitId=t,this.unitId=t,this.id=`${this.type}.${y.ViewHistory}_${t}`}}class ho{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Copy);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.Copy}_${t}_${e}`}}class go{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteColumn);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.DeleteColumn}_${t}_${e}`}}class Ro{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Delete);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.Delete}_${t}_${e}`}}class Co{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.DeleteRow);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.DeleteRow}_${t}_${e}`}}class Re{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Edit);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.Edit}_${t}_${e}`}}class So{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.EditExtraObject);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.EditExtraObject}_${t}_${e}`}}class fo{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Filter);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.Filter}_${t}_${e}`}}class po{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertColumn);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.InsertColumn}_${t}_${e}`}}class Io{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertHyperlink);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.InsertHyperlink}_${t}_${e}`}}class vo{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.InsertRow);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.InsertRow}_${t}_${e}`}}class wo{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.ManageCollaborator);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.ManageCollaborator}_${t}_${e}`}}class Mo{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.PivotTable);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.PivotTable}_${t}_${e}`}}class gc{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SelectProtectedCells);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.SelectProtectedCells}_${t}_${e}`}}class Rc{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SelectUnProtectedCells);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.SelectUnProtectedCells}_${t}_${e}`}}class yo{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetCellStyle);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.SetCellStyle}_${t}_${e}`}}class xt{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetCellValue);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.SetCellValue}_${t}_${e}`}}class mt{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetColumnStyle);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.SetColumnStyle}_${t}_${e}`}}class ht{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.SetRowStyle);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.SetRowStyle}_${t}_${e}`}}class _o{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.Sort);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.Sort}_${t}_${e}`}}class zt{constructor(t,e){S(this,"value",!0);S(this,"type",N.Worksheet);S(this,"status",i.PermissionStatus.INIT);S(this,"id");S(this,"subType",y.View);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${y.View}_${t}_${e}`}}const Et={id:"sheet.command.set-range-values",type:i.CommandType.COMMAND,handler:(o,t)=>{var A;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=o.get(i.IPermissionService),l=P(s,t);if(!l)return!1;const{subUnitId:u,unitId:d,workbook:m,worksheet:h}=l,{value:g,range:R,redoUndoId:C}=t,f=R?[R]:(A=r.getCurrentSelections())==null?void 0:A.map(x=>x.range);if(!f||!f.length||!c.getPermissionPoint(new Re(d,u).id))return!1;const p=new i.ObjectMatrix;let w;if(i.Tools.isArray(g))for(let x=0;x<f.length;x++){const{startRow:W,startColumn:V,endRow:z,endColumn:j}=f[x];for(let q=0;q<=z-W;q++)for(let te=0;te<=j-V;te++)p.setValue(q+W,te+V,g[q][te])}else if(i.isICellData(g))for(let x=0;x<f.length;x++){const{startRow:W,startColumn:V,endRow:z,endColumn:j}=f[x];for(let q=W;q<=z;q++)for(let te=V;te<=j;te++)p.setValue(q,te,g)}else w=g;const I={subUnitId:u,unitId:d,cellValue:w!=null?w:p.getMatrix()},v=me(o,I),M=i.mapObjectMatrix(I.cellValue,(x,W)=>h.getCellHeight(x,W)||void 0);if(!e.syncExecuteCommand(B.id,I))return!1;const{undos:E,redos:T}=a.onCommandExecute({id:Et.id,params:I}),{undos:U,redos:b}=a.generateMutationsOfAutoHeight({unitId:d,subUnitId:u,ranges:f,cellHeights:new i.ObjectMatrix(M)});if(i.sequenceExecute([...T,...b],e).result){const x=Ne(R!=null?R:p.getRange(),m,h);return n.pushUndoRedo({unitID:d,undoMutations:[{id:B.id,params:v},...E,...U,x],redoMutations:[{id:B.id,params:I},...T,...b,i.Tools.deepClone(x)],id:C}),!0}return!1}};function bo(o,t){const e=[],n=[],{unitId:s,subUnitId:r,range:a,shiftDimension:c,cellValue:l={}}=t,u=o.get(i.IUniverInstanceService),d=o.get(exports.SheetInterceptorService),m=u.getUniverSheetInstance(s),h=m==null?void 0:m.getSheetBySheetId(r);if(h){const g=h.getCellMatrix(),R=g.getDataRange();if(a.startColumn<=R.endColumn||a.startRow<=R.endRow){let I,v;if(c===i.Dimension.COLUMNS){const _=Math.min(a.endRow,R.endRow);let E=0;for(let U=a.startRow;U<=_;U++){const b=g.getRow(U),k=b?i.getArrayLength(b)-1:0;E=Math.max(E,k)}I={startRow:a.startRow,startColumn:a.startColumn,endRow:_,endColumn:E};const T=a.endColumn-a.startColumn+1;v={startRow:a.startRow,startColumn:I.startColumn+T,endRow:_,endColumn:I.endColumn+T}}else{const _=Math.min(a.endColumn,R.endColumn),E=R.endRow;I={startRow:a.startRow,startColumn:a.startColumn,endRow:E,endColumn:_};const T=a.endRow-a.startRow+1;v={startRow:I.startRow+T,startColumn:a.startColumn,endRow:I.endRow+T,endColumn:_}}const M=Mn(o,{unitId:s,subUnitId:r,range:I},{subUnitId:r,range:v},!0);M&&(e.push(...M.redos),n.push(...M.undos))}if(Object.entries(l).length===0)for(let I=a.startRow;I<=a.endRow;I++){l[I]||(l[I]={});for(let v=a.startColumn;v<=a.endColumn;v++)l[I][v]=null}const C={subUnitId:r,unitId:s,cellValue:l},f=me(o,C),{undos:p,redos:w}=d.onCommandExecute({id:Et.id,params:{...C,range:a}});e.push({id:B.id,params:C},...w),n.push({id:B.id,params:f},...p)}return{redo:e,undo:n}}function Eo(o,t){const e=[],n=[],{unitId:s,subUnitId:r,range:a,shiftDimension:c}=t,l=o.get(i.IUniverInstanceService),u=o.get(exports.SheetInterceptorService),d=l.getUniverSheetInstance(s),m=d==null?void 0:d.getSheetBySheetId(r);if(m){const h=m.getCellMatrix(),g=h.getDataRange(),R={subUnitId:r,unitId:s,cellValue:Qn([a])},C=me(o,R),f=u.onCommandExecute({id:Et.id,params:R});if(e.push({id:B.id,params:R},...f.redos),n.push(...f.undos,{id:B.id,params:C}),a.startColumn<=g.endColumn||a.startRow<=g.endRow){let p=null,w=null;if(c===i.Dimension.COLUMNS&&a.endColumn<g.endColumn){const I=Math.min(a.endRow,g.endRow);let v=0;for(let _=a.startRow;_<=I;_++){const E=h.getRow(_),T=E?i.getArrayLength(E)-1:0;v=Math.max(v,T)}p={startRow:a.startRow,startColumn:a.endColumn+1,endRow:I,endColumn:v};const M=a.endColumn-a.startColumn+1;w={startRow:a.startRow,startColumn:p.startColumn-M,endRow:I,endColumn:p.endColumn-M}}if(c===i.Dimension.ROWS&&a.endRow<g.endRow){const I=Math.min(a.endColumn,g.endColumn),v=g.endRow;p={startRow:a.endRow+1,startColumn:a.startColumn,endRow:v,endColumn:I};const M=a.endRow-a.startRow+1;w={startRow:p.startRow-M,startColumn:a.startColumn,endRow:p.endRow-M,endColumn:I}}if(p&&w){const I=Mn(o,{unitId:s,subUnitId:r,range:p},{subUnitId:r,range:w},!0);I&&(e.push(...I.redos),n.push(...I.undos))}}}return{redo:e,undo:n}}function Cc(o,t,e,n,s,r){const{startRow:a,endRow:c,startColumn:l,endColumn:u}=t;if(s===i.Dimension.ROWS){const d=c-a+1;for(let m=e;m>=a;m--)for(let h=l;h<=u;h++){const g=o.getValue(m,h);g==null?o.realDeleteValue(m+d,h):o.setValue(m+d,h,g)}for(let m=c;m>=a;m--)for(let h=l;h<=u;h++)r&&r[m]&&r[m][h]?o.setValue(m,h,r[m][h]):o.realDeleteValue(m,h)}else if(s===i.Dimension.COLUMNS){const d=u-l+1;for(let m=a;m<=c;m++)for(let h=n;h>=l;h--){const g=o.getValue(m,h);g==null?o.realDeleteValue(m,h+d):o.setValue(m,h+d,g)}for(let m=a;m<=c;m++)for(let h=u;h>=l;h--)r&&r[m]&&r[m][h]?o.setValue(m,h,r[m][h]):o.realDeleteValue(m,h)}}function Sc(o,t,e,n,s){const{startRow:r,endRow:a,startColumn:c,endColumn:l}=t,u=a-r+1,d=l-c+1;if(s===i.Dimension.ROWS)for(let m=r;m<=e;m++)for(let h=c;h<=l;h++){const g=o.getValue(m+u,h);g==null?o.realDeleteValue(m,h):o.setValue(m,h,g)}else if(s===i.Dimension.COLUMNS)for(let m=r;m<=a;m++)for(let h=c;h<=n;h++){const g=o.getValue(m,h+d);g==null?o.realDeleteValue(m,h):o.setValue(m,h,g)}}const sr="sheet.command.delete-range-move-left",je={type:i.CommandType.COMMAND,id:sr,handler:async(o,t)=>{var v,M,_;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=P(s);if(!c)return!1;const{worksheet:l,workbook:u,subUnitId:d,unitId:m}=c;let h=t==null?void 0:t.range;if(h||(h=(v=r.getCurrentLastSelection())==null?void 0:v.range),!h)return!1;const g={range:h,subUnitId:d,unitId:m,shiftDimension:i.Dimension.COLUMNS},R=a.onCommandExecute({id:je.id,params:{range:h}}),{redo:C,undo:f}=Eo(o,g),p=[...(M=R.preRedos)!=null?M:[],...C],w=[...R.undos,...f];if(p.push(...R.redos),p.push(Ne(h,u,l)),w.push(...(_=R.preUndos)!=null?_:[]),i.sequenceExecute(p,e).result){const E=a.afterCommandExecute({id:je.id,params:{range:h}});return i.sequenceExecute(E.redos,e),w.push(...E.undos),p.push(...E.redos),n.pushUndoRedo({unitID:m,undoMutations:w.reverse(),redoMutations:p}),!0}return!1}},rr="sheet.command.delete-range-move-up",Ge={type:i.CommandType.COMMAND,id:rr,handler:async(o,t)=>{var v,M,_;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=P(s);if(!c)return!1;const{unitId:l,subUnitId:u,workbook:d,worksheet:m}=c;let h=t==null?void 0:t.range;if(h||(h=(v=r.getCurrentLastSelection())==null?void 0:v.range),!h)return!1;const g={range:h,subUnitId:u,unitId:l,shiftDimension:i.Dimension.ROWS},R=a.onCommandExecute({id:Ge.id,params:{range:h}}),{redo:C,undo:f}=Eo(o,g),p=[...(M=R.preRedos)!=null?M:[],...C],w=[...R.undos,...f];if(p.push(...R.redos),p.push(Ne(h,d,m)),w.push(...(_=R.preUndos)!=null?_:[]),i.sequenceExecute(p,e).result){const E=a.afterCommandExecute({id:Ge.id,params:{range:h}});return i.sequenceExecute(E.redos,e),w.push(...E.undos),p.push(...E.redos),n.pushUndoRedo({unitID:l,undoMutations:w.reverse(),redoMutations:p}),!0}return!1}},fc="sheet.command.insert-range-move-down",Xe={type:i.CommandType.COMMAND,id:"sheet.command.insert-range-move-down",handler:async(o,t)=>{var A,x,W;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=o.get(i.ErrorService),l=o.get(i.LocaleService);if(r.isOverlapping())return c.emit(l.t("sheets.info.overlappingSelections")),!1;const u=P(s);if(!u)return!1;const{unitId:d,subUnitId:m,worksheet:h,workbook:g}=u;let R=t==null?void 0:t.range;if(R||(R=(A=r.getCurrentLastSelection())==null?void 0:A.range),!R)return!1;const C=[],f=[],p=h.getCellMatrix(),w=p.getDataRange(),v=p.getSlice(w.startRow,w.endRow,R.startColumn,R.endColumn).getDataRange().endRow,M=Math.max(v+(R.endRow-R.startRow+1)-w.endRow,0);if(M>0){const V=R.startRow-1,z=h.getRowHeight(V),j={unitId:d,subUnitId:m,range:{startRow:w.endRow+1,endRow:w.endRow+M,startColumn:w.startColumn,endColumn:w.endColumn},rowInfo:new Array(M).fill(void 0).map(()=>({h:z,hd:i.BooleanNumber.FALSE}))};C.push({id:ae.id,params:j});const q=pn(o,j);f.push({id:le.id,params:q})}const _={};i.Range.foreach(R,(V,z)=>{const j=h.getCell(V,z);j&&(_[V]||(_[V]={}),_[V][z]={s:j.s})});const E={range:R,subUnitId:m,unitId:d,shiftDimension:i.Dimension.ROWS,cellValue:_},{redo:T,undo:U}=bo(o,E);C.push(...T),f.push(...U);const b=a.onCommandExecute({id:Xe.id,params:{range:R}});if(C.push(...b.redos),C.push(Ne(R,g,h)),f.push(...(x=b.preUndos)!=null?x:[]),C.unshift(...(W=b.preRedos)!=null?W:[]),f.unshift(...b.undos),i.sequenceExecute(C,e)){const V=a.afterCommandExecute({id:Xe.id,params:{range:R}});return i.sequenceExecute(V.redos,e),f.push(...V.undos),C.push(...V.redos),n.pushUndoRedo({unitID:d,undoMutations:f.reverse(),redoMutations:C}),!0}return!1}},To="sheet.command.insert-range-move-right",ft={type:i.CommandType.COMMAND,id:To,handler:async(o,t)=>{var A,x,W;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(exports.SheetInterceptorService),c=o.get(i.ErrorService),l=o.get(i.LocaleService);if(r.isOverlapping())return c.emit(l.t("sheets.info.overlappingSelections")),!1;const u=P(s);if(!u)return!1;const{workbook:d,worksheet:m,unitId:h,subUnitId:g}=u;let R=t==null?void 0:t.range;if(R||(R=(A=r.getCurrentLastSelection())==null?void 0:A.range),!R)return!1;const C=[],f=[],p=m.getCellMatrix(),w=p.getDataRange(),v=p.getSlice(R.startRow,R.endRow,w.startColumn,w.endColumn).getDataRange().endColumn,M=Math.max(v+(R.endColumn-R.startColumn+1)-w.endColumn,0);if(M>0){const V=R.startColumn-1,z=m.getColumnWidth(V),j={unitId:h,subUnitId:g,range:{startRow:w.startRow+1,endRow:w.endRow,startColumn:w.endColumn+1,endColumn:w.endColumn+M},colInfo:new Array(M).fill(void 0).map(()=>({w:z,hd:i.BooleanNumber.FALSE}))};C.push({id:ce.id,params:j});const q=Ht(o,j);f.push({id:ne.id,params:q})}const _={};i.Range.foreach(R,(V,z)=>{const j=m.getCell(V,z);!j||!j.s||(_[V]||(_[V]={}),_[V][z]={s:j.s})});const E={range:R,subUnitId:g,unitId:h,shiftDimension:i.Dimension.COLUMNS,cellValue:_},{redo:T,undo:U}=bo(o,E);C.push(...T),f.push(...U);const b=a.onCommandExecute({id:ft.id,params:{range:R}});if(C.push(...b.redos),C.push(Ne(R,d,m)),f.push(...(x=b.preUndos)!=null?x:[]),C.unshift(...(W=b.preRedos)!=null?W:[]),f.unshift(...b.undos),i.sequenceExecute(C,e).result){const V=a.afterCommandExecute({id:ft.id,params:{range:R}});return i.sequenceExecute(V.redos,e),f.push(...V.undos),C.push(...V.redos),n.pushUndoRedo({unitID:h,undoMutations:f.reverse(),redoMutations:C}),!0}return!1}},ir="sheet.command.insert-row",Me={type:i.CommandType.COMMAND,id:ir,handler:async(o,t)=>{const e=o.get(i.ICommandService),n=o.get(exports.SheetInterceptorService),{range:s,direction:r,unitId:a,subUnitId:c,cellValue:l}=t;return await n.beforeCommandExecute({id:Me.id,params:t})?e.syncExecuteCommand(Uo.id,{range:s,direction:r,unitId:a,subUnitId:c,cellValue:l}):!1}},Uo={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-by-range",handler:(o,t)=>{var T,U,b,k;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),a=P(s,t);if(!a)return!1;const{workbook:c,worksheet:l}=a,{range:u,direction:d,unitId:m,subUnitId:h,cellValue:g}=t,{startRow:R,endRow:C}=u;u.rangeType=i.RANGE_TYPE.ROW;const f=d===i.Direction.UP?R:R-1,p=l.getRowHeight(f),w={unitId:m,subUnitId:h,range:u,rowInfo:new Array(C-R+1).fill(void 0).map(()=>({h:p,hd:i.BooleanNumber.FALSE}))},I=pn(o,w),v=[{id:ae.id,params:w}],M=[{id:le.id,params:I}];g&&Object.keys(g).length>0&&v.push({id:B.id,params:{unitId:m,subUnitId:h,cellValue:g}});const _=r.onCommandExecute({id:Me.id,params:t});if(v.unshift(...(T=_.preRedos)!=null?T:[]),v.push(...(U=_.redos)!=null?U:[]),v.push(Ne(u,c,l)),M.unshift(...(b=_.preUndos)!=null?b:[]),M.push(...(k=_.undos)!=null?k:[]),i.sequenceExecute(v,e).result){const A=r.afterCommandExecute({id:Me.id,params:t});return i.sequenceExecute(A.redos,e),v.push(...A.redos),M.push(...A.undos),n.pushUndoRedo({unitID:t.unitId,undoMutations:M,redoMutations:v}),!0}return!1}},ar={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-before",handler:async(o,t)=>{var f;const n=(f=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:f.map(p=>p.range);let s;if((n==null?void 0:n.length)===1)s=n[0];else return!1;const r=o.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:c,subUnitId:l,unitId:u}=a,d=t.value||0,m=s.startRow,h=s.startRow+d-1,g=0,R=c.getColumnCount()-1,C={unitId:u,subUnitId:l,direction:i.Direction.UP,range:{startRow:m,endRow:h,startColumn:g,endColumn:R},cellValue:Ve(c,m,h,g,R,!0,m-1)};return o.get(i.ICommandService).executeCommand(Me.id,C)}},cr={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-after",handler:async o=>{var C;const e=(C=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:C.map(f=>f.range);let n;if((e==null?void 0:e.length)===1)n=e[0];else return!1;const s=o.get(i.IUniverInstanceService),r=P(s);if(!r)return!1;const{worksheet:a,unitId:c,subUnitId:l}=r,u=n.endRow-n.startRow+1,d=n.endRow+1,m=n.endRow+u,h=0,g=a.getColumnCount()-1,R={unitId:c,subUnitId:l,direction:i.Direction.DOWN,range:{startRow:d,endRow:m,startColumn:h,endColumn:g,rangeType:i.RANGE_TYPE.ROW},cellValue:Ve(a,d,m,h,g,!0,n.endRow)};return o.get(i.ICommandService).executeCommand(Me.id,R)}},lr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-above",handler:async(o,t)=>{var p;const n=(p=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:p.map(w=>w.range);let s;if((n==null?void 0:n.length)===1)s=n[0];else return!1;const r=o.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=t.value||0,m=s.startRow,h=s.startRow+d-1,g=0,R=c.getColumnCount()-1,C=Ve(c,m,h,g,R,!0,m-1),f={unitId:l,subUnitId:u,direction:i.Direction.UP,range:{startRow:m,endRow:h,startColumn:g,endColumn:R,rangeType:i.RANGE_TYPE.ROW},cellValue:C};return o.get(i.ICommandService).executeCommand(Me.id,f)}},ur={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-after",handler:async(o,t)=>{var f;const n=(f=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:f.map(p=>p.range);let s;if((n==null?void 0:n.length)===1)s=n[0];else return!1;const r=o.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=t.value||0,m=s.endRow+1,h=s.endRow+d,g=0,R=c.getColumnCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.DOWN,range:{startRow:m,endRow:h,startColumn:g,endColumn:R,rangeType:i.RANGE_TYPE.ROW},cellValue:Ve(c,m,h,g,R,!0,s.endRow)};return o.get(i.ICommandService).executeCommand(Me.id,C)}},dr="sheet.command.insert-col",ye={type:i.CommandType.COMMAND,id:dr,handler:async(o,t)=>{const e=o.get(i.ICommandService),n=o.get(exports.SheetInterceptorService),{range:s,direction:r,subUnitId:a,unitId:c,cellValue:l}=t;return await n.beforeCommandExecute({id:ye.id,params:t})?e.syncExecuteCommand(Po.id,{range:s,direction:r,unitId:c,subUnitId:a,cellValue:l}):!1}},Po={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-by-range",handler:(o,t)=>{var E,T,U,b;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),{range:a,direction:c,subUnitId:l,unitId:u,cellValue:d}=t,{startColumn:m,endColumn:h}=t.range;a.rangeType=i.RANGE_TYPE.COLUMN;const g=s.getUniverSheetInstance(t.unitId),R=g.getSheetBySheetId(t.subUnitId),C=c===i.Direction.LEFT?m:m-1,f=R.getColumnWidth(C),p={unitId:u,subUnitId:l,range:a,colInfo:new Array(h-m+1).fill(void 0).map(()=>({w:f,hd:i.BooleanNumber.FALSE}))},w=Ht(o,p),I=[{id:ce.id,params:p}],v=[{id:ne.id,params:w}];d&&I.push({id:B.id,params:{unitId:u,subUnitId:l,cellValue:d}});const M=r.onCommandExecute({id:ye.id,params:t});if(I.unshift(...(E=M.preRedos)!=null?E:[]),I.push(...(T=M.redos)!=null?T:[]),I.push(Ne(a,g,R)),v.unshift(...(U=M.preUndos)!=null?U:[]),v.push(...(b=M.undos)!=null?b:[]),i.sequenceExecute(I,e).result){const k=r.afterCommandExecute({id:ye.id,params:t});return i.sequenceExecute(k.redos,e),I.push(...k.redos),v.push(...k.undos),n.pushUndoRedo({unitID:t.unitId,undoMutations:v.filter(Boolean),redoMutations:I.filter(Boolean)}),!0}return!1}},mr={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-before",handler:async(o,t)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();let s;if((n==null?void 0:n.length)===1)s=n[0].range;else return!1;const r=o.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=t.value||0,m=s.startColumn,h=s.startColumn+d-1,g=0,R=c.getRowCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.LEFT,range:{startColumn:m,endColumn:h,startRow:g,endRow:R,rangeType:i.RANGE_TYPE.COLUMN},cellValue:Ve(c,g,R,m,h,!1,m-1)};return o.get(i.ICommandService).executeCommand(ye.id,C)}},hr={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-after",handler:async o=>{const e=o.get(exports.SheetsSelectionsService).getCurrentSelections();let n;if((e==null?void 0:e.length)===1)n=e[0].range;else return!1;const s=o.get(i.IUniverInstanceService),r=P(s);if(!r)return!1;const{worksheet:a,unitId:c,subUnitId:l}=r,u=n.endColumn-n.startColumn+1,d=n.endColumn+1,m=n.endColumn+u,h=0,g=a.getRowCount()-1,R={unitId:c,subUnitId:l,direction:i.Direction.RIGHT,range:{startColumn:d,endColumn:m,startRow:h,endRow:g},cellValue:Ve(a,h,g,d,m,!1,n.endColumn)};return o.get(i.ICommandService).executeCommand(ye.id,R)}},gr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-before",handler:async(o,t)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();let s;if((n==null?void 0:n.length)===1)s=n[0].range;else return!1;const r=o.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=t.value||0,m=s.startColumn,h=s.startColumn+d-1,g=0,R=c.getRowCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.LEFT,range:{startColumn:m,endColumn:h,startRow:g,endRow:R,rangeType:i.RANGE_TYPE.COLUMN},cellValue:Ve(c,g,R,m,h,!1,m-1)};return o.get(i.ICommandService).executeCommand(ye.id,C)}},Rr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-right",handler:async(o,t)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();let s;if((n==null?void 0:n.length)===1)s=n[0].range;else return!1;const r=o.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,d=t.value||0,m=s.endColumn+1,h=s.endColumn+d,g=0,R=c.getRowCount()-1,C={unitId:l,subUnitId:u,direction:i.Direction.RIGHT,range:{startColumn:m,endColumn:h,startRow:g,endRow:R},cellValue:Ve(c,g,R,m,h,!1,s.endColumn)};return o.get(i.ICommandService).executeCommand(ye.id,C)}},cn="sheet.command.remove-row",ko={type:i.CommandType.COMMAND,id:"sheet.command.remove-row-by-range",handler:(o,t)=>{var f,p,w;if(!t)return!1;const e=o.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{workbook:s,worksheet:r}=n,a=o.get(exports.SheetInterceptorService),{range:c,unitId:l,subUnitId:u}=t,d=jt([c],o,l,u).reverse(),m=[],h=[];d.forEach(I=>{const v=[],M=[],_={unitId:l,subUnitId:u,range:I},E=ua(_,r),T=r.getCellMatrix().getSlice(I.startRow,I.endRow,0,r.getColumnCount()-1),U={unitId:l,subUnitId:u,cellValue:T.getMatrix()};M.push({id:le.id,params:_}),v.push({id:ae.id,params:E}),v.push({id:B.id,params:U}),h.push(...M),m.unshift(...v)});const g=a.onCommandExecute({id:cn,params:{range:c}}),R=o.get(i.ICommandService);if(i.sequenceExecute([...(f=g.preRedos)!=null?f:[],...h,...g.redos,Ne(c,s,r)],R).result){const I=a.afterCommandExecute({id:cn,params:{range:c}});return i.sequenceExecute(I.redos,R),o.get(i.IUndoRedoService).pushUndoRedo({unitID:l,undoMutations:[...(p=g.preUndos)!=null?p:[],...m,...g.undos,...I.undos],redoMutations:[...(w=g.preRedos)!=null?w:[],...h,...g.redos,...I.redos]}),!0}return!1}},qt={type:i.CommandType.COMMAND,id:cn,handler:async(o,t)=>{var h;const e=o.get(exports.SheetsSelectionsService),n=o.get(exports.SheetInterceptorService),s=o.get(i.ICommandService);let r=t==null?void 0:t.range;if(r||(r=(h=e.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=o.get(i.IUniverInstanceService),c=P(a);if(!c)return!1;const{worksheet:l,subUnitId:u,unitId:d}=c;return r={...r,startColumn:0,endColumn:Math.max(l.getMaxColumns()-1,0)},await n.beforeCommandExecute({id:qt.id,params:{range:r}})?s.syncExecuteCommand(ko.id,{range:r,unitId:d,subUnitId:u}):!1}},ln="sheet.command.remove-col",No={type:i.CommandType.COMMAND,id:"sheet.command.remove-col-by-range",handler:(o,t)=>{var p,w,I;if(!t)return!1;const e=o.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{workbook:s,worksheet:r}=n,a=o.get(exports.SheetInterceptorService),{range:c,unitId:l,subUnitId:u}=t,d={unitId:l,subUnitId:u,range:c},m=da(o,d),h=r.getCellMatrix().getSlice(0,r.getRowCount()-1,c.startColumn,c.endColumn),g={unitId:l,subUnitId:u,cellValue:h.getMatrix()},R=a.onCommandExecute({id:ln,params:{range:c}}),C=o.get(i.ICommandService);if(i.sequenceExecute([...(p=R.preRedos)!=null?p:[],{id:ne.id,params:d},...R.redos,Ne(c,s,r)],C).result){const v=a.afterCommandExecute({id:ln,params:{range:c}});return i.sequenceExecute(v.redos,C),o.get(i.IUndoRedoService).pushUndoRedo({unitID:l,undoMutations:[...(w=R.preUndos)!=null?w:[],{id:ce.id,params:m},{id:B.id,params:g},...R.undos,...v.undos],redoMutations:[...(I=R.preRedos)!=null?I:[],{id:ne.id,params:d},...R.redos,...v.redos]}),!0}return!1}},Yt={type:i.CommandType.COMMAND,id:ln,handler:async(o,t)=>{var h;const e=o.get(exports.SheetsSelectionsService),n=o.get(exports.SheetInterceptorService),s=o.get(i.ICommandService);let r=t==null?void 0:t.range;if(r||(r=(h=e.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=o.get(i.IUniverInstanceService),c=P(a);if(!c)return!1;const{worksheet:l,subUnitId:u,unitId:d}=c;return r={...r,startRow:0,endRow:Math.max(l.getMaxRows()-1,0)},await n.beforeCommandExecute({id:Yt.id,params:{range:r}})?s.syncExecuteCommand(No.id,{range:r,unitId:d,subUnitId:u}):!1}},Cr=(o,t)=>{const e=o.get(i.IUniverInstanceService),{subUnitId:n,unitId:s}=t,r=_e(e,t);if(!r)throw new Error("[RemoveSheetUndoMutationFactory]: Worksheet is null error!");const{workbook:a,worksheet:c}=r,l=c.getConfig();return{index:a.getConfig().sheetOrder.findIndex(m=>m===n),sheet:l,unitId:s}},nt={id:"sheet.mutation.remove-sheet",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService),{subUnitId:n,unitId:s}=t,r=e.getUniverSheetInstance(s);return r?r.removeSheet(n):!1}};function pc(o,t){return t.getMergeData().some(e=>e.startRow<o&&o<=e.endRow)}function Ic(o,t){return t.getMergeData().some(e=>e.startColumn<o&&o<=e.endColumn)}const Sr="sheet.command.move-rows",pt={id:Sr,type:i.CommandType.COMMAND,handler:(o,t)=>{var A,x;const e=o.get(exports.SheetsSelectionsService),{fromRange:{startRow:n},toRange:{startRow:s},range:r}=t,a=r?[pr(r)]:e.getCurrentSelections(),c=a==null?void 0:a.filter(W=>W.range.rangeType===i.RANGE_TYPE.ROW&&W.range.startRow<=n&&n<=W.range.endRow);if((c==null?void 0:c.length)!==1)return!1;const l=o.get(exports.SheetInterceptorService),u=o.get(i.IUniverInstanceService),d=P(u,t);if(!d)return!1;const{workbook:m,worksheet:h}=d,g=m.getUnitId(),R=h.getSheetId(),C=o.get(i.ErrorService),f=o.get(i.LocaleService),p=c[0].range,w=c[0].primary,I=Gt(p,h,!1);if(!i.Rectangle.equals(p,I))return C.emit(f.t("sheets.info.partOfCell")),!1;if(pc(s,h))return C.emit(f.t("sheets.info.acrossMergedCell")),!1;const v={...p,startRow:s,endRow:s+p.endRow-p.startRow},M={unitId:g,subUnitId:R,sourceRange:p,targetRange:v},_=ys(o,M),E=o.get(i.ICommandService),T=l.onCommandExecute({id:pt.id,params:t}),U=[...(A=T.preRedos)!=null?A:[],{id:ve.id,params:M}],b=[...(x=T.preUndos)!=null?x:[],{id:ve.id,params:_}];if(w){const V=s-n<0,z=p.endRow-p.startRow+1,j=V?v:{...v,startRow:v.startRow-z,endRow:v.endRow-z},q={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:j,primary:oe(j,h),style:null}]},te={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:p,primary:w,style:null}]};U.push({id:G.id,params:q}),b.push({id:G.id,params:te})}if(U.push(...T.redos),b.push(...T.undos),i.sequenceExecute(U,E).result){const W=l.afterCommandExecute({id:pt.id,params:t});return i.sequenceExecute(W.redos,E),U.push(...W.redos),b.push(...W.undos),o.get(i.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:b,redoMutations:U}),!0}return!1}},fr="sheet.command.move-cols",It={id:fr,type:i.CommandType.COMMAND,handler:(o,t)=>{var A,x;const e=o.get(exports.SheetsSelectionsService),{fromRange:{startColumn:n},toRange:{startColumn:s},range:r}=t,a=r?[pr(r)]:e.getCurrentSelections(),c=a==null?void 0:a.filter(W=>W.range.rangeType===i.RANGE_TYPE.COLUMN&&W.range.startColumn<=n&&n<=W.range.endColumn);if((c==null?void 0:c.length)!==1)return!1;const l=o.get(exports.SheetInterceptorService),u=o.get(i.IUniverInstanceService),d=P(u,t);if(!d)return!1;const{workbook:m,worksheet:h}=d,g=m.getUnitId(),R=h.getSheetId(),C=o.get(i.ErrorService),f=o.get(i.LocaleService),p=c[0].range,w=c[0].primary,I=Gt(p,h,!1);if(!i.Rectangle.equals(p,I))return C.emit(f.t("sheets.info.partOfCell")),!1;if(Ic(s,h))return C.emit(f.t("sheets.info.acrossMergedCell")),!1;const v={...p,startColumn:s,endColumn:s+p.endColumn-p.startColumn},M={unitId:g,subUnitId:R,sourceRange:p,targetRange:v},_=_s(o,M),E=o.get(i.ICommandService),T=l.onCommandExecute({id:It.id,params:t}),U=[...(A=T.preRedos)!=null?A:[],{id:we.id,params:M}],b=[...(x=T.preUndos)!=null?x:[],{id:we.id,params:_}];if(w){const W=p.endColumn-p.startColumn+1,j=s-n<0?v:{...v,startColumn:v.startColumn-W,endColumn:v.endColumn-W},q={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:j,primary:oe(j,h),style:null}]},te={unitId:g,subUnitId:R,type:ee.MOVE_END,selections:[{range:p,primary:w,style:null}]};U.push({id:G.id,params:q}),b.push({id:G.id,params:te})}if(U.push(...T.redos),b.push(...T.undos),i.sequenceExecute(U,E).result){const W=l.afterCommandExecute({id:It.id,params:t});return i.sequenceExecute(W.redos,E),U.push(...W.redos),b.push(...W.undos),o.get(i.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:b,redoMutations:U}),!0}return!1}};function pr(o){return{range:o,primary:null,style:null}}var vc=Object.getOwnPropertyDescriptor,wc=(o,t,e,n)=>{for(var s=n>1?void 0:n?vc(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Mc=(o,t)=>(e,n)=>t(e,n,o);exports.SheetSkeletonService=class extends i.Disposable{constructor(e){super();S(this,"_sheetSkeletonStore",new Map);this._injector=e,this.disposeWithMe(()=>{this._sheetSkeletonStore=new Map})}getSkeleton(e,n){if(this._sheetSkeletonStore.has(e))return this._sheetSkeletonStore.get(e).get(n)}setSkeleton(e,n,s){this._sheetSkeletonStore.has(e)||this._sheetSkeletonStore.set(e,new Map),this._sheetSkeletonStore.get(e).set(n,s)}deleteSkeleton(e,n){this._sheetSkeletonStore.has(e)&&this._sheetSkeletonStore.get(e).delete(n)}};exports.SheetSkeletonService=wc([Mc(0,i.Inject(i.Injector))],exports.SheetSkeletonService);function Oo(o,t){const e=new i.ObjectMatrix;return o.map(n=>i.Range.transformRange(n,t)).forEach(n=>{i.Range.foreach(n,(s,r)=>{const a=t.getCellHeight(s,r);a&&e.setValue(s,r,a)})}),e}const yc=1e4;function Kt(o,t){if(!t)return{suitableRanges:o,remainingRanges:[]};const e=t.worksheet.getColumnCount(),n=Math.ceil(yc/e),s=[],r=[],a=t.getOffsetRelativeToRowCol(0,t.scrollY).row,c=o.map(u=>{let d;return a>=u.startRow&&a<=u.endRow?d=0:a<u.startRow?d=u.startRow-a:d=a-u.endRow,{range:u,distance:d,rowCount:u.endRow-u.startRow+1}});c.sort((u,d)=>u.distance!==d.distance?u.distance-d.distance:u.rowCount-d.rowCount);let l=0;for(const u of c)if(l+u.rowCount<=n)s.push(u.range),l+=u.rowCount;else{const d=n-l;if(d>0){const m={...u.range,endRow:u.range.startRow+d-1},h={...u.range,startRow:u.range.startRow+d};s.push(m),r.push(h),l=n}else r.push(u.range)}return{suitableRanges:s,remainingRanges:r}}const Ir="sheet.command.reorder-range",un={id:Ir,type:i.CommandType.COMMAND,handler:(o,t)=>{var I,v;const{subUnitId:e,unitId:n,range:s,order:r}=t,a=o.get(i.ICommandService),c={id:At.id,params:{unitId:n,subUnitId:e,order:r,range:s}},l={id:At.id,params:bs(c.params)},u=o.get(exports.SheetInterceptorService),d=u.onCommandExecute({id:un.id,params:t}),m=[...(I=d.preRedos)!=null?I:[],c,...d.redos],h=[...(v=d.preUndos)!=null?v:[],l,...d.undos],g=i.sequenceExecute(m,a),{suitableRanges:R,remainingRanges:C}=Kt([s],o.get(exports.SheetSkeletonService).getSkeleton(n,e)),{undos:f,redos:p}=u.generateMutationsOfAutoHeight({unitId:n,subUnitId:e,ranges:[s],autoHeightRanges:R,lazyAutoHeightRanges:C}),w=u.afterCommandExecute({id:un.id,params:t});return g.result?(i.sequenceExecute([...w.redos,...p],a),o.get(i.IUndoRedoService).pushUndoRedo({unitID:n,undoMutations:[...h,...w.undos,...f],redoMutations:[...m,...w.redos,...p]}),!0):!1}},D={MoveRangeCommandId:Xs,InsertRowCommandId:ir,InsertColCommandId:dr,RemoveColCommandId:ln,RemoveRowCommandId:cn,DeleteRangeMoveLeftCommandId:sr,DeleteRangeMoveUpCommandId:rr,InsertRangeMoveDownCommandId:fc,InsertRangeMoveRightCommandId:To,MoveColsCommandId:fr,MoveRowsCommandId:Sr,ReorderRangeCommandId:Ir};var L=(o=>(o[o.Set=0]="Set",o[o.Delete=1]="Delete",o[o.HorizontalMove=2]="HorizontalMove",o[o.VerticalMove=3]="VerticalMove",o[o.Unknown=4]="Unknown",o))(L||{});const Xt=Number.MAX_SAFE_INTEGER,Ue=o=>{const t={...o},e=Number.isNaN(t.startRow)&&Number.isNaN(t.endRow)&&!Number.isNaN(t.startColumn)&&!Number.isNaN(t.endColumn),n=Number.isNaN(t.startColumn)&&Number.isNaN(t.endColumn)&&!Number.isNaN(t.startRow)&&!Number.isNaN(t.endRow);return(t.rangeType===i.RANGE_TYPE.COLUMN||e)&&(t.startRow=0,t.endRow=Xt),(t.rangeType===i.RANGE_TYPE.ROW||n)&&(t.startColumn=0,t.endColumn=Xt),t.rangeType===i.RANGE_TYPE.ALL&&(t.startColumn=0,t.endColumn=Xt,t.startRow=0,t.endRow=Xt),t},de=o=>{let t=o.rangeType;return o.rangeType===i.RANGE_TYPE.COLUMN?t=i.RANGE_TYPE.ROW:o.rangeType===i.RANGE_TYPE.ROW&&(t=i.RANGE_TYPE.COLUMN),{startRow:o.startColumn,endRow:o.endColumn,startColumn:o.startRow,endColumn:o.endRow,rangeType:t}},Wt=(o,t,e)=>{const n={...e},s={...t},r=(C,f)=>{const p=Math.max(C.start,f.start),w=Math.min(C.end,f.end);return w<p?null:{start:p,end:w}},a=C=>C.end-C.start+1,c=(C,f)=>({start:C.start-f.start,end:C.start-f.start+C.end-C.start}),l=(C,f)=>({start:f.start+C.start,end:f.start+C.start+C.end-C.start}),u=t.start>o.start;if(u){const C=Math.min(o.end,t.start)-o.start+1;s.start-=C,s.end-=C}const d=a(o),m=d,h=r(o,n),g=h&&a(h)>=a(n);if(o.end<n.start)n.start-=d,n.end-=d;else if(h){const C=a(h);if(g){const f=c(n,o),p=l(f,s);n.start=p.start,n.end=p.end}else h.start>o.start?u?(n.end-=C+d,n.start-=d):n.end-=C:u?n.end-=C:n.start>o.start&&n.end>o.end?(n.start-=d,n.end-=d+C):n.end-=C}const R=r(s,n);return g||(s.start<=n.start?(n.start+=m,n.end+=m):R&&(u?s.end<=n.start||s.start<=n.start&&s.end>=n.start?(n.start+=m,n.end+=m):s.start>=n.start&&s.start<=n.end&&(n.end+=m):n.start<s.start&&n.end>s.start?n.end+=m:(n.start>=s.end||n.start>=s.start&&n.start<=s.end)&&(n.end+=m,n.start+=m))),{step:n.start-e.start,length:a(n)-a(e)}},Do=(o,t)=>{const{fromRange:e,toRange:n}=o.params||{};if(!n||!e)return[];const s=Ue(e),r=Ue(n),a=Ue(t),c=Wt({start:s.startRow,end:s.endRow},{start:r.startRow,end:r.endRow},{start:a.startRow,end:a.endRow});return c===null?[{type:L.Delete}]:[{type:L.VerticalMove,step:c.step||0,length:c.length||0}]},_c=(o,t)=>{const{fromRange:e,toRange:n}=o.params||{};if(!e||!n)return[t];const s=e.startRow,r=e.endRow-e.startRow+1,a=n.startRow,c=new i.ObjectMatrix;return i.Range.foreach(t,(u,d)=>{c.setValue(u,d,1)}),c.moveRows(s,r,a),i.queryObjectMatrix(c,u=>u===1)},bc=(o,t)=>{const{range:e,order:n}=o.params||{};if(!e||!n)return[t];const s=new i.ObjectMatrix;i.Range.foreach(t,(c,l)=>{s.setValue(c,l,1)});const r=new i.ObjectMatrix;return i.Range.foreach(e,(c,l)=>{var u;if(Object.prototype.hasOwnProperty.call(n,c)){const d=n[c],m=(u=s.getValue(d,l))!=null?u:0;r.setValue(c,l,m)}}),r.forValue((c,l,u)=>{s.setValue(c,l,u)}),i.queryObjectMatrix(s,c=>c===1)},Ao=(o,t)=>{const{fromRange:e,toRange:n}=o.params||{};if(!n||!e)return[];const s=Ue(e),r=Ue(n),a=Ue(t),c=Wt({start:s.startColumn,end:s.endColumn},{start:r.startColumn,end:r.endColumn},{start:a.startColumn,end:a.endColumn});return c===null?[{type:L.Delete}]:[{type:L.HorizontalMove,step:c.step||0,length:c.length||0}]},Ec=(o,t)=>{const{fromRange:e,toRange:n}=o.params||{};if(!e||!n)return[t];const s=e.startColumn,r=e.endColumn-e.startColumn+1,a=n.startColumn,c=new i.ObjectMatrix;return i.Range.foreach(t,(l,u)=>{c.setValue(l,u,1)}),c.moveColumns(s,r,a),i.queryObjectMatrix(c,l=>l===1)},vr=(o,t)=>{var r,a;const e=(r=o.params)==null?void 0:r.toRange,n=(a=o.params)==null?void 0:a.fromRange;if(!e||!n)return[];const s=[];if(i.Rectangle.contains(e,t)&&s.push({type:L.Delete}),i.Rectangle.contains(n,t)){s.push({type:L.Delete});const c=i.Rectangle.getRelativeRange(t,n),l=i.Rectangle.getPositionRange(c,e);return[{type:L.Set,range:l}]}return s},Tc=(o,t)=>{var m,h;const e=(m=o.params)==null?void 0:m.toRange,n=(h=o.params)==null?void 0:h.fromRange;if(!e||!n)return[t];if(!i.Rectangle.intersects(n,t)&&!i.Rectangle.intersects(e,t))return[t];if(i.Rectangle.contains(n,t)){const g=i.Rectangle.getRelativeRange(t,n);return[i.Rectangle.getPositionRange(g,e)]}const s=new i.ObjectMatrix;i.Range.foreach(t,(g,R)=>{s.setValue(g,R,1)});const r=new i.ObjectMatrix,a=i.Rectangle.getIntersects(n,t);a&&i.Range.foreach(a,(g,R)=>{s.getValue(g,R)&&(s.setValue(g,R,void 0),r.setValue(g,R,1))});const c=e.startColumn-n.startColumn,l=e.startRow-n.startRow,u={startColumn:e.startColumn-c,endColumn:e.endColumn-c,startRow:e.startRow-l,endRow:e.endRow-l};return u&&i.Range.foreach(u,(g,R)=>{var p;const C=g+l,f=R+c;s.setValue(C,f,(p=r.getValue(g,R))!=null?p:0)}),i.queryObjectMatrix(s,g=>g===1)},Ze=(o,t)=>{const e=Ue(o),n=Ue(t),s=a=>a.endColumn-a.startColumn+1,r=a=>a.endRow-a.startRow+1;if(e.startRow<=n.startRow&&e.endRow>=n.endRow){if(n.startColumn<e.startColumn&&n.endColumn>=e.startColumn&&n.endColumn<=e.endColumn||n.startColumn<e.startColumn&&n.endColumn>=e.endColumn){const a=i.Rectangle.getIntersects(n,e);if(a)return{step:0,length:-s(a)}}if(n.startColumn>=e.startColumn&&n.endColumn<=e.endColumn&&r(e)>=r(n))return null;if(n.startColumn>=e.startColumn&&n.startColumn<=e.endColumn&&n.endColumn>e.endColumn){const a=i.Rectangle.getIntersects(n,e);if(a){const c=-s(a);return{step:-(s(e)-s(a)),length:c}}}if(n.startColumn>e.endColumn)return{step:-s(e),length:0}}return{step:0,length:0}},xo=(o,t)=>{var r;const e=(r=o.params)==null?void 0:r.range;if(!e)return[];const n=[],s=Ze(e,t);if(!s)n.push({type:L.Delete});else{const{step:a,length:c}=s;n.push({type:L.HorizontalMove,step:a,length:c})}return n},wr=(o,t,e)=>{var a;const n=(a=o.params)==null?void 0:a.range;if(!n)return[];const s=[];if(e&&e.length>0){let c=n.startRow;for(let l=n.startRow;l<=n.endRow;l++){if(e.includes(l)){if(l===c){c=l+1;continue}r({...n,startRow:c,endRow:l-1}),c=l+1;continue}l===n.endRow&&r({...n,startRow:c,endRow:n.endRow})}}else r(n);function r(c){const l=Ze(de(c),de(t));if(!l)s.push({type:L.Delete});else{const{step:u,length:d}=l;s.push({type:L.VerticalMove,step:u,length:d})}}return s},Uc=(o,t)=>{const{range:e,order:n}=o.params||{};if(!e||!n)return[];if(i.Rectangle.contains(e,t)&&t.endRow===t.startRow){const s=[],r=t.startRow;for(const a in n)if(n[a]===r){const c=Number(a);return s.push({type:L.VerticalMove,step:c-r,length:0}),s}return[]}return[]},Qe=(o,t)=>{const e=Ue(o),n=Ue(t),s=r=>r.endColumn-r.startColumn+1;return e.startRow<=n.startRow&&e.endRow>=n.endRow?n.startColumn<e.startColumn&&n.endColumn>=e.startColumn&&n.endColumn<=e.endColumn||n.startColumn<e.startColumn&&n.endColumn>=e.endColumn?{step:0,length:s(e)}:n.startColumn>=e.startColumn&&n.endColumn<=e.endColumn||n.startColumn>=e.startColumn&&n.startColumn<=e.endColumn&&n.endColumn>e.endColumn||n.startColumn>=e.endColumn?{step:s(e),length:0}:{step:0,length:0}:{step:0,length:0}};function Pc(o,t,e){const n=[];if(i.Rectangle.contains(t,e)&&n.push({type:L.Delete}),i.Rectangle.contains(o,e)){n.push({type:L.Delete});const s=i.Rectangle.getRelativeRange(e,o),r=i.Rectangle.getPositionRange(s,t);return[{type:L.Set,range:r}]}return n}const Mr=(o,t)=>{var c;const e=(c=o.params)==null?void 0:c.range;if(!e)return[];const n=[],s=Qe(de(e),de(t)),{step:r,length:a}=s;return n.push({type:L.VerticalMove,step:r,length:a}),n},yr=(o,t)=>{var c;const e=(c=o.params)==null?void 0:c.range;if(!e)return[];const n=[],s=Qe(e,t),{step:r,length:a}=s;return n.push({type:L.HorizontalMove,step:r,length:a}),n},_r=(o,t)=>{var c;const e=(c=o.params)==null?void 0:c.range;if(!e)return[];const n=[],s=Qe(de(e),de(t)),{step:r,length:a}=s;return n.push({type:L.VerticalMove,step:r,length:a}),n},kc=(o,t)=>{var l;const e=(l=o.params)==null?void 0:l.range;if(!e)return[t];const n=e.endRow-e.startRow+1,s={...e,startRow:e.startRow,endRow:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(t,s),a=i.Rectangle.getIntersects(s,t);if(!a)return[t];const c=new i.ObjectMatrix;return r.forEach(u=>{i.Range.foreach(u,(d,m)=>{c.setValue(d,m,1)})}),a&&i.Range.foreach(a,(u,d)=>{c.setValue(u+n,d,1)}),i.queryObjectMatrix(c,u=>u===1)},br=(o,t)=>{var c;const e=(c=o.params)==null?void 0:c.range;if(!e)return[];const n=[],s=Qe(e,t),{step:r,length:a}=s;return n.push({type:L.HorizontalMove,step:r,length:a}),n},Nc=(o,t)=>{var l;const e=(l=o.params)==null?void 0:l.range;if(!e)return[t];const n=e.endColumn-e.startColumn+1,s={...e,startColumn:e.startColumn,endColumn:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(t,s),a=i.Rectangle.getIntersects(s,t);if(!a)return[t];const c=new i.ObjectMatrix;return r.forEach(u=>{i.Range.foreach(u,(d,m)=>{c.setValue(d,m,1)})}),a&&i.Range.foreach(a,(u,d)=>{c.setValue(u,d+n,1)}),i.queryObjectMatrix(c,u=>u===1)},Er=(o,t)=>{var r;const e=(r=o.params)==null?void 0:r.range;if(!e)return[];const n=[],s=Ze(e,t);if(!s)n.push({type:L.Delete});else{const{step:a,length:c}=s;n.push({type:L.HorizontalMove,step:a,length:c})}return n},Oc=(o,t)=>{var u;const e=(u=o.params)==null?void 0:u.range;if(!e)return[t];const n={startRow:e.startRow,endRow:e.endRow,startColumn:e.startColumn,endColumn:Number.POSITIVE_INFINITY},s=e.endColumn-e.startColumn+1,r=i.Rectangle.getIntersects(e,t),a=i.Rectangle.subtract(t,n),c=i.Rectangle.getIntersects(n,t);if(!r&&!c)return[t];const l=new i.ObjectMatrix;return c&&i.Range.foreach(c,(d,m)=>{l.setValue(d,m-s,1)}),r&&i.Range.foreach(r,(d,m)=>{l.setValue(d,m-s,0)}),a.forEach(d=>{i.Range.foreach(d,(m,h)=>{l.setValue(m,h,1)})}),i.queryObjectMatrix(l,d=>d===1)},Tr=(o,t)=>{var r;const e=(r=o.params)==null?void 0:r.range;if(!e)return[];const n=[],s=Ze(de(e),de(t));if(!s)n.push({type:L.Delete});else{const{step:a,length:c}=s;n.push({type:L.VerticalMove,step:a,length:c})}return n},Dc=(o,t)=>{var u;const e=(u=o.params)==null?void 0:u.range;if(!e)return[t];const n={...e,startRow:e.startRow,endRow:Number.POSITIVE_INFINITY},s=e.endRow-e.startRow+1,r=i.Rectangle.getIntersects(e,t),a=i.Rectangle.subtract(t,n),c=i.Rectangle.getIntersects(n,t);if(!r&&!c)return[t];const l=new i.ObjectMatrix;return c&&i.Range.foreach(c,(d,m)=>{l.setValue(d-s,m,1)}),r&&i.Range.foreach(r,(d,m)=>{l.setValue(d-s,m,0)}),a.forEach(d=>{i.Range.foreach(d,(m,h)=>{l.setValue(m,h,1)})}),i.queryObjectMatrix(l,d=>d===1)},Ac=(o,t)=>{var s;const e=(s=o.ranges)!=null?s:[o.range],n=new i.ObjectMatrix;return i.Range.foreach(t,(r,a)=>{n.setValue(r,a,1)}),e.forEach(r=>{const a=r.startRow,l=r.endRow-a+1;n.removeRows(a,l)}),i.queryObjectMatrix(n,r=>r===1)},xc=(o,t)=>{const e=o.params,n=e.range.startRow,s=e.range.endRow-e.range.startRow+1;return t.startRow>=n?[{startRow:t.startRow+s,endRow:t.endRow+s,startColumn:t.startColumn,endColumn:t.endColumn}]:t.endRow<n?[t]:[{startRow:t.startRow,endRow:t.endRow+s,startColumn:t.startColumn,endColumn:t.endColumn}]},Wc=(o,t)=>{const e=o.params,n=e.range.startColumn,s=e.range.endColumn-e.range.startColumn+1;return t.startColumn>=n?[{startRow:t.startRow,endRow:t.endRow,startColumn:t.startColumn+s,endColumn:t.endColumn+s}]:t.endColumn<n?[t]:[{startRow:t.startRow,endRow:t.endRow,startColumn:t.startColumn,endColumn:t.endColumn+s}]},et=(o,t)=>{let e={...t};return o.forEach(n=>{switch(n.type){case L.Delete:{e=null;break}case L.HorizontalMove:{if(!e)return;e.startColumn+=n.step,e.endColumn+=n.step+(n.length||0);break}case L.VerticalMove:{if(!e)return;e.startRow+=n.step,e.endRow+=n.step+(n.length||0);break}case L.Set:{e=n.range;break}}}),e&&(e.endColumn<e.startColumn||e.endRow<e.startRow)?null:e},jn=(o,t)=>{let e=[];switch(t.id){case D.DeleteRangeMoveLeftCommandId:{e=Er(t,o);break}case D.DeleteRangeMoveUpCommandId:{e=Tr(t,o);break}case D.InsertColCommandId:{e=yr(t,o);break}case D.InsertRangeMoveDownCommandId:{e=_r(t,o);break}case D.InsertRangeMoveRightCommandId:{e=br(t,o);break}case D.InsertRowCommandId:{e=Mr(t,o);break}case D.MoveColsCommandId:{e=Ao(t,o);break}case D.MoveRangeCommandId:{e=vr(t,o);break}case D.MoveRowsCommandId:{e=Do(t,o);break}case D.RemoveColCommandId:{e=xo(t,o);break}case D.RemoveRowCommandId:{e=wr(t,o);break}case D.ReorderRangeCommandId:{e=Uc(t,o);break}}return et(e,o)},Vc=(o,t,e)=>[je.id,Ge.id].includes(t.id)||Pr(t,e).some(r=>i.Rectangle.intersects(r,o))?jn(o,t):o,Gn=(o,t)=>{let e=[];switch(t.id){case D.DeleteRangeMoveLeftCommandId:return Oc(t,o);case D.DeleteRangeMoveUpCommandId:return Dc(t,o);case D.InsertRangeMoveDownCommandId:return kc(t,o);case D.InsertRangeMoveRightCommandId:return Nc(t,o);case D.InsertColCommandId:return Wc(t,o);case D.InsertRowCommandId:return xc(t,o);case D.MoveColsCommandId:return Ec(t,o);case D.MoveRangeCommandId:return Tc(t,o);case D.MoveRowsCommandId:return _c(t,o);case D.ReorderRangeCommandId:return bc(t,o);case D.RemoveColCommandId:{e=xo(t,o);break}case D.RemoveRowCommandId:return Ac(t.params,o)}const n=et(e,o);return n?[n]:[]},$c=(o,t,e)=>[je.id,Ge.id,Xe.id,To].includes(t.id)||Pr(t,e).some(r=>i.Rectangle.intersects(r,o))?Gn(o,t):o;function Ur(o,t){const{id:e,params:n}=t;let s={length:0,step:0,type:L.Unknown};switch(e){case nt.id:s.type=L.Delete;break;case ve.id:s=Wt({start:n.sourceRange.startRow,end:n.sourceRange.endRow},{start:n.targetRange.startRow,end:n.targetRange.endRow},{start:o.startRow,end:o.endRow}),s.type=L.VerticalMove;break;case we.id:s=Wt({start:n.sourceRange.startColumn,end:n.sourceRange.endColumn},{start:n.targetRange.startColumn,end:n.targetRange.endColumn},{start:o.startColumn,end:o.endColumn}),s.type=L.HorizontalMove;break;case ne.id:s=Ze(n.range,o),s?s.type=L.HorizontalMove:s={step:0,length:0,type:L.Delete};break;case le.id:s=Ze(de(n.range),de(o)),s?s.type=L.VerticalMove:s={step:0,length:0,type:L.Delete};break;case ae.id:s=Qe(de(n.range),de(o)),s.type=L.VerticalMove;break;case ce.id:s=Qe(n.range,o),s.type=L.HorizontalMove;break;case He.id:{const r=n.fromRange||new i.ObjectMatrix(n.from).getRange(),a=n.toRange||new i.ObjectMatrix(n.to).getRange();s=Pc(r,a,o)}break}return s?Array.isArray(s)?et(s,o):et([s],o):o}function Pr(o,t){var n,s,r,a,c,l;const{selectionManagerService:e}=t;switch(o.id){case D.MoveColsCommandId:{const u=o.params;return[u.fromRange,{...u.toRange,startColumn:u.toRange.startColumn-.5,endColumn:u.toRange.endColumn-.5}]}case D.MoveRowsCommandId:{const u=o.params;return[u.fromRange,{...u.toRange,startRow:u.toRange.startRow-.5,endRow:u.toRange.startRow-.5}]}case D.MoveRangeCommandId:{const u=o;return[u.params.fromRange,u.params.toRange]}case D.InsertRowCommandId:{const d=o.params.range;return[{...d,startRow:d.startRow-.5,endRow:d.endRow-.5}]}case D.InsertColCommandId:{const d=o.params.range;return[{...d,startColumn:d.startColumn-.5,endColumn:d.endColumn-.5}]}case D.RemoveRowCommandId:return[o.params.range];case D.RemoveColCommandId:return[o.params.range];case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const d=((n=o.params)==null?void 0:n.range)||((r=(s=e.getCurrentSelections())==null?void 0:s.map(m=>m.range))==null?void 0:r[0]);return d?[d]:[]}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const d=((a=o.params)==null?void 0:a.range)||((l=(c=e.getCurrentSelections())==null?void 0:c.map(m=>m.range))==null?void 0:l[0]);return d?[d]:[]}case D.ReorderRangeCommandId:{const u=o,{range:d,order:m}=u.params,h=[];for(let g=d.startRow;g<=d.endRow;g++)g in m&&h.push({startRow:g,endRow:g,startColumn:d.startColumn,endColumn:d.endColumn});return h}}}function Lc(o){switch(o.id){case we.id:{const t=o.params;return[t.sourceRange,{...t.targetRange,startColumn:t.targetRange.startColumn-.5,endColumn:t.targetRange.startColumn-.5}]}case ve.id:{const t=o.params;return[t.sourceRange,{...t.targetRange,startRow:t.targetRange.startRow-.5,endRow:t.targetRange.startRow-.5}]}case He.id:{const t=o.params;return[new i.ObjectMatrix(t.from.value).getRange(),new i.ObjectMatrix(t.to.value).getRange()]}case ce.id:{const e=o.params.range;return[{...e,startColumn:e.startColumn-.5,endColumn:e.startColumn-.5}]}case ae.id:{const e=o.params.range;return[{...e,startRow:e.startRow-.5,endRow:e.startRow-.5}]}case ne.id:return[o.params.range];case le.id:return[o.params.range]}}function Bc(o,t){var s,r,a,c,l,u;const e=o.get(i.IUniverInstanceService),n=o.get(exports.SheetsSelectionsService);switch(t.id){case D.MoveColsCommandId:{const d=t.params,m=P(e,{unitId:d.unitId,subUnitId:d.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[d.fromRange,{...d.toRange,startColumn:d.fromRange.startColumn<d.toRange.startColumn?d.fromRange.endColumn+1:d.toRange.startColumn,endColumn:d.fromRange.startColumn<d.toRange.startColumn?d.toRange.endColumn-1:d.fromRange.startColumn-1}]}}case D.MoveRowsCommandId:{const d=t.params,m=P(e,{unitId:d.unitId,subUnitId:d.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[d.fromRange,{...d.toRange,startRow:d.fromRange.startRow<d.toRange.startRow?d.fromRange.endRow+1:d.toRange.startRow,endRow:d.fromRange.startRow<d.toRange.startRow?d.toRange.endRow-1:d.fromRange.startRow-1}]}}case D.MoveRangeCommandId:{const d=t.params,m=P(e);return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[d.fromRange,d.toRange]}}case D.InsertRowCommandId:{const d=t.params,m=d.range;return{unitId:d.unitId,subUnitId:d.subUnitId,ranges:[...m.startRow>0?[{...m,startRow:m.startRow-1,endRow:m.endRow-1}]:[],{...m,startRow:m.startRow,endRow:Number.MAX_SAFE_INTEGER}]}}case D.InsertColCommandId:{const d=t.params,m=d.range;return{unitId:d.unitId,subUnitId:d.subUnitId,ranges:[...m.startColumn>0?[{...m,startColumn:m.startColumn-1,endColumn:m.endColumn-1}]:[],{...m,startColumn:m.startColumn,endColumn:Number.MAX_SAFE_INTEGER}]}}case D.RemoveRowCommandId:{const m=t.params.range,h=P(e);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startRow:m.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}}case D.RemoveColCommandId:{const m=t.params.range,h=P(e);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}}case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const d=t,m=P(e),h=((s=d.params)==null?void 0:s.range)||((a=(r=n.getCurrentSelections())==null?void 0:r.map(g=>g.range))==null?void 0:a[0]);return h?{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[h,{...h,startRow:h.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}:{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[]}}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const m=((c=t.params)==null?void 0:c.range)||((u=(l=n.getCurrentSelections())==null?void 0:l.map(g=>g.range))==null?void 0:u[0]),h=P(e);return m?{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}:{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[]}}case D.ReorderRangeCommandId:{const d=t,{range:m,order:h}=d.params,g=[];for(let C=m.startRow;C<=m.endRow;C++)C in h&&g.push({startRow:C,endRow:C,startColumn:m.startColumn,endColumn:m.endColumn});const R=P(e);return{unitId:R.unitId,subUnitId:R.subUnitId,ranges:g}}}}var Fc=Object.getOwnPropertyDescriptor,Hc=(o,t,e,n)=>{for(var s=n>1?void 0:n?Fc(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Zt=(o,t)=>(e,n)=>t(e,n,o);const jc=i.createInterceptorKey("MERGE_REDO"),Gc=i.createInterceptorKey("MERGE_UNDO"),as=Math.floor(Number.MAX_SAFE_INTEGER/10);class zc extends i.Disposable{constructor(t,e,n,s,r=!1){super(),this._unitId=t,this._subUnitId=e,this._range=n,this._callback=s,this._skipIntersects=r}onMutation(t){var s,r;if(((s=t.params)==null?void 0:s.unitId)!==this._unitId)return;if(t.id===He.id){const a=t.params;if(a.from.subUnitId!==this._subUnitId||a.to.subUnitId!==this._subUnitId)return}else if(((r=t.params)==null?void 0:r.subUnitId)!==this._subUnitId)return;if(!this._range)return;if(this._skipIntersects){if(t.id===nt.id)return;const a=Lc(t);if(a!=null&&a.some(c=>i.Rectangle.intersects(c,this._range)))return}const e=Ur(this._range,t);if(e&&i.Rectangle.equals(e,this._range))return!1;const n=this._range;this._range=e,this._callback(n,e)}}exports.RefRangeService=class extends i.Disposable{constructor(e,n,s,r){super();S(this,"interceptor",new i.InterceptorManager({MERGE_REDO:jc,MERGE_UNDO:Gc}));S(this,"_watchRanges",new Set);S(this,"_refRangeManagerMap",new Map);S(this,"_serializer",qc());S(this,"_onRefRangeChange",()=>{this._sheetInterceptorService.interceptCommand({getMutations:e=>{const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet(),s=cs(this._univerInstanceService),r=ls(this._univerInstanceService);if(!n||!s||!r)return{redos:[],undos:[],preRedos:[],preUndos:[]};const l=((()=>{switch(e.id){case D.MoveColsCommandId:{const g=e.params,R=Math.min(g.fromRange.startColumn,g.toRange.startColumn);return this._checkRange([{...g.fromRange,startColumn:R,endColumn:n.getColumnCount()-1}],s,r)}case D.MoveRowsCommandId:{const g=e.params,R=Math.min(g.fromRange.startRow,g.toRange.startRow);return this._checkRange([{...g.fromRange,startRow:R,endRow:n.getRowCount()-1}],s,r)}case D.MoveRangeCommandId:{const g=e;return this._checkRange([g.params.fromRange,g.params.toRange],s,r)}case D.InsertRowCommandId:{const C={startRow:e.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([C],s,r)}case D.InsertColCommandId:{const R=e.params.range.startColumn,C={startRow:0,endRow:n.getRowCount()-1,startColumn:R,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([C],s,r)}case D.RemoveRowCommandId:{const C={startRow:e.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([C],s,r)}case D.RemoveColCommandId:{const R=e.params.range.startColumn,C={startRow:0,endRow:n.getRowCount()-1,startColumn:R,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([C],s,r)}case D.DeleteRangeMoveUpCommandId:case D.InsertRangeMoveDownCommandId:{const R=e.params.range||us(this._selectionManagerService)[0],C={startRow:R.startRow,startColumn:R.startColumn,endColumn:R.endColumn,endRow:as};return this._checkRange([C],s,r)}case D.DeleteRangeMoveLeftCommandId:case D.InsertRangeMoveRightCommandId:{const R=e.params.range||us(this._selectionManagerService)[0],C={startRow:R.startRow,startColumn:R.startColumn,endColumn:as,endRow:R.endRow};return this._checkRange([C],s,r)}case D.ReorderRangeCommandId:{const g=e,{range:R,order:C}=g.params,f=[];for(let p=R.startRow;p<=R.endRow;p++)p in C&&f.push({startRow:p,endRow:p,startColumn:R.startColumn,endColumn:R.endColumn});return this._checkRange(f,s,r)}}})()||[]).reduce((g,R)=>{const C=R(e);return g.push(C),g},[]).reduce((g,R)=>{var C,f;return g.redos.push(...R.redos),g.undos.push(...R.undos),g.preRedos.push(...(C=R.preRedos)!=null?C:[]),g.preUndos.push(...(f=R.preUndos)!=null?f:[]),g},{redos:[],undos:[],preUndos:[],preRedos:[]}),u=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(l.preRedos,null)||[],d=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(l.redos,null)||[],m=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(l.preUndos,null)||[],h=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(l.undos,null)||[];return{redos:d,undos:h,preRedos:u,preUndos:m}}})});S(this,"_checkRange",(e,n,s)=>{const r=ds(n,s),a=this._refRangeManagerMap.get(r);if(a){const c=new Set;return[...a.keys()].forEach(u=>{const d=a.get(u),m=this._serializer.deserialize(u),h={...m,startRow:+m.startRow,endRow:+m.endRow,startColumn:+m.startColumn,endColumn:+m.endColumn,rangeType:m.rangeType&&+m.rangeType};e.some(g=>i.Rectangle.intersects(g,h))&&d&&d.forEach(g=>{c.add(g)})}),[...c]}return[]});S(this,"registerRefRange",(e,n,s,r)=>{const a=s||cs(this._univerInstanceService),c=r||ls(this._univerInstanceService);if(!a||!c)return i.toDisposable(()=>{});const l=ds(a,c),u=this._serializer.serialize(e);let d=this._refRangeManagerMap.get(l);d||(d=new Map,this._refRangeManagerMap.set(l,d));const m=d.get(u);return m?m.add(n):d.set(u,new Set([n])),i.toDisposable(()=>{const h=d.get(u);h&&(h.delete(n),h.size||(d.delete(u),d.size||this._refRangeManagerMap.delete(l)))})});this._commandService=e,this._sheetInterceptorService=n,this._univerInstanceService=s,this._selectionManagerService=r,this._onRefRangeChange(),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_REDO,{priority:-1,handler:a=>a}),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_UNDO,{priority:-1,handler:a=>a})}watchRange(e,n,s,r,a){let c;this._watchRanges.size===0&&(c=this._commandService.onCommandExecuted(m=>{if(m.type!==i.CommandType.MUTATION)return!1;for(const h of this._watchRanges)h.onMutation(m)}));const l=new zc(e,n,s,r,a);this._watchRanges.add(l);const u=i.toDisposable(()=>{this._watchRanges.delete(l),this._watchRanges.size===0&&(c==null||c.dispose(),c=null)}),d=this.disposeWithMe(u);return i.toDisposable(()=>{d.dispose(),u.dispose()})}};exports.RefRangeService=Hc([Zt(0,i.ICommandService),Zt(1,i.Inject(exports.SheetInterceptorService)),Zt(2,i.Inject(i.IUniverInstanceService)),Zt(3,i.Inject(exports.SheetsSelectionsService))],exports.RefRangeService);function cs(o){return o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId()}function ls(o){var t;return(t=o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet())==null?void 0:t.getSheetId()}function us(o){var t;return((t=o.getCurrentSelections())==null?void 0:t.map(e=>e.range))||[]}function ds(o,t){return`${o}_${t}`}function qc(){const o=["startRow","startColumn","endRow","endColumn","rangeType"];return{deserialize:e=>{const n=o.reduce((r,a,c)=>(r[String(c)]=a,r),{});return e.split("_").reduce((r,a,c)=>{const l=String(c);return a&&n[l]&&(r[n[l]]=a),r},{})},serialize:e=>o.reduce((n,s,r)=>{const a=e[s];return a!==void 0?`${n}${r>0?"_":""}${a}`:`${n}`},"")}}var Yc=Object.getOwnPropertyDescriptor,Kc=(o,t,e,n)=>{for(var s=n>1?void 0:n?Yc(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},st=(o,t)=>(e,n)=>t(e,n,o);const Jc=[ce.id,ae.id,ne.id,le.id],Xc=[ve.id,we.id];function Wo(o,t){let e=o;if(t!==void 0){const n=[];for(let s=0;s<e.length;s++){const{startRow:r,endRow:a,startColumn:c,endColumn:l}=e[s];if(t===i.Dimension.ROWS)for(let u=r;u<=a;u++){const d={startRow:u,endRow:u,startColumn:c,endColumn:l};n.push(d)}else if(t===i.Dimension.COLUMNS)for(let u=c;u<=l;u++){const d={startRow:r,endRow:a,startColumn:u,endColumn:u};n.push(d)}}e=n}return e}const kr=i.createInterceptorKey("mergeCellPermissionCheck");exports.MergeCellController=class extends i.Disposable{constructor(e,n,s,r,a,c){super();S(this,"disposableCollection",new i.DisposableCollection);S(this,"interceptor",new i.InterceptorManager({MERGE_CELL_INTERCEPTOR_CHECK:kr}));this._commandService=e,this._refRangeService=n,this._univerInstanceService=s,this._injector=r,this._sheetInterceptorService=a,this._selectionManagerService=c,this._onRefRangeChange(),this._initCommandInterceptor(),this._commandExecutedListener()}_initCommandInterceptor(){const e=this;this._sheetInterceptorService.interceptCommand({getMutations(n){var s;switch(n.id){case vn.id:case wn.id:{const r=e._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=r.getUnitId(),c=r==null?void 0:r.getActiveSheet();if(!c)return{redos:[],undos:[]};const l=c.getSheetId(),u=c.getConfig().mergeData,d=(s=e._selectionManagerService.getCurrentSelections())==null?void 0:s.map(m=>m.range);if(d&&d.length>0&&d.some(h=>u.some(g=>i.Rectangle.intersects(g,h)))){const h={unitId:a,subUnitId:l,ranges:d},g=se(e._injector,h),R=[{id:H.id,params:h}],C=[{id:F.id,params:g}];return{redos:R,undos:C}}}}return{redos:[],undos:[]}}}),this._sheetInterceptorService.interceptRanges({getMutations:({unitId:n,subUnitId:s,ranges:r})=>{const a=[],c=[],l={redos:a,undos:c};if(!r||!r.length)return l;const u=P(this._univerInstanceService,{unitId:n,subUnitId:s});if(!u)return l;const{worksheet:d}=u,h=d.getMergeData().filter(g=>r.some(R=>i.Rectangle.intersects(g,R)));return h.length?(a.push({id:H.id,params:{unitId:n,subUnitId:s,ranges:h}}),c.push({id:F.id,params:{unitId:n,subUnitId:s,ranges:h}}),{undos:c,redos:a}):l}})}refRangeHandle(e,n,s){switch(e.id){case D.MoveColsCommandId:{const r=e.params;return this._handleMoveColsCommand(r,n,s)}case D.MoveRowsCommandId:{const r=e.params;return this._handleMoveRowsCommand(r,n,s)}case Me.id:{const r=e.params,a=r.unitId||n,c=r.subUnitId||s;return this._handleInsertRowCommand(r,a,c)}case ye.id:{const r=e.params,a=r.unitId||n,c=r.subUnitId||s;return this._handleInsertColCommand(r,a,c)}case Yt.id:{const r=e.params;return this._handleRemoveColCommand(r,n,s)}case qt.id:{const r=e.params;return this._handleRemoveRowCommand(r,n,s)}case qe.id:{const r=e.params;return this._handleMoveRangeCommand(r,n,s)}case ft.id:{const r=e.params;return this._handleInsertRangeMoveRightCommand(r,n,s)}case Xe.id:{const r=e.params;return this._handleInsertRangeMoveDownCommand(r,n,s)}case Ge.id:{const r=e.params;return this._handleDeleteRangeMoveUpCommand(r,n,s)}case je.id:{const r=e.params;return this._handleDeleteRangeMoveLeftCommand(r,n,s)}}return{redos:[],undos:[]}}_onRefRangeChange(){const e=(n,s)=>{const r=this._univerInstanceService.getUniverSheetInstance(n);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(s);if(!a)return;this.disposableCollection.dispose();const c=a.getMergeData(),l=u=>this.refRangeHandle(u,n,s);c.forEach(u=>{this.disposableCollection.add(this._refRangeService.registerRefRange(u,l,n,s))})};this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id===bt.id){const s=n.params,r=s.subUnitId,a=s.unitId;if(!r||!a)return;e(a,r)}if(n.id===F.id){const s=n.params,r=s.subUnitId,a=s.unitId;if(!r||!a)return;e(s.unitId,s.subUnitId)}})),this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.first(n=>!!n)).subscribe(n=>{const s=n.getActiveSheet();s&&e(n.getUnitId(),s.getSheetId())})}_handleMoveRowsCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=[...a.getMergeData()],l={unitId:n,subUnitId:s,ranges:[]},u={unitId:n,subUnitId:s,ranges:[]},{fromRange:d}=e,{startRow:m,endRow:h}=d;if(c.forEach(C=>{if(m<=C.startRow&&h>=C.endRow){l.ranges.push(C);const f=Do({id:D.MoveRowsCommandId,params:e},C),p=et(f,C);p&&u.ranges.push(p)}}),l.ranges.length===0)return this._handleNull();const g=se(this._injector,l),R=he(this._injector,u);return{preRedos:[{id:H.id,params:l}],redos:[{id:F.id,params:u}],preUndos:[{id:H.id,params:R}],undos:[{id:F.id,params:g}]}}_handleMoveColsCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=[...a.getMergeData()],l={unitId:n,subUnitId:s,ranges:[]},u={unitId:n,subUnitId:s,ranges:[]},{fromRange:d}=e,{startColumn:m,endColumn:h}=d;if(c.forEach(C=>{if(m<=C.startColumn&&h>=C.endColumn){l.ranges.push(C);const f=Ao({id:D.MoveColsCommandId,params:e},C),p=et(f,C);p&&u.ranges.push(p)}}),l.ranges.length===0)return this._handleNull();const g=se(this._injector,l),R=he(this._injector,u);return{preRedos:[{id:H.id,params:l}],redos:[{id:F.id,params:u}],preUndos:[{id:H.id,params:R}],undos:[{id:F.id,params:g}]}}_handleMoveRangeCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=a.getMergeData(),l=c.filter(R=>i.Rectangle.intersects(R,e.fromRange)),u=c.filter(R=>i.Rectangle.intersects(R,e.toRange)),d=l.map(R=>i.Rectangle.getRelativeRange(R,e.fromRange)).map(R=>i.Rectangle.getPositionRange(R,e.toRange)),m=Wo(d).filter(R=>!c.some(C=>i.Rectangle.equals(R,C))),h=[{id:H.id,params:{unitId:n,subUnitId:s,ranges:l}},{id:H.id,params:{unitId:n,subUnitId:s,ranges:u}},{id:F.id,params:{unitId:n,subUnitId:s,ranges:m}}],g=[{id:H.id,params:{unitId:n,subUnitId:s,ranges:m}},{id:F.id,params:{unitId:n,subUnitId:s,ranges:u}},{id:F.id,params:{unitId:n,subUnitId:s,ranges:l}}];return{redos:h,undos:g}}_handleInsertRowCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const{range:c}=e,{startRow:l,endRow:u}=c,d=i.Tools.deepClone(a.getMergeData()).reduce((w,I)=>(l>I.startRow&&l<=I.endRow&&w.push(I),w),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((w,I)=>{if(l>I.startRow&&l<=I.endRow){const v=u-l+1;I.endRow+=v,this._checkIsMergeCell(I)&&w.push(I)}return w},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:H.id,params:h},{id:F.id,params:R}],p=[{id:H.id,params:C},{id:F.id,params:g}];return{redos:f,undos:p}}_handleInsertColCommand(e,n,s){const{range:r}=e,a=pe(this._univerInstanceService,n);if(!a)return this._handleNull();const c=Ie(a,s);if(!c)return this._handleNull();const{startColumn:l,endColumn:u}=r,d=i.Tools.deepClone(c.getMergeData()).reduce((w,I)=>(l>I.startColumn&&l<=I.endColumn&&w.push(I),w),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(c.getMergeData()).reduce((w,I)=>{if(l>I.startColumn&&l<=I.endColumn){const v=u-l+1;I.endColumn+=v,this._checkIsMergeCell(I)&&w.push(I)}return w},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:H.id,params:h},{id:F.id,params:R}],p=[{id:H.id,params:C},{id:F.id,params:g}];return{redos:f,undos:p}}_handleRemoveColCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const{range:c}=e,{startColumn:l,endColumn:u}=c,d=i.Tools.deepClone(a.getMergeData()).reduce((v,M)=>(i.Rectangle.intersects(c,M)&&v.push(M),v),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((v,M)=>{if(i.Rectangle.intersects(c,M)){if(l<=M.startColumn&&u>=M.endColumn)return v;l>=M.startColumn&&u<=M.endColumn?M.endColumn-=u-l+1:l<M.startColumn?(M.startColumn=l,M.endColumn-=u-l+1):u>M.endColumn&&(M.endColumn=l-1),this._checkIsMergeCell(M)&&v.push(M)}return v},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:H.id,params:h}],p=[{id:F.id,params:R}],w=[{id:H.id,params:C}],I=[{id:F.id,params:g}];return{preUndos:w,undos:I,preRedos:f,redos:p}}_handleRemoveRowCommand(e,n,s){const{range:r}=e,a=pe(this._univerInstanceService,n);if(!a)return this._handleNull();const c=Ie(a,s);if(!c)return this._handleNull();const{startRow:l,endRow:u}=r,d=i.Tools.deepClone(c.getMergeData()).reduce((v,M)=>(i.Rectangle.intersects(r,M)&&v.push(M),v),[]);if(d.length===0)return this._handleNull();const m=i.Tools.deepClone(c.getMergeData()).reduce((v,M)=>{if(i.Rectangle.intersects(r,M)){if(l<=M.startRow&&u>=M.endRow)return v;l>=M.startRow&&u<=M.endRow?M.endRow-=u-l+1:l<M.startRow?(M.startRow=l,M.endRow-=u-l+1):u>M.endRow&&(M.endRow=l-1),this._checkIsMergeCell(M)&&v.push(M)}return v},[]),h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:H.id,params:h}],p=[{id:F.id,params:R}],w=[{id:H.id,params:C}],I=[{id:F.id,params:g}];return{preUndos:w,undos:I,preRedos:f,redos:p}}_handleInsertRangeMoveRightCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=e.range,l=a.getMaxColumns()-1,u=a.getMergeData(),d=[],m=[];u.forEach(f=>{const{startRow:p,endRow:w,startColumn:I,endColumn:v}=c;if(i.Rectangle.intersects({startRow:p,startColumn:I,endRow:w,endColumn:l},f)&&(d.push(f),i.Rectangle.contains({startRow:p,startColumn:I,endRow:w,endColumn:l},f))){const E=v-I+1;m.push({startRow:f.startRow,startColumn:f.startColumn+E,endRow:f.endRow,endColumn:f.endColumn+E})}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R);return{preRedos:[{id:H.id,params:h}],redos:[{id:F.id,params:R}],preUndos:[{id:H.id,params:C}],undos:[{id:F.id,params:g}]}}_handleInsertRangeMoveDownCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=e.range,l=a.getMaxRows()-1,u=a.getMergeData(),d=[],m=[];u.forEach(v=>{const{startRow:M,startColumn:_,endColumn:E,endRow:T}=c;if(i.Rectangle.intersects({startRow:M,startColumn:_,endRow:l,endColumn:E},v)&&(d.push(v),i.Rectangle.contains({startRow:M,startColumn:_,endRow:l,endColumn:E},v))){const k=T-M+1;m.push({startRow:v.startRow+k,startColumn:v.startColumn,endRow:v.endRow+k,endColumn:v.endColumn})}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:H.id,params:h}],p=[{id:F.id,params:R}],w=[{id:H.id,params:C}],I=[{id:F.id,params:g}];return{redos:p,undos:I,preRedos:f,preUndos:w}}_handleDeleteRangeMoveUpCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=e.range,l=a.getMaxRows()-1,u=a.getMergeData(),d=[],m=[];u.forEach(v=>{const{startRow:M,startColumn:_,endColumn:E,endRow:T}=c;if(i.Rectangle.intersects({startRow:M,startColumn:_,endRow:l,endColumn:E},v)&&(d.push(v),i.Rectangle.contains({startRow:M,startColumn:_,endRow:l,endColumn:E},v))){const k=T-M+1,A=i.Rectangle.moveVertical(v,-k);m.push(A)}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R),f=[{id:H.id,params:h}],p=[{id:F.id,params:R}],w=[{id:H.id,params:C}],I=[{id:F.id,params:g}];return{redos:p,undos:I,preRedos:f,preUndos:w}}_handleDeleteRangeMoveLeftCommand(e,n,s){const r=pe(this._univerInstanceService,n);if(!r)return this._handleNull();const a=Ie(r,s);if(!a)return this._handleNull();const c=e.range,l=a.getMaxColumns()-1,u=a.getMergeData(),d=[],m=[];u.forEach(f=>{const{startRow:p,endRow:w,startColumn:I,endColumn:v}=c;if(i.Rectangle.intersects({startRow:p,startColumn:I,endRow:w,endColumn:l},f)&&(d.push(f),i.Rectangle.contains({startRow:p,startColumn:I,endRow:w,endColumn:l},f))){const E=v-I+1;m.push({startRow:f.startRow,startColumn:f.startColumn-E,endRow:f.endRow,endColumn:f.endColumn-E})}});const h={unitId:n,subUnitId:s,ranges:d},g=se(this._injector,h),R={unitId:n,subUnitId:s,ranges:m},C=he(this._injector,R);return{preRedos:[{id:H.id,params:h}],redos:[{id:F.id,params:R}],undos:[{id:F.id,params:g}],preUndos:[{id:H.id,params:C}]}}_checkIsMergeCell(e){return!(e.startRow===e.endRow&&e.startColumn===e.endColumn)}_handleNull(){return{redos:[],undos:[]}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(Xc.includes(e.id)){if(!e.params)return;const n=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!n)return;const s=n.getSheetBySheetId(e.params.subUnitId);if(!s)return;const{sourceRange:r,targetRange:a}=e.params,c=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,l=c?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,u=c?r.startRow:r.startColumn,d=c?a.startRow:a.startColumn,m=s.getConfig().mergeData,h=[];m.forEach(f=>{let{startRow:p,endRow:w,startColumn:I,endColumn:v,rangeType:M}=f;i.Rectangle.intersects(f,r)||(c?u<p&&d>w?(p-=l,w-=l):u>w&&d<=p&&(p+=l,w+=l):u<I&&d>v?(I-=l,v-=l):u>v&&d<=I&&(I+=l,v+=l)),f.startRow===f.endRow&&f.startColumn===f.endColumn||h.push({startRow:p,endRow:w,startColumn:I,endColumn:v,rangeType:M})}),s.setMergeData(h),this.disposableCollection.dispose();const{unitId:g,subUnitId:R}=e.params,C=f=>this.refRangeHandle(f,g,R);h.forEach(f=>{this.disposableCollection.add(this._refRangeService.registerRefRange(f,C,g,R))})}if(Jc.includes(e.id)){const n=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!n)return;const s=n.getSheetBySheetId(e.params.subUnitId);if(!s)return;const r=s.getConfig().mergeData,a=e.params;if(!a)return;const{range:c}=a,l=e.id.includes("row"),u=e.id.includes("insert"),d=l?c.startRow:c.startColumn,m=l?c.endRow:c.endColumn,h=m-d+1,g=[];r.forEach(p=>{let{startRow:w,endRow:I,startColumn:v,endColumn:M,rangeType:_}=p;u?l?d<=w&&(w+=h,I+=h):d<=v&&(v+=h,M+=h):l?m<w&&(w-=h,I-=h):m<v&&(v-=h,M-=h),p.startRow===p.endRow&&p.startColumn===p.endColumn||g.push({startRow:w,endRow:I,startColumn:v,endColumn:M,rangeType:_})}),s.setMergeData(g),this.disposableCollection.dispose();const{unitId:R,subUnitId:C}=e.params,f=p=>this.refRangeHandle(p,R,C);g.forEach(p=>{this.disposableCollection.add(this._refRangeService.registerRefRange(p,f,R,C))})}}))}};exports.MergeCellController=Kc([st(0,i.Inject(i.ICommandService)),st(1,i.Inject(exports.RefRangeService)),st(2,i.Inject(i.IUniverInstanceService)),st(3,i.Inject(i.Injector)),st(4,i.Inject(exports.SheetInterceptorService)),st(5,i.Inject(exports.SheetsSelectionsService))],exports.MergeCellController);function pe(o,t){return t?o.getUniverSheetInstance(t):o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET)}function Ie(o,t){return t?o.getSheetBySheetId(t):o.getActiveSheet()}function Zc(o,t){return t.some(e=>Qc(o,e))}function Qc(o,t){const{startRow:e,startColumn:n,endColumn:s,endRow:r}=t,a=o.getMatrixWithMergedCells(e,n,r,s);let c=!1;return a.forValue((l,u,d)=>{if(d&&(l!==e||u!==n)&&o.cellHasValue(d))return c=!0,!1}),c}function el(o,t,e,n){const s=[],r=[],a=e.getSheetId();return n.forEach(c=>{const l=tl(e,c),u={unitId:t,subUnitId:a,cellValue:l.getData()},d=me(o,u);s.push({id:B.id,params:d}),r.push({id:B.id,params:u})}),{undos:s,redos:r}}function tl(o,t){const{startRow:e,startColumn:n,endColumn:s,endRow:r}=t,a=o.getMatrixWithMergedCells(e,n,r,s,i.CellModeEnum.Raw),c=new i.ObjectMatrix;return a.forValue((l,u,d)=>{d&&(l!==e||u!==n)&&c.setValue(l,u,null)}),c}const Jt={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=t.unitId,a=t.subUnitId,c=t.selections,l=Wo(c,t.value),u=s.getUniverSheetInstance(r).getSheetBySheetId(a),d=[],m=[],h=Zc(u,l),g={unitId:r,subUnitId:a,ranges:l},R={unitId:r,subUnitId:a,ranges:l};d.push({id:H.id,params:g}),d.push({id:F.id,params:R});const C=se(o,g),f=he(o,R);if(m.push({id:H.id,params:f}),m.push({id:F.id,params:C}),h){const w=el(o,r,u,l);d.unshift(...w.redos),m.push(...w.undos)}return i.sequenceExecute(d,e).result?(n.pushUndoRedo({unitID:r,undoMutations:m,redoMutations:d}),!0):!1}},nl={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-all",handler:async o=>{var u;const t=o.get(i.ICommandService),n=(u=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:u.map(d=>d.range);if(!(n!=null&&n.length))return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const c=r.getUnitId(),l=a.getSheetId();return t.executeCommand(Jt.id,{selections:n,unitId:c,subUnitId:l})}},ol={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-vertical",handler:async o=>{var u;const t=o.get(i.ICommandService),n=(u=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:u.map(d=>d.range);if(!(n!=null&&n.length))return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const c=r.getUnitId(),l=a.getSheetId();return t.executeCommand(Jt.id,{value:i.Dimension.COLUMNS,selections:n,unitId:c,subUnitId:l})}},sl={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-horizontal",handler:async o=>{var u;const t=o.get(i.ICommandService),n=(u=o.get(exports.SheetsSelectionsService).getCurrentSelections())==null?void 0:u.map(d=>d.range);if(!(n!=null&&n.length))return!1;const r=o.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const c=r.getUnitId(),l=a.getSheetId();return t.executeCommand(Jt.id,{value:i.Dimension.ROWS,selections:n,unitId:c,subUnitId:l})}};function rl(o,t,e,n,s){const r=o.get(i.IUniverInstanceService),a=P(r,{unitId:t,subUnitId:e});if(!a)return;const{worksheet:c}=a;if(c.getMergeData().some(m=>n.some(h=>i.Rectangle.intersects(h,m))))throw new Error("The ranges to be merged overlap with the existing merged cells");o.get(i.ICommandService).executeCommand(Jt.id,{unitId:t,subUnitId:e,selections:n,defaultMerge:s})}class Tt{constructor(){S(this,"_model",new Map);S(this,"_pointChange",new O.Subject);S(this,"pointChange$",this._pointChange.asObservable())}addRule(t){this._ensureSubUnitMap(t.unitId).set(t.subUnitId,t),this._pointChange.next(t)}deleteRule(t,e){var s,r,a;const n=(s=this._model.get(t))==null?void 0:s.get(e);n&&((a=(r=this._model)==null?void 0:r.get(t))==null||a.delete(e),this._pointChange.next(n))}getRule(t,e){var n,s;return(s=(n=this._model)==null?void 0:n.get(t))==null?void 0:s.get(e)}toObject(){const t={};return[...this._model.keys()].forEach(n=>{const s=this._model.get(n);s!=null&&s.size&&(t[n]=[],[...s.keys()].forEach(a=>{const c=s.get(a);c&&t[n].push(c)}))}),t}fromObject(t){const e=new Map;Object.keys(t).forEach(n=>{const s=t[n];if(s!=null&&s.length){const r=new Map;s.forEach(a=>{r.set(a.subUnitId,a)}),e.set(n,r)}}),this._model=e}deleteUnitModel(t){this._model.delete(t)}_ensureSubUnitMap(t){let e=this._model.get(t);return e||(e=new Map,this._model.set(t,e)),e}getTargetByPermissionId(t,e){const n=this._model.get(t);if(!n)return null;for(const[s,r]of n)if(r.permissionId===e)return[t,s]}}class Oe{constructor(){S(this,"_model",new Map);S(this,"_ruleChange",new O.Subject);S(this,"_ruleRefresh",new O.Subject);S(this,"_resetOrder",new O.Subject);S(this,"ruleChange$",this._ruleChange.asObservable());S(this,"ruleRefresh$",this._ruleRefresh.asObservable());S(this,"resetOrder$",this._resetOrder.asObservable());S(this,"_worksheetRuleInitStateChange",new O.BehaviorSubject(!1));S(this,"worksheetRuleInitStateChange$",this._worksheetRuleInitStateChange.asObservable())}changeRuleInitState(t){this._worksheetRuleInitStateChange.next(t)}getSheetRuleInitState(){return this._worksheetRuleInitStateChange.value}addRule(t,e){this._ensureSubUnitMap(t).set(e.subUnitId,e),this._ruleChange.next({unitId:t,rule:e,type:"add",subUnitId:e.subUnitId})}deleteRule(t,e){var s,r,a;const n=(r=(s=this._model)==null?void 0:s.get(t))==null?void 0:r.get(e);n&&((a=this._model.get(t))==null||a.delete(e),this._ruleChange.next({unitId:t,rule:n,type:"delete",subUnitId:e}))}setRule(t,e,n){var r,a;const s=this.getRule(t,e);s&&((a=(r=this._model)==null?void 0:r.get(t))==null||a.set(e,n),this._ruleChange.next({unitId:t,oldRule:s,rule:n,type:"set",subUnitId:e}))}getRule(t,e){var n,s;return(s=(n=this._model)==null?void 0:n.get(t))==null?void 0:s.get(e)}toObject(){const t={};return[...this._model.keys()].forEach(n=>{const s=this._model.get(n);s!=null&&s.size&&(t[n]=[],[...s.keys()].forEach(a=>{const c=s.get(a);c&&t[n].push(c)}))}),t}fromObject(t){const e=new Map;Object.keys(t).forEach(n=>{const s=t[n];if(s!=null&&s.length){const r=new Map;s.forEach(a=>{r.set(a.subUnitId,a)}),e.set(n,r)}}),this._model=e}deleteUnitModel(t){this._model.delete(t)}_ensureSubUnitMap(t){let e=this._model.get(t);return e||(e=new Map,this._model.set(t,e)),e}ruleRefresh(t){this._ruleRefresh.next(t)}resetOrder(){this._resetOrder.next(Math.random())}getTargetByPermissionId(t,e){const n=this._model.get(t);if(!n)return null;for(const[s,r]of n)if(r.permissionId===e)return[t,s]}}class Vo{constructor(t,e,n){S(this,"type",N.SelectRange);S(this,"subType",y.Delete);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!0);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${N.SelectRange}.${y.Delete}.${n}`}}class $o{constructor(t,e,n){S(this,"type",N.SelectRange);S(this,"subType",y.ManageCollaborator);S(this,"status",i.PermissionStatus.INIT);S(this,"value",!0);S(this,"id");S(this,"unitId");S(this,"subUnitId");S(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${N.SelectRange}.${y.ManageCollaborator}.${n}`}}const ie=()=>[yn,ge,$o,Vo],Be=[y.Edit,y.View,y.ManageCollaborator,y.Delete],il=(o="unitId",t="subUnitId",e="permissionId")=>ie().reduce((n,s)=>{const r=new s(o,t,e);return n[r.subType]=r.value,n},{}),vt=()=>[ue,ao,eo,uo,to,io,bn,oo,so,Tn,_n,ro,lo,En,Zs,mo,co,no,or,nr,er,Qs],Nr=[y.Edit,y.Print,y.Comment,y.View,y.Copy,y.Export,y.ManageCollaborator,y.CreateSheet,y.DeleteSheet,y.RenameSheet,y.HideSheet,y.Duplicate,y.Share,y.MoveSheet,y.CopySheet,y.RecoverHistory,y.ViewHistory,y.CreatePermissionObject,y.InsertRow,y.InsertColumn,y.DeleteRow,y.DeleteColumn],re=()=>[Re,zt,wo,Ro],Ce=()=>[ho,go,Co,So,fo,po,vo,Io,Mo,yo,xt,mt,ht,_o],sn=[y.Copy,y.DeleteColumn,y.DeleteRow,y.EditExtraObject,y.Filter,y.InsertColumn,y.InsertRow,y.InsertHyperlink,y.PivotTable,y.SetCellStyle,y.SetCellValue,y.SetColumnStyle,y.SetRowStyle,y.Sort];var al=Object.getOwnPropertyDescriptor,cl=(o,t,e,n)=>{for(var s=n>1?void 0:n?al(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},$e=(o,t)=>(e,n)=>t(e,n,o);const ll="SHEET_WORKSHEET_PROTECTION_PLUGIN",ul="SHEET_WORKSHEET_PROTECTION_POINT_PLUGIN";exports.WorksheetPermissionService=class extends i.RxDisposable{constructor(t,e,n,s,r,a,c,l){super(),this._permissionService=t,this._univerInstanceService=e,this._injector=n,this._worksheetProtectionRuleModel=s,this._worksheetProtectionPointRuleModel=r,this._resourceManagerService=a,this._rangeProtectionRuleModel=c,this._logService=l,this._init(),this._initRuleChange(),this._initRuleSnapshot(),this._initPointSnapshot()}_init(){const t=e=>{const n=e.getUnitId(),s=r=>{const a=r.getSheetId();[...re(),...Ce()].forEach(c=>{const l=new c(n,a);this._permissionService.addPermissionPoint(l)}),this._logService.debug("[WorksheetPermissionService]","Initialization completed",n,a)};e.getSheets().forEach(r=>{s(r)}),e.sheetCreated$.subscribe(r=>{s(r)}),e.sheetDisposed$.subscribe(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(n,a).forEach(l=>{[...ie()].forEach(u=>{const d=new u(n,a,l.permissionId);this._permissionService.deletePermissionPoint(d.id)})}),[...re(),...Ce()].forEach(l=>{const u=new l(n,a);this._permissionService.deletePermissionPoint(u.id)})})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(e=>{t(e)}),this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).pipe(Nt.takeUntil(this.dispose$)).subscribe(t),this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(Nt.takeUntil(this.dispose$)).subscribe(e=>{e.getSheets().forEach(n=>{const s=e.getUnitId(),r=n.getSheetId();re().forEach(a=>{const c=new a(s,r);this._permissionService.deletePermissionPoint(c.id)})})})}_initRuleChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(t=>{switch(t.type){case"add":break;case"delete":{re().forEach(e=>{const n=new e(t.unitId,t.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)});break}case"set":{re().forEach(e=>{const n=new e(t.unitId,t.subUnitId);this._permissionService.updatePermissionPoint(n.id,t.rule)});break}}}))}_initRuleSnapshot(){const t=()=>{const n=this._worksheetProtectionRuleModel.toObject();return JSON.stringify(n)},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t,parseJson:e,pluginName:ll,businesses:[an.UNIVER_SHEET],onLoad:(n,s)=>{this._worksheetProtectionRuleModel.fromObject(s),Object.keys(s).forEach(r=>{re().forEach(a=>{const c=new a(n,r);c.value=!1,this._permissionService.addPermissionPoint(c)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)},onUnLoad:n=>{const s=this._univerInstanceService.getUnit(n);s&&(s.getSheets().forEach(r=>{const a=r.getSheetId();[...re(),...Ce()].forEach(c=>{const l=new c(n,a);this._permissionService.deletePermissionPoint(l.id)})}),vt().forEach(r=>{const a=new r(n);this._permissionService.deletePermissionPoint(a.id)})),this._worksheetProtectionRuleModel.deleteUnitModel(n)}}))}_initPointSnapshot(){const t=()=>{const n=this._worksheetProtectionPointRuleModel.toObject();return JSON.stringify(n)},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t,parseJson:e,pluginName:ul,businesses:[an.UNIVER_SHEET],onLoad:(n,s)=>{this._worksheetProtectionPointRuleModel.fromObject(s),Object.keys(s).forEach(r=>{Ce().forEach(a=>{const c=new a(n,r);this._permissionService.addPermissionPoint(c)})})},onUnLoad:n=>{this._worksheetProtectionPointRuleModel.deleteUnitModel(n)}}))}};exports.WorksheetPermissionService=cl([$e(0,i.Inject(i.IPermissionService)),$e(1,i.Inject(i.IUniverInstanceService)),$e(2,i.Inject(i.Injector)),$e(3,i.Inject(Oe)),$e(4,i.Inject(Tt)),$e(5,i.Inject(i.IResourceManagerService)),$e(6,i.Inject(J)),$e(7,i.Inject(i.ILogService))],exports.WorksheetPermissionService);const Un={id:"sheet.mutation.set-worksheet-permission-points",type:i.CommandType.MUTATION,handler:(o,t)=>{const{rule:e}=t;return o.get(Tt).addRule(e),!0}};var dl=Object.getOwnPropertyDescriptor,ml=(o,t,e,n)=>{for(var s=n>1?void 0:n?dl(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Pt=(o,t)=>(e,n)=>t(e,n,o);exports.WorkbookPermissionService=class extends i.Disposable{constructor(e,n,s,r,a){super();S(this,"_unitPermissionInitStateChange",new O.BehaviorSubject(!1));S(this,"unitPermissionInitStateChange$",this._unitPermissionInitStateChange.asObservable());this._permissionService=e,this._univerInstanceService=n,this._rangeProtectionRuleModel=s,this._worksheetProtectionRuleModel=r,this._worksheetProtectionPointModel=a,this._init()}_init(){const e=n=>{const s=n.getUnitId();vt().forEach(r=>{const a=new r(s);this._permissionService.addPermissionPoint(a)})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(n=>{e(n)}),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{e(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{const s=n.getUnitId();n.getSheets().forEach(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(s,a).forEach(l=>{[...ie()].forEach(u=>{const d=new u(s,a,l.permissionId);this._permissionService.deletePermissionPoint(d.id)})}),[...re(),...Ce()].forEach(l=>{const u=new l(s,a);this._permissionService.deletePermissionPoint(u.id)})}),vt().forEach(r=>{const a=new r(s);this._permissionService.deletePermissionPoint(a.id)}),this._rangeProtectionRuleModel.deleteUnitModel(s),this._worksheetProtectionPointModel.deleteUnitModel(s),this._worksheetProtectionRuleModel.deleteUnitModel(s)}))}changeUnitInitState(e){this._unitPermissionInitStateChange.next(e)}};exports.WorkbookPermissionService=ml([Pt(0,i.Inject(i.IPermissionService)),Pt(1,i.Inject(i.IUniverInstanceService)),Pt(2,i.Inject(J)),Pt(3,i.Inject(Oe)),Pt(4,i.Inject(Tt))],exports.WorkbookPermissionService);var hl=Object.getOwnPropertyDescriptor,gl=(o,t,e,n)=>{for(var s=n>1?void 0:n?hl(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},be=(o,t)=>(e,n)=>t(e,n,o);exports.SheetPermissionInitController=class extends i.Disposable{constructor(e,n,s,r,a,c,l,u,d,m){super();S(this,"_cmdBufferList",[]);S(this,"_isRangePermissionInitFinish",!1);S(this,"_isWorksheetPermissionInitFinish",!1);S(this,"_isWorkbookPermissionInitFinish",!1);this._univerInstanceService=e,this._permissionService=n,this._authzIoService=s,this._rangeProtectionRuleModel=r,this._worksheetProtectionRuleModel=a,this._userManagerService=c,this._worksheetProtectionPointRuleModel=l,this._workbookPermissionService=u,this._undoRedoService=d,this._commandService=m}initPermission(){this._initRangePermissionFromSnapshot(),this._initRangePermissionChange(),this._initWorksheetPermissionFromSnapshot(),this._initWorksheetPermissionChange(),this._initWorksheetPermissionPointsChange(),this._initWorkbookPermissionFromSnapshot(),this._initUserChange(),this._refreshPermissionByCollaCreate()}refreshRangeProtectPermission(){this._initRangePermissionFromSnapshot()}getIsPermissionInitFinish(){return this._isWorksheetPermissionInitFinish&&this._isRangePermissionInitFinish&&this._isWorkbookPermissionInitFinish}addCmdToBufferList(e){this._cmdBufferList.push(e)}_processCmdBufferList(){if(!(!this.getIsPermissionInitFinish()||this._cmdBufferList.length===0))for(const e of this._cmdBufferList)this._commandService.executeCommand(e.id,e.params,{onlyLocal:!0})}async _initRangePermissionFromSnapshot(){const e=async n=>{const s=[],r=n.getUnitId(),a=n.getSheets(),c=new Map;if(a.forEach(l=>{const u=l.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(r,u).forEach(d=>{c.set(d.permissionId,d),s.push({objectID:d.permissionId,unitID:r,objectType:N.SelectRange,actions:Be})})}),!s.length){this._rangeProtectionRuleModel.changeRuleInitState(!0),this._isRangePermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList();return}this._authzIoService.batchAllowed(s).then(l=>{l.forEach(u=>{const d=c.get(u.objectID);d&&ie().forEach(m=>{const h=new m(r,d.subUnitId,u.objectID),g=h.subType,R=u.actions.find(C=>C.action===g);(R==null?void 0:R.allowed)!==void 0&&this._permissionService.updatePermissionPoint(h.id,R.allowed)})}),this._rangeProtectionRuleModel.changeRuleInitState(!0),this._isRangePermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList()})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(n=>e(n))),this._rangeProtectionRuleModel.changeRuleInitState(!0)}_initRangePermissionChange(){this.disposeWithMe(this._rangeProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:N.SelectRange,actions:Be}).then(n=>{ie().forEach(s=>{if(e.type==="set"){const{rule:u,oldRule:d}=e;if(u.permissionId===(d==null?void 0:d.permissionId))return}const r=e.rule,a=new s(r.unitId,r.subUnitId,r.permissionId),c=a.subType,l=n.find(u=>u.action===c);l&&this._permissionService.updatePermissionPoint(a.id,l.allowed)}),this._rangeProtectionRuleModel.ruleRefresh(e.rule.permissionId)}):this._rangeProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId).length===0&&(this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId),[...Ce()].forEach(s=>{const r=new s(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(r.id,r.value)}))}))}async initWorkbookPermissionChange(e){var s;const n=e||((s=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:s.getUnitId());if(n)return this._authzIoService.allowed({objectID:n,objectType:N.Workbook,unitID:n,actions:Nr}).then(r=>{vt().forEach(a=>{const c=new a(n),l=c.subType,u=r.find(d=>d.action===l);u&&this._permissionService.updatePermissionPoint(c.id,u.allowed)}),this._isWorkbookPermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList()})}async _initWorkbookPermissionFromSnapshot(){await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(e=>this.initWorkbookPermissionChange(e.getUnitId()))),this._workbookPermissionService.changeUnitInitState(!0)}_initWorksheetPermissionChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:N.Worksheet,actions:Be}).then(n=>{re().forEach(s=>{const r=new s(e.unitId,e.subUnitId),a=r.subType,c=n.find(l=>l.action===a);c&&this._permissionService.updatePermissionPoint(r.id,c.allowed)}),this._worksheetProtectionRuleModel.ruleRefresh(e.rule.permissionId)}):([...re(),...Ce()].forEach(n=>{const s=new n(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(s.id,!0)}),this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId))}))}_initWorksheetPermissionPointsChange(){this.disposeWithMe(this._worksheetProtectionPointRuleModel.pointChange$.subscribe(e=>{this._authzIoService.allowed({objectID:e.permissionId,unitID:e.unitId,objectType:N.Worksheet,actions:sn}).then(n=>{Ce().forEach(s=>{const r=new s(e.unitId,e.subUnitId),a=r.subType,c=n.find(l=>l.action===a);c&&this._permissionService.updatePermissionPoint(r.id,c.allowed)})})}))}async _initWorksheetPermissionFromSnapshot(){const e=async n=>{const s=[],r=n.getUnitId(),a=n.getSheets(),c=new Map;if(a.forEach(l=>{const u=l.getSheetId(),d=this._worksheetProtectionRuleModel.getRule(r,u);d&&(c.set(d.permissionId,d),s.push({objectID:d.permissionId,unitID:r,objectType:N.Worksheet,actions:Be}));const m=this._worksheetProtectionPointRuleModel.getRule(r,u);m&&(c.set(m.permissionId,m),s.push({objectID:m.permissionId,unitID:r,objectType:N.Worksheet,actions:sn}))}),!s.length){this._worksheetProtectionRuleModel.changeRuleInitState(!0),this._isWorksheetPermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList();return}this._authzIoService.batchAllowed(s).then(l=>{l.forEach(u=>{const d=c.get(u.objectID);d&&[...re(),...Ce()].forEach(m=>{const h=new m(r,d.subUnitId),g=h.subType,R=u.actions.find(C=>C.action===g);(R==null?void 0:R.allowed)!==void 0&&this._permissionService.updatePermissionPoint(h.id,R.allowed)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0),this._isWorksheetPermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList()})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(n=>e(n))),this._worksheetProtectionRuleModel.changeRuleInitState(!0),this.getIsPermissionInitFinish()&&this._processCmdBufferList()}_initUserChange(){this.disposeWithMe(this._userManagerService.currentUser$.pipe(O.skip(1)).subscribe(()=>{const e=this._permissionService.getAllPermissionPoint();this._permissionService.clearPermissionMap(),this._worksheetProtectionRuleModel.changeRuleInitState(!1),this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(s=>{const r=s.getUnitId();vt().forEach(a=>{let c=new a(r);e.has(c.id)&&(c=e.get(c.id)),this._permissionService.addPermissionPoint(c)}),s.getSheets().forEach(a=>{const c=a.getSheetId();[...re(),...Ce()].forEach(u=>{let d=new u(r,c);e.has(d.id)&&(d=e.get(d.id)),this._permissionService.addPermissionPoint(d)}),this._rangeProtectionRuleModel.getSubunitRuleList(r,c).forEach(u=>{ie().forEach(d=>{let m=new d(r,c,u.permissionId);e.has(m.id)&&(m=e.get(m.id)),this._permissionService.addPermissionPoint(m)})})}),this._initWorkbookPermissionFromSnapshot(),this._initWorksheetPermissionFromSnapshot(),this._initRangePermissionFromSnapshot()})}))}refreshPermission(e,n){const s=this._worksheetProtectionRuleModel.getTargetByPermissionId(e,n);let r=!1;if(s){const[l,u]=s;this._authzIoService.allowed({objectID:n,unitID:e,objectType:N.Worksheet,actions:Be}).then(d=>{let m="";re().forEach(h=>{var f;const g=new h(e,u),R=g.subType,C=d.find(p=>p.action===R);C&&(((f=this._permissionService.getPermissionPoint(g.id))==null?void 0:f.value)!==C.allowed&&(r=!0),this._permissionService.updatePermissionPoint(g.id,C.allowed),m+=`${C.action}_${C.allowed}`)}),this._worksheetProtectionRuleModel.ruleRefresh(`${n}_${m}`),r&&this._undoRedoService.clearUndoRedo(e)})}const a=this._worksheetProtectionPointRuleModel.getTargetByPermissionId(e,n);if(a){const[l,u]=a;this._authzIoService.allowed({objectID:n,unitID:e,objectType:N.Worksheet,actions:sn}).then(d=>{Ce().forEach(m=>{var C;const h=new m(e,u),g=h.subType,R=d.find(f=>f.action===g);R&&(((C=this._permissionService.getPermissionPoint(h.id))==null?void 0:C.value)!==R.allowed&&(r=!0),this._permissionService.updatePermissionPoint(h.id,R.allowed))}),r&&this._undoRedoService.clearUndoRedo(e)})}const c=this._rangeProtectionRuleModel.getTargetByPermissionId(e,n);if(c){const[l,u]=c;this._authzIoService.allowed({objectID:n,unitID:e,objectType:N.SelectRange,actions:Be}).then(d=>{let m="";ie().forEach(h=>{var f;const g=new h(e,u,n),R=g.subType,C=d.find(p=>p.action===R);C&&(((f=this._permissionService.getPermissionPoint(g.id))==null?void 0:f.value)!==C.allowed&&(r=!0),this._permissionService.updatePermissionPoint(g.id,C.allowed),m+=`${C.action}_${C.allowed}`)}),this._rangeProtectionRuleModel.ruleRefresh(`${n}_${m}`),r&&this._undoRedoService.clearUndoRedo(e)})}}_refreshPermissionByCollaCreate(){this.disposeWithMe(this._commandService.onCommandExecuted((e,n)=>{if(n!=null&&n.fromCollab&&(e.id===fe.id||e.id===xe.id||e.id===Un.id)){const s=e.params;this._undoRedoService.clearUndoRedo(s.unitId)}}))}};exports.SheetPermissionInitController=gl([be(0,i.IUniverInstanceService),be(1,i.IPermissionService),be(2,i.IAuthzIoService),be(3,i.Inject(J)),be(4,i.Inject(Oe)),be(5,i.Inject(i.UserManagerService)),be(6,i.Inject(Tt)),be(7,i.Inject(exports.WorkbookPermissionService)),be(8,i.Inject(i.IUndoRedoService)),be(9,i.Inject(i.ICommandService))],exports.SheetPermissionInitController);const xe={id:"sheet.mutation.add-worksheet-protection",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(exports.SheetPermissionInitController),n=o.get(Oe);if(!e.getIsPermissionInitFinish())return e.addCmdToBufferList({id:xe.id,params:t}),!0;const{unitId:s,rule:r}=t;return n.addRule(s,r),!0}},ze={id:"sheet.mutation.delete-worksheet-protection",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(Oe),n=o.get(exports.SheetPermissionInitController);if(!n.getIsPermissionInitFinish())return n.addCmdToBufferList({id:ze.id,params:t}),!0;const{unitId:s,subUnitId:r}=t;return e.deleteRule(s,r),!0}},Or={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-protection",async handler(o,t){if(!t)return!1;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{rule:s,unitId:r}=t,a=s.subUnitId;if(await e.executeCommand(xe.id,{unitId:r,rule:s,subUnitId:s.subUnitId})){const l=[{id:xe.id,params:{unitId:r,rule:s,subUnitId:s.subUnitId}}],u=[{id:ze.id,params:{unitId:r,subUnitId:a}}];n.pushUndoRedo({unitID:r,redoMutations:l,undoMutations:u})}return!0}},Dr={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-range-theme-style",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s}=t,r=ws(o,t);return e.syncExecuteCommand(gt.id,t)?(n.pushUndoRedo({unitID:s,undoMutations:[{id:Rt.id,params:r}],redoMutations:[{id:gt.id,params:t}]}),!0):!1}},Rl="sheet.command.append-row",Ar={type:i.CommandType.COMMAND,id:Rl,handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s,subUnitId:r,cellValue:a,insertRowNums:c,insertColumnNums:l,maxRows:u,maxColumns:d}=t,m={unitId:s,subUnitId:r,cellValue:a},h=me(o,m),g=[{id:B.id,params:m}],R=[{id:B.id,params:h}];if(c){const f={unitId:s,subUnitId:r,range:{startRow:u,endRow:u,startColumn:0,endColumn:d-1}},p=pn(o,f);g.unshift({id:ae.id,params:f}),R.push({id:le.id,params:p})}if(l){const f={unitId:s,subUnitId:r,range:{startRow:0,endRow:u-1,startColumn:d,endColumn:d-1+l}},p=Ht(o,f);g.unshift({id:ce.id,params:f}),R.push({id:ne.id,params:p})}return i.sequenceExecute(g,e).result?(n.pushUndoRedo({unitID:s,undoMutations:R,redoMutations:g}),!0):!1}},Pn={id:"sheet.command.clear-selection-content",type:i.CommandType.COMMAND,handler:(o,t)=>{var I;const e=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUndoRedoService),a=o.get(exports.SheetInterceptorService),c=e.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!c)return!1;const l=(t==null?void 0:t.unitId)||c.getUnitId(),u=c.getActiveSheet();if(!u)return!1;const d=(t==null?void 0:t.subUnitId)||u.getSheetId(),m=(t==null?void 0:t.ranges)||((I=s.getCurrentSelections())==null?void 0:I.map(v=>v.range));if(!(m!=null&&m.length))return!1;const h=jt(m,o,l,d),g={subUnitId:d,unitId:l,cellValue:Bs(h)},R=me(o,g),C=a.onCommandExecute({id:Pn.id}),f=[{id:B.id,params:g},...C.redos],p=[...C.undos,{id:B.id,params:R}];return i.sequenceExecute(f,n).result?(r.pushUndoRedo({unitID:l,undoMutations:p,redoMutations:f}),!0):!1}},Lo=(o,t)=>({subUnitId:t.sheet.id,unitId:t.unitId,subUnitName:t.sheet.name}),wt={id:"sheet.mutation.insert-sheet",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService),{sheet:n,index:s,unitId:r,styles:a}=t,c=e.getUniverSheetInstance(r);return c?(a&&c.addStyles(a),c.addWorksheet(n.id,s,n)):!1}},Bo={type:i.CommandType.COMMAND,id:"sheet.command.copy-sheet",handler:(o,t)=>{var v,M;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),a=o.get(i.LocaleService),c=P(s,t);if(!c)return!1;const{workbook:l,worksheet:u,unitId:d,subUnitId:m}=c,h=i.Tools.deepClone(u.getConfig());h.name=Cl(l,a,h.name),h.id=i.generateRandomId();const R={index:l.getSheetIndex(u)+1,sheet:h,unitId:d},C=Lo(o,R),f=r.onCommandExecute({id:Bo.id,params:{unitId:d,subUnitId:m,targetSubUnitId:h.id}}),p=[...(v=f.preRedos)!=null?v:[],{id:wt.id,params:R},...f.redos],w=[...(M=f.preUndos)!=null?M:[],{id:nt.id,params:C},...f.undos];return i.sequenceExecute(p,e).result?(n.pushUndoRedo({unitID:d,undoMutations:w,redoMutations:p}),!0):!1}};function Cl(o,t,e){let n=`${e} ${t.t("sheets.tabs.sheetCopy","")}`,s=2;for(;o.checkSheetName(n);)n=`${e} ${t.t("sheets.tabs.sheetCopy",`${s}`)}`,s++;return n}const xr={type:i.CommandType.COMMAND,id:"sheet.command.delete-range-protection",async handler(o,t){if(!t)return!1;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s,subUnitId:r,rule:a}=t,c={unitId:s,subUnitId:r,ruleIds:[a.id]};return await e.executeCommand(ke.id,c)&&n.pushUndoRedo({unitID:s,redoMutations:[{id:ke.id,params:c}],undoMutations:[{id:fe.id,params:{unitId:s,subUnitId:r,rules:[a]}}]}),!0}},Wr={type:i.CommandType.COMMAND,id:"sheet.command.delete-worksheet-protection",handler(o,t){if(!t)return!1;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{rule:s,unitId:r,subUnitId:a}=t;e.executeCommand(ze.id,{unitId:r,subUnitId:a});const c=[{id:ze.id,params:{unitId:r,subUnitId:a}}],l=[{id:xe.id,params:{unitId:r,rule:s,subUnitId:a}}];return n.pushUndoRedo({unitID:r,redoMutations:c,undoMutations:l}),!0}},Vr={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-range-theme-style",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s}=t,r=Ms(o,t);return e.syncExecuteCommand(Rt.id,t)?(n.pushUndoRedo({unitID:s,undoMutations:[{id:gt.id,params:r}],redoMutations:[{id:Rt.id,params:t}]}),!0):!1}},$r={id:"sheet.command.insert-defined-name",type:i.CommandType.COMMAND,handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService);if(!t)return!1;const s={...t};return e.syncExecuteCommand(Y.SetDefinedNameMutation.id,s)?(n.pushUndoRedo({unitID:t.unitId,undoMutations:[{id:Y.RemoveDefinedNameMutation.id,params:s}],redoMutations:[{id:Y.SetDefinedNameMutation.id,params:s}]}),!0):!1}},Lr={id:"sheet.command.insert-sheet",type:i.CommandType.COMMAND,handler:(o,t)=>{var f;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(i.LocaleService),a=qn(s,{unitId:t==null?void 0:t.unitId});if(!a)return!1;const{unitId:c,workbook:l}=a;let u=l.getSheets().length;const d=t==null?void 0:t.sheet,m=d==null?void 0:d.id,h=i.mergeWorksheetSnapshotWithDefault(d||{});t?(u=(f=t.index)!=null?f:u,h.id=m||i.generateRandomId(),h.name=(d==null?void 0:d.name)||l.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`)):(h.id=i.generateRandomId(),h.name=l.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`));const g={index:u,sheet:h,unitId:c},R=Lo(o,g);return e.syncExecuteCommand(wt.id,g)?(n.pushUndoRedo({unitID:c,undoMutations:[{id:nt.id,params:R}],redoMutations:[{id:wt.id,params:g}]}),!0):!1}},Mt={id:"sheet.mutation.register-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,rangeThemeStyleJson:n,themeName:s}=t,r=o.get(i.IUniverInstanceService),a=P(r),c=o.get(exports.SheetRangeThemeModel);if(!a)return!1;const l=new We(s,n);return c.registerRangeThemeStyle(e,l),!0}},kn={id:"sheet.mutation.unregister-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,themeName:n}=t,s=o.get(i.IUniverInstanceService),r=P(s),a=o.get(exports.SheetRangeThemeModel);return r?(a.unregisterRangeThemeStyle(e,n),!0):!1}},Br={id:"sheet.command.register-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(o,t)=>{if(!t)return!1;const{unitId:e,rangeThemeStyle:n}=t,s=o.get(i.IUniverInstanceService),r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService);if(!P(s))return!1;const l={unitId:e,themeName:n.getName(),rangeThemeStyleJson:n.toJson()},u={unitId:e,themeName:n.getName()};return r.syncExecuteCommand(Mt.id,l)&&a.pushUndoRedo({unitID:e,undoMutations:[{id:kn.id,params:u}],redoMutations:[{id:Mt.id,params:l}]}),!0}},Fo={id:"sheet.command.remove-defined-name",type:i.CommandType.COMMAND,handler:(o,t)=>{var d,m;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetInterceptorService);if(!t)return!1;const r={...t},a=s.onCommandExecute({id:Fo.id,params:t}),c=[...(d=a.preRedos)!=null?d:[],{id:Y.RemoveDefinedNameMutation.id,params:r},...a.redos],l=[...(m=a.preUndos)!=null?m:[],{id:Y.SetDefinedNameMutation.id,params:r},...a.undos];return i.sequenceExecute(c,e)?(n.pushUndoRedo({unitID:t.unitId,undoMutations:l.filter(Boolean),redoMutations:c.filter(Boolean)}),!0):!1}},Nn={id:"sheet.command.remove-sheet",type:i.CommandType.COMMAND,handler:(o,t)=>{var p,w;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetInterceptorService),a=P(s,t);if(!a)return!1;const{unitId:c,subUnitId:l,workbook:u,worksheet:d}=a;if(u.getSheets().length<=1)return!1;const m={subUnitId:l,unitId:c,subUnitName:d.getName()},h=Cr(o,m),g=r.onCommandExecute({id:Nn.id,params:{unitId:c,subUnitId:l}}),R=[...(p=g.preRedos)!=null?p:[],{id:nt.id,params:m},...g.redos],C=[...(w=g.preUndos)!=null?w:[],{id:wt.id,params:h},...g.undos];return i.sequenceExecute(R,e).result?(n.pushUndoRedo({unitID:c,undoMutations:C,redoMutations:R}),!0):!1}},Fr={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-merge",handler:(o,t)=>{var k;const e=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(i.IUniverInstanceService),a=(t==null?void 0:t.ranges)||((k=e.getCurrentSelections())==null?void 0:k.map(A=>A.range));if(!(a!=null&&a.length))return!1;const c=P(r);if(!c)return!1;const{subUnitId:l,unitId:u,worksheet:d}=c,m={unitId:u,subUnitId:l,ranges:a},g=d.getConfig().mergeData.filter(A=>a.some(x=>i.Rectangle.intersects(x,A)));if(!g.length)return!1;const R=se(o,m),C=e.getCurrentSelections();if(!(C!=null&&C.length))return!1;const f=i.Tools.deepClone(C),p=i.Tools.deepClone(C),w=p[p.length-1],{startRow:I,startColumn:v}=w.range;w.primary={startRow:I,startColumn:v,endRow:I,endColumn:v,actualRow:I,actualColumn:v,isMerged:!1,isMergedMainCell:!1};const M=Sl(d,g),_={unitId:u,subUnitId:l,cellValue:M.redoParams.getMatrix()},E={unitId:u,subUnitId:l,cellValue:M.undoParams.getMatrix()},T=[{id:H.id,params:R},{id:B.id,params:_},{id:G.id,params:{selections:p}}],U=[{id:F.id,params:R},{id:B.id,params:E},{id:G.id,params:{selections:f}}];return i.sequenceExecute(T,n)?(s.pushUndoRedo({unitID:u,undoMutations:U,redoMutations:T}),!0):!1}};function Sl(o,t){const e=new i.ObjectMatrix,n=new i.ObjectMatrix;return t.forEach(s=>{const{startRow:r,startColumn:a,endColumn:c,endRow:l}=s,u=o.getCellMatrix().getValue(r,a);if(u!=null&&u.s)for(let d=r;d<=l;d++)for(let m=a;m<=c;m++)(d!==r||m!==a)&&(e.setValue(d,m,{s:u.s}),n.setValue(d,m,null))}),{redoParams:e,undoParams:n}}class ot{constructor(){S(this,"_borderInfo",{type:i.BorderType.ALL,color:"#000000",style:i.BorderStyleTypes.THIN,activeBorderType:!1});S(this,"_borderInfo$",new O.BehaviorSubject(this._borderInfo));S(this,"borderInfo$",this._borderInfo$.asObservable())}dispose(){this._borderInfo$.complete()}setType(t){this._borderInfo.type=t,this.setActiveBorderType(!0),this._refresh()}setColor(t){this._borderInfo.color=t,this._refresh()}setStyle(t){this._borderInfo.style=t,this._refresh()}setActiveBorderType(t){this._borderInfo.activeBorderType=t}getBorderInfo(){return this._borderInfo}_refresh(){this._borderInfo$.next(this._borderInfo)}}function dn(o,t){const{startRow:e,startColumn:n,endRow:s,endColumn:r}=o;for(let a=e;a<=s;a++)for(let c=n;c<=r;c++)t(a,c)}const Ho=(o,t,e,n)=>{const{mr:s,worksheet:r}=o;t.startRow<0||t.startColumn<0||dn(t,(a,c)=>{var d,m;const l=r.getMergedCell(a,c);let u=e;if(l&&(e.bc_tr||e.ml_tr||e.bl_tr||e.tl_mr||e.tl_bc||e.tl_br)){if(n){const h=i.Tools.deepClone((d=s.getValue(l.startRow,l.startColumn))==null?void 0:d.s);u=h!=null&&h.bd?Object.assign(h.bd,e):e}s.setValue(l.startRow,l.startColumn,{s:{bd:u}})}else{if(n){const h=i.Tools.deepClone((m=s.getValue(a,c))==null?void 0:m.s);u=h!=null&&h.bd?Object.assign(h.bd,e):e}s.setValue(a,c,{s:{bd:u}})}})},fl=o=>{const t={startRow:o.startRow-1,startColumn:o.startColumn,endRow:o.startRow-1,endColumn:o.endColumn},e={startRow:o.startRow,startColumn:o.startColumn-1,endRow:o.endRow,endColumn:o.startColumn-1},n={startRow:o.endRow+1,startColumn:o.startColumn,endRow:o.endRow+1,endColumn:o.endColumn},s={startRow:o.startRow,startColumn:o.endColumn+1,endRow:o.endRow,endColumn:o.endColumn+1},r={startRow:o.startRow,startColumn:o.startColumn,endRow:o.startRow,endColumn:o.endColumn},a={startRow:o.startRow,startColumn:o.startColumn,endRow:o.endRow,endColumn:o.startColumn},c={startRow:o.endRow,startColumn:o.startColumn,endRow:o.endRow,endColumn:o.endColumn},l={startRow:o.startRow,startColumn:o.endColumn,endRow:o.endRow,endColumn:o.endColumn};return{topRangeOut:t,leftRangeOut:e,bottomRangeOut:n,rightRangeOut:s,topRange:r,leftRange:a,bottomRange:c,rightRange:l}};function pl(o,t,e){const{style:n,color:s,type:r}=o.getBorderInfo(),a=r===i.BorderType.TOP||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,c=r===i.BorderType.LEFT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,l=r===i.BorderType.BOTTOM||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,u=r===i.BorderType.RIGHT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,d=r===i.BorderType.VERTICAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,m=r===i.BorderType.HORIZONTAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,h=r.indexOf("tlbr")>-1,g=r.indexOf("tlbc")>-1,R=r.indexOf("tlmr")>-1,C=r.indexOf("bltr")>-1,f=r.indexOf("mltr")>-1,p=r.indexOf("bctr")>-1,w=e[0],{topRangeOut:I,leftRangeOut:v,bottomRangeOut:M,rightRangeOut:_,topRange:E,leftRange:T,bottomRange:U,rightRange:b}=fl(w),k=new i.ObjectMatrix,{worksheet:A,unitId:x,subUnitId:W}=t;return{worksheet:A,unitId:x,subUnitId:W,style:n,color:s,type:r,top:a,left:c,right:u,bottom:l,vertical:d,horizontal:m,tl_br:h,tl_bc:g,tl_mr:R,bl_tr:C,ml_tr:f,bc_tr:p,topRangeOut:I,leftRangeOut:v,bottomRangeOut:M,rightRangeOut:_,topRange:E,leftRange:T,bottomRange:U,rightRange:b,range:w,mr:k,borderStyle:{s:n,cl:{rgb:s}}}}const Il=o=>{const{range:t,mr:e,borderStyle:n,vertical:s,horizontal:r,worksheet:a}=o;s&&dn(t,(c,l)=>{var d,m,h;const u=a.getMergedCell(c,l);if(u){const g=(d=e.getValue(u.startRow,u.startColumn))==null?void 0:d.s;u.startColumn!==t.startColumn&&e.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}else{if(l!==t.endColumn){const g=(m=e.getValue(c,l))==null?void 0:m.s;e.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{r:i.Tools.deepClone(n)}):{r:i.Tools.deepClone(n)}}})}if(l!==t.startColumn){const g=(h=e.getValue(c,l))==null?void 0:h.s;e.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}}}),r&&dn(t,(c,l)=>{var d,m,h;const u=a.getMergedCell(c,l);if(u){const g=(d=e.getValue(u.startRow,u.startColumn))==null?void 0:d.s;u.startRow!==t.startRow&&e.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}else{if(c!==t.endRow){const g=(m=e.getValue(c,l))==null?void 0:m.s;e.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{b:i.Tools.deepClone(n)}):{b:i.Tools.deepClone(n)}}})}if(c!==t.startRow){const g=(h=e.getValue(c,l))==null?void 0:h.s;e.setValue(c,l,{s:{bd:g!=null&&g.bd?Object.assign(g.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}}})};function vl(o){const{borderStyle:t,tl_br:e,tl_bc:n,tl_mr:s,bl_tr:r,ml_tr:a,bc_tr:c}=o,l=(u,d,m)=>{Ho(o,u,d,m)};e&&l(o.range,{tl_br:i.Tools.deepClone(t)},!0),n&&l(o.range,{tl_bc:i.Tools.deepClone(t)},!0),s&&l(o.range,{tl_mr:i.Tools.deepClone(t)},!0),r&&l(o.range,{bl_tr:i.Tools.deepClone(t)},!0),a&&l(o.range,{ml_tr:i.Tools.deepClone(t)},!0),c&&l(o.range,{bc_tr:i.Tools.deepClone(t)},!0)}const wl=o=>{const{top:t,left:e,right:n,bottom:s,borderStyle:r,bottomRange:a,topRange:c,leftRange:l,rightRange:u,bottomRangeOut:d,topRangeOut:m,leftRangeOut:h,rightRangeOut:g}=o,R=(C,f,p)=>{Ho(o,C,f,p)};t&&(R(m,{b:null}),R(c,{t:i.Tools.deepClone(r)},!0)),s&&(R(d,{t:null}),R(a,{b:i.Tools.deepClone(r)},!0)),e&&(R(h,{r:null}),R(l,{l:i.Tools.deepClone(r)},!0)),n&&(R(g,{l:null}),R(u,{r:i.Tools.deepClone(r)},!0))},Ml=o=>{const{range:t,worksheet:e,mr:n,top:s,bottom:r,left:a,right:c,vertical:l,horizontal:u,tl_br:d,tl_bc:m,tl_mr:h,bl_tr:g,ml_tr:R,bc_tr:C,topRange:f,bottomRange:p,leftRange:w,rightRange:I,topRangeOut:v,bottomRangeOut:M,leftRangeOut:_,rightRangeOut:E}=o,T=(U,b,k)=>{Ho(o,U,b,k)};!s&&!r&&!a&&!c&&!l&&!u&&!d&&!m&&!h&&!g&&!R&&!C&&(dn(t,(U,b)=>{var A,x,W,V,z,j,q,te;const k=e.getMergedCell(U,b);if(k){if(k.endColumn!==t.endColumn){const $=(A=n.getValue(k.startRow,k.startColumn))==null?void 0:A.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{r:null}):{r:null}}})}if(k.startColumn!==t.startColumn){const $=(x=n.getValue(k.startRow,k.startColumn))==null?void 0:x.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{l:null}):{l:null}}})}if(k.endRow!==t.endRow){const $=(W=n.getValue(k.startRow,k.startColumn))==null?void 0:W.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{b:null}):{b:null}}})}if(k.startRow!==t.startRow){const $=(V=n.getValue(k.startRow,k.startColumn))==null?void 0:V.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{t:null}):{t:null}}})}}else{if(b!==t.endColumn){const $=(z=n.getValue(U,b))==null?void 0:z.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{r:null}):{r:null}}})}if(b!==t.startColumn){const $=(j=n.getValue(U,b))==null?void 0:j.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{l:null}):{l:null}}})}if(U!==t.endRow){const $=(q=n.getValue(U,b))==null?void 0:q.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{b:null}):{b:null}}})}if(U!==t.startRow){const $=(te=n.getValue(U,b))==null?void 0:te.s;n.setValue(U,b,{s:{bd:$!=null&&$.bd?Object.assign($.bd,{t:null}):{t:null}}})}}}),T(v,{b:null}),T(f,{t:null},!0),T(M,{t:null}),T(p,{b:null},!0),T(_,{r:null}),T(w,{l:null},!0),T(E,{l:null}),T(I,{r:null},!0),T(t,{tl_br:null},!0),T(t,{tl_bc:null},!0),T(t,{tl_mr:null},!0),T(t,{bl_tr:null},!0),T(t,{ml_tr:null},!0),T(t,{bc_tr:null},!0))},Ut={id:"sheet.command.set-border",type:i.CommandType.COMMAND,handler:(o,t)=>{var p;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=o.get(exports.SheetsSelectionsService),a=o.get(ot),c=P(s,t);if(!c)return!1;const l=(t==null?void 0:t.ranges)||((p=r.getCurrentSelections())==null?void 0:p.map(w=>w.range));if(!(l!=null&&l.length))return!1;const{activeBorderType:u}=a.getBorderInfo();if(!u)return!1;const d=pl(a,c,l);Il(d),wl(d),vl(d),Ml(d);const{unitId:m,subUnitId:h,mr:g}=d,R={unitId:m,subUnitId:h,cellValue:g.getData()},C=me(o,R);return e.syncExecuteCommand(B.id,R)?(n.pushUndoRedo({unitID:m,undoMutations:[{id:B.id,params:C}],redoMutations:[{id:B.id,params:R}]}),!0):!1}},Hr={id:"sheet.command.set-border-position",type:i.CommandType.COMMAND,handler:(o,t)=>{if(!t.value)return!1;const e=o.get(i.ICommandService);return o.get(ot).setType(t.value),e.syncExecuteCommand(Ut.id)}},jr={id:"sheet.command.set-border-style",type:i.CommandType.COMMAND,handler:(o,t)=>{const e=o.get(i.ICommandService);return o.get(ot).setStyle(t.value),e.syncExecuteCommand(Ut.id)}},Gr={id:"sheet.command.set-border-color",type:i.CommandType.COMMAND,handler:(o,t)=>{const e=o.get(i.ICommandService);return o.get(ot).setColor(t.value),e.syncExecuteCommand(Ut.id)}},zr={id:"sheet.command.set-border-basic",type:i.CommandType.COMMAND,handler:(o,t)=>{const{unitId:e,subUnitId:n,value:s,ranges:r}=t,{type:a,color:c,style:l}=s,u=o.get(i.ICommandService),d=o.get(ot);return d.setType(a),c&&d.setColor(c),d.setStyle(l),u.syncExecuteCommand(Ut.id,{unitId:e,subUnitId:n,ranges:r})}},qr={type:i.CommandType.COMMAND,id:"sheet.command.set-col-data",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=P(s,t);if(!r)return!1;const{columnData:a}=t,{unitId:c,subUnitId:l,worksheet:u}=r,d={subUnitId:l,unitId:c,columnData:a},m=Es(d,u);return e.syncExecuteCommand(rt.id,d)?(n.pushUndoRedo({unitID:c,undoMutations:[{id:rt.id,params:m}],redoMutations:[{id:rt.id,params:d}]}),!0):!1}},yt={type:i.CommandType.COMMAND,id:"sheet.command.set-col-visible-on-cols",handler:(o,t)=>{var p,w;const{unitId:e,subUnitId:n,ranges:s}=t,r=o.get(exports.SheetInterceptorService),a=o.get(i.ICommandService),c=o.get(i.IUniverInstanceService),l=P(c,{unitId:e,subUnitId:n});if(!l)return!1;const{worksheet:u}=l,d={unitId:e,subUnitId:n,ranges:s},m={unitId:e,subUnitId:n,reveal:!0,selections:s.map(I=>({range:I,primary:oe(I,u),style:null}))},h=Ra(o,d),g={unitId:e,subUnitId:n,selections:Yr(s).map(I=>({range:I,primary:oe(I,u),style:null}))},R=i.sequenceExecute([{id:St.id,params:d},{id:G.id,params:m}],a),C=r.onCommandExecute({id:yt.id,params:t}),f=i.sequenceExecute([...C.redos],a);if(R.result&&f.result){const I=r.afterCommandExecute({id:yt.id,params:t});return i.sequenceExecute(I.redos,a),o.get(i.IUndoRedoService).pushUndoRedo({unitID:e,undoMutations:[{id:Ct.id,params:h},{id:G.id,params:g},...(p=C.undos)!=null?p:[],...I.undos],redoMutations:[...(w=C.preRedos)!=null?w:[],{id:St.id,params:d},{id:G.id,params:m},...C.redos,...I.redos]}),!0}return!0}},jo={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-cols-visible",handler:o=>{var u;const t=o.get(exports.SheetsSelectionsService),e=o.get(i.ICommandService),n=(u=t.getCurrentSelections())==null?void 0:u.map(d=>d.range).filter(d=>d.rangeType===i.RANGE_TYPE.COLUMN);if(!(n!=null&&n.length))return!1;const s=P(o.get(i.IUniverInstanceService));if(!s)return!1;const{worksheet:r,unitId:a,subUnitId:c}=s,l=n.map(d=>r.getHiddenCols(d.startColumn,d.endColumn)).flat();return e.executeCommand(yt.id,{unitId:a,subUnitId:c,ranges:l})}},mn={type:i.CommandType.COMMAND,id:"sheet.command.set-col-hidden",handler:(o,t)=>{var w,I,v,M;const e=o.get(exports.SheetsSelectionsService),n=o.get(exports.SheetInterceptorService),s=o.get(i.IUniverInstanceService),r=o.get(i.ICommandService);let a=(w=t==null?void 0:t.ranges)!=null&&w.length?t.ranges:(I=e.getCurrentSelections())==null?void 0:I.map(_=>_.range).filter(_=>_.rangeType===i.RANGE_TYPE.COLUMN);if(!(a!=null&&a.length))return!1;const c=P(s,t);if(!c)return!1;const{worksheet:l,unitId:u,subUnitId:d}=c;a=yl(c.worksheet,a);const m={unitId:u,subUnitId:d,ranges:a},h={unitId:u,subUnitId:d,selections:Yr(a).map(_=>({range:_,primary:oe(_,l),style:null}))},g=ga(o,m),R={unitId:u,subUnitId:d,reveal:!0,selections:a.map(_=>({range:_,primary:oe(_,l),style:null}))},C=i.sequenceExecute([{id:Ct.id,params:m},{id:G.id,params:h}],r),f=n.onCommandExecute({id:mn.id,params:m}),p=i.sequenceExecute([...f.redos],r);if(C.result&&p.result){const _=n.afterCommandExecute({id:mn.id,params:m});return i.sequenceExecute(_.redos,r),o.get(i.IUndoRedoService).pushUndoRedo({unitID:u,undoMutations:[{id:St.id,params:g},{id:G.id,params:R},...(v=f.undos)!=null?v:[],..._.undos],redoMutations:[...(M=f.preRedos)!=null?M:[],{id:Ct.id,params:m},{id:G.id,params:h},...f.redos,..._.redos]}),!0}return!1}};function yl(o,t){const e=o.getRowCount()-1,n=o.getHiddenCols(),s=[];return t.forEach(r=>{const a=n.filter(c=>c.startColumn>=r.startColumn&&c.endColumn<=r.endColumn);if(a.length){let c=r.startColumn;a.forEach(l=>{l.startColumn>c&&(s.push({startColumn:c,endColumn:l.startColumn-1,startRow:0,endRow:e}),c=l.endColumn+1)}),c<=r.endColumn&&s.push({startColumn:c,endColumn:r.endColumn,startRow:0,endRow:e})}else s.push(r)}),s}function Yr(o){return _l(o).map(e=>{const n=e.startColumn===0?e.endColumn+1:e.startColumn-1;return{...e,startColumn:n,endColumn:n}})}function _l(o){const t=[];let e;return o.sort((n,s)=>n.startColumn-s.startColumn).forEach(n=>{if(!e){e=n;return}e.endColumn===n.startColumn-1?e.endColumn=n.endColumn:(t.push(e),e=n)}),t.push(e),t}const Go={id:"sheet.command.set-defined-name",type:i.CommandType.COMMAND,handler:(o,t)=>{var m,h;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetInterceptorService);if(!t)return!1;const r={...t},a=Y.SetDefinedNameMutationFactory(o,t),c=s.onCommandExecute({id:Go.id,params:t}),l=[...(m=c.preRedos)!=null?m:[],{id:Y.RemoveDefinedNameMutation.id,params:a},{id:Y.SetDefinedNameMutation.id,params:r},...c.redos],u=[...(h=c.preUndos)!=null?h:[],{id:Y.RemoveDefinedNameMutation.id,params:r},{id:Y.SetDefinedNameMutation.id,params:a},...c.undos];return i.sequenceExecute(l,e)?(n.pushUndoRedo({unitID:t.unitId,undoMutations:u.filter(Boolean),redoMutations:l.filter(Boolean)}),!0):!1}},zo=(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(s==null)throw new Error("worksheet is null error!");const a=s.getConfig().freeze;return{unitId:t.unitId,subUnitId:t.subUnitId,...a}},Pe={id:"sheet.mutation.set-frozen",type:i.CommandType.MUTATION,handler:(o,t)=>{const n=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const s=n.getSheetBySheetId(t.subUnitId);if(!s)return!1;const r=s.getConfig(),{startRow:a,startColumn:c,ySplit:l,xSplit:u}=t;return r.freeze={startRow:a,startColumn:c,ySplit:l,xSplit:u},!0}},Kr={type:i.CommandType.COMMAND,id:"sheet.command.set-frozen",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=P(s,{unitId:t.unitId,subUnitId:t.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:c,worksheet:l}=r,{startColumn:u,startRow:d,xSplit:m,ySplit:h}=t;if(d>=l.getRowCount()||u>=l.getColumnCount()||m>=l.getColumnCount()||h>=l.getRowCount())return!1;const g={unitId:a,subUnitId:c,...t},R=zo(o,g);return e.syncExecuteCommand(Pe.id,g)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:Pe.id,params:R}],redoMutations:[{id:Pe.id,params:g}]}),!0):!1}},Jr={type:i.CommandType.COMMAND,id:"sheet.command.cancel-frozen",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUniverInstanceService),s=o.get(i.IUndoRedoService),r=P(n,{unitId:t==null?void 0:t.unitId,subUnitId:t==null?void 0:t.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:c}=r,l={unitId:a,subUnitId:c,startRow:-1,startColumn:-1,xSplit:0,ySplit:0},u=zo(o,l);return e.syncExecuteCommand(Pe.id,l)&&s.pushUndoRedo({unitID:a,undoMutations:[{id:Pe.id,params:u}],redoMutations:[{id:Pe.id,params:l}]}),!0}},Xr={type:i.CommandType.COMMAND,id:"sheet.command.set-gridlines-color",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=P(s);if(!r)return!1;const{worksheet:a}=r,c=a.getConfig().gridlinesColor;if(c===(t==null?void 0:t.color))return!1;const{unitId:l,subUnitId:u}=r,d={color:t==null?void 0:t.color,unitId:l,subUnitId:u},m={color:c,unitId:l,subUnitId:u};return e.syncExecuteCommand(it.id,d)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:it.id,params:m}],redoMutations:[{id:it.id,params:d}]}),!0):!1}},Z={id:"sheet.mutation.set-range-protection",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,rule:s,ruleId:r}=t;return o.get(J).setRule(e,n,r,s),!0}},bl=(o,t)=>{const{unitId:e,subUnitId:n,ruleId:s}=t,a=o.get(J).getRule(e,n,s);return a?{id:Z.id,params:{...t,rule:a}}:null},Ye={id:"sheet.mutation.set-worksheet-protection",type:i.CommandType.MUTATION,handler:(o,t)=>{const{unitId:e,subUnitId:n,rule:s}=t;return o.get(Oe).setRule(e,n,s),!0}},Zr={type:i.CommandType.COMMAND,id:"sheet.command.set-protection",async handler(o,t){if(!t)return!1;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(J),{rule:r,oldRule:a}=t,{unitId:c,subUnitId:l}=r,u=[],d=[];return(a==null?void 0:a.unitType)===r.unitType?r.unitType===N.Worksheet?(u.push({id:Ye.id,params:{unitId:c,subUnitId:l,rule:r}}),d.push({id:Ye.id,params:{unitId:c,subUnitId:l,rule:a}})):(u.push({id:Z.id,params:{unitId:c,subUnitId:l,rule:r,ruleId:r.id}}),d.push({id:Z.id,params:{unitId:c,subUnitId:l,ruleId:a.id,rule:a}})):(a&&(a.unitType===N.Worksheet?(u.push({id:ze.id,params:{unitId:c,subUnitId:l}}),d.push({id:xe.id,params:{unitId:c,rule:a,subUnitId:a.subUnitId}})):a.unitType===N.SelectRange&&(u.push({id:ke.id,params:{unitId:c,subUnitId:l,ruleIds:[a.id]}}),d.push({id:fe.id,params:{unitId:c,subUnitId:l,rules:[a]}}))),r.unitType===N.Worksheet?(u.push({id:xe.id,params:{unitId:c,rule:r,subUnitId:r.subUnitId}}),d.unshift({id:ze.id,params:{unitId:c,subUnitId:l}})):r.unitType===N.SelectRange&&(r.id=s.createRuleId(c,l),u.push({id:fe.id,params:{unitId:c,subUnitId:l,rules:[r]}}),d.unshift({id:ke.id,params:{unitId:c,subUnitId:l,ruleIds:[r.id]}}))),i.sequenceExecute(u,e)&&n.pushUndoRedo({unitID:c,undoMutations:d,redoMutations:u}),!0}},Qr={type:i.CommandType.COMMAND,id:"sheet.command.set-row-data",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=P(s,t);if(!r)return!1;const{rowData:a}=t,{unitId:c,subUnitId:l,worksheet:u}=r,d={subUnitId:l,unitId:c,rowData:a},m=Us(d,u);return e.syncExecuteCommand(at.id,d)?(n.pushUndoRedo({unitID:c,undoMutations:[{id:at.id,params:m}],redoMutations:[{id:at.id,params:d}]}),!0):!1}},_t={type:i.CommandType.COMMAND,id:"sheet.command.set-specific-rows-visible",handler:(o,t)=>{var p,w,I;const{unitId:e,subUnitId:n,ranges:s}=t,r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(exports.SheetInterceptorService),l=P(o.get(i.IUniverInstanceService),{unitId:e,subUnitId:n});if(!l)return!1;const{worksheet:u}=l,d={unitId:e,subUnitId:n,ranges:s},m={unitId:e,subUnitId:n,reveal:!0,selections:s.map(v=>({range:v,primary:oe(v,u),style:null}))},h=_a(o,d),g={unitId:e,subUnitId:n,selections:ei(s).map(v=>({range:v,primary:oe(v,u),style:null}))},R=i.sequenceExecute([{id:Ke.id,params:d},{id:G.id,params:m}],r),C=c.onCommandExecute({id:_t.id,params:t}),f=i.sequenceExecute([...C.redos],r);if(R.result&&f.result){const v=c.afterCommandExecute({id:_t.id,params:t});return i.sequenceExecute(v.redos,r),a.pushUndoRedo({unitID:e,undoMutations:[...(p=C.preUndos)!=null?p:[],{id:Je.id,params:h},{id:G.id,params:g},...(w=C.undos)!=null?w:[],...v.undos],redoMutations:[...(I=C.preRedos)!=null?I:[],{id:Ke.id,params:d},{id:G.id,params:m},...C.redos,...v.redos]}),!0}return!0}},qo={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-rows-visible",handler:async o=>{var d;const t=o.get(exports.SheetsSelectionsService),e=o.get(i.IUniverInstanceService),n=o.get(i.ICommandService),s=(d=t.getCurrentSelections())==null?void 0:d.map(m=>m.range).filter(m=>m.rangeType===i.RANGE_TYPE.ROW);if(!(s!=null&&s.length))return!1;const r=P(e);if(!r)return!1;const{worksheet:a,unitId:c,subUnitId:l}=r,u=s.map(m=>a.getHiddenRows(m.startRow,m.endRow)).flat();return n.executeCommand(_t.id,{unitId:c,subUnitId:l,ranges:u})}},hn={type:i.CommandType.COMMAND,id:"sheet.command.set-rows-hidden",handler:(o,t)=>{var w,I,v,M,_,E;const e=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(i.IUniverInstanceService),a=o.get(exports.SheetInterceptorService);let c=(w=t==null?void 0:t.ranges)!=null&&w.length?t.ranges:(I=e.getCurrentSelections())==null?void 0:I.map(T=>T.range).filter(T=>T.rangeType===i.RANGE_TYPE.ROW);if(!(c!=null&&c.length))return!1;const l=P(r,t);if(!l)return!1;c=El(l.worksheet,c);const{unitId:u,subUnitId:d,worksheet:m}=l,h={unitId:u,subUnitId:d,ranges:c},g={unitId:u,subUnitId:d,selections:ei(c).map(T=>({range:T,primary:oe(T,m),style:null}))},R=ba(o,h),C={unitId:u,subUnitId:d,reveal:!0,selections:c.map(T=>({range:T,primary:oe(T,m),style:null}))},f=a.onCommandExecute({id:hn.id,params:h});if(i.sequenceExecute([...(v=f.preRedos)!=null?v:[],{id:Je.id,params:h},{id:G.id,params:g},...f.redos],n).result){const T=a.afterCommandExecute({id:hn.id,params:h});return i.sequenceExecute(T.redos,n),s.pushUndoRedo({unitID:u,undoMutations:[...(M=f.preUndos)!=null?M:[],{id:Ke.id,params:R},{id:G.id,params:C},...(_=f.undos)!=null?_:[],...T.undos],redoMutations:[...(E=f.preRedos)!=null?E:[],{id:Je.id,params:h},{id:G.id,params:g},...f.redos,...T.redos]}),!0}return!0}};function El(o,t){const e=o.getMaxColumns()-1,n=o.getHiddenRows(),s=[];return t.forEach(r=>{const a=n.filter(c=>c.startRow>=r.startRow&&c.endRow<=r.endRow);if(a.length){let c=r.startRow;a.forEach(l=>{l.startRow>c&&(s.push({startRow:c,endRow:l.startRow-1,startColumn:0,endColumn:e}),c=l.endRow+1)}),c<=r.endRow&&s.push({startRow:c,endRow:r.endRow,startColumn:0,endColumn:e})}else s.push(r)}),s}function ei(o){return Tl(o).map(e=>{const n=e.startRow===0?e.endRow+1:e.startRow-1;return{...e,startRow:n,endRow:n}})}function Tl(o){const t=[];let e;return o.sort((n,s)=>n.startRow-s.startRow).forEach(n=>{if(!e){e=n;return}n.startRow===e.endRow+1?e.endRow=n.endRow:(t.push(e),e=n)}),t.push(e),t}const Ul=["ff","fs","tr","tb"],Q={type:i.CommandType.COMMAND,id:"sheet.command.set-style",handler:(o,t)=>{var U;const e=o.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{unitId:s,subUnitId:r,worksheet:a}=n,{range:c,style:l}=t,u=o.get(i.ICommandService),d=o.get(i.IUndoRedoService),m=o.get(exports.SheetsSelectionsService),h=c?[c]:(U=m.getCurrentSelections())==null?void 0:U.map(b=>b.range);if(!(h!=null&&h.length))return!1;const g=new i.ObjectMatrix,R=lc(a);if(i.Tools.isArray(l.value))for(let b=0;b<h.length;b++)R.forOperableEach(h[b],(k,A,x)=>{g.setValue(k,A,{s:{[l.type]:l.value[k-x.startRow][A-x.startColumn]}})});else for(let b=0;b<h.length;b++){const k={s:{[l.type]:l.value}};R.forOperableEach(h[b],(A,x)=>g.setValue(A,x,k))}const C={subUnitId:r,unitId:s,cellValue:g.getMatrix()},f=o.get(exports.SheetSkeletonService).getSkeleton(s,r),p=me(o,C),w=u.syncExecuteCommand(B.id,C),I=o.get(exports.SheetInterceptorService);let v=[],M=[];if(Ul.includes(t==null?void 0:t.style.type)){const{suitableRanges:b,remainingRanges:k}=Kt(h,f),A=Oo(b,a),{undos:x,redos:W}=I.generateMutationsOfAutoHeight({unitId:s,subUnitId:r,ranges:b,autoHeightRanges:b,lazyAutoHeightRanges:k,cellHeights:A});v=x,M=W}const{undos:_,redos:E}=I.onCommandExecute({id:Q.id,params:t}),T=i.sequenceExecute([...E,...M],u);return w&&T.result?(d.pushUndoRedo({unitID:C.unitId,undoMutations:[{id:B.id,params:p},..._,...v],redoMutations:[{id:B.id,params:C},...E,...M]}),!0):!1}},Pl={type:i.CommandType.COMMAND,id:"sheet.command.set-bold",handler:o=>{const t=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(o.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e,{actualRow:s,actualColumn:r}=t.primary,c={style:{type:"bl",value:n.getRange(s,r).getFontWeight()===i.FontWeight.BOLD?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,c)}},kl={type:i.CommandType.COMMAND,id:"sheet.command.set-italic",handler:o=>{const t=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(o.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let s=!0;if(t.primary){const{startRow:a,startColumn:c}=t.primary;s=n.getRange(a,c).getFontStyle()===i.FontItalic.ITALIC}const r={style:{type:"it",value:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},Nl={type:i.CommandType.COMMAND,id:"sheet.command.set-underline",handler:o=>{const t=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(o.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let s=!0;t.primary&&(s=!!n.getRange(t.primary.startRow,t.primary.startColumn).getUnderline().s);const r={style:{type:"ul",value:{s:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},Ol={type:i.CommandType.COMMAND,id:"sheet.command.set-stroke",handler:o=>{const t=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(o.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let s=!0;t.primary&&(s=!!n.getRange(t.primary.actualRow,t.primary.actualColumn).getStrikeThrough().s);const r={style:{type:"st",value:{s:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},Dl={type:i.CommandType.COMMAND,id:"sheet.command.set-overline",handler:o=>{const t=o.get(exports.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(o.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let s=!0;t.primary&&(s=!!n.getRange(t.primary.startRow,t.primary.startColumn).getOverline().s);const r={style:{type:"ol",value:{s:s?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return o.get(i.ICommandService).syncExecuteCommand(Q.id,r)}},Al={type:i.CommandType.COMMAND,id:"sheet.command.set-font-family",handler:(o,t)=>{if(!t)return!1;const e=o.get(i.ICommandService),n={style:{type:"ff",value:t.value}};return e.syncExecuteCommand(Q.id,n)}},xl={type:i.CommandType.COMMAND,id:"sheet.command.set-font-size",handler:(o,t)=>{if(!t)return!1;const e=o.get(i.ICommandService),n={style:{type:"fs",value:t.value}};return e.syncExecuteCommand(Q.id,n)}},ti={type:i.CommandType.COMMAND,id:"sheet.command.set-text-color",handler:(o,t)=>{if(!t)return!1;const e=o.get(i.ICommandService),n={style:{type:"cl",value:{rgb:t.value}}};return e.syncExecuteCommand(Q.id,n)}},ni={type:i.CommandType.COMMAND,id:"sheet.command.reset-text-color",handler:o=>{const t=o.get(i.ICommandService),e={style:{type:"cl",value:{rgb:null}}};return t.syncExecuteCommand(Q.id,e)}},oi={type:i.CommandType.COMMAND,id:"sheet.command.set-background-color",handler:(o,t)=>{if(!t||!t.value)return!1;const e=o.get(i.ICommandService),n={style:{type:"bg",value:{rgb:t.value}}};return e.syncExecuteCommand(Q.id,n)}},si={type:i.CommandType.COMMAND,id:"sheet.command.reset-background-color",handler:o=>{const t=o.get(i.ICommandService),e={style:{type:"bg",value:{rgb:null}}};return t.syncExecuteCommand(Q.id,e)}},ri={type:i.CommandType.COMMAND,id:"sheet.command.set-vertical-text-align",handler:(o,t)=>{if(!t)return!1;const e=o.get(i.ICommandService),n={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"vt",value:t.value}};return e.syncExecuteCommand(Q.id,n)}},ii={type:i.CommandType.COMMAND,id:"sheet.command.set-horizontal-text-align",handler:(o,t)=>{if(!t)return!1;const e=o.get(i.ICommandService),n={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"ht",value:t.value}};return e.syncExecuteCommand(Q.id,n)}},ai={type:i.CommandType.COMMAND,id:"sheet.command.set-text-wrap",handler:(o,t)=>{if(!t)return!1;const e=o.get(i.ICommandService),n={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"tb",value:t.value}};return e.syncExecuteCommand(Q.id,n)}},ci={type:i.CommandType.COMMAND,id:"sheet.command.set-text-rotation",handler:(o,t)=>{if(!t)return!1;const e=typeof t.value=="number"?{a:t.value}:{a:0,v:i.BooleanNumber.TRUE},n=o.get(i.ICommandService),s={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"tr",value:e}};return n.syncExecuteCommand(Q.id,s)}},Wl=(o,t)=>{const r=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().tabColor;return{...i.Tools.deepClone(t),color:r}},Ot={id:"sheet.mutation.set-tab-color",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getSheetBySheetId(t.subUnitId);return n?(n.getConfig().tabColor=t.color,!0):!1}},li={type:i.CommandType.COMMAND,id:"sheet.command.set-tab-color",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=P(o.get(i.IUniverInstanceService));if(!s)return!1;const{unitId:r,subUnitId:a}=s,c={color:t.value,unitId:r,subUnitId:a},l=Wl(o,c);return e.syncExecuteCommand(Ot.id,c)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:Ot.id,params:l}],redoMutations:[{id:Ot.id,params:c}]}),!0):!1}},Yo={id:"sheet.mutation.set-workbook-name",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService).getUnit(t.unitId,i.UniverInstanceType.UNIVER_SHEET);return e?(e.setName(t.name),!0):!1}},Ko={type:i.CommandType.COMMAND,id:"sheet.command.set-workbook-name",handler:(o,t)=>{var l;const e=o.get(i.ICommandService),n=o.get(exports.SheetInterceptorService);if(!qn(o.get(i.IUniverInstanceService),t))return!1;const r=n.onCommandExecute({id:Ko.id,params:t}),a={name:t.name,unitId:t.unitId},c=[...(l=r.preRedos)!=null?l:[],{id:Yo.id,params:a},...r.redos];return i.sequenceExecute(c,e).result}},Vl=4,Jo={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-activate",handler:(o,t,e)=>{const n=o.get(i.ICommandService),s=P(o.get(i.IUniverInstanceService),t);if(!s)return!1;const{unitId:r,subUnitId:a}=s;return new Promise(c=>{setTimeout(()=>{const l=n.syncExecuteCommand(bt.id,{unitId:r,subUnitId:a},e);c(l)},Vl)})}},Vt={type:i.CommandType.COMMAND,id:"sheet.command.delta-column-width",handler:async(o,t)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections();if(!(n!=null&&n.length))return!1;const s=o.get(i.ICommandService),r=o.get(i.IUndoRedoService),a=P(o.get(i.IUniverInstanceService));if(!a)return!1;const{worksheet:c,unitId:l,subUnitId:u}=a,{anchorCol:d,deltaX:m}=t,g=c.getColumnWidth(d)+m,R=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,C=n.filter(V=>V.range.rangeType===i.RANGE_TYPE.COLUMN),f=R?i.RANGE_TYPE.ALL:C.some(({range:V})=>{const{startColumn:z,endColumn:j}=V;return z<=d&&d<=j})?i.RANGE_TYPE.COLUMN:i.RANGE_TYPE.NORMAL;let p;if(f===i.RANGE_TYPE.ALL){const V=c.getRowCount(),z=new Array(c.getColumnCount()).fill(void 0).map((j,q)=>({startRow:0,endRow:V-1,startColumn:q,endColumn:q}));p={subUnitId:u,unitId:l,colWidth:g,ranges:z}}else f===i.RANGE_TYPE.COLUMN?p={subUnitId:u,unitId:l,ranges:C.map(V=>i.Rectangle.clone(V.range)),colWidth:g}:p={subUnitId:u,unitId:l,colWidth:g,ranges:[{startRow:0,endRow:c.getMaxRows()-1,startColumn:d,endColumn:d}]};const w=o.get(exports.SheetSkeletonService).getSkeleton(l,u),{suitableRanges:I,remainingRanges:v}=Kt(p.ranges,w);Oo(I,c);const M=o.get(exports.SheetInterceptorService),{undos:_,redos:E}=M.onCommandExecute({id:Vt.id,params:p}),T=Yn(p,c),U=s.syncExecuteCommand(Ae.id,p),{undos:b,redos:k}=M.generateMutationsOfAutoHeight({unitId:l,subUnitId:u,ranges:I,autoHeightRanges:I,lazyAutoHeightRanges:v}),{undos:A,redos:x}=o.get(exports.SheetInterceptorService).afterCommandExecute({id:Vt.id,params:p}),W=i.sequenceExecute([...E,...x,...k],s);return U&&W.result&&r.pushUndoRedo({unitID:l,undoMutations:[{id:Ae.id,params:T},..._,...A,...b],redoMutations:[{id:Ae.id,params:p},...E,...x,...k]}),!0}},$t={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-col-width",handler:(o,t)=>{var M,_,E,T;const e=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(exports.SheetInterceptorService),a=(M=t==null?void 0:t.ranges)!=null&&M.length?t.ranges:(_=e.getCurrentSelections())==null?void 0:_.map(U=>U.range);if(!(a!=null&&a.length))return!1;const c=P(o.get(i.IUniverInstanceService),t);if(!c)return!1;const{subUnitId:l,unitId:u,worksheet:d}=c,m=o.get(exports.SheetSkeletonService).getSkeleton(u,l),h={subUnitId:l,unitId:u,ranges:a,colWidth:t.value},{suitableRanges:g,remainingRanges:R}=Kt(h.ranges,m);Oo(g,d);const C=Yn(h,d),f=n.syncExecuteCommand(Ae.id,h),{undos:p,redos:w}=r.generateMutationsOfAutoHeight({unitId:u,subUnitId:l,ranges:g,autoHeightRanges:g,lazyAutoHeightRanges:R}),I=r.onCommandExecute({id:$t.id,params:h}),v=i.sequenceExecute([...I.redos,...w],n);if(f&&v.result){const U=r.afterCommandExecute({id:$t.id,params:h});return i.sequenceExecute(U.redos,n),s.pushUndoRedo({unitID:u,undoMutations:[...(E=I.preUndos)!=null?E:[],{id:Ae.id,params:C},...I.undos,...U.undos,...p],redoMutations:[...(T=I.preRedos)!=null?T:[],{id:Ae.id,params:h},...I.redos,...U.redos,...w]}),!0}return!1}};i.CommandType.COMMAND;const ui={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-column-count",handler:(o,t)=>{const{unitId:e,subUnitId:n,columnCount:s}=t,r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(i.IUniverInstanceService);if(!P(c,t))return!1;const u={unitId:e,subUnitId:n,columnCount:s},d=Ps(o,u);return r.syncExecuteCommand(ct.id,u)?(a.pushUndoRedo({unitID:e,undoMutations:[{id:ct.id,params:d}],redoMutations:[{id:ct.id,params:u}]}),!0):!1}},di={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-default-style",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{unitId:s}=t,r=ks(o,t);return e.syncExecuteCommand(lt.id,t)?(n.pushUndoRedo({unitID:s,undoMutations:[{id:lt.id,params:r}],redoMutations:[{id:lt.id,params:t}]}),!0):!1}},mi=(o,t)=>{const e=_e(o.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetHideMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{hidden:n.isSheetHidden(),unitId:t.unitId,subUnitId:n.getSheetId()}},Fe={id:"sheet.mutation.set-worksheet-hidden",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(e==null)return!1;const n=e.getSheetBySheetId(t.subUnitId);return n?(n.getConfig().hidden=t.hidden,!0):!1}},hi={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-hidden",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.ErrorService),r=o.get(i.LocaleService),a=P(o.get(i.IUniverInstanceService),t);if(!a)return!1;const{workbook:c,worksheet:l,unitId:u,subUnitId:d}=a;if(l.getConfig().hidden===i.BooleanNumber.TRUE)return!1;const h={unitId:u,subUnitId:d,hidden:i.BooleanNumber.TRUE},g=mi(o,h);return c.getSheets().filter(p=>p.getConfig().hidden===i.BooleanNumber.FALSE).length===1?(s.emit(r.t("sheets.info.hideSheet")),!1):e.syncExecuteCommand(Fe.id,h)?(n.pushUndoRedo({unitID:u,undoMutations:[{id:Fe.id,params:g}],redoMutations:[{id:Fe.id,params:h}]}),!0):!1}},$l=(o,t)=>{const e=_e(o.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetNameMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,name:n.getName(),subUnitId:n.getSheetId()}},Lt={id:"sheet.mutation.set-worksheet-name",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(e==null)return!1;const n=e.getSheetBySheetId(t.subUnitId);return n?(n.getConfig().name=t.name,!0):!1}},On={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-name",handler:(o,t)=>{var R,C;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetInterceptorService),r=P(o.get(i.IUniverInstanceService),t);if(!r)return!1;const{unitId:a,subUnitId:c}=r,l={subUnitId:c,name:t.name,unitId:a},u=$l(o,l),d=s.onCommandExecute({id:On.id,params:t}),m=[...(R=d.preRedos)!=null?R:[],{id:Lt.id,params:l},...d.redos],h=[...(C=d.preUndos)!=null?C:[],{id:Lt.id,params:u},...d.undos];return i.sequenceExecute(m,e).result?(n.pushUndoRedo({unitID:a,undoMutations:h,redoMutations:m}),!0):!1}},Ll=(o,t)=>({...i.Tools.deepClone(t),toOrder:t.fromOrder,fromOrder:t.toOrder}),Dt={id:"sheet.mutation.set-worksheet-order",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getConfig();return n.sheetOrder.splice(t.fromOrder,1),n.sheetOrder.splice(t.toOrder,0,t.subUnitId),!0}},Xo={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-order",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=P(o.get(i.IUniverInstanceService),t);if(!s)return!1;const{workbook:r,unitId:a,subUnitId:c}=s,u={fromOrder:r.getConfig().sheetOrder.indexOf(c),toOrder:t.order,unitId:a,subUnitId:c},d=Ll(o,u);return e.syncExecuteCommand(Dt.id,u)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:Dt.id,params:d}],redoMutations:[{id:Dt.id,params:u}]}),!0):!1}},gi={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-permission-points",async handler(o,t){if(!t)return!1;const e=o.get(i.ICommandService),{rule:n}=t;return e.executeCommand(Un.id,{rule:n,unitId:n.unitId,subUnitId:n.subUnitId}),!0}},Ri={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-protection",async handler(o,t){if(!t)return!1;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),{rule:s,permissionId:r,oldRule:a}=t,{unitId:c,subUnitId:l}=s,u={...s,permissionId:r};if(await e.executeCommand(Ye.id,{unitId:c,subUnitId:l,newRule:u})){const m=[{id:Ye.id,params:{unitId:c,subUnitId:l,newRule:u}}],h=[{id:Ye.id,params:{unitId:c,subUnitId:l,rule:a}}];n.pushUndoRedo({unitID:c,redoMutations:m,undoMutations:h})}return!0}},Bl=(o,t)=>{const r=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().rightToLeft;return{...i.Tools.deepClone(t),rightToLeft:r}},rn={id:"sheet.mutation.set-worksheet-right-to-left",type:i.CommandType.MUTATION,handler:(o,t)=>{const e=o.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getSheetBySheetId(t.subUnitId);if(!n)return!1;const s=n.getConfig();return s.rightToLeft=t.rightToLeft,!0}},Fl={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-right-to-left",handler:async(o,t)=>{var m;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=P(o.get(i.IUniverInstanceService),t);if(!s)return!1;const{unitId:r,subUnitId:a}=s;let c=i.BooleanNumber.FALSE;t&&(c=(m=t.rightToLeft)!=null?m:i.BooleanNumber.FALSE);const l={rightToLeft:c,unitId:r,subUnitId:a},u=Bl(o,l);return e.syncExecuteCommand(rn.id,l)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:rn.id,params:u}],redoMutations:[{id:rn.id,params:l}]}),!0):!1}},Ci={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-row-count",handler:(o,t)=>{const{unitId:e,subUnitId:n,rowCount:s}=t,r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(i.IUniverInstanceService);if(!P(c,t))return!1;const u={unitId:e,subUnitId:n,rowCount:s},d=Ns(o,u);return r.syncExecuteCommand(ut.id,u)?(a.pushUndoRedo({unitID:e,undoMutations:[{id:ut.id,params:d}],redoMutations:[{id:ut.id,params:u}]}),!0):!1}},Bt={type:i.CommandType.COMMAND,id:"sheet.command.delta-row-height",handler:async(o,t)=>{var U,b;const n=o.get(exports.SheetsSelectionsService).getCurrentSelections(),s=o.get(exports.SheetInterceptorService);if(!(n!=null&&n.length))return!1;const r=P(o.get(i.IUniverInstanceService));if(!r)return!1;const{worksheet:a,subUnitId:c,unitId:l}=r,{anchorRow:u,deltaY:d}=t,h=a.getRowHeight(u)+d,g=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,R=n.filter(k=>k.range.rangeType===i.RANGE_TYPE.ROW),C=g?i.RANGE_TYPE.ALL:R.some(({range:k})=>{const{startRow:A,endRow:x}=k;return A<=u&&u<=x})?i.RANGE_TYPE.ROW:i.RANGE_TYPE.NORMAL;let f;if(C===i.RANGE_TYPE.ALL){const k=a.getColumnCount(),A=new Array(a.getRowCount()).fill(void 0).map((x,W)=>({startRow:W,endRow:W,startColumn:0,endColumn:k-1}));f={subUnitId:c,unitId:l,rowHeight:h,ranges:A}}else C===i.RANGE_TYPE.ROW?f={subUnitId:c,unitId:l,ranges:R.map(k=>i.Rectangle.clone(k.range)),rowHeight:h}:f={subUnitId:c,unitId:l,rowHeight:h,ranges:[{startRow:u,endRow:u,startColumn:0,endColumn:a.getMaxColumns()-1}]};const p=Os(f,a),w={unitId:l,subUnitId:c,ranges:f.ranges,autoHeightInfo:i.BooleanNumber.FALSE},I=Kn(w,a),v=o.get(i.ICommandService),M=o.get(i.IUndoRedoService),_=s.onCommandExecute({id:Bt.id,params:f}),E=i.sequenceExecute([{id:Te.id,params:f},{id:Se.id,params:w}],v),T=i.sequenceExecute([..._.redos],v);if(E.result&&T.result){const k=s.afterCommandExecute({id:Bt.id,params:f});return i.sequenceExecute(k.redos,v),M.pushUndoRedo({unitID:l,undoMutations:[...(U=_.preUndos)!=null?U:[],{id:Te.id,params:p},{id:Se.id,params:I},..._.undos,...k.undos],redoMutations:[...(b=_.preRedos)!=null?b:[],{id:Te.id,params:f},{id:Se.id,params:w},..._.redos,...k.redos]}),!0}return!1}},Ft={type:i.CommandType.COMMAND,id:"sheet.command.set-row-height",handler:(o,t)=>{var I,v,M,_;const e=o.get(exports.SheetsSelectionsService),n=o.get(i.ICommandService),s=o.get(i.IUndoRedoService),r=o.get(i.IUniverInstanceService),a=o.get(exports.SheetInterceptorService),c=(I=t==null?void 0:t.ranges)!=null&&I.length?t.ranges:(v=e.getCurrentSelections())==null?void 0:v.map(E=>E.range);if(!(c!=null&&c.length))return!1;const l=P(r,t);if(!l)return!1;const{unitId:u,subUnitId:d,worksheet:m}=l,h={subUnitId:d,unitId:u,ranges:c,rowHeight:t.value},g=Os(h,m),R={unitId:u,subUnitId:d,ranges:h.ranges,autoHeightInfo:i.BooleanNumber.FALSE},C=Kn(R,m),f=i.sequenceExecute([{id:Te.id,params:h},{id:Se.id,params:R}],n),p=a.onCommandExecute({id:Ft.id,params:h}),w=i.sequenceExecute([...p.redos],n);if(f.result&&w.result){const E=a.afterCommandExecute({id:Ft.id,params:h});return i.sequenceExecute(E.redos,n),s.pushUndoRedo({unitID:u,undoMutations:[...(M=p.preRedos)!=null?M:[],{id:Te.id,params:g},{id:Se.id,params:C},...p.undos,...E.undos],redoMutations:[...(_=p.preRedos)!=null?_:[],{id:Te.id,params:h},{id:Se.id,params:R},...p.redos,...E.redos]}),!0}return!1}},Dn={type:i.CommandType.COMMAND,id:"sheet.command.set-row-is-auto-height",handler:(o,t)=>{var E,T;const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(exports.SheetsSelectionsService),r=o.get(i.IUniverInstanceService),a=P(r,t);if(!a)return!1;const{unitId:c,subUnitId:l,worksheet:u}=a,d=(E=t==null?void 0:t.ranges)!=null&&E.length?t.ranges:(T=s.getCurrentSelections())==null?void 0:T.map(U=>U.range);if(!(d!=null&&d.length))return!1;const m={unitId:c,subUnitId:l,ranges:d,autoHeightInfo:i.BooleanNumber.TRUE},h=Kn(m,u),g=e.syncExecuteCommand(Se.id,m),R=o.get(exports.SheetSkeletonService).getSkeleton(c,l),{suitableRanges:C,remainingRanges:f}=Kt(m.ranges,R),p=o.get(exports.SheetInterceptorService),{undos:w,redos:I}=p.generateMutationsOfAutoHeight({unitId:c,subUnitId:l,ranges:C,autoHeightRanges:C,lazyAutoHeightRanges:f}),{undos:v,redos:M}=p.onCommandExecute({id:Dn.id,params:m}),_=i.sequenceExecute([...M,...I],e);return g&&_.result?(n.pushUndoRedo({unitID:c,undoMutations:[{id:Se.id,params:h},...v,...w],redoMutations:[{id:Se.id,params:m},...M,...I]}),!0):!1}},Zo={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-show",handler:(o,t)=>{const{unitId:e,subUnitId:n}=t,s=o.get(i.ICommandService),r=o.get(i.IUndoRedoService),a=o.get(i.IUniverInstanceService);if(!P(o.get(i.IUniverInstanceService)))return!1;const l=a.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return!1;const u=l.getSheetBySheetId(n);if(!u||u.getConfig().hidden===i.BooleanNumber.FALSE)return!1;const m={unitId:e,subUnitId:n,hidden:i.BooleanNumber.FALSE},h=mi(o,m),g=s.syncExecuteCommand(Fe.id,m),R={unitId:e,subUnitId:n},C=s.syncExecuteCommand(bt.id,R);return g&&C?(r.pushUndoRedo({unitID:e,undoMutations:[{id:Fe.id,params:h}],redoMutations:[{id:Fe.id,params:m}]}),!0):!1}},Si={type:i.CommandType.COMMAND,id:"sheet.command.split-text-to-columns",handler:(o,t)=>{const{unitId:e,subUnitId:n,range:s,delimiter:r,customDelimiter:a,treatMultipleDelimitersAsOne:c}=t,l=o.get(i.ICommandService),u=o.get(i.IUniverInstanceService),d=o.get(i.IUndoRedoService);if(!P(o.get(i.IUniverInstanceService)))return!1;const h=u.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!h)return!1;const g=h.getSheetBySheetId(n);if(!g)return!1;const{lastRow:R,rs:C,maxLength:f}=Ls(g,s,r,a,c),p=g.getColumnCount(),{startColumn:w}=i.Range.transformRange(s,g);if(s.startColumn!==s.endColumn)return!1;const I=[],v=[],M=w+f+1-p;if(M>0){const k={unitId:e,subUnitId:n,range:{startRow:0,endRow:g.getRowCount()-1,startColumn:p-1,endColumn:p-1+M}};I.push({id:ce.id,params:k});const A=Ht(o,k);v.push({id:ne.id,params:A})}const _={startRow:s.startRow,endRow:R,startColumn:w,endColumn:w+f},E=new i.ObjectMatrix;for(let k=_.startRow;k<=_.endRow;k++)for(let A=_.startColumn;A<=_.endColumn;A++){const x=C[k-_.startRow];A===0&&(x==null?void 0:x.length)===1?E.setValue(k,A,g.getCell(k,A)):E.setValue(k,A,{v:(x==null?void 0:x[A-_.startColumn])||null,p:null,f:null,si:null,custom:null})}const T={unitId:e,subUnitId:n,cellValue:E.clone()},U=me(o,T);return I.push({id:B.id,params:T}),v.unshift({id:B.id,params:U}),i.sequenceExecute(I,l).result?(d.pushUndoRedo({unitID:e,undoMutations:v,redoMutations:I}),!0):!1}},fi={id:"sheet.command.toggle-cell-checkbox",type:i.CommandType.COMMAND,handler:(o,t)=>{if(!t)return!1;const{unitId:e,subUnitId:n,row:s,col:r,paragraphIndex:a}=t,l=o.get(i.IUniverInstanceService).getUnit(e,i.UniverInstanceType.UNIVER_SHEET),u=l==null?void 0:l.getSheetBySheetId(n),d=o.get(i.IUndoRedoService),m=o.get(i.ICommandService);if(!u)return!1;const h=u.getCell(s,r);if(!(h!=null&&h.p))return!1;const g=i.Tools.deepClone(h.p),R=new i.DocumentDataModel(g),C=i.BuildTextUtils.paragraph.bullet.toggleChecklist({document:R,paragraphIndex:a});if(!C)return!1;i.TextX.apply(R.getBody(),C.serialize());const f={unitId:e,subUnitId:n,cellValue:{[s]:{[r]:{p:g,t:i.CellValueType.STRING}}}},p={id:B.id,params:f},w=me(o,f),I={id:B.id,params:w},v=[p],M=[I];return d.pushUndoRedo({redoMutations:v,undoMutations:M,unitID:e}),m.syncExecuteCommand(p.id,p.params)}},pi={type:i.CommandType.COMMAND,id:"sheet.command.toggle-gridlines",handler:(o,t)=>{const e=o.get(i.ICommandService),n=o.get(i.IUndoRedoService),s=o.get(i.IUniverInstanceService),r=P(s);if(!r)return!1;const{worksheet:a}=r,c=a.getConfig().showGridlines;if(c===(t==null?void 0:t.showGridlines))return!1;const{unitId:l,subUnitId:u}=r,d={showGridlines:c===i.BooleanNumber.TRUE?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE,unitId:l,subUnitId:u},m={showGridlines:c,unitId:l,subUnitId:u};return e.syncExecuteCommand(dt.id,d)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:dt.id,params:m}],redoMutations:[{id:dt.id,params:d}]}),!0):!1}},Ii={id:"sheet.command.unregister-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(o,t)=>{var h;if(!t)return!1;const{unitId:e,themeName:n}=t,s=o.get(i.IUniverInstanceService),r=o.get(i.ICommandService),a=o.get(i.IUndoRedoService),c=o.get(exports.SheetRangeThemeModel);if(!P(s))return!1;const u={unitId:e,themeName:n},d={unitId:e,themeName:n,rangeThemeStyleJson:(h=c.getRangeThemeStyle(e,n))==null?void 0:h.toJson()};return r.syncExecuteCommand(Mt.id,t)&&a.pushUndoRedo({unitID:e,undoMutations:[{id:Mt.id,params:d}],redoMutations:[{id:kn.id,params:u}]}),!0}},vi={id:"sheet.mutation.add-range-theme",type:i.CommandType.MUTATION,handler:(o,t)=>{if(!t)return!1;const{styleJSON:e,unitId:n}=t,s=o.get(exports.SheetRangeThemeModel),r=new We(e.name);return r.fromJson(e),s.registerRangeThemeStyle(n,r),!0}},wi={id:"sheet.mutation.empty",type:i.CommandType.MUTATION,handler:()=>!0},Mi={id:"sheet.operation.mark-dirty-row-auto-height",type:i.CommandType.OPERATION,handler:()=>!0},yi={id:"sheet.operation.cancel-mark-dirty-row-auto-height",type:i.CommandType.OPERATION,handler:()=>!0},tt=i.createIdentifier("INumfmtService"),Hl=(o,t)=>{const e=o.get(tt),{values:n,unitId:s,subUnitId:r}=t,a=[],c=[];Object.keys(n).forEach(u=>{n[u].ranges.forEach(m=>{i.Range.foreach(m,(h,g)=>{const R=e.getValue(s,r,h,g);R?a.push({pattern:R.pattern,row:h,col:g}):c.push({startColumn:g,endColumn:g,startRow:h,endRow:h})})})});const l=[];if(a.length){const u=gn(s,r,a);Object.keys(u.values).forEach(d=>{const m=u.values[d];m.ranges=Zn(m.ranges)}),l.push({id:An.id,params:gn(s,r,a)})}return c.length&&l.push({id:Qo.id,params:{unitId:s,subUnitId:r,ranges:c}}),l},An={id:"sheet.mutation.set.numfmt",type:i.CommandType.MUTATION,handler:(o,t)=>{if(!t)return!1;const{values:e,refMap:n}=t,s=o.get(tt),r=t.unitId,a=t.subUnitId,c=Object.keys(e).reduce((l,u)=>{const d=n[u],m=e[u].ranges;return d&&l.push({...d,ranges:m}),l},[]);return s.setValues(r,a,c),!0}},Qo={id:"sheet.mutation.remove.numfmt",type:i.CommandType.MUTATION,handler:(o,t)=>{if(!t)return!1;const{unitId:e,subUnitId:n,ranges:s}=t;return o.get(tt).deleteValues(e,n,s),!0}},jl=(o,t)=>{const e=o.get(tt),{ranges:n,unitId:s,subUnitId:r}=t,a=[];if(n.forEach(l=>{i.Range.foreach(l,(u,d)=>{const m=e.getValue(s,r,u,d);m&&a.push({pattern:m.pattern,row:u,col:d})})}),!a.length)return[];const c=gn(s,r,a);return Object.keys(c.values).forEach(l=>{const u=c.values[l];u.ranges=Zn(u.ranges)}),[{id:An.id,params:c}]},gn=(o,t,e)=>{const n=Ya(e,"pattern"),s={},r={},a=Ka();return Object.keys(n).forEach(c=>{const l=n[c],u=a();s[u]={pattern:c},l.forEach(d=>{r[u]||(r[u]={ranges:[]}),r[u].ranges.push(i.cellToRange(d.row,d.col))})}),{unitId:o,subUnitId:t,refMap:s,values:r}},_i={id:"sheet.mutation.remove-range-theme",type:i.CommandType.MUTATION,handler:(o,t)=>{if(!t)return!1;const{styleName:e,unitId:n}=t;return o.get(exports.SheetRangeThemeModel).unregisterRangeThemeStyle(n,e),!0}},bi={id:"sheet.mutation.set-range-theme",type:i.CommandType.MUTATION,handler:(o,t)=>{if(!t)return!1;const{unitId:e,styleName:n,style:s}=t,a=o.get(exports.SheetRangeThemeModel).getRangeThemeStyle(e,n);return a&&(s.headerRowStyle&&a.setHeaderRowStyle(s.headerRowStyle),s.firstRowStyle&&a.setFirstRowStyle(s.firstRowStyle),s.secondRowStyle&&a.setSecondRowStyle(s.secondRowStyle),s.lastRowStyle&&a.setLastRowStyle(s.lastRowStyle)),!0}},Ei={id:"sheet.operation.scroll-to-cell",type:i.CommandType.OPERATION,handler:()=>!0},Gl=(o,t,e)=>{const s=o.get(exports.SheetsSelectionsService).getCurrentSelections(),{value:r,selections:a,unitId:c,subUnitId:l}=t;if(s){const d=s[(s==null?void 0:s.length)-1].primary;if(d){const{actualColumn:m,actualRow:h}=d;let{startRow:g,startColumn:R,endRow:C,endColumn:f}=a[a.length-1];if(r===i.Dimension.COLUMNS){const v=e.find(M=>M.startColumn===m&&M.endColumn===m&&h===M.startRow);v&&(f=v.endColumn,g=v.startRow,C=v.endRow)}else if(r===i.Dimension.ROWS){const v=e.find(M=>M.startRow===h&&M.endRow===h&&m===M.startColumn);v&&(C=v.endRow,R=v.startColumn,f=v.endColumn)}const p={startRow:g,startColumn:R,endRow:C,endColumn:f,actualRow:h,actualColumn:m,isMerged:!0,isMergedMainCell:g===h&&R===m},w=s.map((v,M,_)=>({range:v.range,style:null,primary:M===_.length-1?p:null})),I={unitId:c,subUnitId:l,type:ee.ONLY_SET,selections:w};return{id:G.id,params:I}}return null}return null},zl=(o,t)=>{const n=o.get(exports.SheetsSelectionsService).getCurrentSelections(),{unitId:s,subUnitId:r}=t;if(n&&n[(n==null?void 0:n.length)-1].primary){const l={unitId:s,subUnitId:r,type:ee.ONLY_SET,selections:[...n]};return{id:G.id,params:l}}return null},Ti="maxCellsPerSheet",ql=3e6;var Yl=Object.getOwnPropertyDescriptor,Kl=(o,t,e,n)=>{for(var s=n>1?void 0:n?Yl(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},ms=(o,t)=>(e,n)=>t(e,n,o);const Jl="SHEET_DEFINED_NAME_PLUGIN",Xl="AllDefaultWorkbook";exports.DefinedNameDataController=class extends i.Disposable{constructor(t,e){super(),this._definedNamesService=t,this._resourceManagerService=e,this._initialize()}_initialize(){this._initSnapshot()}_initSnapshot(){const t=n=>{const s=this._definedNamesService.getDefinedNameMap(n);return s?JSON.stringify(s):""},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:Jl,businesses:[i.UniverInstanceType.UNIVER_SHEET],toJson:n=>t(n),parseJson:n=>e(n),onUnLoad:n=>{this._definedNamesService.removeUnitDefinedName(n)},onLoad:(n,s)=>{this._definedNamesService.registerDefinedNames(n,s)}}))}};exports.DefinedNameDataController=Kl([ms(0,Y.IDefinedNamesService),ms(1,i.IResourceManagerService)],exports.DefinedNameDataController);const Ui="sheets.config",hs={};var Zl=Object.getOwnPropertyDescriptor,Ql=(o,t,e,n)=>{for(var s=n>1?void 0:n?Zl(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Wn=(o,t)=>(e,n)=>t(e,n,o);const eu=[Pe.id],tu=[ae.id,ce.id,le.id,ne.id,ve.id,we.id];exports.SheetsFreezeSyncController=class extends i.Disposable{constructor(e,n,s){var a,c;super();S(this,"_d",new i.DisposableCollection);S(this,"_enabled",!0);this._univerInstanceService=e,this._commandService=n,this._configService=s;const r=(c=(a=this._configService.getConfig(Ui))==null?void 0:a.freezeSync)!=null?c:!0;this.setEnabled(r)}getEnabled(){return this._enabled}setEnabled(e){e?this._d.dispose():this._initOnlyLocalListener(),this._enabled=e}_initOnlyLocalListener(){this._d.add(this._commandService.beforeCommandExecuted((e,n)=>{eu.includes(e.id)&&(n||(n={}),n.onlyLocal=!0)})),this._d.add(this._commandService.onCommandExecuted((e,n)=>{if(tu.includes(e.id)&&(n!=null&&n.fromCollab)){const{id:s,params:r}=e;s===ae.id?this._handleInsertRowMutation(r,n):s===ce.id?this._handleInsertColMutation(r,n):s===le.id?this._handleRemoveRowMutation(r,n):s===ne.id?this._handleRemoveColMutation(r,n):s===ve.id?this._handleMoveRowsMutation(r,n):s===we.id&&this._handleMoveColsMutation(r,n)}}))}_handleInsertRowMutation(e,n){const{range:s,unitId:r,subUnitId:a}=e,c=this._getFreeze(r,a);if(c&&s.startRow<c.startRow){const l=s.endRow-s.startRow+1,u={...c,startRow:Math.max(1,c.startRow+l),ySplit:Math.max(1,c.ySplit+l)};this._sequenceExecute(r,a,u,n)}}_handleInsertColMutation(e,n){const{range:s,unitId:r,subUnitId:a}=e,c=this._getFreeze(r,a);if(c&&s.startColumn<c.startColumn){const l=s.endColumn-s.startColumn+1,u={...c,startColumn:Math.max(1,c.startColumn+l),xSplit:Math.max(1,c.xSplit+l)};this._sequenceExecute(r,a,u,n)}}_handleRemoveRowMutation(e,n){const{range:s,unitId:r,subUnitId:a}=e,c=this._getFreeze(r,a);if(c&&s.startRow<c.startRow){const l=Math.min(c.startRow,s.endRow+1)-s.startRow,u={...c,startRow:Math.max(1,c.startRow-l),ySplit:Math.max(1,c.ySplit-l)};this._sequenceExecute(r,a,u,n)}}_handleRemoveColMutation(e,n){const{range:s,unitId:r,subUnitId:a}=e,c=this._getFreeze(r,a);if(c&&s.startColumn<c.startColumn){const l=Math.min(c.startColumn,s.endColumn+1)-s.startColumn,u={...c,startColumn:Math.max(1,c.startColumn-l),xSplit:Math.max(1,c.xSplit-l)};this._sequenceExecute(r,a,u,n)}}_handleMoveRowsMutation(e,n){const{sourceRange:s,targetRange:r,unitId:a,subUnitId:c}=e,l=this._getFreeze(a,c);if(!l||l.startRow<=0||s.startRow>=l.startRow&&r.startRow>=l.startRow||s.endRow<l.startRow&&r.endRow<l.startRow)return;const u=s.endRow-s.startRow+1,d=Math.max(Math.min(l.startRow,s.endRow+1)-s.startRow,0),m={...l};r.startRow>=l.startRow?(m.startRow=Math.max(1,l.startRow-d),m.ySplit=Math.max(1,l.ySplit-d)):(m.startRow=l.startRow+u-d,m.ySplit=l.ySplit+u-d),this._sequenceExecute(a,c,m,n)}_handleMoveColsMutation(e,n){const{sourceRange:s,targetRange:r,unitId:a,subUnitId:c}=e,l=this._getFreeze(a,c);if(!l||l.startColumn<=0||s.startColumn>=l.startColumn&&r.startColumn>=l.startColumn||s.endColumn<l.startColumn&&r.endColumn<l.startColumn)return;const u=s.endColumn-s.startColumn+1,d=Math.max(Math.min(l.startColumn,s.endColumn+1)-s.startColumn,0),m={...l};r.startColumn>=l.startColumn?(m.startColumn=Math.max(1,l.startColumn-d),m.xSplit=Math.max(1,l.xSplit-d)):(m.startColumn=l.startColumn+u-d,m.xSplit=l.xSplit+u-d),this._sequenceExecute(a,c,m,n)}_getFreeze(e,n){const s=this._univerInstanceService.getUnit(e,i.UniverInstanceType.UNIVER_SHEET);if(!s)return null;const r=s.getSheetBySheetId(n);return r?r.getFreeze():null}_sequenceExecute(e,n,s,r){i.sequenceExecute([{id:Pe.id,params:{...s,unitId:e,subUnitId:n,resetScroll:!1}}],this._commandService,r)}};exports.SheetsFreezeSyncController=Ql([Wn(0,i.Inject(i.IUniverInstanceService)),Wn(1,i.ICommandService),Wn(2,i.IConfigService)],exports.SheetsFreezeSyncController);var nu=Object.getOwnPropertyDescriptor,ou=(o,t,e,n)=>{for(var s=n>1?void 0:n?nu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Ee=(o,t)=>(e,n)=>t(e,n,o);exports.SheetPermissionCheckController=class extends i.Disposable{constructor(e,n,s,r,a,c,l,u,d,m){super();S(this,"disposableCollection",new i.DisposableCollection);S(this,"_triggerPermissionUIEvent$",new O.Subject);S(this,"triggerPermissionUIEvent$",this._triggerPermissionUIEvent$.asObservable());this._commandService=e,this._univerInstanceService=n,this._permissionService=s,this._selectionManagerService=r,this._rangeProtectionRuleModel=a,this._worksheetProtectionRuleModel=c,this._localeService=l,this._lexerTreeBuilder=u,this._contextService=d,this._definedNamesService=m,this._initialize()}blockExecuteWithoutPermission(e){throw this._triggerPermissionUIEvent$.next(e),new i.CustomCommandExecutionError("have no permission")}_getPermissionCheck(e,n){let s=!0,r="";switch(e){case Et.id:i.isICellData(n.value)&&n.value.f?(s=this._permissionCheckWithFormula(n),r=this._localeService.t("permission.dialog.formulaErr")):s=this._permissionCheckBySetRangeValue({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[xt,Re]},n);break;case Pn.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[xt,Re]}),r=this._localeService.t("permission.dialog.editErr");break;case Vt.id:case $t.id:s=this.permissionCheckWithoutRange({worksheetTypes:[mt]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Bt.id:case Ft.id:case Dn.id:s=this.permissionCheckWithoutRange({worksheetTypes:[ht]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case It.id:case pt.id:s=this._permissionCheckByMoveCommand(n),r=this._localeService.t("permission.dialog.moveRowColErr");break;case qe.id:s=this._permissionCheckByMoveRangeCommand(n),r=this._localeService.t("permission.dialog.moveRangeErr");break;case Xo.id:s=this._permissionCheckByWorksheetCommand([ue,En]),r=this._localeService.t("permission.dialog.operatorSheetErr"),s===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case On.id:s=this._permissionCheckByWorksheetCommand([ue,Tn]),r=this._localeService.t("permission.dialog.operatorSheetErr"),s===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case Zo.id:{const{unitId:a,subUnitId:c}=n;s=this._permissionCheckByWorksheetCommand([ue,_n],a,c),r=this._localeService.t("permission.dialog.operatorSheetErr"),s===!1&&this._worksheetProtectionRuleModel.resetOrder()}break;case yt.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,mt]},n.ranges),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case _t.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,ht]},n.ranges),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case jo.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,mt]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case qo.id:s=this.permissionCheckWithRanges({workbookTypes:[ue],rangeTypes:[ge],worksheetTypes:[Re,ht]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case ft.id:s=this._permissionCheckWithInsertRangeMove("right"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Xe.id:s=this._permissionCheckWithInsertRangeMove("bottom"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case je.id:s=this._permissionCheckWithInsertRangeMove("left"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Ge.id:s=this._permissionCheckWithInsertRangeMove("top"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break}s||this.blockExecuteWithoutPermission(r)}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{this._getPermissionCheck(e.id,e==null?void 0:e.params)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var n;if(e.id===Lt.id){const s=e.params,{unitId:r=(n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.getUnitId(),subUnitId:a}=s;if(!r||!a)return;const c=this._worksheetProtectionRuleModel.getRule(r,a),l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a);c&&this._worksheetProtectionRuleModel.ruleRefresh(c.permissionId),l.length&&this._rangeProtectionRuleModel.ruleRefresh(a)}}))}_permissionCheckWithInsertRangeMove(e){var d;const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=i.Tools.deepClone((d=this._selectionManagerService.getCurrentLastSelection())==null?void 0:d.range);return!(!c||(e==="top"||e==="bottom"?c.endRow=s.getRowCount()-1:(e==="left"||e==="right")&&(c.endColumn=s.getColumnCount()-1),this._rangeProtectionRuleModel.getSubunitRuleList(r,a).map(m=>m.ranges).flat().some(m=>i.Rectangle.getIntersects(c,m))))}_permissionCheckByWorksheetCommand(e,n,s){var d,m;const r=P(this._univerInstanceService,{unitId:n,subUnitId:s});if(!r)return!1;const{unitId:a,subUnitId:c}=r,l=this._worksheetProtectionRuleModel.getRule(a,c),u=this._rangeProtectionRuleModel.getSubunitRuleList(a,c).length>0;return l||u?(m=(d=this._permissionService.getPermissionPoint(new bn(a).id))==null?void 0:d.value)!=null?m:!1:this._permissionService.composePermission(e.map(h=>new h(a).id)).every(h=>h.value)}permissionCheckWithoutRange(e){var g,R,C,f;const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=this._selectionManagerService.getCurrentLastSelection();if(!c)return!0;const l=(R=(g=c==null?void 0:c.primary)==null?void 0:g.actualRow)!=null?R:0,u=(f=(C=c==null?void 0:c.primary)==null?void 0:C.actualColumn)!=null?f:0,{workbookTypes:d,worksheetTypes:m,rangeTypes:h}=e;return!(d&&d.some(w=>{var M,_;const I=new w(r);return((_=(M=this._permissionService.getPermissionPoint(I.id))==null?void 0:M.value)!=null?_:!1)===!1})===!0||m&&m.some(w=>{var M,_;const I=new w(r,a);return((_=(M=this._permissionService.getPermissionPoint(I.id))==null?void 0:M.value)!=null?_:!1)===!1})===!0||h&&h.some(w=>{var E,T,U,b,k;const I=(T=(E=s.getCell(l,u))==null?void 0:E.selectionProtection)==null?void 0:T[0];if(!(I!=null&&I.ruleId))return!1;const v=(U=this._rangeProtectionRuleModel.getRule(r,a,I.ruleId))==null?void 0:U.permissionId;if(!v)return!1;const M=new w(r,a,v);return((k=(b=this._permissionService.getPermissionPoint(M.id))==null?void 0:b.value)!=null?k:!1)===!1})===!0)}permissionCheckWithRanges(e,n,s,r){var R;const a=P(this._univerInstanceService);if(!a)return!1;const{workbook:c,worksheet:l}=a;s||(s=c.getUnitId()),r||(r=l.getSheetId());const u=n!=null?n:(R=this._selectionManagerService.getCurrentSelections())==null?void 0:R.map(C=>C.range);if(!u)return!1;const{workbookTypes:d,worksheetTypes:m,rangeTypes:h}=e,g=[];return d&&g.push(...d.map(C=>new C(s).id)),m&&g.push(...m.map(C=>new C(s,r).id)),h&&this._rangeProtectionRuleModel.getSubunitRuleList(s,r).forEach(C=>{u.some(p=>C.ranges.some(w=>i.Rectangle.intersects(w,p)))&&g.push(...h.map(p=>new p(s,r,C.permissionId).id))}),g.length?this._permissionService.composePermission(g).every(C=>C.value):!0}_permissionCheckByMoveCommand(e){const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=e.toRange;c.endRow===s.getRowCount()-1?c.endColumn=c.startColumn:c.endRow=c.startRow;const l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((u,d)=>[...u,...d.ranges],[]).filter(u=>i.Rectangle.intersects(u,c));return l.length>0?!1:(l.forEach(u=>{var d,m;for(let h=u.startRow;h<=u.endRow;h++)for(let g=u.startColumn;g<=u.endColumn;g++){const R=(m=(d=s.getCell(h,g))==null?void 0:d.selectionProtection)==null?void 0:m[0];if((R==null?void 0:R[y.Edit])===!1)return!1}}),!0)}_permissionCheckByMoveRangeCommand(e){const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:s,unitId:r,subUnitId:a}=n,c=e.toRange,l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((u,d)=>[...u,...d.ranges],[]).filter(u=>i.Rectangle.intersects(u,c));return l.length>0?!1:(l.forEach(u=>{var d,m;for(let h=u.startRow;h<=u.endRow;h++)for(let g=u.startColumn;g<=u.endColumn;g++){const R=(m=(d=s.getCell(h,g))==null?void 0:d.selectionProtection)==null?void 0:m[0];if((R==null?void 0:R[y.Edit])===!1)return!1}}),!0)}_permissionCheckBySetRangeValue(e,n){let s=[];n.range?s=[n.range]:s=[new i.ObjectMatrix(n.value).getDataRange()];const{unitId:r,subUnitId:a}=n;return this.permissionCheckWithRanges(e,s,r,a)}_permissionCheckWithFormula(e){var a,c,l,u,d;const n=e.value,s=e.range,r=n.f;if(r){const m=r.substring(1),h=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),g=(a=e.unitId)!=null?a:h.getUnitId(),R=this._definedNamesService.getValueByName(g,m);if(R){let C=R.formulaOrRefString;C.startsWith(Y.operatorToken.EQUALS)&&(C=C.slice(1));const f=C.split(",");for(let p=0;p<f.length;p++){const w=f[p],I=Y.deserializeRangeWithSheet(w);if(I.sheetName){const v=h.getSheetBySheetName(I.sheetName);if(!v)return!0;const{startRow:M,endRow:_,startColumn:E,endColumn:T}=I.range;for(let U=M;U<=_;U++)for(let b=E;b<=T;b++){const k=(l=(c=v.getCell(U,b))==null?void 0:c.selectionProtection)==null?void 0:l[0];if((k==null?void 0:k[y.View])===!1)return!1}}}return!0}else{const C=this._lexerTreeBuilder.sequenceNodesBuilder(r);if(!C)return!0;for(let f=0;f<C.length;f++){const p=C[f];if(typeof p=="string"||p.nodeType!==Y.sequenceNodeType.REFERENCE)continue;const{token:w}=p,I=Y.deserializeRangeWithSheetWithCache(w),v=I.unitId?this._univerInstanceService.getUnit(I.unitId):this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!v)return!0;let M=I.sheetName?v.getSheetBySheetName(I.sheetName):v.getActiveSheet();const _=v.getUnitId();if(I.sheetName){if(M=v.getSheetBySheetName(I.sheetName),!M)return!0;const k=M==null?void 0:M.getSheetId();if(!this._permissionService.getPermissionPoint(new zt(_,k).id))return!1}if(!M)return!0;const{startRow:E,endRow:T,startColumn:U,endColumn:b}=I.range;for(let k=E;k<=T;k++)for(let A=U;A<=b;A++){const x=(d=(u=M.getCell(k,A))==null?void 0:u.selectionProtection)==null?void 0:d[0];if((x==null?void 0:x[y.View])===!1)return!1}}return!0}}if(s){const m=P(this._univerInstanceService);if(!m)return!1;const h=e.unitId||m.unitId,g=e.subUnitId||m.subUnitId,C=this._rangeProtectionRuleModel.getSubunitRuleList(h,g).filter(p=>p.ranges.some(w=>i.Rectangle.intersects(w,s))).map(p=>new ge(h,g,p.permissionId).id);if(!this._permissionService.composePermission(C).every(p=>p.value))return!1}return!0}};exports.SheetPermissionCheckController=ou([Ee(0,i.ICommandService),Ee(1,i.IUniverInstanceService),Ee(2,i.IPermissionService),Ee(3,i.Inject(exports.SheetsSelectionsService)),Ee(4,i.Inject(J)),Ee(5,i.Inject(Oe)),Ee(6,i.Inject(i.LocaleService)),Ee(7,i.Inject(Y.LexerTreeBuilder)),Ee(8,i.IContextService),Ee(9,Y.IDefinedNamesService)],exports.SheetPermissionCheckController);var su=Object.getOwnPropertyDescriptor,ru=(o,t,e,n)=>{for(var s=n>1?void 0:n?su(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Vn=(o,t)=>(e,n)=>t(e,n,o);exports.ZebraCrossingCacheController=class extends i.Disposable{constructor(e,n,s){super();S(this,"_zebraCacheUpdateSubject",new O.Subject);this._commandService=e,this._sheetRangeThemeModel=n,this._univerInstanceService=s,this._init()}_init(){this._initializeCommandListener(),this._initTriggerCacheUpdateListener()}updateZebraCrossingCache(e,n){this._zebraCacheUpdateSubject.next({unitId:e,subUnitId:n})}_initializeCommandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{const{id:n}=e;let s,r;switch(n){case ae.id:{const a=e.params;s=a.unitId,r=a.subUnitId}break;case Ke.id:{const a=e.params;s=a.unitId,r=a.subUnitId}break;case Je.id:{const a=e.params;s=a.unitId,r=a.subUnitId}break;case le.id:{const a=e.params;s=a.unitId,r=a.subUnitId}break;case Te.id:{const a=e.params;s=a.unitId,r=a.subUnitId}break}s&&r&&(this._sheetRangeThemeModel.refreshSheetRowVisibleFuncSet(s,r),this._sheetRangeThemeModel.refreshZebraCrossingCacheBySheet(s,r))}))}_initTriggerCacheUpdateListener(){this.disposeWithMe(this._zebraCacheUpdateSubject.subscribe(({unitId:e,subUnitId:n})=>{this._sheetRangeThemeModel.refreshSheetRowVisibleFuncSet(e,n),this._sheetRangeThemeModel.refreshZebraCrossingCacheBySheet(e,n)}))}};exports.ZebraCrossingCacheController=ru([Vn(0,i.Inject(i.ICommandService)),Vn(1,i.Inject(exports.SheetRangeThemeModel)),Vn(2,i.Inject(i.IUniverInstanceService))],exports.ZebraCrossingCacheController);var iu=Object.getOwnPropertyDescriptor,au=(o,t,e,n)=>{for(var s=n>1?void 0:n?iu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},gs=(o,t)=>(e,n)=>t(e,n,o);exports.RangeProtectionRenderModel=class{constructor(t,e){S(this,"_cache",new i.LRUMap(1e4));this._selectionProtectionRuleModel=t,this._permissionService=e,this._init()}_init(){this._permissionService.permissionPointUpdate$.pipe(Nt.filter(t=>t.type===N.SelectRange),Nt.filter(t=>ie().some(e=>t instanceof e)),Nt.map(t=>t)).subscribe(t=>{const e=this._selectionProtectionRuleModel.getSubunitRuleList(t.unitId,t.subUnitId);for(const n of e)n.permissionId===t.permissionId&&n.ranges.forEach(s=>{i.Range.foreach(s,(r,a)=>{const c=this._createKey(t.unitId,t.subUnitId,r,a);this._cache.delete(c)})})}),this._selectionProtectionRuleModel.ruleChange$.subscribe(t=>{var e;t.rule.ranges.forEach(n=>{i.Range.foreach(n,(s,r)=>{const a=this._createKey(t.unitId,t.subUnitId,s,r);this._cache.delete(a)})}),t.type==="set"&&((e=t.oldRule)==null||e.ranges.forEach(n=>{i.Range.foreach(n,(s,r)=>{const a=this._createKey(t.unitId,t.subUnitId,s,r);this._cache.delete(a)})}))})}_createKey(t,e,n,s){return`${t}_${e}_${n}_${s}`}getCellInfo(t,e,n,s){const r=this._selectionProtectionRuleModel.getSubunitRuleList(t,e),a=[];if(!r||!r.length)return a;const c=this._createKey(t,e,n,s),l=this._cache.get(c);if(l)return l;const u=[];for(const d of r)if(d.ranges.some(m=>m.startRow<=n&&m.endRow>=n&&m.startColumn<=s&&m.endColumn>=s)){const m=ie().reduce((h,g)=>{var f;const R=new g(t,e,d.permissionId),C=this._permissionService.getPermissionPoint(R.id);return h[R.subType]=(f=C==null?void 0:C.value)!=null?f:R.value,h},{});u.push({...m,ruleId:d.id,ranges:d.ranges})}return this._cache.set(c,u),u}clear(){this._cache.clear()}};exports.RangeProtectionRenderModel=au([gs(0,i.Inject(J)),gs(1,i.Inject(i.IPermissionService))],exports.RangeProtectionRenderModel);var cu=Object.getOwnPropertyDescriptor,lu=(o,t,e,n)=>{for(var s=n>1?void 0:n?cu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},$n=(o,t)=>(e,n)=>t(e,n,o);exports.RangeProtectionCache=class extends i.Disposable{constructor(e,n,s){super();S(this,"_cellRuleCache",new Map);S(this,"_permissionIdCache",new Map);S(this,"_cellInfoCache",new Map);S(this,"_rowInfoCache",new Map);S(this,"_colInfoCache",new Map);this._ruleModel=e,this._permissionService=n,this._univerInstanceService=s,this._initUpdateCellRuleCache(),this._initUpdateCellInfoCache(),this._initUpdateRowColInfoCache(),this._initCache()}_initCache(){this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(e=>{e.getSheets().forEach(n=>{const s=e.getUnitId(),r=n.getSheetId();this.reBuildCache(s,r)})})}_initUpdateCellInfoCache(){this._permissionService.permissionPointUpdate$.pipe(O.filter(e=>e.type===N.SelectRange),O.map(e=>e)).subscribe(e=>{const{subUnitId:n,unitId:s,permissionId:r}=e,a=this._permissionIdCache.get(r);if(!a)return;const c=this._ruleModel.getRule(s,n,a);if(!c)return;const l=this._ensureCellInfoMap(s,n);c.ranges.forEach(u=>{const{startRow:d,endRow:m,startColumn:h,endColumn:g}=u;for(let R=d;R<=m;R++)for(let C=h;C<=g;C++)l.delete(`${R}-${C}`)})}),this._ruleModel.ruleChange$.subscribe(e=>{var a;const{unitId:n,subUnitId:s}=e,r=this._ensureCellInfoMap(n,s);e.rule.ranges.forEach(c=>{i.Range.foreach(c,(l,u)=>{r.delete(`${l}-${u}`)})}),e.type==="set"&&((a=e.oldRule)==null||a.ranges.forEach(c=>{i.Range.foreach(c,(l,u)=>{this._cellInfoCache.delete(`${l}-${u}`)})}))})}_initUpdateCellRuleCache(){this._ruleModel.ruleChange$.subscribe(e=>{const{type:n}=e;n==="add"?this._addCellRuleCache(e):n==="delete"?this._deleteCellRuleCache(e):(this._deleteCellRuleCache({...e,rule:e.oldRule}),this._addCellRuleCache(e))})}_ensureRuleMap(e,n){let s=this._cellRuleCache.get(e);s||(s=new Map,this._cellRuleCache.set(e,s));let r=s.get(n);return r||(r=new Map,s.set(n,r)),r}_ensureCellInfoMap(e,n){let s=this._cellInfoCache.get(e);s||(s=new Map,this._cellInfoCache.set(e,s));let r=s.get(n);return r||(r=new Map,s.set(n,r)),r}_ensureRowColInfoMap(e,n,s){let r=s==="row"?this._rowInfoCache.get(e):this._colInfoCache.get(e);r||(r=new Map,s==="row"?this._rowInfoCache.set(e,r):this._colInfoCache.set(e,r));let a=r.get(n);return a||(a=new Map,r.set(n,a)),a}_addCellRuleCache(e){const{subUnitId:n,unitId:s,rule:r}=e,a=this._ensureRuleMap(s,n);r.ranges.forEach(c=>{const{startRow:l,endRow:u,startColumn:d,endColumn:m}=c;for(let h=l;h<=u;h++)for(let g=d;g<=m;g++)a.set(`${h}-${g}`,r.id)}),this._permissionIdCache.set(r.permissionId,r.id)}_deleteCellRuleCache(e){const{subUnitId:n,unitId:s,rule:r}=e,a=this._ensureRuleMap(s,n),c=this._ensureCellInfoMap(s,n);r.ranges.forEach(l=>{const{startRow:u,endRow:d,startColumn:m,endColumn:h}=l;for(let g=u;g<=d;g++)for(let R=m;R<=h;R++)a.delete(`${g}-${R}`),c.delete(`${g}-${R}`)}),this._permissionIdCache.delete(r.permissionId)}_getSelectionActions(e,n,s){var d,m,h,g,R,C,f,p,w,I,v,M;const r=(h=(m=this._permissionService.getPermissionPoint((d=new ge(e,n,s.permissionId))==null?void 0:d.id))==null?void 0:m.value)!=null?h:!0,a=(C=(R=this._permissionService.getPermissionPoint((g=new yn(e,n,s.permissionId))==null?void 0:g.id))==null?void 0:R.value)!=null?C:!0,c=(w=(p=this._permissionService.getPermissionPoint((f=new $o(e,n,s.permissionId))==null?void 0:f.id))==null?void 0:p.value)!=null?w:!1,l=(M=(v=this._permissionService.getPermissionPoint((I=new Vo(e,n,s.permissionId))==null?void 0:I.id))==null?void 0:v.value)!=null?M:!1;return{[y.Edit]:r,[y.View]:a,[y.ManageCollaborator]:c,[y.Delete]:l}}reBuildCache(e,n){const s=this._ensureRuleMap(e,n),r=this._ensureCellInfoMap(e,n);s.clear(),r.clear();const a=this._ensureRowColInfoMap(e,n,"row"),c=this._ensureRowColInfoMap(e,n,"col");a.clear(),c.clear(),this._ruleModel.getSubunitRuleList(e,n).forEach(l=>{const u=this._getSelectionActions(e,n,l),d={...u,ruleId:l.id,ranges:l.ranges};l.ranges.forEach(m=>{const{startRow:h,endRow:g,startColumn:R,endColumn:C}=m;for(let f=h;f<=g;f++){const p=a.get(`${f}`);p?p.set(l.id,u):a.set(`${f}`,new Map([[l.id,u]]));for(let w=R;w<=C;w++){s.set(`${f}-${w}`,l.id),r.set(`${f}-${w}`,d);const I=c.get(`${w}`);I?I.set(l.id,u):c.set(`${w}`,new Map([[l.id,u]]))}}}),this._permissionIdCache.set(l.permissionId,l.id)})}getRowPermissionInfo(e,n,s,r){var l;const a=(l=this._rowInfoCache.get(e))==null?void 0:l.get(n);if(!a)return!0;const c=a.get(`${s}`);return c?r.every(u=>{for(const d of c.values())if(d[u]===!1)return!1;return!0}):!0}getColPermissionInfo(e,n,s,r){var l;const a=(l=this._colInfoCache.get(e))==null?void 0:l.get(n);if(!a)return!0;const c=a.get(`${s}`);return c?r.every(u=>{for(const d of c.values())if(d[u]===!1)return!1;return!0}):!0}_initUpdateRowColInfoCache(){this._permissionService.permissionPointUpdate$.pipe(O.filter(e=>e.type===N.SelectRange),O.map(e=>e)).subscribe({next:e=>{const{subUnitId:n,unitId:s,permissionId:r}=e,a=this._permissionIdCache.get(r);if(!a)return;const c=this._ruleModel.getRule(s,n,a);if(!c)return;const l=this._ensureRowColInfoMap(s,n,"row"),u=this._ensureRowColInfoMap(s,n,"col"),d=this._getSelectionActions(s,n,c);c.ranges.forEach(m=>{const{startRow:h,endRow:g,startColumn:R,endColumn:C}=m;for(let f=h;f<=g;f++){const p=l.get(`${f}`);p?p.set(a,d):l.set(`${f}`,new Map([[a,d]]));for(let w=R;w<=C;w++){const I=u.get(`${w}`);I?I.set(a,d):u.set(`${w}`,new Map([[a,d]]))}}})}}),this._ruleModel.ruleChange$.subscribe(e=>{if(e.type==="delete"){const{unitId:n,subUnitId:s,rule:r}=e,a=this._ensureRowColInfoMap(n,s,"row"),c=this._ensureRowColInfoMap(n,s,"col");r.ranges.forEach(l=>{const{startRow:u,endRow:d,startColumn:m,endColumn:h}=l;for(let g=u;g<=d;g++){const R=a.get(`${g}`);R==null||R.delete(r.id);for(let C=m;C<=h;C++){const f=c.get(`${C}`);f==null||f.delete(r.id)}}})}})}getCellInfo(e,n,s,r){var d,m;const a=this._ensureCellInfoMap(e,n),c=a.get(`${s}-${r}`);if(c)return c;const l=(m=(d=this._cellRuleCache.get(e))==null?void 0:d.get(n))==null?void 0:m.get(`${s}-${r}`);if(!l)return;const u=this._ruleModel.getRule(e,n,l);if(u){const g={...this._getSelectionActions(e,n,u),ruleId:l,ranges:u.ranges};return a.set(`${s}-${r}`,g),g}}deleteUnit(e){this._cellRuleCache.delete(e),this._cellInfoCache.delete(e),this._rowInfoCache.delete(e),this._colInfoCache.delete(e);const n=this._univerInstanceService.getUnit(e);n==null||n.getSheets().forEach(s=>{const r=s.getSheetId();this._ruleModel.getSubunitRuleList(e,r).forEach(a=>{this._permissionIdCache.delete(a.permissionId)})})}};exports.RangeProtectionCache=lu([$n(0,i.Inject(J)),$n(1,i.Inject(i.IPermissionService)),$n(2,i.Inject(i.IUniverInstanceService))],exports.RangeProtectionCache);const Pi="ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY";var uu=Object.getOwnPropertyDescriptor,du=(o,t,e,n)=>{for(var s=n>1?void 0:n?uu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Ln=(o,t)=>(e,n)=>t(e,n,o);let Rn=class extends i.Disposable{constructor(o,t,e){var s;super(),this._commandService=o,this._configService=t,this._dataSyncPrimaryController=e,[B,ce,ae,wt,He,ve,we,ne,le,nt,H,Qo,F,Yo,Lt,An,At,wi,Je,Ke,Mi,yi].forEach(r=>{var a;this._commandService.registerCommand(r),(a=this._dataSyncPrimaryController)==null||a.registerSyncingMutations(r)}),((s=this._configService.getConfig(Pi))!=null?s:!1)||[Ar,vn,Pn,wn,Bo,je,Ge,Vt,Bt,hr,mr,gr,Rr,Po,ye,Xe,ft,cr,ar,ur,lr,Uo,Me,Lr,It,qe,pt,ko,Yt,No,qt,Nn,un,Fr,si,ni,oi,zr,Gr,Ut,Hr,jr,mn,Ct,St,$t,qr,rt,Kr,Pe,Jr,ii,Et,Ft,hn,Qr,at,jo,qo,yt,_t,Q,li,Ot,ti,ci,ai,ri,Ko,Jo,bt,hi,Fe,On,Xo,Dt,Jn,Te,Dn,Se,Ae,Ci,ut,ui,ct,Js,G,Ei,$r,Fo,Go,Zo,pi,dt,Xr,it,gi,xe,Ye,ze,Un,Gs,Zr,xr,Or,Wr,Ri,fe,ke,Z,fi,lt,di,Si,Rt,gt,kn,Mt,Ii,Br,Dr,Vr,vi,bi,_i].forEach(r=>this.disposeWithMe(this._commandService.registerCommand(r))),this._configService.setConfig(Ti,ql)}};Rn=du([Ln(0,i.ICommandService),Ln(1,i.IConfigService),Ln(2,i.Optional($i.DataSyncPrimaryController))],Rn);var mu=Object.getOwnPropertyDescriptor,hu=(o,t,e,n)=>{for(var s=n>1?void 0:n?mu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Rs=(o,t)=>(e,n)=>t(e,n,o);let Cn=class extends i.Disposable{constructor(o,t){super(),this._univerInstanceService=o,this._commandService=t,this._initialize()}_initialize(){this.disposeWithMe(this._commandService.onCommandExecuted(o=>{if(o.id!==Y.SetFormulaCalculationResultMutation.id)return;const t=o.params,{unitData:e}=t,n=Object.keys(e),s=[];for(let a=0;a<n.length;a++){const c=n[a],l=e[c];if(l==null)continue;const u=Object.keys(l);for(let d=0;d<u.length;d++){const m=u[d],h=l[m];if(h==null)continue;const g=this._getMergedCellData(c,m,h),R={subUnitId:m,unitId:c,cellValue:g};s.push({id:B.id,params:R})}}return s.every(a=>this._commandService.executeCommand(a.id,a.params,{onlyLocal:!0,fromFormula:!0}))}))}_getMergedCellData(o,t,e){const n=this._univerInstanceService.getUniverSheetInstance(o),s=n==null?void 0:n.getStyles(),r=n==null?void 0:n.getSheetBySheetId(t),a=r==null?void 0:r.getCellMatrix(),c=new i.ObjectMatrix(e);return c.forValue((l,u,d)=>{const m=a==null?void 0:a.getValue(l,u),h=Y.handleNumfmtInCell(m,d,s);c.setValue(l,u,h)}),c.getMatrix()}};Cn=hu([Rs(0,i.Inject(i.IUniverInstanceService)),Rs(1,i.ICommandService)],Cn);var gu=Object.getOwnPropertyDescriptor,Ru=(o,t,e,n)=>{for(var s=n>1?void 0:n?gu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Cu=(o,t)=>(e,n)=>t(e,n,o);let Sn=class extends i.Disposable{constructor(o){super(),this._sheetInterceptorService=o,this._initialize()}_initialize(){this._initInterceptorCellContent()}_initInterceptorCellContent(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{priority:11,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(o,t,e)=>{var s;if(!o)return e(o);const n=t.workbook.getStyles().getStyleByCell(o);return i.isDefaultFormat((s=n==null?void 0:n.n)==null?void 0:s.pattern)&&(o==null?void 0:o.t)===i.CellValueType.NUMBER&&o.v!==void 0&&o.v!==null&&i.isRealNum(o.v)&&((!o||o===t.rawData)&&(o={...t.rawData}),o.v=Y.stripErrorMargin(Number(o.v))),e(o)}}))}};Sn=Ru([Cu(0,i.Inject(exports.SheetInterceptorService))],Sn);var Su=Object.getOwnPropertyDescriptor,fu=(o,t,e,n)=>{for(var s=n>1?void 0:n?Su(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Qt=(o,t)=>(e,n)=>t(e,n,o);let fn=class extends i.Disposable{constructor(o,t,e,n){super(),this._permissionService=o,this._worksheetProtectionRuleModel=t,this._sheetInterceptorService=e,this._rangeProtectionCache=n,this._initViewModelByRangeInterceptor(),this._initViewModelBySheetInterceptor()}_initViewModelByRangeInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(o,t,e)=>{const{unitId:n,subUnitId:s,row:r,col:a}=t,c=this._rangeProtectionCache.getCellInfo(n,s,r,a);if(c){const l=c[y.View]===!1,u=!o||o===t.rawData?{...t.rawData}:o;return u.selectionProtection=[c],l?(delete u.s,delete u.v,delete u.p,u):e(u)}return e(o)}}))}_initViewModelBySheetInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(De.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(o,t,e)=>{var a,c,l,u,d;const{unitId:n,subUnitId:s}=t,r=this._worksheetProtectionRuleModel.getRule(n,s);if(r!=null&&r.permissionId){const m=[{[y.View]:(c=(a=this._permissionService.getPermissionPoint(new zt(n,s).id))==null?void 0:a.value)!=null?c:!1,[y.Edit]:(u=(l=this._permissionService.getPermissionPoint(new Re(n,s).id))==null?void 0:l.value)!=null?u:!1}],h=!((d=m[0])!=null&&d[y.View]),g=!o||o===t.rawData?{...o}:o;return g.hasWorksheetRule=!0,g.selectionProtection=m,h?(delete g.s,delete g.v,delete g.p,g):e(g)}return e(o)}}))}};fn=fu([Qt(0,i.IPermissionService),Qt(1,i.Inject(Oe)),Qt(2,i.Inject(exports.SheetInterceptorService)),Qt(3,i.Inject(exports.RangeProtectionCache))],fn);const zn=i.createIdentifier("univer.exclusive-range-service");class ki extends i.Disposable{constructor(){super(...arguments);S(this,"_exclusiveRanges",new Map);S(this,"_exclusiveRangesChange$",new O.Subject);S(this,"exclusiveRangesChange$",this._exclusiveRangesChange$.asObservable())}_ensureUnitMap(e){return this._exclusiveRanges.has(e)||this._exclusiveRanges.set(e,new Map),this._exclusiveRanges.get(e)}_ensureSubunitMap(e,n){const s=this._ensureUnitMap(e);return s.has(n)||s.set(n,new Map),s.get(n)}_ensureFeature(e,n,s){const r=this._ensureSubunitMap(e,n);return r.has(s)||r.set(s,[]),r.get(s)}addExclusiveRange(e,n,s,r){const a=this._ensureFeature(e,n,s);a.push(...r),this._exclusiveRangesChange$.next({unitId:e,subUnitId:n,ranges:a.map(c=>c.range)})}getExclusiveRanges(e,n,s){var r,a;return(a=(r=this._exclusiveRanges.get(e))==null?void 0:r.get(n))==null?void 0:a.get(s)}clearExclusiveRanges(e,n,s){const r=this.getExclusiveRanges(e,n,s);this._exclusiveRangesChange$.next({unitId:e,subUnitId:n,ranges:(r==null?void 0:r.map(a=>a.range))||[]}),this._ensureFeature(e,n,s),this._exclusiveRanges.get(e).get(n).set(s,[])}clearExclusiveRangesByGroupId(e,n,s,r){const a=this.getExclusiveRanges(e,n,s);this._exclusiveRangesChange$.next({unitId:e,subUnitId:n,ranges:(a==null?void 0:a.map(l=>l.range))||[]});const c=this.getExclusiveRanges(e,n,s);if(c){const l=c.filter(u=>u.groupId!==r);this._exclusiveRanges.get(e).get(n).set(s,l)}}getInterestGroupId(e){const n=[];return e.forEach(s=>{var u;const r=s.range,{unitId:a,sheetId:c}=r;if(!a||!c)return;const l=(u=this._exclusiveRanges.get(a))==null?void 0:u.get(c);if(l)for(const d of l.keys()){const m=l.get(d);if(m){for(const h of m)if(i.Rectangle.intersects(r,h.range)){n.push(d);break}}}}),n}}var pu=Object.getOwnPropertyDescriptor,Iu=(o,t,e,n)=>{for(var s=n>1?void 0:n?pu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Bn=(o,t)=>(e,n)=>t(e,n,o);exports.NumfmtService=class extends i.Disposable{constructor(t,e,n){super(),this._resourceManagerService=t,this._univerInstanceService=e,this._logService=n}getValue(t,e,n,s){const r=this._univerInstanceService.getUniverSheetInstance(t);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(e);if(!a)return;const c=r.getStyles(),l=a.getCellRaw(n,s);if(l!=null&&l.s){const u=c.get(l.s);if(u!=null&&u.n)return u.n}return null}deleteValues(t,e,n){const s=this._univerInstanceService.getUniverSheetInstance(t);if(!s)return;const r=s==null?void 0:s.getSheetBySheetId(e);if(!r)return;const a=s.getStyles();n.forEach(c=>{i.Range.foreach(c,(l,u)=>{const d=r.getCellRaw(l,u);if(!d)return;const m=d==null?void 0:d.s,g={...m&&a.get(m)||{}};delete g.n;const R=a.setValue(g);d.s=R})})}setValues(t,e,n){const s=this._univerInstanceService.getUniverSheetInstance(t);if(!s)return;const r=s==null?void 0:s.getSheetBySheetId(e);if(!r)return;const a=s.getStyles(),c=r.getCellMatrix();n.forEach(l=>{l.ranges.forEach(u=>{i.Range.foreach(u,(d,m)=>{const h=r.getCellRaw(d,m);if(h){const R={...a.getStyleByCell(h)||{},n:{pattern:l.pattern}},C=a.setValue(R);h.s=C}else{const g={n:{pattern:l.pattern}},R=a.setValue(g);R&&c.setValue(d,m,{s:R})}})})})}};exports.NumfmtService=Iu([Bn(0,i.IResourceManagerService),Bn(1,i.IUniverInstanceService),Bn(2,i.ILogService)],exports.NumfmtService);var vu=Object.getOwnPropertyDescriptor,wu=(o,t,e,n)=>{for(var s=n>1?void 0:n?vu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Le=(o,t)=>(e,n)=>t(e,n,o);const Cs=[ce.id,ae.id,ne.id,le.id],Ss=[ve.id,we.id];exports.RangeProtectionRefRangeService=class extends i.Disposable{constructor(e,n,s,r,a,c,l,u){super();S(this,"disposableCollection",new i.DisposableCollection);this._selectionProtectionRuleModel=e,this._univerInstanceService=n,this._commandService=s,this._refRangeService=r,this._selectionProtectionRenderModel=a,this._rangeProtectionCache=c,this._sheetInterceptorService=l,this._rangeProtectionRuleModel=u,this._onRefRangeChange(),this._correctPermissionRange(),this._initReBuildCache(),this._initRemoveSheet()}_onRefRangeChange(){const e=(s,r)=>{const a=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!a||!(a==null?void 0:a.getSheetBySheetId(r)))return;this.disposableCollection.dispose();const l=d=>this.refRangeHandle(d,s,r);this._selectionProtectionRuleModel.getSubunitRuleList(s,r).reduce((d,m)=>[...d,...m.ranges],[]).forEach(d=>{this.disposableCollection.add(this._refRangeService.registerRefRange(d,l,s,r))})};this.disposeWithMe(this._commandService.onCommandExecuted(s=>{if(s.id===Jo.id){const r=s.params,a=r.subUnitId,c=r.unitId;if(!a||!c)return;e(c,a)}if(s.id===Z.id||s.id===fe.id){const r=s.params,a=r.subUnitId,c=r.unitId;if(!a||!c)return;e(c,a)}}));const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(n){const s=n.getActiveSheet();if(!s)return;e(n.getUnitId(),s.getSheetId())}}refRangeHandle(e,n,s){switch(e.id){case pt.id:return this._getRefRangeMutationsByMoveRows(e.params,n,s);case It.id:return this._getRefRangeMutationsByMoveCols(e.params,n,s);case Me.id:return this._getRefRangeMutationsByInsertRows(e.params,n,s);case ye.id:return this._getRefRangeMutationsByInsertCols(e.params,n,s);case Yt.id:return this._getRefRangeMutationsByDeleteCols(e.params,n,s);case qt.id:return this._getRefRangeMutationsByDeleteRows(e.params,n,s)}return{redos:[],undos:[]}}_getRefRangeMutationsByDeleteCols(e,n,s){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(c=>c.ranges.some(l=>i.Rectangle.intersects(l,e.range))),a=e.range;if(r.length){const c=[],l=[];return r.forEach(u=>{const d=i.Tools.deepClone(u),m=d.ranges.reduce((h,g)=>{if(i.Rectangle.intersects(g,a)){const R=i.Tools.deepClone(g),{startColumn:C,endColumn:f}=a;if(C<=R.startColumn&&f>=R.endColumn)return h;C>=R.startColumn&&f<=R.endColumn?R.endColumn-=f-C+1:C<R.startColumn?(R.startColumn=C,R.endColumn-=f-C+1):f>R.endColumn&&(R.endColumn=C-1),this._checkIsRightRange(R)&&h.push(R)}return h},[]);d.ranges=m,d.ranges.length?(c.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:u.id}}),l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:u,ruleId:u.id}})):(c.push({id:ke.id,params:{unitId:n,subUnitId:s,ruleIds:[u.id]}}),l.push({id:fe.id,params:{unitId:n,subUnitId:s,name:"",rules:[u]}}))}),{redos:c,undos:l}}return{undos:[],redos:[]}}_getRefRangeMutationsByDeleteRows(e,n,s){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(c=>c.ranges.some(l=>i.Rectangle.intersects(l,e.range))),a=e.range;if(r.length){const c=[],l=[];return r.forEach(u=>{const d=i.Tools.deepClone(u),m=d.ranges.reduce((h,g)=>{if(i.Rectangle.intersects(g,a)){const R=i.Tools.deepClone(g),{startRow:C,endRow:f}=a;if(C<=R.startRow&&f>=R.endRow)return h;C>=R.startRow&&f<=R.endRow?R.endRow-=f-C+1:C<R.startRow?(R.startRow=C,R.endRow-=f-C+1):f>R.endRow&&(R.endRow=C-1),this._checkIsRightRange(R)&&h.push(R)}return h},[]);d.ranges=m,c.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:u.id}}),l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:u,ruleId:u.id}})}),{redos:c,undos:l}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertCols(e,n,s){const r=e.range.startColumn,a=e.range.endColumn-e.range.startColumn+1,c=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(l=>l.ranges.some(u=>r>u.startColumn&&r<=u.endColumn));if(c.length){const l=[],u=[];return c.forEach(d=>{const m=i.Tools.deepClone(d);let h=!1;m.ranges.forEach(g=>{r>g.startColumn&&r<=g.endColumn&&(g.endColumn+=a,h=!0)}),h&&(l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:d.id}}),u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:d.id}}))}),{redos:l,undos:u}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertRows(e,n,s){const r=e.range.startRow,a=e.range.endRow-e.range.startRow+1,c=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(l=>l.ranges.some(u=>r>u.startRow&&r<=u.endRow));if(c.length){const l=[],u=[];return c.forEach(d=>{const m=i.Tools.deepClone(d);let h=!1;m.ranges.forEach(g=>{r>g.startRow&&r<=g.endRow&&(g.endRow+=a,h=!0)}),h&&(l.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:d.id}}),u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:d,ruleId:d.id}}))}),{redos:l,undos:u}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveRows(e,n,s){const r=e.toRange,a=r.startRow,c=r.endRow-r.startRow+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(u=>u.ranges.some(d=>a>d.startRow&&a<=d.endRow));if(l.length){const u=[],d=[];return l.forEach(m=>{const h=i.Tools.deepClone(m),R=e.fromRange.startRow;let C=!1;h.ranges.forEach(f=>{a>f.startRow&&a<=f.endRow&&(R<f.startRow&&(f.startRow=f.startRow-c,f.endRow=f.endRow-c),f.endRow+=c,C=!0)}),C&&(u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:h,ruleId:m.id}}),d.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:m.id}}))}),{redos:u,undos:d}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveCols(e,n,s){const r=e.toRange,a=r.startColumn,c=r.endColumn-r.startColumn+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,s).filter(u=>u.ranges.some(d=>a>d.startColumn&&a<=d.endColumn));if(l.length){const u=[],d=[];return l.forEach(m=>{const h=i.Tools.deepClone(m),R=e.fromRange.startColumn;let C=!1;h.ranges.forEach(f=>{a>f.startColumn&&a<=f.endColumn&&(R<f.startColumn&&(f.startColumn=f.startColumn-c,f.endColumn=f.endColumn-c),f.endColumn+=c,C=!0)}),C&&(u.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:h,ruleId:m.id}}),d.push({id:Z.id,params:{unitId:n,subUnitId:s,rule:m,ruleId:m.id}}))}),{redos:u,undos:d}}return{undos:[],redos:[]}}_correctPermissionRange(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(Ss.includes(e.id)){if(!e.params)return;const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!n)return;const s=n.getSheetBySheetId(e.params.subUnitId);if(!s)return;const{sourceRange:r,targetRange:a}=e.params,c=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,l=c?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,u=c?r.startRow:r.startColumn,d=c?a.startRow:a.startColumn;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),s.getSheetId()).forEach(f=>{f.ranges.forEach(w=>{let{startRow:I,endRow:v,startColumn:M,endColumn:_}=w;i.Rectangle.intersects(w,r)||(c?u<I&&d>v?(I-=l,v-=l):u>v&&d<=I&&(I+=l,v+=l):u<M&&d>_?(M-=l,_-=l):u>_&&d<=M&&(M+=l,_+=l)),this._checkIsRightRange({startRow:I,endRow:v,startColumn:M,endColumn:_})&&(w.startColumn=M,w.endColumn=_,w.startRow=I,w.endRow=v)})}),this.disposableCollection.dispose();const{unitId:h,subUnitId:g}=e.params,R=f=>this.refRangeHandle(f,h,g);this._selectionProtectionRuleModel.getSubunitRuleList(h,g).reduce((f,p)=>[...f,...p.ranges],[]).forEach(f=>{this.disposableCollection.add(this._refRangeService.registerRefRange(f,R,h,g))}),this._selectionProtectionRenderModel.clear()}if(Cs.includes(e.id)){const n=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!n)return;const s=n.getSheetBySheetId(e.params.subUnitId);if(!s)return;const r=e.params;if(!r)return;const{range:a}=r,c=e.id.includes("row"),l=e.id.includes("insert"),u=c?a.startRow:a.startColumn,d=c?a.endRow:a.endColumn,m=d-u+1;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),s.getSheetId()).forEach(p=>{p.ranges.forEach(I=>{let{startRow:v,endRow:M,startColumn:_,endColumn:E}=I;l?c?u<=v&&(v+=m,M+=m):u<=_&&(_+=m,E+=m):c?d<v&&(v-=m,M-=m):d<_&&(_-=m,E-=m),this._checkIsRightRange({startRow:v,endRow:M,startColumn:_,endColumn:E})&&(I.startColumn=_,I.endColumn=E,I.startRow=v,I.endRow=M)})}),this.disposableCollection.dispose();const{unitId:g,subUnitId:R}=e.params,C=p=>this.refRangeHandle(p,g,R);this._selectionProtectionRuleModel.getSubunitRuleList(g,R).reduce((p,w)=>[...p,...w.ranges],[]).forEach(p=>{this.disposableCollection.add(this._refRangeService.registerRefRange(p,C,g,R))}),this._selectionProtectionRenderModel.clear()}}))}_checkIsRightRange(e){return e.startRow<=e.endRow&&e.startColumn<=e.endColumn}_initReBuildCache(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(Cs.includes(e.id)||Ss.includes(e.id)){const{unitId:n,subUnitId:s}=e.params;this._rangeProtectionCache.reBuildCache(n,s)}}))}_initRemoveSheet(){this._sheetInterceptorService.interceptCommand({getMutations:e=>{const n=[],s=[],r=[],a=[];if(e.id===Nn.id){const c=e.params,l=[],u=[];this._rangeProtectionRuleModel.getSubunitRuleList(c.unitId,c.subUnitId).forEach(d=>{l.push(d.id),u.push(d)}),l.length&&u.length&&(r.push({id:ke.id,params:{unitId:c.unitId,subUnitId:c.subUnitId,ruleIds:l}}),n.push({id:fe.id,params:{unitId:c.unitId,subUnitId:c.subUnitId,name:"",rules:u}}))}return{redos:s,undos:n,preRedos:r,preUndos:a}}})}};exports.RangeProtectionRefRangeService=wu([Le(0,i.Inject(J)),Le(1,i.Inject(i.IUniverInstanceService)),Le(2,i.ICommandService),Le(3,i.Inject(exports.RefRangeService)),Le(4,i.Inject(exports.RangeProtectionRenderModel)),Le(5,i.Inject(exports.RangeProtectionCache)),Le(6,i.Inject(exports.SheetInterceptorService)),Le(7,i.Inject(J))],exports.RangeProtectionRefRangeService);var Mu=Object.getOwnPropertyDescriptor,yu=(o,t,e,n)=>{for(var s=n>1?void 0:n?Mu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},kt=(o,t)=>(e,n)=>t(e,n,o);const _u="SHEET_RANGE_PROTECTION_PLUGIN";exports.RangeProtectionService=class extends i.Disposable{constructor(t,e,n,s,r){super(),this._selectionProtectionRuleModel=t,this._permissionService=e,this._resourceManagerService=n,this._selectionProtectionCache=s,this._univerInstanceService=r,this._initSnapshot(),this._initRuleChange()}_initRuleChange(){this.disposeWithMe(this._selectionProtectionRuleModel.ruleChange$.subscribe(t=>{switch(t.type){case"add":{ie().forEach(e=>{const n=new e(t.unitId,t.subUnitId,t.rule.permissionId);this._permissionService.addPermissionPoint(n)});break}case"delete":{ie().forEach(e=>{const n=new e(t.unitId,t.subUnitId,t.rule.permissionId);this._permissionService.deletePermissionPoint(n.id)});break}case"set":{t.oldRule.permissionId!==t.rule.permissionId&&ie().forEach(e=>{const n=new e(t.unitId,t.subUnitId,t.oldRule.permissionId);this._permissionService.deletePermissionPoint(n.id);const s=new e(t.unitId,t.subUnitId,t.rule.permissionId);this._permissionService.addPermissionPoint(s)});break}}}))}_initSnapshot(){const t=n=>{const r=this._selectionProtectionRuleModel.toObject()[n];return r?JSON.stringify(r):""},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t,parseJson:e,pluginName:_u,businesses:[an.UNIVER_SHEET],onLoad:(n,s)=>{const r=this._selectionProtectionRuleModel.toObject();r[n]=s,this._selectionProtectionRuleModel.fromObject(r);const a=[];Object.keys(s).forEach(c=>{const l=s[c];this._selectionProtectionRuleModel.getSubunitRuleList(n,c).forEach(u=>{a.push({objectID:u.permissionId,unitID:n,objectType:N.SelectRange,actions:Be})}),l.forEach(u=>{ie().forEach(d=>{const m=new d(n,c,u.permissionId);m.value=!1,this._permissionService.addPermissionPoint(m)})}),this._selectionProtectionCache.reBuildCache(n,c)})},onUnLoad:n=>{this._selectionProtectionCache.deleteUnit(n)}}))}};exports.RangeProtectionService=yu([kt(0,i.Inject(J)),kt(1,i.Inject(i.IPermissionService)),kt(2,i.Inject(i.IResourceManagerService)),kt(3,i.Inject(exports.RangeProtectionCache)),kt(4,i.Inject(i.IUniverInstanceService))],exports.RangeProtectionService);var bu=Object.getOwnPropertyDescriptor,Eu=(o,t,e,n)=>{for(var s=n>1?void 0:n?bu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},Tu=(o,t)=>(e,n)=>t(e,n,o);exports.SheetRangeThemeService=class extends i.Disposable{constructor(t){super(),this._sheetRangeThemeModel=t}registerRangeTheme(t,e){this._sheetRangeThemeModel.registerRangeThemeStyle(t,e)}removeRangeThemeRule(t,e){this._sheetRangeThemeModel.removeRangeThemeRule(t,e)}getALLRegisterThemes(t){return this._sheetRangeThemeModel.getALLRegisteredTheme(t)}registerRangeThemeStyle(t,e){this._sheetRangeThemeModel.registerRangeThemeRule(t,e)}getAppliedRangeThemeStyle(t){return this._sheetRangeThemeModel.getRegisteredRangeThemeStyle(t)}getRegisteredRangeThemes(){return this._sheetRangeThemeModel.getRegisteredRangeThemes()}};exports.SheetRangeThemeService=Eu([Tu(0,i.Inject(exports.SheetRangeThemeModel))],exports.SheetRangeThemeService);var Uu=Object.defineProperty,Pu=Object.getOwnPropertyDescriptor,ku=(o,t,e)=>t in o?Uu(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,Nu=(o,t,e,n)=>{for(var s=n>1?void 0:n?Pu(t,e):t,r=o.length-1,a;r>=0;r--)(a=o[r])&&(s=a(s)||s);return s},fs=(o,t)=>(e,n)=>t(e,n,o),Ni=(o,t,e)=>ku(o,typeof t!="symbol"?t+"":t,e);const Ou="SHEET_PLUGIN";exports.UniverSheetsPlugin=class extends i.Plugin{constructor(t=hs,e,n){super(),this._config=t,this._injector=e,this._configService=n;const{...s}=i.merge({},hs,this._config);this._configService.setConfig(Ui,s),this._initConfig(),this._initDependencies()}_initConfig(){var t,e,n;(t=this._config)!=null&&t.onlyRegisterFormulaRelatedMutations&&this._configService.setConfig(Pi,!0),(e=this._config)!=null&&e.isRowStylePrecedeColumnStyle&&this._configService.setConfig(i.IS_ROW_STYLE_PRECEDE_COLUMN_STYLE,!0),(n=this._config)!=null&&n.autoHeightForMergedCells&&this._configService.setConfig(i.AUTO_HEIGHT_FOR_MERGED_CELLS,!0)}_initDependencies(){var e;const t=[[ot],[exports.SheetsSelectionsService],[exports.RefRangeService],[exports.WorkbookPermissionService],[tt,{useClass:exports.NumfmtService}],[exports.SheetInterceptorService],[exports.SheetRangeThemeService],[exports.SheetSkeletonService],[Rn],[exports.MergeCellController],[Sn],[exports.DefinedNameDataController],[exports.ZebraCrossingCacheController],[exports.SheetsFreezeSyncController],[exports.WorksheetPermissionService],[Oe],[Tt],[fn],[exports.SheetPermissionInitController],[exports.SheetPermissionCheckController],[exports.SheetRangeThemeModel],[exports.RangeProtectionRenderModel],[J],[exports.RangeProtectionCache],[exports.RangeProtectionRefRangeService],[exports.RangeProtectionService],[zn,{useClass:ki,deps:[exports.SheetsSelectionsService]}]];(e=this._config)!=null&&e.notExecuteFormula||t.push([Cn]),i.registerDependencies(this._injector,i.mergeOverrideWithDependencies(t,this._config.override)),i.touchDependencies(this._injector,[[exports.SheetInterceptorService],[exports.RangeProtectionService],[zn],[exports.SheetPermissionInitController],[exports.SheetsFreezeSyncController]])}onStarting(){i.touchDependencies(this._injector,[[Rn],[exports.MergeCellController],[exports.WorkbookPermissionService],[exports.WorksheetPermissionService],[fn],[exports.SheetSkeletonService]])}onRendered(){i.touchDependencies(this._injector,[[tt]])}onReady(){i.touchDependencies(this._injector,[[Cn],[exports.DefinedNameDataController],[exports.ZebraCrossingCacheController],[exports.SheetRangeThemeModel],[Sn],[exports.RangeProtectionRenderModel],[exports.RangeProtectionRefRangeService],[exports.RefRangeService],[exports.SheetPermissionCheckController]])}};Ni(exports.UniverSheetsPlugin,"pluginName",Ou);Ni(exports.UniverSheetsPlugin,"type",i.UniverInstanceType.UNIVER_SHEET);exports.UniverSheetsPlugin=Nu([i.DependentOn(Y.UniverFormulaEnginePlugin),fs(1,i.Inject(i.Injector)),fs(2,i.IConfigService)],exports.UniverSheetsPlugin);const Du={WorkbookCommentPermission:eo,WorkbookCopyPermission:to,WorkbookCreateProtectPermission:no,WorkbookCreateSheetPermission:oo,WorkbookDeleteSheetPermission:so,WorkbookDuplicatePermission:ro,WorkbookEditablePermission:ue,WorkbookExportPermission:io,WorkbookHideSheetPermission:_n,WorkbookHistoryPermission:tr,WorkbookManageCollaboratorPermission:bn,WorkbookMoveSheetPermission:En,WorkbookPrintPermission:ao,WorkbookRecoverHistoryPermission:co,WorkbookRenameSheetPermission:Tn,WorkbookSharePermission:lo,WorkbookViewHistoryPermission:mo,WorkbookViewPermission:uo,WorksheetCopyPermission:ho,WorksheetDeleteColumnPermission:go,WorksheetDeleteProtectionPermission:Ro,WorksheetDeleteRowPermission:Co,WorksheetEditExtraObjectPermission:So,WorksheetEditPermission:Re,WorksheetFilterPermission:fo,WorksheetInsertColumnPermission:po,WorksheetInsertHyperlinkPermission:Io,WorksheetInsertRowPermission:vo,WorksheetManageCollaboratorPermission:wo,WorksheetPivotTablePermission:Mo,WorksheetSetCellStylePermission:yo,WorksheetSetCellValuePermission:xt,WorksheetSetColumnStylePermission:mt,WorksheetSetRowStylePermission:ht,WorksheetSortPermission:_o,WorksheetViewPermission:zt,RangeProtectionPermissionEditPoint:ge,RangeProtectionPermissionViewPoint:yn},Au=(o,t,e,n)=>{const s=o.get(i.IPermissionService),r=o.get(J),a=s.getPermissionPoint(new ue(t).id);if(!(a!=null&&a.value))return!1;const c=s.getPermissionPoint(new Re(t,e).id);if(!(c!=null&&c.value))return!1;const u=r.getSubunitRuleList(t,e).filter(d=>d.ranges.some(m=>n.some(h=>i.Rectangle.intersects(m,h))));return u.length?u.every(d=>{const m=d.permissionId,h=s.getPermissionPoint(new ge(t,e,m).id);return!!(h!=null&&h.value)}):!0},Oi=(o,t,e,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,t),{startRow:c,endRow:l}=a;let u=e.startRow-n,d=t.getMergedCell(u,e.startColumn),m=!d||d.startRow===u&&d.startColumn===e.startColumn;for(;!t.getRowVisible(u)||!m;)u--,d=t.getMergedCell(u,e.startColumn),m=!d||d.startRow===u&&d.startColumn===e.startColumn;if(u>=c)return{...e,startRow:u,endRow:u};if(r){const h={...e,startRow:l,endRow:l};return Ai(o,t,h,n,s,!1)}},Di=(o,t,e,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,t),{startRow:c,endRow:l}=a;let u=e.endRow+n,d=t.getMergedCell(u,e.startColumn),m=!d||d.startRow===u&&d.startColumn===e.startColumn;for(;!t.getRowVisible(u)||!m;)u++,d=t.getMergedCell(u,e.startColumn),m=!d||d.startRow===u&&d.startColumn===e.startColumn;if(u<=l)return{...e,startRow:u,endRow:u};if(r){const h={...e,startRow:c,endRow:c};return xi(o,t,h,n,s,!1)}},Ai=(o,t,e,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,t),{startColumn:c,endColumn:l}=a;let u=e.startColumn-n,d=t.getMergedCell(e.startRow,u),m=!d||d.startRow===e.startRow&&d.startColumn===u;for(;!t.getColVisible(u)||!m;)u--,d=t.getMergedCell(e.startRow,u),m=!d||d.startRow===e.startRow&&d.startColumn===u;if(u>=c)return{...e,startColumn:u,endColumn:u};if(r){const h={...e,startColumn:l,endColumn:l};return Oi(o,t,h,n,s,!1)}},xi=(o,t,e,n=1,s=!0,r=!0)=>{const a=i.Range.transformRange(o,t),{startColumn:c,endColumn:l}=a;let u=e.endColumn+n,d=t.getMergedCell(e.startRow,u),m=!d||d.startRow===e.startRow&&d.startColumn===u;for(;!t.getColVisible(u)||!m;)u++,d=t.getMergedCell(e.startRow,u),m=!d||d.startRow===e.startRow&&d.startColumn===u;if(u<=l)return{...e,endColumn:u,startColumn:u};if(r){const h={...e,startColumn:c,endColumn:c};return Di(o,t,h,n,s,!1)}};function en(o,t,e){let n=null;return e.getMatrixWithMergedCells(o,t,o,t).forValue((r,a,c)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:c.rowSpan!==void 0||c.colSpan!==void 0,isMergedMainCell:c.rowSpan!==void 0&&c.colSpan!==void 0,endRow:r+(c.rowSpan!==void 0?c.rowSpan-1:0),endColumn:a+(c.colSpan!==void 0?c.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:t,actualRow:o,startRow:o,startColumn:t,endRow:o,endColumn:t,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}const xu=(o,t,e,n,s=1)=>{switch(n){case i.Direction.UP:return Oi(o,t,e,s);case i.Direction.DOWN:return Di(o,t,e,s);case i.Direction.LEFT:return Ai(o,t,e,s);case i.Direction.RIGHT:return xi(o,t,e,s)}},Wu=(o,t,e)=>{let n,s=-1,r;for(let p=0;p<o.length;p++)if(o[p].primary){n=o[p],s=p,r=n.primary;break}if(s===-1)return null;const a=t===i.Direction.LEFT||t===i.Direction.UP,c=a?s-1>=0?s-1:o.length-1:s+1<o.length?s+1:0,l=o[c];if(!n||!r)return null;const u={...r},{startRow:d,startColumn:m,endRow:h,endColumn:g}=n.range,R=a?u.startRow===d&&u.startColumn===m:u.endRow===h&&u.endColumn===g,C=R&&a;if(!i.Rectangle.equals(n.range,u)){const p=R?l.range:xu(n.range,e,u,t);if(!p)return null;const w=C?en(p.endRow,p.endColumn,e):en(p.startRow,p.startColumn,e);return{startRow:w.startRow,startColumn:w.startColumn,endRow:w.endRow,endColumn:w.endColumn}}const f=C?en(l.range.endRow,l.range.endColumn,e):en(l.range.startRow,l.range.startColumn,e);return{startRow:f.startRow,startColumn:f.startColumn,endRow:f.endRow,endColumn:f.endColumn}};exports.AFTER_CELL_EDIT=tn;exports.AddMergeRedoSelectionsOperationFactory=Gl;exports.AddMergeUndoMutationFactory=he;exports.AddMergeUndoSelectionsOperationFactory=zl;exports.AddRangeProtectionCommand=Gs;exports.AddRangeProtectionMutation=fe;exports.AddRangeThemeMutation=vi;exports.AddWorksheetMergeAllCommand=nl;exports.AddWorksheetMergeCommand=Jt;exports.AddWorksheetMergeHorizontalCommand=sl;exports.AddWorksheetMergeMutation=F;exports.AddWorksheetMergeVerticalCommand=ol;exports.AddWorksheetProtectionCommand=Or;exports.AddWorksheetProtectionMutation=xe;exports.AppendRowCommand=Ar;exports.BEFORE_CELL_EDIT=Hn;exports.BorderStyleManagerService=ot;exports.COMMAND_LISTENER_SKELETON_CHANGE=Ta;exports.COMMAND_LISTENER_VALUE_CHANGE=Ua;exports.CancelFrozenCommand=Jr;exports.CancelMarkDirtyRowAutoHeightMutation=yi;exports.ClearSelectionAllCommand=vn;exports.ClearSelectionContentCommand=Pn;exports.ClearSelectionFormatCommand=wn;exports.CopySheetCommand=Bo;exports.DISABLE_NORMAL_SELECTIONS=sc;exports.DeleteRangeMoveLeftCommand=je;exports.DeleteRangeMoveUpCommand=Ge;exports.DeleteRangeProtectionCommand=xr;exports.DeleteRangeProtectionMutation=ke;exports.DeleteWorksheetProtectionCommand=Wr;exports.DeleteWorksheetProtectionMutation=ze;exports.DeleteWorksheetRangeThemeStyleCommand=Vr;exports.DeleteWorksheetRangeThemeStyleMutation=Rt;exports.DeleteWorksheetRangeThemeStyleMutationFactory=Ms;exports.DeltaColumnWidthCommand=Vt;exports.DeltaRowHeightCommand=Bt;exports.EditStateEnum=js;exports.EffectRefRangId=D;exports.EmptyMutation=wi;exports.ExclusiveRangeService=ki;exports.FactoryAddRangeProtectionMutation=ec;exports.FactoryDeleteRangeProtectionMutation=Qa;exports.FactorySetRangeProtectionMutation=bl;exports.IExclusiveRangeService=zn;exports.INTERCEPTOR_POINT=De;exports.INumfmtService=tt;exports.IRefSelectionsService=Ys;exports.InsertColAfterCommand=hr;exports.InsertColBeforeCommand=mr;exports.InsertColByRangeCommand=Po;exports.InsertColCommand=ye;exports.InsertColMutation=ce;exports.InsertColMutationUndoFactory=Ht;exports.InsertDefinedNameCommand=$r;exports.InsertMultiColsLeftCommand=gr;exports.InsertMultiColsRightCommand=Rr;exports.InsertMultiRowsAboveCommand=lr;exports.InsertMultiRowsAfterCommand=ur;exports.InsertRangeMoveDownCommand=Xe;exports.InsertRangeMoveRightCommand=ft;exports.InsertRowAfterCommand=cr;exports.InsertRowBeforeCommand=ar;exports.InsertRowByRangeCommand=Uo;exports.InsertRowCommand=Me;exports.InsertRowMutation=ae;exports.InsertRowMutationUndoFactory=pn;exports.InsertSheetCommand=Lr;exports.InsertSheetMutation=wt;exports.InsertSheetUndoMutationFactory=Lo;exports.InterceptCellContentPriority=ps;exports.MAX_CELL_PER_SHEET_KEY=Ti;exports.MERGE_CELL_INTERCEPTOR_CHECK=kr;exports.MarkDirtyRowAutoHeightMutation=Mi;exports.MoveColsCommand=It;exports.MoveColsMutation=we;exports.MoveColsMutationUndoFactory=_s;exports.MoveRangeCommand=qe;exports.MoveRangeMutation=He;exports.MoveRowsCommand=pt;exports.MoveRowsMutation=ve;exports.MoveRowsMutationUndoFactory=ys;exports.OperatorType=L;exports.PermissionPointsDefinitions=Du;exports.REF_SELECTIONS_ENABLED=qs;exports.RangeMergeUtil=$a;exports.RangeProtectionPermissionDeleteProtectionPoint=Vo;exports.RangeProtectionPermissionEditPoint=ge;exports.RangeProtectionPermissionManageCollaPoint=$o;exports.RangeProtectionPermissionViewPoint=yn;exports.RangeProtectionRuleModel=J;exports.RangeThemeStyle=We;exports.RegisterWorksheetRangeThemeStyleCommand=Br;exports.RegisterWorksheetRangeThemeStyleMutation=Mt;exports.RemoveColByRangeCommand=No;exports.RemoveColCommand=Yt;exports.RemoveColMutation=ne;exports.RemoveDefinedNameCommand=Fo;exports.RemoveMergeUndoMutationFactory=se;exports.RemoveNumfmtMutation=Qo;exports.RemoveRangeThemeMutation=_i;exports.RemoveRowByRangeCommand=ko;exports.RemoveRowCommand=qt;exports.RemoveRowMutation=le;exports.RemoveSheetCommand=Nn;exports.RemoveSheetMutation=nt;exports.RemoveSheetUndoMutationFactory=Cr;exports.RemoveWorksheetMergeCommand=Fr;exports.RemoveWorksheetMergeMutation=H;exports.ReorderRangeCommand=un;exports.ReorderRangeMutation=At;exports.ReorderRangeUndoMutationFactory=bs;exports.ResetBackgroundColorCommand=si;exports.ResetTextColorCommand=ni;exports.SCOPE_WORKBOOK_VALUE_DEFINED_NAME=Xl;exports.SELECTIONS_ENABLED=rc;exports.SELECTION_CONTROL_BORDER_BUFFER_COLOR=Ba;exports.SELECTION_CONTROL_BORDER_BUFFER_WIDTH=La;exports.ScrollToCellOperation=Ei;exports.SelectRangeCommand=Js;exports.SelectionMoveType=ee;exports.SetBackgroundColorCommand=oi;exports.SetBoldCommand=Pl;exports.SetBorderBasicCommand=zr;exports.SetBorderColorCommand=Gr;exports.SetBorderCommand=Ut;exports.SetBorderPositionCommand=Hr;exports.SetBorderStyleCommand=jr;exports.SetColDataCommand=qr;exports.SetColDataMutation=rt;exports.SetColDataMutationFactory=Es;exports.SetColHiddenCommand=mn;exports.SetColHiddenMutation=Ct;exports.SetColVisibleMutation=St;exports.SetColWidthCommand=$t;exports.SetDefinedNameCommand=Go;exports.SetFontFamilyCommand=Al;exports.SetFontSizeCommand=xl;exports.SetFrozenCommand=Kr;exports.SetFrozenMutation=Pe;exports.SetFrozenMutationFactory=zo;exports.SetGridlinesColorCommand=Xr;exports.SetGridlinesColorMutation=it;exports.SetHorizontalTextAlignCommand=ii;exports.SetItalicCommand=kl;exports.SetNumfmtMutation=An;exports.SetOverlineCommand=Dl;exports.SetProtectionCommand=Zr;exports.SetRangeProtectionMutation=Z;exports.SetRangeThemeMutation=bi;exports.SetRangeValuesCommand=Et;exports.SetRangeValuesMutation=B;exports.SetRangeValuesUndoMutationFactory=me;exports.SetRowDataCommand=Qr;exports.SetRowDataMutation=at;exports.SetRowDataMutationFactory=Us;exports.SetRowHeightCommand=Ft;exports.SetRowHiddenCommand=hn;exports.SetRowHiddenMutation=Je;exports.SetRowVisibleMutation=Ke;exports.SetSelectedColsVisibleCommand=jo;exports.SetSelectedRowsVisibleCommand=qo;exports.SetSelectionsOperation=G;exports.SetSpecificColsVisibleCommand=yt;exports.SetSpecificRowsVisibleCommand=_t;exports.SetStrikeThroughCommand=Ol;exports.SetStyleCommand=Q;exports.SetTabColorCommand=li;exports.SetTabColorMutation=Ot;exports.SetTextColorCommand=ti;exports.SetTextRotationCommand=ci;exports.SetTextWrapCommand=ai;exports.SetUnderlineCommand=Nl;exports.SetVerticalTextAlignCommand=ri;exports.SetWorkbookNameCommand=Ko;exports.SetWorkbookNameMutation=Yo;exports.SetWorksheetActivateCommand=Jo;exports.SetWorksheetActiveOperation=bt;exports.SetWorksheetColWidthMutation=Ae;exports.SetWorksheetColWidthMutationFactory=Yn;exports.SetWorksheetColumnCountCommand=ui;exports.SetWorksheetColumnCountMutation=ct;exports.SetWorksheetColumnCountUndoMutationFactory=Ps;exports.SetWorksheetDefaultStyleCommand=di;exports.SetWorksheetDefaultStyleMutation=lt;exports.SetWorksheetDefaultStyleMutationFactory=ks;exports.SetWorksheetHideCommand=hi;exports.SetWorksheetHideMutation=Fe;exports.SetWorksheetNameCommand=On;exports.SetWorksheetNameMutation=Lt;exports.SetWorksheetOrderCommand=Xo;exports.SetWorksheetOrderMutation=Dt;exports.SetWorksheetPermissionPointsCommand=gi;exports.SetWorksheetPermissionPointsMutation=Un;exports.SetWorksheetProtectionCommand=Ri;exports.SetWorksheetProtectionMutation=Ye;exports.SetWorksheetRangeThemeStyleCommand=Dr;exports.SetWorksheetRangeThemeStyleMutation=gt;exports.SetWorksheetRangeThemeStyleMutationFactory=ws;exports.SetWorksheetRightToLeftCommand=Fl;exports.SetWorksheetRightToLeftMutation=rn;exports.SetWorksheetRowAutoHeightMutation=Jn;exports.SetWorksheetRowAutoHeightMutationFactory=Ea;exports.SetWorksheetRowCountCommand=Ci;exports.SetWorksheetRowCountMutation=ut;exports.SetWorksheetRowCountUndoMutationFactory=Ns;exports.SetWorksheetRowHeightMutation=Te;exports.SetWorksheetRowIsAutoHeightCommand=Dn;exports.SetWorksheetRowIsAutoHeightMutation=Se;exports.SetWorksheetShowCommand=Zo;exports.SheetSkeletonChangeType=Ds;exports.SheetValueChangeType=As;exports.SplitDelimiterEnum=$s;exports.SplitTextToColumnsCommand=Si;exports.ToggleCellCheckboxCommand=fi;exports.ToggleGridlinesCommand=pi;exports.ToggleGridlinesMutation=dt;exports.UnitAction=y;exports.UnitObject=N;exports.UnregisterWorksheetRangeThemeStyleCommand=Ii;exports.UnregisterWorksheetRangeThemeStyleMutation=kn;exports.VALIDATE_CELL=nn;exports.ViewStateEnum=Hs;exports.WorkbookCommentPermission=eo;exports.WorkbookCopyPermission=to;exports.WorkbookCopySheetPermission=Zs;exports.WorkbookCreateProtectPermission=no;exports.WorkbookCreateSheetPermission=oo;exports.WorkbookDeleteColumnPermission=Qs;exports.WorkbookDeleteRowPermission=er;exports.WorkbookDeleteSheetPermission=so;exports.WorkbookDuplicatePermission=ro;exports.WorkbookEditablePermission=ue;exports.WorkbookExportPermission=io;exports.WorkbookHideSheetPermission=_n;exports.WorkbookHistoryPermission=tr;exports.WorkbookInsertColumnPermission=nr;exports.WorkbookInsertRowPermission=or;exports.WorkbookManageCollaboratorPermission=bn;exports.WorkbookMoveSheetPermission=En;exports.WorkbookPrintPermission=ao;exports.WorkbookRecoverHistoryPermission=co;exports.WorkbookRenameSheetPermission=Tn;exports.WorkbookSelectionModel=zs;exports.WorkbookSharePermission=lo;exports.WorkbookViewHistoryPermission=mo;exports.WorkbookViewPermission=uo;exports.WorksheetCopyPermission=ho;exports.WorksheetDeleteColumnPermission=go;exports.WorksheetDeleteProtectionPermission=Ro;exports.WorksheetDeleteRowPermission=Co;exports.WorksheetEditExtraObjectPermission=So;exports.WorksheetEditPermission=Re;exports.WorksheetFilterPermission=fo;exports.WorksheetInsertColumnPermission=po;exports.WorksheetInsertHyperlinkPermission=Io;exports.WorksheetInsertRowPermission=vo;exports.WorksheetManageCollaboratorPermission=wo;exports.WorksheetPivotTablePermission=Mo;exports.WorksheetProtectionPointModel=Tt;exports.WorksheetProtectionRuleModel=Oe;exports.WorksheetSelectProtectedCellsPermission=gc;exports.WorksheetSelectUnProtectedCellsPermission=Rc;exports.WorksheetSetCellStylePermission=yo;exports.WorksheetSetCellValuePermission=xt;exports.WorksheetSetColumnStylePermission=mt;exports.WorksheetSetRowStylePermission=ht;exports.WorksheetSortPermission=_o;exports.WorksheetViewPermission=zt;exports.addMergeCellsUtil=rl;exports.adjustRangeOnMutation=Ur;exports.alignToMergedCellsBorders=Gt;exports.baseProtectionActions=Be;exports.checkCellValueType=Fn;exports.checkRangesEditablePermission=Au;exports.convertPrimaryWithCoordToPrimary=Vs;exports.convertSelectionDataToRange=Fa;exports.copyRangeStyles=Ve;exports.createTopMatrixFromMatrix=Ws;exports.createTopMatrixFromRanges=xs;exports.defaultWorkbookPermissionPoints=Nr;exports.defaultWorksheetPermissionPoint=sn;exports.expandToContinuousRange=Wa;exports.factoryRemoveNumfmtUndoMutation=jl;exports.factorySetNumfmtUndoMutation=Hl;exports.findAllRectangle=Xn;exports.findFirstNonEmptyCell=Xa;exports.followSelectionOperation=Ne;exports.generateNullCell=Qn;exports.generateNullCellValue=Bs;exports.getAddMergeMutationRangeByType=Wo;exports.getAllRangePermissionPoint=ie;exports.getAllWorkbookPermissionPoint=vt;exports.getAllWorksheetPermissionPoint=re;exports.getAllWorksheetPermissionPointByPointPanel=Ce;exports.getCellAtRowCol=ic;exports.getDefaultRangePermission=il;exports.getInsertRangeMutations=bo;exports.getMoveRangeUndoRedoMutations=Mn;exports.getNextPrimaryCell=Wu;exports.getPrimaryForRange=oe;exports.getRemoveRangeMutations=Eo;exports.getSelectionsService=Ks;exports.getSeparateEffectedRangesOnCommand=Bc;exports.getSheetCommandTarget=P;exports.getSheetCommandTargetWorkbook=qn;exports.getSheetMutationTarget=_e;exports.getSkeletonChangedEffectedRange=ka;exports.getValueChangedEffectedRange=Pa;exports.getVisibleRanges=jt;exports.handleBaseInsertRange=Qe;exports.handleBaseMoveRowsCols=Wt;exports.handleBaseRemoveRange=Ze;exports.handleCommonDefaultRangeChangeWithEffectRefCommands=Gn;exports.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests=$c;exports.handleDefaultRangeChangeWithEffectRefCommands=jn;exports.handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests=Vc;exports.handleDeleteRangeMoveLeft=Er;exports.handleDeleteRangeMoveUp=Tr;exports.handleDeleteRangeMutation=Sc;exports.handleIRemoveCol=xo;exports.handleIRemoveRow=wr;exports.handleInsertCol=yr;exports.handleInsertRangeMoveDown=_r;exports.handleInsertRangeMoveRight=br;exports.handleInsertRangeMutation=Cc;exports.handleInsertRow=Mr;exports.handleMoveCols=Ao;exports.handleMoveRange=vr;exports.handleMoveRows=Do;exports.isSingleCellSelection=cc;exports.rangeMerge=Zn;exports.rangeToDiscreteRange=Fs;exports.rotateRange=de;exports.runRefRangeMutations=et;exports.setEndForRange=ac;exports.splitRangeText=Ls;exports.transformCellsToRange=gn;
