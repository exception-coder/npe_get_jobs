(function(g,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/core"),require("rxjs"),require("rxjs/operators"),require("@univerjs/engine-formula"),require("@univerjs/rpc")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","rxjs","rxjs/operators","@univerjs/engine-formula","@univerjs/rpc"],i):(g=typeof globalThis<"u"?globalThis:g||self,i(g.UniverSheets={},g.UniverCore,g.rxjs,g.rxjs.operators,g.UniverEngineFormula,g.UniverRpc))})(this,(function(g,i,O,kt,J,$i){"use strict";var Wd=Object.defineProperty;var Vd=(g,i,O)=>i in g?Wd(g,i,{enumerable:!0,configurable:!0,writable:!0,value:O}):g[i]=O;var f=(g,i,O)=>Vd(g,typeof i!="symbol"?i+"":i,O);function Li(s,t,e){var r,a,u;if(t.t)return t.t;if(t.v===null)return null;const n=s.getStyleByCell(t),o=s.getStyleByCell(e);if(e.t===i.CellValueType.FORCE_STRING){if(!i.isTextFormat((r=o==null?void 0:o.n)==null?void 0:r.pattern)&&t.v!==void 0){if(i.isRealNum(t.v))return i.CellValueType.NUMBER;if(i.isBooleanString(`${t.v}`))return i.CellValueType.BOOLEAN}return i.CellValueType.FORCE_STRING}return Bi(n)?i.isTextFormat((a=n==null?void 0:n.n)==null?void 0:a.pattern)?i.CellValueType.STRING:eo(t,e):i.isTextFormat((u=o==null?void 0:o.n)==null?void 0:u.pattern)?i.CellValueType.STRING:eo(t,e)}function eo(s,t){return s.v!==void 0?Vn(s.v,s.t):Vn(t.v,t.t)}function Bi(s){var t;return!!((t=s==null?void 0:s.n)!=null&&t.pattern)}function Vn(s,t){return s===null?null:typeof s=="string"?i.isRealNum(s)?(+s==0||+s==1)&&t===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:t!==i.CellValueType.STRING&&t!==i.CellValueType.FORCE_STRING&&i.willLoseNumericPrecision(s)?i.CellValueType.FORCE_STRING:i.CellValueType.NUMBER:i.isBooleanString(s)?i.CellValueType.BOOLEAN:i.CellValueType.STRING:typeof s=="number"?(s===0||s===1)&&t===i.CellValueType.BOOLEAN?i.CellValueType.BOOLEAN:i.CellValueType.NUMBER:typeof s=="boolean"?i.CellValueType.BOOLEAN:i.CellValueType.FORCE_STRING}const ge=(s,t)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:i.Tools.deepClone(t.ranges)}},j={id:"sheet.mutation.add-worksheet-merge",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(!o)return!1;const a=o.getConfig().mergeData,u=t.ranges;for(let l=0;l<u.length;l++)a.push(u[l]);return o.getSpanModel().rebuild(a),!0}},Hi=i.createInterceptorKey("CELL_CONTENT"),Fi=i.createInterceptorKey("ROW_FILTERED"),Ae={CELL_CONTENT:Hi,ROW_FILTERED:Fi};var to=(s=>(s[s.DATA_VALIDATION=9]="DATA_VALIDATION",s[s.NUMFMT=10]="NUMFMT",s[s.CELL_IMAGE=11]="CELL_IMAGE",s))(to||{});const no="sheet.interceptor.range-theme-id",so="sheet.interceptor.ignore-range-theme";var ji=Object.getOwnPropertyDescriptor,Gi=(s,t,e,n)=>{for(var o=n>1?void 0:n?ji(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},zi=(s,t)=>(e,n)=>t(e,n,s);const $n=i.createInterceptorKey("BEFORE_CELL_EDIT"),Zt=i.createInterceptorKey("AFTER_CELL_EDIT"),Qt=i.createInterceptorKey("VALIDATE_CELL");g.SheetInterceptorService=class extends i.Disposable{constructor(e){super();f(this,"_interceptorsByName",new Map);f(this,"_commandInterceptors",[]);f(this,"_rangeInterceptors",[]);f(this,"_autoHeightInterceptors",[]);f(this,"_beforeCommandInterceptor",[]);f(this,"_afterCommandInterceptors",[]);f(this,"_workbookDisposables",new Map);f(this,"_worksheetDisposables",new Map);f(this,"_interceptorsDirty",!1);f(this,"_composedInterceptorByKey",new Map);f(this,"writeCellInterceptor",new i.InterceptorManager({BEFORE_CELL_EDIT:$n,AFTER_CELL_EDIT:Zt,VALIDATE_CELL:Qt}));this._univerInstanceService=e,this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._interceptWorkbook(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>this._disposeWorkbookInterceptor(n))),this.intercept(Ae.CELL_CONTENT,{priority:-1,effect:i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value,handler:n=>n}),this.disposeWithMe(this.writeCellInterceptor.intercept(Zt,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept($n,{priority:-1,handler:n=>n})),this.disposeWithMe(this.writeCellInterceptor.intercept(Qt,{priority:-1,handler:n=>n}))}dispose(){super.dispose(),this._workbookDisposables.forEach(e=>e.dispose()),this._workbookDisposables.clear(),this._worksheetDisposables.forEach(e=>e.dispose()),this._worksheetDisposables.clear(),this._interceptorsByName.clear()}interceptCommand(e){if(this._commandInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._commandInterceptors.push(e),this._commandInterceptors.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._commandInterceptors,e)))}onCommandExecute(e){const n=this._commandInterceptors.map(o=>o.getMutations(e));return{preUndos:n.map(o=>{var r;return(r=o.preUndos)!=null?r:[]}).flat(),undos:n.map(o=>o.undos).flat(),preRedos:n.map(o=>{var r;return(r=o.preRedos)!=null?r:[]}).flat(),redos:n.map(o=>o.redos).flat()}}interceptAfterCommand(e){if(this._afterCommandInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._afterCommandInterceptors.push(e),this._afterCommandInterceptors.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._afterCommandInterceptors,e)))}afterCommandExecute(e){const n=this._afterCommandInterceptors.map(o=>o.getMutations(e));return{undos:n.map(o=>o.undos).flat(),redos:n.map(o=>o.redos).flat()}}interceptAutoHeight(e){if(this._autoHeightInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._autoHeightInterceptors.push(e),this._autoHeightInterceptors.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._autoHeightInterceptors,e)))}generateMutationsOfAutoHeight(e){const n=this._autoHeightInterceptors.map(o=>o.getMutations(e));return{preUndos:n.map(o=>{var r;return(r=o.preUndos)!=null?r:[]}).flat(),undos:n.map(o=>o.undos).flat(),preRedos:n.map(o=>{var r;return(r=o.preRedos)!=null?r:[]}).flat(),redos:n.map(o=>o.redos).flat()}}interceptBeforeCommand(e){if(this._beforeCommandInterceptor.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._beforeCommandInterceptor.push(e),this._beforeCommandInterceptor.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._beforeCommandInterceptor,e)))}async beforeCommandExecute(e){return(await Promise.all(this._beforeCommandInterceptor.map(o=>o.performCheck(e)))).every(o=>o)}interceptRanges(e){if(this._rangeInterceptors.includes(e))throw new Error("[SheetInterceptorService]: Interceptor already exists!");return this._rangeInterceptors.push(e),this._rangeInterceptors.sort((n,o)=>{var r,a;return((r=o.priority)!=null?r:0)-((a=n.priority)!=null?a:0)}),this.disposeWithMe(i.toDisposable(()=>i.remove(this._rangeInterceptors,e)))}generateMutationsByRanges(e){const n=this._rangeInterceptors.map(o=>o.getMutations(e));return{preUndos:n.map(o=>{var r;return(r=o.preUndos)!=null?r:[]}).flat(),undos:n.map(o=>o.undos).flat(),preRedos:n.map(o=>{var r;return(r=o.preRedos)!=null?r:[]}).flat(),redos:n.map(o=>o.redos).flat()}}onWriteCell(e,n,o,r,a){const u={subUnitId:n.getSheetId(),unitId:e.getUnitId(),workbook:e,worksheet:n,row:o,col:r,origin:i.Tools.deepClone(a)};return this.writeCellInterceptor.fetchThroughInterceptors(Zt)(a,u)}onValidateCell(e,n,o,r){const a={subUnitId:n.getSheetId(),unitId:e.getUnitId(),workbook:e,worksheet:n,row:o,col:r};return this.writeCellInterceptor.fetchThroughInterceptors(Qt)(Promise.resolve(!0),a)}intercept(e,n){const o=e;this._interceptorsByName.has(o)||this._interceptorsByName.set(o,[]);const r=this._interceptorsByName.get(o);r.push(n);const a=r.sort((u,l)=>{var d,c;return((d=l.priority)!=null?d:0)-((c=u.priority)!=null?c:0)});if(this._interceptorsDirty=!0,o===Ae.CELL_CONTENT){const u=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;this._interceptorsByName.set(`${o}-${u}`,a);const l=i.InterceptorEffectEnum.Style|i.InterceptorEffectEnum.Value;return this._interceptorsByName.set(`${o}-${i.InterceptorEffectEnum.Style}`,a.filter(d=>((d.effect||l)&i.InterceptorEffectEnum.Style)>0)),this._interceptorsByName.set(`${o}-${i.InterceptorEffectEnum.Value}`,a.filter(d=>((d.effect||l)&i.InterceptorEffectEnum.Value)>0)),this.disposeWithMe(i.toDisposable(()=>{i.remove(this._interceptorsByName.get(o),n),i.remove(this._interceptorsByName.get(`${o}-${u}`),n),i.remove(this._interceptorsByName.get(`${o}-${i.InterceptorEffectEnum.Style}`),n),i.remove(this._interceptorsByName.get(`${o}-${i.InterceptorEffectEnum.Value}`),n)}))}else return this._interceptorsByName.set(o,a),this.disposeWithMe(i.toDisposable(()=>i.remove(this._interceptorsByName.get(o),n)))}fetchThroughInterceptors(e,n,o,r){const a=n===void 0?e:`${e}-${n}`,u=o!=null?o:a;let l=this._composedInterceptorByKey.get(u);if(!l||this._interceptorsDirty){let d=this._interceptorsByName.get(a);d&&r&&(d=d.filter(r)),l=i.composeInterceptors(d||[]),this._composedInterceptorByKey.set(u,l)}return l}_interceptWorkbook(e){const n=new i.DisposableCollection,o=e.getUnitId(),r=this,a=u=>{const l=u.getSheetId();u.__interceptViewModel(d=>{const c=new i.DisposableCollection;r._worksheetDisposables.set(oo(o,u),c),c.add(d.registerCellContentInterceptor({getCell(m,h,R,C,S){const I=u.getCellRaw(m,h);return r.fetchThroughInterceptors(Ae.CELL_CONTENT,R,C,S)(I,{unitId:o,subUnitId:l,row:m,col:h,worksheet:u,workbook:e,rawData:I})}})),c.add(d.registerRowFilteredInterceptor({getRowFiltered(m){return!!r.fetchThroughInterceptors(Ae.ROW_FILTERED)(!1,{unitId:o,subUnitId:l,row:m,workbook:e,worksheet:u})}}))})};e.getSheets().forEach(u=>a(u)),n.add(e.sheetCreated$.subscribe(u=>a(u))),n.add(i.toDisposable(()=>e.getSheets().forEach(u=>this._disposeSheetInterceptor(o,u)))),n.add(e.sheetDisposed$.subscribe(u=>this._disposeSheetInterceptor(o,u))),this._workbookDisposables.set(o,n)}_disposeWorkbookInterceptor(e){const n=e.getUnitId(),o=this._workbookDisposables.get(n);o&&(o.dispose(),this._workbookDisposables.delete(n))}_disposeSheetInterceptor(e,n){const o=oo(e,n),r=this._worksheetDisposables.get(o);r&&(r.dispose(),this._worksheetDisposables.delete(o))}},g.SheetInterceptorService=Gi([zi(0,i.IUniverInstanceService)],g.SheetInterceptorService);function oo(s,t){return`${s}|${t.getSheetId()}`}const Z=s=>{const t={};return s.bg&&(t.bg={...s.bg}),s.ol&&(t.ol={...s.ol}),s.bd&&(t.bd={...s.bd}),s.cl&&(t.cl={...s.cl}),s.ht&&(t.ht=s.ht),s.vt&&(t.vt=s.vt),s.bl!==void 0&&(t.bl=s.bl),t};function qi(s){const t={};if(s.length===1)return s[0];for(const e of s)e.bg&&(t.bg=e.bg),e.ol&&(t.ol=e.ol),e.bd&&(t.bd={...t.bd,...e.bd}),e.cl&&(t.cl=e.cl),e.ht&&(t.ht=e.ht),e.vt&&(t.vt=e.vt),e.bl!==void 0&&(t.bl=e.bl);return t}const x={wholeStyle:1,headerRowStyle:2,headerColumnStyle:4,firstRowStyle:8,secondRowStyle:16,lastRowStyle:32,firstColumnStyle:128,secondColumnStyle:256,lastColumnStyle:512};class We{constructor(t,e){f(this,"_name");f(this,"wholeStyle",null);f(this,"headerRowStyle",null);f(this,"headerColumnStyle",null);f(this,"firstRowStyle",null);f(this,"secondRowStyle",null);f(this,"lastRowStyle",null);f(this,"firstColumnStyle",null);f(this,"secondColumnStyle",null);f(this,"lastColumnStyle",null);f(this,"_mergeCacheMap",new Map);e&&this.fromJson({...e,name:t}),this._name=t}getName(){return this._name}getWholeStyle(){return this.wholeStyle}setWholeStyle(t){this.wholeStyle=t,this._resetStyleCache()}getFirstRowStyle(){return this.firstRowStyle}setFirstRowStyle(t){this.firstRowStyle=t,this._resetStyleCache()}getSecondRowStyle(){return this.secondRowStyle}setSecondRowStyle(t){this.secondRowStyle=t,this._resetStyleCache()}getLastRowStyle(){return this.lastRowStyle}setLastRowStyle(t){this.lastRowStyle=t,this._resetStyleCache()}getFirstColumnStyle(){return this.firstColumnStyle}setFirstColumnStyle(t){this.firstColumnStyle=t,this._resetStyleCache()}getSecondColumnStyle(){return this.secondColumnStyle}setSecondColumnStyle(t){this.secondColumnStyle=t,this._resetStyleCache()}getLastColumnStyle(){return this.lastColumnStyle}setLastColumnStyle(t){this.lastColumnStyle=t,this._resetStyleCache()}getHeaderRowStyle(){return this.headerRowStyle}setHeaderRowStyle(t){this.headerRowStyle=t,this._resetStyleCache()}getHeaderColumnStyle(){return this.headerColumnStyle}setHeaderColumnStyle(t){this.headerColumnStyle=t,this._resetStyleCache()}getStyle(t,e,n,o,r){let a=0;return n&&(a=a|x.lastRowStyle),o&&(a=a|x.lastColumnStyle),t>=0&&e>=0&&(a=a|x.wholeStyle),t%2===1&&(a=a|(r?x.secondRowStyle:x.firstRowStyle)),t%2===0&&(a=a|(r?x.firstRowStyle:x.secondRowStyle)),t===0&&(a=a|x.headerRowStyle),e===0&&(a=a|x.headerColumnStyle),e%2===1&&(a=a|x.firstColumnStyle),e%2===0&&(a=a|x.secondColumnStyle),a===0?null:this._getMergeStyle(a)}_getMergeStyle(t){let e=this._mergeCacheMap.get(t);return e||(e=this._mergeStyle(t),this._mergeCacheMap.set(t,e)),e}_mergeStyle(t){const e=[];return this.wholeStyle&&t&x.wholeStyle&&e.push(this.wholeStyle),this.firstColumnStyle&&t&x.firstColumnStyle&&e.push(this.firstColumnStyle),this.secondColumnStyle&&t&x.secondColumnStyle&&e.push(this.secondColumnStyle),this.firstRowStyle&&t&x.firstRowStyle&&e.push(this.firstRowStyle),this.secondRowStyle&&t&x.secondRowStyle&&e.push(this.secondRowStyle),this.headerColumnStyle&&t&x.headerColumnStyle&&e.push(this.headerColumnStyle),this.lastColumnStyle&&t&x.lastColumnStyle&&e.push(this.lastColumnStyle),this.headerRowStyle&&t&x.headerRowStyle&&e.push(this.headerRowStyle),this.lastRowStyle&&t&x.lastRowStyle&&e.push(this.lastRowStyle),qi(e)}_resetStyleCache(){this._mergeCacheMap.clear()}toJson(){const t={name:this._name};return this.wholeStyle&&(t.wholeStyle=Z(this.wholeStyle)),this.headerRowStyle&&(t.headerRowStyle=Z(this.headerRowStyle)),this.headerColumnStyle&&(t.headerColumnStyle=Z(this.headerColumnStyle)),this.firstRowStyle&&(t.firstRowStyle=Z(this.firstRowStyle)),this.secondRowStyle&&(t.secondRowStyle=Z(this.secondRowStyle)),this.lastRowStyle&&(t.lastRowStyle=Z(this.lastRowStyle)),this.firstColumnStyle&&(t.firstColumnStyle=Z(this.firstColumnStyle)),this.secondColumnStyle&&(t.secondColumnStyle=Z(this.secondColumnStyle)),this.lastColumnStyle&&(t.lastColumnStyle=Z(this.lastColumnStyle)),t}fromJson(t){this._name=t.name,t.wholeStyle&&(this.wholeStyle=Z(t.wholeStyle)),t.headerRowStyle&&(this.headerRowStyle=Z(t.headerRowStyle)),t.headerColumnStyle&&(this.headerColumnStyle=Z(t.headerColumnStyle)),t.firstRowStyle&&(this.firstRowStyle=Z(t.firstRowStyle)),t.secondRowStyle&&(this.secondRowStyle=Z(t.secondRowStyle)),t.lastRowStyle&&(this.lastRowStyle=Z(t.lastRowStyle)),t.firstColumnStyle&&(this.firstColumnStyle=Z(t.firstColumnStyle)),t.secondColumnStyle&&(this.secondColumnStyle=Z(t.secondColumnStyle)),t.lastColumnStyle&&(this.lastColumnStyle=Z(t.lastColumnStyle))}dispose(){this._mergeCacheMap.clear()}}const Yi=(s,t,e)=>new We(`light-${s}`,{headerRowStyle:{bg:{rgb:t}},firstColumnStyle:{bg:{rgb:"rgb(255, 255, 255)"}},secondColumnStyle:{bg:{rgb:e}},lastRowStyle:{bg:{rgb:t}}}),Ki=(s,t,e)=>new We(`middle-${s}`,{headerRowStyle:{bg:{rgb:t}},headerColumnStyle:{bg:{rgb:e}},secondRowStyle:{bg:{rgb:e}},lastRowStyle:{bg:{rgb:t}},lastColumnStyle:{bg:{rgb:e}}}),Ji=(s,t,e,n)=>new We(`dark-${s}`,{headerRowStyle:{bg:{rgb:t},cl:{rgb:"rgb(255, 255, 255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:e}},secondRowStyle:{bg:{rgb:n}},lastRowStyle:{bg:{rgb:t}}}),xi=[{baseName:"blue",header:"rgb(164, 202, 254)",color:"rgb(225, 239, 254)"},{baseName:"grey",header:"rgb(205, 208, 216)",color:"rgb(238, 239, 241)"},{baseName:"red",header:"rgb(248, 180, 180)",color:"rgb(253, 232, 232)"},{baseName:"orange",header:"rgb(253, 186, 140)",color:"rgb(254, 236, 220)"},{baseName:"yellow",header:"rgb(250, 200, 21)",color:"rgb(255, 244, 185)"},{baseName:"green",header:"rgb(132, 225, 188)",color:"rgb(222, 247, 236)"},{baseName:"azure",header:"rgb(126, 220, 226)",color:"rgb(213, 245, 246)"},{baseName:"indigo",header:"rgb(186, 198, 248)",color:"rgb(233, 237, 255)"},{baseName:"purple",header:"rgb(202, 191, 253)",color:"rgb(237, 235, 254)"},{baseName:"magenta",header:"rgb(248, 180, 217)",color:"rgb(252, 232, 243)"}],Xi=[{baseName:"blue",rowHeader:"rgb(63, 131, 248)",colHeader:"rgb(195, 221, 253)"},{baseName:"grey",rowHeader:"rgb(95, 101, 116)",colHeader:"rgb(227, 229, 234)"},{baseName:"red",rowHeader:"rgb(240, 82, 82)",colHeader:"rgb(251, 213, 213)"},{baseName:"orange",rowHeader:"rgb(255, 90, 31)",colHeader:"rgb(252, 217, 189)"},{baseName:"yellow",rowHeader:"rgb(212, 157, 15)",colHeader:"rgb(252, 220, 106)"},{baseName:"green",rowHeader:"rgb(13, 164, 113)",colHeader:"rgb(188, 240, 218)"},{baseName:"azure",rowHeader:"rgb(6, 148, 162)",colHeader:"rgb(175, 236, 239)"},{baseName:"indigo",rowHeader:"rgb(70, 106, 247)",colHeader:"rgb(210, 218, 250)"},{baseName:"purple",rowHeader:"rgb(144, 97, 249)",colHeader:"rgb(220, 215, 254)"},{baseName:"magenta",rowHeader:"rgb(231, 70, 148)",colHeader:"rgb(250, 209, 232)"}],Zi=[{baseName:"blue",rowHeader:"rgb(30, 66, 159)",firstRow:"rgb(195, 221, 253)",secondRow:"rgb(118, 169, 250)"},{baseName:"grey",rowHeader:"rgb(44, 48, 64)",firstRow:"rgb(227, 229, 234)",secondRow:"rgb(151, 157, 172)"},{baseName:"red",rowHeader:"rgb(155, 28, 28)",firstRow:"rgb(251, 213, 213)",secondRow:"rgb(249, 128, 128)"},{baseName:"orange",rowHeader:"rgb(180, 52, 3)",firstRow:"rgb(252, 217, 189)",secondRow:"rgb(255, 138, 76)"},{baseName:"yellow",rowHeader:"rgb(154, 109, 21)",firstRow:"rgb(252, 220, 106)",secondRow:"rgb(212, 157, 15)"},{baseName:"green",rowHeader:"rgb(4, 108, 78)",firstRow:"rgb(188, 240, 218)",secondRow:"rgb(49, 196, 141)"},{baseName:"azure",rowHeader:"rgb(3, 102, 114)",firstRow:"rgb(175, 236, 239)",secondRow:"rgb(22, 189, 202)"},{baseName:"indigo",rowHeader:"rgb(16, 51, 191)",firstRow:"rgb(210, 218, 250)",secondRow:"rgb(98, 128, 249)"},{baseName:"purple",rowHeader:"rgb(74, 29, 150)",firstRow:"rgb(220, 215, 254)",secondRow:"rgb(172, 148, 250)"},{baseName:"magenta",rowHeader:"rgb(153, 21, 75)",firstRow:"rgb(250, 209, 232)",secondRow:"rgb(241, 126, 184)"}],Qi=xi.map(({baseName:s,header:t,color:e})=>Yi(s,t,e)),ea=Xi.map(({baseName:s,rowHeader:t,colHeader:e})=>Ki(s,t,e)),ta=Zi.map(({baseName:s,rowHeader:t,firstRow:e,secondRow:n})=>Ji(s,t,e,n)),na=[...Qi,...ea,...ta],ro={headerRowStyle:{bg:{rgb:"rgb(68,114,196)"},cl:{rgb:"rgb(255,255,255)"},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE},firstRowStyle:{bg:{rgb:"rgb(217,225,242)"}}},sa=new We("default",ro),oa=new We("default-last-row",{...ro,lastRowStyle:{bd:{t:{s:i.BorderStyleTypes.THIN,cl:{rgb:"rgb(68,114,196)"}}},ht:i.HorizontalAlign.CENTER,bl:i.BooleanNumber.TRUE}});class ra{constructor(){f(this,"_toggleRanges",[])}refresh(t,e){const{startRow:n,endRow:o}=t,r=[];let a=0,u=!1,l=-1;for(let d=n;d<=o;d++){if(!e(d)){a++,a%2===1?u=!0:(u=!1,l!==-1&&(r.push([l,d-1]),l=-1));continue}a%2===1?u?l===-1&&(l=d):(u=!0,l=d):u&&(r.push([l,d-2]),u=!1,l=-1),d===o&&u&&r.push([l,d])}this._toggleRanges=r}getToggleRanges(){return this._toggleRanges.concat()}getIsToggled(t){let e=0,n=this._toggleRanges.length-1;for(;e<=n;){const o=Math.floor((e+n)/2),[r,a]=this._toggleRanges[o];if(t<r)n=o-1;else if(t>a)e=o+1;else return!0}return!1}}var ia=Object.getOwnPropertyDescriptor,aa=(s,t,e,n)=>{for(var o=n>1?void 0:n?ia(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ln=(s,t)=>(e,n)=>t(e,n,s);const ua="SHEET_RANGE_THEME_MODEL_PLUGIN";g.SheetRangeThemeModel=class extends i.Disposable{constructor(e,n,o){super();f(this,"_rangeThemeStyleMap",new Map);f(this,"_rangeThemeStyleRuleMap",new Map);f(this,"_rTreeCollection",new Map);f(this,"_defaultRangeThemeMap",new Map);f(this,"_zebraCrossingCacheMap",new Map);f(this,"_rowVisibleFuncSet",new Map);f(this,"_rangeThemeMapChanged$",new O.Subject);f(this,"rangeThemeMapChange$",this._rangeThemeMapChanged$.asObservable());this._sheetInterceptorService=e,this._resourceManagerService=n,this._univerInstanceService=o,this._registerIntercept(),this._initSnapshot(),this._initDefaultTheme()}_initDefaultTheme(){this.registerDefaultRangeTheme(sa),this.registerDefaultRangeTheme(oa);for(const e of na)this.registerDefaultRangeTheme(e)}_ensureRangeThemeStyleMap(e){return this._rangeThemeStyleMap.has(e)||this._rangeThemeStyleMap.set(e,new Map),this._rangeThemeStyleMap.get(e)}_ensureRangeThemeStyleRuleMap(e){return this._rangeThemeStyleRuleMap.has(e)||this._rangeThemeStyleRuleMap.set(e,new Map),this._rangeThemeStyleRuleMap.get(e)}_ensureRTreeCollection(e){return this._rTreeCollection.has(e)||this._rTreeCollection.set(e,new i.RTree),this._rTreeCollection.get(e)}getDefaultRangeThemeStyle(e){return this._defaultRangeThemeMap.get(e)}getCustomRangeThemeStyle(e,n){return this._ensureRangeThemeStyleMap(e).get(n)}_getSheetRowVisibleFuncSet(e,n){this._rowVisibleFuncSet.has(e)||this._rowVisibleFuncSet.set(e,new Map);const o=this._rowVisibleFuncSet.get(e);return o.has(n)||o.set(n,new Set),o.get(n)}_getSheetRowVisibleHasInit(e,n){var o;return!!(this._rowVisibleFuncSet.has(e)&&((o=this._rowVisibleFuncSet.get(e))!=null&&o.has(n)))}refreshSheetRowVisibleFuncSet(e,n){const o=this._getSheetRowVisibleFuncSet(e,n);o.clear();const r=this._univerInstanceService.getUnit(e);if(r){const a=r.getSheetBySheetId(n);if(a){const u=a.getRowCount(),l=a.getRowManager();for(let d=1;d<=u;d++)a.getRowVisible(d)?l.getRowHeight(d)===0&&o.add(d):o.add(d)}}}_ensureZebraCrossingCache(e,n,o){this._zebraCrossingCacheMap.has(e)||this._zebraCrossingCacheMap.set(e,new Map);const r=this._zebraCrossingCacheMap.get(e);r.has(n)||r.set(n,new Map);const a=r.get(n);return a.has(o)||a.set(o,new ra),a.get(o)}registerRangeThemeRule(e,n){const{unitId:o,subUnitId:r,range:a}=n,u=i.generateRandomId(),l=this._ensureRangeThemeStyleRuleMap(o),d=this._ensureRTreeCollection(o);l.set(u,{rangeInfo:n,themeName:e}),d.insert({unitId:o,sheetId:r,range:a,id:u}),this._getSheetRowVisibleHasInit(o,r)||this.refreshSheetRowVisibleFuncSet(o,r);const c=this._ensureZebraCrossingCache(o,r,u),m=this._getSheetRowVisibleFuncSet(o,r);c.refresh(a,h=>!m.has(h))}getRegisteredRangeThemeStyle(e){const{unitId:n,subUnitId:o,range:r}=e,a=this._ensureRTreeCollection(n),u=Array.from(a.bulkSearch([{unitId:n,sheetId:o,range:r}]));if(u[0]){const d=this._ensureRangeThemeStyleRuleMap(n).get(u[0]);if(d)return d.themeName}}refreshZebraCrossingCacheBySheet(e,n){this._zebraCrossingCacheMap.has(e)||this._zebraCrossingCacheMap.set(e,new Map);const o=this._zebraCrossingCacheMap.get(e);o.has(n)||o.set(n,new Map);const r=o.get(n);r&&r.forEach((a,u)=>{const d=this._ensureRangeThemeStyleRuleMap(e).get(u);d?a.refresh(d.rangeInfo.range,c=>!this._getSheetRowVisibleFuncSet(e,n).has(c)):r.delete(u)})}removeRangeThemeRule(e,n){const{unitId:o,subUnitId:r,range:a}=n,u=this._ensureRTreeCollection(o),l=Array.from(u.bulkSearch([{unitId:o,sheetId:r,range:a}])),d=this._ensureRangeThemeStyleRuleMap(o);for(let c=0;c<l.length;c++){const m=d.get(l[c]);if(m&&m.themeName===e){d.delete(l[c]),u.remove({unitId:o,sheetId:r,range:a,id:l[c]});const h=this._zebraCrossingCacheMap.get(o);if(h){const R=h.get(r);R&&R.delete(l[c])}break}}}registerDefaultRangeTheme(e){this._defaultRangeThemeMap.set(e.getName(),e),this._rangeThemeMapChanged$.next({type:"add",styleName:e.getName()})}unRegisterDefaultRangeTheme(e){this._defaultRangeThemeMap.delete(e),this._rangeThemeMapChanged$.next({type:"remove",styleName:e})}getRegisteredRangeThemes(){return Array.from(this._defaultRangeThemeMap.keys())}registerRangeThemeStyle(e,n){this._ensureRangeThemeStyleMap(e).set(n.getName(),n),this._rangeThemeMapChanged$.next({type:"add",styleName:n.getName()})}unregisterRangeThemeStyle(e,n){this._ensureRangeThemeStyleMap(e).delete(n),this._rangeThemeMapChanged$.next({type:"remove",styleName:n})}getALLRegisteredTheme(e){return Array.from(this._ensureRangeThemeStyleMap(e).keys())}getRangeThemeStyle(e,n){return this._defaultRangeThemeMap.has(n)?this._defaultRangeThemeMap.get(n):this._ensureRangeThemeStyleMap(e).get(n)}getCellStyle(e,n,o,r){const a={startRow:o,startColumn:r,endRow:o,endColumn:r},u=this._ensureRTreeCollection(e),l=Array.from(u.bulkSearch([{unitId:e,sheetId:n,range:a}]));if(l[0]){const c=this._ensureRangeThemeStyleRuleMap(e).get(l[0]);if(c){const{rangeInfo:m,themeName:h}=c,R=o-m.range.startRow,C=r-m.range.startColumn,S=this.getRangeThemeStyle(e,h),v=this._ensureZebraCrossingCache(e,n,l[0]).getIsToggled(o);if(S)return S.getStyle(R,C,o===m.range.endRow,r===m.range.endColumn,v)}}}_registerIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(Ae.CELL_CONTENT,{id:no,effect:i.InterceptorEffectEnum.Style,handler:(e,n,o)=>{const{row:r,col:a,unitId:u,subUnitId:l}=n,d=this.getCellStyle(u,l,r,a);if(d){const c=!e||e===n.rawData?{...n.rawData}:e;return c.themeStyle=d,o(c)}return o(e)}}))}toJson(e){const n=this._ensureRangeThemeStyleRuleMap(e),o=this._ensureRangeThemeStyleMap(e);if(o.size===0&&n.size===0)return"{}";const r={};n.forEach((u,l)=>{r[l]=u});const a={};return o.forEach((u,l)=>{a[l]=u.toJson()}),JSON.stringify({rangeThemeStyleRuleMap:r,rangeThemeStyleMapJson:a})}fromJSON(e,n){const{rangeThemeStyleRuleMap:o,rangeThemeStyleMapJson:r}=n;o&&Object.keys(o).forEach(a=>{const u=o[a],{themeName:l,rangeInfo:d}=u;l.startsWith("table")||(this.registerRangeThemeRule(l,d),this._ensureRTreeCollection(d.unitId).insert({unitId:a,sheetId:d.subUnitId,range:d.range,id:a}))}),r&&Object.keys(r).forEach(a=>{const u=r[a],l=new We(u.name);l.fromJson(u),this._ensureRangeThemeStyleMap(e).set(l.getName(),l)})}deleteUnitId(e){this._rangeThemeStyleMap.delete(e),this._rangeThemeStyleRuleMap.delete(e),this._rTreeCollection.delete(e)}_initSnapshot(){this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e=>this.toJson(e),parseJson:e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},businesses:[i.UniverInstanceType.UNIVER_SHEET],pluginName:ua,onLoad:(e,n)=>{this.fromJSON(e,n)},onUnLoad:e=>{this.deleteUnitId(e)}}))}dispose(){super.dispose(),this._rangeThemeStyleMap.clear(),this._rangeThemeStyleRuleMap.clear(),this._defaultRangeThemeMap.clear(),this._rTreeCollection.clear(),this._zebraCrossingCacheMap.clear(),this._rowVisibleFuncSet.clear()}},g.SheetRangeThemeModel=aa([Ln(0,i.Inject(g.SheetInterceptorService)),Ln(1,i.Inject(i.IResourceManagerService)),Ln(2,i.Inject(i.IUniverInstanceService))],g.SheetRangeThemeModel);function Bn(s,t){const{unitId:e}=t,n=e?s.getUnit(e,i.UniverInstanceType.UNIVER_SHEET):s.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);return n?{workbook:n,unitId:n.getUnitId()}:null}function P(s,t={}){const{unitId:e,subUnitId:n}=t,o=e?s.getUnit(e,i.UniverInstanceType.UNIVER_SHEET):s.getCurrentUnitOfType(i.UniverInstanceType.UNIVER_SHEET);if(!o)return null;const r=n?o.getSheetBySheetId(n):o.getActiveSheet(!0);return r?{worksheet:r,workbook:o,unitId:o.getUnitId(),subUnitId:r.getSheetId()}:null}function ve(s,t){const{unitId:e,subUnitId:n}=t,o=s.getUnit(e,i.UniverInstanceType.UNIVER_SHEET);if(!o)return null;const r=o.getSheetBySheetId(n);return r?{worksheet:r,workbook:o}:null}const rt={id:"sheet.mutation.set-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,range:o,themeName:r}=t,a=s.get(i.IUniverInstanceService),u=P(a),l=s.get(g.SheetRangeThemeModel);return u?(l.registerRangeThemeRule(r,{range:o,unitId:e,subUnitId:n}),!0):!1}},io=(s,t)=>{const e=ve(s.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetRangeThemeStyleMutation]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,subUnitId:n.getSheetId(),range:t.range,themeName:t.themeName}},it={id:"sheet.mutation.remove-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,range:o,themeName:r}=t,a=s.get(i.IUniverInstanceService),u=P(a),l=s.get(g.SheetRangeThemeModel);return u?(l.removeRangeThemeRule(r,{range:o,unitId:e,subUnitId:n}),!0):!1}},ao=(s,t)=>{const e=ve(s.get(i.IUniverInstanceService),t);if(!e)throw new Error("[DeleteWorksheetRangeThemeStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,subUnitId:n.getSheetId(),range:t.range,themeName:t.themeName}},en=(s,t)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},re={id:"sheet.mutation.insert-row",type:i.CommandType.MUTATION,handler:(s,t)=>{var C;const{unitId:e,subUnitId:n,range:o,rowInfo:r}=t,u=s.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(u==null)throw new Error("universheet is null error!");const l=u.getSheetBySheetId(n);if(l==null)throw new Error("worksheet is null error!");const d=l.getRowManager().getRowData(),c={h:l.getConfig().defaultRowHeight,hd:0},m=o.startRow,h=o.endRow-o.startRow+1;for(let S=m;S<m+h;S++)r?i.insertMatrixArray(S,(C=r[S-o.startRow])!=null?C:c,d):i.insertMatrixArray(S,c,d);return l.setRowCount(l.getRowCount()+h),l.getCellMatrix().insertRows(o.startRow,h),!0}},Nt=(s,t)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},ie={id:"sheet.mutation.insert-col",type:i.CommandType.MUTATION,handler:(s,t)=>{var C;const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(!o)return!1;const r=o.getColumnManager(),{range:a,colInfo:u}=t,d=r.getColumnData(),c=a.startColumn,m=a.endColumn-a.startColumn+1,h=o.getConfig().defaultColumnWidth;for(let S=c;S<c+m;S++){const I={w:h,hd:0};u?i.insertMatrixArray(S,(C=u[S-a.startColumn])!=null?C:I,d):i.insertMatrixArray(S,I,d)}return o.setColumnCount(o.getColumnCount()+a.endColumn-a.startColumn+1),o.getCellMatrix().insertColumns(a.startColumn,m),!0}},Be={id:"sheet.mutation.move-range",type:i.CommandType.MUTATION,handler:(s,t)=>{const{from:e,to:n}=t;if(!e||!n)return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getSheetBySheetId(t.from.subUnitId),u=r.getSheetBySheetId(t.to.subUnitId);if(!a||!u)return!1;const l=a.getCellMatrix(),d=u.getCellMatrix();return new i.ObjectMatrix(e.value).forValue((c,m,h)=>{h==null?l.realDeleteValue(c,m):l.setValue(c,m,h)}),new i.ObjectMatrix(n.value).forValue((c,m,h)=>{h==null?d.realDeleteValue(c,m):d.setValue(c,m,h)}),!0}};function uo(s,t){const{unitId:e,subUnitId:n,sourceRange:o,targetRange:r}=t,a=o.startRow>r.startRow,u=o.endRow-o.startRow+1;return a?{unitId:e,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...o,endRow:o.endRow+u,startRow:o.startRow+u}}:{unitId:e,subUnitId:n,targetRange:i.Rectangle.clone(o),sourceRange:{...r,endRow:r.endRow-u,startRow:r.startRow-u}}}const pe={id:"sheet.mutation.move-rows",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,sourceRange:o,targetRange:r}=t,u=s.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(!u)throw new Error("[MoveRowMutation] univerSheet is null!");const l=u.getSheetBySheetId(n);if(!l)throw new Error("[MoveRowMutation] worksheet is null!");const d=o.startRow,c=o.endRow-o.startRow+1,m=r.startRow,h=l.getRowManager().getRowData();return i.moveMatrixArray(d,c,m,h),l.getCellMatrix().moveRows(d,c,m),!0}};function lo(s,t){const{unitId:e,subUnitId:n,sourceRange:o,targetRange:r}=t,a=o.startColumn>r.startColumn,u=o.endColumn-o.startColumn+1;return a?{unitId:e,subUnitId:n,sourceRange:i.Rectangle.clone(r),targetRange:{...o,endColumn:o.endColumn+u,startColumn:o.startColumn+u}}:{unitId:e,subUnitId:n,targetRange:i.Rectangle.clone(o),sourceRange:{...r,startColumn:r.startColumn-u,endColumn:r.endColumn-u}}}const we={id:"sheet.mutation.move-columns",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,sourceRange:o,targetRange:r}=t,u=s.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(!u)throw new Error("[MoveColumnMutation] univerSheet is null!");const l=u.getSheetBySheetId(n);if(!l)throw new Error("[MoveColumnMutation] worksheet is null!");const d=o.startColumn,c=o.endColumn-o.startColumn+1,m=r.startColumn,h=l.getColumnManager().getColumnData();return i.moveMatrixArray(d,c,m,h),l.getCellMatrix().moveColumns(d,c,m),!0}},la=(s,t)=>{const o=t.getRowManager().getRowData(),r={},a=s.range,u=i.sliceMatrixArray(a.startRow,a.endRow,o),l=i.concatMatrixArray(r,u);return{unitId:s.unitId,subUnitId:s.subUnitId,range:s.range,rowInfo:l}},ae={id:"sheet.mutation.remove-rows",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(!o)return!1;const r=t.range,u=o.getRowManager().getRowData();for(let c=r.startRow;c<=r.endRow;c++)o.getRowFiltered(c);const l=r.endRow-r.startRow+1;return i.spliceArray(r.startRow,l,u),o.getCellMatrix().removeRows(r.startRow,l),o.setRowCount(o.getRowCount()-l),!0}},da=(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(o==null)throw new Error("worksheet is null error!");const u=o.getColumnManager().getColumnData(),l={},d=t.range,c=i.sliceMatrixArray(d.startColumn,d.endColumn,u),m=i.concatMatrixArray(l,c);return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,colInfo:m}},ne={id:"sheet.mutation.remove-col",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(!o)return!1;const r=t.range,u=o.getColumnManager().getColumnData(),l=r.endColumn-r.startColumn+1;return i.spliceArray(r.startColumn,l,u),o.setColumnCount(o.getColumnCount()-l),o.getCellMatrix().removeColumns(r.startColumn,l),!0}},ue=(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(o==null)throw new Error("worksheet is null error!");const a=o.getConfig().mergeData,u=t.ranges,l=[];for(let d=0;d<u.length;d++)for(let c=a.length-1;c>=0;c--){const m=a[c],h=u[d];i.Rectangle.intersects(m,h)&&l.push(a[c])}return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:l}},G={id:"sheet.mutation.remove-worksheet-merge",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(!o)return!1;const a=o.getConfig().mergeData,u=t.ranges;for(let l=0;l<u.length;l++)for(let d=a.length-1;d>=0;d--){const c=a[d],m=u[l];i.Rectangle.intersects(c,m)&&a.splice(d,1)}return o.getSpanModel().rebuild(a),!0}},co=s=>{const{order:t}=s,e={};return Object.keys(t).forEach(n=>{e[t[Number(n)]]=Number(n)}),{...s,order:e}},Ot={id:"sheet.mutation.reorder-range",type:i.CommandType.MUTATION,handler:(s,t)=>{const{subUnitId:e,unitId:n,range:o,order:r}=t,l=s.get(i.IUniverInstanceService).getUnit(n).getSheetBySheetId(e);if(!l)return!1;const d=new i.ObjectMatrix;i.Range.foreach(o,(m,h)=>{if(r.hasOwnProperty(m)){const R=r[m],C=i.Tools.deepClone(l.getCellRaw(R,h));d.setValue(m,h,C)}});const c=l.getCellMatrix();return d.forValue((m,h,R)=>{c.setValue(m,h,R)}),!0}};function ca(s,t){if(s==null)return s;const e=i.Tools.deepClone(s);if(t==null)return e;const n={};return"h"in t&&(n.h=e.h),"ia"in t&&(n.ia=e.ia),"ah"in t&&(n.ah=e.ah),"hd"in t&&(n.hd=e.hd),"s"in t&&(n.s=e.s),"custom"in t&&(n.custom=e.custom),n}function ma(s,t){if(s==null)return s;const e=i.Tools.deepClone(s);if(t==null)return e;const n={};return"w"in t&&(n.w=e.w),"hd"in t&&(n.hd=e.hd),"s"in t&&(n.s=e.s),"custom"in t&&(n.custom=e.custom),n}const mo=(s,t)=>{const{unitId:e,subUnitId:n,columnData:o}=s,r={},a=t.getColumnManager();for(const u in o){const l=o[u],d=a.getColumn(Number(u));r[u]=ma(d,l)}return{unitId:e,subUnitId:n,columnData:r}},at={id:"sheet.mutation.set-col-data",type:i.CommandType.MUTATION,handler:(s,t)=>{const{columnData:e}=t,n=s.get(i.IUniverInstanceService),o=P(n,t);if(!o)return!1;const{worksheet:r}=o,a=r.getColumnManager();for(const u in e){const l=e[u];if(l==null){a.removeColumn(Number(u));continue}const d=a.getColumnOrCreate(Number(u));Object.assign(d,l)}return!0}},ha=(s,t)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},ut={id:"sheet.mutation.set-col-hidden",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;const o=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let u=a.startColumn;u<a.endColumn+1;u++){const l=o.getColumnOrCreate(u);l!=null&&(l.hd=i.BooleanNumber.TRUE)}}return!0}},ga=(s,t)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},lt={id:"sheet.mutation.set-col-visible",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;const o=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let u=a.startColumn;u<a.endColumn+1;u++){const l=o.getColumnOrCreate(u);l!=null&&(l.hd=i.BooleanNumber.FALSE)}}return!0}},dt={id:"sheet.mutation.set-gridlines-color",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=P(s.get(i.IUniverInstanceService),t);if(!e)return!1;const{worksheet:n}=e,o=n.getConfig();return o.gridlinesColor=t.color,!0}};function Ra(s,t,e){var a;const n=s.getStyleByCell(t);n==null&&delete t.s,typeof e.s=="string"&&(e.s=s.get(e.s));const o=tn(n,e.s?e.s:null);o&&(i.Tools.removeNull(o),Object.entries(o).forEach(([u,l])=>{typeof l=="object"&&l!==null&&Object.keys(l).length===0&&delete o[u]})),i.Tools.isEmptyObject(o)?delete t.s:t.s=s.setValue(o);const r=e.v?`${e.v}\r
`:"";!e.p&&t.p&&(r&&r!==((a=t.p.body)==null?void 0:a.dataStream)?delete t.p:fa(t.p,e.s?e.s:null))}function Ca(s,t){if(!t||!Object.keys(t).length)return s;const e=i.Tools.deepClone(s!=null?s:{});for(const n in t)n==="bd"?e[n]=Sa(e[n]||{},t[n]):n in e||(e[n]=null);return e}function Sa(s,t){if(!t||!Object.keys(t).length)return s;for(const e in t)e in s||(s[e]=null);return s}function tn(s,t,e=!1){if(t===null)return t;if(t===void 0)return s;const n=i.Tools.deepClone(s)||{};for(const o in t)e&&["bd","tr","td","ht","vt","tb","pd","bg"].includes(o)||(o in n&&o==="bd"?n[o]=Object.assign(n[o],t[o]):n[o]=t[o]);return"cl"in n&&("ul"in n&&n.ul&&(n.ul.cl=n.cl),"ol"in n&&n.ol&&(n.ol.cl=n.cl),"st"in n&&n.st&&(n.st.cl=n.cl)),n}function ho(s,t){return s.some(e=>e.startIndex===t)?ho(s,t+1):t}function fa(s,t){var a;if(s.body==null)return;Array.isArray(s.body.textRuns)||(s.body.textRuns=[]);let e=0;const n=[],o=((a=s.body)==null?void 0:a.paragraphs)||[];for(const u of s.body.textRuns){const{st:l,ed:d,ts:c={}}=u;if(e<l){const h={st:e,ed:l},R=tn({},t,!0);R&&i.Tools.removeNull(R),i.Tools.isEmptyObject(R)||(h.ts=R),n.push(h)}const m=tn(c,t,!0);m&&i.Tools.removeNull(m),i.Tools.isEmptyObject(m)?delete u.ts:u.ts=m,n.push(u),e=ho(o,d)}const r=s.body.dataStream.endsWith(`\r
`)?s.body.dataStream.length-2:s.body.dataStream.length;if(e<r){const u={st:e,ed:r},l=tn({},t,!0);l&&i.Tools.removeNull(l),i.Tools.isEmptyObject(l)||(u.ts=l),n.push(u)}s.body.textRuns=i.normalizeTextRuns(n)}function go(s,t){return t.v===void 0||t.v===null?t.v:s===i.CellValueType.NUMBER?Number(t.v):s===i.CellValueType.BOOLEAN?Ia(t.v)?1:0:s===i.CellValueType.STRING||s===i.CellValueType.FORCE_STRING?`${t.v}`:t.v}function Ia(s){if(typeof s=="string"){if(s.toUpperCase()==="TRUE")return!0;if(s.toUpperCase()==="FALSE")return!1;if(i.isSafeNumeric(s)){if(Number(s)===0)return!1;if(Number(s)===1)return!0}}if(typeof s=="number"){if(s===0)return!1;if(s===1)return!0}return typeof s=="boolean"?s:null}function va(s){return s==null?null:(s.f===void 0&&(s.f=null),s.si===void 0&&(s.si=null),s.p===void 0&&(s.p=null),s.v===void 0&&(s.v=null),s.t===void 0&&(s.t=null),s.s===void 0&&(s.s=null),s.custom===void 0&&(s.custom=null),s)}const ce=(s,t)=>{const{unitId:e,subUnitId:n,cellValue:o}=t,a=s.get(i.IUniverInstanceService).getUniverSheetInstance(e);if(a==null)throw new Error("workbook is null error!");const u=a.getSheetBySheetId(n);if(u==null)throw new Error("worksheet is null error!");const l=u.getCellMatrix(),d=a.getStyles(),c=new i.ObjectMatrix;return new i.ObjectMatrix(o).forValue((h,R,C)=>{const S=i.Tools.deepClone(l==null?void 0:l.getValue(h,R))||{},I=d.getStyleByCell(S),v=d.getStyleByCell(C);S.s=Ca(I,v),c.setValue(h,R,va(S))}),{...t,options:{},cellValue:c.getMatrix()}},F={id:"sheet.mutation.set-range-values",type:i.CommandType.MUTATION,handler:(s,t)=>{const{cellValue:e,subUnitId:n,unitId:o}=t,a=s.get(i.IUniverInstanceService).getUnit(o);if(!a)return!1;const u=a.getSheetBySheetId(n);if(!u)return!1;const l=u.getCellMatrix(),d=a.getStyles();return new i.ObjectMatrix(e).forValue((m,h,R)=>{if(!R)l.realDeleteValue(m,h);else{let C=l.getValue(m,h)||{};C=wa(R,C,d),i.Tools.isEmptyObject(C)?l.realDeleteValue(m,h):l.setValue(m,h,C)}}),!0}},pa=new Set(["f","p","si","custom","ref"]);function wa(s,t,e){const n=Li(e,s,t);return Object.keys(s).forEach(o=>{const r=o;if(pa.has(r)){const a=s[r];Ma(t,r,a)}else r==="v"?s.v!==void 0&&(t.v=go(n,s)):r==="s"&&Ra(e,t,s)}),t.v!==void 0&&(t.t=n,t.v=go(n,t)),t.v===null&&(delete t.t,delete t.v),t}function Ma(s,t,e){e===void 0||(e===null?delete s[t]:s[t]=e)}const Ro=(s,t)=>{const{unitId:e,subUnitId:n,rowData:o}=s,r={},a=t.getRowManager();for(const u in o){const l=o[u],d=a.getRow(Number(u));r[u]=ca(d,l)}return{unitId:e,subUnitId:n,rowData:r}},ct={id:"sheet.mutation.set-row-data",type:i.CommandType.MUTATION,handler:(s,t)=>{const{rowData:e}=t,n=s.get(i.IUniverInstanceService),o=P(n,t);if(!o)return!1;const{worksheet:r}=o,a=r.getRowManager();for(const u in e){const l=e[u];if(l==null){a.removeRow(Number(u));continue}const d=a.getRowOrCreate(Number(u));Object.assign(d,l)}return!0}},ya=(s,t)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},Ke={id:"sheet.mutation.set-row-visible",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let u=a.startRow;u<a.endRow+1;u++){const l=o.getRowOrCreate(u);l!=null&&(l.hd=0)}}return!0}},_a=(s,t)=>{if(s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId)==null)throw new Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},Je={id:"sheet.mutation.set-row-hidden",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let r=0;r<t.ranges.length;r++){const a=t.ranges[r];for(let u=a.startRow;u<a.endRow+1;u++){const l=o.getRowOrCreate(u);l!=null&&(l.hd=1)}}return!0}},Hn=(s,t)=>{const{unitId:e,subUnitId:n,ranges:o}=s,r={},a=t.getColumnManager();for(let u=0;u<o.length;u++){const l=o[u];for(let d=l.startColumn;d<l.endColumn+1;d++)r[d]=a.getColumnWidth(d)}return{unitId:e,subUnitId:n,ranges:o,colWidth:r}},Ve={id:"sheet.mutation.set-worksheet-col-width",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{worksheet:o}=n,r=o.getColumnManager(),a=t.ranges;for(let u=0;u<a.length;u++){const l=a[u];for(let d=l.startColumn;d<l.endColumn+1;d++)o.getColVisible(d)&&(typeof t.colWidth=="number"?r.setColumnWidth(d,t.colWidth):i.Tools.isDefine(t.colWidth[d])&&r.setColumnWidth(d,t.colWidth[d]))}return!0}},Co=(s,t)=>{const e=ve(s.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetColumnCountUndoMutationFactory]: worksheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,columnCount:e.worksheet.getColumnCount()}},mt={id:"sheet.mutation.set-worksheet-column-count",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService),n=ve(e,t);return n?(n.worksheet.setColumnCount(t.columnCount),!0):!1}},ht={id:"sheet.mutation.set-worksheet-default-style",type:i.CommandType.MUTATION,handler:(s,t)=>{const{defaultStyle:e}=t,n=s.get(i.IUniverInstanceService),o=P(n);if(!o)return!1;const{worksheet:r}=o;return r?(r.setDefaultCellStyle(e),!0):!1}},So=(s,t)=>{const e=ve(s.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetDefaultStyleMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,subUnitId:n.getSheetId(),defaultStyle:n.getDefaultCellStyle()}},fo=(s,t)=>{const e=ve(s.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetRowCountUndoMutationFactory]: worksheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,rowCount:e.worksheet.getRowCount()}},gt={id:"sheet.mutation.set-worksheet-row-count",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService),n=ve(e,t);return n?(n.worksheet.setRowCount(t.rowCount),!0):!1}},Io=(s,t)=>{var u,l;const{unitId:e,subUnitId:n,ranges:o}=s,r={},a=t.getRowManager();for(const{startRow:d,endRow:c}of o)for(let m=d;m<c+1;m++)r[m]=(l=(u=a.getRow(m))==null?void 0:u.h)!=null?l:t.getConfig().defaultRowHeight;return{unitId:e,subUnitId:n,ranges:o,rowHeight:r}},Fn=(s,t)=>{var u;const{unitId:e,subUnitId:n,ranges:o}=s,r={},a=t.getRowManager();for(const{startRow:l,endRow:d}of o)for(let c=l;c<=d;c++)r[c]=(u=a.getRow(c))==null?void 0:u.ia;return{unitId:e,subUnitId:n,ranges:o,autoHeightInfo:r}},ba=(s,t)=>{var u,l;const{unitId:e,subUnitId:n,rowsAutoHeightInfo:o}=s,r=[],a=t.getRowManager();for(const d of o){const{row:c}=d;r.push({row:c,autoHeight:(l=(u=a.getRow(c))==null?void 0:u.ah)!=null?l:t.getConfig().defaultRowHeight})}return{unitId:e,subUnitId:n,rowsAutoHeightInfo:r}},Ee={id:"sheet.mutation.set-worksheet-row-height",type:i.CommandType.MUTATION,handler:(s,t)=>{const{ranges:e,rowHeight:n}=t,o=s.get(i.IUniverInstanceService),r=P(o,t);if(!r)return!1;const{worksheet:a}=r,u=a.getRowManager();for(const{startRow:l,endRow:d}of e)for(let c=l;c<=d;c++)typeof n=="number"?u.setRowHeight(c,n):i.Tools.isDefine(n[c])&&u.setRowHeight(c,n[c]);return!0}},Re={id:"sheet.mutation.set-worksheet-row-is-auto-height",type:i.CommandType.MUTATION,handler:(s,t)=>{var u;const{ranges:e,autoHeightInfo:n}=t,o=s.get(i.IUniverInstanceService),r=P(o,t);if(!r)return!1;const a=r.worksheet.getRowManager();for(const{startRow:l,endRow:d}of e)for(let c=l;c<=d;c++){const m=a.getRowOrCreate(c);typeof n=="number"?m.ia=n:m.ia=(u=n[c])!=null?u:void 0}return!0}},jn={id:"sheet.mutation.set-worksheet-row-auto-height",type:i.CommandType.MUTATION,handler:(s,t)=>{const{rowsAutoHeightInfo:e}=t,n=s.get(i.IUniverInstanceService),o=P(n,t);if(!o)return!1;const r=o.worksheet.getRowManager();for(const{row:a,autoHeight:u}of e){const l=r.getRowOrCreate(a);l.ah=u}return!0}},Rt={id:"sheet.mutation.toggle-gridlines",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=P(s.get(i.IUniverInstanceService),t);if(!e)return!1;const{worksheet:n}=e,o=n.getConfig();return o.showGridlines=t.showGridlines,!0}},Ct={id:"sheet.operation.set-worksheet-active",type:i.CommandType.OPERATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getWorksheets();for(const[,o]of n)if(o.getSheetId()===t.subUnitId)return e.setActiveSheet(o),!0;return!1}};var vo=(s=>(s.SET_WORKSHEET_ROW_HEIGHT="sheet.mutation.set-worksheet-row-height",s.SET_WORKSHEET_ROW_IS_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-is-auto-height",s.SET_WORKSHEET_ROW_AUTO_HEIGHT="sheet.mutation.set-worksheet-row-auto-height",s.SET_WORKSHEET_COL_WIDTH="sheet.mutation.set-worksheet-col-width",s.SET_WORKSHEET_ACTIVE="sheet.operation.set-worksheet-active",s.MOVE_ROWS="sheet.mutation.move-rows",s.MOVE_COLUMNS="sheet.mutation.move-columns",s.SET_COL_HIDDEN="sheet.mutation.set-col-hidden",s.SET_COL_VISIBLE="sheet.mutation.set-col-visible",s.SET_ROW_HIDDEN="sheet.mutation.set-row-hidden",s.SET_ROW_VISIBLE="sheet.mutation.set-row-visible",s.INSERT_COL="sheet.mutation.insert-col",s.INSERT_ROW="sheet.mutation.insert-row",s.REMOVE_COL="sheet.mutation.remove-col",s.REMOVE_ROW="sheet.mutation.remove-rows",s.TOGGLE_GRIDLINES="sheet.mutation.toggle-gridlines",s.SET_GRIDLINES_COLOR="sheet.mutation.set-gridlines-color",s))(vo||{}),po=(s=>(s.SET_RANGE_VALUES="sheet.mutation.set-range-values",s.MOVE_RANGE="sheet.mutation.move-range",s.REMOVE_WORKSHEET_MERGE="sheet.mutation.remove-worksheet-merge",s.ADD_WORKSHEET_MERGE="sheet.mutation.add-worksheet-merge",s.REORDER_RANGE="sheet.mutation.reorder-range",s.SET_WORKSHEET_DEFAULT_STYLE="sheet.mutation.set-worksheet-default-style",s.SET_ROW_DATA="sheet.mutation.set-row-data",s.SET_COL_DATA="sheet.mutation.set-col-data",s.SET_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.set-worksheet-range-theme-style",s.DELETE_WORKSHEET_RANGE_THEME_STYLE="sheet.mutation.delete-worksheet-range-theme-style",s))(po||{});const Ea=[Ee.id,Re.id,jn.id,Ve.id,Ct.id,pe.id,we.id,ut.id,lt.id,Je.id,Ke.id,ie.id,re.id,ne.id,ae.id,Rt.id,dt.id,gt.id,mt.id],Ta=[F.id,Be.id,G.id,j.id,Ot.id,ht.id,ct.id,at.id,rt.id,it.id];function Ua(s){switch(s.id){case"sheet.mutation.set-range-values":{const t=s.params,e=new i.ObjectMatrix(t.cellValue).getDataRange();return e.endRow===-1?[]:t.cellValue?[{unitId:t.unitId,subUnitId:t.subUnitId,range:e}]:[]}case"sheet.mutation.move-range":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.from.subUnitId,range:new i.ObjectMatrix(t.from.value).getRange()},{unitId:t.unitId,subUnitId:t.to.subUnitId,range:new i.ObjectMatrix(t.to.value).getRange()}]}case"sheet.mutation.remove-worksheet-merge":{const t=s.params;return t.ranges.map(e=>({unitId:t.unitId,subUnitId:t.subUnitId,range:e}))}case"sheet.mutation.add-worksheet-merge":{const t=s.params;return t.ranges.map(e=>({unitId:t.unitId,subUnitId:t.subUnitId,range:e}))}case"sheet.mutation.reorder-range":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}]}case"sheet.mutation.set-worksheet-default-style":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-row-data":{const t=s.params,e=Object.keys(t.rowData).map(Number);return e.length===0?[]:[{unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:Math.min(...e),endRow:Math.max(...e),startColumn:0,endColumn:Number.MAX_SAFE_INTEGER}}]}case"sheet.mutation.set-col-data":{const t=s.params,e=Object.keys(t.columnData).map(Number);return e.length===0?[]:[{unitId:t.unitId,subUnitId:t.subUnitId,range:{startRow:0,endRow:Number.MAX_SAFE_INTEGER,startColumn:Math.min(...e),endColumn:Math.max(...e)}}]}case"sheet.mutation.set-worksheet-range-theme-style":case"sheet.mutation.delete-worksheet-range-theme-style":{const t=s.params;return[{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}]}default:return[]}}function Pa(s,t){switch(s.id){case"sheet.mutation.set-worksheet-row-height":case"sheet.mutation.set-worksheet-row-is-auto-height":{const e=s.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-row-auto-height":{const e=s.params;return e.rowsAutoHeightInfo.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{startRow:n.row,endRow:n.row,startColumn:0,endColumn:t-1,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.set-worksheet-col-width":{const e=s.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.move-rows":case"sheet.mutation.move-columns":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:e.targetRange},{unitId:e.unitId,subUnitId:e.subUnitId,range:e.sourceRange}]}case"sheet.mutation.set-col-hidden":case"sheet.mutation.set-col-visible":{const e=s.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.COLUMN}}))}case"sheet.mutation.set-row-hidden":case"sheet.mutation.set-row-visible":{const e=s.params;return e.ranges.map(n=>({unitId:e.unitId,subUnitId:e.subUnitId,range:{...n,rangeType:i.RANGE_TYPE.ROW}}))}case"sheet.mutation.insert-col":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.insert-row":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.remove-col":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.COLUMN}}]}case"sheet.mutation.remove-rows":{const e=s.params;return[{unitId:e.unitId,subUnitId:e.subUnitId,range:{...e.range,rangeType:i.RANGE_TYPE.ROW}}]}case"sheet.mutation.toggle-gridlines":case"sheet.mutation.set-gridlines-color":return[];default:return[]}}function wo(s){return s==null?!1:s.v!==void 0&&s.v!==null&&s.v!==""||s.p!==void 0}function nn(s,t){return s&&s.spanAnchor?wo(t.getValue(s.spanAnchor.startRow,s.spanAnchor.startColumn)):wo(s)}function ka(s,t,e,n,o){const r=s.getCellMatrix(),a=s.getSpanModel().getMergedCellRange(t,e,n,o),u=new i.ObjectMatrix;return r.forValue((l,d)=>{const c=r.getValue(l,d);c&&u.setValue(l,d,c)}),a.forEach(l=>{const{startColumn:d,startRow:c,endColumn:m,endRow:h}=l;i.createRowColIter(c,h,d,m).forEach((R,C)=>{R===c&&C===d&&u.setValue(R,C,{...r.getValue(R,C),spanAnchor:{startRow:c,endRow:h,startColumn:d,endColumn:m}}),(R!==c||C!==d)&&(u.realDeleteValue(R,C),u.setValue(R,C,{spanAnchor:{startRow:c,endRow:h,startColumn:d,endColumn:m}}))})}),u}function Na(s,t,e,n){const{startRow:o,startColumn:r,endRow:a}=s;let u=null,l=!1;for(let d=o;d<=a;d++){const c=t.getValue(d,r-e);if(l=l||nn(c,t),!n&&l)break;c&&c.spanAnchor&&(u?u={startRow:Math.min(c.spanAnchor.startRow,u.startRow),startColumn:Math.min(c.spanAnchor.startColumn,u.startColumn),endRow:Math.max(c.spanAnchor.endRow,u.endRow),endColumn:Math.max(c.spanAnchor.endColumn,u.endColumn)}:u={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return l?(s.startColumn=s.startColumn-e,{spanAnchor:u,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function Oa(s,t,e,n){const{startRow:o,endColumn:r,endRow:a}=s;let u=null,l=!1;for(let d=o;d<=a;d++){const c=t.getValue(d,r+e);if(l=l||nn(c,t),!n&&l)break;c&&c.spanAnchor&&(u?u={startRow:Math.min(c.spanAnchor.startRow,u.startRow),startColumn:Math.min(c.spanAnchor.startColumn,u.startColumn),endRow:Math.max(c.spanAnchor.endRow,u.endRow),endColumn:Math.max(c.spanAnchor.endColumn,u.endColumn)}:u={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return l?(s.endColumn=s.endColumn+e,{spanAnchor:u,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function Da(s,t,e,n){const{startRow:o,startColumn:r,endColumn:a}=s;let u=null,l=!1;for(let d=r;d<=a;d++){const c=t.getValue(o-e,d);if(l=l||nn(c,t),!n&&l)break;c&&c.spanAnchor&&(u?u={startRow:Math.min(c.spanAnchor.startRow,u.startRow),startColumn:Math.min(c.spanAnchor.startColumn,u.startColumn),endRow:Math.max(c.spanAnchor.endRow,u.endRow),endColumn:Math.max(c.spanAnchor.endColumn,u.endColumn)}:u={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return l?(s.startRow=s.startRow-e,{spanAnchor:u,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function Aa(s,t,e,n){const{startColumn:o,endColumn:r,endRow:a}=s;let u=null,l=!1;for(let d=o;d<=r;d++){const c=t.getValue(a+e,d);if(l=l||nn(c,t),!n&&l)break;c&&c.spanAnchor&&(u?u={startRow:Math.min(c.spanAnchor.startRow,u.startRow),startColumn:Math.min(c.spanAnchor.startColumn,u.startColumn),endRow:Math.max(c.spanAnchor.endRow,u.endRow),endColumn:Math.max(c.spanAnchor.endColumn,u.endColumn)}:u={startRow:c.spanAnchor.startRow,startColumn:c.spanAnchor.startColumn,endRow:c.spanAnchor.endRow,endColumn:c.spanAnchor.endColumn})}return l?(s.endRow=s.endRow+e,{spanAnchor:u,hasValue:!0,range:s}):{spanAnchor:null,hasValue:!1,range:s}}function Wa(s,t,e){const n=e.getMaxRows(),o=e.getMaxColumns(),r=ka(e,0,0,n-1,o-1),a=e.getSnapshot().mergeData.length>0,{left:u,right:l,up:d,down:c}=t;let m=!0,h={...s};const R=[];for(;m;){if(m=!1,d&&h.startRow!==0){const{hasValue:C,range:S,spanAnchor:I}=Da(h,r,1,a);if(I&&R.push(I),C){h=S,m=!0;continue}}if(c&&h.endRow!==n-1){const{hasValue:C,range:S,spanAnchor:I}=Aa(h,r,1,a);if(I&&R.push(I),C){h=S,m=!0;continue}}if(u&&h.startColumn!==0){const{hasValue:C,range:S,spanAnchor:I}=Na(h,r,1,a);if(I&&R.push(I),C){h=S,m=!0;continue}}if(l&&h.endColumn!==o-1){const{hasValue:C,range:S,spanAnchor:I}=Oa(h,r,1,a);if(I&&R.push(I),C){h=S,m=!0;continue}}}return R.length>0&&(h=i.Rectangle.union(h,...R)),h}const Mo=s=>{const t=new i.ObjectMatrix;return s.forEach(e=>{i.Range.foreach(e,(n,o)=>{t.setValue(n,o,1)})}),t.forValue((e,n)=>{const o=t.getValue(e-1,n);o&&t.setValue(e,n,o+1)}),t},yo=s=>{const t=s;return t.forValue((e,n)=>{const o=s.getValue(e-1,n);o&&t.setValue(e,n,o+1)}),t},_o=s=>{const t={area:0},e=(n,o)=>t.area<n?(t.area=n,t.range=o,!0):!1;return s.forValue((n,o,r)=>{let a=1,u=r;e(a*u,{startRow:n-u+1,endRow:n,startColumn:o,endColumn:o});const l={startRow:n-u+1,endRow:n,startColumn:0,endColumn:o};for(let d=o-1;d>=0&&s.getValue(n,d);d--){u=Math.min(s.getValue(n,d)||0,u),a++;const c=u*a;l.startColumn=d,l.startRow=n-u+1,e(c,l)}}),t},Va=(s,t)=>{i.Range.foreach(t,(e,n)=>{s.realDeleteValue(e,n)});for(let e=t.startColumn;e<=t.endColumn;e++){const n=t.endRow+1;if(s.getValue(n,e)>0){s.setValue(n,e,1);let r=n+1;for(;s.getValue(r,e)>0;)s.setValue(r,e,s.getValue(r-1,e)+1),r++}}return s},Gn=s=>{const t=[];let e=_o(s);for(;e.area>0;)e.range&&(t.push(e.range),Va(s,e.range)),e=_o(s);return t},zn=s=>{const t=Mo(s);return Gn(t)};class $a{constructor(){f(this,"_matrix",new i.ObjectMatrix)}add(...t){return t.forEach(e=>{i.Range.foreach(e,(n,o)=>{this._matrix.setValue(n,o,1)})}),this}subtract(...t){return t.forEach(e=>{i.Range.foreach(e,(n,o)=>{this._matrix.realDeleteValue(n,o)})}),this}merge(){const t=yo(this._matrix);return Gn(t)}}const La=1.5,Ba="rgba(255, 255, 255, 0.01)";function Ha(s){const{rangeWithCoord:t,primaryWithCoord:e,style:n}=s,o={range:{startRow:t.startRow,startColumn:t.startColumn,endRow:t.endRow,endColumn:t.endColumn,rangeType:t.rangeType,unitId:t.unitId,sheetId:t.sheetId},primary:null,style:n};return e!=null&&(o.primary=bo(e)),o}function bo(s){const{actualRow:t,actualColumn:e,isMerged:n,isMergedMainCell:o}=s,{startRow:r,startColumn:a,endRow:u,endColumn:l}=s.mergeInfo;return{actualRow:t,actualColumn:e,isMerged:n,isMergedMainCell:o,startRow:r,startColumn:a,endRow:u,endColumn:l}}var Eo=(s=>(s[s.Tab=1]="Tab",s[s.Comma=2]="Comma",s[s.Semicolon=4]="Semicolon",s[s.Space=8]="Space",s[s.Custom=16]="Custom",s))(Eo||{});class Fa{constructor(){f(this,"_tabCount",0);f(this,"_commaCount",0);f(this,"_semicolonCount",0);f(this,"_spaceCount",0)}add(t){switch(t){case"	":this._tabCount++;break;case",":this._commaCount++;break;case";":this._semicolonCount++;break;case" ":this._spaceCount++;break}}update(t){t&&typeof t=="string"&&(t.includes("	")&&this._tabCount++,t.includes(",")&&this._commaCount++,t.includes(";")&&this._semicolonCount++,t.trim().includes(" ")&&this._spaceCount++)}getDelimiter(){const t=Math.max(this._tabCount,this._commaCount,this._semicolonCount,this._spaceCount);return t===0||t===this._tabCount?1:t===this._commaCount?2:t===this._semicolonCount?4:t===this._spaceCount?8:1}}function ja(s,t,e){const n=[];e!==void 0&&(s&16)>0&&n.push(e),(s&1)>0&&n.push("	"),(s&2)>0&&n.push(","),(s&4)>0&&n.push(";"),(s&8)>0&&n.push(" ");let o="";for(const a of n)o+=Ga(a);let r="[".concat(o,"]");return t&&(r+="+"),new RegExp(r)}function Ga(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const za=s=>{var e;return((e=s.body)==null?void 0:e.dataStream.replace(/\r\n$/,""))||""};function qa(s){if(s!=null){if(s.p)return za(s.p);if(s.v&&typeof s.v=="string")return s.v;if(s.t&&(s.t===i.CellValueType.FORCE_STRING||s.t===i.CellValueType.STRING))return String(s.v)}}function To(s,t,e,n,o=!1){const r=i.Range.transformRange(t,s),{startColumn:a,startRow:u,endColumn:l,endRow:d}=r;if(a!==l)throw new Error("The range must be in the same column.");if(e&&(e&16)>0&&(n===void 0||n.length!==1))throw new Error("The custom delimiter must a character.");const c=e===void 0,m=c?new Fa:null,h=[];for(let p=u;p<=d;p++){const w=s.getCell(p,a),y=qa(w);h.push(y),m&&m.update(y)}const R=c?m.getDelimiter():e,C=ja(R,o,n);let S=-1,I=0,v=0;const M=[];for(const p of h){if(p!==void 0){const w=String(p).split(C);S<0?S=w.length:S=Math.max(S,w.length),M.push(w),I=v}else M.push(void 0);v++}return{rs:M,maxLength:S===-1?0:S,lastRow:I}}const Ya=(s,t,e="")=>s.reduce((n,o)=>{const r=o&&o[t];return typeof r!="string"?(console.warn(o,`${t} is not string`),n):(r?(n[r]||(n[r]=[]),n[r].push(o)):n[e].push(o),n)},{}),Ka=(s=0)=>{let t=s;return function(){return t++}};function Ja(s){return s==null?!1:s.v!==void 0&&s.v!==null&&s.v!==""||s.p!==void 0}function xa(s,t){for(let e=s.startRow;e<=s.endRow;e++)for(let n=s.startColumn;n<=s.endColumn;n++){const o=t.getCell(e,n);if(Ja(o))return{startRow:e,startColumn:n,endRow:e,endColumn:n}}return null}function qn(s){const t=new i.ObjectMatrix;return s.forEach(e=>{const{startRow:n,startColumn:o,endRow:r,endColumn:a}=e;for(let u=n;u<=r;u++)for(let l=o;l<=a;l++)t.setValue(u,l,null)}),t.clone()}function Uo(s){const t=new i.ObjectMatrix;return s.forEach(e=>{const{startRow:n,startColumn:o,endRow:r,endColumn:a}=e;for(let u=n;u<=r;u++)for(let l=o;l<=a;l++)t.setValue(u,l,{v:null,p:null,f:null,si:null,custom:null})}),t.clone()}function Xa(s){const t=new i.ObjectMatrix;return s.forEach(e=>{const{startRow:n,startColumn:o,endRow:r,endColumn:a}=e;for(let u=n;u<=r;u++)for(let l=o;l<=a;l++)t.setValue(u,l,{s:null})}),t.clone()}function Po(s,t,e,n){const o=t.get(i.IUniverInstanceService),r=e?o.getUnit(e,i.UniverInstanceType.UNIVER_SHEET):o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=n?r==null?void 0:r.getSheetBySheetId(n):r==null?void 0:r.getActiveSheet();if(!a)return null;const{startRow:u,endRow:l,startColumn:d,endColumn:c}=s,m=[],h=[];for(let R=u;R<=l;R++)a.getRowFiltered(R)||m.push(R);for(let R=d;R<=c;R++)h.push(R);return{rows:m,cols:h}}function Dt(s,t,e,n){const o=[],r=[];for(const h of s){const R=Po(h,t,e,n);R&&(o.push(...R.rows),r.push(...R.cols))}const a=Array.from(new Set(o)).sort((h,R)=>h-R),u=Array.from(new Set(r)).sort((h,R)=>h-R),l=[];function d(h){const R=[];let C=h[0];for(let S=1;S<h.length;S++)h[S]!==h[S-1]+1&&(R.push([C,h[S-1]]),C=h[S]);return R.push([C,h[h.length-1]]),R}const c=d(a),m=d(u);for(const[h,R]of c)for(const[C,S]of m)l.push({startRow:h,endRow:R,startColumn:C,endColumn:S});return l}var ko=(s=>(s.OthersCanView="othersCanView",s.NoOneElseCanView="noOneElseCanView",s))(ko||{}),No=(s=>(s.DesignedUserCanEdit="designedUserCanEdit",s.OnlyMe="onlyMe",s))(No||{});class X{constructor(){f(this,"_model",new Map);f(this,"_ruleChange$",new O.Subject);f(this,"ruleChange$",this._ruleChange$.asObservable());f(this,"_ruleRefresh$",new O.Subject);f(this,"ruleRefresh$",this._ruleRefresh$.asObservable());f(this,"_rangeRuleInitStateChange",new O.BehaviorSubject(!1));f(this,"rangeRuleInitStateChange$",this._rangeRuleInitStateChange.asObservable())}dispose(){this._ruleChange$.complete(),this._ruleRefresh$.complete()}ruleRefresh(t){this._ruleRefresh$.next(t)}getRangeRuleInitState(){return this._rangeRuleInitStateChange.value}changeRuleInitState(t){this._rangeRuleInitStateChange.next(t)}addRule(t,e,n){this._ensureRuleMap(t,e).set(n.id,n),this._ruleChange$.next({unitId:t,subUnitId:e,rule:n,type:"add"})}deleteRule(t,e,n){var r,a,u,l;const o=(a=(r=this._model.get(t))==null?void 0:r.get(e))==null?void 0:a.get(n);o&&((l=(u=this._model.get(t))==null?void 0:u.get(e))==null||l.delete(n),this._ruleChange$.next({unitId:t,subUnitId:e,rule:o,type:"delete"}))}setRule(t,e,n,o){var a,u;const r=this.getRule(t,e,n);r&&((u=(a=this._model.get(t))==null?void 0:a.get(e))==null||u.set(n,o),this._ruleChange$.next({unitId:t,subUnitId:e,oldRule:r,rule:o,type:"set"}))}getRule(t,e,n){var o,r;return(r=(o=this._model.get(t))==null?void 0:o.get(e))==null?void 0:r.get(n)}getSubunitRuleList(t,e){var o;return[...(((o=this._model.get(t))==null?void 0:o.get(e))||new Map).values()]}getSubunitRuleListLength(t,e){var o;const n=(o=this._model.get(t))==null?void 0:o.get(e);return n?n.size:0}_ensureRuleMap(t,e){let n=this._model.get(t);n||(n=new Map,this._model.set(t,n));let o=n.get(e);return o||(o=new Map,n.set(e,o)),o}toObject(){const t={};return[...this._model.keys()].forEach(n=>{const o=this._model.get(n),r=[...o.keys()];t[n]={},r.forEach(a=>{const u=o.get(a);t[n][a]=[...u.values()]})}),t}fromObject(t){const e=new Map;Object.keys(t).forEach(n=>{const o=t[n],r=new Map;Object.keys(o).forEach(a=>{const u=o[a].reduce((l,d)=>(l.set(d.id,d),l),new Map);r.set(a,u)}),e.set(n,r)}),this._model=e}deleteUnitModel(t){this._model.delete(t)}createRuleId(t,e){let n=i.generateRandomId(4);const o=this._ensureRuleMap(t,e);for(;o.has(n);)n=i.generateRandomId(4);return n}getTargetByPermissionId(t,e){const n=this._model.get(t);if(!n)return null;for(const[o,r]of n)for(const a of r.values())if(a.permissionId===e)return[t,o];return null}}const Za=(s,t)=>{const e=s.get(X),n=t.ruleIds.map(r=>e.getRule(t.unitId,t.subUnitId,r)).filter(r=>!!r);return{id:Ce.id,params:{subUnitId:t.subUnitId,unitId:t.unitId,rules:n}}},Te={id:"sheet.mutation.delete-range-protection",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,ruleIds:o}=t,r=s.get(X);return o.forEach(a=>{r.deleteRule(e,n,a)}),!0}},Qa=s=>{const t={...s,ruleIds:s.rules.map(e=>e.id)};return{id:Te.id,params:t}},Ce={id:"sheet.mutation.add-range-protection",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,rules:o}=t,r=s.get(X);return o.forEach(a=>{r.addRule(e,n,a)}),!0}},Oo={type:i.CommandType.COMMAND,id:"sheet.command.add-range-protection",async handler(s,t){if(!t)return!1;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(X),{rule:r,permissionId:a}=t,{unitId:u,subUnitId:l,ranges:d,description:c,viewState:m,editState:h}=r,R=[{ranges:d,permissionId:a,id:o.createRuleId(u,l),description:c,unitType:r.unitType,unitId:u,subUnitId:l,viewState:m,editState:h}];if(await e.executeCommand(Ce.id,{unitId:u,subUnitId:l,rules:R})){const S=[{id:Ce.id,params:{unitId:u,subUnitId:l,rules:R}}],I=[{id:Te.id,params:{unitId:u,subUnitId:l,ruleIds:R.map(v=>v.id)}}];n.pushUndoRedo({unitID:u,redoMutations:S,undoMutations:I})}return!0}};var te=(s=>(s[s.MOVE_START=0]="MOVE_START",s[s.MOVING=1]="MOVING",s[s.MOVE_END=2]="MOVE_END",s[s.ONLY_SET=3]="ONLY_SET",s))(te||{});class Do extends i.Disposable{constructor(e){super();f(this,"_worksheetSelections",new Map);f(this,"_selectionMoveStart$",new O.Subject);f(this,"selectionMoveStart$",this._selectionMoveStart$.asObservable());f(this,"_selectionMoving$",new O.Subject);f(this,"selectionMoving$",this._selectionMoving$.asObservable());f(this,"_selectionMoveEnd$",new O.BehaviorSubject([]));f(this,"selectionMoveEnd$",this._selectionMoveEnd$.asObservable());f(this,"_selectionSet$",new O.BehaviorSubject([]));f(this,"selectionSet$",this._selectionSet$.asObservable());f(this,"selectionChanged$");f(this,"_beforeSelectionMoveEnd$",new O.BehaviorSubject([]));f(this,"beforeSelectionMoveEnd$",this._beforeSelectionMoveEnd$.asObservable());this._workbook=e,this.selectionChanged$=O.merge(this._selectionMoveEnd$,this._selectionSet$)}dispose(){super.dispose(),this._beforeSelectionMoveEnd$.complete(),this._selectionMoveEnd$.complete(),this._selectionMoving$.complete(),this._selectionMoveStart$.complete(),this._selectionSet$.complete(),this._workbook=null}addSelections(e,n){const o=this.getSelectionsOfWorksheet(e);o.push(...n),this._selectionSet$.next(o)}setSelections(e,n=[],o){switch(this.setSelectionsOfWorksheet(e,n),o){case te.MOVE_START:this._selectionMoveStart$.next(n);break;case te.MOVING:this._selectionMoving$.next(n);break;case te.MOVE_END:this._beforeSelectionMoveEnd$.next(n),this._selectionMoveEnd$.next(n);break;case te.ONLY_SET:{this._selectionSet$.next(n);break}default:this._selectionSet$.next(n);break}}getCurrentSelections(){return this._getCurrentSelections()}getSelectionOfWorksheet(e){return this.getSelectionsOfWorksheet(e)}getSelectionsOfWorksheet(e){return this._worksheetSelections.has(e)||this._worksheetSelections.set(e,[]),this._worksheetSelections.get(e)}setSelectionsOfWorksheet(e,n){this._worksheetSelections.set(e,[...n])}deleteSheetSelection(e){this._worksheetSelections.set(e,[])}clear(){this._worksheetSelections.clear(),this._selectionSet$.next([])}_getCurrentSelections(){return this.getSelectionsOfWorksheet(this._workbook.getActiveSheet().getSheetId())}getCurrentLastSelection(){const e=this._getCurrentSelections();return e[e.length-1]}}var eu=Object.getOwnPropertyDescriptor,tu=(s,t,e,n)=>{for(var o=n>1?void 0:n?eu(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},nu=(s,t)=>(e,n)=>t(e,n,s);g.SheetsSelectionsService=class extends i.RxDisposable{constructor(e){super();f(this,"_cellStylesCache",new Map);f(this,"selectionMoveStart$");f(this,"selectionMoving$");f(this,"selectionMoveEnd$");f(this,"selectionSet$");f(this,"selectionChanged$");f(this,"_workbookSelections",new Map);this._instanceSrv=e,this._init()}get _currentSelectionPos(){const e=this._instanceSrv.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!e)return null;const n=e.getActiveSheet();return{unitId:e.getUnitId(),sheetId:n.getSheetId()}}get currentSelectionParam(){return this._currentSelectionPos}_init(){const e=this._instanceSrv.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.shareReplay(1),O.takeUntil(this.dispose$));this.selectionMoveStart$=e.pipe().pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveStart$:O.of())).pipe(O.takeUntil(this.dispose$)),this.selectionMoving$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoving$:O.of())).pipe(O.takeUntil(this.dispose$)),this.selectionMoveEnd$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionMoveEnd$:O.of([]))).pipe(O.takeUntil(this.dispose$)),this.selectionSet$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionSet$:O.of([]))).pipe(O.takeUntil(this.dispose$)),this.selectionChanged$=e.pipe(O.switchMap(n=>n?this._ensureWorkbookSelection(n.getUnitId()).selectionChanged$:O.of([]))).pipe(O.distinctUntilChanged((n,o)=>n.length!==o.length?!1:n.length===0&&o.length===0?!0:n.every((r,a)=>JSON.stringify(r)===JSON.stringify(o[a]))),O.skip(1)).pipe(O.takeUntil(this.dispose$)),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.takeUntil(this.dispose$)).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId())})),this.disposeWithMe(this.selectionChanged$.pipe(O.takeUntil(this.dispose$)).subscribe(()=>{this._cellStylesCache.clear()}))}dispose(){super.dispose(),this._cellStylesCache.clear(),this._workbookSelections.forEach(e=>e.dispose()),this._workbookSelections.clear(),this.selectionMoveStart$=O.of(null),this.selectionMoving$=O.of(null),this.selectionMoveEnd$=O.of([]),this.selectionSet$=O.of(null),this.selectionChanged$=O.of(null)}clear(){this._workbookSelections.forEach(e=>e.clear())}getCurrentSelections(){return this._getCurrentSelections()}getCurrentLastSelection(){const e=this._getCurrentSelections();return e==null?void 0:e[e.length-1]}addSelections(e,n,o){if(typeof e=="string"){this._ensureWorkbookSelection(e).addSelections(n,o);return}const r=this._currentSelectionPos;if(!r)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:a,sheetId:u}=r;this._ensureWorkbookSelection(a).addSelections(u,e)}setSelections(e,n,o,r){if(typeof e=="string"&&typeof n=="string"){const d=e;this._ensureWorkbookSelection(d).setSelections(n,o||[],r!=null?r:te.ONLY_SET);return}const a=this._currentSelectionPos;if(!a)throw new Error("[SheetsSelectionsService]: cannot find current selection position!");const{unitId:u,sheetId:l}=a;if(typeof e=="object"){const d=e!=null?e:o,c=n!=null?n:te.ONLY_SET;this._ensureWorkbookSelection(u).setSelections(l,d,c)}}clearCurrentSelections(){this._getCurrentSelections().splice(0)}isOverlapping(){const e=this.getCurrentSelections();return e==null?!1:e.some(({range:n},o)=>e.some(({range:r},a)=>o===a?!1:n.startRow<=r.endRow&&n.endRow>=r.startRow&&n.startColumn<=r.endColumn&&n.endColumn>=r.startColumn))}_getCurrentSelections(){const e=this._currentSelectionPos;if(!e)return[];const{unitId:n,sheetId:o}=e;return this._ensureWorkbookSelection(n).getSelectionsOfWorksheet(o)}getWorkbookSelections(e){return this._ensureWorkbookSelection(e)}_ensureWorkbookSelection(e){let n=this._workbookSelections.get(e);if(!n){const o=this._instanceSrv.getUnit(e);if(!o)throw new Error(`[SheetsSelectionsService]: cannot resolve unit with id "${e}"!`);n=new Do(o),this._workbookSelections.set(e,n)}return n}_removeWorkbookSelection(e){this._workbookSelections.delete(e)}getCellStylesProperty(e){var a;const n=(a=this._instanceSrv.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:a.getActiveSheet(),o=this.getCurrentSelections();if(!n||o.length===0)return{isAllValuesSame:!1,value:null};let r=null;for(let u=0;u<o.length;u++){const l=o[u],{startRow:d,endRow:c,startColumn:m,endColumn:h}=l.range;for(let R=d;R<=c;R++)for(let C=m;C<=h;C++){const S=`${R}_${C}`;let I;this._cellStylesCache.has(S)?I=this._cellStylesCache.get(S):(I=n.getComposedCellStyle(R,C),this._cellStylesCache.set(S,I));const v=I[e];if(r!=null&&!i.Tools.diffValue(r,v))return{isAllValuesSame:!1,value:null};r=v}}return{isAllValuesSame:!0,value:r}}},g.SheetsSelectionsService=tu([nu(0,i.IUniverInstanceService)],g.SheetsSelectionsService);const su="DISABLE_NORMAL_SELECTIONS",ou="SELECTIONS_ENABLED",Ao="REF_SELECTIONS_ENABLED",sn={id:"sheet.command.clear-selection-all",type:i.CommandType.COMMAND,handler:(s,t)=>{var p;const e=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUndoRedoService),a=s.get(g.SheetInterceptorService),u=e.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!u)return!1;const l=(t==null?void 0:t.unitId)||u.getUnitId(),d=u.getActiveSheet();if(!d)return!1;const c=(t==null?void 0:t.subUnitId)||d.getSheetId(),m=(t==null?void 0:t.ranges)||((p=o.getCurrentSelections())==null?void 0:p.map(w=>w.range));if(!(m!=null&&m.length))return!1;const h=Dt(m,s,l,c),R=[],C=[],S={subUnitId:c,unitId:l,cellValue:qn(h)},I=ce(s,S);R.push({id:F.id,params:S}),C.push({id:F.id,params:I});const v=a.onCommandExecute({id:sn.id});return R.push(...v.redos),C.unshift(...v.undos),i.sequenceExecute(R,n)?(r.pushUndoRedo({unitID:l,undoMutations:C,redoMutations:R}),!0):!1}},on={id:"sheet.command.clear-selection-format",type:i.CommandType.COMMAND,handler:(s,t)=>{var p;const e=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUndoRedoService),a=s.get(g.SheetInterceptorService),u=e.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!u)return!1;const l=(t==null?void 0:t.unitId)||u.getUnitId(),d=u.getActiveSheet();if(!d)return!1;const c=(t==null?void 0:t.subUnitId)||d.getSheetId(),m=(t==null?void 0:t.ranges)||((p=o.getCurrentSelections())==null?void 0:p.map(w=>w.range));if(!(m!=null&&m.length))return!1;const h=Dt(m,s,l,c),R=[],C=[],S={subUnitId:c,unitId:l,cellValue:Xa(h)},I=ce(s,S);R.push({id:F.id,params:S}),C.push({id:F.id,params:I});const v=a.onCommandExecute({id:on.id});return R.push(...v.redos),C.unshift(...v.undos),i.sequenceExecute(R,n)?(r.pushUndoRedo({unitID:l,undoMutations:C,redoMutations:R}),!0):!1}};function At(s,t,e=!0){const n=t.getMatrixWithMergedCells(...i.selectionToArray(s)),o=[];if(n.forValue((a,u,l)=>{if(l.colSpan!==void 0&&l.rowSpan!==void 0){const d={startRow:a,startColumn:u,endRow:a+l.rowSpan-1,endColumn:u+l.colSpan-1};i.Rectangle.contains(s,d)||o.push(d)}}),o.length===0)return s;const r=i.Rectangle.union(s,...o);return e?At(r,t,e):r}function ru(s,t,e){let n=null;return e.getMatrixWithMergedCells(s,t,s,t).forValue((r,a,u)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:u.rowSpan!==void 0||u.colSpan!==void 0,isMergedMainCell:u.rowSpan!==void 0&&u.colSpan!==void 0,endRow:r+(u.rowSpan!==void 0?u.rowSpan-1:0),endColumn:a+(u.colSpan!==void 0?u.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:t,actualRow:s,startRow:s,startColumn:t,endRow:s,endColumn:t,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}function iu(s,t,e){const{startRow:n,startColumn:o,endRow:r,endColumn:a}=s;return Number.isNaN(n)&&(s.startRow=0),Number.isNaN(r)&&(s.endRow=t-1),Number.isNaN(o)&&(s.startColumn=0),Number.isNaN(a)&&(s.endColumn=e-1),s}function se(s,t){const e=Number.isNaN(s.startRow)?0:s.startRow,n=Number.isNaN(s.startColumn)?0:s.startColumn,o=t.getMergedCell(e,n);return o?{...o,actualRow:e,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!0,isMergedMainCell:!0}:{startRow:e,startColumn:n,endRow:s.startRow,endColumn:s.startColumn,actualRow:e,actualColumn:n,rangeType:i.RANGE_TYPE.NORMAL,isMerged:!1,isMergedMainCell:!1}}const Ue=(s,t,e)=>({id:q.id,params:{unitId:t.getUnitId(),subUnitId:e.getSheetId(),reveal:!0,selections:[{range:s,primary:se(s,e)}]}});function au(s){if(!s)return!1;const{range:t,primary:e}=s;return i.Rectangle.equals(t,e)}function uu(s){function t(e,n){function o(r){for(let a=r.startRow;a<=r.endRow;a++)if(!s.getRowFiltered(a))for(let u=r.startColumn;u<=r.endColumn;u++)n(a,u,r)}o(e)}return{forOperableEach:t}}const Wo=s=>s.id!==no;function $e(s,t,e,n,o,r,a){const u={};for(let l=t;l<=e;l++)for(let d=n;d<=o;d++){const c=r?s.getCellWithFilteredInterceptors(a,d,so,Wo):s.getCellWithFilteredInterceptors(l,a,so,Wo);!c||!c.s||(u[l]||(u[l]={}),u[l][d]={s:c.s})}return u}var lu=Object.getOwnPropertyDescriptor,du=(s,t,e,n)=>{for(var o=n>1?void 0:n?lu(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},cu=(s,t)=>(e,n)=>t(e,n,s);const Vo=i.createIdentifier("sheets-formula.ref-selections.service");g.RefSelectionsService=class extends g.SheetsSelectionsService{constructor(t){super(t)}_init(){const t=this._getAliveWorkbooks$().pipe(O.takeUntil(this.dispose$));this.selectionMoveStart$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionMoveStart$)))),this.selectionMoving$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionMoving$)))),this.selectionMoveEnd$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionMoveEnd$)))),this.selectionSet$=t.pipe(O.switchMap(e=>O.merge(...e.map(n=>n.selectionSet$))))}dispose(){super.dispose(),this.selectionMoveStart$=O.of(null),this.selectionMoving$=O.of(null),this.selectionMoveEnd$=O.of(null),this.selectionSet$=O.of(null),delete this._instanceSrv,this._workbookSelections.clear()}_getAliveWorkbooks$(){const t=this._instanceSrv.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET);t.forEach(n=>this._ensureWorkbookSelection(n.getUnitId()));const e=new O.BehaviorSubject(t);return this.disposeWithMe(this._instanceSrv.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._ensureWorkbookSelection(n.getUnitId()),e.next([...e.getValue(),n])})),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{this._removeWorkbookSelection(n.getUnitId()),e.next(e.getValue().filter(o=>o!==n))})),e.pipe(O.map(n=>n.map(o=>this._ensureWorkbookSelection(o.getUnitId()))))}},g.RefSelectionsService=du([cu(0,i.IUniverInstanceService)],g.RefSelectionsService);function $o(s,t){const n=s.get(i.IContextService).getContextValue(Ao);return s.get(n&&!t?Vo:g.SheetsSelectionsService)}const q={id:"sheet.operation.set-selections",type:i.CommandType.OPERATION,handler:(s,t)=>{if(!t)return!1;const{selections:e,type:n,unitId:o,subUnitId:r}=t;return $o(s).setSelections(o,r,[...e],n),!0}},Lo={id:"sheet.command.select-range",type:i.CommandType.COMMAND,handler:(s,t)=>{if(!t)return!1;const{unitId:e,subUnit:n,range:o}=t,r=s.get(i.ICommandService),a=P(s.get(i.IUniverInstanceService),t);if(!a)return!1;const u=[{range:o,primary:se(o,a.worksheet),style:null}];return r.syncExecuteCommand(q.id,{unitId:e,subUnitId:n,selections:u})}},Bo="sheet.command.move-range",xe={type:i.CommandType.COMMAND,id:Bo,handler:async(s,t)=>{var M,p;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(i.ErrorService),a=s.get(i.LocaleService),u=s.get(g.SheetInterceptorService),l=P(o);if(!l||!await u.beforeCommandExecute({id:xe.id,params:t}))return!1;const{worksheet:c,subUnitId:m,unitId:h}=l,R=rn(s,{unitId:h,subUnitId:m,range:t.fromRange},{subUnitId:m,range:t.toRange});if(R===null)return r.emit(a.t("sheets.info.acrossMergedCell")),!1;const C=u.onCommandExecute({id:xe.id,params:t}),S=[...(M=C.preRedos)!=null?M:[],...R.redos,...C.redos,{id:q.id,params:{unitId:h,subUnitId:m,selections:[{range:t.toRange,primary:mu(t.fromRange,t.toRange,c)}],type:te.MOVE_END}}],I=[...(p=C.preUndos)!=null?p:[],...R.undos,...C.undos,{id:q.id,params:{unitId:h,subUnitId:m,selections:[{range:t.fromRange,primary:se(t.fromRange,c)}],type:te.MOVE_END}}];if(i.sequenceExecute(S,e).result){const{undos:w,redos:y}=u.generateMutationsOfAutoHeight({unitId:h,subUnitId:m,ranges:[t.fromRange,t.toRange]}),b=u.afterCommandExecute({id:xe.id,params:t});return i.sequenceExecute([...b.redos,...y],e),n.pushUndoRedo({unitID:h,undoMutations:[...I,...b.undos,...w],redoMutations:[...S,...b.redos,...y]}),!0}return!1}};function rn(s,t,e,n=!1){const o=[],r=[],{range:a,subUnitId:u,unitId:l}=t,{range:d,subUnitId:c}=e,h=s.get(i.IUniverInstanceService).getUniverSheetInstance(l),R=h==null?void 0:h.getSheetBySheetId(c),C=h==null?void 0:h.getSheetBySheetId(u),S=R==null?void 0:R.getCellMatrix(),I=C==null?void 0:C.getCellMatrix();if(R&&C&&S&&I){const v=At(d,R,!1);if(!i.Rectangle.equals(d,v)&&!n)return null;const M=new i.ObjectMatrix,p=new i.ObjectMatrix,w=new i.ObjectMatrix;i.Range.foreach(a,(k,E)=>{const N=I.getValue(k,E);if(M.setValue(k,E,i.Tools.deepClone(N)),N){const W=h==null?void 0:h.getStyles().get(N.s);w.setValue(k,E,i.Tools.deepClone(W))}p.setValue(k,E,null)});const y=new i.ObjectMatrix,b=new i.ObjectMatrix;i.Range.foreach(d,(k,E)=>{y.setValue(k,E,i.Tools.deepClone(S.getValue(k,E)))}),i.Range.foreach(a,(k,E)=>{const N=i.cellToRange(k,E),W=i.Rectangle.getRelativeRange(N,a),V=i.Rectangle.getPositionRange(W,d),$=i.Tools.deepClone(w.getValue(k,E)),L=i.Tools.deepClone(M.getValue(k,E));L&&$&&(L.s=$),b.setValue(V.startRow,V.startColumn,L)});const T={fromRange:t.range,toRange:e.range,from:{value:p.getMatrix(),subUnitId:u},to:{value:b.getMatrix(),subUnitId:c},unitId:l},U={fromRange:e.range,toRange:t.range,from:{value:M.getMatrix(),subUnitId:u},to:{value:y.getMatrix(),subUnitId:c},unitId:l};o.push({id:Be.id,params:T}),r.push({id:Be.id,params:U})}return{redos:o,undos:r}}function mu(s,t,e){const n=s.startRow,o=s.startColumn,r=e.getMergedCell(n,o),a=se(t,e);if(r){const u=r.endRow-r.startRow+1,l=r.endColumn-r.startColumn+1;a.endRow=a.startRow+u-1,a.endColumn=a.startColumn+l-1,a.actualRow=a.startRow,a.actualColumn=a.startColumn,a.isMerged=!1,a.isMergedMainCell=!0}return a}var an=(s=>(s[s.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",s[s.UNIVER_DOC=1]="UNIVER_DOC",s[s.UNIVER_SHEET=2]="UNIVER_SHEET",s[s.UNIVER_SLIDE=3]="UNIVER_SLIDE",s[s.UNIVER_PROJECT=4]="UNIVER_PROJECT",s[s.UNRECOGNIZED=-1]="UNRECOGNIZED",s))(an||{}),_=(s=>(s[s.View=0]="View",s[s.Edit=1]="Edit",s[s.ManageCollaborator=2]="ManageCollaborator",s[s.Print=3]="Print",s[s.Duplicate=4]="Duplicate",s[s.Comment=5]="Comment",s[s.Copy=6]="Copy",s[s.Share=7]="Share",s[s.Export=8]="Export",s[s.MoveWorksheet=9]="MoveWorksheet",s[s.DeleteWorksheet=10]="DeleteWorksheet",s[s.HideWorksheet=11]="HideWorksheet",s[s.RenameWorksheet=12]="RenameWorksheet",s[s.CreateWorksheet=13]="CreateWorksheet",s[s.SetWorksheetStyle=14]="SetWorksheetStyle",s[s.EditWorksheetCell=15]="EditWorksheetCell",s[s.InsertHyperlink=16]="InsertHyperlink",s[s.Sort=17]="Sort",s[s.Filter=18]="Filter",s[s.PivotTable=19]="PivotTable",s[s.FloatImg=20]="FloatImg",s[s.History=21]="History",s[s.RwHgtClWdt=22]="RwHgtClWdt",s[s.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",s[s.ViewFilter=24]="ViewFilter",s[s.MoveSheet=25]="MoveSheet",s[s.DeleteSheet=26]="DeleteSheet",s[s.HideSheet=27]="HideSheet",s[s.CopySheet=28]="CopySheet",s[s.RenameSheet=29]="RenameSheet",s[s.CreateSheet=30]="CreateSheet",s[s.SelectProtectedCells=31]="SelectProtectedCells",s[s.SelectUnProtectedCells=32]="SelectUnProtectedCells",s[s.SetCellStyle=33]="SetCellStyle",s[s.SetCellValue=34]="SetCellValue",s[s.SetRowStyle=35]="SetRowStyle",s[s.SetColumnStyle=36]="SetColumnStyle",s[s.InsertRow=37]="InsertRow",s[s.InsertColumn=38]="InsertColumn",s[s.DeleteRow=39]="DeleteRow",s[s.DeleteColumn=40]="DeleteColumn",s[s.EditExtraObject=41]="EditExtraObject",s[s.Delete=42]="Delete",s[s.RecoverHistory=43]="RecoverHistory",s[s.ViewHistory=44]="ViewHistory",s[s.CreatePermissionObject=45]="CreatePermissionObject",s[s.UNRECOGNIZED=-1]="UNRECOGNIZED",s))(_||{}),D=(s=>(s[s.Unkonwn=0]="Unkonwn",s[s.Workbook=1]="Workbook",s[s.Worksheet=2]="Worksheet",s[s.SelectRange=3]="SelectRange",s[s.Document=4]="Document",s[s.Slide=5]="Slide",s[s.UNRECOGNIZED=-1]="UNRECOGNIZED",s))(D||{});class Se{constructor(t,e,n){f(this,"type",D.SelectRange);f(this,"subType",_.Edit);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${D.SelectRange}.${_.Edit}.${n}`}}class un{constructor(t,e,n){f(this,"type",D.SelectRange);f(this,"subType",_.View);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${D.SelectRange}.${_.View}.${n}`}}class Yn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Comment);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.Comment}_${t}`}}class Kn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Copy);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.Copy}_${t}`}}class Ho{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"subType",_.CopySheet);f(this,"status",i.PermissionStatus.INIT);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.CopySheet}_${t}`}}class Jn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.CreatePermissionObject);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.CreatePermissionObject}_${t}`}}class xn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.CreateSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.CreateSheet}_${t}`}}class Fo{constructor(t){f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.DeleteColumn);this.unitId=t,this.id=`${this.type}.${_.DeleteColumn}_${t}`}}class jo{constructor(t){f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.DeleteRow);this.unitId=t,this.id=`${this.type}.${_.DeleteRow}_${t}`}}class Xn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.DeleteSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.DeleteSheet}_${t}`}}class Zn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Duplicate);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.Duplicate}_${t}`}}class me{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Edit);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.Edit}_${t}`}}class Qn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Export);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.Export}_${t}`}}class ln{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.HideSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.HideSheet}_${t}`}}class Go{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.History);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.History}_${t}`}}class zo{constructor(t){f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertColumn);this.unitId=t,this.id=`${this.type}.${_.InsertColumn}_${t}`}}class qo{constructor(t){f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertRow);this.unitId=t,this.id=`${this.type}.${_.InsertRow}_${t}`}}class dn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.ManageCollaborator);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.ManageCollaborator}_${t}`}}class cn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.MoveSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.MoveSheet}_${t}`}}class es{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Print);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.Print}_${t}`}}class ts{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.RecoverHistory);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.RecoverHistory}_${t}`}}class mn{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.RenameSheet);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.RenameSheet}_${t}`}}class ns{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.Share);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.Share}_${t}`}}class ss{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.View);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.View}_${t}`}}class os{constructor(t){f(this,"id");f(this,"value",!0);f(this,"type",D.Workbook);f(this,"status",i.PermissionStatus.INIT);f(this,"subType",_.ViewHistory);this.unitId=t,this.unitId=t,this.id=`${this.type}.${_.ViewHistory}_${t}`}}class rs{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Copy);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.Copy}_${t}_${e}`}}class is{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.DeleteColumn);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.DeleteColumn}_${t}_${e}`}}class as{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Delete);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.Delete}_${t}_${e}`}}class us{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.DeleteRow);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.DeleteRow}_${t}_${e}`}}class fe{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Edit);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.Edit}_${t}_${e}`}}class ls{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.EditExtraObject);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.EditExtraObject}_${t}_${e}`}}class ds{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Filter);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.Filter}_${t}_${e}`}}class cs{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertColumn);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.InsertColumn}_${t}_${e}`}}class ms{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertHyperlink);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.InsertHyperlink}_${t}_${e}`}}class hs{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.InsertRow);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.InsertRow}_${t}_${e}`}}class gs{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.ManageCollaborator);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.ManageCollaborator}_${t}_${e}`}}class Rs{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.PivotTable);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.PivotTable}_${t}_${e}`}}class hu{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SelectProtectedCells);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.SelectProtectedCells}_${t}_${e}`}}class gu{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SelectUnProtectedCells);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.SelectUnProtectedCells}_${t}_${e}`}}class Cs{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetCellStyle);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.SetCellStyle}_${t}_${e}`}}class Wt{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetCellValue);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.SetCellValue}_${t}_${e}`}}class St{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetColumnStyle);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.SetColumnStyle}_${t}_${e}`}}class ft{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.SetRowStyle);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.SetRowStyle}_${t}_${e}`}}class Ss{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.Sort);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.Sort}_${t}_${e}`}}class Vt{constructor(t,e){f(this,"value",!0);f(this,"type",D.Worksheet);f(this,"status",i.PermissionStatus.INIT);f(this,"id");f(this,"subType",_.View);this.unitId=t,this.subUnitId=e,this.id=`${this.type}.${_.View}_${t}_${e}`}}const It={id:"sheet.command.set-range-values",type:i.CommandType.COMMAND,handler:(s,t)=>{var W;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),u=s.get(i.IPermissionService),l=P(o,t);if(!l)return!1;const{subUnitId:d,unitId:c,workbook:m,worksheet:h}=l,{value:R,range:C,redoUndoId:S}=t,I=C?[C]:(W=r.getCurrentSelections())==null?void 0:W.map(V=>V.range);if(!I||!I.length||!u.getPermissionPoint(new fe(c,d).id))return!1;const v=new i.ObjectMatrix;let M;if(i.Tools.isArray(R))for(let V=0;V<I.length;V++){const{startRow:$,startColumn:L,endRow:Y,endColumn:z}=I[V];for(let K=0;K<=Y-$;K++)for(let oe=0;oe<=z-L;oe++)v.setValue(K+$,oe+L,R[K][oe])}else if(i.isICellData(R))for(let V=0;V<I.length;V++){const{startRow:$,startColumn:L,endRow:Y,endColumn:z}=I[V];for(let K=$;K<=Y;K++)for(let oe=L;oe<=z;oe++)v.setValue(K,oe,R)}else M=R;const p={subUnitId:d,unitId:c,cellValue:M!=null?M:v.getMatrix()},w=ce(s,p),y=i.mapObjectMatrix(p.cellValue,(V,$)=>h.getCellHeight(V,$)||void 0);if(!e.syncExecuteCommand(F.id,p))return!1;const{undos:T,redos:U}=a.onCommandExecute({id:It.id,params:p}),{undos:k,redos:E}=a.generateMutationsOfAutoHeight({unitId:c,subUnitId:d,ranges:I,cellHeights:new i.ObjectMatrix(y)});if(i.sequenceExecute([...U,...E],e).result){const V=Ue(C!=null?C:v.getRange(),m,h);return n.pushUndoRedo({unitID:c,undoMutations:[{id:F.id,params:w},...T,...k,V],redoMutations:[{id:F.id,params:p},...U,...E,i.Tools.deepClone(V)],id:S}),!0}return!1}};function fs(s,t){const e=[],n=[],{unitId:o,subUnitId:r,range:a,shiftDimension:u,cellValue:l={}}=t,d=s.get(i.IUniverInstanceService),c=s.get(g.SheetInterceptorService),m=d.getUniverSheetInstance(o),h=m==null?void 0:m.getSheetBySheetId(r);if(h){const R=h.getCellMatrix(),C=R.getDataRange();if(a.startColumn<=C.endColumn||a.startRow<=C.endRow){let p,w;if(u===i.Dimension.COLUMNS){const b=Math.min(a.endRow,C.endRow);let T=0;for(let k=a.startRow;k<=b;k++){const E=R.getRow(k),N=E?i.getArrayLength(E)-1:0;T=Math.max(T,N)}p={startRow:a.startRow,startColumn:a.startColumn,endRow:b,endColumn:T};const U=a.endColumn-a.startColumn+1;w={startRow:a.startRow,startColumn:p.startColumn+U,endRow:b,endColumn:p.endColumn+U}}else{const b=Math.min(a.endColumn,C.endColumn),T=C.endRow;p={startRow:a.startRow,startColumn:a.startColumn,endRow:T,endColumn:b};const U=a.endRow-a.startRow+1;w={startRow:p.startRow+U,startColumn:a.startColumn,endRow:p.endRow+U,endColumn:b}}const y=rn(s,{unitId:o,subUnitId:r,range:p},{subUnitId:r,range:w},!0);y&&(e.push(...y.redos),n.push(...y.undos))}if(Object.entries(l).length===0)for(let p=a.startRow;p<=a.endRow;p++){l[p]||(l[p]={});for(let w=a.startColumn;w<=a.endColumn;w++)l[p][w]=null}const S={subUnitId:r,unitId:o,cellValue:l},I=ce(s,S),{undos:v,redos:M}=c.onCommandExecute({id:It.id,params:{...S,range:a}});e.push({id:F.id,params:S},...M),n.push({id:F.id,params:I},...v)}return{redo:e,undo:n}}function Is(s,t){const e=[],n=[],{unitId:o,subUnitId:r,range:a,shiftDimension:u}=t,l=s.get(i.IUniverInstanceService),d=s.get(g.SheetInterceptorService),c=l.getUniverSheetInstance(o),m=c==null?void 0:c.getSheetBySheetId(r);if(m){const h=m.getCellMatrix(),R=h.getDataRange(),C={subUnitId:r,unitId:o,cellValue:qn([a])},S=ce(s,C),I=d.onCommandExecute({id:It.id,params:C});if(e.push({id:F.id,params:C},...I.redos),n.push(...I.undos,{id:F.id,params:S}),a.startColumn<=R.endColumn||a.startRow<=R.endRow){let v=null,M=null;if(u===i.Dimension.COLUMNS&&a.endColumn<R.endColumn){const p=Math.min(a.endRow,R.endRow);let w=0;for(let b=a.startRow;b<=p;b++){const T=h.getRow(b),U=T?i.getArrayLength(T)-1:0;w=Math.max(w,U)}v={startRow:a.startRow,startColumn:a.endColumn+1,endRow:p,endColumn:w};const y=a.endColumn-a.startColumn+1;M={startRow:a.startRow,startColumn:v.startColumn-y,endRow:p,endColumn:v.endColumn-y}}if(u===i.Dimension.ROWS&&a.endRow<R.endRow){const p=Math.min(a.endColumn,R.endColumn),w=R.endRow;v={startRow:a.endRow+1,startColumn:a.startColumn,endRow:w,endColumn:p};const y=a.endRow-a.startRow+1;M={startRow:v.startRow-y,startColumn:a.startColumn,endRow:v.endRow-y,endColumn:p}}if(v&&M){const p=rn(s,{unitId:o,subUnitId:r,range:v},{subUnitId:r,range:M},!0);p&&(e.push(...p.redos),n.push(...p.undos))}}}return{redo:e,undo:n}}function Ru(s,t,e,n,o,r){const{startRow:a,endRow:u,startColumn:l,endColumn:d}=t;if(o===i.Dimension.ROWS){const c=u-a+1;for(let m=e;m>=a;m--)for(let h=l;h<=d;h++){const R=s.getValue(m,h);R==null?s.realDeleteValue(m+c,h):s.setValue(m+c,h,R)}for(let m=u;m>=a;m--)for(let h=l;h<=d;h++)r&&r[m]&&r[m][h]?s.setValue(m,h,r[m][h]):s.realDeleteValue(m,h)}else if(o===i.Dimension.COLUMNS){const c=d-l+1;for(let m=a;m<=u;m++)for(let h=n;h>=l;h--){const R=s.getValue(m,h);R==null?s.realDeleteValue(m,h+c):s.setValue(m,h+c,R)}for(let m=a;m<=u;m++)for(let h=d;h>=l;h--)r&&r[m]&&r[m][h]?s.setValue(m,h,r[m][h]):s.realDeleteValue(m,h)}}function Cu(s,t,e,n,o){const{startRow:r,endRow:a,startColumn:u,endColumn:l}=t,d=a-r+1,c=l-u+1;if(o===i.Dimension.ROWS)for(let m=r;m<=e;m++)for(let h=u;h<=l;h++){const R=s.getValue(m+d,h);R==null?s.realDeleteValue(m,h):s.setValue(m,h,R)}else if(o===i.Dimension.COLUMNS)for(let m=r;m<=a;m++)for(let h=u;h<=n;h++){const R=s.getValue(m,h+c);R==null?s.realDeleteValue(m,h):s.setValue(m,h,R)}}const Yo="sheet.command.delete-range-move-left",He={type:i.CommandType.COMMAND,id:Yo,handler:async(s,t)=>{var w,y,b;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),u=P(o);if(!u)return!1;const{worksheet:l,workbook:d,subUnitId:c,unitId:m}=u;let h=t==null?void 0:t.range;if(h||(h=(w=r.getCurrentLastSelection())==null?void 0:w.range),!h)return!1;const R={range:h,subUnitId:c,unitId:m,shiftDimension:i.Dimension.COLUMNS},C=a.onCommandExecute({id:He.id,params:{range:h}}),{redo:S,undo:I}=Is(s,R),v=[...(y=C.preRedos)!=null?y:[],...S],M=[...C.undos,...I];if(v.push(...C.redos),v.push(Ue(h,d,l)),M.push(...(b=C.preUndos)!=null?b:[]),i.sequenceExecute(v,e).result){const T=a.afterCommandExecute({id:He.id,params:{range:h}});return i.sequenceExecute(T.redos,e),M.push(...T.undos),v.push(...T.redos),n.pushUndoRedo({unitID:m,undoMutations:M.reverse(),redoMutations:v}),!0}return!1}},Ko="sheet.command.delete-range-move-up",Fe={type:i.CommandType.COMMAND,id:Ko,handler:async(s,t)=>{var w,y,b;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),u=P(o);if(!u)return!1;const{unitId:l,subUnitId:d,workbook:c,worksheet:m}=u;let h=t==null?void 0:t.range;if(h||(h=(w=r.getCurrentLastSelection())==null?void 0:w.range),!h)return!1;const R={range:h,subUnitId:d,unitId:l,shiftDimension:i.Dimension.ROWS},C=a.onCommandExecute({id:Fe.id,params:{range:h}}),{redo:S,undo:I}=Is(s,R),v=[...(y=C.preRedos)!=null?y:[],...S],M=[...C.undos,...I];if(v.push(...C.redos),v.push(Ue(h,c,m)),M.push(...(b=C.preUndos)!=null?b:[]),i.sequenceExecute(v,e).result){const T=a.afterCommandExecute({id:Fe.id,params:{range:h}});return i.sequenceExecute(T.redos,e),M.push(...T.undos),v.push(...T.redos),n.pushUndoRedo({unitID:l,undoMutations:M.reverse(),redoMutations:v}),!0}return!1}},Su="sheet.command.insert-range-move-down",Xe={type:i.CommandType.COMMAND,id:"sheet.command.insert-range-move-down",handler:async(s,t)=>{var W,V,$;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),u=s.get(i.ErrorService),l=s.get(i.LocaleService);if(r.isOverlapping())return u.emit(l.t("sheets.info.overlappingSelections")),!1;const d=P(o);if(!d)return!1;const{unitId:c,subUnitId:m,worksheet:h,workbook:R}=d;let C=t==null?void 0:t.range;if(C||(C=(W=r.getCurrentLastSelection())==null?void 0:W.range),!C)return!1;const S=[],I=[],v=h.getCellMatrix(),M=v.getDataRange(),w=v.getSlice(M.startRow,M.endRow,C.startColumn,C.endColumn).getDataRange().endRow,y=Math.max(w+(C.endRow-C.startRow+1)-M.endRow,0);if(y>0){const L=C.startRow-1,Y=h.getRowHeight(L),z={unitId:c,subUnitId:m,range:{startRow:M.endRow+1,endRow:M.endRow+y,startColumn:M.startColumn,endColumn:M.endColumn},rowInfo:new Array(y).fill(void 0).map(()=>({h:Y,hd:i.BooleanNumber.FALSE}))};S.push({id:re.id,params:z});const K=en(s,z);I.push({id:ae.id,params:K})}const b={};i.Range.foreach(C,(L,Y)=>{const z=h.getCell(L,Y);z&&(b[L]||(b[L]={}),b[L][Y]={s:z.s})});const T={range:C,subUnitId:m,unitId:c,shiftDimension:i.Dimension.ROWS,cellValue:b},{redo:U,undo:k}=fs(s,T);S.push(...U),I.push(...k);const E=a.onCommandExecute({id:Xe.id,params:{range:C}});if(S.push(...E.redos),S.push(Ue(C,R,h)),I.push(...(V=E.preUndos)!=null?V:[]),S.unshift(...($=E.preRedos)!=null?$:[]),I.unshift(...E.undos),i.sequenceExecute(S,e)){const L=a.afterCommandExecute({id:Xe.id,params:{range:C}});return i.sequenceExecute(L.redos,e),I.push(...L.undos),S.push(...L.redos),n.pushUndoRedo({unitID:c,undoMutations:I.reverse(),redoMutations:S}),!0}return!1}},vs="sheet.command.insert-range-move-right",vt={type:i.CommandType.COMMAND,id:vs,handler:async(s,t)=>{var W,V,$;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(g.SheetInterceptorService),u=s.get(i.ErrorService),l=s.get(i.LocaleService);if(r.isOverlapping())return u.emit(l.t("sheets.info.overlappingSelections")),!1;const d=P(o);if(!d)return!1;const{workbook:c,worksheet:m,unitId:h,subUnitId:R}=d;let C=t==null?void 0:t.range;if(C||(C=(W=r.getCurrentLastSelection())==null?void 0:W.range),!C)return!1;const S=[],I=[],v=m.getCellMatrix(),M=v.getDataRange(),w=v.getSlice(C.startRow,C.endRow,M.startColumn,M.endColumn).getDataRange().endColumn,y=Math.max(w+(C.endColumn-C.startColumn+1)-M.endColumn,0);if(y>0){const L=C.startColumn-1,Y=m.getColumnWidth(L),z={unitId:h,subUnitId:R,range:{startRow:M.startRow+1,endRow:M.endRow,startColumn:M.endColumn+1,endColumn:M.endColumn+y},colInfo:new Array(y).fill(void 0).map(()=>({w:Y,hd:i.BooleanNumber.FALSE}))};S.push({id:ie.id,params:z});const K=Nt(s,z);I.push({id:ne.id,params:K})}const b={};i.Range.foreach(C,(L,Y)=>{const z=m.getCell(L,Y);!z||!z.s||(b[L]||(b[L]={}),b[L][Y]={s:z.s})});const T={range:C,subUnitId:R,unitId:h,shiftDimension:i.Dimension.COLUMNS,cellValue:b},{redo:U,undo:k}=fs(s,T);S.push(...U),I.push(...k);const E=a.onCommandExecute({id:vt.id,params:{range:C}});if(S.push(...E.redos),S.push(Ue(C,c,m)),I.push(...(V=E.preUndos)!=null?V:[]),S.unshift(...($=E.preRedos)!=null?$:[]),I.unshift(...E.undos),i.sequenceExecute(S,e).result){const L=a.afterCommandExecute({id:vt.id,params:{range:C}});return i.sequenceExecute(L.redos,e),I.push(...L.undos),S.push(...L.redos),n.pushUndoRedo({unitID:h,undoMutations:I.reverse(),redoMutations:S}),!0}return!1}},Jo="sheet.command.insert-row",Me={type:i.CommandType.COMMAND,id:Jo,handler:async(s,t)=>{const e=s.get(i.ICommandService),n=s.get(g.SheetInterceptorService),{range:o,direction:r,unitId:a,subUnitId:u,cellValue:l}=t;return await n.beforeCommandExecute({id:Me.id,params:t})?e.syncExecuteCommand(ps.id,{range:o,direction:r,unitId:a,subUnitId:u,cellValue:l}):!1}},ps={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-by-range",handler:(s,t)=>{var U,k,E,N;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),a=P(o,t);if(!a)return!1;const{workbook:u,worksheet:l}=a,{range:d,direction:c,unitId:m,subUnitId:h,cellValue:R}=t,{startRow:C,endRow:S}=d;d.rangeType=i.RANGE_TYPE.ROW;const I=c===i.Direction.UP?C:C-1,v=l.getRowHeight(I),M={unitId:m,subUnitId:h,range:d,rowInfo:new Array(S-C+1).fill(void 0).map(()=>({h:v,hd:i.BooleanNumber.FALSE}))},p=en(s,M),w=[{id:re.id,params:M}],y=[{id:ae.id,params:p}];R&&Object.keys(R).length>0&&w.push({id:F.id,params:{unitId:m,subUnitId:h,cellValue:R}});const b=r.onCommandExecute({id:Me.id,params:t});if(w.unshift(...(U=b.preRedos)!=null?U:[]),w.push(...(k=b.redos)!=null?k:[]),w.push(Ue(d,u,l)),y.unshift(...(E=b.preUndos)!=null?E:[]),y.push(...(N=b.undos)!=null?N:[]),i.sequenceExecute(w,e).result){const W=r.afterCommandExecute({id:Me.id,params:t});return i.sequenceExecute(W.redos,e),w.push(...W.redos),y.push(...W.undos),n.pushUndoRedo({unitID:t.unitId,undoMutations:y,redoMutations:w}),!0}return!1}},xo={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-before",handler:async(s,t)=>{var I;const n=(I=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:I.map(v=>v.range);let o;if((n==null?void 0:n.length)===1)o=n[0];else return!1;const r=s.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:u,subUnitId:l,unitId:d}=a,c=t.value||0,m=o.startRow,h=o.startRow+c-1,R=0,C=u.getColumnCount()-1,S={unitId:d,subUnitId:l,direction:i.Direction.UP,range:{startRow:m,endRow:h,startColumn:R,endColumn:C},cellValue:$e(u,m,h,R,C,!0,m-1)};return s.get(i.ICommandService).executeCommand(Me.id,S)}},Xo={type:i.CommandType.COMMAND,id:"sheet.command.insert-row-after",handler:async s=>{var S;const e=(S=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:S.map(I=>I.range);let n;if((e==null?void 0:e.length)===1)n=e[0];else return!1;const o=s.get(i.IUniverInstanceService),r=P(o);if(!r)return!1;const{worksheet:a,unitId:u,subUnitId:l}=r,d=n.endRow-n.startRow+1,c=n.endRow+1,m=n.endRow+d,h=0,R=a.getColumnCount()-1,C={unitId:u,subUnitId:l,direction:i.Direction.DOWN,range:{startRow:c,endRow:m,startColumn:h,endColumn:R,rangeType:i.RANGE_TYPE.ROW},cellValue:$e(a,c,m,h,R,!0,n.endRow)};return s.get(i.ICommandService).executeCommand(Me.id,C)}},Zo={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-above",handler:async(s,t)=>{var v;const n=(v=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:v.map(M=>M.range);let o;if((n==null?void 0:n.length)===1)o=n[0];else return!1;const r=s.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:u,unitId:l,subUnitId:d}=a,c=t.value||0,m=o.startRow,h=o.startRow+c-1,R=0,C=u.getColumnCount()-1,S=$e(u,m,h,R,C,!0,m-1),I={unitId:l,subUnitId:d,direction:i.Direction.UP,range:{startRow:m,endRow:h,startColumn:R,endColumn:C,rangeType:i.RANGE_TYPE.ROW},cellValue:S};return s.get(i.ICommandService).executeCommand(Me.id,I)}},Qo={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-rows-after",handler:async(s,t)=>{var I;const n=(I=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:I.map(v=>v.range);let o;if((n==null?void 0:n.length)===1)o=n[0];else return!1;const r=s.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:u,unitId:l,subUnitId:d}=a,c=t.value||0,m=o.endRow+1,h=o.endRow+c,R=0,C=u.getColumnCount()-1,S={unitId:l,subUnitId:d,direction:i.Direction.DOWN,range:{startRow:m,endRow:h,startColumn:R,endColumn:C,rangeType:i.RANGE_TYPE.ROW},cellValue:$e(u,m,h,R,C,!0,o.endRow)};return s.get(i.ICommandService).executeCommand(Me.id,S)}},er="sheet.command.insert-col",ye={type:i.CommandType.COMMAND,id:er,handler:async(s,t)=>{const e=s.get(i.ICommandService),n=s.get(g.SheetInterceptorService),{range:o,direction:r,subUnitId:a,unitId:u,cellValue:l}=t;return await n.beforeCommandExecute({id:ye.id,params:t})?e.syncExecuteCommand(ws.id,{range:o,direction:r,unitId:u,subUnitId:a,cellValue:l}):!1}},ws={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-by-range",handler:(s,t)=>{var T,U,k,E;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),{range:a,direction:u,subUnitId:l,unitId:d,cellValue:c}=t,{startColumn:m,endColumn:h}=t.range;a.rangeType=i.RANGE_TYPE.COLUMN;const R=o.getUniverSheetInstance(t.unitId),C=R.getSheetBySheetId(t.subUnitId),S=u===i.Direction.LEFT?m:m-1,I=C.getColumnWidth(S),v={unitId:d,subUnitId:l,range:a,colInfo:new Array(h-m+1).fill(void 0).map(()=>({w:I,hd:i.BooleanNumber.FALSE}))},M=Nt(s,v),p=[{id:ie.id,params:v}],w=[{id:ne.id,params:M}];c&&p.push({id:F.id,params:{unitId:d,subUnitId:l,cellValue:c}});const y=r.onCommandExecute({id:ye.id,params:t});if(p.unshift(...(T=y.preRedos)!=null?T:[]),p.push(...(U=y.redos)!=null?U:[]),p.push(Ue(a,R,C)),w.unshift(...(k=y.preUndos)!=null?k:[]),w.push(...(E=y.undos)!=null?E:[]),i.sequenceExecute(p,e).result){const N=r.afterCommandExecute({id:ye.id,params:t});return i.sequenceExecute(N.redos,e),p.push(...N.redos),w.push(...N.undos),n.pushUndoRedo({unitID:t.unitId,undoMutations:w.filter(Boolean),redoMutations:p.filter(Boolean)}),!0}return!1}},tr={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-before",handler:async(s,t)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections();let o;if((n==null?void 0:n.length)===1)o=n[0].range;else return!1;const r=s.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:u,unitId:l,subUnitId:d}=a,c=t.value||0,m=o.startColumn,h=o.startColumn+c-1,R=0,C=u.getRowCount()-1,S={unitId:l,subUnitId:d,direction:i.Direction.LEFT,range:{startColumn:m,endColumn:h,startRow:R,endRow:C,rangeType:i.RANGE_TYPE.COLUMN},cellValue:$e(u,R,C,m,h,!1,m-1)};return s.get(i.ICommandService).executeCommand(ye.id,S)}},nr={type:i.CommandType.COMMAND,id:"sheet.command.insert-col-after",handler:async s=>{const e=s.get(g.SheetsSelectionsService).getCurrentSelections();let n;if((e==null?void 0:e.length)===1)n=e[0].range;else return!1;const o=s.get(i.IUniverInstanceService),r=P(o);if(!r)return!1;const{worksheet:a,unitId:u,subUnitId:l}=r,d=n.endColumn-n.startColumn+1,c=n.endColumn+1,m=n.endColumn+d,h=0,R=a.getRowCount()-1,C={unitId:u,subUnitId:l,direction:i.Direction.RIGHT,range:{startColumn:c,endColumn:m,startRow:h,endRow:R},cellValue:$e(a,h,R,c,m,!1,n.endColumn)};return s.get(i.ICommandService).executeCommand(ye.id,C)}},sr={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-before",handler:async(s,t)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections();let o;if((n==null?void 0:n.length)===1)o=n[0].range;else return!1;const r=s.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:u,unitId:l,subUnitId:d}=a,c=t.value||0,m=o.startColumn,h=o.startColumn+c-1,R=0,C=u.getRowCount()-1,S={unitId:l,subUnitId:d,direction:i.Direction.LEFT,range:{startColumn:m,endColumn:h,startRow:R,endRow:C,rangeType:i.RANGE_TYPE.COLUMN},cellValue:$e(u,R,C,m,h,!1,m-1)};return s.get(i.ICommandService).executeCommand(ye.id,S)}},or={type:i.CommandType.COMMAND,id:"sheet.command.insert-multi-cols-right",handler:async(s,t)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections();let o;if((n==null?void 0:n.length)===1)o=n[0].range;else return!1;const r=s.get(i.IUniverInstanceService),a=P(r);if(!a)return!1;const{worksheet:u,unitId:l,subUnitId:d}=a,c=t.value||0,m=o.endColumn+1,h=o.endColumn+c,R=0,C=u.getRowCount()-1,S={unitId:l,subUnitId:d,direction:i.Direction.RIGHT,range:{startColumn:m,endColumn:h,startRow:R,endRow:C},cellValue:$e(u,R,C,m,h,!1,o.endColumn)};return s.get(i.ICommandService).executeCommand(ye.id,S)}},hn="sheet.command.remove-row",Ms={type:i.CommandType.COMMAND,id:"sheet.command.remove-row-by-range",handler:(s,t)=>{var I,v,M;if(!t)return!1;const e=s.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{workbook:o,worksheet:r}=n,a=s.get(g.SheetInterceptorService),{range:u,unitId:l,subUnitId:d}=t,c=Dt([u],s,l,d).reverse(),m=[],h=[];c.forEach(p=>{const w=[],y=[],b={unitId:l,subUnitId:d,range:p},T=la(b,r),U=r.getCellMatrix().getSlice(p.startRow,p.endRow,0,r.getColumnCount()-1),k={unitId:l,subUnitId:d,cellValue:U.getMatrix()};y.push({id:ae.id,params:b}),w.push({id:re.id,params:T}),w.push({id:F.id,params:k}),h.push(...y),m.unshift(...w)});const R=a.onCommandExecute({id:hn,params:{range:u}}),C=s.get(i.ICommandService);if(i.sequenceExecute([...(I=R.preRedos)!=null?I:[],...h,...R.redos,Ue(u,o,r)],C).result){const p=a.afterCommandExecute({id:hn,params:{range:u}});return i.sequenceExecute(p.redos,C),s.get(i.IUndoRedoService).pushUndoRedo({unitID:l,undoMutations:[...(v=R.preUndos)!=null?v:[],...m,...R.undos,...p.undos],redoMutations:[...(M=R.preRedos)!=null?M:[],...h,...R.redos,...p.redos]}),!0}return!1}},$t={type:i.CommandType.COMMAND,id:hn,handler:async(s,t)=>{var h;const e=s.get(g.SheetsSelectionsService),n=s.get(g.SheetInterceptorService),o=s.get(i.ICommandService);let r=t==null?void 0:t.range;if(r||(r=(h=e.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=s.get(i.IUniverInstanceService),u=P(a);if(!u)return!1;const{worksheet:l,subUnitId:d,unitId:c}=u;return r={...r,startColumn:0,endColumn:Math.max(l.getMaxColumns()-1,0)},await n.beforeCommandExecute({id:$t.id,params:{range:r}})?o.syncExecuteCommand(Ms.id,{range:r,unitId:c,subUnitId:d}):!1}},gn="sheet.command.remove-col",ys={type:i.CommandType.COMMAND,id:"sheet.command.remove-col-by-range",handler:(s,t)=>{var v,M,p;if(!t)return!1;const e=s.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{workbook:o,worksheet:r}=n,a=s.get(g.SheetInterceptorService),{range:u,unitId:l,subUnitId:d}=t,c={unitId:l,subUnitId:d,range:u},m=da(s,c),h=r.getCellMatrix().getSlice(0,r.getRowCount()-1,u.startColumn,u.endColumn),R={unitId:l,subUnitId:d,cellValue:h.getMatrix()},C=a.onCommandExecute({id:gn,params:{range:u}}),S=s.get(i.ICommandService);if(i.sequenceExecute([...(v=C.preRedos)!=null?v:[],{id:ne.id,params:c},...C.redos,Ue(u,o,r)],S).result){const w=a.afterCommandExecute({id:gn,params:{range:u}});return i.sequenceExecute(w.redos,S),s.get(i.IUndoRedoService).pushUndoRedo({unitID:l,undoMutations:[...(M=C.preUndos)!=null?M:[],{id:ie.id,params:m},{id:F.id,params:R},...C.undos,...w.undos],redoMutations:[...(p=C.preRedos)!=null?p:[],{id:ne.id,params:c},...C.redos,...w.redos]}),!0}return!1}},Lt={type:i.CommandType.COMMAND,id:gn,handler:async(s,t)=>{var h;const e=s.get(g.SheetsSelectionsService),n=s.get(g.SheetInterceptorService),o=s.get(i.ICommandService);let r=t==null?void 0:t.range;if(r||(r=(h=e.getCurrentLastSelection())==null?void 0:h.range),!r)return!1;const a=s.get(i.IUniverInstanceService),u=P(a);if(!u)return!1;const{worksheet:l,subUnitId:d,unitId:c}=u;return r={...r,startRow:0,endRow:Math.max(l.getMaxRows()-1,0)},await n.beforeCommandExecute({id:Lt.id,params:{range:r}})?o.syncExecuteCommand(ys.id,{range:r,unitId:c,subUnitId:d}):!1}},rr=(s,t)=>{const e=s.get(i.IUniverInstanceService),{subUnitId:n,unitId:o}=t,r=ve(e,t);if(!r)throw new Error("[RemoveSheetUndoMutationFactory]: Worksheet is null error!");const{workbook:a,worksheet:u}=r,l=u.getConfig();return{index:a.getConfig().sheetOrder.findIndex(m=>m===n),sheet:l,unitId:o}},Ze={id:"sheet.mutation.remove-sheet",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService),{subUnitId:n,unitId:o}=t,r=e.getUniverSheetInstance(o);return r?r.removeSheet(n):!1}};function fu(s,t){return t.getMergeData().some(e=>e.startRow<s&&s<=e.endRow)}function Iu(s,t){return t.getMergeData().some(e=>e.startColumn<s&&s<=e.endColumn)}const ir="sheet.command.move-rows",pt={id:ir,type:i.CommandType.COMMAND,handler:(s,t)=>{var W,V;const e=s.get(g.SheetsSelectionsService),{fromRange:{startRow:n},toRange:{startRow:o},range:r}=t,a=r?[ur(r)]:e.getCurrentSelections(),u=a==null?void 0:a.filter($=>$.range.rangeType===i.RANGE_TYPE.ROW&&$.range.startRow<=n&&n<=$.range.endRow);if((u==null?void 0:u.length)!==1)return!1;const l=s.get(g.SheetInterceptorService),d=s.get(i.IUniverInstanceService),c=P(d,t);if(!c)return!1;const{workbook:m,worksheet:h}=c,R=m.getUnitId(),C=h.getSheetId(),S=s.get(i.ErrorService),I=s.get(i.LocaleService),v=u[0].range,M=u[0].primary,p=At(v,h,!1);if(!i.Rectangle.equals(v,p))return S.emit(I.t("sheets.info.partOfCell")),!1;if(fu(o,h))return S.emit(I.t("sheets.info.acrossMergedCell")),!1;const w={...v,startRow:o,endRow:o+v.endRow-v.startRow},y={unitId:R,subUnitId:C,sourceRange:v,targetRange:w},b=uo(s,y),T=s.get(i.ICommandService),U=l.onCommandExecute({id:pt.id,params:t}),k=[...(W=U.preRedos)!=null?W:[],{id:pe.id,params:y}],E=[...(V=U.preUndos)!=null?V:[],{id:pe.id,params:b}];if(M){const L=o-n<0,Y=v.endRow-v.startRow+1,z=L?w:{...w,startRow:w.startRow-Y,endRow:w.endRow-Y},K={unitId:R,subUnitId:C,type:te.MOVE_END,selections:[{range:z,primary:se(z,h),style:null}]},oe={unitId:R,subUnitId:C,type:te.MOVE_END,selections:[{range:v,primary:M,style:null}]};k.push({id:q.id,params:K}),E.push({id:q.id,params:oe})}if(k.push(...U.redos),E.push(...U.undos),i.sequenceExecute(k,T).result){const $=l.afterCommandExecute({id:pt.id,params:t});return i.sequenceExecute($.redos,T),k.push(...$.redos),E.push(...$.undos),s.get(i.IUndoRedoService).pushUndoRedo({unitID:R,undoMutations:E,redoMutations:k}),!0}return!1}},ar="sheet.command.move-cols",wt={id:ar,type:i.CommandType.COMMAND,handler:(s,t)=>{var W,V;const e=s.get(g.SheetsSelectionsService),{fromRange:{startColumn:n},toRange:{startColumn:o},range:r}=t,a=r?[ur(r)]:e.getCurrentSelections(),u=a==null?void 0:a.filter($=>$.range.rangeType===i.RANGE_TYPE.COLUMN&&$.range.startColumn<=n&&n<=$.range.endColumn);if((u==null?void 0:u.length)!==1)return!1;const l=s.get(g.SheetInterceptorService),d=s.get(i.IUniverInstanceService),c=P(d,t);if(!c)return!1;const{workbook:m,worksheet:h}=c,R=m.getUnitId(),C=h.getSheetId(),S=s.get(i.ErrorService),I=s.get(i.LocaleService),v=u[0].range,M=u[0].primary,p=At(v,h,!1);if(!i.Rectangle.equals(v,p))return S.emit(I.t("sheets.info.partOfCell")),!1;if(Iu(o,h))return S.emit(I.t("sheets.info.acrossMergedCell")),!1;const w={...v,startColumn:o,endColumn:o+v.endColumn-v.startColumn},y={unitId:R,subUnitId:C,sourceRange:v,targetRange:w},b=lo(s,y),T=s.get(i.ICommandService),U=l.onCommandExecute({id:wt.id,params:t}),k=[...(W=U.preRedos)!=null?W:[],{id:we.id,params:y}],E=[...(V=U.preUndos)!=null?V:[],{id:we.id,params:b}];if(M){const $=v.endColumn-v.startColumn+1,z=o-n<0?w:{...w,startColumn:w.startColumn-$,endColumn:w.endColumn-$},K={unitId:R,subUnitId:C,type:te.MOVE_END,selections:[{range:z,primary:se(z,h),style:null}]},oe={unitId:R,subUnitId:C,type:te.MOVE_END,selections:[{range:v,primary:M,style:null}]};k.push({id:q.id,params:K}),E.push({id:q.id,params:oe})}if(k.push(...U.redos),E.push(...U.undos),i.sequenceExecute(k,T).result){const $=l.afterCommandExecute({id:wt.id,params:t});return i.sequenceExecute($.redos,T),k.push(...$.redos),E.push(...$.undos),s.get(i.IUndoRedoService).pushUndoRedo({unitID:R,undoMutations:E,redoMutations:k}),!0}return!1}};function ur(s){return{range:s,primary:null,style:null}}var vu=Object.getOwnPropertyDescriptor,pu=(s,t,e,n)=>{for(var o=n>1?void 0:n?vu(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},wu=(s,t)=>(e,n)=>t(e,n,s);g.SheetSkeletonService=class extends i.Disposable{constructor(e){super();f(this,"_sheetSkeletonStore",new Map);this._injector=e,this.disposeWithMe(()=>{this._sheetSkeletonStore=new Map})}getSkeleton(e,n){if(this._sheetSkeletonStore.has(e))return this._sheetSkeletonStore.get(e).get(n)}setSkeleton(e,n,o){this._sheetSkeletonStore.has(e)||this._sheetSkeletonStore.set(e,new Map),this._sheetSkeletonStore.get(e).set(n,o)}deleteSkeleton(e,n){this._sheetSkeletonStore.has(e)&&this._sheetSkeletonStore.get(e).delete(n)}},g.SheetSkeletonService=pu([wu(0,i.Inject(i.Injector))],g.SheetSkeletonService);function _s(s,t){const e=new i.ObjectMatrix;return s.map(n=>i.Range.transformRange(n,t)).forEach(n=>{i.Range.foreach(n,(o,r)=>{const a=t.getCellHeight(o,r);a&&e.setValue(o,r,a)})}),e}const Mu=1e4;function Bt(s,t){if(!t)return{suitableRanges:s,remainingRanges:[]};const e=t.worksheet.getColumnCount(),n=Math.ceil(Mu/e),o=[],r=[],a=t.getOffsetRelativeToRowCol(0,t.scrollY).row,u=s.map(d=>{let c;return a>=d.startRow&&a<=d.endRow?c=0:a<d.startRow?c=d.startRow-a:c=a-d.endRow,{range:d,distance:c,rowCount:d.endRow-d.startRow+1}});u.sort((d,c)=>d.distance!==c.distance?d.distance-c.distance:d.rowCount-c.rowCount);let l=0;for(const d of u)if(l+d.rowCount<=n)o.push(d.range),l+=d.rowCount;else{const c=n-l;if(c>0){const m={...d.range,endRow:d.range.startRow+c-1},h={...d.range,startRow:d.range.startRow+c};o.push(m),r.push(h),l=n}else r.push(d.range)}return{suitableRanges:o,remainingRanges:r}}const lr="sheet.command.reorder-range",Rn={id:lr,type:i.CommandType.COMMAND,handler:(s,t)=>{var p,w;const{subUnitId:e,unitId:n,range:o,order:r}=t,a=s.get(i.ICommandService),u={id:Ot.id,params:{unitId:n,subUnitId:e,order:r,range:o}},l={id:Ot.id,params:co(u.params)},d=s.get(g.SheetInterceptorService),c=d.onCommandExecute({id:Rn.id,params:t}),m=[...(p=c.preRedos)!=null?p:[],u,...c.redos],h=[...(w=c.preUndos)!=null?w:[],l,...c.undos],R=i.sequenceExecute(m,a),{suitableRanges:C,remainingRanges:S}=Bt([o],s.get(g.SheetSkeletonService).getSkeleton(n,e)),{undos:I,redos:v}=d.generateMutationsOfAutoHeight({unitId:n,subUnitId:e,ranges:[o],autoHeightRanges:C,lazyAutoHeightRanges:S}),M=d.afterCommandExecute({id:Rn.id,params:t});return R.result?(i.sequenceExecute([...M.redos,...v],a),s.get(i.IUndoRedoService).pushUndoRedo({unitID:n,undoMutations:[...h,...M.undos,...I],redoMutations:[...m,...M.redos,...v]}),!0):!1}},A={MoveRangeCommandId:Bo,InsertRowCommandId:Jo,InsertColCommandId:er,RemoveColCommandId:gn,RemoveRowCommandId:hn,DeleteRangeMoveLeftCommandId:Yo,DeleteRangeMoveUpCommandId:Ko,InsertRangeMoveDownCommandId:Su,InsertRangeMoveRightCommandId:vs,MoveColsCommandId:ar,MoveRowsCommandId:ir,ReorderRangeCommandId:lr};var B=(s=>(s[s.Set=0]="Set",s[s.Delete=1]="Delete",s[s.HorizontalMove=2]="HorizontalMove",s[s.VerticalMove=3]="VerticalMove",s[s.Unknown=4]="Unknown",s))(B||{});const Cn=Number.MAX_SAFE_INTEGER,Pe=s=>{const t={...s},e=Number.isNaN(t.startRow)&&Number.isNaN(t.endRow)&&!Number.isNaN(t.startColumn)&&!Number.isNaN(t.endColumn),n=Number.isNaN(t.startColumn)&&Number.isNaN(t.endColumn)&&!Number.isNaN(t.startRow)&&!Number.isNaN(t.endRow);return(t.rangeType===i.RANGE_TYPE.COLUMN||e)&&(t.startRow=0,t.endRow=Cn),(t.rangeType===i.RANGE_TYPE.ROW||n)&&(t.startColumn=0,t.endColumn=Cn),t.rangeType===i.RANGE_TYPE.ALL&&(t.startColumn=0,t.endColumn=Cn,t.startRow=0,t.endRow=Cn),t},he=s=>{let t=s.rangeType;return s.rangeType===i.RANGE_TYPE.COLUMN?t=i.RANGE_TYPE.ROW:s.rangeType===i.RANGE_TYPE.ROW&&(t=i.RANGE_TYPE.COLUMN),{startRow:s.startColumn,endRow:s.endColumn,startColumn:s.startRow,endColumn:s.endRow,rangeType:t}},Ht=(s,t,e)=>{const n={...e},o={...t},r=(S,I)=>{const v=Math.max(S.start,I.start),M=Math.min(S.end,I.end);return M<v?null:{start:v,end:M}},a=S=>S.end-S.start+1,u=(S,I)=>({start:S.start-I.start,end:S.start-I.start+S.end-S.start}),l=(S,I)=>({start:I.start+S.start,end:I.start+S.start+S.end-S.start}),d=t.start>s.start;if(d){const S=Math.min(s.end,t.start)-s.start+1;o.start-=S,o.end-=S}const c=a(s),m=c,h=r(s,n),R=h&&a(h)>=a(n);if(s.end<n.start)n.start-=c,n.end-=c;else if(h){const S=a(h);if(R){const I=u(n,s),v=l(I,o);n.start=v.start,n.end=v.end}else h.start>s.start?d?(n.end-=S+c,n.start-=c):n.end-=S:d?n.end-=S:n.start>s.start&&n.end>s.end?(n.start-=c,n.end-=c+S):n.end-=S}const C=r(o,n);return R||(o.start<=n.start?(n.start+=m,n.end+=m):C&&(d?o.end<=n.start||o.start<=n.start&&o.end>=n.start?(n.start+=m,n.end+=m):o.start>=n.start&&o.start<=n.end&&(n.end+=m):n.start<o.start&&n.end>o.start?n.end+=m:(n.start>=o.end||n.start>=o.start&&n.start<=o.end)&&(n.end+=m,n.start+=m))),{step:n.start-e.start,length:a(n)-a(e)}},bs=(s,t)=>{const{fromRange:e,toRange:n}=s.params||{};if(!n||!e)return[];const o=Pe(e),r=Pe(n),a=Pe(t),u=Ht({start:o.startRow,end:o.endRow},{start:r.startRow,end:r.endRow},{start:a.startRow,end:a.endRow});return u===null?[{type:B.Delete}]:[{type:B.VerticalMove,step:u.step||0,length:u.length||0}]},yu=(s,t)=>{const{fromRange:e,toRange:n}=s.params||{};if(!e||!n)return[t];const o=e.startRow,r=e.endRow-e.startRow+1,a=n.startRow,u=new i.ObjectMatrix;return i.Range.foreach(t,(d,c)=>{u.setValue(d,c,1)}),u.moveRows(o,r,a),i.queryObjectMatrix(u,d=>d===1)},_u=(s,t)=>{const{range:e,order:n}=s.params||{};if(!e||!n)return[t];const o=new i.ObjectMatrix;i.Range.foreach(t,(u,l)=>{o.setValue(u,l,1)});const r=new i.ObjectMatrix;return i.Range.foreach(e,(u,l)=>{var d;if(Object.prototype.hasOwnProperty.call(n,u)){const c=n[u],m=(d=o.getValue(c,l))!=null?d:0;r.setValue(u,l,m)}}),r.forValue((u,l,d)=>{o.setValue(u,l,d)}),i.queryObjectMatrix(o,u=>u===1)},Es=(s,t)=>{const{fromRange:e,toRange:n}=s.params||{};if(!n||!e)return[];const o=Pe(e),r=Pe(n),a=Pe(t),u=Ht({start:o.startColumn,end:o.endColumn},{start:r.startColumn,end:r.endColumn},{start:a.startColumn,end:a.endColumn});return u===null?[{type:B.Delete}]:[{type:B.HorizontalMove,step:u.step||0,length:u.length||0}]},bu=(s,t)=>{const{fromRange:e,toRange:n}=s.params||{};if(!e||!n)return[t];const o=e.startColumn,r=e.endColumn-e.startColumn+1,a=n.startColumn,u=new i.ObjectMatrix;return i.Range.foreach(t,(l,d)=>{u.setValue(l,d,1)}),u.moveColumns(o,r,a),i.queryObjectMatrix(u,l=>l===1)},dr=(s,t)=>{var r,a;const e=(r=s.params)==null?void 0:r.toRange,n=(a=s.params)==null?void 0:a.fromRange;if(!e||!n)return[];const o=[];if(i.Rectangle.contains(e,t)&&o.push({type:B.Delete}),i.Rectangle.contains(n,t)){o.push({type:B.Delete});const u=i.Rectangle.getRelativeRange(t,n),l=i.Rectangle.getPositionRange(u,e);return[{type:B.Set,range:l}]}return o},Eu=(s,t)=>{var m,h;const e=(m=s.params)==null?void 0:m.toRange,n=(h=s.params)==null?void 0:h.fromRange;if(!e||!n)return[t];if(!i.Rectangle.intersects(n,t)&&!i.Rectangle.intersects(e,t))return[t];if(i.Rectangle.contains(n,t)){const R=i.Rectangle.getRelativeRange(t,n);return[i.Rectangle.getPositionRange(R,e)]}const o=new i.ObjectMatrix;i.Range.foreach(t,(R,C)=>{o.setValue(R,C,1)});const r=new i.ObjectMatrix,a=i.Rectangle.getIntersects(n,t);a&&i.Range.foreach(a,(R,C)=>{o.getValue(R,C)&&(o.setValue(R,C,void 0),r.setValue(R,C,1))});const u=e.startColumn-n.startColumn,l=e.startRow-n.startRow,d={startColumn:e.startColumn-u,endColumn:e.endColumn-u,startRow:e.startRow-l,endRow:e.endRow-l};return d&&i.Range.foreach(d,(R,C)=>{var v;const S=R+l,I=C+u;o.setValue(S,I,(v=r.getValue(R,C))!=null?v:0)}),i.queryObjectMatrix(o,R=>R===1)},Qe=(s,t)=>{const e=Pe(s),n=Pe(t),o=a=>a.endColumn-a.startColumn+1,r=a=>a.endRow-a.startRow+1;if(e.startRow<=n.startRow&&e.endRow>=n.endRow){if(n.startColumn<e.startColumn&&n.endColumn>=e.startColumn&&n.endColumn<=e.endColumn||n.startColumn<e.startColumn&&n.endColumn>=e.endColumn){const a=i.Rectangle.getIntersects(n,e);if(a)return{step:0,length:-o(a)}}if(n.startColumn>=e.startColumn&&n.endColumn<=e.endColumn&&r(e)>=r(n))return null;if(n.startColumn>=e.startColumn&&n.startColumn<=e.endColumn&&n.endColumn>e.endColumn){const a=i.Rectangle.getIntersects(n,e);if(a){const u=-o(a);return{step:-(o(e)-o(a)),length:u}}}if(n.startColumn>e.endColumn)return{step:-o(e),length:0}}return{step:0,length:0}},Ts=(s,t)=>{var r;const e=(r=s.params)==null?void 0:r.range;if(!e)return[];const n=[],o=Qe(e,t);if(!o)n.push({type:B.Delete});else{const{step:a,length:u}=o;n.push({type:B.HorizontalMove,step:a,length:u})}return n},cr=(s,t,e)=>{var a;const n=(a=s.params)==null?void 0:a.range;if(!n)return[];const o=[];if(e&&e.length>0){let u=n.startRow;for(let l=n.startRow;l<=n.endRow;l++){if(e.includes(l)){if(l===u){u=l+1;continue}r({...n,startRow:u,endRow:l-1}),u=l+1;continue}l===n.endRow&&r({...n,startRow:u,endRow:n.endRow})}}else r(n);function r(u){const l=Qe(he(u),he(t));if(!l)o.push({type:B.Delete});else{const{step:d,length:c}=l;o.push({type:B.VerticalMove,step:d,length:c})}}return o},Tu=(s,t)=>{const{range:e,order:n}=s.params||{};if(!e||!n)return[];if(i.Rectangle.contains(e,t)&&t.endRow===t.startRow){const o=[],r=t.startRow;for(const a in n)if(n[a]===r){const u=Number(a);return o.push({type:B.VerticalMove,step:u-r,length:0}),o}return[]}return[]},et=(s,t)=>{const e=Pe(s),n=Pe(t),o=r=>r.endColumn-r.startColumn+1;return e.startRow<=n.startRow&&e.endRow>=n.endRow?n.startColumn<e.startColumn&&n.endColumn>=e.startColumn&&n.endColumn<=e.endColumn||n.startColumn<e.startColumn&&n.endColumn>=e.endColumn?{step:0,length:o(e)}:n.startColumn>=e.startColumn&&n.endColumn<=e.endColumn||n.startColumn>=e.startColumn&&n.startColumn<=e.endColumn&&n.endColumn>e.endColumn||n.startColumn>=e.endColumn?{step:o(e),length:0}:{step:0,length:0}:{step:0,length:0}};function Uu(s,t,e){const n=[];if(i.Rectangle.contains(t,e)&&n.push({type:B.Delete}),i.Rectangle.contains(s,e)){n.push({type:B.Delete});const o=i.Rectangle.getRelativeRange(e,s),r=i.Rectangle.getPositionRange(o,t);return[{type:B.Set,range:r}]}return n}const mr=(s,t)=>{var u;const e=(u=s.params)==null?void 0:u.range;if(!e)return[];const n=[],o=et(he(e),he(t)),{step:r,length:a}=o;return n.push({type:B.VerticalMove,step:r,length:a}),n},hr=(s,t)=>{var u;const e=(u=s.params)==null?void 0:u.range;if(!e)return[];const n=[],o=et(e,t),{step:r,length:a}=o;return n.push({type:B.HorizontalMove,step:r,length:a}),n},gr=(s,t)=>{var u;const e=(u=s.params)==null?void 0:u.range;if(!e)return[];const n=[],o=et(he(e),he(t)),{step:r,length:a}=o;return n.push({type:B.VerticalMove,step:r,length:a}),n},Pu=(s,t)=>{var l;const e=(l=s.params)==null?void 0:l.range;if(!e)return[t];const n=e.endRow-e.startRow+1,o={...e,startRow:e.startRow,endRow:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(t,o),a=i.Rectangle.getIntersects(o,t);if(!a)return[t];const u=new i.ObjectMatrix;return r.forEach(d=>{i.Range.foreach(d,(c,m)=>{u.setValue(c,m,1)})}),a&&i.Range.foreach(a,(d,c)=>{u.setValue(d+n,c,1)}),i.queryObjectMatrix(u,d=>d===1)},Rr=(s,t)=>{var u;const e=(u=s.params)==null?void 0:u.range;if(!e)return[];const n=[],o=et(e,t),{step:r,length:a}=o;return n.push({type:B.HorizontalMove,step:r,length:a}),n},ku=(s,t)=>{var l;const e=(l=s.params)==null?void 0:l.range;if(!e)return[t];const n=e.endColumn-e.startColumn+1,o={...e,startColumn:e.startColumn,endColumn:Number.POSITIVE_INFINITY},r=i.Rectangle.subtract(t,o),a=i.Rectangle.getIntersects(o,t);if(!a)return[t];const u=new i.ObjectMatrix;return r.forEach(d=>{i.Range.foreach(d,(c,m)=>{u.setValue(c,m,1)})}),a&&i.Range.foreach(a,(d,c)=>{u.setValue(d,c+n,1)}),i.queryObjectMatrix(u,d=>d===1)},Cr=(s,t)=>{var r;const e=(r=s.params)==null?void 0:r.range;if(!e)return[];const n=[],o=Qe(e,t);if(!o)n.push({type:B.Delete});else{const{step:a,length:u}=o;n.push({type:B.HorizontalMove,step:a,length:u})}return n},Nu=(s,t)=>{var d;const e=(d=s.params)==null?void 0:d.range;if(!e)return[t];const n={startRow:e.startRow,endRow:e.endRow,startColumn:e.startColumn,endColumn:Number.POSITIVE_INFINITY},o=e.endColumn-e.startColumn+1,r=i.Rectangle.getIntersects(e,t),a=i.Rectangle.subtract(t,n),u=i.Rectangle.getIntersects(n,t);if(!r&&!u)return[t];const l=new i.ObjectMatrix;return u&&i.Range.foreach(u,(c,m)=>{l.setValue(c,m-o,1)}),r&&i.Range.foreach(r,(c,m)=>{l.setValue(c,m-o,0)}),a.forEach(c=>{i.Range.foreach(c,(m,h)=>{l.setValue(m,h,1)})}),i.queryObjectMatrix(l,c=>c===1)},Sr=(s,t)=>{var r;const e=(r=s.params)==null?void 0:r.range;if(!e)return[];const n=[],o=Qe(he(e),he(t));if(!o)n.push({type:B.Delete});else{const{step:a,length:u}=o;n.push({type:B.VerticalMove,step:a,length:u})}return n},Ou=(s,t)=>{var d;const e=(d=s.params)==null?void 0:d.range;if(!e)return[t];const n={...e,startRow:e.startRow,endRow:Number.POSITIVE_INFINITY},o=e.endRow-e.startRow+1,r=i.Rectangle.getIntersects(e,t),a=i.Rectangle.subtract(t,n),u=i.Rectangle.getIntersects(n,t);if(!r&&!u)return[t];const l=new i.ObjectMatrix;return u&&i.Range.foreach(u,(c,m)=>{l.setValue(c-o,m,1)}),r&&i.Range.foreach(r,(c,m)=>{l.setValue(c-o,m,0)}),a.forEach(c=>{i.Range.foreach(c,(m,h)=>{l.setValue(m,h,1)})}),i.queryObjectMatrix(l,c=>c===1)},Du=(s,t)=>{var o;const e=(o=s.ranges)!=null?o:[s.range],n=new i.ObjectMatrix;return i.Range.foreach(t,(r,a)=>{n.setValue(r,a,1)}),e.forEach(r=>{const a=r.startRow,l=r.endRow-a+1;n.removeRows(a,l)}),i.queryObjectMatrix(n,r=>r===1)},Au=(s,t)=>{const e=s.params,n=e.range.startRow,o=e.range.endRow-e.range.startRow+1;return t.startRow>=n?[{startRow:t.startRow+o,endRow:t.endRow+o,startColumn:t.startColumn,endColumn:t.endColumn}]:t.endRow<n?[t]:[{startRow:t.startRow,endRow:t.endRow+o,startColumn:t.startColumn,endColumn:t.endColumn}]},Wu=(s,t)=>{const e=s.params,n=e.range.startColumn,o=e.range.endColumn-e.range.startColumn+1;return t.startColumn>=n?[{startRow:t.startRow,endRow:t.endRow,startColumn:t.startColumn+o,endColumn:t.endColumn+o}]:t.endColumn<n?[t]:[{startRow:t.startRow,endRow:t.endRow,startColumn:t.startColumn,endColumn:t.endColumn+o}]},tt=(s,t)=>{let e={...t};return s.forEach(n=>{switch(n.type){case B.Delete:{e=null;break}case B.HorizontalMove:{if(!e)return;e.startColumn+=n.step,e.endColumn+=n.step+(n.length||0);break}case B.VerticalMove:{if(!e)return;e.startRow+=n.step,e.endRow+=n.step+(n.length||0);break}case B.Set:{e=n.range;break}}}),e&&(e.endColumn<e.startColumn||e.endRow<e.startRow)?null:e},Us=(s,t)=>{let e=[];switch(t.id){case A.DeleteRangeMoveLeftCommandId:{e=Cr(t,s);break}case A.DeleteRangeMoveUpCommandId:{e=Sr(t,s);break}case A.InsertColCommandId:{e=hr(t,s);break}case A.InsertRangeMoveDownCommandId:{e=gr(t,s);break}case A.InsertRangeMoveRightCommandId:{e=Rr(t,s);break}case A.InsertRowCommandId:{e=mr(t,s);break}case A.MoveColsCommandId:{e=Es(t,s);break}case A.MoveRangeCommandId:{e=dr(t,s);break}case A.MoveRowsCommandId:{e=bs(t,s);break}case A.RemoveColCommandId:{e=Ts(t,s);break}case A.RemoveRowCommandId:{e=cr(t,s);break}case A.ReorderRangeCommandId:{e=Tu(t,s);break}}return tt(e,s)},Vu=(s,t,e)=>[He.id,Fe.id].includes(t.id)||Ir(t,e).some(r=>i.Rectangle.intersects(r,s))?Us(s,t):s,Ps=(s,t)=>{let e=[];switch(t.id){case A.DeleteRangeMoveLeftCommandId:return Nu(t,s);case A.DeleteRangeMoveUpCommandId:return Ou(t,s);case A.InsertRangeMoveDownCommandId:return Pu(t,s);case A.InsertRangeMoveRightCommandId:return ku(t,s);case A.InsertColCommandId:return Wu(t,s);case A.InsertRowCommandId:return Au(t,s);case A.MoveColsCommandId:return bu(t,s);case A.MoveRangeCommandId:return Eu(t,s);case A.MoveRowsCommandId:return yu(t,s);case A.ReorderRangeCommandId:return _u(t,s);case A.RemoveColCommandId:{e=Ts(t,s);break}case A.RemoveRowCommandId:return Du(t.params,s)}const n=tt(e,s);return n?[n]:[]},$u=(s,t,e)=>[He.id,Fe.id,Xe.id,vs].includes(t.id)||Ir(t,e).some(r=>i.Rectangle.intersects(r,s))?Ps(s,t):s;function fr(s,t){const{id:e,params:n}=t;let o={length:0,step:0,type:B.Unknown};switch(e){case Ze.id:o.type=B.Delete;break;case pe.id:o=Ht({start:n.sourceRange.startRow,end:n.sourceRange.endRow},{start:n.targetRange.startRow,end:n.targetRange.endRow},{start:s.startRow,end:s.endRow}),o.type=B.VerticalMove;break;case we.id:o=Ht({start:n.sourceRange.startColumn,end:n.sourceRange.endColumn},{start:n.targetRange.startColumn,end:n.targetRange.endColumn},{start:s.startColumn,end:s.endColumn}),o.type=B.HorizontalMove;break;case ne.id:o=Qe(n.range,s),o?o.type=B.HorizontalMove:o={step:0,length:0,type:B.Delete};break;case ae.id:o=Qe(he(n.range),he(s)),o?o.type=B.VerticalMove:o={step:0,length:0,type:B.Delete};break;case re.id:o=et(he(n.range),he(s)),o.type=B.VerticalMove;break;case ie.id:o=et(n.range,s),o.type=B.HorizontalMove;break;case Be.id:{const r=n.fromRange||new i.ObjectMatrix(n.from).getRange(),a=n.toRange||new i.ObjectMatrix(n.to).getRange();o=Uu(r,a,s)}break}return o?Array.isArray(o)?tt(o,s):tt([o],s):s}function Ir(s,t){var n,o,r,a,u,l;const{selectionManagerService:e}=t;switch(s.id){case A.MoveColsCommandId:{const d=s.params;return[d.fromRange,{...d.toRange,startColumn:d.toRange.startColumn-.5,endColumn:d.toRange.endColumn-.5}]}case A.MoveRowsCommandId:{const d=s.params;return[d.fromRange,{...d.toRange,startRow:d.toRange.startRow-.5,endRow:d.toRange.startRow-.5}]}case A.MoveRangeCommandId:{const d=s;return[d.params.fromRange,d.params.toRange]}case A.InsertRowCommandId:{const c=s.params.range;return[{...c,startRow:c.startRow-.5,endRow:c.endRow-.5}]}case A.InsertColCommandId:{const c=s.params.range;return[{...c,startColumn:c.startColumn-.5,endColumn:c.endColumn-.5}]}case A.RemoveRowCommandId:return[s.params.range];case A.RemoveColCommandId:return[s.params.range];case A.DeleteRangeMoveUpCommandId:case A.InsertRangeMoveDownCommandId:{const c=((n=s.params)==null?void 0:n.range)||((r=(o=e.getCurrentSelections())==null?void 0:o.map(m=>m.range))==null?void 0:r[0]);return c?[c]:[]}case A.DeleteRangeMoveLeftCommandId:case A.InsertRangeMoveRightCommandId:{const c=((a=s.params)==null?void 0:a.range)||((l=(u=e.getCurrentSelections())==null?void 0:u.map(m=>m.range))==null?void 0:l[0]);return c?[c]:[]}case A.ReorderRangeCommandId:{const d=s,{range:c,order:m}=d.params,h=[];for(let R=c.startRow;R<=c.endRow;R++)R in m&&h.push({startRow:R,endRow:R,startColumn:c.startColumn,endColumn:c.endColumn});return h}}}function Lu(s){switch(s.id){case we.id:{const t=s.params;return[t.sourceRange,{...t.targetRange,startColumn:t.targetRange.startColumn-.5,endColumn:t.targetRange.startColumn-.5}]}case pe.id:{const t=s.params;return[t.sourceRange,{...t.targetRange,startRow:t.targetRange.startRow-.5,endRow:t.targetRange.startRow-.5}]}case Be.id:{const t=s.params;return[new i.ObjectMatrix(t.from.value).getRange(),new i.ObjectMatrix(t.to.value).getRange()]}case ie.id:{const e=s.params.range;return[{...e,startColumn:e.startColumn-.5,endColumn:e.startColumn-.5}]}case re.id:{const e=s.params.range;return[{...e,startRow:e.startRow-.5,endRow:e.startRow-.5}]}case ne.id:return[s.params.range];case ae.id:return[s.params.range]}}function Bu(s,t){var o,r,a,u,l,d;const e=s.get(i.IUniverInstanceService),n=s.get(g.SheetsSelectionsService);switch(t.id){case A.MoveColsCommandId:{const c=t.params,m=P(e,{unitId:c.unitId,subUnitId:c.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[c.fromRange,{...c.toRange,startColumn:c.fromRange.startColumn<c.toRange.startColumn?c.fromRange.endColumn+1:c.toRange.startColumn,endColumn:c.fromRange.startColumn<c.toRange.startColumn?c.toRange.endColumn-1:c.fromRange.startColumn-1}]}}case A.MoveRowsCommandId:{const c=t.params,m=P(e,{unitId:c.unitId,subUnitId:c.subUnitId});return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[c.fromRange,{...c.toRange,startRow:c.fromRange.startRow<c.toRange.startRow?c.fromRange.endRow+1:c.toRange.startRow,endRow:c.fromRange.startRow<c.toRange.startRow?c.toRange.endRow-1:c.fromRange.startRow-1}]}}case A.MoveRangeCommandId:{const c=t.params,m=P(e);return{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[c.fromRange,c.toRange]}}case A.InsertRowCommandId:{const c=t.params,m=c.range;return{unitId:c.unitId,subUnitId:c.subUnitId,ranges:[...m.startRow>0?[{...m,startRow:m.startRow-1,endRow:m.endRow-1}]:[],{...m,startRow:m.startRow,endRow:Number.MAX_SAFE_INTEGER}]}}case A.InsertColCommandId:{const c=t.params,m=c.range;return{unitId:c.unitId,subUnitId:c.subUnitId,ranges:[...m.startColumn>0?[{...m,startColumn:m.startColumn-1,endColumn:m.endColumn-1}]:[],{...m,startColumn:m.startColumn,endColumn:Number.MAX_SAFE_INTEGER}]}}case A.RemoveRowCommandId:{const m=t.params.range,h=P(e);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startRow:m.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}}case A.RemoveColCommandId:{const m=t.params.range,h=P(e);return{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}}case A.DeleteRangeMoveUpCommandId:case A.InsertRangeMoveDownCommandId:{const c=t,m=P(e),h=((o=c.params)==null?void 0:o.range)||((a=(r=n.getCurrentSelections())==null?void 0:r.map(R=>R.range))==null?void 0:a[0]);return h?{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[h,{...h,startRow:h.endRow+1,endRow:Number.MAX_SAFE_INTEGER}]}:{unitId:m.unitId,subUnitId:m.subUnitId,ranges:[]}}case A.DeleteRangeMoveLeftCommandId:case A.InsertRangeMoveRightCommandId:{const m=((u=t.params)==null?void 0:u.range)||((d=(l=n.getCurrentSelections())==null?void 0:l.map(R=>R.range))==null?void 0:d[0]),h=P(e);return m?{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[m,{...m,startColumn:m.endColumn+1,endColumn:Number.MAX_SAFE_INTEGER}]}:{unitId:h.unitId,subUnitId:h.subUnitId,ranges:[]}}case A.ReorderRangeCommandId:{const c=t,{range:m,order:h}=c.params,R=[];for(let S=m.startRow;S<=m.endRow;S++)S in h&&R.push({startRow:S,endRow:S,startColumn:m.startColumn,endColumn:m.endColumn});const C=P(e);return{unitId:C.unitId,subUnitId:C.subUnitId,ranges:R}}}}var Hu=Object.getOwnPropertyDescriptor,Fu=(s,t,e,n)=>{for(var o=n>1?void 0:n?Hu(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Sn=(s,t)=>(e,n)=>t(e,n,s);const ju=i.createInterceptorKey("MERGE_REDO"),Gu=i.createInterceptorKey("MERGE_UNDO"),vr=Math.floor(Number.MAX_SAFE_INTEGER/10);class zu extends i.Disposable{constructor(t,e,n,o,r=!1){super(),this._unitId=t,this._subUnitId=e,this._range=n,this._callback=o,this._skipIntersects=r}onMutation(t){var o,r;if(((o=t.params)==null?void 0:o.unitId)!==this._unitId)return;if(t.id===Be.id){const a=t.params;if(a.from.subUnitId!==this._subUnitId||a.to.subUnitId!==this._subUnitId)return}else if(((r=t.params)==null?void 0:r.subUnitId)!==this._subUnitId)return;if(!this._range)return;if(this._skipIntersects){if(t.id===Ze.id)return;const a=Lu(t);if(a!=null&&a.some(u=>i.Rectangle.intersects(u,this._range)))return}const e=fr(this._range,t);if(e&&i.Rectangle.equals(e,this._range))return!1;const n=this._range;this._range=e,this._callback(n,e)}}g.RefRangeService=class extends i.Disposable{constructor(e,n,o,r){super();f(this,"interceptor",new i.InterceptorManager({MERGE_REDO:ju,MERGE_UNDO:Gu}));f(this,"_watchRanges",new Set);f(this,"_refRangeManagerMap",new Map);f(this,"_serializer",qu());f(this,"_onRefRangeChange",()=>{this._sheetInterceptorService.interceptCommand({getMutations:e=>{const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet(),o=pr(this._univerInstanceService),r=wr(this._univerInstanceService);if(!n||!o||!r)return{redos:[],undos:[],preRedos:[],preUndos:[]};const l=((()=>{switch(e.id){case A.MoveColsCommandId:{const R=e.params,C=Math.min(R.fromRange.startColumn,R.toRange.startColumn);return this._checkRange([{...R.fromRange,startColumn:C,endColumn:n.getColumnCount()-1}],o,r)}case A.MoveRowsCommandId:{const R=e.params,C=Math.min(R.fromRange.startRow,R.toRange.startRow);return this._checkRange([{...R.fromRange,startRow:C,endRow:n.getRowCount()-1}],o,r)}case A.MoveRangeCommandId:{const R=e;return this._checkRange([R.params.fromRange,R.params.toRange],o,r)}case A.InsertRowCommandId:{const S={startRow:e.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([S],o,r)}case A.InsertColCommandId:{const C=e.params.range.startColumn,S={startRow:0,endRow:n.getRowCount()-1,startColumn:C,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([S],o,r)}case A.RemoveRowCommandId:{const S={startRow:e.params.range.startRow,endRow:n.getRowCount()-1,startColumn:0,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return this._checkRange([S],o,r)}case A.RemoveColCommandId:{const C=e.params.range.startColumn,S={startRow:0,endRow:n.getRowCount()-1,startColumn:C,endColumn:n.getColumnCount()-1,rangeType:i.RANGE_TYPE.COLUMN};return this._checkRange([S],o,r)}case A.DeleteRangeMoveUpCommandId:case A.InsertRangeMoveDownCommandId:{const C=e.params.range||Mr(this._selectionManagerService)[0],S={startRow:C.startRow,startColumn:C.startColumn,endColumn:C.endColumn,endRow:vr};return this._checkRange([S],o,r)}case A.DeleteRangeMoveLeftCommandId:case A.InsertRangeMoveRightCommandId:{const C=e.params.range||Mr(this._selectionManagerService)[0],S={startRow:C.startRow,startColumn:C.startColumn,endColumn:vr,endRow:C.endRow};return this._checkRange([S],o,r)}case A.ReorderRangeCommandId:{const R=e,{range:C,order:S}=R.params,I=[];for(let v=C.startRow;v<=C.endRow;v++)v in S&&I.push({startRow:v,endRow:v,startColumn:C.startColumn,endColumn:C.endColumn});return this._checkRange(I,o,r)}}})()||[]).reduce((R,C)=>{const S=C(e);return R.push(S),R},[]).reduce((R,C)=>{var S,I;return R.redos.push(...C.redos),R.undos.push(...C.undos),R.preRedos.push(...(S=C.preRedos)!=null?S:[]),R.preUndos.push(...(I=C.preUndos)!=null?I:[]),R},{redos:[],undos:[],preUndos:[],preRedos:[]}),d=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(l.preRedos,null)||[],c=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(l.redos,null)||[],m=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(l.preUndos,null)||[],h=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(l.undos,null)||[];return{redos:c,undos:h,preRedos:d,preUndos:m}}})});f(this,"_checkRange",(e,n,o)=>{const r=yr(n,o),a=this._refRangeManagerMap.get(r);if(a){const u=new Set;return[...a.keys()].forEach(d=>{const c=a.get(d),m=this._serializer.deserialize(d),h={...m,startRow:+m.startRow,endRow:+m.endRow,startColumn:+m.startColumn,endColumn:+m.endColumn,rangeType:m.rangeType&&+m.rangeType};e.some(R=>i.Rectangle.intersects(R,h))&&c&&c.forEach(R=>{u.add(R)})}),[...u]}return[]});f(this,"registerRefRange",(e,n,o,r)=>{const a=o||pr(this._univerInstanceService),u=r||wr(this._univerInstanceService);if(!a||!u)return i.toDisposable(()=>{});const l=yr(a,u),d=this._serializer.serialize(e);let c=this._refRangeManagerMap.get(l);c||(c=new Map,this._refRangeManagerMap.set(l,c));const m=c.get(d);return m?m.add(n):c.set(d,new Set([n])),i.toDisposable(()=>{const h=c.get(d);h&&(h.delete(n),h.size||(c.delete(d),c.size||this._refRangeManagerMap.delete(l)))})});this._commandService=e,this._sheetInterceptorService=n,this._univerInstanceService=o,this._selectionManagerService=r,this._onRefRangeChange(),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_REDO,{priority:-1,handler:a=>a}),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_UNDO,{priority:-1,handler:a=>a})}watchRange(e,n,o,r,a){let u;this._watchRanges.size===0&&(u=this._commandService.onCommandExecuted(m=>{if(m.type!==i.CommandType.MUTATION)return!1;for(const h of this._watchRanges)h.onMutation(m)}));const l=new zu(e,n,o,r,a);this._watchRanges.add(l);const d=i.toDisposable(()=>{this._watchRanges.delete(l),this._watchRanges.size===0&&(u==null||u.dispose(),u=null)}),c=this.disposeWithMe(d);return i.toDisposable(()=>{c.dispose(),d.dispose()})}},g.RefRangeService=Fu([Sn(0,i.ICommandService),Sn(1,i.Inject(g.SheetInterceptorService)),Sn(2,i.Inject(i.IUniverInstanceService)),Sn(3,i.Inject(g.SheetsSelectionsService))],g.RefRangeService);function pr(s){return s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId()}function wr(s){var t;return(t=s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getActiveSheet())==null?void 0:t.getSheetId()}function Mr(s){var t;return((t=s.getCurrentSelections())==null?void 0:t.map(e=>e.range))||[]}function yr(s,t){return`${s}_${t}`}function qu(){const s=["startRow","startColumn","endRow","endColumn","rangeType"];return{deserialize:e=>{const n=s.reduce((r,a,u)=>(r[String(u)]=a,r),{});return e.split("_").reduce((r,a,u)=>{const l=String(u);return a&&n[l]&&(r[n[l]]=a),r},{})},serialize:e=>s.reduce((n,o,r)=>{const a=e[o];return a!==void 0?`${n}${r>0?"_":""}${a}`:`${n}`},"")}}var Yu=Object.getOwnPropertyDescriptor,Ku=(s,t,e,n)=>{for(var o=n>1?void 0:n?Yu(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Mt=(s,t)=>(e,n)=>t(e,n,s);const Ju=[ie.id,re.id,ne.id,ae.id],xu=[pe.id,we.id];function ks(s,t){let e=s;if(t!==void 0){const n=[];for(let o=0;o<e.length;o++){const{startRow:r,endRow:a,startColumn:u,endColumn:l}=e[o];if(t===i.Dimension.ROWS)for(let d=r;d<=a;d++){const c={startRow:d,endRow:d,startColumn:u,endColumn:l};n.push(c)}else if(t===i.Dimension.COLUMNS)for(let d=u;d<=l;d++){const c={startRow:r,endRow:a,startColumn:d,endColumn:d};n.push(c)}}e=n}return e}const _r=i.createInterceptorKey("mergeCellPermissionCheck");g.MergeCellController=class extends i.Disposable{constructor(e,n,o,r,a,u){super();f(this,"disposableCollection",new i.DisposableCollection);f(this,"interceptor",new i.InterceptorManager({MERGE_CELL_INTERCEPTOR_CHECK:_r}));this._commandService=e,this._refRangeService=n,this._univerInstanceService=o,this._injector=r,this._sheetInterceptorService=a,this._selectionManagerService=u,this._onRefRangeChange(),this._initCommandInterceptor(),this._commandExecutedListener()}_initCommandInterceptor(){const e=this;this._sheetInterceptorService.interceptCommand({getMutations(n){var o;switch(n.id){case sn.id:case on.id:{const r=e._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=r.getUnitId(),u=r==null?void 0:r.getActiveSheet();if(!u)return{redos:[],undos:[]};const l=u.getSheetId(),d=u.getConfig().mergeData,c=(o=e._selectionManagerService.getCurrentSelections())==null?void 0:o.map(m=>m.range);if(c&&c.length>0&&c.some(h=>d.some(R=>i.Rectangle.intersects(R,h)))){const h={unitId:a,subUnitId:l,ranges:c},R=ue(e._injector,h),C=[{id:G.id,params:h}],S=[{id:j.id,params:R}];return{redos:C,undos:S}}}}return{redos:[],undos:[]}}}),this._sheetInterceptorService.interceptRanges({getMutations:({unitId:n,subUnitId:o,ranges:r})=>{const a=[],u=[],l={redos:a,undos:u};if(!r||!r.length)return l;const d=P(this._univerInstanceService,{unitId:n,subUnitId:o});if(!d)return l;const{worksheet:c}=d,h=c.getMergeData().filter(R=>r.some(C=>i.Rectangle.intersects(R,C)));return h.length?(a.push({id:G.id,params:{unitId:n,subUnitId:o,ranges:h}}),u.push({id:j.id,params:{unitId:n,subUnitId:o,ranges:h}}),{undos:u,redos:a}):l}})}refRangeHandle(e,n,o){switch(e.id){case A.MoveColsCommandId:{const r=e.params;return this._handleMoveColsCommand(r,n,o)}case A.MoveRowsCommandId:{const r=e.params;return this._handleMoveRowsCommand(r,n,o)}case Me.id:{const r=e.params,a=r.unitId||n,u=r.subUnitId||o;return this._handleInsertRowCommand(r,a,u)}case ye.id:{const r=e.params,a=r.unitId||n,u=r.subUnitId||o;return this._handleInsertColCommand(r,a,u)}case Lt.id:{const r=e.params;return this._handleRemoveColCommand(r,n,o)}case $t.id:{const r=e.params;return this._handleRemoveRowCommand(r,n,o)}case xe.id:{const r=e.params;return this._handleMoveRangeCommand(r,n,o)}case vt.id:{const r=e.params;return this._handleInsertRangeMoveRightCommand(r,n,o)}case Xe.id:{const r=e.params;return this._handleInsertRangeMoveDownCommand(r,n,o)}case Fe.id:{const r=e.params;return this._handleDeleteRangeMoveUpCommand(r,n,o)}case He.id:{const r=e.params;return this._handleDeleteRangeMoveLeftCommand(r,n,o)}}return{redos:[],undos:[]}}_onRefRangeChange(){const e=(n,o)=>{const r=this._univerInstanceService.getUniverSheetInstance(n);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(o);if(!a)return;this.disposableCollection.dispose();const u=a.getMergeData(),l=d=>this.refRangeHandle(d,n,o);u.forEach(d=>{this.disposableCollection.add(this._refRangeService.registerRefRange(d,l,n,o))})};this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id===Ct.id){const o=n.params,r=o.subUnitId,a=o.unitId;if(!r||!a)return;e(a,r)}if(n.id===j.id){const o=n.params,r=o.subUnitId,a=o.unitId;if(!r||!a)return;e(o.unitId,o.subUnitId)}})),this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe(O.first(n=>!!n)).subscribe(n=>{const o=n.getActiveSheet();o&&e(n.getUnitId(),o.getSheetId())})}_handleMoveRowsCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const u=[...a.getMergeData()],l={unitId:n,subUnitId:o,ranges:[]},d={unitId:n,subUnitId:o,ranges:[]},{fromRange:c}=e,{startRow:m,endRow:h}=c;if(u.forEach(S=>{if(m<=S.startRow&&h>=S.endRow){l.ranges.push(S);const I=bs({id:A.MoveRowsCommandId,params:e},S),v=tt(I,S);v&&d.ranges.push(v)}}),l.ranges.length===0)return this._handleNull();const R=ue(this._injector,l),C=ge(this._injector,d);return{preRedos:[{id:G.id,params:l}],redos:[{id:j.id,params:d}],preUndos:[{id:G.id,params:C}],undos:[{id:j.id,params:R}]}}_handleMoveColsCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const u=[...a.getMergeData()],l={unitId:n,subUnitId:o,ranges:[]},d={unitId:n,subUnitId:o,ranges:[]},{fromRange:c}=e,{startColumn:m,endColumn:h}=c;if(u.forEach(S=>{if(m<=S.startColumn&&h>=S.endColumn){l.ranges.push(S);const I=Es({id:A.MoveColsCommandId,params:e},S),v=tt(I,S);v&&d.ranges.push(v)}}),l.ranges.length===0)return this._handleNull();const R=ue(this._injector,l),C=ge(this._injector,d);return{preRedos:[{id:G.id,params:l}],redos:[{id:j.id,params:d}],preUndos:[{id:G.id,params:C}],undos:[{id:j.id,params:R}]}}_handleMoveRangeCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const u=a.getMergeData(),l=u.filter(C=>i.Rectangle.intersects(C,e.fromRange)),d=u.filter(C=>i.Rectangle.intersects(C,e.toRange)),c=l.map(C=>i.Rectangle.getRelativeRange(C,e.fromRange)).map(C=>i.Rectangle.getPositionRange(C,e.toRange)),m=ks(c).filter(C=>!u.some(S=>i.Rectangle.equals(C,S))),h=[{id:G.id,params:{unitId:n,subUnitId:o,ranges:l}},{id:G.id,params:{unitId:n,subUnitId:o,ranges:d}},{id:j.id,params:{unitId:n,subUnitId:o,ranges:m}}],R=[{id:G.id,params:{unitId:n,subUnitId:o,ranges:m}},{id:j.id,params:{unitId:n,subUnitId:o,ranges:d}},{id:j.id,params:{unitId:n,subUnitId:o,ranges:l}}];return{redos:h,undos:R}}_handleInsertRowCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const{range:u}=e,{startRow:l,endRow:d}=u,c=i.Tools.deepClone(a.getMergeData()).reduce((M,p)=>(l>p.startRow&&l<=p.endRow&&M.push(p),M),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((M,p)=>{if(l>p.startRow&&l<=p.endRow){const w=d-l+1;p.endRow+=w,this._checkIsMergeCell(p)&&M.push(p)}return M},[]),h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C),I=[{id:G.id,params:h},{id:j.id,params:C}],v=[{id:G.id,params:S},{id:j.id,params:R}];return{redos:I,undos:v}}_handleInsertColCommand(e,n,o){const{range:r}=e,a=_e(this._univerInstanceService,n);if(!a)return this._handleNull();const u=be(a,o);if(!u)return this._handleNull();const{startColumn:l,endColumn:d}=r,c=i.Tools.deepClone(u.getMergeData()).reduce((M,p)=>(l>p.startColumn&&l<=p.endColumn&&M.push(p),M),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(u.getMergeData()).reduce((M,p)=>{if(l>p.startColumn&&l<=p.endColumn){const w=d-l+1;p.endColumn+=w,this._checkIsMergeCell(p)&&M.push(p)}return M},[]),h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C),I=[{id:G.id,params:h},{id:j.id,params:C}],v=[{id:G.id,params:S},{id:j.id,params:R}];return{redos:I,undos:v}}_handleRemoveColCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const{range:u}=e,{startColumn:l,endColumn:d}=u,c=i.Tools.deepClone(a.getMergeData()).reduce((w,y)=>(i.Rectangle.intersects(u,y)&&w.push(y),w),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(a.getMergeData()).reduce((w,y)=>{if(i.Rectangle.intersects(u,y)){if(l<=y.startColumn&&d>=y.endColumn)return w;l>=y.startColumn&&d<=y.endColumn?y.endColumn-=d-l+1:l<y.startColumn?(y.startColumn=l,y.endColumn-=d-l+1):d>y.endColumn&&(y.endColumn=l-1),this._checkIsMergeCell(y)&&w.push(y)}return w},[]),h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C),I=[{id:G.id,params:h}],v=[{id:j.id,params:C}],M=[{id:G.id,params:S}],p=[{id:j.id,params:R}];return{preUndos:M,undos:p,preRedos:I,redos:v}}_handleRemoveRowCommand(e,n,o){const{range:r}=e,a=_e(this._univerInstanceService,n);if(!a)return this._handleNull();const u=be(a,o);if(!u)return this._handleNull();const{startRow:l,endRow:d}=r,c=i.Tools.deepClone(u.getMergeData()).reduce((w,y)=>(i.Rectangle.intersects(r,y)&&w.push(y),w),[]);if(c.length===0)return this._handleNull();const m=i.Tools.deepClone(u.getMergeData()).reduce((w,y)=>{if(i.Rectangle.intersects(r,y)){if(l<=y.startRow&&d>=y.endRow)return w;l>=y.startRow&&d<=y.endRow?y.endRow-=d-l+1:l<y.startRow?(y.startRow=l,y.endRow-=d-l+1):d>y.endRow&&(y.endRow=l-1),this._checkIsMergeCell(y)&&w.push(y)}return w},[]),h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C),I=[{id:G.id,params:h}],v=[{id:j.id,params:C}],M=[{id:G.id,params:S}],p=[{id:j.id,params:R}];return{preUndos:M,undos:p,preRedos:I,redos:v}}_handleInsertRangeMoveRightCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const u=e.range,l=a.getMaxColumns()-1,d=a.getMergeData(),c=[],m=[];d.forEach(I=>{const{startRow:v,endRow:M,startColumn:p,endColumn:w}=u;if(i.Rectangle.intersects({startRow:v,startColumn:p,endRow:M,endColumn:l},I)&&(c.push(I),i.Rectangle.contains({startRow:v,startColumn:p,endRow:M,endColumn:l},I))){const T=w-p+1;m.push({startRow:I.startRow,startColumn:I.startColumn+T,endRow:I.endRow,endColumn:I.endColumn+T})}});const h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C);return{preRedos:[{id:G.id,params:h}],redos:[{id:j.id,params:C}],preUndos:[{id:G.id,params:S}],undos:[{id:j.id,params:R}]}}_handleInsertRangeMoveDownCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const u=e.range,l=a.getMaxRows()-1,d=a.getMergeData(),c=[],m=[];d.forEach(w=>{const{startRow:y,startColumn:b,endColumn:T,endRow:U}=u;if(i.Rectangle.intersects({startRow:y,startColumn:b,endRow:l,endColumn:T},w)&&(c.push(w),i.Rectangle.contains({startRow:y,startColumn:b,endRow:l,endColumn:T},w))){const N=U-y+1;m.push({startRow:w.startRow+N,startColumn:w.startColumn,endRow:w.endRow+N,endColumn:w.endColumn})}});const h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C),I=[{id:G.id,params:h}],v=[{id:j.id,params:C}],M=[{id:G.id,params:S}],p=[{id:j.id,params:R}];return{redos:v,undos:p,preRedos:I,preUndos:M}}_handleDeleteRangeMoveUpCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const u=e.range,l=a.getMaxRows()-1,d=a.getMergeData(),c=[],m=[];d.forEach(w=>{const{startRow:y,startColumn:b,endColumn:T,endRow:U}=u;if(i.Rectangle.intersects({startRow:y,startColumn:b,endRow:l,endColumn:T},w)&&(c.push(w),i.Rectangle.contains({startRow:y,startColumn:b,endRow:l,endColumn:T},w))){const N=U-y+1,W=i.Rectangle.moveVertical(w,-N);m.push(W)}});const h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C),I=[{id:G.id,params:h}],v=[{id:j.id,params:C}],M=[{id:G.id,params:S}],p=[{id:j.id,params:R}];return{redos:v,undos:p,preRedos:I,preUndos:M}}_handleDeleteRangeMoveLeftCommand(e,n,o){const r=_e(this._univerInstanceService,n);if(!r)return this._handleNull();const a=be(r,o);if(!a)return this._handleNull();const u=e.range,l=a.getMaxColumns()-1,d=a.getMergeData(),c=[],m=[];d.forEach(I=>{const{startRow:v,endRow:M,startColumn:p,endColumn:w}=u;if(i.Rectangle.intersects({startRow:v,startColumn:p,endRow:M,endColumn:l},I)&&(c.push(I),i.Rectangle.contains({startRow:v,startColumn:p,endRow:M,endColumn:l},I))){const T=w-p+1;m.push({startRow:I.startRow,startColumn:I.startColumn-T,endRow:I.endRow,endColumn:I.endColumn-T})}});const h={unitId:n,subUnitId:o,ranges:c},R=ue(this._injector,h),C={unitId:n,subUnitId:o,ranges:m},S=ge(this._injector,C);return{preRedos:[{id:G.id,params:h}],redos:[{id:j.id,params:C}],undos:[{id:j.id,params:R}],preUndos:[{id:G.id,params:S}]}}_checkIsMergeCell(e){return!(e.startRow===e.endRow&&e.startColumn===e.endColumn)}_handleNull(){return{redos:[],undos:[]}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(xu.includes(e.id)){if(!e.params)return;const n=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!n)return;const o=n.getSheetBySheetId(e.params.subUnitId);if(!o)return;const{sourceRange:r,targetRange:a}=e.params,u=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,l=u?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,d=u?r.startRow:r.startColumn,c=u?a.startRow:a.startColumn,m=o.getConfig().mergeData,h=[];m.forEach(I=>{let{startRow:v,endRow:M,startColumn:p,endColumn:w,rangeType:y}=I;i.Rectangle.intersects(I,r)||(u?d<v&&c>M?(v-=l,M-=l):d>M&&c<=v&&(v+=l,M+=l):d<p&&c>w?(p-=l,w-=l):d>w&&c<=p&&(p+=l,w+=l)),I.startRow===I.endRow&&I.startColumn===I.endColumn||h.push({startRow:v,endRow:M,startColumn:p,endColumn:w,rangeType:y})}),o.setMergeData(h),this.disposableCollection.dispose();const{unitId:R,subUnitId:C}=e.params,S=I=>this.refRangeHandle(I,R,C);h.forEach(I=>{this.disposableCollection.add(this._refRangeService.registerRefRange(I,S,R,C))})}if(Ju.includes(e.id)){const n=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!n)return;const o=n.getSheetBySheetId(e.params.subUnitId);if(!o)return;const r=o.getConfig().mergeData,a=e.params;if(!a)return;const{range:u}=a,l=e.id.includes("row"),d=e.id.includes("insert"),c=l?u.startRow:u.startColumn,m=l?u.endRow:u.endColumn,h=m-c+1,R=[];r.forEach(v=>{let{startRow:M,endRow:p,startColumn:w,endColumn:y,rangeType:b}=v;d?l?c<=M&&(M+=h,p+=h):c<=w&&(w+=h,y+=h):l?m<M&&(M-=h,p-=h):m<w&&(w-=h,y-=h),v.startRow===v.endRow&&v.startColumn===v.endColumn||R.push({startRow:M,endRow:p,startColumn:w,endColumn:y,rangeType:b})}),o.setMergeData(R),this.disposableCollection.dispose();const{unitId:C,subUnitId:S}=e.params,I=v=>this.refRangeHandle(v,C,S);R.forEach(v=>{this.disposableCollection.add(this._refRangeService.registerRefRange(v,I,C,S))})}}))}},g.MergeCellController=Ku([Mt(0,i.Inject(i.ICommandService)),Mt(1,i.Inject(g.RefRangeService)),Mt(2,i.Inject(i.IUniverInstanceService)),Mt(3,i.Inject(i.Injector)),Mt(4,i.Inject(g.SheetInterceptorService)),Mt(5,i.Inject(g.SheetsSelectionsService))],g.MergeCellController);function _e(s,t){return t?s.getUniverSheetInstance(t):s.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET)}function be(s,t){return t?s.getSheetBySheetId(t):s.getActiveSheet()}function Xu(s,t){return t.some(e=>Zu(s,e))}function Zu(s,t){const{startRow:e,startColumn:n,endColumn:o,endRow:r}=t,a=s.getMatrixWithMergedCells(e,n,r,o);let u=!1;return a.forValue((l,d,c)=>{if(c&&(l!==e||d!==n)&&s.cellHasValue(c))return u=!0,!1}),u}function Qu(s,t,e,n){const o=[],r=[],a=e.getSheetId();return n.forEach(u=>{const l=el(e,u),d={unitId:t,subUnitId:a,cellValue:l.getData()},c=ce(s,d);o.push({id:F.id,params:c}),r.push({id:F.id,params:d})}),{undos:o,redos:r}}function el(s,t){const{startRow:e,startColumn:n,endColumn:o,endRow:r}=t,a=s.getMatrixWithMergedCells(e,n,r,o,i.CellModeEnum.Raw),u=new i.ObjectMatrix;return a.forValue((l,d,c)=>{c&&(l!==e||d!==n)&&u.setValue(l,d,null)}),u}const Ft={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=t.unitId,a=t.subUnitId,u=t.selections,l=ks(u,t.value),d=o.getUniverSheetInstance(r).getSheetBySheetId(a),c=[],m=[],h=Xu(d,l),R={unitId:r,subUnitId:a,ranges:l},C={unitId:r,subUnitId:a,ranges:l};c.push({id:G.id,params:R}),c.push({id:j.id,params:C});const S=ue(s,R),I=ge(s,C);if(m.push({id:G.id,params:I}),m.push({id:j.id,params:S}),h){const M=Qu(s,r,d,l);c.unshift(...M.redos),m.push(...M.undos)}return i.sequenceExecute(c,e).result?(n.pushUndoRedo({unitID:r,undoMutations:m,redoMutations:c}),!0):!1}},tl={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-all",handler:async s=>{var d;const t=s.get(i.ICommandService),n=(d=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:d.map(c=>c.range);if(!(n!=null&&n.length))return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const u=r.getUnitId(),l=a.getSheetId();return t.executeCommand(Ft.id,{selections:n,unitId:u,subUnitId:l})}},nl={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-vertical",handler:async s=>{var d;const t=s.get(i.ICommandService),n=(d=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:d.map(c=>c.range);if(!(n!=null&&n.length))return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const u=r.getUnitId(),l=a.getSheetId();return t.executeCommand(Ft.id,{value:i.Dimension.COLUMNS,selections:n,unitId:u,subUnitId:l})}},sl={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-horizontal",handler:async s=>{var d;const t=s.get(i.ICommandService),n=(d=s.get(g.SheetsSelectionsService).getCurrentSelections())==null?void 0:d.map(c=>c.range);if(!(n!=null&&n.length))return!1;const r=s.get(i.IUniverInstanceService).getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;const a=r.getActiveSheet();if(!a)return!1;const u=r.getUnitId(),l=a.getSheetId();return t.executeCommand(Ft.id,{value:i.Dimension.ROWS,selections:n,unitId:u,subUnitId:l})}};function ol(s,t,e,n,o){const r=s.get(i.IUniverInstanceService),a=P(r,{unitId:t,subUnitId:e});if(!a)return;const{worksheet:u}=a;if(u.getMergeData().some(m=>n.some(h=>i.Rectangle.intersects(h,m))))throw new Error("The ranges to be merged overlap with the existing merged cells");s.get(i.ICommandService).executeCommand(Ft.id,{unitId:t,subUnitId:e,selections:n,defaultMerge:o})}class yt{constructor(){f(this,"_model",new Map);f(this,"_pointChange",new O.Subject);f(this,"pointChange$",this._pointChange.asObservable())}addRule(t){this._ensureSubUnitMap(t.unitId).set(t.subUnitId,t),this._pointChange.next(t)}deleteRule(t,e){var o,r,a;const n=(o=this._model.get(t))==null?void 0:o.get(e);n&&((a=(r=this._model)==null?void 0:r.get(t))==null||a.delete(e),this._pointChange.next(n))}getRule(t,e){var n,o;return(o=(n=this._model)==null?void 0:n.get(t))==null?void 0:o.get(e)}toObject(){const t={};return[...this._model.keys()].forEach(n=>{const o=this._model.get(n);o!=null&&o.size&&(t[n]=[],[...o.keys()].forEach(a=>{const u=o.get(a);u&&t[n].push(u)}))}),t}fromObject(t){const e=new Map;Object.keys(t).forEach(n=>{const o=t[n];if(o!=null&&o.length){const r=new Map;o.forEach(a=>{r.set(a.subUnitId,a)}),e.set(n,r)}}),this._model=e}deleteUnitModel(t){this._model.delete(t)}_ensureSubUnitMap(t){let e=this._model.get(t);return e||(e=new Map,this._model.set(t,e)),e}getTargetByPermissionId(t,e){const n=this._model.get(t);if(!n)return null;for(const[o,r]of n)if(r.permissionId===e)return[t,o]}}class ke{constructor(){f(this,"_model",new Map);f(this,"_ruleChange",new O.Subject);f(this,"_ruleRefresh",new O.Subject);f(this,"_resetOrder",new O.Subject);f(this,"ruleChange$",this._ruleChange.asObservable());f(this,"ruleRefresh$",this._ruleRefresh.asObservable());f(this,"resetOrder$",this._resetOrder.asObservable());f(this,"_worksheetRuleInitStateChange",new O.BehaviorSubject(!1));f(this,"worksheetRuleInitStateChange$",this._worksheetRuleInitStateChange.asObservable())}changeRuleInitState(t){this._worksheetRuleInitStateChange.next(t)}getSheetRuleInitState(){return this._worksheetRuleInitStateChange.value}addRule(t,e){this._ensureSubUnitMap(t).set(e.subUnitId,e),this._ruleChange.next({unitId:t,rule:e,type:"add",subUnitId:e.subUnitId})}deleteRule(t,e){var o,r,a;const n=(r=(o=this._model)==null?void 0:o.get(t))==null?void 0:r.get(e);n&&((a=this._model.get(t))==null||a.delete(e),this._ruleChange.next({unitId:t,rule:n,type:"delete",subUnitId:e}))}setRule(t,e,n){var r,a;const o=this.getRule(t,e);o&&((a=(r=this._model)==null?void 0:r.get(t))==null||a.set(e,n),this._ruleChange.next({unitId:t,oldRule:o,rule:n,type:"set",subUnitId:e}))}getRule(t,e){var n,o;return(o=(n=this._model)==null?void 0:n.get(t))==null?void 0:o.get(e)}toObject(){const t={};return[...this._model.keys()].forEach(n=>{const o=this._model.get(n);o!=null&&o.size&&(t[n]=[],[...o.keys()].forEach(a=>{const u=o.get(a);u&&t[n].push(u)}))}),t}fromObject(t){const e=new Map;Object.keys(t).forEach(n=>{const o=t[n];if(o!=null&&o.length){const r=new Map;o.forEach(a=>{r.set(a.subUnitId,a)}),e.set(n,r)}}),this._model=e}deleteUnitModel(t){this._model.delete(t)}_ensureSubUnitMap(t){let e=this._model.get(t);return e||(e=new Map,this._model.set(t,e)),e}ruleRefresh(t){this._ruleRefresh.next(t)}resetOrder(){this._resetOrder.next(Math.random())}getTargetByPermissionId(t,e){const n=this._model.get(t);if(!n)return null;for(const[o,r]of n)if(r.permissionId===e)return[t,o]}}class Ns{constructor(t,e,n){f(this,"type",D.SelectRange);f(this,"subType",_.Delete);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${D.SelectRange}.${_.Delete}.${n}`}}class Os{constructor(t,e,n){f(this,"type",D.SelectRange);f(this,"subType",_.ManageCollaborator);f(this,"status",i.PermissionStatus.INIT);f(this,"value",!0);f(this,"id");f(this,"unitId");f(this,"subUnitId");f(this,"permissionId");this.unitId=t,this.subUnitId=e,this.permissionId=n,this.id=`${D.SelectRange}.${_.ManageCollaborator}.${n}`}}const le=()=>[un,Se,Os,Ns],je=[_.Edit,_.View,_.ManageCollaborator,_.Delete],rl=(s="unitId",t="subUnitId",e="permissionId")=>le().reduce((n,o)=>{const r=new o(s,t,e);return n[r.subType]=r.value,n},{}),_t=()=>[me,es,Yn,ss,Kn,Qn,dn,xn,Xn,mn,ln,Zn,ns,cn,Ho,os,ts,Jn,qo,zo,jo,Fo],br=[_.Edit,_.Print,_.Comment,_.View,_.Copy,_.Export,_.ManageCollaborator,_.CreateSheet,_.DeleteSheet,_.RenameSheet,_.HideSheet,_.Duplicate,_.Share,_.MoveSheet,_.CopySheet,_.RecoverHistory,_.ViewHistory,_.CreatePermissionObject,_.InsertRow,_.InsertColumn,_.DeleteRow,_.DeleteColumn],de=()=>[fe,Vt,gs,as],Ie=()=>[rs,is,us,ls,ds,cs,hs,ms,Rs,Cs,Wt,St,ft,Ss],fn=[_.Copy,_.DeleteColumn,_.DeleteRow,_.EditExtraObject,_.Filter,_.InsertColumn,_.InsertRow,_.InsertHyperlink,_.PivotTable,_.SetCellStyle,_.SetCellValue,_.SetColumnStyle,_.SetRowStyle,_.Sort];var il=Object.getOwnPropertyDescriptor,al=(s,t,e,n)=>{for(var o=n>1?void 0:n?il(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ge=(s,t)=>(e,n)=>t(e,n,s);const ul="SHEET_WORKSHEET_PROTECTION_PLUGIN",ll="SHEET_WORKSHEET_PROTECTION_POINT_PLUGIN";g.WorksheetPermissionService=class extends i.RxDisposable{constructor(t,e,n,o,r,a,u,l){super(),this._permissionService=t,this._univerInstanceService=e,this._injector=n,this._worksheetProtectionRuleModel=o,this._worksheetProtectionPointRuleModel=r,this._resourceManagerService=a,this._rangeProtectionRuleModel=u,this._logService=l,this._init(),this._initRuleChange(),this._initRuleSnapshot(),this._initPointSnapshot()}_init(){const t=e=>{const n=e.getUnitId(),o=r=>{const a=r.getSheetId();[...de(),...Ie()].forEach(u=>{const l=new u(n,a);this._permissionService.addPermissionPoint(l)}),this._logService.debug("[WorksheetPermissionService]","Initialization completed",n,a)};e.getSheets().forEach(r=>{o(r)}),e.sheetCreated$.subscribe(r=>{o(r)}),e.sheetDisposed$.subscribe(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(n,a).forEach(l=>{[...le()].forEach(d=>{const c=new d(n,a,l.permissionId);this._permissionService.deletePermissionPoint(c.id)})}),[...de(),...Ie()].forEach(l=>{const d=new l(n,a);this._permissionService.deletePermissionPoint(d.id)})})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(e=>{t(e)}),this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).pipe(kt.takeUntil(this.dispose$)).subscribe(t),this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).pipe(kt.takeUntil(this.dispose$)).subscribe(e=>{e.getSheets().forEach(n=>{const o=e.getUnitId(),r=n.getSheetId();de().forEach(a=>{const u=new a(o,r);this._permissionService.deletePermissionPoint(u.id)})})})}_initRuleChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(t=>{switch(t.type){case"add":break;case"delete":{de().forEach(e=>{const n=new e(t.unitId,t.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)});break}case"set":{de().forEach(e=>{const n=new e(t.unitId,t.subUnitId);this._permissionService.updatePermissionPoint(n.id,t.rule)});break}}}))}_initRuleSnapshot(){const t=()=>{const n=this._worksheetProtectionRuleModel.toObject();return JSON.stringify(n)},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t,parseJson:e,pluginName:ul,businesses:[an.UNIVER_SHEET],onLoad:(n,o)=>{this._worksheetProtectionRuleModel.fromObject(o),Object.keys(o).forEach(r=>{de().forEach(a=>{const u=new a(n,r);u.value=!1,this._permissionService.addPermissionPoint(u)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)},onUnLoad:n=>{const o=this._univerInstanceService.getUnit(n);o&&(o.getSheets().forEach(r=>{const a=r.getSheetId();[...de(),...Ie()].forEach(u=>{const l=new u(n,a);this._permissionService.deletePermissionPoint(l.id)})}),_t().forEach(r=>{const a=new r(n);this._permissionService.deletePermissionPoint(a.id)})),this._worksheetProtectionRuleModel.deleteUnitModel(n)}}))}_initPointSnapshot(){const t=()=>{const n=this._worksheetProtectionPointRuleModel.toObject();return JSON.stringify(n)},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t,parseJson:e,pluginName:ll,businesses:[an.UNIVER_SHEET],onLoad:(n,o)=>{this._worksheetProtectionPointRuleModel.fromObject(o),Object.keys(o).forEach(r=>{Ie().forEach(a=>{const u=new a(n,r);this._permissionService.addPermissionPoint(u)})})},onUnLoad:n=>{this._worksheetProtectionPointRuleModel.deleteUnitModel(n)}}))}},g.WorksheetPermissionService=al([Ge(0,i.Inject(i.IPermissionService)),Ge(1,i.Inject(i.IUniverInstanceService)),Ge(2,i.Inject(i.Injector)),Ge(3,i.Inject(ke)),Ge(4,i.Inject(yt)),Ge(5,i.Inject(i.IResourceManagerService)),Ge(6,i.Inject(X)),Ge(7,i.Inject(i.ILogService))],g.WorksheetPermissionService);const In={id:"sheet.mutation.set-worksheet-permission-points",type:i.CommandType.MUTATION,handler:(s,t)=>{const{rule:e}=t;return s.get(yt).addRule(e),!0}};var dl=Object.getOwnPropertyDescriptor,cl=(s,t,e,n)=>{for(var o=n>1?void 0:n?dl(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},jt=(s,t)=>(e,n)=>t(e,n,s);g.WorkbookPermissionService=class extends i.Disposable{constructor(e,n,o,r,a){super();f(this,"_unitPermissionInitStateChange",new O.BehaviorSubject(!1));f(this,"unitPermissionInitStateChange$",this._unitPermissionInitStateChange.asObservable());this._permissionService=e,this._univerInstanceService=n,this._rangeProtectionRuleModel=o,this._worksheetProtectionRuleModel=r,this._worksheetProtectionPointModel=a,this._init()}_init(){const e=n=>{const o=n.getUnitId();_t().forEach(r=>{const a=new r(o);this._permissionService.addPermissionPoint(a)})};this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(n=>{e(n)}),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{e(n)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(i.UniverInstanceType.UNIVER_SHEET).subscribe(n=>{const o=n.getUnitId();n.getSheets().forEach(r=>{const a=r.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(o,a).forEach(l=>{[...le()].forEach(d=>{const c=new d(o,a,l.permissionId);this._permissionService.deletePermissionPoint(c.id)})}),[...de(),...Ie()].forEach(l=>{const d=new l(o,a);this._permissionService.deletePermissionPoint(d.id)})}),_t().forEach(r=>{const a=new r(o);this._permissionService.deletePermissionPoint(a.id)}),this._rangeProtectionRuleModel.deleteUnitModel(o),this._worksheetProtectionPointModel.deleteUnitModel(o),this._worksheetProtectionRuleModel.deleteUnitModel(o)}))}changeUnitInitState(e){this._unitPermissionInitStateChange.next(e)}},g.WorkbookPermissionService=cl([jt(0,i.Inject(i.IPermissionService)),jt(1,i.Inject(i.IUniverInstanceService)),jt(2,i.Inject(X)),jt(3,i.Inject(ke)),jt(4,i.Inject(yt))],g.WorkbookPermissionService);var ml=Object.getOwnPropertyDescriptor,hl=(s,t,e,n)=>{for(var o=n>1?void 0:n?ml(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ne=(s,t)=>(e,n)=>t(e,n,s);g.SheetPermissionInitController=class extends i.Disposable{constructor(e,n,o,r,a,u,l,d,c,m){super();f(this,"_cmdBufferList",[]);f(this,"_isRangePermissionInitFinish",!1);f(this,"_isWorksheetPermissionInitFinish",!1);f(this,"_isWorkbookPermissionInitFinish",!1);this._univerInstanceService=e,this._permissionService=n,this._authzIoService=o,this._rangeProtectionRuleModel=r,this._worksheetProtectionRuleModel=a,this._userManagerService=u,this._worksheetProtectionPointRuleModel=l,this._workbookPermissionService=d,this._undoRedoService=c,this._commandService=m}initPermission(){this._initRangePermissionFromSnapshot(),this._initRangePermissionChange(),this._initWorksheetPermissionFromSnapshot(),this._initWorksheetPermissionChange(),this._initWorksheetPermissionPointsChange(),this._initWorkbookPermissionFromSnapshot(),this._initUserChange(),this._refreshPermissionByCollaCreate()}refreshRangeProtectPermission(){this._initRangePermissionFromSnapshot()}getIsPermissionInitFinish(){return this._isWorksheetPermissionInitFinish&&this._isRangePermissionInitFinish&&this._isWorkbookPermissionInitFinish}addCmdToBufferList(e){this._cmdBufferList.push(e)}_processCmdBufferList(){if(!(!this.getIsPermissionInitFinish()||this._cmdBufferList.length===0))for(const e of this._cmdBufferList)this._commandService.executeCommand(e.id,e.params,{onlyLocal:!0})}async _initRangePermissionFromSnapshot(){const e=async n=>{const o=[],r=n.getUnitId(),a=n.getSheets(),u=new Map;if(a.forEach(l=>{const d=l.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(r,d).forEach(c=>{u.set(c.permissionId,c),o.push({objectID:c.permissionId,unitID:r,objectType:D.SelectRange,actions:je})})}),!o.length){this._rangeProtectionRuleModel.changeRuleInitState(!0),this._isRangePermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList();return}this._authzIoService.batchAllowed(o).then(l=>{l.forEach(d=>{const c=u.get(d.objectID);c&&le().forEach(m=>{const h=new m(r,c.subUnitId,d.objectID),R=h.subType,C=d.actions.find(S=>S.action===R);(C==null?void 0:C.allowed)!==void 0&&this._permissionService.updatePermissionPoint(h.id,C.allowed)})}),this._rangeProtectionRuleModel.changeRuleInitState(!0),this._isRangePermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList()})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(n=>e(n))),this._rangeProtectionRuleModel.changeRuleInitState(!0)}_initRangePermissionChange(){this.disposeWithMe(this._rangeProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:D.SelectRange,actions:je}).then(n=>{le().forEach(o=>{if(e.type==="set"){const{rule:d,oldRule:c}=e;if(d.permissionId===(c==null?void 0:c.permissionId))return}const r=e.rule,a=new o(r.unitId,r.subUnitId,r.permissionId),u=a.subType,l=n.find(d=>d.action===u);l&&this._permissionService.updatePermissionPoint(a.id,l.allowed)}),this._rangeProtectionRuleModel.ruleRefresh(e.rule.permissionId)}):this._rangeProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId).length===0&&(this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId),[...Ie()].forEach(o=>{const r=new o(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(r.id,r.value)}))}))}async initWorkbookPermissionChange(e){var o;const n=e||((o=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:o.getUnitId());if(n)return this._authzIoService.allowed({objectID:n,objectType:D.Workbook,unitID:n,actions:br}).then(r=>{_t().forEach(a=>{const u=new a(n),l=u.subType,d=r.find(c=>c.action===l);d&&this._permissionService.updatePermissionPoint(u.id,d.allowed)}),this._isWorkbookPermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList()})}async _initWorkbookPermissionFromSnapshot(){await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(e=>this.initWorkbookPermissionChange(e.getUnitId()))),this._workbookPermissionService.changeUnitInitState(!0)}_initWorksheetPermissionChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{e.type!=="delete"?this._authzIoService.allowed({objectID:e.rule.permissionId,unitID:e.unitId,objectType:D.Worksheet,actions:je}).then(n=>{de().forEach(o=>{const r=new o(e.unitId,e.subUnitId),a=r.subType,u=n.find(l=>l.action===a);u&&this._permissionService.updatePermissionPoint(r.id,u.allowed)}),this._worksheetProtectionRuleModel.ruleRefresh(e.rule.permissionId)}):([...de(),...Ie()].forEach(n=>{const o=new n(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(o.id,!0)}),this._worksheetProtectionPointRuleModel.deleteRule(e.unitId,e.subUnitId))}))}_initWorksheetPermissionPointsChange(){this.disposeWithMe(this._worksheetProtectionPointRuleModel.pointChange$.subscribe(e=>{this._authzIoService.allowed({objectID:e.permissionId,unitID:e.unitId,objectType:D.Worksheet,actions:fn}).then(n=>{Ie().forEach(o=>{const r=new o(e.unitId,e.subUnitId),a=r.subType,u=n.find(l=>l.action===a);u&&this._permissionService.updatePermissionPoint(r.id,u.allowed)})})}))}async _initWorksheetPermissionFromSnapshot(){const e=async n=>{const o=[],r=n.getUnitId(),a=n.getSheets(),u=new Map;if(a.forEach(l=>{const d=l.getSheetId(),c=this._worksheetProtectionRuleModel.getRule(r,d);c&&(u.set(c.permissionId,c),o.push({objectID:c.permissionId,unitID:r,objectType:D.Worksheet,actions:je}));const m=this._worksheetProtectionPointRuleModel.getRule(r,d);m&&(u.set(m.permissionId,m),o.push({objectID:m.permissionId,unitID:r,objectType:D.Worksheet,actions:fn}))}),!o.length){this._worksheetProtectionRuleModel.changeRuleInitState(!0),this._isWorksheetPermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList();return}this._authzIoService.batchAllowed(o).then(l=>{l.forEach(d=>{const c=u.get(d.objectID);c&&[...de(),...Ie()].forEach(m=>{const h=new m(r,c.subUnitId),R=h.subType,C=d.actions.find(S=>S.action===R);(C==null?void 0:C.allowed)!==void 0&&this._permissionService.updatePermissionPoint(h.id,C.allowed)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0),this._isWorksheetPermissionInitFinish=!0,this.getIsPermissionInitFinish()&&this._processCmdBufferList()})};await Promise.all(this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).map(n=>e(n))),this._worksheetProtectionRuleModel.changeRuleInitState(!0),this.getIsPermissionInitFinish()&&this._processCmdBufferList()}_initUserChange(){this.disposeWithMe(this._userManagerService.currentUser$.pipe(O.skip(1)).subscribe(()=>{const e=this._permissionService.getAllPermissionPoint();this._permissionService.clearPermissionMap(),this._worksheetProtectionRuleModel.changeRuleInitState(!1),this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(o=>{const r=o.getUnitId();_t().forEach(a=>{let u=new a(r);e.has(u.id)&&(u=e.get(u.id)),this._permissionService.addPermissionPoint(u)}),o.getSheets().forEach(a=>{const u=a.getSheetId();[...de(),...Ie()].forEach(d=>{let c=new d(r,u);e.has(c.id)&&(c=e.get(c.id)),this._permissionService.addPermissionPoint(c)}),this._rangeProtectionRuleModel.getSubunitRuleList(r,u).forEach(d=>{le().forEach(c=>{let m=new c(r,u,d.permissionId);e.has(m.id)&&(m=e.get(m.id)),this._permissionService.addPermissionPoint(m)})})}),this._initWorkbookPermissionFromSnapshot(),this._initWorksheetPermissionFromSnapshot(),this._initRangePermissionFromSnapshot()})}))}refreshPermission(e,n){const o=this._worksheetProtectionRuleModel.getTargetByPermissionId(e,n);let r=!1;if(o){const[l,d]=o;this._authzIoService.allowed({objectID:n,unitID:e,objectType:D.Worksheet,actions:je}).then(c=>{let m="";de().forEach(h=>{var I;const R=new h(e,d),C=R.subType,S=c.find(v=>v.action===C);S&&(((I=this._permissionService.getPermissionPoint(R.id))==null?void 0:I.value)!==S.allowed&&(r=!0),this._permissionService.updatePermissionPoint(R.id,S.allowed),m+=`${S.action}_${S.allowed}`)}),this._worksheetProtectionRuleModel.ruleRefresh(`${n}_${m}`),r&&this._undoRedoService.clearUndoRedo(e)})}const a=this._worksheetProtectionPointRuleModel.getTargetByPermissionId(e,n);if(a){const[l,d]=a;this._authzIoService.allowed({objectID:n,unitID:e,objectType:D.Worksheet,actions:fn}).then(c=>{Ie().forEach(m=>{var S;const h=new m(e,d),R=h.subType,C=c.find(I=>I.action===R);C&&(((S=this._permissionService.getPermissionPoint(h.id))==null?void 0:S.value)!==C.allowed&&(r=!0),this._permissionService.updatePermissionPoint(h.id,C.allowed))}),r&&this._undoRedoService.clearUndoRedo(e)})}const u=this._rangeProtectionRuleModel.getTargetByPermissionId(e,n);if(u){const[l,d]=u;this._authzIoService.allowed({objectID:n,unitID:e,objectType:D.SelectRange,actions:je}).then(c=>{let m="";le().forEach(h=>{var I;const R=new h(e,d,n),C=R.subType,S=c.find(v=>v.action===C);S&&(((I=this._permissionService.getPermissionPoint(R.id))==null?void 0:I.value)!==S.allowed&&(r=!0),this._permissionService.updatePermissionPoint(R.id,S.allowed),m+=`${S.action}_${S.allowed}`)}),this._rangeProtectionRuleModel.ruleRefresh(`${n}_${m}`),r&&this._undoRedoService.clearUndoRedo(e)})}}_refreshPermissionByCollaCreate(){this.disposeWithMe(this._commandService.onCommandExecuted((e,n)=>{if(n!=null&&n.fromCollab&&(e.id===Ce.id||e.id===Le.id||e.id===In.id)){const o=e.params;this._undoRedoService.clearUndoRedo(o.unitId)}}))}},g.SheetPermissionInitController=hl([Ne(0,i.IUniverInstanceService),Ne(1,i.IPermissionService),Ne(2,i.IAuthzIoService),Ne(3,i.Inject(X)),Ne(4,i.Inject(ke)),Ne(5,i.Inject(i.UserManagerService)),Ne(6,i.Inject(yt)),Ne(7,i.Inject(g.WorkbookPermissionService)),Ne(8,i.Inject(i.IUndoRedoService)),Ne(9,i.Inject(i.ICommandService))],g.SheetPermissionInitController);const Le={id:"sheet.mutation.add-worksheet-protection",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(g.SheetPermissionInitController),n=s.get(ke);if(!e.getIsPermissionInitFinish())return e.addCmdToBufferList({id:Le.id,params:t}),!0;const{unitId:o,rule:r}=t;return n.addRule(o,r),!0}},ze={id:"sheet.mutation.delete-worksheet-protection",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(ke),n=s.get(g.SheetPermissionInitController);if(!n.getIsPermissionInitFinish())return n.addCmdToBufferList({id:ze.id,params:t}),!0;const{unitId:o,subUnitId:r}=t;return e.deleteRule(o,r),!0}},Er={type:i.CommandType.COMMAND,id:"sheet.command.add-worksheet-protection",async handler(s,t){if(!t)return!1;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{rule:o,unitId:r}=t,a=o.subUnitId;if(await e.executeCommand(Le.id,{unitId:r,rule:o,subUnitId:o.subUnitId})){const l=[{id:Le.id,params:{unitId:r,rule:o,subUnitId:o.subUnitId}}],d=[{id:ze.id,params:{unitId:r,subUnitId:a}}];n.pushUndoRedo({unitID:r,redoMutations:l,undoMutations:d})}return!0}},Tr={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-range-theme-style",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o}=t,r=io(s,t);return e.syncExecuteCommand(rt.id,t)?(n.pushUndoRedo({unitID:o,undoMutations:[{id:it.id,params:r}],redoMutations:[{id:rt.id,params:t}]}),!0):!1}},Ur={type:i.CommandType.COMMAND,id:"sheet.command.append-row",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o,subUnitId:r,cellValue:a,insertRowNums:u,insertColumnNums:l,maxRows:d,maxColumns:c}=t,m={unitId:o,subUnitId:r,cellValue:a},h=ce(s,m),R=[{id:F.id,params:m}],C=[{id:F.id,params:h}];if(u){const I={unitId:o,subUnitId:r,range:{startRow:d,endRow:d,startColumn:0,endColumn:c-1}},v=en(s,I);R.unshift({id:re.id,params:I}),C.push({id:ae.id,params:v})}if(l){const I={unitId:o,subUnitId:r,range:{startRow:0,endRow:d-1,startColumn:c,endColumn:c-1+l}},v=Nt(s,I);R.unshift({id:ie.id,params:I}),C.push({id:ne.id,params:v})}return i.sequenceExecute(R,e).result?(n.pushUndoRedo({unitID:o,undoMutations:C,redoMutations:R}),!0):!1}},vn={id:"sheet.command.clear-selection-content",type:i.CommandType.COMMAND,handler:(s,t)=>{var p;const e=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUndoRedoService),a=s.get(g.SheetInterceptorService),u=e.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!u)return!1;const l=(t==null?void 0:t.unitId)||u.getUnitId(),d=u.getActiveSheet();if(!d)return!1;const c=(t==null?void 0:t.subUnitId)||d.getSheetId(),m=(t==null?void 0:t.ranges)||((p=o.getCurrentSelections())==null?void 0:p.map(w=>w.range));if(!(m!=null&&m.length))return!1;const h=Dt(m,s,l,c),R={subUnitId:c,unitId:l,cellValue:Uo(h)},C=ce(s,R),S=a.onCommandExecute({id:vn.id}),I=[{id:F.id,params:R},...S.redos],v=[...S.undos,{id:F.id,params:C}];return i.sequenceExecute(I,n).result?(r.pushUndoRedo({unitID:l,undoMutations:v,redoMutations:I}),!0):!1}},Ds=(s,t)=>({subUnitId:t.sheet.id,unitId:t.unitId,subUnitName:t.sheet.name}),bt={id:"sheet.mutation.insert-sheet",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService),{sheet:n,index:o,unitId:r,styles:a}=t,u=e.getUniverSheetInstance(r);return u?(a&&u.addStyles(a),u.addWorksheet(n.id,o,n)):!1}},As={type:i.CommandType.COMMAND,id:"sheet.command.copy-sheet",handler:(s,t)=>{var w,y;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),a=s.get(i.LocaleService),u=P(o,t);if(!u)return!1;const{workbook:l,worksheet:d,unitId:c,subUnitId:m}=u,h=i.Tools.deepClone(d.getConfig());h.name=gl(l,a,h.name),h.id=i.generateRandomId();const C={index:l.getSheetIndex(d)+1,sheet:h,unitId:c},S=Ds(s,C),I=r.onCommandExecute({id:As.id,params:{unitId:c,subUnitId:m,targetSubUnitId:h.id}}),v=[...(w=I.preRedos)!=null?w:[],{id:bt.id,params:C},...I.redos],M=[...(y=I.preUndos)!=null?y:[],{id:Ze.id,params:S},...I.undos];return i.sequenceExecute(v,e).result?(n.pushUndoRedo({unitID:c,undoMutations:M,redoMutations:v}),!0):!1}};function gl(s,t,e){let n=`${e} ${t.t("sheets.tabs.sheetCopy","")}`,o=2;for(;s.checkSheetName(n);)n=`${e} ${t.t("sheets.tabs.sheetCopy",`${o}`)}`,o++;return n}const Pr={type:i.CommandType.COMMAND,id:"sheet.command.delete-range-protection",async handler(s,t){if(!t)return!1;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o,subUnitId:r,rule:a}=t,u={unitId:o,subUnitId:r,ruleIds:[a.id]};return await e.executeCommand(Te.id,u)&&n.pushUndoRedo({unitID:o,redoMutations:[{id:Te.id,params:u}],undoMutations:[{id:Ce.id,params:{unitId:o,subUnitId:r,rules:[a]}}]}),!0}},kr={type:i.CommandType.COMMAND,id:"sheet.command.delete-worksheet-protection",handler(s,t){if(!t)return!1;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{rule:o,unitId:r,subUnitId:a}=t;e.executeCommand(ze.id,{unitId:r,subUnitId:a});const u=[{id:ze.id,params:{unitId:r,subUnitId:a}}],l=[{id:Le.id,params:{unitId:r,rule:o,subUnitId:a}}];return n.pushUndoRedo({unitID:r,redoMutations:u,undoMutations:l}),!0}},Nr={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-range-theme-style",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o}=t,r=ao(s,t);return e.syncExecuteCommand(it.id,t)?(n.pushUndoRedo({unitID:o,undoMutations:[{id:rt.id,params:r}],redoMutations:[{id:it.id,params:t}]}),!0):!1}},Or={id:"sheet.command.insert-defined-name",type:i.CommandType.COMMAND,handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService);if(!t)return!1;const o={...t};return e.syncExecuteCommand(J.SetDefinedNameMutation.id,o)?(n.pushUndoRedo({unitID:t.unitId,undoMutations:[{id:J.RemoveDefinedNameMutation.id,params:o}],redoMutations:[{id:J.SetDefinedNameMutation.id,params:o}]}),!0):!1}},Dr={id:"sheet.command.insert-sheet",type:i.CommandType.COMMAND,handler:(s,t)=>{var I;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(i.LocaleService),a=Bn(o,{unitId:t==null?void 0:t.unitId});if(!a)return!1;const{unitId:u,workbook:l}=a;let d=l.getSheets().length;const c=t==null?void 0:t.sheet,m=c==null?void 0:c.id,h=i.mergeWorksheetSnapshotWithDefault(c||{});t?(d=(I=t.index)!=null?I:d,h.id=m||i.generateRandomId(),h.name=(c==null?void 0:c.name)||l.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`)):(h.id=i.generateRandomId(),h.name=l.generateNewSheetName(`${r.t("sheets.tabs.sheet")}`));const R={index:d,sheet:h,unitId:u},C=Ds(s,R);return e.syncExecuteCommand(bt.id,R)?(n.pushUndoRedo({unitID:u,undoMutations:[{id:Ze.id,params:C}],redoMutations:[{id:bt.id,params:R}]}),!0):!1}},Et={id:"sheet.mutation.register-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,rangeThemeStyleJson:n,themeName:o}=t,r=s.get(i.IUniverInstanceService),a=P(r),u=s.get(g.SheetRangeThemeModel);if(!a)return!1;const l=new We(o,n);return u.registerRangeThemeStyle(e,l),!0}},pn={id:"sheet.mutation.unregister-worksheet-range-theme-style",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,themeName:n}=t,o=s.get(i.IUniverInstanceService),r=P(o),a=s.get(g.SheetRangeThemeModel);return r?(a.unregisterRangeThemeStyle(e,n),!0):!1}},Ar={id:"sheet.command.register-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(s,t)=>{if(!t)return!1;const{unitId:e,rangeThemeStyle:n}=t,o=s.get(i.IUniverInstanceService),r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService);if(!P(o))return!1;const l={unitId:e,themeName:n.getName(),rangeThemeStyleJson:n.toJson()},d={unitId:e,themeName:n.getName()};return r.syncExecuteCommand(Et.id,l)&&a.pushUndoRedo({unitID:e,undoMutations:[{id:pn.id,params:d}],redoMutations:[{id:Et.id,params:l}]}),!0}},Ws={id:"sheet.command.remove-defined-name",type:i.CommandType.COMMAND,handler:(s,t)=>{var c,m;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetInterceptorService);if(!t)return!1;const r={...t},a=o.onCommandExecute({id:Ws.id,params:t}),u=[...(c=a.preRedos)!=null?c:[],{id:J.RemoveDefinedNameMutation.id,params:r},...a.redos],l=[...(m=a.preUndos)!=null?m:[],{id:J.SetDefinedNameMutation.id,params:r},...a.undos];return i.sequenceExecute(u,e)?(n.pushUndoRedo({unitID:t.unitId,undoMutations:l.filter(Boolean),redoMutations:u.filter(Boolean)}),!0):!1}},wn={id:"sheet.command.remove-sheet",type:i.CommandType.COMMAND,handler:(s,t)=>{var v,M;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetInterceptorService),a=P(o,t);if(!a)return!1;const{unitId:u,subUnitId:l,workbook:d,worksheet:c}=a;if(d.getSheets().length<=1)return!1;const m={subUnitId:l,unitId:u,subUnitName:c.getName()},h=rr(s,m),R=r.onCommandExecute({id:wn.id,params:{unitId:u,subUnitId:l}}),C=[...(v=R.preRedos)!=null?v:[],{id:Ze.id,params:m},...R.redos],S=[...(M=R.preUndos)!=null?M:[],{id:bt.id,params:h},...R.undos];return i.sequenceExecute(C,e).result?(n.pushUndoRedo({unitID:u,undoMutations:S,redoMutations:C}),!0):!1}},Wr={type:i.CommandType.COMMAND,id:"sheet.command.remove-worksheet-merge",handler:(s,t)=>{var N;const e=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(i.IUniverInstanceService),a=(t==null?void 0:t.ranges)||((N=e.getCurrentSelections())==null?void 0:N.map(W=>W.range));if(!(a!=null&&a.length))return!1;const u=P(r);if(!u)return!1;const{subUnitId:l,unitId:d,worksheet:c}=u,m={unitId:d,subUnitId:l,ranges:a},R=c.getConfig().mergeData.filter(W=>a.some(V=>i.Rectangle.intersects(V,W)));if(!R.length)return!1;const C=ue(s,m),S=e.getCurrentSelections();if(!(S!=null&&S.length))return!1;const I=i.Tools.deepClone(S),v=i.Tools.deepClone(S),M=v[v.length-1],{startRow:p,startColumn:w}=M.range;M.primary={startRow:p,startColumn:w,endRow:p,endColumn:w,actualRow:p,actualColumn:w,isMerged:!1,isMergedMainCell:!1};const y=Rl(c,R),b={unitId:d,subUnitId:l,cellValue:y.redoParams.getMatrix()},T={unitId:d,subUnitId:l,cellValue:y.undoParams.getMatrix()},U=[{id:G.id,params:C},{id:F.id,params:b},{id:q.id,params:{selections:v}}],k=[{id:j.id,params:C},{id:F.id,params:T},{id:q.id,params:{selections:I}}];return i.sequenceExecute(U,n)?(o.pushUndoRedo({unitID:d,undoMutations:k,redoMutations:U}),!0):!1}};function Rl(s,t){const e=new i.ObjectMatrix,n=new i.ObjectMatrix;return t.forEach(o=>{const{startRow:r,startColumn:a,endColumn:u,endRow:l}=o,d=s.getCellMatrix().getValue(r,a);if(d!=null&&d.s)for(let c=r;c<=l;c++)for(let m=a;m<=u;m++)(c!==r||m!==a)&&(e.setValue(c,m,{s:d.s}),n.setValue(c,m,null))}),{redoParams:e,undoParams:n}}class nt{constructor(){f(this,"_borderInfo",{type:i.BorderType.ALL,color:"#000000",style:i.BorderStyleTypes.THIN,activeBorderType:!1});f(this,"_borderInfo$",new O.BehaviorSubject(this._borderInfo));f(this,"borderInfo$",this._borderInfo$.asObservable())}dispose(){this._borderInfo$.complete()}setType(t){this._borderInfo.type=t,this.setActiveBorderType(!0),this._refresh()}setColor(t){this._borderInfo.color=t,this._refresh()}setStyle(t){this._borderInfo.style=t,this._refresh()}setActiveBorderType(t){this._borderInfo.activeBorderType=t}getBorderInfo(){return this._borderInfo}_refresh(){this._borderInfo$.next(this._borderInfo)}}function Mn(s,t){const{startRow:e,startColumn:n,endRow:o,endColumn:r}=s;for(let a=e;a<=o;a++)for(let u=n;u<=r;u++)t(a,u)}const Vs=(s,t,e,n)=>{const{mr:o,worksheet:r}=s;t.startRow<0||t.startColumn<0||Mn(t,(a,u)=>{var c,m;const l=r.getMergedCell(a,u);let d=e;if(l&&(e.bc_tr||e.ml_tr||e.bl_tr||e.tl_mr||e.tl_bc||e.tl_br)){if(n){const h=i.Tools.deepClone((c=o.getValue(l.startRow,l.startColumn))==null?void 0:c.s);d=h!=null&&h.bd?Object.assign(h.bd,e):e}o.setValue(l.startRow,l.startColumn,{s:{bd:d}})}else{if(n){const h=i.Tools.deepClone((m=o.getValue(a,u))==null?void 0:m.s);d=h!=null&&h.bd?Object.assign(h.bd,e):e}o.setValue(a,u,{s:{bd:d}})}})},Cl=s=>{const t={startRow:s.startRow-1,startColumn:s.startColumn,endRow:s.startRow-1,endColumn:s.endColumn},e={startRow:s.startRow,startColumn:s.startColumn-1,endRow:s.endRow,endColumn:s.startColumn-1},n={startRow:s.endRow+1,startColumn:s.startColumn,endRow:s.endRow+1,endColumn:s.endColumn},o={startRow:s.startRow,startColumn:s.endColumn+1,endRow:s.endRow,endColumn:s.endColumn+1},r={startRow:s.startRow,startColumn:s.startColumn,endRow:s.startRow,endColumn:s.endColumn},a={startRow:s.startRow,startColumn:s.startColumn,endRow:s.endRow,endColumn:s.startColumn},u={startRow:s.endRow,startColumn:s.startColumn,endRow:s.endRow,endColumn:s.endColumn},l={startRow:s.startRow,startColumn:s.endColumn,endRow:s.endRow,endColumn:s.endColumn};return{topRangeOut:t,leftRangeOut:e,bottomRangeOut:n,rightRangeOut:o,topRange:r,leftRange:a,bottomRange:u,rightRange:l}};function Sl(s,t,e){const{style:n,color:o,type:r}=s.getBorderInfo(),a=r===i.BorderType.TOP||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,u=r===i.BorderType.LEFT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,l=r===i.BorderType.BOTTOM||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,d=r===i.BorderType.RIGHT||r===i.BorderType.ALL||r===i.BorderType.OUTSIDE,c=r===i.BorderType.VERTICAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,m=r===i.BorderType.HORIZONTAL||r===i.BorderType.ALL||r===i.BorderType.INSIDE,h=r.indexOf("tlbr")>-1,R=r.indexOf("tlbc")>-1,C=r.indexOf("tlmr")>-1,S=r.indexOf("bltr")>-1,I=r.indexOf("mltr")>-1,v=r.indexOf("bctr")>-1,M=e[0],{topRangeOut:p,leftRangeOut:w,bottomRangeOut:y,rightRangeOut:b,topRange:T,leftRange:U,bottomRange:k,rightRange:E}=Cl(M),N=new i.ObjectMatrix,{worksheet:W,unitId:V,subUnitId:$}=t;return{worksheet:W,unitId:V,subUnitId:$,style:n,color:o,type:r,top:a,left:u,right:d,bottom:l,vertical:c,horizontal:m,tl_br:h,tl_bc:R,tl_mr:C,bl_tr:S,ml_tr:I,bc_tr:v,topRangeOut:p,leftRangeOut:w,bottomRangeOut:y,rightRangeOut:b,topRange:T,leftRange:U,bottomRange:k,rightRange:E,range:M,mr:N,borderStyle:{s:n,cl:{rgb:o}}}}const fl=s=>{const{range:t,mr:e,borderStyle:n,vertical:o,horizontal:r,worksheet:a}=s;o&&Mn(t,(u,l)=>{var c,m,h;const d=a.getMergedCell(u,l);if(d){const R=(c=e.getValue(d.startRow,d.startColumn))==null?void 0:c.s;d.startColumn!==t.startColumn&&e.setValue(u,l,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}else{if(l!==t.endColumn){const R=(m=e.getValue(u,l))==null?void 0:m.s;e.setValue(u,l,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{r:i.Tools.deepClone(n)}):{r:i.Tools.deepClone(n)}}})}if(l!==t.startColumn){const R=(h=e.getValue(u,l))==null?void 0:h.s;e.setValue(u,l,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{l:i.Tools.deepClone(n)}):{l:i.Tools.deepClone(n)}}})}}}),r&&Mn(t,(u,l)=>{var c,m,h;const d=a.getMergedCell(u,l);if(d){const R=(c=e.getValue(d.startRow,d.startColumn))==null?void 0:c.s;d.startRow!==t.startRow&&e.setValue(u,l,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}else{if(u!==t.endRow){const R=(m=e.getValue(u,l))==null?void 0:m.s;e.setValue(u,l,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{b:i.Tools.deepClone(n)}):{b:i.Tools.deepClone(n)}}})}if(u!==t.startRow){const R=(h=e.getValue(u,l))==null?void 0:h.s;e.setValue(u,l,{s:{bd:R!=null&&R.bd?Object.assign(R.bd,{t:i.Tools.deepClone(n)}):{t:i.Tools.deepClone(n)}}})}}})};function Il(s){const{borderStyle:t,tl_br:e,tl_bc:n,tl_mr:o,bl_tr:r,ml_tr:a,bc_tr:u}=s,l=(d,c,m)=>{Vs(s,d,c,m)};e&&l(s.range,{tl_br:i.Tools.deepClone(t)},!0),n&&l(s.range,{tl_bc:i.Tools.deepClone(t)},!0),o&&l(s.range,{tl_mr:i.Tools.deepClone(t)},!0),r&&l(s.range,{bl_tr:i.Tools.deepClone(t)},!0),a&&l(s.range,{ml_tr:i.Tools.deepClone(t)},!0),u&&l(s.range,{bc_tr:i.Tools.deepClone(t)},!0)}const vl=s=>{const{top:t,left:e,right:n,bottom:o,borderStyle:r,bottomRange:a,topRange:u,leftRange:l,rightRange:d,bottomRangeOut:c,topRangeOut:m,leftRangeOut:h,rightRangeOut:R}=s,C=(S,I,v)=>{Vs(s,S,I,v)};t&&(C(m,{b:null}),C(u,{t:i.Tools.deepClone(r)},!0)),o&&(C(c,{t:null}),C(a,{b:i.Tools.deepClone(r)},!0)),e&&(C(h,{r:null}),C(l,{l:i.Tools.deepClone(r)},!0)),n&&(C(R,{l:null}),C(d,{r:i.Tools.deepClone(r)},!0))},pl=s=>{const{range:t,worksheet:e,mr:n,top:o,bottom:r,left:a,right:u,vertical:l,horizontal:d,tl_br:c,tl_bc:m,tl_mr:h,bl_tr:R,ml_tr:C,bc_tr:S,topRange:I,bottomRange:v,leftRange:M,rightRange:p,topRangeOut:w,bottomRangeOut:y,leftRangeOut:b,rightRangeOut:T}=s,U=(k,E,N)=>{Vs(s,k,E,N)};!o&&!r&&!a&&!u&&!l&&!d&&!c&&!m&&!h&&!R&&!C&&!S&&(Mn(t,(k,E)=>{var W,V,$,L,Y,z,K,oe;const N=e.getMergedCell(k,E);if(N){if(N.endColumn!==t.endColumn){const H=(W=n.getValue(N.startRow,N.startColumn))==null?void 0:W.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{r:null}):{r:null}}})}if(N.startColumn!==t.startColumn){const H=(V=n.getValue(N.startRow,N.startColumn))==null?void 0:V.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{l:null}):{l:null}}})}if(N.endRow!==t.endRow){const H=($=n.getValue(N.startRow,N.startColumn))==null?void 0:$.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{b:null}):{b:null}}})}if(N.startRow!==t.startRow){const H=(L=n.getValue(N.startRow,N.startColumn))==null?void 0:L.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{t:null}):{t:null}}})}}else{if(E!==t.endColumn){const H=(Y=n.getValue(k,E))==null?void 0:Y.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{r:null}):{r:null}}})}if(E!==t.startColumn){const H=(z=n.getValue(k,E))==null?void 0:z.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{l:null}):{l:null}}})}if(k!==t.endRow){const H=(K=n.getValue(k,E))==null?void 0:K.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{b:null}):{b:null}}})}if(k!==t.startRow){const H=(oe=n.getValue(k,E))==null?void 0:oe.s;n.setValue(k,E,{s:{bd:H!=null&&H.bd?Object.assign(H.bd,{t:null}):{t:null}}})}}}),U(w,{b:null}),U(I,{t:null},!0),U(y,{t:null}),U(v,{b:null},!0),U(b,{r:null}),U(M,{l:null},!0),U(T,{l:null}),U(p,{r:null},!0),U(t,{tl_br:null},!0),U(t,{tl_bc:null},!0),U(t,{tl_mr:null},!0),U(t,{bl_tr:null},!0),U(t,{ml_tr:null},!0),U(t,{bc_tr:null},!0))},Tt={id:"sheet.command.set-border",type:i.CommandType.COMMAND,handler:(s,t)=>{var v;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=s.get(g.SheetsSelectionsService),a=s.get(nt),u=P(o,t);if(!u)return!1;const l=(t==null?void 0:t.ranges)||((v=r.getCurrentSelections())==null?void 0:v.map(M=>M.range));if(!(l!=null&&l.length))return!1;const{activeBorderType:d}=a.getBorderInfo();if(!d)return!1;const c=Sl(a,u,l);fl(c),vl(c),Il(c),pl(c);const{unitId:m,subUnitId:h,mr:R}=c,C={unitId:m,subUnitId:h,cellValue:R.getData()},S=ce(s,C);return e.syncExecuteCommand(F.id,C)?(n.pushUndoRedo({unitID:m,undoMutations:[{id:F.id,params:S}],redoMutations:[{id:F.id,params:C}]}),!0):!1}},Vr={id:"sheet.command.set-border-position",type:i.CommandType.COMMAND,handler:(s,t)=>{if(!t.value)return!1;const e=s.get(i.ICommandService);return s.get(nt).setType(t.value),e.syncExecuteCommand(Tt.id)}},$r={id:"sheet.command.set-border-style",type:i.CommandType.COMMAND,handler:(s,t)=>{const e=s.get(i.ICommandService);return s.get(nt).setStyle(t.value),e.syncExecuteCommand(Tt.id)}},Lr={id:"sheet.command.set-border-color",type:i.CommandType.COMMAND,handler:(s,t)=>{const e=s.get(i.ICommandService);return s.get(nt).setColor(t.value),e.syncExecuteCommand(Tt.id)}},Br={id:"sheet.command.set-border-basic",type:i.CommandType.COMMAND,handler:(s,t)=>{const{unitId:e,subUnitId:n,value:o,ranges:r}=t,{type:a,color:u,style:l}=o,d=s.get(i.ICommandService),c=s.get(nt);return c.setType(a),u&&c.setColor(u),c.setStyle(l),d.syncExecuteCommand(Tt.id,{unitId:e,subUnitId:n,ranges:r})}},Hr={type:i.CommandType.COMMAND,id:"sheet.command.set-col-data",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=P(o,t);if(!r)return!1;const{columnData:a}=t,{unitId:u,subUnitId:l,worksheet:d}=r,c={subUnitId:l,unitId:u,columnData:a},m=mo(c,d);return e.syncExecuteCommand(at.id,c)?(n.pushUndoRedo({unitID:u,undoMutations:[{id:at.id,params:m}],redoMutations:[{id:at.id,params:c}]}),!0):!1}},Ut={type:i.CommandType.COMMAND,id:"sheet.command.set-col-visible-on-cols",handler:(s,t)=>{var v,M;const{unitId:e,subUnitId:n,ranges:o}=t,r=s.get(g.SheetInterceptorService),a=s.get(i.ICommandService),u=s.get(i.IUniverInstanceService),l=P(u,{unitId:e,subUnitId:n});if(!l)return!1;const{worksheet:d}=l,c={unitId:e,subUnitId:n,ranges:o},m={unitId:e,subUnitId:n,reveal:!0,selections:o.map(p=>({range:p,primary:se(p,d),style:null}))},h=ga(s,c),R={unitId:e,subUnitId:n,selections:Fr(o).map(p=>({range:p,primary:se(p,d),style:null}))},C=i.sequenceExecute([{id:lt.id,params:c},{id:q.id,params:m}],a),S=r.onCommandExecute({id:Ut.id,params:t}),I=i.sequenceExecute([...S.redos],a);if(C.result&&I.result){const p=r.afterCommandExecute({id:Ut.id,params:t});return i.sequenceExecute(p.redos,a),s.get(i.IUndoRedoService).pushUndoRedo({unitID:e,undoMutations:[{id:ut.id,params:h},{id:q.id,params:R},...(v=S.undos)!=null?v:[],...p.undos],redoMutations:[...(M=S.preRedos)!=null?M:[],{id:lt.id,params:c},{id:q.id,params:m},...S.redos,...p.redos]}),!0}return!0}},$s={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-cols-visible",handler:s=>{var d;const t=s.get(g.SheetsSelectionsService),e=s.get(i.ICommandService),n=(d=t.getCurrentSelections())==null?void 0:d.map(c=>c.range).filter(c=>c.rangeType===i.RANGE_TYPE.COLUMN);if(!(n!=null&&n.length))return!1;const o=P(s.get(i.IUniverInstanceService));if(!o)return!1;const{worksheet:r,unitId:a,subUnitId:u}=o,l=n.map(c=>r.getHiddenCols(c.startColumn,c.endColumn)).flat();return e.executeCommand(Ut.id,{unitId:a,subUnitId:u,ranges:l})}},yn={type:i.CommandType.COMMAND,id:"sheet.command.set-col-hidden",handler:(s,t)=>{var M,p,w,y;const e=s.get(g.SheetsSelectionsService),n=s.get(g.SheetInterceptorService),o=s.get(i.IUniverInstanceService),r=s.get(i.ICommandService);let a=(M=t==null?void 0:t.ranges)!=null&&M.length?t.ranges:(p=e.getCurrentSelections())==null?void 0:p.map(b=>b.range).filter(b=>b.rangeType===i.RANGE_TYPE.COLUMN);if(!(a!=null&&a.length))return!1;const u=P(o,t);if(!u)return!1;const{worksheet:l,unitId:d,subUnitId:c}=u;a=wl(u.worksheet,a);const m={unitId:d,subUnitId:c,ranges:a},h={unitId:d,subUnitId:c,selections:Fr(a).map(b=>({range:b,primary:se(b,l),style:null}))},R=ha(s,m),C={unitId:d,subUnitId:c,reveal:!0,selections:a.map(b=>({range:b,primary:se(b,l),style:null}))},S=i.sequenceExecute([{id:ut.id,params:m},{id:q.id,params:h}],r),I=n.onCommandExecute({id:yn.id,params:m}),v=i.sequenceExecute([...I.redos],r);if(S.result&&v.result){const b=n.afterCommandExecute({id:yn.id,params:m});return i.sequenceExecute(b.redos,r),s.get(i.IUndoRedoService).pushUndoRedo({unitID:d,undoMutations:[{id:lt.id,params:R},{id:q.id,params:C},...(w=I.undos)!=null?w:[],...b.undos],redoMutations:[...(y=I.preRedos)!=null?y:[],{id:ut.id,params:m},{id:q.id,params:h},...I.redos,...b.redos]}),!0}return!1}};function wl(s,t){const e=s.getRowCount()-1,n=s.getHiddenCols(),o=[];return t.forEach(r=>{const a=n.filter(u=>u.startColumn>=r.startColumn&&u.endColumn<=r.endColumn);if(a.length){let u=r.startColumn;a.forEach(l=>{l.startColumn>u&&(o.push({startColumn:u,endColumn:l.startColumn-1,startRow:0,endRow:e}),u=l.endColumn+1)}),u<=r.endColumn&&o.push({startColumn:u,endColumn:r.endColumn,startRow:0,endRow:e})}else o.push(r)}),o}function Fr(s){return Ml(s).map(e=>{const n=e.startColumn===0?e.endColumn+1:e.startColumn-1;return{...e,startColumn:n,endColumn:n}})}function Ml(s){const t=[];let e;return s.sort((n,o)=>n.startColumn-o.startColumn).forEach(n=>{if(!e){e=n;return}e.endColumn===n.startColumn-1?e.endColumn=n.endColumn:(t.push(e),e=n)}),t.push(e),t}const Ls={id:"sheet.command.set-defined-name",type:i.CommandType.COMMAND,handler:(s,t)=>{var m,h;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetInterceptorService);if(!t)return!1;const r={...t},a=J.SetDefinedNameMutationFactory(s,t),u=o.onCommandExecute({id:Ls.id,params:t}),l=[...(m=u.preRedos)!=null?m:[],{id:J.RemoveDefinedNameMutation.id,params:a},{id:J.SetDefinedNameMutation.id,params:r},...u.redos],d=[...(h=u.preUndos)!=null?h:[],{id:J.RemoveDefinedNameMutation.id,params:r},{id:J.SetDefinedNameMutation.id,params:a},...u.undos];return i.sequenceExecute(l,e)?(n.pushUndoRedo({unitID:t.unitId,undoMutations:d.filter(Boolean),redoMutations:l.filter(Boolean)}),!0):!1}},Bs=(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(o==null)throw new Error("worksheet is null error!");const a=o.getConfig().freeze;return{unitId:t.unitId,subUnitId:t.subUnitId,...a}},Oe={id:"sheet.mutation.set-frozen",type:i.CommandType.MUTATION,handler:(s,t)=>{const n=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(n==null)throw new Error("universheet is null error!");const o=n.getSheetBySheetId(t.subUnitId);if(!o)return!1;const r=o.getConfig(),{startRow:a,startColumn:u,ySplit:l,xSplit:d}=t;return r.freeze={startRow:a,startColumn:u,ySplit:l,xSplit:d},!0}},jr={type:i.CommandType.COMMAND,id:"sheet.command.set-frozen",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=P(o,{unitId:t.unitId,subUnitId:t.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:u,worksheet:l}=r,{startColumn:d,startRow:c,xSplit:m,ySplit:h}=t;if(c>=l.getRowCount()||d>=l.getColumnCount()||m>=l.getColumnCount()||h>=l.getRowCount())return!1;const R={unitId:a,subUnitId:u,...t},C=Bs(s,R);return e.syncExecuteCommand(Oe.id,R)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:Oe.id,params:C}],redoMutations:[{id:Oe.id,params:R}]}),!0):!1}},Gr={type:i.CommandType.COMMAND,id:"sheet.command.cancel-frozen",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUniverInstanceService),o=s.get(i.IUndoRedoService),r=P(n,{unitId:t==null?void 0:t.unitId,subUnitId:t==null?void 0:t.subUnitId});if(!r)return!1;const{unitId:a,subUnitId:u}=r,l={unitId:a,subUnitId:u,startRow:-1,startColumn:-1,xSplit:0,ySplit:0},d=Bs(s,l);return e.syncExecuteCommand(Oe.id,l)&&o.pushUndoRedo({unitID:a,undoMutations:[{id:Oe.id,params:d}],redoMutations:[{id:Oe.id,params:l}]}),!0}},zr={type:i.CommandType.COMMAND,id:"sheet.command.set-gridlines-color",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=P(o);if(!r)return!1;const{worksheet:a}=r,u=a.getConfig().gridlinesColor;if(u===(t==null?void 0:t.color))return!1;const{unitId:l,subUnitId:d}=r,c={color:t==null?void 0:t.color,unitId:l,subUnitId:d},m={color:u,unitId:l,subUnitId:d};return e.syncExecuteCommand(dt.id,c)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:dt.id,params:m}],redoMutations:[{id:dt.id,params:c}]}),!0):!1}},Q={id:"sheet.mutation.set-range-protection",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,rule:o,ruleId:r}=t;return s.get(X).setRule(e,n,r,o),!0}},yl=(s,t)=>{const{unitId:e,subUnitId:n,ruleId:o}=t,a=s.get(X).getRule(e,n,o);return a?{id:Q.id,params:{...t,rule:a}}:null},st={id:"sheet.mutation.set-worksheet-protection",type:i.CommandType.MUTATION,handler:(s,t)=>{const{unitId:e,subUnitId:n,rule:o}=t;return s.get(ke).setRule(e,n,o),!0}},qr={type:i.CommandType.COMMAND,id:"sheet.command.set-protection",async handler(s,t){if(!t)return!1;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(X),{rule:r,oldRule:a}=t,{unitId:u,subUnitId:l}=r,d=[],c=[];return(a==null?void 0:a.unitType)===r.unitType?r.unitType===D.Worksheet?(d.push({id:st.id,params:{unitId:u,subUnitId:l,rule:r}}),c.push({id:st.id,params:{unitId:u,subUnitId:l,rule:a}})):(d.push({id:Q.id,params:{unitId:u,subUnitId:l,rule:r,ruleId:r.id}}),c.push({id:Q.id,params:{unitId:u,subUnitId:l,ruleId:a.id,rule:a}})):(a&&(a.unitType===D.Worksheet?(d.push({id:ze.id,params:{unitId:u,subUnitId:l}}),c.push({id:Le.id,params:{unitId:u,rule:a,subUnitId:a.subUnitId}})):a.unitType===D.SelectRange&&(d.push({id:Te.id,params:{unitId:u,subUnitId:l,ruleIds:[a.id]}}),c.push({id:Ce.id,params:{unitId:u,subUnitId:l,rules:[a]}}))),r.unitType===D.Worksheet?(d.push({id:Le.id,params:{unitId:u,rule:r,subUnitId:r.subUnitId}}),c.unshift({id:ze.id,params:{unitId:u,subUnitId:l}})):r.unitType===D.SelectRange&&(r.id=o.createRuleId(u,l),d.push({id:Ce.id,params:{unitId:u,subUnitId:l,rules:[r]}}),c.unshift({id:Te.id,params:{unitId:u,subUnitId:l,ruleIds:[r.id]}}))),i.sequenceExecute(d,e)&&n.pushUndoRedo({unitID:u,undoMutations:c,redoMutations:d}),!0}},Yr={type:i.CommandType.COMMAND,id:"sheet.command.set-row-data",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=P(o,t);if(!r)return!1;const{rowData:a}=t,{unitId:u,subUnitId:l,worksheet:d}=r,c={subUnitId:l,unitId:u,rowData:a},m=Ro(c,d);return e.syncExecuteCommand(ct.id,c)?(n.pushUndoRedo({unitID:u,undoMutations:[{id:ct.id,params:m}],redoMutations:[{id:ct.id,params:c}]}),!0):!1}},Pt={type:i.CommandType.COMMAND,id:"sheet.command.set-specific-rows-visible",handler:(s,t)=>{var v,M,p;const{unitId:e,subUnitId:n,ranges:o}=t,r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),u=s.get(g.SheetInterceptorService),l=P(s.get(i.IUniverInstanceService),{unitId:e,subUnitId:n});if(!l)return!1;const{worksheet:d}=l,c={unitId:e,subUnitId:n,ranges:o},m={unitId:e,subUnitId:n,reveal:!0,selections:o.map(w=>({range:w,primary:se(w,d),style:null}))},h=ya(s,c),R={unitId:e,subUnitId:n,selections:Kr(o).map(w=>({range:w,primary:se(w,d),style:null}))},C=i.sequenceExecute([{id:Ke.id,params:c},{id:q.id,params:m}],r),S=u.onCommandExecute({id:Pt.id,params:t}),I=i.sequenceExecute([...S.redos],r);if(C.result&&I.result){const w=u.afterCommandExecute({id:Pt.id,params:t});return i.sequenceExecute(w.redos,r),a.pushUndoRedo({unitID:e,undoMutations:[...(v=S.preUndos)!=null?v:[],{id:Je.id,params:h},{id:q.id,params:R},...(M=S.undos)!=null?M:[],...w.undos],redoMutations:[...(p=S.preRedos)!=null?p:[],{id:Ke.id,params:c},{id:q.id,params:m},...S.redos,...w.redos]}),!0}return!0}},Hs={type:i.CommandType.COMMAND,id:"sheet.command.set-selected-rows-visible",handler:async s=>{var c;const t=s.get(g.SheetsSelectionsService),e=s.get(i.IUniverInstanceService),n=s.get(i.ICommandService),o=(c=t.getCurrentSelections())==null?void 0:c.map(m=>m.range).filter(m=>m.rangeType===i.RANGE_TYPE.ROW);if(!(o!=null&&o.length))return!1;const r=P(e);if(!r)return!1;const{worksheet:a,unitId:u,subUnitId:l}=r,d=o.map(m=>a.getHiddenRows(m.startRow,m.endRow)).flat();return n.executeCommand(Pt.id,{unitId:u,subUnitId:l,ranges:d})}},_n={type:i.CommandType.COMMAND,id:"sheet.command.set-rows-hidden",handler:(s,t)=>{var M,p,w,y,b,T;const e=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(i.IUniverInstanceService),a=s.get(g.SheetInterceptorService);let u=(M=t==null?void 0:t.ranges)!=null&&M.length?t.ranges:(p=e.getCurrentSelections())==null?void 0:p.map(U=>U.range).filter(U=>U.rangeType===i.RANGE_TYPE.ROW);if(!(u!=null&&u.length))return!1;const l=P(r,t);if(!l)return!1;u=_l(l.worksheet,u);const{unitId:d,subUnitId:c,worksheet:m}=l,h={unitId:d,subUnitId:c,ranges:u},R={unitId:d,subUnitId:c,selections:Kr(u).map(U=>({range:U,primary:se(U,m),style:null}))},C=_a(s,h),S={unitId:d,subUnitId:c,reveal:!0,selections:u.map(U=>({range:U,primary:se(U,m),style:null}))},I=a.onCommandExecute({id:_n.id,params:h});if(i.sequenceExecute([...(w=I.preRedos)!=null?w:[],{id:Je.id,params:h},{id:q.id,params:R},...I.redos],n).result){const U=a.afterCommandExecute({id:_n.id,params:h});return i.sequenceExecute(U.redos,n),o.pushUndoRedo({unitID:d,undoMutations:[...(y=I.preUndos)!=null?y:[],{id:Ke.id,params:C},{id:q.id,params:S},...(b=I.undos)!=null?b:[],...U.undos],redoMutations:[...(T=I.preRedos)!=null?T:[],{id:Je.id,params:h},{id:q.id,params:R},...I.redos,...U.redos]}),!0}return!0}};function _l(s,t){const e=s.getMaxColumns()-1,n=s.getHiddenRows(),o=[];return t.forEach(r=>{const a=n.filter(u=>u.startRow>=r.startRow&&u.endRow<=r.endRow);if(a.length){let u=r.startRow;a.forEach(l=>{l.startRow>u&&(o.push({startRow:u,endRow:l.startRow-1,startColumn:0,endColumn:e}),u=l.endRow+1)}),u<=r.endRow&&o.push({startRow:u,endRow:r.endRow,startColumn:0,endColumn:e})}else o.push(r)}),o}function Kr(s){return bl(s).map(e=>{const n=e.startRow===0?e.endRow+1:e.startRow-1;return{...e,startRow:n,endRow:n}})}function bl(s){const t=[];let e;return s.sort((n,o)=>n.startRow-o.startRow).forEach(n=>{if(!e){e=n;return}n.startRow===e.endRow+1?e.endRow=n.endRow:(t.push(e),e=n)}),t.push(e),t}const El=["ff","fs","tr","tb"],ee={type:i.CommandType.COMMAND,id:"sheet.command.set-style",handler:(s,t)=>{var k;const e=s.get(i.IUniverInstanceService),n=P(e,t);if(!n)return!1;const{unitId:o,subUnitId:r,worksheet:a}=n,{range:u,style:l}=t,d=s.get(i.ICommandService),c=s.get(i.IUndoRedoService),m=s.get(g.SheetsSelectionsService),h=u?[u]:(k=m.getCurrentSelections())==null?void 0:k.map(E=>E.range);if(!(h!=null&&h.length))return!1;const R=new i.ObjectMatrix,C=uu(a);if(i.Tools.isArray(l.value))for(let E=0;E<h.length;E++)C.forOperableEach(h[E],(N,W,V)=>{R.setValue(N,W,{s:{[l.type]:l.value[N-V.startRow][W-V.startColumn]}})});else for(let E=0;E<h.length;E++){const N={s:{[l.type]:l.value}};C.forOperableEach(h[E],(W,V)=>R.setValue(W,V,N))}const S={subUnitId:r,unitId:o,cellValue:R.getMatrix()},I=s.get(g.SheetSkeletonService).getSkeleton(o,r),v=ce(s,S),M=d.syncExecuteCommand(F.id,S),p=s.get(g.SheetInterceptorService);let w=[],y=[];if(El.includes(t==null?void 0:t.style.type)){const{suitableRanges:E,remainingRanges:N}=Bt(h,I),W=_s(E,a),{undos:V,redos:$}=p.generateMutationsOfAutoHeight({unitId:o,subUnitId:r,ranges:E,autoHeightRanges:E,lazyAutoHeightRanges:N,cellHeights:W});w=V,y=$}const{undos:b,redos:T}=p.onCommandExecute({id:ee.id,params:t}),U=i.sequenceExecute([...T,...y],d);return M&&U.result?(c.pushUndoRedo({unitID:S.unitId,undoMutations:[{id:F.id,params:v},...b,...w],redoMutations:[{id:F.id,params:S},...T,...y]}),!0):!1}},Tl={type:i.CommandType.COMMAND,id:"sheet.command.set-bold",handler:s=>{const t=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(s.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e,{actualRow:o,actualColumn:r}=t.primary,u={style:{type:"bl",value:n.getRange(o,r).getFontWeight()===i.FontWeight.BOLD?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return s.get(i.ICommandService).syncExecuteCommand(ee.id,u)}},Ul={type:i.CommandType.COMMAND,id:"sheet.command.set-italic",handler:s=>{const t=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(s.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let o=!0;if(t.primary){const{startRow:a,startColumn:u}=t.primary;o=n.getRange(a,u).getFontStyle()===i.FontItalic.ITALIC}const r={style:{type:"it",value:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}};return s.get(i.ICommandService).syncExecuteCommand(ee.id,r)}},Pl={type:i.CommandType.COMMAND,id:"sheet.command.set-underline",handler:s=>{const t=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(s.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let o=!0;t.primary&&(o=!!n.getRange(t.primary.startRow,t.primary.startColumn).getUnderline().s);const r={style:{type:"ul",value:{s:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return s.get(i.ICommandService).syncExecuteCommand(ee.id,r)}},kl={type:i.CommandType.COMMAND,id:"sheet.command.set-stroke",handler:s=>{const t=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(s.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let o=!0;t.primary&&(o=!!n.getRange(t.primary.actualRow,t.primary.actualColumn).getStrikeThrough().s);const r={style:{type:"st",value:{s:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return s.get(i.ICommandService).syncExecuteCommand(ee.id,r)}},Nl={type:i.CommandType.COMMAND,id:"sheet.command.set-overline",handler:s=>{const t=s.get(g.SheetsSelectionsService).getCurrentLastSelection();if(!t)return!1;const e=P(s.get(i.IUniverInstanceService));if(!e)return!1;const{worksheet:n}=e;let o=!0;t.primary&&(o=!!n.getRange(t.primary.startRow,t.primary.startColumn).getOverline().s);const r={style:{type:"ol",value:{s:o?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE}}};return s.get(i.ICommandService).syncExecuteCommand(ee.id,r)}},Ol={type:i.CommandType.COMMAND,id:"sheet.command.set-font-family",handler:(s,t)=>{if(!t)return!1;const e=s.get(i.ICommandService),n={style:{type:"ff",value:t.value}};return e.syncExecuteCommand(ee.id,n)}},Dl={type:i.CommandType.COMMAND,id:"sheet.command.set-font-size",handler:(s,t)=>{if(!t)return!1;const e=s.get(i.ICommandService),n={style:{type:"fs",value:t.value}};return e.syncExecuteCommand(ee.id,n)}},Jr={type:i.CommandType.COMMAND,id:"sheet.command.set-text-color",handler:(s,t)=>{if(!t)return!1;const e=s.get(i.ICommandService),n={style:{type:"cl",value:{rgb:t.value}}};return e.syncExecuteCommand(ee.id,n)}},xr={type:i.CommandType.COMMAND,id:"sheet.command.reset-text-color",handler:s=>{const t=s.get(i.ICommandService),e={style:{type:"cl",value:{rgb:null}}};return t.syncExecuteCommand(ee.id,e)}},Xr={type:i.CommandType.COMMAND,id:"sheet.command.set-background-color",handler:(s,t)=>{if(!t||!t.value)return!1;const e=s.get(i.ICommandService),n={style:{type:"bg",value:{rgb:t.value}}};return e.syncExecuteCommand(ee.id,n)}},Zr={type:i.CommandType.COMMAND,id:"sheet.command.reset-background-color",handler:s=>{const t=s.get(i.ICommandService),e={style:{type:"bg",value:{rgb:null}}};return t.syncExecuteCommand(ee.id,e)}},Qr={type:i.CommandType.COMMAND,id:"sheet.command.set-vertical-text-align",handler:(s,t)=>{if(!t)return!1;const e=s.get(i.ICommandService),n={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"vt",value:t.value}};return e.syncExecuteCommand(ee.id,n)}},ei={type:i.CommandType.COMMAND,id:"sheet.command.set-horizontal-text-align",handler:(s,t)=>{if(!t)return!1;const e=s.get(i.ICommandService),n={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"ht",value:t.value}};return e.syncExecuteCommand(ee.id,n)}},ti={type:i.CommandType.COMMAND,id:"sheet.command.set-text-wrap",handler:(s,t)=>{if(!t)return!1;const e=s.get(i.ICommandService),n={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"tb",value:t.value}};return e.syncExecuteCommand(ee.id,n)}},ni={type:i.CommandType.COMMAND,id:"sheet.command.set-text-rotation",handler:(s,t)=>{if(!t)return!1;const e=typeof t.value=="number"?{a:t.value}:{a:0,v:i.BooleanNumber.TRUE},n=s.get(i.ICommandService),o={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"tr",value:e}};return n.syncExecuteCommand(ee.id,o)}},Al=(s,t)=>{const r=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().tabColor;return{...i.Tools.deepClone(t),color:r}},Gt={id:"sheet.mutation.set-tab-color",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getSheetBySheetId(t.subUnitId);return n?(n.getConfig().tabColor=t.color,!0):!1}},si={type:i.CommandType.COMMAND,id:"sheet.command.set-tab-color",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=P(s.get(i.IUniverInstanceService));if(!o)return!1;const{unitId:r,subUnitId:a}=o,u={color:t.value,unitId:r,subUnitId:a},l=Al(s,u);return e.syncExecuteCommand(Gt.id,u)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:Gt.id,params:l}],redoMutations:[{id:Gt.id,params:u}]}),!0):!1}},Fs={id:"sheet.mutation.set-workbook-name",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService).getUnit(t.unitId,i.UniverInstanceType.UNIVER_SHEET);return e?(e.setName(t.name),!0):!1}},js={type:i.CommandType.COMMAND,id:"sheet.command.set-workbook-name",handler:(s,t)=>{var l;const e=s.get(i.ICommandService),n=s.get(g.SheetInterceptorService);if(!Bn(s.get(i.IUniverInstanceService),t))return!1;const r=n.onCommandExecute({id:js.id,params:t}),a={name:t.name,unitId:t.unitId},u=[...(l=r.preRedos)!=null?l:[],{id:Fs.id,params:a},...r.redos];return i.sequenceExecute(u,e).result}},Wl=4,Gs={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-activate",handler:(s,t,e)=>{const n=s.get(i.ICommandService),o=P(s.get(i.IUniverInstanceService),t);if(!o)return!1;const{unitId:r,subUnitId:a}=o;return new Promise(u=>{setTimeout(()=>{const l=n.syncExecuteCommand(Ct.id,{unitId:r,subUnitId:a},e);u(l)},Wl)})}},zt={type:i.CommandType.COMMAND,id:"sheet.command.delta-column-width",handler:async(s,t)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections();if(!(n!=null&&n.length))return!1;const o=s.get(i.ICommandService),r=s.get(i.IUndoRedoService),a=P(s.get(i.IUniverInstanceService));if(!a)return!1;const{worksheet:u,unitId:l,subUnitId:d}=a,{anchorCol:c,deltaX:m}=t,R=u.getColumnWidth(c)+m,C=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,S=n.filter(L=>L.range.rangeType===i.RANGE_TYPE.COLUMN),I=C?i.RANGE_TYPE.ALL:S.some(({range:L})=>{const{startColumn:Y,endColumn:z}=L;return Y<=c&&c<=z})?i.RANGE_TYPE.COLUMN:i.RANGE_TYPE.NORMAL;let v;if(I===i.RANGE_TYPE.ALL){const L=u.getRowCount(),Y=new Array(u.getColumnCount()).fill(void 0).map((z,K)=>({startRow:0,endRow:L-1,startColumn:K,endColumn:K}));v={subUnitId:d,unitId:l,colWidth:R,ranges:Y}}else I===i.RANGE_TYPE.COLUMN?v={subUnitId:d,unitId:l,ranges:S.map(L=>i.Rectangle.clone(L.range)),colWidth:R}:v={subUnitId:d,unitId:l,colWidth:R,ranges:[{startRow:0,endRow:u.getMaxRows()-1,startColumn:c,endColumn:c}]};const M=s.get(g.SheetSkeletonService).getSkeleton(l,d),{suitableRanges:p,remainingRanges:w}=Bt(v.ranges,M);_s(p,u);const y=s.get(g.SheetInterceptorService),{undos:b,redos:T}=y.onCommandExecute({id:zt.id,params:v}),U=Hn(v,u),k=o.syncExecuteCommand(Ve.id,v),{undos:E,redos:N}=y.generateMutationsOfAutoHeight({unitId:l,subUnitId:d,ranges:p,autoHeightRanges:p,lazyAutoHeightRanges:w}),{undos:W,redos:V}=s.get(g.SheetInterceptorService).afterCommandExecute({id:zt.id,params:v}),$=i.sequenceExecute([...T,...V,...N],o);return k&&$.result&&r.pushUndoRedo({unitID:l,undoMutations:[{id:Ve.id,params:U},...b,...W,...E],redoMutations:[{id:Ve.id,params:v},...T,...V,...N]}),!0}},qt={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-col-width",handler:(s,t)=>{var y,b,T,U;const e=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(g.SheetInterceptorService),a=(y=t==null?void 0:t.ranges)!=null&&y.length?t.ranges:(b=e.getCurrentSelections())==null?void 0:b.map(k=>k.range);if(!(a!=null&&a.length))return!1;const u=P(s.get(i.IUniverInstanceService),t);if(!u)return!1;const{subUnitId:l,unitId:d,worksheet:c}=u,m=s.get(g.SheetSkeletonService).getSkeleton(d,l),h={subUnitId:l,unitId:d,ranges:a,colWidth:t.value},{suitableRanges:R,remainingRanges:C}=Bt(h.ranges,m);_s(R,c);const S=Hn(h,c),I=n.syncExecuteCommand(Ve.id,h),{undos:v,redos:M}=r.generateMutationsOfAutoHeight({unitId:d,subUnitId:l,ranges:R,autoHeightRanges:R,lazyAutoHeightRanges:C}),p=r.onCommandExecute({id:qt.id,params:h}),w=i.sequenceExecute([...p.redos,...M],n);if(I&&w.result){const k=r.afterCommandExecute({id:qt.id,params:h});return i.sequenceExecute(k.redos,n),o.pushUndoRedo({unitID:d,undoMutations:[...(T=p.preUndos)!=null?T:[],{id:Ve.id,params:S},...p.undos,...k.undos,...v],redoMutations:[...(U=p.preRedos)!=null?U:[],{id:Ve.id,params:h},...p.redos,...k.redos,...M]}),!0}return!1}};i.CommandType.COMMAND;const oi={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-column-count",handler:(s,t)=>{const{unitId:e,subUnitId:n,columnCount:o}=t,r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),u=s.get(i.IUniverInstanceService);if(!P(u,t))return!1;const d={unitId:e,subUnitId:n,columnCount:o},c=Co(s,d);return r.syncExecuteCommand(mt.id,d)?(a.pushUndoRedo({unitID:e,undoMutations:[{id:mt.id,params:c}],redoMutations:[{id:mt.id,params:d}]}),!0):!1}},ri={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-default-style",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{unitId:o}=t,r=So(s,t);return e.syncExecuteCommand(ht.id,t)?(n.pushUndoRedo({unitID:o,undoMutations:[{id:ht.id,params:r}],redoMutations:[{id:ht.id,params:t}]}),!0):!1}},ii=(s,t)=>{const e=ve(s.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetHideMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{hidden:n.isSheetHidden(),unitId:t.unitId,subUnitId:n.getSheetId()}},qe={id:"sheet.mutation.set-worksheet-hidden",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(e==null)return!1;const n=e.getSheetBySheetId(t.subUnitId);return n?(n.getConfig().hidden=t.hidden,!0):!1}},ai={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-hidden",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.ErrorService),r=s.get(i.LocaleService),a=P(s.get(i.IUniverInstanceService),t);if(!a)return!1;const{workbook:u,worksheet:l,unitId:d,subUnitId:c}=a;if(l.getConfig().hidden===i.BooleanNumber.TRUE)return!1;const h={unitId:d,subUnitId:c,hidden:i.BooleanNumber.TRUE},R=ii(s,h);return u.getSheets().filter(v=>v.getConfig().hidden===i.BooleanNumber.FALSE).length===1?(o.emit(r.t("sheets.info.hideSheet")),!1):e.syncExecuteCommand(qe.id,h)?(n.pushUndoRedo({unitID:d,undoMutations:[{id:qe.id,params:R}],redoMutations:[{id:qe.id,params:h}]}),!0):!1}},Vl=(s,t)=>{const e=ve(s.get(i.IUniverInstanceService),t);if(!e)throw new Error("[SetWorksheetNameMutationFactory]: worksheet is null error!");const{worksheet:n}=e;return{unitId:t.unitId,name:n.getName(),subUnitId:n.getSheetId()}},Yt={id:"sheet.mutation.set-worksheet-name",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(e==null)return!1;const n=e.getSheetBySheetId(t.subUnitId);return n?(n.getConfig().name=t.name,!0):!1}},bn={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-name",handler:(s,t)=>{var C,S;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetInterceptorService),r=P(s.get(i.IUniverInstanceService),t);if(!r)return!1;const{unitId:a,subUnitId:u}=r,l={subUnitId:u,name:t.name,unitId:a},d=Vl(s,l),c=o.onCommandExecute({id:bn.id,params:t}),m=[...(C=c.preRedos)!=null?C:[],{id:Yt.id,params:l},...c.redos],h=[...(S=c.preUndos)!=null?S:[],{id:Yt.id,params:d},...c.undos];return i.sequenceExecute(m,e).result?(n.pushUndoRedo({unitID:a,undoMutations:h,redoMutations:m}),!0):!1}},$l=(s,t)=>({...i.Tools.deepClone(t),toOrder:t.fromOrder,fromOrder:t.toOrder}),Kt={id:"sheet.mutation.set-worksheet-order",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getConfig();return n.sheetOrder.splice(t.fromOrder,1),n.sheetOrder.splice(t.toOrder,0,t.subUnitId),!0}},zs={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-order",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=P(s.get(i.IUniverInstanceService),t);if(!o)return!1;const{workbook:r,unitId:a,subUnitId:u}=o,d={fromOrder:r.getConfig().sheetOrder.indexOf(u),toOrder:t.order,unitId:a,subUnitId:u},c=$l(s,d);return e.syncExecuteCommand(Kt.id,d)?(n.pushUndoRedo({unitID:a,undoMutations:[{id:Kt.id,params:c}],redoMutations:[{id:Kt.id,params:d}]}),!0):!1}},ui={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-permission-points",async handler(s,t){if(!t)return!1;const e=s.get(i.ICommandService),{rule:n}=t;return e.executeCommand(In.id,{rule:n,unitId:n.unitId,subUnitId:n.subUnitId}),!0}},li={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-protection",async handler(s,t){if(!t)return!1;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),{rule:o,permissionId:r,oldRule:a}=t,{unitId:u,subUnitId:l}=o,d={...o,permissionId:r};if(await e.executeCommand(st.id,{unitId:u,subUnitId:l,newRule:d})){const m=[{id:st.id,params:{unitId:u,subUnitId:l,newRule:d}}],h=[{id:st.id,params:{unitId:u,subUnitId:l,rule:a}}];n.pushUndoRedo({unitID:u,redoMutations:m,undoMutations:h})}return!0}},Ll=(s,t)=>{const r=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().rightToLeft;return{...i.Tools.deepClone(t),rightToLeft:r}},En={id:"sheet.mutation.set-worksheet-right-to-left",type:i.CommandType.MUTATION,handler:(s,t)=>{const e=s.get(i.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!e)return!1;const n=e.getSheetBySheetId(t.subUnitId);if(!n)return!1;const o=n.getConfig();return o.rightToLeft=t.rightToLeft,!0}},Bl={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-right-to-left",handler:async(s,t)=>{var m;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=P(s.get(i.IUniverInstanceService),t);if(!o)return!1;const{unitId:r,subUnitId:a}=o;let u=i.BooleanNumber.FALSE;t&&(u=(m=t.rightToLeft)!=null?m:i.BooleanNumber.FALSE);const l={rightToLeft:u,unitId:r,subUnitId:a},d=Ll(s,l);return e.syncExecuteCommand(En.id,l)?(n.pushUndoRedo({unitID:r,undoMutations:[{id:En.id,params:d}],redoMutations:[{id:En.id,params:l}]}),!0):!1}},di={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-row-count",handler:(s,t)=>{const{unitId:e,subUnitId:n,rowCount:o}=t,r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),u=s.get(i.IUniverInstanceService);if(!P(u,t))return!1;const d={unitId:e,subUnitId:n,rowCount:o},c=fo(s,d);return r.syncExecuteCommand(gt.id,d)?(a.pushUndoRedo({unitID:e,undoMutations:[{id:gt.id,params:c}],redoMutations:[{id:gt.id,params:d}]}),!0):!1}},Jt={type:i.CommandType.COMMAND,id:"sheet.command.delta-row-height",handler:async(s,t)=>{var k,E;const n=s.get(g.SheetsSelectionsService).getCurrentSelections(),o=s.get(g.SheetInterceptorService);if(!(n!=null&&n.length))return!1;const r=P(s.get(i.IUniverInstanceService));if(!r)return!1;const{worksheet:a,subUnitId:u,unitId:l}=r,{anchorRow:d,deltaY:c}=t,h=a.getRowHeight(d)+c,R=n.length===1&&n[0].range.rangeType===i.RANGE_TYPE.ALL,C=n.filter(N=>N.range.rangeType===i.RANGE_TYPE.ROW),S=R?i.RANGE_TYPE.ALL:C.some(({range:N})=>{const{startRow:W,endRow:V}=N;return W<=d&&d<=V})?i.RANGE_TYPE.ROW:i.RANGE_TYPE.NORMAL;let I;if(S===i.RANGE_TYPE.ALL){const N=a.getColumnCount(),W=new Array(a.getRowCount()).fill(void 0).map((V,$)=>({startRow:$,endRow:$,startColumn:0,endColumn:N-1}));I={subUnitId:u,unitId:l,rowHeight:h,ranges:W}}else S===i.RANGE_TYPE.ROW?I={subUnitId:u,unitId:l,ranges:C.map(N=>i.Rectangle.clone(N.range)),rowHeight:h}:I={subUnitId:u,unitId:l,rowHeight:h,ranges:[{startRow:d,endRow:d,startColumn:0,endColumn:a.getMaxColumns()-1}]};const v=Io(I,a),M={unitId:l,subUnitId:u,ranges:I.ranges,autoHeightInfo:i.BooleanNumber.FALSE},p=Fn(M,a),w=s.get(i.ICommandService),y=s.get(i.IUndoRedoService),b=o.onCommandExecute({id:Jt.id,params:I}),T=i.sequenceExecute([{id:Ee.id,params:I},{id:Re.id,params:M}],w),U=i.sequenceExecute([...b.redos],w);if(T.result&&U.result){const N=o.afterCommandExecute({id:Jt.id,params:I});return i.sequenceExecute(N.redos,w),y.pushUndoRedo({unitID:l,undoMutations:[...(k=b.preUndos)!=null?k:[],{id:Ee.id,params:v},{id:Re.id,params:p},...b.undos,...N.undos],redoMutations:[...(E=b.preRedos)!=null?E:[],{id:Ee.id,params:I},{id:Re.id,params:M},...b.redos,...N.redos]}),!0}return!1}},xt={type:i.CommandType.COMMAND,id:"sheet.command.set-row-height",handler:(s,t)=>{var p,w,y,b;const e=s.get(g.SheetsSelectionsService),n=s.get(i.ICommandService),o=s.get(i.IUndoRedoService),r=s.get(i.IUniverInstanceService),a=s.get(g.SheetInterceptorService),u=(p=t==null?void 0:t.ranges)!=null&&p.length?t.ranges:(w=e.getCurrentSelections())==null?void 0:w.map(T=>T.range);if(!(u!=null&&u.length))return!1;const l=P(r,t);if(!l)return!1;const{unitId:d,subUnitId:c,worksheet:m}=l,h={subUnitId:c,unitId:d,ranges:u,rowHeight:t.value},R=Io(h,m),C={unitId:d,subUnitId:c,ranges:h.ranges,autoHeightInfo:i.BooleanNumber.FALSE},S=Fn(C,m),I=i.sequenceExecute([{id:Ee.id,params:h},{id:Re.id,params:C}],n),v=a.onCommandExecute({id:xt.id,params:h}),M=i.sequenceExecute([...v.redos],n);if(I.result&&M.result){const T=a.afterCommandExecute({id:xt.id,params:h});return i.sequenceExecute(T.redos,n),o.pushUndoRedo({unitID:d,undoMutations:[...(y=v.preRedos)!=null?y:[],{id:Ee.id,params:R},{id:Re.id,params:S},...v.undos,...T.undos],redoMutations:[...(b=v.preRedos)!=null?b:[],{id:Ee.id,params:h},{id:Re.id,params:C},...v.redos,...T.redos]}),!0}return!1}},Tn={type:i.CommandType.COMMAND,id:"sheet.command.set-row-is-auto-height",handler:(s,t)=>{var T,U;const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(g.SheetsSelectionsService),r=s.get(i.IUniverInstanceService),a=P(r,t);if(!a)return!1;const{unitId:u,subUnitId:l,worksheet:d}=a,c=(T=t==null?void 0:t.ranges)!=null&&T.length?t.ranges:(U=o.getCurrentSelections())==null?void 0:U.map(k=>k.range);if(!(c!=null&&c.length))return!1;const m={unitId:u,subUnitId:l,ranges:c,autoHeightInfo:i.BooleanNumber.TRUE},h=Fn(m,d),R=e.syncExecuteCommand(Re.id,m),C=s.get(g.SheetSkeletonService).getSkeleton(u,l),{suitableRanges:S,remainingRanges:I}=Bt(m.ranges,C),v=s.get(g.SheetInterceptorService),{undos:M,redos:p}=v.generateMutationsOfAutoHeight({unitId:u,subUnitId:l,ranges:S,autoHeightRanges:S,lazyAutoHeightRanges:I}),{undos:w,redos:y}=v.onCommandExecute({id:Tn.id,params:m}),b=i.sequenceExecute([...y,...p],e);return R&&b.result?(n.pushUndoRedo({unitID:u,undoMutations:[{id:Re.id,params:h},...w,...M],redoMutations:[{id:Re.id,params:m},...y,...p]}),!0):!1}},qs={type:i.CommandType.COMMAND,id:"sheet.command.set-worksheet-show",handler:(s,t)=>{const{unitId:e,subUnitId:n}=t,o=s.get(i.ICommandService),r=s.get(i.IUndoRedoService),a=s.get(i.IUniverInstanceService);if(!P(s.get(i.IUniverInstanceService)))return!1;const l=a.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return!1;const d=l.getSheetBySheetId(n);if(!d||d.getConfig().hidden===i.BooleanNumber.FALSE)return!1;const m={unitId:e,subUnitId:n,hidden:i.BooleanNumber.FALSE},h=ii(s,m),R=o.syncExecuteCommand(qe.id,m),C={unitId:e,subUnitId:n},S=o.syncExecuteCommand(Ct.id,C);return R&&S?(r.pushUndoRedo({unitID:e,undoMutations:[{id:qe.id,params:h}],redoMutations:[{id:qe.id,params:m}]}),!0):!1}},ci={type:i.CommandType.COMMAND,id:"sheet.command.split-text-to-columns",handler:(s,t)=>{const{unitId:e,subUnitId:n,range:o,delimiter:r,customDelimiter:a,treatMultipleDelimitersAsOne:u}=t,l=s.get(i.ICommandService),d=s.get(i.IUniverInstanceService),c=s.get(i.IUndoRedoService);if(!P(s.get(i.IUniverInstanceService)))return!1;const h=d.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!h)return!1;const R=h.getSheetBySheetId(n);if(!R)return!1;const{lastRow:C,rs:S,maxLength:I}=To(R,o,r,a,u),v=R.getColumnCount(),{startColumn:M}=i.Range.transformRange(o,R);if(o.startColumn!==o.endColumn)return!1;const p=[],w=[],y=M+I+1-v;if(y>0){const N={unitId:e,subUnitId:n,range:{startRow:0,endRow:R.getRowCount()-1,startColumn:v-1,endColumn:v-1+y}};p.push({id:ie.id,params:N});const W=Nt(s,N);w.push({id:ne.id,params:W})}const b={startRow:o.startRow,endRow:C,startColumn:M,endColumn:M+I},T=new i.ObjectMatrix;for(let N=b.startRow;N<=b.endRow;N++)for(let W=b.startColumn;W<=b.endColumn;W++){const V=S[N-b.startRow];W===0&&(V==null?void 0:V.length)===1?T.setValue(N,W,R.getCell(N,W)):T.setValue(N,W,{v:(V==null?void 0:V[W-b.startColumn])||null,p:null,f:null,si:null,custom:null})}const U={unitId:e,subUnitId:n,cellValue:T.clone()},k=ce(s,U);return p.push({id:F.id,params:U}),w.unshift({id:F.id,params:k}),i.sequenceExecute(p,l).result?(c.pushUndoRedo({unitID:e,undoMutations:w,redoMutations:p}),!0):!1}},mi={id:"sheet.command.toggle-cell-checkbox",type:i.CommandType.COMMAND,handler:(s,t)=>{if(!t)return!1;const{unitId:e,subUnitId:n,row:o,col:r,paragraphIndex:a}=t,l=s.get(i.IUniverInstanceService).getUnit(e,i.UniverInstanceType.UNIVER_SHEET),d=l==null?void 0:l.getSheetBySheetId(n),c=s.get(i.IUndoRedoService),m=s.get(i.ICommandService);if(!d)return!1;const h=d.getCell(o,r);if(!(h!=null&&h.p))return!1;const R=i.Tools.deepClone(h.p),C=new i.DocumentDataModel(R),S=i.BuildTextUtils.paragraph.bullet.toggleChecklist({document:C,paragraphIndex:a});if(!S)return!1;i.TextX.apply(C.getBody(),S.serialize());const I={unitId:e,subUnitId:n,cellValue:{[o]:{[r]:{p:R,t:i.CellValueType.STRING}}}},v={id:F.id,params:I},M=ce(s,I),p={id:F.id,params:M},w=[v],y=[p];return c.pushUndoRedo({redoMutations:w,undoMutations:y,unitID:e}),m.syncExecuteCommand(v.id,v.params)}},hi={type:i.CommandType.COMMAND,id:"sheet.command.toggle-gridlines",handler:(s,t)=>{const e=s.get(i.ICommandService),n=s.get(i.IUndoRedoService),o=s.get(i.IUniverInstanceService),r=P(o);if(!r)return!1;const{worksheet:a}=r,u=a.getConfig().showGridlines;if(u===(t==null?void 0:t.showGridlines))return!1;const{unitId:l,subUnitId:d}=r,c={showGridlines:u===i.BooleanNumber.TRUE?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE,unitId:l,subUnitId:d},m={showGridlines:u,unitId:l,subUnitId:d};return e.syncExecuteCommand(Rt.id,c)?(n.pushUndoRedo({unitID:l,undoMutations:[{id:Rt.id,params:m}],redoMutations:[{id:Rt.id,params:c}]}),!0):!1}},gi={id:"sheet.command.unregister-worksheet-range-theme-style",type:i.CommandType.COMMAND,handler:(s,t)=>{var h;if(!t)return!1;const{unitId:e,themeName:n}=t,o=s.get(i.IUniverInstanceService),r=s.get(i.ICommandService),a=s.get(i.IUndoRedoService),u=s.get(g.SheetRangeThemeModel);if(!P(o))return!1;const d={unitId:e,themeName:n},c={unitId:e,themeName:n,rangeThemeStyleJson:(h=u.getRangeThemeStyle(e,n))==null?void 0:h.toJson()};return r.syncExecuteCommand(Et.id,t)&&a.pushUndoRedo({unitID:e,undoMutations:[{id:Et.id,params:c}],redoMutations:[{id:pn.id,params:d}]}),!0}},Ri={id:"sheet.mutation.add-range-theme",type:i.CommandType.MUTATION,handler:(s,t)=>{if(!t)return!1;const{styleJSON:e,unitId:n}=t,o=s.get(g.SheetRangeThemeModel),r=new We(e.name);return r.fromJson(e),o.registerRangeThemeStyle(n,r),!0}},Ci={id:"sheet.mutation.empty",type:i.CommandType.MUTATION,handler:()=>!0},Si={id:"sheet.operation.mark-dirty-row-auto-height",type:i.CommandType.OPERATION,handler:()=>!0},fi={id:"sheet.operation.cancel-mark-dirty-row-auto-height",type:i.CommandType.OPERATION,handler:()=>!0},ot=i.createIdentifier("INumfmtService"),Hl=(s,t)=>{const e=s.get(ot),{values:n,unitId:o,subUnitId:r}=t,a=[],u=[];Object.keys(n).forEach(d=>{n[d].ranges.forEach(m=>{i.Range.foreach(m,(h,R)=>{const C=e.getValue(o,r,h,R);C?a.push({pattern:C.pattern,row:h,col:R}):u.push({startColumn:R,endColumn:R,startRow:h,endRow:h})})})});const l=[];if(a.length){const d=Pn(o,r,a);Object.keys(d.values).forEach(c=>{const m=d.values[c];m.ranges=zn(m.ranges)}),l.push({id:Un.id,params:Pn(o,r,a)})}return u.length&&l.push({id:Ys.id,params:{unitId:o,subUnitId:r,ranges:u}}),l},Un={id:"sheet.mutation.set.numfmt",type:i.CommandType.MUTATION,handler:(s,t)=>{if(!t)return!1;const{values:e,refMap:n}=t,o=s.get(ot),r=t.unitId,a=t.subUnitId,u=Object.keys(e).reduce((l,d)=>{const c=n[d],m=e[d].ranges;return c&&l.push({...c,ranges:m}),l},[]);return o.setValues(r,a,u),!0}},Ys={id:"sheet.mutation.remove.numfmt",type:i.CommandType.MUTATION,handler:(s,t)=>{if(!t)return!1;const{unitId:e,subUnitId:n,ranges:o}=t;return s.get(ot).deleteValues(e,n,o),!0}},Fl=(s,t)=>{const e=s.get(ot),{ranges:n,unitId:o,subUnitId:r}=t,a=[];if(n.forEach(l=>{i.Range.foreach(l,(d,c)=>{const m=e.getValue(o,r,d,c);m&&a.push({pattern:m.pattern,row:d,col:c})})}),!a.length)return[];const u=Pn(o,r,a);return Object.keys(u.values).forEach(l=>{const d=u.values[l];d.ranges=zn(d.ranges)}),[{id:Un.id,params:u}]},Pn=(s,t,e)=>{const n=Ya(e,"pattern"),o={},r={},a=Ka();return Object.keys(n).forEach(u=>{const l=n[u],d=a();o[d]={pattern:u},l.forEach(c=>{r[d]||(r[d]={ranges:[]}),r[d].ranges.push(i.cellToRange(c.row,c.col))})}),{unitId:s,subUnitId:t,refMap:o,values:r}},Ii={id:"sheet.mutation.remove-range-theme",type:i.CommandType.MUTATION,handler:(s,t)=>{if(!t)return!1;const{styleName:e,unitId:n}=t;return s.get(g.SheetRangeThemeModel).unregisterRangeThemeStyle(n,e),!0}},vi={id:"sheet.mutation.set-range-theme",type:i.CommandType.MUTATION,handler:(s,t)=>{if(!t)return!1;const{unitId:e,styleName:n,style:o}=t,a=s.get(g.SheetRangeThemeModel).getRangeThemeStyle(e,n);return a&&(o.headerRowStyle&&a.setHeaderRowStyle(o.headerRowStyle),o.firstRowStyle&&a.setFirstRowStyle(o.firstRowStyle),o.secondRowStyle&&a.setSecondRowStyle(o.secondRowStyle),o.lastRowStyle&&a.setLastRowStyle(o.lastRowStyle)),!0}},pi={id:"sheet.operation.scroll-to-cell",type:i.CommandType.OPERATION,handler:()=>!0},jl=(s,t,e)=>{const o=s.get(g.SheetsSelectionsService).getCurrentSelections(),{value:r,selections:a,unitId:u,subUnitId:l}=t;if(o){const c=o[(o==null?void 0:o.length)-1].primary;if(c){const{actualColumn:m,actualRow:h}=c;let{startRow:R,startColumn:C,endRow:S,endColumn:I}=a[a.length-1];if(r===i.Dimension.COLUMNS){const w=e.find(y=>y.startColumn===m&&y.endColumn===m&&h===y.startRow);w&&(I=w.endColumn,R=w.startRow,S=w.endRow)}else if(r===i.Dimension.ROWS){const w=e.find(y=>y.startRow===h&&y.endRow===h&&m===y.startColumn);w&&(S=w.endRow,C=w.startColumn,I=w.endColumn)}const v={startRow:R,startColumn:C,endRow:S,endColumn:I,actualRow:h,actualColumn:m,isMerged:!0,isMergedMainCell:R===h&&C===m},M=o.map((w,y,b)=>({range:w.range,style:null,primary:y===b.length-1?v:null})),p={unitId:u,subUnitId:l,type:te.ONLY_SET,selections:M};return{id:q.id,params:p}}return null}return null},Gl=(s,t)=>{const n=s.get(g.SheetsSelectionsService).getCurrentSelections(),{unitId:o,subUnitId:r}=t;if(n&&n[(n==null?void 0:n.length)-1].primary){const l={unitId:o,subUnitId:r,type:te.ONLY_SET,selections:[...n]};return{id:q.id,params:l}}return null},wi="maxCellsPerSheet",zl=3e6;var ql=Object.getOwnPropertyDescriptor,Yl=(s,t,e,n)=>{for(var o=n>1?void 0:n?ql(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Mi=(s,t)=>(e,n)=>t(e,n,s);const Kl="SHEET_DEFINED_NAME_PLUGIN",Jl="AllDefaultWorkbook";g.DefinedNameDataController=class extends i.Disposable{constructor(t,e){super(),this._definedNamesService=t,this._resourceManagerService=e,this._initialize()}_initialize(){this._initSnapshot()}_initSnapshot(){const t=n=>{const o=this._definedNamesService.getDefinedNameMap(n);return o?JSON.stringify(o):""},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:Kl,businesses:[i.UniverInstanceType.UNIVER_SHEET],toJson:n=>t(n),parseJson:n=>e(n),onUnLoad:n=>{this._definedNamesService.removeUnitDefinedName(n)},onLoad:(n,o)=>{this._definedNamesService.registerDefinedNames(n,o)}}))}},g.DefinedNameDataController=Yl([Mi(0,J.IDefinedNamesService),Mi(1,i.IResourceManagerService)],g.DefinedNameDataController);const yi="sheets.config",_i={};var xl=Object.getOwnPropertyDescriptor,Xl=(s,t,e,n)=>{for(var o=n>1?void 0:n?xl(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ks=(s,t)=>(e,n)=>t(e,n,s);const Zl=[Oe.id],Ql=[re.id,ie.id,ae.id,ne.id,pe.id,we.id];g.SheetsFreezeSyncController=class extends i.Disposable{constructor(e,n,o){var a,u;super();f(this,"_d",new i.DisposableCollection);f(this,"_enabled",!0);this._univerInstanceService=e,this._commandService=n,this._configService=o;const r=(u=(a=this._configService.getConfig(yi))==null?void 0:a.freezeSync)!=null?u:!0;this.setEnabled(r)}getEnabled(){return this._enabled}setEnabled(e){e?this._d.dispose():this._initOnlyLocalListener(),this._enabled=e}_initOnlyLocalListener(){this._d.add(this._commandService.beforeCommandExecuted((e,n)=>{Zl.includes(e.id)&&(n||(n={}),n.onlyLocal=!0)})),this._d.add(this._commandService.onCommandExecuted((e,n)=>{if(Ql.includes(e.id)&&(n!=null&&n.fromCollab)){const{id:o,params:r}=e;o===re.id?this._handleInsertRowMutation(r,n):o===ie.id?this._handleInsertColMutation(r,n):o===ae.id?this._handleRemoveRowMutation(r,n):o===ne.id?this._handleRemoveColMutation(r,n):o===pe.id?this._handleMoveRowsMutation(r,n):o===we.id&&this._handleMoveColsMutation(r,n)}}))}_handleInsertRowMutation(e,n){const{range:o,unitId:r,subUnitId:a}=e,u=this._getFreeze(r,a);if(u&&o.startRow<u.startRow){const l=o.endRow-o.startRow+1,d={...u,startRow:Math.max(1,u.startRow+l),ySplit:Math.max(1,u.ySplit+l)};this._sequenceExecute(r,a,d,n)}}_handleInsertColMutation(e,n){const{range:o,unitId:r,subUnitId:a}=e,u=this._getFreeze(r,a);if(u&&o.startColumn<u.startColumn){const l=o.endColumn-o.startColumn+1,d={...u,startColumn:Math.max(1,u.startColumn+l),xSplit:Math.max(1,u.xSplit+l)};this._sequenceExecute(r,a,d,n)}}_handleRemoveRowMutation(e,n){const{range:o,unitId:r,subUnitId:a}=e,u=this._getFreeze(r,a);if(u&&o.startRow<u.startRow){const l=Math.min(u.startRow,o.endRow+1)-o.startRow,d={...u,startRow:Math.max(1,u.startRow-l),ySplit:Math.max(1,u.ySplit-l)};this._sequenceExecute(r,a,d,n)}}_handleRemoveColMutation(e,n){const{range:o,unitId:r,subUnitId:a}=e,u=this._getFreeze(r,a);if(u&&o.startColumn<u.startColumn){const l=Math.min(u.startColumn,o.endColumn+1)-o.startColumn,d={...u,startColumn:Math.max(1,u.startColumn-l),xSplit:Math.max(1,u.xSplit-l)};this._sequenceExecute(r,a,d,n)}}_handleMoveRowsMutation(e,n){const{sourceRange:o,targetRange:r,unitId:a,subUnitId:u}=e,l=this._getFreeze(a,u);if(!l||l.startRow<=0||o.startRow>=l.startRow&&r.startRow>=l.startRow||o.endRow<l.startRow&&r.endRow<l.startRow)return;const d=o.endRow-o.startRow+1,c=Math.max(Math.min(l.startRow,o.endRow+1)-o.startRow,0),m={...l};r.startRow>=l.startRow?(m.startRow=Math.max(1,l.startRow-c),m.ySplit=Math.max(1,l.ySplit-c)):(m.startRow=l.startRow+d-c,m.ySplit=l.ySplit+d-c),this._sequenceExecute(a,u,m,n)}_handleMoveColsMutation(e,n){const{sourceRange:o,targetRange:r,unitId:a,subUnitId:u}=e,l=this._getFreeze(a,u);if(!l||l.startColumn<=0||o.startColumn>=l.startColumn&&r.startColumn>=l.startColumn||o.endColumn<l.startColumn&&r.endColumn<l.startColumn)return;const d=o.endColumn-o.startColumn+1,c=Math.max(Math.min(l.startColumn,o.endColumn+1)-o.startColumn,0),m={...l};r.startColumn>=l.startColumn?(m.startColumn=Math.max(1,l.startColumn-c),m.xSplit=Math.max(1,l.xSplit-c)):(m.startColumn=l.startColumn+d-c,m.xSplit=l.xSplit+d-c),this._sequenceExecute(a,u,m,n)}_getFreeze(e,n){const o=this._univerInstanceService.getUnit(e,i.UniverInstanceType.UNIVER_SHEET);if(!o)return null;const r=o.getSheetBySheetId(n);return r?r.getFreeze():null}_sequenceExecute(e,n,o,r){i.sequenceExecute([{id:Oe.id,params:{...o,unitId:e,subUnitId:n,resetScroll:!1}}],this._commandService,r)}},g.SheetsFreezeSyncController=Xl([Ks(0,i.Inject(i.IUniverInstanceService)),Ks(1,i.ICommandService),Ks(2,i.IConfigService)],g.SheetsFreezeSyncController);var ed=Object.getOwnPropertyDescriptor,td=(s,t,e,n)=>{for(var o=n>1?void 0:n?ed(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},De=(s,t)=>(e,n)=>t(e,n,s);g.SheetPermissionCheckController=class extends i.Disposable{constructor(e,n,o,r,a,u,l,d,c,m){super();f(this,"disposableCollection",new i.DisposableCollection);f(this,"_triggerPermissionUIEvent$",new O.Subject);f(this,"triggerPermissionUIEvent$",this._triggerPermissionUIEvent$.asObservable());this._commandService=e,this._univerInstanceService=n,this._permissionService=o,this._selectionManagerService=r,this._rangeProtectionRuleModel=a,this._worksheetProtectionRuleModel=u,this._localeService=l,this._lexerTreeBuilder=d,this._contextService=c,this._definedNamesService=m,this._initialize()}blockExecuteWithoutPermission(e){throw this._triggerPermissionUIEvent$.next(e),new i.CustomCommandExecutionError("have no permission")}_getPermissionCheck(e,n){let o=!0,r="";switch(e){case It.id:i.isICellData(n.value)&&n.value.f?(o=this._permissionCheckWithFormula(n),r=this._localeService.t("permission.dialog.formulaErr")):o=this._permissionCheckBySetRangeValue({workbookTypes:[me],rangeTypes:[Se],worksheetTypes:[Wt,fe]},n);break;case vn.id:o=this.permissionCheckWithRanges({workbookTypes:[me],rangeTypes:[Se],worksheetTypes:[Wt,fe]}),r=this._localeService.t("permission.dialog.editErr");break;case zt.id:case qt.id:o=this.permissionCheckWithoutRange({worksheetTypes:[St]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Jt.id:case xt.id:case Tn.id:o=this.permissionCheckWithoutRange({worksheetTypes:[ft]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case wt.id:case pt.id:o=this._permissionCheckByMoveCommand(n),r=this._localeService.t("permission.dialog.moveRowColErr");break;case xe.id:o=this._permissionCheckByMoveRangeCommand(n),r=this._localeService.t("permission.dialog.moveRangeErr");break;case zs.id:o=this._permissionCheckByWorksheetCommand([me,cn]),r=this._localeService.t("permission.dialog.operatorSheetErr"),o===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case bn.id:o=this._permissionCheckByWorksheetCommand([me,mn]),r=this._localeService.t("permission.dialog.operatorSheetErr"),o===!1&&this._worksheetProtectionRuleModel.resetOrder();break;case qs.id:{const{unitId:a,subUnitId:u}=n;o=this._permissionCheckByWorksheetCommand([me,ln],a,u),r=this._localeService.t("permission.dialog.operatorSheetErr"),o===!1&&this._worksheetProtectionRuleModel.resetOrder()}break;case Ut.id:o=this.permissionCheckWithRanges({workbookTypes:[me],rangeTypes:[Se],worksheetTypes:[fe,St]},n.ranges),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Pt.id:o=this.permissionCheckWithRanges({workbookTypes:[me],rangeTypes:[Se],worksheetTypes:[fe,ft]},n.ranges),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case $s.id:o=this.permissionCheckWithRanges({workbookTypes:[me],rangeTypes:[Se],worksheetTypes:[fe,St]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case Hs.id:o=this.permissionCheckWithRanges({workbookTypes:[me],rangeTypes:[Se],worksheetTypes:[fe,ft]}),r=this._localeService.t("permission.dialog.setRowColStyleErr");break;case vt.id:o=this._permissionCheckWithInsertRangeMove("right"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Xe.id:o=this._permissionCheckWithInsertRangeMove("bottom"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case He.id:o=this._permissionCheckWithInsertRangeMove("left"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break;case Fe.id:o=this._permissionCheckWithInsertRangeMove("top"),r=this._localeService.t("permission.dialog.insertOrDeleteMoveRangeErr");break}o||this.blockExecuteWithoutPermission(r)}_initialize(){this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{this._getPermissionCheck(e.id,e==null?void 0:e.params)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var n;if(e.id===Yt.id){const o=e.params,{unitId:r=(n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.getUnitId(),subUnitId:a}=o;if(!r||!a)return;const u=this._worksheetProtectionRuleModel.getRule(r,a),l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a);u&&this._worksheetProtectionRuleModel.ruleRefresh(u.permissionId),l.length&&this._rangeProtectionRuleModel.ruleRefresh(a)}}))}_permissionCheckWithInsertRangeMove(e){var c;const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,u=i.Tools.deepClone((c=this._selectionManagerService.getCurrentLastSelection())==null?void 0:c.range);return!(!u||(e==="top"||e==="bottom"?u.endRow=o.getRowCount()-1:(e==="left"||e==="right")&&(u.endColumn=o.getColumnCount()-1),this._rangeProtectionRuleModel.getSubunitRuleList(r,a).map(m=>m.ranges).flat().some(m=>i.Rectangle.getIntersects(u,m))))}_permissionCheckByWorksheetCommand(e,n,o){var c,m;const r=P(this._univerInstanceService,{unitId:n,subUnitId:o});if(!r)return!1;const{unitId:a,subUnitId:u}=r,l=this._worksheetProtectionRuleModel.getRule(a,u),d=this._rangeProtectionRuleModel.getSubunitRuleList(a,u).length>0;return l||d?(m=(c=this._permissionService.getPermissionPoint(new dn(a).id))==null?void 0:c.value)!=null?m:!1:this._permissionService.composePermission(e.map(h=>new h(a).id)).every(h=>h.value)}permissionCheckWithoutRange(e){var R,C,S,I;const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,u=this._selectionManagerService.getCurrentLastSelection();if(!u)return!0;const l=(C=(R=u==null?void 0:u.primary)==null?void 0:R.actualRow)!=null?C:0,d=(I=(S=u==null?void 0:u.primary)==null?void 0:S.actualColumn)!=null?I:0,{workbookTypes:c,worksheetTypes:m,rangeTypes:h}=e;return!(c&&c.some(M=>{var y,b;const p=new M(r);return((b=(y=this._permissionService.getPermissionPoint(p.id))==null?void 0:y.value)!=null?b:!1)===!1})===!0||m&&m.some(M=>{var y,b;const p=new M(r,a);return((b=(y=this._permissionService.getPermissionPoint(p.id))==null?void 0:y.value)!=null?b:!1)===!1})===!0||h&&h.some(M=>{var T,U,k,E,N;const p=(U=(T=o.getCell(l,d))==null?void 0:T.selectionProtection)==null?void 0:U[0];if(!(p!=null&&p.ruleId))return!1;const w=(k=this._rangeProtectionRuleModel.getRule(r,a,p.ruleId))==null?void 0:k.permissionId;if(!w)return!1;const y=new M(r,a,w);return((N=(E=this._permissionService.getPermissionPoint(y.id))==null?void 0:E.value)!=null?N:!1)===!1})===!0)}permissionCheckWithRanges(e,n,o,r){var C;const a=P(this._univerInstanceService);if(!a)return!1;const{workbook:u,worksheet:l}=a;o||(o=u.getUnitId()),r||(r=l.getSheetId());const d=n!=null?n:(C=this._selectionManagerService.getCurrentSelections())==null?void 0:C.map(S=>S.range);if(!d)return!1;const{workbookTypes:c,worksheetTypes:m,rangeTypes:h}=e,R=[];return c&&R.push(...c.map(S=>new S(o).id)),m&&R.push(...m.map(S=>new S(o,r).id)),h&&this._rangeProtectionRuleModel.getSubunitRuleList(o,r).forEach(S=>{d.some(v=>S.ranges.some(M=>i.Rectangle.intersects(M,v)))&&R.push(...h.map(v=>new v(o,r,S.permissionId).id))}),R.length?this._permissionService.composePermission(R).every(S=>S.value):!0}_permissionCheckByMoveCommand(e){const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,u=e.toRange;u.endRow===o.getRowCount()-1?u.endColumn=u.startColumn:u.endRow=u.startRow;const l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((d,c)=>[...d,...c.ranges],[]).filter(d=>i.Rectangle.intersects(d,u));return l.length>0?!1:(l.forEach(d=>{var c,m;for(let h=d.startRow;h<=d.endRow;h++)for(let R=d.startColumn;R<=d.endColumn;R++){const C=(m=(c=o.getCell(h,R))==null?void 0:c.selectionProtection)==null?void 0:m[0];if((C==null?void 0:C[_.Edit])===!1)return!1}}),!0)}_permissionCheckByMoveRangeCommand(e){const n=P(this._univerInstanceService);if(!n)return!1;const{worksheet:o,unitId:r,subUnitId:a}=n,u=e.toRange,l=this._rangeProtectionRuleModel.getSubunitRuleList(r,a).reduce((d,c)=>[...d,...c.ranges],[]).filter(d=>i.Rectangle.intersects(d,u));return l.length>0?!1:(l.forEach(d=>{var c,m;for(let h=d.startRow;h<=d.endRow;h++)for(let R=d.startColumn;R<=d.endColumn;R++){const C=(m=(c=o.getCell(h,R))==null?void 0:c.selectionProtection)==null?void 0:m[0];if((C==null?void 0:C[_.Edit])===!1)return!1}}),!0)}_permissionCheckBySetRangeValue(e,n){let o=[];n.range?o=[n.range]:o=[new i.ObjectMatrix(n.value).getDataRange()];const{unitId:r,subUnitId:a}=n;return this.permissionCheckWithRanges(e,o,r,a)}_permissionCheckWithFormula(e){var a,u,l,d,c;const n=e.value,o=e.range,r=n.f;if(r){const m=r.substring(1),h=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),R=(a=e.unitId)!=null?a:h.getUnitId(),C=this._definedNamesService.getValueByName(R,m);if(C){let S=C.formulaOrRefString;S.startsWith(J.operatorToken.EQUALS)&&(S=S.slice(1));const I=S.split(",");for(let v=0;v<I.length;v++){const M=I[v],p=J.deserializeRangeWithSheet(M);if(p.sheetName){const w=h.getSheetBySheetName(p.sheetName);if(!w)return!0;const{startRow:y,endRow:b,startColumn:T,endColumn:U}=p.range;for(let k=y;k<=b;k++)for(let E=T;E<=U;E++){const N=(l=(u=w.getCell(k,E))==null?void 0:u.selectionProtection)==null?void 0:l[0];if((N==null?void 0:N[_.View])===!1)return!1}}}return!0}else{const S=this._lexerTreeBuilder.sequenceNodesBuilder(r);if(!S)return!0;for(let I=0;I<S.length;I++){const v=S[I];if(typeof v=="string"||v.nodeType!==J.sequenceNodeType.REFERENCE)continue;const{token:M}=v,p=J.deserializeRangeWithSheetWithCache(M),w=p.unitId?this._univerInstanceService.getUnit(p.unitId):this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!w)return!0;let y=p.sheetName?w.getSheetBySheetName(p.sheetName):w.getActiveSheet();const b=w.getUnitId();if(p.sheetName){if(y=w.getSheetBySheetName(p.sheetName),!y)return!0;const N=y==null?void 0:y.getSheetId();if(!this._permissionService.getPermissionPoint(new Vt(b,N).id))return!1}if(!y)return!0;const{startRow:T,endRow:U,startColumn:k,endColumn:E}=p.range;for(let N=T;N<=U;N++)for(let W=k;W<=E;W++){const V=(c=(d=y.getCell(N,W))==null?void 0:d.selectionProtection)==null?void 0:c[0];if((V==null?void 0:V[_.View])===!1)return!1}}return!0}}if(o){const m=P(this._univerInstanceService);if(!m)return!1;const h=e.unitId||m.unitId,R=e.subUnitId||m.subUnitId,S=this._rangeProtectionRuleModel.getSubunitRuleList(h,R).filter(v=>v.ranges.some(M=>i.Rectangle.intersects(M,o))).map(v=>new Se(h,R,v.permissionId).id);if(!this._permissionService.composePermission(S).every(v=>v.value))return!1}return!0}},g.SheetPermissionCheckController=td([De(0,i.ICommandService),De(1,i.IUniverInstanceService),De(2,i.IPermissionService),De(3,i.Inject(g.SheetsSelectionsService)),De(4,i.Inject(X)),De(5,i.Inject(ke)),De(6,i.Inject(i.LocaleService)),De(7,i.Inject(J.LexerTreeBuilder)),De(8,i.IContextService),De(9,J.IDefinedNamesService)],g.SheetPermissionCheckController);var nd=Object.getOwnPropertyDescriptor,sd=(s,t,e,n)=>{for(var o=n>1?void 0:n?nd(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Js=(s,t)=>(e,n)=>t(e,n,s);g.ZebraCrossingCacheController=class extends i.Disposable{constructor(e,n,o){super();f(this,"_zebraCacheUpdateSubject",new O.Subject);this._commandService=e,this._sheetRangeThemeModel=n,this._univerInstanceService=o,this._init()}_init(){this._initializeCommandListener(),this._initTriggerCacheUpdateListener()}updateZebraCrossingCache(e,n){this._zebraCacheUpdateSubject.next({unitId:e,subUnitId:n})}_initializeCommandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{const{id:n}=e;let o,r;switch(n){case re.id:{const a=e.params;o=a.unitId,r=a.subUnitId}break;case Ke.id:{const a=e.params;o=a.unitId,r=a.subUnitId}break;case Je.id:{const a=e.params;o=a.unitId,r=a.subUnitId}break;case ae.id:{const a=e.params;o=a.unitId,r=a.subUnitId}break;case Ee.id:{const a=e.params;o=a.unitId,r=a.subUnitId}break}o&&r&&(this._sheetRangeThemeModel.refreshSheetRowVisibleFuncSet(o,r),this._sheetRangeThemeModel.refreshZebraCrossingCacheBySheet(o,r))}))}_initTriggerCacheUpdateListener(){this.disposeWithMe(this._zebraCacheUpdateSubject.subscribe(({unitId:e,subUnitId:n})=>{this._sheetRangeThemeModel.refreshSheetRowVisibleFuncSet(e,n),this._sheetRangeThemeModel.refreshZebraCrossingCacheBySheet(e,n)}))}},g.ZebraCrossingCacheController=sd([Js(0,i.Inject(i.ICommandService)),Js(1,i.Inject(g.SheetRangeThemeModel)),Js(2,i.Inject(i.IUniverInstanceService))],g.ZebraCrossingCacheController);var od=Object.getOwnPropertyDescriptor,rd=(s,t,e,n)=>{for(var o=n>1?void 0:n?od(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},bi=(s,t)=>(e,n)=>t(e,n,s);g.RangeProtectionRenderModel=class{constructor(t,e){f(this,"_cache",new i.LRUMap(1e4));this._selectionProtectionRuleModel=t,this._permissionService=e,this._init()}_init(){this._permissionService.permissionPointUpdate$.pipe(kt.filter(t=>t.type===D.SelectRange),kt.filter(t=>le().some(e=>t instanceof e)),kt.map(t=>t)).subscribe(t=>{const e=this._selectionProtectionRuleModel.getSubunitRuleList(t.unitId,t.subUnitId);for(const n of e)n.permissionId===t.permissionId&&n.ranges.forEach(o=>{i.Range.foreach(o,(r,a)=>{const u=this._createKey(t.unitId,t.subUnitId,r,a);this._cache.delete(u)})})}),this._selectionProtectionRuleModel.ruleChange$.subscribe(t=>{var e;t.rule.ranges.forEach(n=>{i.Range.foreach(n,(o,r)=>{const a=this._createKey(t.unitId,t.subUnitId,o,r);this._cache.delete(a)})}),t.type==="set"&&((e=t.oldRule)==null||e.ranges.forEach(n=>{i.Range.foreach(n,(o,r)=>{const a=this._createKey(t.unitId,t.subUnitId,o,r);this._cache.delete(a)})}))})}_createKey(t,e,n,o){return`${t}_${e}_${n}_${o}`}getCellInfo(t,e,n,o){const r=this._selectionProtectionRuleModel.getSubunitRuleList(t,e),a=[];if(!r||!r.length)return a;const u=this._createKey(t,e,n,o),l=this._cache.get(u);if(l)return l;const d=[];for(const c of r)if(c.ranges.some(m=>m.startRow<=n&&m.endRow>=n&&m.startColumn<=o&&m.endColumn>=o)){const m=le().reduce((h,R)=>{var I;const C=new R(t,e,c.permissionId),S=this._permissionService.getPermissionPoint(C.id);return h[C.subType]=(I=S==null?void 0:S.value)!=null?I:C.value,h},{});d.push({...m,ruleId:c.id,ranges:c.ranges})}return this._cache.set(u,d),d}clear(){this._cache.clear()}},g.RangeProtectionRenderModel=rd([bi(0,i.Inject(X)),bi(1,i.Inject(i.IPermissionService))],g.RangeProtectionRenderModel);var id=Object.getOwnPropertyDescriptor,ad=(s,t,e,n)=>{for(var o=n>1?void 0:n?id(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},xs=(s,t)=>(e,n)=>t(e,n,s);g.RangeProtectionCache=class extends i.Disposable{constructor(e,n,o){super();f(this,"_cellRuleCache",new Map);f(this,"_permissionIdCache",new Map);f(this,"_cellInfoCache",new Map);f(this,"_rowInfoCache",new Map);f(this,"_colInfoCache",new Map);this._ruleModel=e,this._permissionService=n,this._univerInstanceService=o,this._initUpdateCellRuleCache(),this._initUpdateCellInfoCache(),this._initUpdateRowColInfoCache(),this._initCache()}_initCache(){this._univerInstanceService.getAllUnitsForType(i.UniverInstanceType.UNIVER_SHEET).forEach(e=>{e.getSheets().forEach(n=>{const o=e.getUnitId(),r=n.getSheetId();this.reBuildCache(o,r)})})}_initUpdateCellInfoCache(){this._permissionService.permissionPointUpdate$.pipe(O.filter(e=>e.type===D.SelectRange),O.map(e=>e)).subscribe(e=>{const{subUnitId:n,unitId:o,permissionId:r}=e,a=this._permissionIdCache.get(r);if(!a)return;const u=this._ruleModel.getRule(o,n,a);if(!u)return;const l=this._ensureCellInfoMap(o,n);u.ranges.forEach(d=>{const{startRow:c,endRow:m,startColumn:h,endColumn:R}=d;for(let C=c;C<=m;C++)for(let S=h;S<=R;S++)l.delete(`${C}-${S}`)})}),this._ruleModel.ruleChange$.subscribe(e=>{var a;const{unitId:n,subUnitId:o}=e,r=this._ensureCellInfoMap(n,o);e.rule.ranges.forEach(u=>{i.Range.foreach(u,(l,d)=>{r.delete(`${l}-${d}`)})}),e.type==="set"&&((a=e.oldRule)==null||a.ranges.forEach(u=>{i.Range.foreach(u,(l,d)=>{this._cellInfoCache.delete(`${l}-${d}`)})}))})}_initUpdateCellRuleCache(){this._ruleModel.ruleChange$.subscribe(e=>{const{type:n}=e;n==="add"?this._addCellRuleCache(e):n==="delete"?this._deleteCellRuleCache(e):(this._deleteCellRuleCache({...e,rule:e.oldRule}),this._addCellRuleCache(e))})}_ensureRuleMap(e,n){let o=this._cellRuleCache.get(e);o||(o=new Map,this._cellRuleCache.set(e,o));let r=o.get(n);return r||(r=new Map,o.set(n,r)),r}_ensureCellInfoMap(e,n){let o=this._cellInfoCache.get(e);o||(o=new Map,this._cellInfoCache.set(e,o));let r=o.get(n);return r||(r=new Map,o.set(n,r)),r}_ensureRowColInfoMap(e,n,o){let r=o==="row"?this._rowInfoCache.get(e):this._colInfoCache.get(e);r||(r=new Map,o==="row"?this._rowInfoCache.set(e,r):this._colInfoCache.set(e,r));let a=r.get(n);return a||(a=new Map,r.set(n,a)),a}_addCellRuleCache(e){const{subUnitId:n,unitId:o,rule:r}=e,a=this._ensureRuleMap(o,n);r.ranges.forEach(u=>{const{startRow:l,endRow:d,startColumn:c,endColumn:m}=u;for(let h=l;h<=d;h++)for(let R=c;R<=m;R++)a.set(`${h}-${R}`,r.id)}),this._permissionIdCache.set(r.permissionId,r.id)}_deleteCellRuleCache(e){const{subUnitId:n,unitId:o,rule:r}=e,a=this._ensureRuleMap(o,n),u=this._ensureCellInfoMap(o,n);r.ranges.forEach(l=>{const{startRow:d,endRow:c,startColumn:m,endColumn:h}=l;for(let R=d;R<=c;R++)for(let C=m;C<=h;C++)a.delete(`${R}-${C}`),u.delete(`${R}-${C}`)}),this._permissionIdCache.delete(r.permissionId)}_getSelectionActions(e,n,o){var c,m,h,R,C,S,I,v,M,p,w,y;const r=(h=(m=this._permissionService.getPermissionPoint((c=new Se(e,n,o.permissionId))==null?void 0:c.id))==null?void 0:m.value)!=null?h:!0,a=(S=(C=this._permissionService.getPermissionPoint((R=new un(e,n,o.permissionId))==null?void 0:R.id))==null?void 0:C.value)!=null?S:!0,u=(M=(v=this._permissionService.getPermissionPoint((I=new Os(e,n,o.permissionId))==null?void 0:I.id))==null?void 0:v.value)!=null?M:!1,l=(y=(w=this._permissionService.getPermissionPoint((p=new Ns(e,n,o.permissionId))==null?void 0:p.id))==null?void 0:w.value)!=null?y:!1;return{[_.Edit]:r,[_.View]:a,[_.ManageCollaborator]:u,[_.Delete]:l}}reBuildCache(e,n){const o=this._ensureRuleMap(e,n),r=this._ensureCellInfoMap(e,n);o.clear(),r.clear();const a=this._ensureRowColInfoMap(e,n,"row"),u=this._ensureRowColInfoMap(e,n,"col");a.clear(),u.clear(),this._ruleModel.getSubunitRuleList(e,n).forEach(l=>{const d=this._getSelectionActions(e,n,l),c={...d,ruleId:l.id,ranges:l.ranges};l.ranges.forEach(m=>{const{startRow:h,endRow:R,startColumn:C,endColumn:S}=m;for(let I=h;I<=R;I++){const v=a.get(`${I}`);v?v.set(l.id,d):a.set(`${I}`,new Map([[l.id,d]]));for(let M=C;M<=S;M++){o.set(`${I}-${M}`,l.id),r.set(`${I}-${M}`,c);const p=u.get(`${M}`);p?p.set(l.id,d):u.set(`${M}`,new Map([[l.id,d]]))}}}),this._permissionIdCache.set(l.permissionId,l.id)})}getRowPermissionInfo(e,n,o,r){var l;const a=(l=this._rowInfoCache.get(e))==null?void 0:l.get(n);if(!a)return!0;const u=a.get(`${o}`);return u?r.every(d=>{for(const c of u.values())if(c[d]===!1)return!1;return!0}):!0}getColPermissionInfo(e,n,o,r){var l;const a=(l=this._colInfoCache.get(e))==null?void 0:l.get(n);if(!a)return!0;const u=a.get(`${o}`);return u?r.every(d=>{for(const c of u.values())if(c[d]===!1)return!1;return!0}):!0}_initUpdateRowColInfoCache(){this._permissionService.permissionPointUpdate$.pipe(O.filter(e=>e.type===D.SelectRange),O.map(e=>e)).subscribe({next:e=>{const{subUnitId:n,unitId:o,permissionId:r}=e,a=this._permissionIdCache.get(r);if(!a)return;const u=this._ruleModel.getRule(o,n,a);if(!u)return;const l=this._ensureRowColInfoMap(o,n,"row"),d=this._ensureRowColInfoMap(o,n,"col"),c=this._getSelectionActions(o,n,u);u.ranges.forEach(m=>{const{startRow:h,endRow:R,startColumn:C,endColumn:S}=m;for(let I=h;I<=R;I++){const v=l.get(`${I}`);v?v.set(a,c):l.set(`${I}`,new Map([[a,c]]));for(let M=C;M<=S;M++){const p=d.get(`${M}`);p?p.set(a,c):d.set(`${M}`,new Map([[a,c]]))}}})}}),this._ruleModel.ruleChange$.subscribe(e=>{if(e.type==="delete"){const{unitId:n,subUnitId:o,rule:r}=e,a=this._ensureRowColInfoMap(n,o,"row"),u=this._ensureRowColInfoMap(n,o,"col");r.ranges.forEach(l=>{const{startRow:d,endRow:c,startColumn:m,endColumn:h}=l;for(let R=d;R<=c;R++){const C=a.get(`${R}`);C==null||C.delete(r.id);for(let S=m;S<=h;S++){const I=u.get(`${S}`);I==null||I.delete(r.id)}}})}})}getCellInfo(e,n,o,r){var c,m;const a=this._ensureCellInfoMap(e,n),u=a.get(`${o}-${r}`);if(u)return u;const l=(m=(c=this._cellRuleCache.get(e))==null?void 0:c.get(n))==null?void 0:m.get(`${o}-${r}`);if(!l)return;const d=this._ruleModel.getRule(e,n,l);if(d){const R={...this._getSelectionActions(e,n,d),ruleId:l,ranges:d.ranges};return a.set(`${o}-${r}`,R),R}}deleteUnit(e){this._cellRuleCache.delete(e),this._cellInfoCache.delete(e),this._rowInfoCache.delete(e),this._colInfoCache.delete(e);const n=this._univerInstanceService.getUnit(e);n==null||n.getSheets().forEach(o=>{const r=o.getSheetId();this._ruleModel.getSubunitRuleList(e,r).forEach(a=>{this._permissionIdCache.delete(a.permissionId)})})}},g.RangeProtectionCache=ad([xs(0,i.Inject(X)),xs(1,i.Inject(i.IPermissionService)),xs(2,i.Inject(i.IUniverInstanceService))],g.RangeProtectionCache);const Ei="ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY";var ud=Object.getOwnPropertyDescriptor,ld=(s,t,e,n)=>{for(var o=n>1?void 0:n?ud(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Xs=(s,t)=>(e,n)=>t(e,n,s);let kn=class extends i.Disposable{constructor(s,t,e){var o;super(),this._commandService=s,this._configService=t,this._dataSyncPrimaryController=e,[F,ie,re,bt,Be,pe,we,ne,ae,Ze,G,Ys,j,Fs,Yt,Un,Ot,Ci,Je,Ke,Si,fi].forEach(r=>{var a;this._commandService.registerCommand(r),(a=this._dataSyncPrimaryController)==null||a.registerSyncingMutations(r)}),((o=this._configService.getConfig(Ei))!=null?o:!1)||[Ur,sn,vn,on,As,He,Fe,zt,Jt,nr,tr,sr,or,ws,ye,Xe,vt,Xo,xo,Qo,Zo,ps,Me,Dr,wt,xe,pt,Ms,Lt,ys,$t,wn,Rn,Wr,Zr,xr,Xr,Br,Lr,Tt,Vr,$r,yn,ut,lt,qt,Hr,at,jr,Oe,Gr,ei,It,xt,_n,Yr,ct,$s,Hs,Ut,Pt,ee,si,Gt,Jr,ni,ti,Qr,js,Gs,Ct,ai,qe,bn,zs,Kt,jn,Ee,Tn,Re,Ve,di,gt,oi,mt,Lo,q,pi,Or,Ws,Ls,qs,hi,Rt,zr,dt,ui,Le,st,ze,In,Oo,qr,Pr,Er,kr,li,Ce,Te,Q,mi,ht,ri,ci,it,rt,pn,Et,gi,Ar,Tr,Nr,Ri,vi,Ii].forEach(r=>this.disposeWithMe(this._commandService.registerCommand(r))),this._configService.setConfig(wi,zl)}};kn=ld([Xs(0,i.ICommandService),Xs(1,i.IConfigService),Xs(2,i.Optional($i.DataSyncPrimaryController))],kn);var dd=Object.getOwnPropertyDescriptor,cd=(s,t,e,n)=>{for(var o=n>1?void 0:n?dd(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ti=(s,t)=>(e,n)=>t(e,n,s);let Nn=class extends i.Disposable{constructor(s,t){super(),this._univerInstanceService=s,this._commandService=t,this._initialize()}_initialize(){this.disposeWithMe(this._commandService.onCommandExecuted(s=>{if(s.id!==J.SetFormulaCalculationResultMutation.id)return;const t=s.params,{unitData:e}=t,n=Object.keys(e),o=[];for(let a=0;a<n.length;a++){const u=n[a],l=e[u];if(l==null)continue;const d=Object.keys(l);for(let c=0;c<d.length;c++){const m=d[c],h=l[m];if(h==null)continue;const R=this._getMergedCellData(u,m,h),C={subUnitId:m,unitId:u,cellValue:R};o.push({id:F.id,params:C})}}return o.every(a=>this._commandService.executeCommand(a.id,a.params,{onlyLocal:!0,fromFormula:!0}))}))}_getMergedCellData(s,t,e){const n=this._univerInstanceService.getUniverSheetInstance(s),o=n==null?void 0:n.getStyles(),r=n==null?void 0:n.getSheetBySheetId(t),a=r==null?void 0:r.getCellMatrix(),u=new i.ObjectMatrix(e);return u.forValue((l,d,c)=>{const m=a==null?void 0:a.getValue(l,d),h=J.handleNumfmtInCell(m,c,o);u.setValue(l,d,h)}),u.getMatrix()}};Nn=cd([Ti(0,i.Inject(i.IUniverInstanceService)),Ti(1,i.ICommandService)],Nn);var md=Object.getOwnPropertyDescriptor,hd=(s,t,e,n)=>{for(var o=n>1?void 0:n?md(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},gd=(s,t)=>(e,n)=>t(e,n,s);let On=class extends i.Disposable{constructor(s){super(),this._sheetInterceptorService=s,this._initialize()}_initialize(){this._initInterceptorCellContent()}_initInterceptorCellContent(){this.disposeWithMe(this._sheetInterceptorService.intercept(Ae.CELL_CONTENT,{priority:11,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(s,t,e)=>{var o;if(!s)return e(s);const n=t.workbook.getStyles().getStyleByCell(s);return i.isDefaultFormat((o=n==null?void 0:n.n)==null?void 0:o.pattern)&&(s==null?void 0:s.t)===i.CellValueType.NUMBER&&s.v!==void 0&&s.v!==null&&i.isRealNum(s.v)&&((!s||s===t.rawData)&&(s={...t.rawData}),s.v=J.stripErrorMargin(Number(s.v))),e(s)}}))}};On=hd([gd(0,i.Inject(g.SheetInterceptorService))],On);var Rd=Object.getOwnPropertyDescriptor,Cd=(s,t,e,n)=>{for(var o=n>1?void 0:n?Rd(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Dn=(s,t)=>(e,n)=>t(e,n,s);let An=class extends i.Disposable{constructor(s,t,e,n){super(),this._permissionService=s,this._worksheetProtectionRuleModel=t,this._sheetInterceptorService=e,this._rangeProtectionCache=n,this._initViewModelByRangeInterceptor(),this._initViewModelBySheetInterceptor()}_initViewModelByRangeInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(Ae.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(s,t,e)=>{const{unitId:n,subUnitId:o,row:r,col:a}=t,u=this._rangeProtectionCache.getCellInfo(n,o,r,a);if(u){const l=u[_.View]===!1,d=!s||s===t.rawData?{...t.rawData}:s;return d.selectionProtection=[u],l?(delete d.s,delete d.v,delete d.p,d):e(d)}return e(s)}}))}_initViewModelBySheetInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(Ae.CELL_CONTENT,{priority:999,effect:i.InterceptorEffectEnum.Value|i.InterceptorEffectEnum.Style,handler:(s,t,e)=>{var a,u,l,d,c;const{unitId:n,subUnitId:o}=t,r=this._worksheetProtectionRuleModel.getRule(n,o);if(r!=null&&r.permissionId){const m=[{[_.View]:(u=(a=this._permissionService.getPermissionPoint(new Vt(n,o).id))==null?void 0:a.value)!=null?u:!1,[_.Edit]:(d=(l=this._permissionService.getPermissionPoint(new fe(n,o).id))==null?void 0:l.value)!=null?d:!1}],h=!((c=m[0])!=null&&c[_.View]),R=!s||s===t.rawData?{...s}:s;return R.hasWorksheetRule=!0,R.selectionProtection=m,h?(delete R.s,delete R.v,delete R.p,R):e(R)}return e(s)}}))}};An=Cd([Dn(0,i.IPermissionService),Dn(1,i.Inject(ke)),Dn(2,i.Inject(g.SheetInterceptorService)),Dn(3,i.Inject(g.RangeProtectionCache))],An);const Zs=i.createIdentifier("univer.exclusive-range-service");class Ui extends i.Disposable{constructor(){super(...arguments);f(this,"_exclusiveRanges",new Map);f(this,"_exclusiveRangesChange$",new O.Subject);f(this,"exclusiveRangesChange$",this._exclusiveRangesChange$.asObservable())}_ensureUnitMap(e){return this._exclusiveRanges.has(e)||this._exclusiveRanges.set(e,new Map),this._exclusiveRanges.get(e)}_ensureSubunitMap(e,n){const o=this._ensureUnitMap(e);return o.has(n)||o.set(n,new Map),o.get(n)}_ensureFeature(e,n,o){const r=this._ensureSubunitMap(e,n);return r.has(o)||r.set(o,[]),r.get(o)}addExclusiveRange(e,n,o,r){const a=this._ensureFeature(e,n,o);a.push(...r),this._exclusiveRangesChange$.next({unitId:e,subUnitId:n,ranges:a.map(u=>u.range)})}getExclusiveRanges(e,n,o){var r,a;return(a=(r=this._exclusiveRanges.get(e))==null?void 0:r.get(n))==null?void 0:a.get(o)}clearExclusiveRanges(e,n,o){const r=this.getExclusiveRanges(e,n,o);this._exclusiveRangesChange$.next({unitId:e,subUnitId:n,ranges:(r==null?void 0:r.map(a=>a.range))||[]}),this._ensureFeature(e,n,o),this._exclusiveRanges.get(e).get(n).set(o,[])}clearExclusiveRangesByGroupId(e,n,o,r){const a=this.getExclusiveRanges(e,n,o);this._exclusiveRangesChange$.next({unitId:e,subUnitId:n,ranges:(a==null?void 0:a.map(l=>l.range))||[]});const u=this.getExclusiveRanges(e,n,o);if(u){const l=u.filter(d=>d.groupId!==r);this._exclusiveRanges.get(e).get(n).set(o,l)}}getInterestGroupId(e){const n=[];return e.forEach(o=>{var d;const r=o.range,{unitId:a,sheetId:u}=r;if(!a||!u)return;const l=(d=this._exclusiveRanges.get(a))==null?void 0:d.get(u);if(l)for(const c of l.keys()){const m=l.get(c);if(m){for(const h of m)if(i.Rectangle.intersects(r,h.range)){n.push(c);break}}}}),n}}var Sd=Object.getOwnPropertyDescriptor,fd=(s,t,e,n)=>{for(var o=n>1?void 0:n?Sd(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Qs=(s,t)=>(e,n)=>t(e,n,s);g.NumfmtService=class extends i.Disposable{constructor(t,e,n){super(),this._resourceManagerService=t,this._univerInstanceService=e,this._logService=n}getValue(t,e,n,o){const r=this._univerInstanceService.getUniverSheetInstance(t);if(!r)return;const a=r==null?void 0:r.getSheetBySheetId(e);if(!a)return;const u=r.getStyles(),l=a.getCellRaw(n,o);if(l!=null&&l.s){const d=u.get(l.s);if(d!=null&&d.n)return d.n}return null}deleteValues(t,e,n){const o=this._univerInstanceService.getUniverSheetInstance(t);if(!o)return;const r=o==null?void 0:o.getSheetBySheetId(e);if(!r)return;const a=o.getStyles();n.forEach(u=>{i.Range.foreach(u,(l,d)=>{const c=r.getCellRaw(l,d);if(!c)return;const m=c==null?void 0:c.s,R={...m&&a.get(m)||{}};delete R.n;const C=a.setValue(R);c.s=C})})}setValues(t,e,n){const o=this._univerInstanceService.getUniverSheetInstance(t);if(!o)return;const r=o==null?void 0:o.getSheetBySheetId(e);if(!r)return;const a=o.getStyles(),u=r.getCellMatrix();n.forEach(l=>{l.ranges.forEach(d=>{i.Range.foreach(d,(c,m)=>{const h=r.getCellRaw(c,m);if(h){const C={...a.getStyleByCell(h)||{},n:{pattern:l.pattern}},S=a.setValue(C);h.s=S}else{const R={n:{pattern:l.pattern}},C=a.setValue(R);C&&u.setValue(c,m,{s:C})}})})})}},g.NumfmtService=fd([Qs(0,i.IResourceManagerService),Qs(1,i.IUniverInstanceService),Qs(2,i.ILogService)],g.NumfmtService);var Id=Object.getOwnPropertyDescriptor,vd=(s,t,e,n)=>{for(var o=n>1?void 0:n?Id(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ye=(s,t)=>(e,n)=>t(e,n,s);const Pi=[ie.id,re.id,ne.id,ae.id],ki=[pe.id,we.id];g.RangeProtectionRefRangeService=class extends i.Disposable{constructor(e,n,o,r,a,u,l,d){super();f(this,"disposableCollection",new i.DisposableCollection);this._selectionProtectionRuleModel=e,this._univerInstanceService=n,this._commandService=o,this._refRangeService=r,this._selectionProtectionRenderModel=a,this._rangeProtectionCache=u,this._sheetInterceptorService=l,this._rangeProtectionRuleModel=d,this._onRefRangeChange(),this._correctPermissionRange(),this._initReBuildCache(),this._initRemoveSheet()}_onRefRangeChange(){const e=(o,r)=>{const a=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!a||!(a==null?void 0:a.getSheetBySheetId(r)))return;this.disposableCollection.dispose();const l=c=>this.refRangeHandle(c,o,r);this._selectionProtectionRuleModel.getSubunitRuleList(o,r).reduce((c,m)=>[...c,...m.ranges],[]).forEach(c=>{this.disposableCollection.add(this._refRangeService.registerRefRange(c,l,o,r))})};this.disposeWithMe(this._commandService.onCommandExecuted(o=>{if(o.id===Gs.id){const r=o.params,a=r.subUnitId,u=r.unitId;if(!a||!u)return;e(u,a)}if(o.id===Q.id||o.id===Ce.id){const r=o.params,a=r.subUnitId,u=r.unitId;if(!a||!u)return;e(u,a)}}));const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(n){const o=n.getActiveSheet();if(!o)return;e(n.getUnitId(),o.getSheetId())}}refRangeHandle(e,n,o){switch(e.id){case pt.id:return this._getRefRangeMutationsByMoveRows(e.params,n,o);case wt.id:return this._getRefRangeMutationsByMoveCols(e.params,n,o);case Me.id:return this._getRefRangeMutationsByInsertRows(e.params,n,o);case ye.id:return this._getRefRangeMutationsByInsertCols(e.params,n,o);case Lt.id:return this._getRefRangeMutationsByDeleteCols(e.params,n,o);case $t.id:return this._getRefRangeMutationsByDeleteRows(e.params,n,o)}return{redos:[],undos:[]}}_getRefRangeMutationsByDeleteCols(e,n,o){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(u=>u.ranges.some(l=>i.Rectangle.intersects(l,e.range))),a=e.range;if(r.length){const u=[],l=[];return r.forEach(d=>{const c=i.Tools.deepClone(d),m=c.ranges.reduce((h,R)=>{if(i.Rectangle.intersects(R,a)){const C=i.Tools.deepClone(R),{startColumn:S,endColumn:I}=a;if(S<=C.startColumn&&I>=C.endColumn)return h;S>=C.startColumn&&I<=C.endColumn?C.endColumn-=I-S+1:S<C.startColumn?(C.startColumn=S,C.endColumn-=I-S+1):I>C.endColumn&&(C.endColumn=S-1),this._checkIsRightRange(C)&&h.push(C)}return h},[]);c.ranges=m,c.ranges.length?(u.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:d.id}}),l.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:d,ruleId:d.id}})):(u.push({id:Te.id,params:{unitId:n,subUnitId:o,ruleIds:[d.id]}}),l.push({id:Ce.id,params:{unitId:n,subUnitId:o,name:"",rules:[d]}}))}),{redos:u,undos:l}}return{undos:[],redos:[]}}_getRefRangeMutationsByDeleteRows(e,n,o){const r=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(u=>u.ranges.some(l=>i.Rectangle.intersects(l,e.range))),a=e.range;if(r.length){const u=[],l=[];return r.forEach(d=>{const c=i.Tools.deepClone(d),m=c.ranges.reduce((h,R)=>{if(i.Rectangle.intersects(R,a)){const C=i.Tools.deepClone(R),{startRow:S,endRow:I}=a;if(S<=C.startRow&&I>=C.endRow)return h;S>=C.startRow&&I<=C.endRow?C.endRow-=I-S+1:S<C.startRow?(C.startRow=S,C.endRow-=I-S+1):I>C.endRow&&(C.endRow=S-1),this._checkIsRightRange(C)&&h.push(C)}return h},[]);c.ranges=m,u.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:d.id}}),l.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:d,ruleId:d.id}})}),{redos:u,undos:l}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertCols(e,n,o){const r=e.range.startColumn,a=e.range.endColumn-e.range.startColumn+1,u=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(l=>l.ranges.some(d=>r>d.startColumn&&r<=d.endColumn));if(u.length){const l=[],d=[];return u.forEach(c=>{const m=i.Tools.deepClone(c);let h=!1;m.ranges.forEach(R=>{r>R.startColumn&&r<=R.endColumn&&(R.endColumn+=a,h=!0)}),h&&(l.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:c.id}}),d.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:c.id}}))}),{redos:l,undos:d}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertRows(e,n,o){const r=e.range.startRow,a=e.range.endRow-e.range.startRow+1,u=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(l=>l.ranges.some(d=>r>d.startRow&&r<=d.endRow));if(u.length){const l=[],d=[];return u.forEach(c=>{const m=i.Tools.deepClone(c);let h=!1;m.ranges.forEach(R=>{r>R.startRow&&r<=R.endRow&&(R.endRow+=a,h=!0)}),h&&(l.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:c.id}}),d.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:c,ruleId:c.id}}))}),{redos:l,undos:d}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveRows(e,n,o){const r=e.toRange,a=r.startRow,u=r.endRow-r.startRow+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(d=>d.ranges.some(c=>a>c.startRow&&a<=c.endRow));if(l.length){const d=[],c=[];return l.forEach(m=>{const h=i.Tools.deepClone(m),C=e.fromRange.startRow;let S=!1;h.ranges.forEach(I=>{a>I.startRow&&a<=I.endRow&&(C<I.startRow&&(I.startRow=I.startRow-u,I.endRow=I.endRow-u),I.endRow+=u,S=!0)}),S&&(d.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:h,ruleId:m.id}}),c.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:m.id}}))}),{redos:d,undos:c}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveCols(e,n,o){const r=e.toRange,a=r.startColumn,u=r.endColumn-r.startColumn+1,l=this._selectionProtectionRuleModel.getSubunitRuleList(n,o).filter(d=>d.ranges.some(c=>a>c.startColumn&&a<=c.endColumn));if(l.length){const d=[],c=[];return l.forEach(m=>{const h=i.Tools.deepClone(m),C=e.fromRange.startColumn;let S=!1;h.ranges.forEach(I=>{a>I.startColumn&&a<=I.endColumn&&(C<I.startColumn&&(I.startColumn=I.startColumn-u,I.endColumn=I.endColumn-u),I.endColumn+=u,S=!0)}),S&&(d.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:h,ruleId:m.id}}),c.push({id:Q.id,params:{unitId:n,subUnitId:o,rule:m,ruleId:m.id}}))}),{redos:d,undos:c}}return{undos:[],redos:[]}}_correctPermissionRange(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(ki.includes(e.id)){if(!e.params)return;const n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!n)return;const o=n.getSheetBySheetId(e.params.subUnitId);if(!o)return;const{sourceRange:r,targetRange:a}=e.params,u=r.startColumn===a.startColumn&&r.endColumn===a.endColumn,l=u?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,d=u?r.startRow:r.startColumn,c=u?a.startRow:a.startColumn;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),o.getSheetId()).forEach(I=>{I.ranges.forEach(M=>{let{startRow:p,endRow:w,startColumn:y,endColumn:b}=M;i.Rectangle.intersects(M,r)||(u?d<p&&c>w?(p-=l,w-=l):d>w&&c<=p&&(p+=l,w+=l):d<y&&c>b?(y-=l,b-=l):d>b&&c<=y&&(y+=l,b+=l)),this._checkIsRightRange({startRow:p,endRow:w,startColumn:y,endColumn:b})&&(M.startColumn=y,M.endColumn=b,M.startRow=p,M.endRow=w)})}),this.disposableCollection.dispose();const{unitId:h,subUnitId:R}=e.params,C=I=>this.refRangeHandle(I,h,R);this._selectionProtectionRuleModel.getSubunitRuleList(h,R).reduce((I,v)=>[...I,...v.ranges],[]).forEach(I=>{this.disposableCollection.add(this._refRangeService.registerRefRange(I,C,h,R))}),this._selectionProtectionRenderModel.clear()}if(Pi.includes(e.id)){const n=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!n)return;const o=n.getSheetBySheetId(e.params.subUnitId);if(!o)return;const r=e.params;if(!r)return;const{range:a}=r,u=e.id.includes("row"),l=e.id.includes("insert"),d=u?a.startRow:a.startColumn,c=u?a.endRow:a.endColumn,m=c-d+1;this._selectionProtectionRuleModel.getSubunitRuleList(n.getUnitId(),o.getSheetId()).forEach(v=>{v.ranges.forEach(p=>{let{startRow:w,endRow:y,startColumn:b,endColumn:T}=p;l?u?d<=w&&(w+=m,y+=m):d<=b&&(b+=m,T+=m):u?c<w&&(w-=m,y-=m):c<b&&(b-=m,T-=m),this._checkIsRightRange({startRow:w,endRow:y,startColumn:b,endColumn:T})&&(p.startColumn=b,p.endColumn=T,p.startRow=w,p.endRow=y)})}),this.disposableCollection.dispose();const{unitId:R,subUnitId:C}=e.params,S=v=>this.refRangeHandle(v,R,C);this._selectionProtectionRuleModel.getSubunitRuleList(R,C).reduce((v,M)=>[...v,...M.ranges],[]).forEach(v=>{this.disposableCollection.add(this._refRangeService.registerRefRange(v,S,R,C))}),this._selectionProtectionRenderModel.clear()}}))}_checkIsRightRange(e){return e.startRow<=e.endRow&&e.startColumn<=e.endColumn}_initReBuildCache(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(Pi.includes(e.id)||ki.includes(e.id)){const{unitId:n,subUnitId:o}=e.params;this._rangeProtectionCache.reBuildCache(n,o)}}))}_initRemoveSheet(){this._sheetInterceptorService.interceptCommand({getMutations:e=>{const n=[],o=[],r=[],a=[];if(e.id===wn.id){const u=e.params,l=[],d=[];this._rangeProtectionRuleModel.getSubunitRuleList(u.unitId,u.subUnitId).forEach(c=>{l.push(c.id),d.push(c)}),l.length&&d.length&&(r.push({id:Te.id,params:{unitId:u.unitId,subUnitId:u.subUnitId,ruleIds:l}}),n.push({id:Ce.id,params:{unitId:u.unitId,subUnitId:u.subUnitId,name:"",rules:d}}))}return{redos:o,undos:n,preRedos:r,preUndos:a}}})}},g.RangeProtectionRefRangeService=vd([Ye(0,i.Inject(X)),Ye(1,i.Inject(i.IUniverInstanceService)),Ye(2,i.ICommandService),Ye(3,i.Inject(g.RefRangeService)),Ye(4,i.Inject(g.RangeProtectionRenderModel)),Ye(5,i.Inject(g.RangeProtectionCache)),Ye(6,i.Inject(g.SheetInterceptorService)),Ye(7,i.Inject(X))],g.RangeProtectionRefRangeService);var pd=Object.getOwnPropertyDescriptor,wd=(s,t,e,n)=>{for(var o=n>1?void 0:n?pd(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Xt=(s,t)=>(e,n)=>t(e,n,s);const Md="SHEET_RANGE_PROTECTION_PLUGIN";g.RangeProtectionService=class extends i.Disposable{constructor(t,e,n,o,r){super(),this._selectionProtectionRuleModel=t,this._permissionService=e,this._resourceManagerService=n,this._selectionProtectionCache=o,this._univerInstanceService=r,this._initSnapshot(),this._initRuleChange()}_initRuleChange(){this.disposeWithMe(this._selectionProtectionRuleModel.ruleChange$.subscribe(t=>{switch(t.type){case"add":{le().forEach(e=>{const n=new e(t.unitId,t.subUnitId,t.rule.permissionId);this._permissionService.addPermissionPoint(n)});break}case"delete":{le().forEach(e=>{const n=new e(t.unitId,t.subUnitId,t.rule.permissionId);this._permissionService.deletePermissionPoint(n.id)});break}case"set":{t.oldRule.permissionId!==t.rule.permissionId&&le().forEach(e=>{const n=new e(t.unitId,t.subUnitId,t.oldRule.permissionId);this._permissionService.deletePermissionPoint(n.id);const o=new e(t.unitId,t.subUnitId,t.rule.permissionId);this._permissionService.addPermissionPoint(o)});break}}}))}_initSnapshot(){const t=n=>{const r=this._selectionProtectionRuleModel.toObject()[n];return r?JSON.stringify(r):""},e=n=>{if(!n)return{};try{return JSON.parse(n)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:t,parseJson:e,pluginName:Md,businesses:[an.UNIVER_SHEET],onLoad:(n,o)=>{const r=this._selectionProtectionRuleModel.toObject();r[n]=o,this._selectionProtectionRuleModel.fromObject(r);const a=[];Object.keys(o).forEach(u=>{const l=o[u];this._selectionProtectionRuleModel.getSubunitRuleList(n,u).forEach(d=>{a.push({objectID:d.permissionId,unitID:n,objectType:D.SelectRange,actions:je})}),l.forEach(d=>{le().forEach(c=>{const m=new c(n,u,d.permissionId);m.value=!1,this._permissionService.addPermissionPoint(m)})}),this._selectionProtectionCache.reBuildCache(n,u)})},onUnLoad:n=>{this._selectionProtectionCache.deleteUnit(n)}}))}},g.RangeProtectionService=wd([Xt(0,i.Inject(X)),Xt(1,i.Inject(i.IPermissionService)),Xt(2,i.Inject(i.IResourceManagerService)),Xt(3,i.Inject(g.RangeProtectionCache)),Xt(4,i.Inject(i.IUniverInstanceService))],g.RangeProtectionService);var yd=Object.getOwnPropertyDescriptor,_d=(s,t,e,n)=>{for(var o=n>1?void 0:n?yd(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},bd=(s,t)=>(e,n)=>t(e,n,s);g.SheetRangeThemeService=class extends i.Disposable{constructor(t){super(),this._sheetRangeThemeModel=t}registerRangeTheme(t,e){this._sheetRangeThemeModel.registerRangeThemeStyle(t,e)}removeRangeThemeRule(t,e){this._sheetRangeThemeModel.removeRangeThemeRule(t,e)}getALLRegisterThemes(t){return this._sheetRangeThemeModel.getALLRegisteredTheme(t)}registerRangeThemeStyle(t,e){this._sheetRangeThemeModel.registerRangeThemeRule(t,e)}getAppliedRangeThemeStyle(t){return this._sheetRangeThemeModel.getRegisteredRangeThemeStyle(t)}getRegisteredRangeThemes(){return this._sheetRangeThemeModel.getRegisteredRangeThemes()}},g.SheetRangeThemeService=_d([bd(0,i.Inject(g.SheetRangeThemeModel))],g.SheetRangeThemeService);var Ed=Object.defineProperty,Td=Object.getOwnPropertyDescriptor,Ud=(s,t,e)=>t in s?Ed(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Pd=(s,t,e,n)=>{for(var o=n>1?void 0:n?Td(t,e):t,r=s.length-1,a;r>=0;r--)(a=s[r])&&(o=a(o)||o);return o},Ni=(s,t)=>(e,n)=>t(e,n,s),Oi=(s,t,e)=>Ud(s,typeof t!="symbol"?t+"":t,e);const kd="SHEET_PLUGIN";g.UniverSheetsPlugin=class extends i.Plugin{constructor(t=_i,e,n){super(),this._config=t,this._injector=e,this._configService=n;const{...o}=i.merge({},_i,this._config);this._configService.setConfig(yi,o),this._initConfig(),this._initDependencies()}_initConfig(){var t,e,n;(t=this._config)!=null&&t.onlyRegisterFormulaRelatedMutations&&this._configService.setConfig(Ei,!0),(e=this._config)!=null&&e.isRowStylePrecedeColumnStyle&&this._configService.setConfig(i.IS_ROW_STYLE_PRECEDE_COLUMN_STYLE,!0),(n=this._config)!=null&&n.autoHeightForMergedCells&&this._configService.setConfig(i.AUTO_HEIGHT_FOR_MERGED_CELLS,!0)}_initDependencies(){var e;const t=[[nt],[g.SheetsSelectionsService],[g.RefRangeService],[g.WorkbookPermissionService],[ot,{useClass:g.NumfmtService}],[g.SheetInterceptorService],[g.SheetRangeThemeService],[g.SheetSkeletonService],[kn],[g.MergeCellController],[On],[g.DefinedNameDataController],[g.ZebraCrossingCacheController],[g.SheetsFreezeSyncController],[g.WorksheetPermissionService],[ke],[yt],[An],[g.SheetPermissionInitController],[g.SheetPermissionCheckController],[g.SheetRangeThemeModel],[g.RangeProtectionRenderModel],[X],[g.RangeProtectionCache],[g.RangeProtectionRefRangeService],[g.RangeProtectionService],[Zs,{useClass:Ui,deps:[g.SheetsSelectionsService]}]];(e=this._config)!=null&&e.notExecuteFormula||t.push([Nn]),i.registerDependencies(this._injector,i.mergeOverrideWithDependencies(t,this._config.override)),i.touchDependencies(this._injector,[[g.SheetInterceptorService],[g.RangeProtectionService],[Zs],[g.SheetPermissionInitController],[g.SheetsFreezeSyncController]])}onStarting(){i.touchDependencies(this._injector,[[kn],[g.MergeCellController],[g.WorkbookPermissionService],[g.WorksheetPermissionService],[An],[g.SheetSkeletonService]])}onRendered(){i.touchDependencies(this._injector,[[ot]])}onReady(){i.touchDependencies(this._injector,[[Nn],[g.DefinedNameDataController],[g.ZebraCrossingCacheController],[g.SheetRangeThemeModel],[On],[g.RangeProtectionRenderModel],[g.RangeProtectionRefRangeService],[g.RefRangeService],[g.SheetPermissionCheckController]])}},Oi(g.UniverSheetsPlugin,"pluginName",kd),Oi(g.UniverSheetsPlugin,"type",i.UniverInstanceType.UNIVER_SHEET),g.UniverSheetsPlugin=Pd([i.DependentOn(J.UniverFormulaEnginePlugin),Ni(1,i.Inject(i.Injector)),Ni(2,i.IConfigService)],g.UniverSheetsPlugin);const Nd={WorkbookCommentPermission:Yn,WorkbookCopyPermission:Kn,WorkbookCreateProtectPermission:Jn,WorkbookCreateSheetPermission:xn,WorkbookDeleteSheetPermission:Xn,WorkbookDuplicatePermission:Zn,WorkbookEditablePermission:me,WorkbookExportPermission:Qn,WorkbookHideSheetPermission:ln,WorkbookHistoryPermission:Go,WorkbookManageCollaboratorPermission:dn,WorkbookMoveSheetPermission:cn,WorkbookPrintPermission:es,WorkbookRecoverHistoryPermission:ts,WorkbookRenameSheetPermission:mn,WorkbookSharePermission:ns,WorkbookViewHistoryPermission:os,WorkbookViewPermission:ss,WorksheetCopyPermission:rs,WorksheetDeleteColumnPermission:is,WorksheetDeleteProtectionPermission:as,WorksheetDeleteRowPermission:us,WorksheetEditExtraObjectPermission:ls,WorksheetEditPermission:fe,WorksheetFilterPermission:ds,WorksheetInsertColumnPermission:cs,WorksheetInsertHyperlinkPermission:ms,WorksheetInsertRowPermission:hs,WorksheetManageCollaboratorPermission:gs,WorksheetPivotTablePermission:Rs,WorksheetSetCellStylePermission:Cs,WorksheetSetCellValuePermission:Wt,WorksheetSetColumnStylePermission:St,WorksheetSetRowStylePermission:ft,WorksheetSortPermission:Ss,WorksheetViewPermission:Vt,RangeProtectionPermissionEditPoint:Se,RangeProtectionPermissionViewPoint:un},Od=(s,t,e,n)=>{const o=s.get(i.IPermissionService),r=s.get(X),a=o.getPermissionPoint(new me(t).id);if(!(a!=null&&a.value))return!1;const u=o.getPermissionPoint(new fe(t,e).id);if(!(u!=null&&u.value))return!1;const d=r.getSubunitRuleList(t,e).filter(c=>c.ranges.some(m=>n.some(h=>i.Rectangle.intersects(m,h))));return d.length?d.every(c=>{const m=c.permissionId,h=o.getPermissionPoint(new Se(t,e,m).id);return!!(h!=null&&h.value)}):!0},Di=(s,t,e,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,t),{startRow:u,endRow:l}=a;let d=e.startRow-n,c=t.getMergedCell(d,e.startColumn),m=!c||c.startRow===d&&c.startColumn===e.startColumn;for(;!t.getRowVisible(d)||!m;)d--,c=t.getMergedCell(d,e.startColumn),m=!c||c.startRow===d&&c.startColumn===e.startColumn;if(d>=u)return{...e,startRow:d,endRow:d};if(r){const h={...e,startRow:l,endRow:l};return Wi(s,t,h,n,o,!1)}},Ai=(s,t,e,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,t),{startRow:u,endRow:l}=a;let d=e.endRow+n,c=t.getMergedCell(d,e.startColumn),m=!c||c.startRow===d&&c.startColumn===e.startColumn;for(;!t.getRowVisible(d)||!m;)d++,c=t.getMergedCell(d,e.startColumn),m=!c||c.startRow===d&&c.startColumn===e.startColumn;if(d<=l)return{...e,startRow:d,endRow:d};if(r){const h={...e,startRow:u,endRow:u};return Vi(s,t,h,n,o,!1)}},Wi=(s,t,e,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,t),{startColumn:u,endColumn:l}=a;let d=e.startColumn-n,c=t.getMergedCell(e.startRow,d),m=!c||c.startRow===e.startRow&&c.startColumn===d;for(;!t.getColVisible(d)||!m;)d--,c=t.getMergedCell(e.startRow,d),m=!c||c.startRow===e.startRow&&c.startColumn===d;if(d>=u)return{...e,startColumn:d,endColumn:d};if(r){const h={...e,startColumn:l,endColumn:l};return Di(s,t,h,n,o,!1)}},Vi=(s,t,e,n=1,o=!0,r=!0)=>{const a=i.Range.transformRange(s,t),{startColumn:u,endColumn:l}=a;let d=e.endColumn+n,c=t.getMergedCell(e.startRow,d),m=!c||c.startRow===e.startRow&&c.startColumn===d;for(;!t.getColVisible(d)||!m;)d++,c=t.getMergedCell(e.startRow,d),m=!c||c.startRow===e.startRow&&c.startColumn===d;if(d<=l)return{...e,endColumn:d,startColumn:d};if(r){const h={...e,startColumn:u,endColumn:u};return Ai(s,t,h,n,o,!1)}};function Wn(s,t,e){let n=null;return e.getMatrixWithMergedCells(s,t,s,t).forValue((r,a,u)=>(n={actualRow:r,actualColumn:a,startRow:r,startColumn:a,isMerged:u.rowSpan!==void 0||u.colSpan!==void 0,isMergedMainCell:u.rowSpan!==void 0&&u.colSpan!==void 0,endRow:r+(u.rowSpan!==void 0?u.rowSpan-1:0),endColumn:a+(u.colSpan!==void 0?u.colSpan-1:0),rangeType:i.RANGE_TYPE.NORMAL},!1)),n||{actualColumn:t,actualRow:s,startRow:s,startColumn:t,endRow:s,endColumn:t,isMerged:!1,isMergedMainCell:!1,rangeType:i.RANGE_TYPE.NORMAL}}const Dd=(s,t,e,n,o=1)=>{switch(n){case i.Direction.UP:return Di(s,t,e,o);case i.Direction.DOWN:return Ai(s,t,e,o);case i.Direction.LEFT:return Wi(s,t,e,o);case i.Direction.RIGHT:return Vi(s,t,e,o)}},Ad=(s,t,e)=>{let n,o=-1,r;for(let v=0;v<s.length;v++)if(s[v].primary){n=s[v],o=v,r=n.primary;break}if(o===-1)return null;const a=t===i.Direction.LEFT||t===i.Direction.UP,u=a?o-1>=0?o-1:s.length-1:o+1<s.length?o+1:0,l=s[u];if(!n||!r)return null;const d={...r},{startRow:c,startColumn:m,endRow:h,endColumn:R}=n.range,C=a?d.startRow===c&&d.startColumn===m:d.endRow===h&&d.endColumn===R,S=C&&a;if(!i.Rectangle.equals(n.range,d)){const v=C?l.range:Dd(n.range,e,d,t);if(!v)return null;const M=S?Wn(v.endRow,v.endColumn,e):Wn(v.startRow,v.startColumn,e);return{startRow:M.startRow,startColumn:M.startColumn,endRow:M.endRow,endColumn:M.endColumn}}const I=S?Wn(l.range.endRow,l.range.endColumn,e):Wn(l.range.startRow,l.range.startColumn,e);return{startRow:I.startRow,startColumn:I.startColumn,endRow:I.endRow,endColumn:I.endColumn}};g.AFTER_CELL_EDIT=Zt,g.AddMergeRedoSelectionsOperationFactory=jl,g.AddMergeUndoMutationFactory=ge,g.AddMergeUndoSelectionsOperationFactory=Gl,g.AddRangeProtectionCommand=Oo,g.AddRangeProtectionMutation=Ce,g.AddRangeThemeMutation=Ri,g.AddWorksheetMergeAllCommand=tl,g.AddWorksheetMergeCommand=Ft,g.AddWorksheetMergeHorizontalCommand=sl,g.AddWorksheetMergeMutation=j,g.AddWorksheetMergeVerticalCommand=nl,g.AddWorksheetProtectionCommand=Er,g.AddWorksheetProtectionMutation=Le,g.AppendRowCommand=Ur,g.BEFORE_CELL_EDIT=$n,g.BorderStyleManagerService=nt,g.COMMAND_LISTENER_SKELETON_CHANGE=Ea,g.COMMAND_LISTENER_VALUE_CHANGE=Ta,g.CancelFrozenCommand=Gr,g.CancelMarkDirtyRowAutoHeightMutation=fi,g.ClearSelectionAllCommand=sn,g.ClearSelectionContentCommand=vn,g.ClearSelectionFormatCommand=on,g.CopySheetCommand=As,g.DISABLE_NORMAL_SELECTIONS=su,g.DeleteRangeMoveLeftCommand=He,g.DeleteRangeMoveUpCommand=Fe,g.DeleteRangeProtectionCommand=Pr,g.DeleteRangeProtectionMutation=Te,g.DeleteWorksheetProtectionCommand=kr,g.DeleteWorksheetProtectionMutation=ze,g.DeleteWorksheetRangeThemeStyleCommand=Nr,g.DeleteWorksheetRangeThemeStyleMutation=it,g.DeleteWorksheetRangeThemeStyleMutationFactory=ao,g.DeltaColumnWidthCommand=zt,g.DeltaRowHeightCommand=Jt,g.EditStateEnum=No,g.EffectRefRangId=A,g.EmptyMutation=Ci,g.ExclusiveRangeService=Ui,g.FactoryAddRangeProtectionMutation=Qa,g.FactoryDeleteRangeProtectionMutation=Za,g.FactorySetRangeProtectionMutation=yl,g.IExclusiveRangeService=Zs,g.INTERCEPTOR_POINT=Ae,g.INumfmtService=ot,g.IRefSelectionsService=Vo,g.InsertColAfterCommand=nr,g.InsertColBeforeCommand=tr,g.InsertColByRangeCommand=ws,g.InsertColCommand=ye,g.InsertColMutation=ie,g.InsertColMutationUndoFactory=Nt,g.InsertDefinedNameCommand=Or,g.InsertMultiColsLeftCommand=sr,g.InsertMultiColsRightCommand=or,g.InsertMultiRowsAboveCommand=Zo,g.InsertMultiRowsAfterCommand=Qo,g.InsertRangeMoveDownCommand=Xe,g.InsertRangeMoveRightCommand=vt,g.InsertRowAfterCommand=Xo,g.InsertRowBeforeCommand=xo,g.InsertRowByRangeCommand=ps,g.InsertRowCommand=Me,g.InsertRowMutation=re,g.InsertRowMutationUndoFactory=en,g.InsertSheetCommand=Dr,g.InsertSheetMutation=bt,g.InsertSheetUndoMutationFactory=Ds,g.InterceptCellContentPriority=to,g.MAX_CELL_PER_SHEET_KEY=wi,g.MERGE_CELL_INTERCEPTOR_CHECK=_r,g.MarkDirtyRowAutoHeightMutation=Si,g.MoveColsCommand=wt,g.MoveColsMutation=we,g.MoveColsMutationUndoFactory=lo,g.MoveRangeCommand=xe,g.MoveRangeMutation=Be,g.MoveRowsCommand=pt,g.MoveRowsMutation=pe,g.MoveRowsMutationUndoFactory=uo,g.OperatorType=B,g.PermissionPointsDefinitions=Nd,g.REF_SELECTIONS_ENABLED=Ao,g.RangeMergeUtil=$a,g.RangeProtectionPermissionDeleteProtectionPoint=Ns,g.RangeProtectionPermissionEditPoint=Se,g.RangeProtectionPermissionManageCollaPoint=Os,g.RangeProtectionPermissionViewPoint=un,g.RangeProtectionRuleModel=X,g.RangeThemeStyle=We,g.RegisterWorksheetRangeThemeStyleCommand=Ar,g.RegisterWorksheetRangeThemeStyleMutation=Et,g.RemoveColByRangeCommand=ys,g.RemoveColCommand=Lt,g.RemoveColMutation=ne,g.RemoveDefinedNameCommand=Ws,g.RemoveMergeUndoMutationFactory=ue,g.RemoveNumfmtMutation=Ys,g.RemoveRangeThemeMutation=Ii,g.RemoveRowByRangeCommand=Ms,g.RemoveRowCommand=$t,g.RemoveRowMutation=ae,g.RemoveSheetCommand=wn,g.RemoveSheetMutation=Ze,g.RemoveSheetUndoMutationFactory=rr,g.RemoveWorksheetMergeCommand=Wr,g.RemoveWorksheetMergeMutation=G,g.ReorderRangeCommand=Rn,g.ReorderRangeMutation=Ot,g.ReorderRangeUndoMutationFactory=co,g.ResetBackgroundColorCommand=Zr,g.ResetTextColorCommand=xr,g.SCOPE_WORKBOOK_VALUE_DEFINED_NAME=Jl,g.SELECTIONS_ENABLED=ou,g.SELECTION_CONTROL_BORDER_BUFFER_COLOR=Ba,g.SELECTION_CONTROL_BORDER_BUFFER_WIDTH=La,g.ScrollToCellOperation=pi,g.SelectRangeCommand=Lo,g.SelectionMoveType=te,g.SetBackgroundColorCommand=Xr,g.SetBoldCommand=Tl,g.SetBorderBasicCommand=Br,g.SetBorderColorCommand=Lr,g.SetBorderCommand=Tt,g.SetBorderPositionCommand=Vr,g.SetBorderStyleCommand=$r,g.SetColDataCommand=Hr,g.SetColDataMutation=at,g.SetColDataMutationFactory=mo,g.SetColHiddenCommand=yn,g.SetColHiddenMutation=ut,g.SetColVisibleMutation=lt,g.SetColWidthCommand=qt,g.SetDefinedNameCommand=Ls,g.SetFontFamilyCommand=Ol,g.SetFontSizeCommand=Dl,g.SetFrozenCommand=jr,g.SetFrozenMutation=Oe,g.SetFrozenMutationFactory=Bs,g.SetGridlinesColorCommand=zr,g.SetGridlinesColorMutation=dt,g.SetHorizontalTextAlignCommand=ei,g.SetItalicCommand=Ul,g.SetNumfmtMutation=Un,g.SetOverlineCommand=Nl,g.SetProtectionCommand=qr,g.SetRangeProtectionMutation=Q,g.SetRangeThemeMutation=vi,g.SetRangeValuesCommand=It,g.SetRangeValuesMutation=F,g.SetRangeValuesUndoMutationFactory=ce,g.SetRowDataCommand=Yr,g.SetRowDataMutation=ct,g.SetRowDataMutationFactory=Ro,g.SetRowHeightCommand=xt,g.SetRowHiddenCommand=_n,g.SetRowHiddenMutation=Je,g.SetRowVisibleMutation=Ke,g.SetSelectedColsVisibleCommand=$s,g.SetSelectedRowsVisibleCommand=Hs,g.SetSelectionsOperation=q,g.SetSpecificColsVisibleCommand=Ut,g.SetSpecificRowsVisibleCommand=Pt,g.SetStrikeThroughCommand=kl,g.SetStyleCommand=ee,g.SetTabColorCommand=si,g.SetTabColorMutation=Gt,g.SetTextColorCommand=Jr,g.SetTextRotationCommand=ni,g.SetTextWrapCommand=ti,g.SetUnderlineCommand=Pl,g.SetVerticalTextAlignCommand=Qr,g.SetWorkbookNameCommand=js,g.SetWorkbookNameMutation=Fs,g.SetWorksheetActivateCommand=Gs,g.SetWorksheetActiveOperation=Ct,g.SetWorksheetColWidthMutation=Ve,g.SetWorksheetColWidthMutationFactory=Hn,g.SetWorksheetColumnCountCommand=oi,g.SetWorksheetColumnCountMutation=mt,g.SetWorksheetColumnCountUndoMutationFactory=Co,g.SetWorksheetDefaultStyleCommand=ri,g.SetWorksheetDefaultStyleMutation=ht,g.SetWorksheetDefaultStyleMutationFactory=So,g.SetWorksheetHideCommand=ai,g.SetWorksheetHideMutation=qe,g.SetWorksheetNameCommand=bn,g.SetWorksheetNameMutation=Yt,g.SetWorksheetOrderCommand=zs,g.SetWorksheetOrderMutation=Kt,g.SetWorksheetPermissionPointsCommand=ui,g.SetWorksheetPermissionPointsMutation=In,g.SetWorksheetProtectionCommand=li,g.SetWorksheetProtectionMutation=st,g.SetWorksheetRangeThemeStyleCommand=Tr,g.SetWorksheetRangeThemeStyleMutation=rt,g.SetWorksheetRangeThemeStyleMutationFactory=io,g.SetWorksheetRightToLeftCommand=Bl,g.SetWorksheetRightToLeftMutation=En,g.SetWorksheetRowAutoHeightMutation=jn,g.SetWorksheetRowAutoHeightMutationFactory=ba,g.SetWorksheetRowCountCommand=di,g.SetWorksheetRowCountMutation=gt,g.SetWorksheetRowCountUndoMutationFactory=fo,g.SetWorksheetRowHeightMutation=Ee,g.SetWorksheetRowIsAutoHeightCommand=Tn,g.SetWorksheetRowIsAutoHeightMutation=Re,g.SetWorksheetShowCommand=qs,g.SheetSkeletonChangeType=vo,g.SheetValueChangeType=po,g.SplitDelimiterEnum=Eo,g.SplitTextToColumnsCommand=ci,g.ToggleCellCheckboxCommand=mi,g.ToggleGridlinesCommand=hi,g.ToggleGridlinesMutation=Rt,g.UnitAction=_,g.UnitObject=D,g.UnregisterWorksheetRangeThemeStyleCommand=gi,g.UnregisterWorksheetRangeThemeStyleMutation=pn,g.VALIDATE_CELL=Qt,g.ViewStateEnum=ko,g.WorkbookCommentPermission=Yn,g.WorkbookCopyPermission=Kn,g.WorkbookCopySheetPermission=Ho,g.WorkbookCreateProtectPermission=Jn,g.WorkbookCreateSheetPermission=xn,g.WorkbookDeleteColumnPermission=Fo,g.WorkbookDeleteRowPermission=jo,g.WorkbookDeleteSheetPermission=Xn,g.WorkbookDuplicatePermission=Zn,g.WorkbookEditablePermission=me,g.WorkbookExportPermission=Qn,g.WorkbookHideSheetPermission=ln,g.WorkbookHistoryPermission=Go,g.WorkbookInsertColumnPermission=zo,g.WorkbookInsertRowPermission=qo,g.WorkbookManageCollaboratorPermission=dn,g.WorkbookMoveSheetPermission=cn,g.WorkbookPrintPermission=es,g.WorkbookRecoverHistoryPermission=ts,g.WorkbookRenameSheetPermission=mn,g.WorkbookSelectionModel=Do,g.WorkbookSharePermission=ns,g.WorkbookViewHistoryPermission=os,g.WorkbookViewPermission=ss,g.WorksheetCopyPermission=rs,g.WorksheetDeleteColumnPermission=is,g.WorksheetDeleteProtectionPermission=as,g.WorksheetDeleteRowPermission=us,g.WorksheetEditExtraObjectPermission=ls,g.WorksheetEditPermission=fe,g.WorksheetFilterPermission=ds,g.WorksheetInsertColumnPermission=cs,g.WorksheetInsertHyperlinkPermission=ms,g.WorksheetInsertRowPermission=hs,g.WorksheetManageCollaboratorPermission=gs,g.WorksheetPivotTablePermission=Rs,g.WorksheetProtectionPointModel=yt,g.WorksheetProtectionRuleModel=ke,g.WorksheetSelectProtectedCellsPermission=hu,g.WorksheetSelectUnProtectedCellsPermission=gu,g.WorksheetSetCellStylePermission=Cs,g.WorksheetSetCellValuePermission=Wt,g.WorksheetSetColumnStylePermission=St,g.WorksheetSetRowStylePermission=ft,g.WorksheetSortPermission=Ss,g.WorksheetViewPermission=Vt,g.addMergeCellsUtil=ol,g.adjustRangeOnMutation=fr,g.alignToMergedCellsBorders=At,g.baseProtectionActions=je,g.checkCellValueType=Vn,g.checkRangesEditablePermission=Od,g.convertPrimaryWithCoordToPrimary=bo,g.convertSelectionDataToRange=Ha,g.copyRangeStyles=$e,g.createTopMatrixFromMatrix=yo,g.createTopMatrixFromRanges=Mo,g.defaultWorkbookPermissionPoints=br,g.defaultWorksheetPermissionPoint=fn,g.expandToContinuousRange=Wa,g.factoryRemoveNumfmtUndoMutation=Fl,g.factorySetNumfmtUndoMutation=Hl,g.findAllRectangle=Gn,g.findFirstNonEmptyCell=xa,g.followSelectionOperation=Ue,g.generateNullCell=qn,g.generateNullCellValue=Uo,g.getAddMergeMutationRangeByType=ks,g.getAllRangePermissionPoint=le,g.getAllWorkbookPermissionPoint=_t,g.getAllWorksheetPermissionPoint=de,g.getAllWorksheetPermissionPointByPointPanel=Ie,g.getCellAtRowCol=ru,g.getDefaultRangePermission=rl,g.getInsertRangeMutations=fs,g.getMoveRangeUndoRedoMutations=rn,g.getNextPrimaryCell=Ad,g.getPrimaryForRange=se,g.getRemoveRangeMutations=Is,g.getSelectionsService=$o,g.getSeparateEffectedRangesOnCommand=Bu,g.getSheetCommandTarget=P,g.getSheetCommandTargetWorkbook=Bn,g.getSheetMutationTarget=ve,g.getSkeletonChangedEffectedRange=Pa,g.getValueChangedEffectedRange=Ua,g.getVisibleRanges=Dt,g.handleBaseInsertRange=et,g.handleBaseMoveRowsCols=Ht,g.handleBaseRemoveRange=Qe,g.handleCommonDefaultRangeChangeWithEffectRefCommands=Ps,g.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests=$u,g.handleDefaultRangeChangeWithEffectRefCommands=Us,g.handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests=Vu,g.handleDeleteRangeMoveLeft=Cr,g.handleDeleteRangeMoveUp=Sr,g.handleDeleteRangeMutation=Cu,g.handleIRemoveCol=Ts,g.handleIRemoveRow=cr,g.handleInsertCol=hr,g.handleInsertRangeMoveDown=gr,g.handleInsertRangeMoveRight=Rr,g.handleInsertRangeMutation=Ru,g.handleInsertRow=mr,g.handleMoveCols=Es,g.handleMoveRange=dr,g.handleMoveRows=bs,g.isSingleCellSelection=au,g.rangeMerge=zn,g.rangeToDiscreteRange=Po,g.rotateRange=he,g.runRefRangeMutations=tt,g.setEndForRange=iu,g.splitRangeText=To,g.transformCellsToRange=Pn,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})}));
