"use strict";var Pe=Object.defineProperty;var je=(n,s,e)=>s in n?Pe(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var p=(n,s,e)=>je(n,typeof s!="symbol"?s+"":s,e);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("@univerjs/core"),g=require("@univerjs/data-validation"),E=require("@univerjs/engine-formula"),_=require("@univerjs/sheets"),b=require("rxjs"),se=require("@univerjs/sheets-formula");var He=Object.getOwnPropertyDescriptor,We=(n,s,e,t)=>{for(var a=t>1?void 0:t?He(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},ce=(n,s)=>(e,t)=>s(e,t,n);exports.DataValidationCacheService=class extends i.Disposable{constructor(e,t,a){super();p(this,"_cacheMatrix",new Map);p(this,"_dirtyRanges$",new b.Subject);p(this,"dirtyRanges$",this._dirtyRanges$.asObservable());this._commandService=e,this._univerInstanceService=t,this._sheetDataValidationModel=a,this._initDirtyRanges(),this._initSheetRemove()}_initDirtyRanges(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===_.SetRangeValuesMutation.id){const{cellValue:t,unitId:a,subUnitId:r}=e.params;if(t){const o=new i.ObjectMatrix(t).getDataRange();if(o.endRow===-1)return;const u=this._sheetDataValidationModel.getRules(a,r).map(c=>c.ranges).flat().map(c=>i.getIntersectRange(c,o)).filter(Boolean);u.length&&this.markRangeDirty(a,r,u,!0)}}}))}_initSheetRemove(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var t;if(e.id===_.RemoveSheetMutation.id){const{unitId:a,subUnitId:r}=e.params;(t=this._cacheMatrix.get(a))==null||t.delete(r)}})),this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(e=>{e.type===i.UniverInstanceType.UNIVER_SHEET&&this._cacheMatrix.delete(e.getUnitId())}))}_ensureCache(e,t){let a=this._cacheMatrix.get(e);a||(a=new Map,this._cacheMatrix.set(e,a));let r=a.get(t);return r||(r=new i.ObjectMatrix,a.set(t,r)),r}ensureCache(e,t){return this._ensureCache(e,t)}addRule(e,t,a){this.markRangeDirty(e,t,a.ranges)}removeRule(e,t,a){this._deleteRange(e,t,a.ranges)}markRangeDirty(e,t,a,r){const o=this._ensureCache(e,t);a.forEach(l=>{i.Range.foreach(l,(d,u)=>{o.getValue(d,u)!==void 0&&o.setValue(d,u,void 0)})}),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:a,isSetRange:r})}_deleteRange(e,t,a){const r=this._ensureCache(e,t);a.forEach(o=>{i.Range.foreach(o,(l,d)=>{r.realDeleteValue(l,d)})}),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:a})}getValue(e,t,a,r){return this._ensureCache(e,t).getValue(a,r)}};exports.DataValidationCacheService=We([ce(0,i.Inject(i.ICommandService)),ce(1,i.Inject(i.IUniverInstanceService)),ce(2,i.Inject(g.DataValidationModel))],exports.DataValidationCacheService);function w(n){var s,e;return(e=(s=n==null?void 0:n[0])==null?void 0:s[0])==null?void 0:e.v}function j(n){var s;return(s=n==null?void 0:n[0])==null?void 0:s[0]}function M(n){return!E.ERROR_TYPE_SET.has(n)}function Y(n,s){var t;const e=s.getValidatorItem(n);return(t=e==null?void 0:e.offsetFormulaByRange)!=null?t:!1}var $e=Object.getOwnPropertyDescriptor,ke=(n,s,e,t)=>{for(var a=t>1?void 0:t?$e(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},x=(n,s)=>(e,t)=>s(e,t,n);exports.DataValidationCustomFormulaService=class extends i.Disposable{constructor(e,t,a,r,o){super();p(this,"_ruleFormulaMap",new Map);p(this,"_ruleFormulaMap2",new Map);this._instanceSrv=e,this._registerOtherFormulaService=t,this._dataValidationModel=a,this._dataValidationCacheService=r,this._validatorRegistryService=o,this._initFormulaResultHandler(),this._initDirtyRanges()}dispose(){super.dispose(),this._ruleFormulaMap.clear(),this._ruleFormulaMap2.clear()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(const t in e){const a=e[t];if(this._instanceSrv.getUnitType(t)===i.UniverInstanceType.UNIVER_SHEET)for(const o in a){const l=a[o],{ruleFormulaMap:d}=this._ensureMaps(t,o);l.forEach(u=>{var h,S;const c=d.get((h=u.extra)==null?void 0:h.ruleId),m=this._dataValidationModel.getRuleById(t,o,(S=u.extra)==null?void 0:S.ruleId);m&&c&&this._dataValidationCacheService.markRangeDirty(t,o,m.ranges)})}}}))}_ensureMaps(e,t){let a=this._ruleFormulaMap.get(e),r=this._ruleFormulaMap2.get(e);a||(a=new Map,this._ruleFormulaMap.set(e,a)),r||(r=new Map,this._ruleFormulaMap2.set(e,r));let o=a.get(t);o||(o=new Map,a.set(t,o));let l=r.get(t);return l||(l=new Map,r.set(t,l)),{ruleFormulaMap:o,ruleFormulaMap2:l}}_registerFormula(e,t,a,r,o){return this._registerOtherFormulaService.registerFormulaWithRange(e,t,r,o,{ruleId:a})}_handleDirtyRanges(e,t,a){this._dataValidationModel.getRules(e,t).forEach(o=>{const l=o.ranges;i.Rectangle.doAnyRangesIntersect(l,a)&&this.makeRuleDirty(e,t,o.uid)})}_initDirtyRanges(){this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.subscribe(e=>{e.isSetRange&&this._handleDirtyRanges(e.unitId,e.subUnitId,e.ranges)}))}deleteByRuleId(e,t,a){const{ruleFormulaMap:r,ruleFormulaMap2:o}=this._ensureMaps(e,t),l=this._dataValidationModel.getRuleById(e,t,a),d=r.get(a);if(!l||!d)return;const u=r.get(a);u&&(r.delete(a),this._registerOtherFormulaService.deleteFormula(e,t,[u.formulaId]));const c=o.get(a);c&&(o.delete(a),this._registerOtherFormulaService.deleteFormula(e,t,[c.formulaId]))}_addFormulaByRange(e,t,a,r,o,l){const{ruleFormulaMap:d,ruleFormulaMap2:u}=this._ensureMaps(e,t),c=l[0].startRow,m=l[0].startColumn;if(r&&i.isFormulaString(r)){const h=this._registerFormula(e,t,a,r,l);d.set(a,{formula:r,originCol:m,originRow:c,formulaId:h})}if(o&&i.isFormulaString(o)){const h=this._registerFormula(e,t,a,o,l);u.set(a,{formula:o,originCol:m,originRow:c,formulaId:h})}}addRule(e,t,a){if(Y(a.type,this._validatorRegistryService)){const{ranges:r,formula1:o,formula2:l,uid:d}=a;this._addFormulaByRange(e,t,d,o,l,r)}}async getCellFormulaValue(e,t,a,r,o){var v,V;const{ruleFormulaMap:l}=this._ensureMaps(e,t),d=l.get(a);if(!d)return Promise.resolve(void 0);const u=await this._registerOtherFormulaService.getFormulaValue(e,t,d.formulaId),{originRow:c,originCol:m}=d,h=r-c,S=o-m;return j((V=(v=u==null?void 0:u.result)==null?void 0:v[h])==null?void 0:V[S])}async getCellFormula2Value(e,t,a,r,o){var v,V;const{ruleFormulaMap2:l}=this._ensureMaps(e,t),d=l.get(a);if(!d)return Promise.resolve(void 0);const u=await this._registerOtherFormulaService.getFormulaValue(e,t,d.formulaId),{originRow:c,originCol:m}=d,h=r-c,S=o-m;return j((V=(v=u==null?void 0:u.result)==null?void 0:v[h])==null?void 0:V[S])}getCellFormulaValueSync(e,t,a,r,o){var v,V;const{ruleFormulaMap:l}=this._ensureMaps(e,t),d=l.get(a);if(!d)return;const u=this._registerOtherFormulaService.getFormulaValueSync(e,t,d.formulaId),{originRow:c,originCol:m}=d,h=r-c,S=o-m;return j((V=(v=u==null?void 0:u.result)==null?void 0:v[h])==null?void 0:V[S])}getCellFormula2ValueSync(e,t,a,r,o){var v,V;const{ruleFormulaMap2:l}=this._ensureMaps(e,t),d=l.get(a);if(!d)return;const u=this._registerOtherFormulaService.getFormulaValueSync(e,t,d.formulaId),{originRow:c,originCol:m}=d,h=r-c,S=o-m;return j((V=(v=u==null?void 0:u.result)==null?void 0:v[h])==null?void 0:V[S])}getRuleFormulaInfo(e,t,a){const{ruleFormulaMap:r}=this._ensureMaps(e,t);return r.get(a)}makeRuleDirty(e,t,a){var l,d,u,c;const r=(d=(l=this._ruleFormulaMap.get(e))==null?void 0:l.get(t))==null?void 0:d.get(a),o=(c=(u=this._ruleFormulaMap2.get(e))==null?void 0:u.get(t))==null?void 0:c.get(a);r&&this._registerOtherFormulaService.markFormulaDirty(e,t,r.formulaId),o&&this._registerOtherFormulaService.markFormulaDirty(e,t,o.formulaId)}};exports.DataValidationCustomFormulaService=ke([x(0,i.IUniverInstanceService),x(1,i.Inject(se.RegisterOtherFormulaService)),x(2,i.Inject(g.DataValidationModel)),x(3,i.Inject(exports.DataValidationCacheService)),x(4,i.Inject(g.DataValidatorRegistryService))],exports.DataValidationCustomFormulaService);var qe=Object.getOwnPropertyDescriptor,Qe=(n,s,e,t)=>{for(var a=t>1?void 0:t?qe(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},P=(n,s)=>(e,t)=>s(e,t,n);exports.DataValidationFormulaService=class extends i.Disposable{constructor(e,t,a,r,o){super();p(this,"_formulaRuleMap",new Map);this._instanceService=e,this._registerOtherFormulaService=t,this._dataValidationCacheService=a,this._dataValidationModel=r,this._validatorRegistryService=o,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(const t in e){const a=e[t];if(this._instanceService.getUnitType(t)===i.UniverInstanceType.UNIVER_SHEET)for(const o in a){const l=a[o],d=this._ensureRuleFormulaMap(t,o);l.forEach(u=>{var c,m;if(d.get((c=u.extra)==null?void 0:c.ruleId)){const h=this._dataValidationModel.getRuleById(t,o,(m=u.extra)==null?void 0:m.ruleId);h&&this._dataValidationCacheService.markRangeDirty(t,o,h.ranges)}})}}}))}_ensureRuleFormulaMap(e,t){let a=this._formulaRuleMap.get(e);a||(a=new Map,this._formulaRuleMap.set(e,a));let r=a.get(t);return r||(r=new Map,a.set(t,r)),r}_registerSingleFormula(e,t,a,r){const o=[{startColumn:0,endColumn:0,startRow:0,endRow:0}];return this._registerOtherFormulaService.registerFormulaWithRange(e,t,a,o,{ruleId:r})}addRule(e,t,a){if(!Y(a.type,this._validatorRegistryService)&&a.type!==i.DataValidationType.CHECKBOX){const{formula1:r,formula2:o,uid:l}=a,d=i.isFormulaString(r),u=i.isFormulaString(o);if(!d&&!u)return;const c=this._ensureRuleFormulaMap(e,t),m=[void 0,void 0];if(d){const h=this._registerSingleFormula(e,t,r,l);m[0]={id:h,text:r}}if(u){const h=this._registerSingleFormula(e,t,o,l);m[1]={id:h,text:o}}c.set(l,m)}}removeRule(e,t,a){const o=this._ensureRuleFormulaMap(e,t).get(a);if(!o)return;const[l,d]=o,u=[l==null?void 0:l.id,d==null?void 0:d.id].filter(Boolean);u.length&&this._registerOtherFormulaService.deleteFormula(e,t,u)}getRuleFormulaResult(e,t,a){const o=this._ensureRuleFormulaMap(e,t).get(a);if(!o)return Promise.resolve(null);const l=async d=>d&&this._registerOtherFormulaService.getFormulaValue(e,t,d.id);return Promise.all([l(o[0]),l(o[1])])}getRuleFormulaResultSync(e,t,a){const o=this._ensureRuleFormulaMap(e,t).get(a);if(o)return o.map(l=>{if(l)return this._registerOtherFormulaService.getFormulaValueSync(e,t,l.id)})}getRuleFormulaInfo(e,t,a){return this._ensureRuleFormulaMap(e,t).get(a)}};exports.DataValidationFormulaService=Qe([P(0,i.IUniverInstanceService),P(1,i.Inject(se.RegisterOtherFormulaService)),P(2,i.Inject(exports.DataValidationCacheService)),P(3,i.Inject(g.DataValidationModel)),P(4,i.Inject(g.DataValidatorRegistryService))],exports.DataValidationFormulaService);function L(n){return i.getOriginCellValue(n)}function Ee(n){var s;return String((s=L(n))!=null?s:"")}class ve{constructor(s,e,t,a,r=!1){p(this,"_map");p(this,"_tree",new i.RBush);p(this,"_dirty",!0);p(this,"_buildTree",()=>{if(!this._dirty||this._disableTree)return;this._tree.clear();const s=[];this._map.forEach((e,t)=>{e.forEach(a=>{s.push({minX:a.startRow,maxX:a.endRow,minY:a.startColumn,maxY:a.endColumn,ruleId:t})})}),this._tree.load(s),this._dirty=!1});p(this,"_debonceBuildTree",i.debounce(this._buildTree,0));this._unitId=e,this._subUnitId=t,this._univerInstanceService=a,this._disableTree=r,this._map=s,this._buildTree()}get _worksheet(){var s;return(s=this._univerInstanceService.getUnit(this._unitId,i.UniverInstanceType.UNIVER_SHEET))==null?void 0:s.getSheetBySheetId(this._subUnitId)}_addRule(s,e){if(!this._worksheet)return;const t=i.Rectangle.mergeRanges(e.map(a=>i.Range.transformRange(a,this._worksheet)));this._map.forEach((a,r)=>{const o=i.Rectangle.subtractMulti(a,t);o.length===0?this._map.delete(r):this._map.set(r,o)}),this._dirty=!0,this._map.set(s,t),this._debonceBuildTree()}addRule(s){this._addRule(s.uid,s.ranges)}removeRange(s){if(!this._worksheet)return;const e=s.map(t=>i.Range.transformRange(t,this._worksheet));this._map.forEach((t,a)=>{const r=i.Rectangle.subtractMulti(t,e);r.length===0?this._map.delete(a):this._map.set(a,r)}),this._dirty=!0,this._debonceBuildTree()}_removeRule(s){this._map.delete(s),this._dirty=!0,this._debonceBuildTree()}removeRule(s){this._removeRule(s.uid)}updateRange(s,e){this._removeRule(s),this._addRule(s,e)}addRangeRules(s){s.forEach(({id:e,ranges:t})=>{if(!t.length)return;let a=this._map.get(e);a?(this._map.set(e,i.Rectangle.mergeRanges([...a,...t])),a=this._map.get(e)):(a=t,this._map.set(e,a)),this._map.forEach((r,o)=>{if(o===e)return;const l=i.Rectangle.subtractMulti(r,t);l.length===0?this._map.delete(o):this._map.set(o,l)})}),this._dirty=!0,this._debonceBuildTree()}diff(s){const e=[];let t=0;return s.forEach((a,r)=>{var d;const o=(d=this._map.get(a.uid))!=null?d:[],l=a.ranges;o.length!==0&&(o.length!==l.length||o.some((u,c)=>!i.Rectangle.equals(u,l[c])))&&e.push({type:"update",ruleId:a.uid,oldRanges:l,newRanges:i.Rectangle.sort(o),rule:a}),o.length===0&&(e.push({type:"delete",rule:a,index:r-t}),t++)}),e}diffWithAddition(s,e){const t=[];let a=0;return s.forEach((r,o)=>{var u;const l=(u=this._map.get(r.uid))!=null?u:[],d=r.ranges;l.length!==0&&(l.length!==d.length||l.some((c,m)=>!i.Rectangle.equals(c,d[m])))&&t.push({type:"update",ruleId:r.uid,oldRanges:d,newRanges:i.Rectangle.sort(l),rule:r}),l.length===0&&(t.push({type:"delete",rule:r,index:o-a}),a++)}),Array.from(e).forEach(r=>{var l;const o=(l=this._map.get(r.uid))!=null?l:[];t.push({type:"add",rule:{...r,ranges:i.Rectangle.sort(o)}})}),t}clone(){return new ve(new Map(i.Tools.deepClone(Array.from(this._map.entries()))),this._unitId,this._subUnitId,this._univerInstanceService,!0)}getValue(s,e){this._dirty&&this._buildTree();const t=this._tree.search({minX:s,maxX:s,minY:e,maxY:e});return t.length>0?t[0].ruleId:void 0}}var Ge=Object.getOwnPropertyDescriptor,Ye=(n,s,e,t)=>{for(var a=t>1?void 0:t?Ge(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},C=(n,s)=>(e,t)=>s(e,t,n);exports.SheetDataValidationModel=class extends i.Disposable{constructor(e,t,a,r,o,l,d){super();p(this,"_ruleMatrixMap",new Map);p(this,"_validStatusChange$",new b.Subject);p(this,"_ruleChange$",new b.Subject);p(this,"ruleChange$",this._ruleChange$.asObservable());p(this,"validStatusChange$",this._validStatusChange$.asObservable());this._dataValidationModel=e,this._univerInstanceService=t,this._dataValidatorRegistryService=a,this._dataValidationCacheService=r,this._dataValidationFormulaService=o,this._dataValidationCustomFormulaService=l,this._commandService=d,this._initRuleUpdateListener(),this.disposeWithMe(()=>{this._ruleChange$.complete(),this._validStatusChange$.complete()}),this._initUniverInstanceListener()}_initUniverInstanceListener(){this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(e=>{this._ruleMatrixMap.delete(e.getUnitId())})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===_.RemoveSheetMutation.id){const{unitId:t,subUnitId:a}=e.params,r=this._ruleMatrixMap.get(t);r&&r.delete(a)}}))}_initRuleUpdateListener(){const e=this._dataValidationModel.getAll();for(const[t,a]of e)for(const[r,o]of a)for(const l of o)this._addRule(t,r,l),this._ruleChange$.next({type:"add",unitId:t,subUnitId:r,rule:l,source:"patched"});this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(t=>{switch(t.type){case"add":this._addRule(t.unitId,t.subUnitId,t.rule);break;case"update":this._updateRule(t.unitId,t.subUnitId,t.rule.uid,t.oldRule,t.updatePayload);break;case"remove":this._removeRule(t.unitId,t.subUnitId,t.rule);break}this._ruleChange$.next(t)}))}_ensureRuleMatrix(e,t){let a=this._ruleMatrixMap.get(e);a||(a=new Map,this._ruleMatrixMap.set(e,a));let r=a.get(t);return r||(r=new ve(new Map,e,t,this._univerInstanceService),a.set(t,r)),r}_addRuleSideEffect(e,t,a){this._ensureRuleMatrix(e,t).addRule(a),this._dataValidationCacheService.addRule(e,t,a),this._dataValidationFormulaService.addRule(e,t,a),this._dataValidationCustomFormulaService.addRule(e,t,a)}_addRule(e,t,a){(Array.isArray(a)?a:[a]).forEach(o=>{this._addRuleSideEffect(e,t,o)})}_updateRule(e,t,a,r,o){const l=this._ensureRuleMatrix(e,t),d={...r,...o.payload};o.type===g.UpdateRuleType.RANGE?l.updateRange(a,o.payload):o.type===g.UpdateRuleType.ALL&&l.updateRange(a,o.payload.ranges),this._dataValidationCacheService.removeRule(e,t,r),this._dataValidationCacheService.addRule(e,t,d),this._dataValidationFormulaService.removeRule(e,t,r.uid),this._dataValidationFormulaService.addRule(e,t,d),this._dataValidationCustomFormulaService.deleteByRuleId(e,t,a),this._dataValidationCustomFormulaService.addRule(e,t,d)}_removeRule(e,t,a){this._ensureRuleMatrix(e,t).removeRule(a),this._dataValidationCacheService.removeRule(e,t,a),this._dataValidationCustomFormulaService.deleteByRuleId(e,t,a.uid)}getValidator(e){return this._dataValidatorRegistryService.getValidatorItem(e)}getRuleIdByLocation(e,t,a,r){return this._ensureRuleMatrix(e,t).getValue(a,r)}getRuleByLocation(e,t,a,r){const o=this.getRuleIdByLocation(e,t,a,r);if(o)return this._dataValidationModel.getRuleById(e,t,o)}validator(e,t,a){const{col:r,row:o,unitId:l,subUnitId:d,worksheet:u}=t,c=(V,R)=>{a&&a(V,R),R&&this._validStatusChange$.next({unitId:l,subUnitId:d,ruleId:e.uid,status:V,row:o,col:r})},m=u.getCellValueOnly(o,r),h=this.getValidator(e.type),S=u.getCellRaw(o,r),v=L(S);if(h){const V=this._dataValidationCacheService.ensureCache(l,d),R=V.getValue(o,r);return R==null?(V.setValue(o,r,i.DataValidationStatus.VALIDATING),h.validator({value:v,unitId:l,subUnitId:d,row:o,column:r,worksheet:t.worksheet,workbook:t.workbook,interceptValue:L(m),t:S==null?void 0:S.t},e).then(f=>{const D=f?i.DataValidationStatus.VALID:i.DataValidationStatus.INVALID,y=V.getValue(o,r);D===i.DataValidationStatus.VALID?V.realDeleteValue(o,r):V.setValue(o,r,D),c(D,R!==y)}),i.DataValidationStatus.VALIDATING):(c(R!=null?R:i.DataValidationStatus.VALID,!1),R!=null?R:i.DataValidationStatus.VALID)}else return c(i.DataValidationStatus.VALID,!1),i.DataValidationStatus.VALID}getRuleObjectMatrix(e,t){return this._ensureRuleMatrix(e,t)}getRuleById(e,t,a){return this._dataValidationModel.getRuleById(e,t,a)}getRuleIndex(e,t,a){return this._dataValidationModel.getRuleIndex(e,t,a)}getRules(e,t){return[...this._dataValidationModel.getRules(e,t)]}getUnitRules(e){return this._dataValidationModel.getUnitRules(e)}deleteUnitRules(e){return this._dataValidationModel.deleteUnitRules(e)}getSubUnitIds(e){return this._dataValidationModel.getSubUnitIds(e)}getAll(){return this._dataValidationModel.getAll()}};exports.SheetDataValidationModel=Ye([C(0,i.Inject(g.DataValidationModel)),C(1,i.IUniverInstanceService),C(2,i.Inject(g.DataValidatorRegistryService)),C(3,i.Inject(exports.DataValidationCacheService)),C(4,i.Inject(exports.DataValidationFormulaService)),C(5,i.Inject(exports.DataValidationCustomFormulaService)),C(6,i.ICommandService)],exports.SheetDataValidationModel);const $=1,k=0;function _e(n,s){return i.Tools.isBlank(n)?s.t("dataValidation.validFail.value"):i.isFormulaString(n)?s.t("dataValidation.validFail.primitive"):""}const H=n=>i.Tools.isDefine(n)&&String(n).toLowerCase()==="true"?"1":String(n).toLowerCase()==="false"?"0":n;class ye extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"id",i.DataValidationType.CHECKBOX);p(this,"title","dataValidation.checkbox.title");p(this,"operators",[]);p(this,"scopes",["sheet"]);p(this,"order",41);p(this,"offsetFormulaByRange",!1);p(this,"_formulaService",this.injector.get(exports.DataValidationFormulaService));p(this,"skipDefaultFontRender",(e,t,a)=>{const{unitId:r,subUnitId:o}=a,{formula1:l,formula2:d}=this.parseFormulaSync(e,r,o),u=`${t!=null?t:""}`;return!u||u===`${l}`||u===`${d}`})}validatorFormula(e,t,a){const{formula1:r,formula2:o}=e,l=r===o;if(i.Tools.isBlank(r)&&i.Tools.isBlank(o))return{success:!0};if(l)return{success:!1,formula1:this.localeService.t("dataValidation.validFail.checkboxEqual"),formula2:this.localeService.t("dataValidation.validFail.checkboxEqual")};const d=_e(r,this.localeService),u=_e(o,this.localeService);return{success:!d&&!u,formula1:d,formula2:u}}async parseFormula(e,t,a){var m,h,S,v;const{formula1:r=$,formula2:o=k}=e,l=await this._formulaService.getRuleFormulaResult(t,a,e.uid),d=i.isFormulaString(r)?w((h=(m=l==null?void 0:l[0])==null?void 0:m.result)==null?void 0:h[0][0]):r,u=i.isFormulaString(o)?w((v=(S=l==null?void 0:l[1])==null?void 0:S.result)==null?void 0:v[0][0]):o,c=M(String(d))&&M(String(u));return{formula1:H(d),formula2:H(u),originFormula1:d,originFormula2:u,isFormulaValid:c}}getExtraStyle(e,t){return{tb:i.WrapStrategy.CLIP}}parseFormulaSync(e,t,a){var m,h,S,v;const{formula1:r=$,formula2:o=k}=e,l=this._formulaService.getRuleFormulaResultSync(t,a,e.uid),d=i.isFormulaString(r)?w((h=(m=l==null?void 0:l[0])==null?void 0:m.result)==null?void 0:h[0][0]):r,u=i.isFormulaString(o)?w((v=(S=l==null?void 0:l[1])==null?void 0:S.result)==null?void 0:v[0][0]):o,c=M(String(d))&&M(String(u));return{formula1:H(d),formula2:H(u),originFormula1:d,originFormula2:u,isFormulaValid:c}}async isValidType(e,t,a){const{value:r,unitId:o,subUnitId:l}=e,{formula1:d,formula2:u,originFormula1:c,originFormula2:m}=await this.parseFormula(a,o,l);return!i.Tools.isDefine(d)||!i.Tools.isDefine(u)?!0:i.Tools.isDefine(r)&&(String(r)===String(d)||String(r)===String(u)||String(r)===String(c!=null?c:"")||String(r)===String(m!=null?m:""))}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.checkbox.error")}generateRuleName(e){return this.titleStr}}const Xe={[i.DataValidationOperator.BETWEEN]:"dataValidation.date.operators.between",[i.DataValidationOperator.EQUAL]:"dataValidation.date.operators.equal",[i.DataValidationOperator.GREATER_THAN]:"dataValidation.date.operators.greaterThan",[i.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.operators.greaterThanOrEqual",[i.DataValidationOperator.LESS_THAN]:"dataValidation.date.operators.lessThan",[i.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.operators.lessThanOrEqual",[i.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.operators.notBetween",[i.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.operators.notEqual"};i.DataValidationOperator.BETWEEN+"",i.DataValidationOperator.EQUAL+"",i.DataValidationOperator.GREATER_THAN+"",i.DataValidationOperator.GREATER_THAN_OR_EQUAL+"",i.DataValidationOperator.LESS_THAN+"",i.DataValidationOperator.LESS_THAN_OR_EQUAL+"",i.DataValidationOperator.NOT_BETWEEN+"",i.DataValidationOperator.NOT_EQUAL+"";const De={[i.DataValidationOperator.BETWEEN]:"dataValidation.date.ruleName.between",[i.DataValidationOperator.EQUAL]:"dataValidation.date.ruleName.equal",[i.DataValidationOperator.GREATER_THAN]:"dataValidation.date.ruleName.greaterThan",[i.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.ruleName.greaterThanOrEqual",[i.DataValidationOperator.LESS_THAN]:"dataValidation.date.ruleName.lessThan",[i.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.ruleName.lessThanOrEqual",[i.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.ruleName.notBetween",[i.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.ruleName.notEqual",NONE:"dataValidation.date.ruleName.legal"},Ke={[i.DataValidationOperator.BETWEEN]:"dataValidation.date.errorMsg.between",[i.DataValidationOperator.EQUAL]:"dataValidation.date.errorMsg.equal",[i.DataValidationOperator.GREATER_THAN]:"dataValidation.date.errorMsg.greaterThan",[i.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.greaterThanOrEqual",[i.DataValidationOperator.LESS_THAN]:"dataValidation.date.errorMsg.lessThan",[i.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.lessThanOrEqual",[i.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.errorMsg.notBetween",[i.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.errorMsg.notEqual",NONE:"dataValidation.date.errorMsg.legal"},le=[i.DataValidationOperator.BETWEEN,i.DataValidationOperator.NOT_BETWEEN],q="{FORMULA1}",Q="{FORMULA2}";function ze(n){return n.filter(Boolean).join(",")}function W(n){return n.split(",").filter(Boolean)}function Ze(n){const s=L(n);return s==null?"":s.toString()}function X(n,s,e){const{formula1:t,formula2:a}=s,r=s.ranges[0].startRow,o=s.ranges[0].startColumn,l=e.row-r,d=e.col-o,u=i.isFormulaString(t)?n.moveFormulaRefOffset(t,d,l,!0):t,c=i.isFormulaString(a)?n.moveFormulaRefOffset(a,d,l,!0):a;return{transformedFormula1:u,transformedFormula2:c}}const me=n=>{var e,t;if(n==null||typeof n=="boolean")return;if(typeof n=="number"||!Number.isNaN(+n))return+n;const s=(e=i.numfmt.parseDate(n))==null?void 0:e.v;return i.Tools.isDefine(s)?s:(t=i.numfmt.parseDate(i.dayjs(n).format("YYYY-MM-DD HH:mm:ss")))==null?void 0:t.v};class Te extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"id",i.DataValidationType.DATE);p(this,"title","dataValidation.date.title");p(this,"order",40);p(this,"operators",[i.DataValidationOperator.BETWEEN,i.DataValidationOperator.EQUAL,i.DataValidationOperator.GREATER_THAN,i.DataValidationOperator.GREATER_THAN_OR_EQUAL,i.DataValidationOperator.LESS_THAN,i.DataValidationOperator.LESS_THAN_OR_EQUAL,i.DataValidationOperator.NOT_BETWEEN,i.DataValidationOperator.NOT_EQUAL]);p(this,"scopes",["sheet"]);p(this,"_customFormulaService",this.injector.get(exports.DataValidationCustomFormulaService));p(this,"_lexerTreeBuilder",this.injector.get(E.LexerTreeBuilder))}async parseFormula(e,t,a,r,o){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,r,o),d=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,r,o),{formula1:u,formula2:c}=e,m=M(String(l==null?void 0:l.v))&&M(String(d==null?void 0:d.v));return{formula1:me(i.isFormulaString(u)?l==null?void 0:l.v:u),formula2:me(i.isFormulaString(c)?d==null?void 0:d.v:c),isFormulaValid:m}}async isValidType(e){const{interceptValue:t,value:a}=e;return typeof a=="number"&&typeof t=="string"||typeof t=="string"?!!i.numfmt.parseDate(t):!1}_validatorSingleFormula(e){return!i.Tools.isBlank(e)&&(i.isFormulaString(e)||!Number.isNaN(+e)||!!(e&&i.numfmt.parseDate(e)))}validatorFormula(e,t,a){const r=e.operator;if(!r)return{success:!0};const o=this._validatorSingleFormula(e.formula1),l=this.localeService.t("dataValidation.validFail.date");if(le.includes(r)){const u=this._validatorSingleFormula(e.formula2);return{success:o&&u,formula1:o?void 0:l,formula2:u?void 0:l}}return{success:o,formula1:o?void 0:l}}normalizeFormula(e,t,a){const{formula1:r,formula2:o,bizInfo:l}=e,d=u=>{var m;if(!u)return u;let c;if(!Number.isNaN(+u))c=i.numfmt.dateFromSerial(+u);else{const h=(m=i.numfmt.parseDate(u))==null?void 0:m.v;if(h==null)return"";c=i.numfmt.dateFromSerial(h)}return i.dayjs(`${c[0]}/${c[1]}/${c[2]} ${c[3]}:${c[4]}:${c[5]}`).format(l!=null&&l.showTime?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD")};return{formula1:i.isFormulaString(r)?r:d(`${r}`),formula2:i.isFormulaString(o)?o:d(`${o}`)}}transform(e,t,a){const{value:r}=e;return{...e,value:me(r)}}get operatorNames(){return this.operators.map(e=>this.localeService.t(Xe[e]))}generateRuleName(e){var a,r;if(!e.operator)return this.localeService.t(De.NONE);const t=this.localeService.t(De[e.operator]).replace(q,(a=e.formula1)!=null?a:"").replace(Q,(r=e.formula2)!=null?r:"");return`${this.titleStr} ${t}`}generateRuleErrorMessage(e,t){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:r}=X(this._lexerTreeBuilder,e,t);return`${this.localeService.t(Ke[e.operator]).replace(q,a!=null?a:"").replace(Q,r!=null?r:"")}`}}i.DataValidationOperator.BETWEEN+"",i.DataValidationOperator.EQUAL+"",i.DataValidationOperator.GREATER_THAN+"",i.DataValidationOperator.GREATER_THAN_OR_EQUAL+"",i.DataValidationOperator.LESS_THAN+"",i.DataValidationOperator.LESS_THAN_OR_EQUAL+"",i.DataValidationOperator.NOT_BETWEEN+"",i.DataValidationOperator.NOT_EQUAL+"";i.DataValidationOperator.BETWEEN+"",i.DataValidationOperator.EQUAL+"",i.DataValidationOperator.GREATER_THAN+"",i.DataValidationOperator.GREATER_THAN_OR_EQUAL+"",i.DataValidationOperator.LESS_THAN+"",i.DataValidationOperator.LESS_THAN_OR_EQUAL+"",i.DataValidationOperator.NOT_BETWEEN+"",i.DataValidationOperator.NOT_EQUAL+"";const ae={[i.DataValidationOperator.BETWEEN]:"dataValidation.errorMsg.between",[i.DataValidationOperator.EQUAL]:"dataValidation.errorMsg.equal",[i.DataValidationOperator.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[i.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[i.DataValidationOperator.LESS_THAN]:"dataValidation.errorMsg.lessThan",[i.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[i.DataValidationOperator.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[i.DataValidationOperator.NOT_EQUAL]:"dataValidation.errorMsg.notEqual",NONE:"dataValidation.errorMsg.legal"};function G(n){return+n}class Je extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"_customFormulaService",this.injector.get(exports.DataValidationCustomFormulaService));p(this,"id",i.DataValidationType.DECIMAL);p(this,"_lexerTreeBuilder",this.injector.get(E.LexerTreeBuilder));p(this,"title","dataValidation.decimal.title");p(this,"order",20);p(this,"operators",[i.DataValidationOperator.BETWEEN,i.DataValidationOperator.EQUAL,i.DataValidationOperator.GREATER_THAN,i.DataValidationOperator.GREATER_THAN_OR_EQUAL,i.DataValidationOperator.LESS_THAN,i.DataValidationOperator.LESS_THAN_OR_EQUAL,i.DataValidationOperator.NOT_BETWEEN,i.DataValidationOperator.NOT_EQUAL]);p(this,"scopes",["sheet"])}_isFormulaOrNumber(e){return!i.Tools.isBlank(e)&&(i.isFormulaString(e)||!Number.isNaN(+e))}async isValidType(e,t,a){const{value:r}=e;return!Number.isNaN(G(r))}transform(e,t,a){const{value:r}=e;return{...e,value:G(r)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,t,a,r,o){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,r,o),d=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,r,o),{formula1:u,formula2:c}=e,m=M(String(l==null?void 0:l.v))&&M(String(d==null?void 0:d.v));return{formula1:this._parseNumber(i.isFormulaString(u)?l==null?void 0:l.v:u),formula2:this._parseNumber(i.isFormulaString(c)?d==null?void 0:d.v:c),isFormulaValid:m}}validatorFormula(e,t,a){const r=e.operator;if(!r)return{success:!0};const o=i.Tools.isDefine(e.formula1)&&this._isFormulaOrNumber(e.formula1),l=i.Tools.isDefine(e.formula2)&&this._isFormulaOrNumber(e.formula2),d=le.includes(r),u=this.localeService.t("dataValidation.validFail.number");return d?{success:o&&l,formula1:o?void 0:u,formula2:l?void 0:u}:{success:o,formula1:o?"":u}}generateRuleErrorMessage(e,t){if(!e.operator)return this.localeService.t(ae.NONE).replace("{TYPE}",this.titleStr);const{transformedFormula1:a,transformedFormula2:r}=X(this._lexerTreeBuilder,e,t);return`${this.localeService.t(ae[e.operator]).replace(q,a!=null?a:"").replace(Q,r!=null?r:"")}`}}function he(n){if(!n)return[];const s=new Set;return n.forEach(e=>{e.forEach(t=>{var r,o;const a=L(t);if(a!=null){if(typeof a!="string"&&typeof(t==null?void 0:t.s)=="object"&&((o=(r=t.s)==null?void 0:r.n)!=null&&o.pattern)){s.add(i.numfmt.format(t.s.n.pattern,a,{throws:!1}));return}M(a.toString())&&s.add(a.toString())}})}),[...s]}const et=["if","indirect","choose","offset"];function tt(n,s){if(!i.isFormulaString(n)||E.isReferenceString(n.slice(1)))return!0;const t=s.sequenceNodesBuilder(n);return t&&t.some(a=>typeof a=="object"&&a.nodeType===E.sequenceNodeType.FUNCTION&&et.indexOf(a.token.toLowerCase())>-1)}function at(n,s){const{formula1:e="",ranges:t}=n;if(E.isReferenceString(e.slice(1))){const r=E.deserializeRangeWithSheet(e.slice(1));if((!r.sheetName||r.sheetName===s)&&t.some(o=>i.Rectangle.intersects(o,r.range)))return!0}return!1}class Ve extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"formulaService",this.injector.get(exports.DataValidationFormulaService));p(this,"_lexer",this.injector.get(E.LexerTreeBuilder));p(this,"_univerInstanceService",this.injector.get(i.IUniverInstanceService));p(this,"order",50);p(this,"offsetFormulaByRange",!1);p(this,"id",i.DataValidationType.LIST);p(this,"title","dataValidation.list.title");p(this,"operators",[]);p(this,"scopes",["sheet"]);p(this,"skipDefaultFontRender",e=>e.renderMode!==i.DataValidationRenderMode.TEXT)}validatorFormula(e,t,a){var u,c,m;const r=!i.Tools.isBlank(e.formula1),o=tt((u=e.formula1)!=null?u:"",this._lexer),l=(m=(c=this._univerInstanceService.getUnit(t,i.UniverInstanceType.UNIVER_SHEET))==null?void 0:c.getSheetBySheetId(a))==null?void 0:m.getName(),d=at(e,l!=null?l:"");return{success:!!(r&&o&&!d),formula1:r?o?d?this.localeService.t("dataValidation.validFail.listIntersects"):void 0:this.localeService.t("dataValidation.validFail.listInvalid"):this.localeService.t("dataValidation.validFail.list")}}getExtraStyle(e,t,{style:a}){var o;const r=(o=a.tb!==i.WrapStrategy.OVERFLOW?a.tb:i.WrapStrategy.CLIP)!=null?o:i.WrapStrategy.WRAP;if(e.type===i.DataValidationType.LIST&&(e.renderMode===i.DataValidationRenderMode.ARROW||e.renderMode===i.DataValidationRenderMode.TEXT)){const l=this.getListWithColorMap(e),d=`${t!=null?t:""}`,u=l[d];if(u)return{bg:{rgb:u},tb:r}}return{tb:r}}parseCellValue(e){const t=e.toString();return W(t)}async parseFormula(e,t,a){var d,u;const r=await this.formulaService.getRuleFormulaResult(t,a,e.uid),o=w((u=(d=r==null?void 0:r[0])==null?void 0:d.result)==null?void 0:u[0][0]);return{formula1:void 0,formula2:void 0,isFormulaValid:M(String(o))}}async isValidType(e,t,a){var h,S;const{value:r,unitId:o,subUnitId:l}=e,{formula1:d=""}=a,u=await this.formulaService.getRuleFormulaResult(o,l,a.uid),c=i.isFormulaString(d)?he((S=(h=u==null?void 0:u[0])==null?void 0:h.result)==null?void 0:S[0][0]):W(d);return this.parseCellValue(r).every(v=>c.includes(v))}generateRuleName(){return this.localeService.t("dataValidation.list.name")}generateRuleErrorMessage(){return this.localeService.t("dataValidation.list.error")}getList(e,t,a){var h,S,v,V;const{formula1:r=""}=e,o=this.injector.get(i.IUniverInstanceService),l=(h=t?o.getUniverSheetInstance(t):void 0)!=null?h:o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return[];const d=(S=a?l.getSheetBySheetId(a):void 0)!=null?S:l.getActiveSheet();if(!d)return[];const u=l.getUnitId(),c=d.getSheetId(),m=this.formulaService.getRuleFormulaResultSync(u,c,e.uid);return i.isFormulaString(r)?he((V=(v=m==null?void 0:m[0])==null?void 0:v.result)==null?void 0:V[0][0]):W(r)}async getListAsync(e,t,a){var h,S,v,V;const{formula1:r=""}=e,o=this.injector.get(i.IUniverInstanceService),l=(h=t?o.getUniverSheetInstance(t):void 0)!=null?h:o.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);if(!l)return[];const d=(S=a?l.getSheetBySheetId(a):void 0)!=null?S:l.getActiveSheet();if(!d)return[];const u=l.getUnitId(),c=d.getSheetId(),m=await this.formulaService.getRuleFormulaResult(u,c,e.uid);return i.isFormulaString(r)?he((V=(v=m==null?void 0:m[0])==null?void 0:v.result)==null?void 0:V[0][0]):W(r)}getListWithColor(e,t,a){const r=this.getList(e,t,a),o=(e.formula2||"").split(",");return r.map((l,d)=>({label:l,color:o[d]}))}getListWithColorMap(e,t,a){const r=this.getListWithColor(e,t,a),o={};return r.forEach(l=>{l.color&&(o[l.label]=l.color)}),o}}class rt extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"id",i.DataValidationType.TEXT_LENGTH);p(this,"title","dataValidation.textLength.title");p(this,"_lexerTreeBuilder",this.injector.get(E.LexerTreeBuilder));p(this,"order",30);p(this,"operators",[i.DataValidationOperator.BETWEEN,i.DataValidationOperator.EQUAL,i.DataValidationOperator.GREATER_THAN,i.DataValidationOperator.GREATER_THAN_OR_EQUAL,i.DataValidationOperator.LESS_THAN,i.DataValidationOperator.LESS_THAN_OR_EQUAL,i.DataValidationOperator.NOT_BETWEEN,i.DataValidationOperator.NOT_EQUAL]);p(this,"scopes",["sheet"]);p(this,"_customFormulaService",this.injector.get(exports.DataValidationCustomFormulaService))}_isFormulaOrInt(e){return!i.Tools.isBlank(e)&&(i.isFormulaString(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}validatorFormula(e,t,a){const r=e.operator;if(!r)return{success:!1};const o=i.Tools.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),l=i.Tools.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),d=le.includes(r),u=this.localeService.t("dataValidation.validFail.number");return d?{success:o&&l,formula1:o?void 0:u,formula2:l?void 0:u}:{success:o,formula1:u}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,t,a,r,o){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,r,o),d=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,r,o),{formula1:u,formula2:c}=e,m=M(String(l==null?void 0:l.v))&&M(String(d==null?void 0:d.v));return{formula1:this._parseNumber(i.isFormulaString(u)?l==null?void 0:l.v:u),formula2:this._parseNumber(i.isFormulaString(c)?d==null?void 0:d.v:c),isFormulaValid:m}}transform(e,t,a){return{...e,value:e.value.toString().length}}async isValidType(e,t,a){const{value:r}=e;return typeof r=="string"||typeof r=="number"}generateRuleErrorMessage(e,t){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:r}=X(this._lexerTreeBuilder,e,t);return`${this.localeService.t(g.TextLengthErrorTitleMap[e.operator]).replace(q,a!=null?a:"").replace(Q,r!=null?r:"")}`}}function Fe(n){var e,t;return n?n.p?!((t=(e=n.p.body)==null?void 0:e.dataStream)!=null?t:"").slice(0,-2).trim():i.Tools.isBlank(n.v):!0}function K(n,s,e,t,a="command",r=!0){const o=t.get(E.LexerTreeBuilder),l=t.get(g.DataValidatorRegistryService),d=[],u=[],c=t.get(exports.SheetDataValidationModel),m=t.get(i.IUniverInstanceService),h=_.getSheetCommandTarget(m,{unitId:n,subUnitId:s});if(!h)return{redoMutations:d,undoMutations:u};const{worksheet:S}=h,v=new i.ObjectMatrix;let V=!1;function R(f,D){r&&f.forEach(y=>{i.Range.foreach(y,(T,O)=>{const F=S.getCellRaw(T,O),N=Ee(F);(Fe(F)||N===D)&&!(F!=null&&F.p)&&(V=!0,v.setValue(T,O,{v:D,p:null}))})})}if(e.forEach(f=>{switch(f.type){case"delete":d.push({id:g.RemoveDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.rule.uid,source:a}}),u.unshift({id:g.AddDataValidationMutation.id,params:{unitId:n,subUnitId:s,rule:f.rule,index:f.index,source:a}});break;case"update":{if(Y(f.rule.type,l)){const y=f.oldRanges[0].startRow,T=f.oldRanges[0].startColumn,O=f.newRanges[0].startRow,F=f.newRanges[0].startColumn,N=O-y,z=F-T,Z=i.isFormulaString(f.rule.formula1)?o.moveFormulaRefOffset(f.rule.formula1,z,N):f.rule.formula1,J=i.isFormulaString(f.rule.formula2)?o.moveFormulaRefOffset(f.rule.formula2,z,N):f.rule.formula2;Z!==f.rule.formula1||J!==f.rule.formula2||!i.isRangesEqual(f.newRanges,f.oldRanges)?(d.push({id:g.UpdateDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.ruleId,payload:{type:g.UpdateRuleType.ALL,payload:{formula1:Z,formula2:J,ranges:f.newRanges}}}}),u.unshift({id:g.UpdateDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.ruleId,payload:{type:g.UpdateRuleType.ALL,payload:{formula1:f.rule.formula1,formula2:f.rule.formula2,ranges:f.oldRanges}}}})):(d.push({id:g.UpdateDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.ruleId,payload:{type:g.UpdateRuleType.RANGE,payload:f.newRanges},source:a}}),u.unshift({id:g.UpdateDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.ruleId,payload:{type:g.UpdateRuleType.RANGE,payload:f.oldRanges},source:a}}))}else d.push({id:g.UpdateDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.ruleId,payload:{type:g.UpdateRuleType.RANGE,payload:f.newRanges},source:a}}),u.unshift({id:g.UpdateDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.ruleId,payload:{type:g.UpdateRuleType.RANGE,payload:f.oldRanges},source:a}});const D=c.getRuleById(n,s,f.ruleId);if(D&&D.type===i.DataValidationType.CHECKBOX){const T=c.getValidator(i.DataValidationType.CHECKBOX).parseFormulaSync(D,n,s);R(f.newRanges,T.formula2)}break}case"add":{if(d.push({id:g.AddDataValidationMutation.id,params:{unitId:n,subUnitId:s,rule:f.rule,source:a}}),u.unshift({id:g.RemoveDataValidationMutation.id,params:{unitId:n,subUnitId:s,ruleId:f.rule.uid,source:a}}),f.rule.type===i.DataValidationType.CHECKBOX){const y=c.getValidator(i.DataValidationType.CHECKBOX).parseFormulaSync(f.rule,n,s);R(f.rule.ranges,y.originFormula2)}break}}}),V){const f={id:_.SetRangeValuesMutation.id,params:{unitId:n,subUnitId:s,cellValue:v.getData()}},D={id:_.SetRangeValuesMutation.id,params:_.SetRangeValuesUndoMutationFactory(t,f.params)};d.push(f),u.push(D)}return{redoMutations:d,undoMutations:u}}const Oe={type:i.CommandType.COMMAND,id:"sheet.command.updateDataValidationRuleRange",handler(n,s){if(!s)return!1;const{unitId:e,subUnitId:t,ranges:a,ruleId:r}=s,o=n.get(exports.SheetDataValidationModel),l=n.get(i.ICommandService),d=n.get(i.IUndoRedoService);if(!o.getRuleById(e,t,r))return!1;const c=o.getRuleObjectMatrix(e,t).clone();c.updateRange(r,a);const m=c.diff(o.getRules(e,t)),{redoMutations:h,undoMutations:S}=K(e,t,m,n);return d.pushUndoRedo({undoMutations:S,redoMutations:h,unitID:e}),i.sequenceExecute(h,l),!0}},Ie={type:i.CommandType.COMMAND,id:"sheet.command.addDataValidation",handler(n,s){if(!s)return!1;const{unitId:e,subUnitId:t,rule:a}=s,r=n.get(exports.SheetDataValidationModel),o=n.get(i.ICommandService),l=n.get(i.IUndoRedoService),d=r.getRuleObjectMatrix(e,t).clone();d.addRule(a);const u=d.diff(r.getRules(e,t)),c=r.getValidator(a.type),m={unitId:e,subUnitId:t,rule:{...a,...c==null?void 0:c.normalizeFormula(a,e,t)}},{redoMutations:h,undoMutations:S}=K(e,t,u,n);return h.push({id:g.AddDataValidationMutation.id,params:m}),S.unshift({id:g.RemoveDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:a.uid}}),l.pushUndoRedo({unitID:e,redoMutations:h,undoMutations:S}),i.sequenceExecute(h,o),!0}},Ce={type:i.CommandType.COMMAND,id:"sheets.command.update-data-validation-setting",handler(n,s){if(!s)return!1;const e=n.get(i.ICommandService),t=n.get(i.IUndoRedoService),a=n.get(exports.SheetDataValidationModel),r=n.get(g.DataValidatorRegistryService),{unitId:o,subUnitId:l,ruleId:d,setting:u}=s,c=r.getValidatorItem(u.type);if(!c)return!1;const m=a.getRuleById(o,l,d);if(!m)return!1;const h={...m,...u};if(!c.validatorFormula(h,o,l).success)return!1;const S={unitId:o,subUnitId:l,ruleId:d,payload:{type:g.UpdateRuleType.SETTING,payload:{...u,...c.normalizeFormula(h,o,l)}}},v=[{id:g.UpdateDataValidationMutation.id,params:S}],V={unitId:o,subUnitId:l,ruleId:d,payload:{type:g.UpdateRuleType.SETTING,payload:g.getRuleSetting(m)}},R=[{id:g.UpdateDataValidationMutation.id,params:V}];if(u.type===i.DataValidationType.CHECKBOX){const D=m.ranges,y=n.get(i.IUniverInstanceService),T=_.getSheetCommandTarget(y,{unitId:o,subUnitId:l});if(T){const O=new i.ObjectMatrix,{worksheet:F}=T,{formula2:N=k,formula1:z=$}=m,{formula2:Z=k,formula1:J=$}=u;let de=!1;if(D.forEach(ee=>{i.Range.foreach(ee,(B,ue)=>{const I=F.getCellRaw(B,ue),Re=Ee(I);(Fe(I)||Re===String(N))&&!(I!=null&&I.p)?(O.setValue(B,ue,{v:Z,p:null}),de=!0):Re===String(z)&&!(I!=null&&I.p)&&(O.setValue(B,ue,{v:J,p:null}),de=!0)})}),de){const ee={id:_.SetRangeValuesMutation.id,params:{unitId:o,subUnitId:l,cellValue:O.getData()}},B={id:_.SetRangeValuesMutation.id,params:_.SetRangeValuesUndoMutationFactory(n,ee.params)};v.push(ee),R.push(B)}}}return i.sequenceExecute(v,e).result?(t.pushUndoRedo({unitID:o,redoMutations:v,undoMutations:R}),!0):!1}},Ne={type:i.CommandType.COMMAND,id:"sheets.command.update-data-validation-options",handler(n,s){if(!s)return!1;const e=n.get(i.ICommandService),t=n.get(i.IUndoRedoService),a=n.get(exports.SheetDataValidationModel),{unitId:r,subUnitId:o,ruleId:l,options:d}=s,u=a.getRuleById(r,o,l);if(!u)return!1;const c={unitId:r,subUnitId:o,ruleId:l,payload:{type:g.UpdateRuleType.OPTIONS,payload:d}},m=[{id:g.UpdateDataValidationMutation.id,params:c}],h={unitId:r,subUnitId:o,ruleId:l,payload:{type:g.UpdateRuleType.OPTIONS,payload:g.getRuleOptions(u)}},S=[{id:g.UpdateDataValidationMutation.id,params:h}];return t.pushUndoRedo({unitID:r,redoMutations:m,undoMutations:S}),e.executeCommand(g.UpdateDataValidationMutation.id,c),!0}},Ae={type:i.CommandType.COMMAND,id:"sheets.command.clear-range-data-validation",handler(n,s){if(!s)return!1;const{unitId:e,subUnitId:t,ranges:a}=s,r=n.get(i.ICommandService),o=n.get(i.IUniverInstanceService),l=_.getSheetCommandTarget(o,{unitId:e,subUnitId:t}),d=n.get(exports.SheetDataValidationModel);if(!l)return!1;const u=n.get(i.IUndoRedoService),c=d.getRuleObjectMatrix(e,t).clone();c.removeRange(a);const m=c.diff(d.getRules(e,t)),{redoMutations:h,undoMutations:S}=K(e,t,m,n);return u.pushUndoRedo({unitID:e,redoMutations:h,undoMutations:S}),i.sequenceExecute(h,r).result}},Ue={type:i.CommandType.COMMAND,id:"sheet.command.remove-all-data-validation",handler(n,s){if(!s)return!1;const{unitId:e,subUnitId:t}=s,a=n.get(i.ICommandService),r=n.get(exports.SheetDataValidationModel),o=n.get(i.IUndoRedoService),l=[...r.getRules(e,t)],d={unitId:e,subUnitId:t,ruleId:l.map(m=>m.uid)},u=[{id:g.RemoveDataValidationMutation.id,params:d}],c=[{id:g.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:l}}];return o.pushUndoRedo({redoMutations:u,undoMutations:c,unitID:e}),a.executeCommand(g.RemoveDataValidationMutation.id,d),!0}},it=(n,s)=>{const e=n.get(exports.SheetDataValidationModel),{unitId:t,subUnitId:a,ruleId:r,source:o}=s;if(Array.isArray(r)){const d=r.map(u=>e.getRuleById(t,a,u)).filter(Boolean);return[{id:g.AddDataValidationMutation.id,params:{unitId:t,subUnitId:a,rule:d,source:o}}]}return[{id:g.AddDataValidationMutation.id,params:{unitId:t,subUnitId:a,rule:{...e.getRuleById(t,a,r)},index:e.getRuleIndex(t,a,r)}}]},we={type:i.CommandType.COMMAND,id:"sheet.command.remove-data-validation-rule",handler(n,s){if(!s)return!1;const{unitId:e,subUnitId:t,ruleId:a}=s,r=n.get(i.ICommandService),o=n.get(i.IUndoRedoService),l=n.get(exports.SheetDataValidationModel),d=[{id:g.RemoveDataValidationMutation.id,params:s}],u=[{id:g.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:{...l.getRuleById(e,t,a)},index:l.getRuleIndex(e,t,a)}}];return o.pushUndoRedo({undoMutations:u,redoMutations:d,unitID:s.unitId}),r.executeCommand(g.RemoveDataValidationMutation.id,s),!0}},be="SHEET_DATA_VALIDATION_PLUGIN";var Le=(n=>(n[n.View=0]="View",n[n.Edit=1]="Edit",n[n.ManageCollaborator=2]="ManageCollaborator",n[n.Print=3]="Print",n[n.Duplicate=4]="Duplicate",n[n.Comment=5]="Comment",n[n.Copy=6]="Copy",n[n.Share=7]="Share",n[n.Export=8]="Export",n[n.MoveWorksheet=9]="MoveWorksheet",n[n.DeleteWorksheet=10]="DeleteWorksheet",n[n.HideWorksheet=11]="HideWorksheet",n[n.RenameWorksheet=12]="RenameWorksheet",n[n.CreateWorksheet=13]="CreateWorksheet",n[n.SetWorksheetStyle=14]="SetWorksheetStyle",n[n.EditWorksheetCell=15]="EditWorksheetCell",n[n.InsertHyperlink=16]="InsertHyperlink",n[n.Sort=17]="Sort",n[n.Filter=18]="Filter",n[n.PivotTable=19]="PivotTable",n[n.FloatImg=20]="FloatImg",n[n.History=21]="History",n[n.RwHgtClWdt=22]="RwHgtClWdt",n[n.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",n[n.ViewFilter=24]="ViewFilter",n[n.MoveSheet=25]="MoveSheet",n[n.DeleteSheet=26]="DeleteSheet",n[n.HideSheet=27]="HideSheet",n[n.CopySheet=28]="CopySheet",n[n.RenameSheet=29]="RenameSheet",n[n.CreateSheet=30]="CreateSheet",n[n.SelectProtectedCells=31]="SelectProtectedCells",n[n.SelectUnProtectedCells=32]="SelectUnProtectedCells",n[n.SetCellStyle=33]="SetCellStyle",n[n.SetCellValue=34]="SetCellValue",n[n.SetRowStyle=35]="SetRowStyle",n[n.SetColumnStyle=36]="SetColumnStyle",n[n.InsertRow=37]="InsertRow",n[n.InsertColumn=38]="InsertColumn",n[n.DeleteRow=39]="DeleteRow",n[n.DeleteColumn=40]="DeleteColumn",n[n.EditExtraObject=41]="EditExtraObject",n[n.Delete=42]="Delete",n[n.RecoverHistory=43]="RecoverHistory",n[n.ViewHistory=44]="ViewHistory",n[n.CreatePermissionObject=45]="CreatePermissionObject",n[n.UNRECOGNIZED=-1]="UNRECOGNIZED",n))(Le||{}),ot=Object.getOwnPropertyDescriptor,nt=(n,s,e,t)=>{for(var a=t>1?void 0:t?ot(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},pe=(n,s)=>(e,t)=>s(e,t,n);exports.DataValidationFormulaController=class extends i.Disposable{constructor(s,e,t){super(),this._univerInstanceService=s,this._permissionService=e,this._lexerTreeBuilder=t}getFormulaRefCheck(s){var t,a;const e=this._lexerTreeBuilder.sequenceNodesBuilder(s);if(!e)return!0;for(let r=0;r<e.length;r++){const o=e[r];if(typeof o=="string")continue;const{token:l}=o,d=E.deserializeRangeWithSheetWithCache(l),u=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);let c=u.getActiveSheet();const m=u.getUnitId();if(d.sheetName){if(c=u.getSheetBySheetName(d.sheetName),!c)return!1;const R=c==null?void 0:c.getSheetId();if(!this._permissionService.getPermissionPoint(new _.WorksheetViewPermission(m,R).id))return!1}if(!c)return!1;const{startRow:h,endRow:S,startColumn:v,endColumn:V}=d.range;for(let R=h;R<=S;R++)for(let f=v;f<=V;f++){const D=(a=(t=c.getCell(R,f))==null?void 0:t.selectionProtection)==null?void 0:a[0];if((D==null?void 0:D[Le.View])===!1)return!1}}return!0}};exports.DataValidationFormulaController=nt([pe(0,i.IUniverInstanceService),pe(1,i.IPermissionService),pe(2,i.Inject(E.LexerTreeBuilder))],exports.DataValidationFormulaController);const st="sheets-data-validation.config",Me={};var lt=Object.getOwnPropertyDescriptor,dt=(n,s,e,t)=>{for(var a=t>1?void 0:t?lt(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},ge=(n,s)=>(e,t)=>s(e,t,n);let re=class extends i.Disposable{constructor(s,e,t){super();p(this,"_disposableMap",new Map);p(this,"registerRule",(s,e,t)=>{Y(t.type,this._validatorRegistryService)&&this.register(s,e,t)});this._dataValidationModel=s,this._formulaRefRangeService=e,this._validatorRegistryService=t,this._initRefRange()}_getIdWithUnitId(s,e,t){return`${s}_${e}_${t}`}register(s,e,t){const a=t.ranges,r=t.formula1,o=t.formula2,l=this._formulaRefRangeService.registerRangeFormula(s,e,a,[r!=null?r:"",o!=null?o:""],u=>{if(u.length===0)return{undos:[{id:g.AddDataValidationMutation.id,params:{unitId:s,subUnitId:e,rule:t,source:"patched"}}],redos:[{id:g.RemoveDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,source:"patched"}}]};const c=[],m=[],h=u[0];c.push({id:g.UpdateDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:g.UpdateRuleType.ALL,payload:{ranges:h.ranges,formula1:h.formulas[0],formula2:h.formulas[1]}},source:"patched"}}),m.push({id:g.UpdateDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:g.UpdateRuleType.ALL,payload:{ranges:a,formula1:r,formula2:o}},source:"patched"}});for(let S=1;S<u.length;S++){const v=u[S],V=i.generateRandomId();c.push({id:g.AddDataValidationMutation.id,params:{unitId:s,subUnitId:e,rule:{...t,uid:V,formula1:v.formulas[0],formula2:v.formulas[1],ranges:v.ranges},source:"patched"}}),m.push({id:g.RemoveDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:V,source:"patched"}})}return{undos:m,redos:c}}),d=this._getIdWithUnitId(s,e,t.uid);this._disposableMap.set(d,l)}_initRefRange(){const s=this._dataValidationModel.getAll();for(const[e,t]of s)for(const[a,r]of t)for(const o of r)this.registerRule(e,a,o);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{const{unitId:t,subUnitId:a,rule:r}=e;switch(e.type){case"add":{const o=e.rule;this.registerRule(e.unitId,e.subUnitId,o);break}case"remove":{const o=this._disposableMap.get(this._getIdWithUnitId(t,a,r.uid));o&&o.dispose();break}case"update":{const o=e.rule,l=this._disposableMap.get(this._getIdWithUnitId(t,a,o.uid));l&&l.dispose(),this.registerRule(e.unitId,e.subUnitId,o);break}}})),this.disposeWithMe(i.toDisposable(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}};re=dt([ge(0,i.Inject(exports.SheetDataValidationModel)),ge(1,i.Inject(se.FormulaRefRangeService)),ge(2,i.Inject(g.DataValidatorRegistryService))],re);var ut=Object.getOwnPropertyDescriptor,ct=(n,s,e,t)=>{for(var a=t>1?void 0:t?ut(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},A=(n,s)=>(e,t)=>s(e,t,n);let ie=class extends i.Disposable{constructor(s,e,t,a,r,o){super();p(this,"_disposableMap",new Map);p(this,"registerRule",(s,e,t)=>{Y(t.type,this._validatorRegistryService)||(this.register(s,e,t),this.registerFormula(s,e,t))});this._dataValidationModel=s,this._injector=e,this._refRangeService=t,this._dataValidationFormulaService=a,this._formulaRefRangeService=r,this._validatorRegistryService=o,this._initRefRange()}_getIdWithUnitId(s,e,t){return`${s}_${e}_${t}`}registerFormula(s,e,t){var u;const a=t.uid,r=this._getIdWithUnitId(s,e,a),o=(u=this._disposableMap.get(r))!=null?u:new Set,l=(c,m)=>{const h=this._dataValidationModel.getRuleById(s,e,a);if(!h)return{redos:[],undos:[]};const S=h[c];if(!S||S===m)return{redos:[],undos:[]};const v={unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:g.UpdateRuleType.SETTING,payload:{type:h.type,formula1:h.formula1,formula2:h.formula2,[c]:m}},source:"patched"},V={unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:g.UpdateRuleType.SETTING,payload:{type:h.type,formula1:h.formula1,formula2:h.formula2}},source:"patched"},R=[{id:g.UpdateDataValidationMutation.id,params:v}],f=[{id:g.UpdateDataValidationMutation.id,params:V}];return{redos:R,undos:f}},d=this._dataValidationFormulaService.getRuleFormulaInfo(s,e,a);if(d){const[c,m]=d;if(c){const h=this._formulaRefRangeService.registerFormula(s,e,c.text,S=>l("formula1",S));o.add(()=>h.dispose())}if(m){const h=this._formulaRefRangeService.registerFormula(s,e,m.text,S=>l("formula2",S));o.add(()=>h.dispose())}}}register(s,e,t){var d;const a=u=>{const c=[...t.ranges],h=c.map(v=>_.handleCommonDefaultRangeChangeWithEffectRefCommands(v,u)).filter(v=>!!v).flat();if(i.isRangesEqual(h,c))return{redos:[],undos:[]};if(h.length){const v={unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:g.UpdateRuleType.RANGE,payload:h},source:"patched"},V=[{id:g.UpdateDataValidationMutation.id,params:v}],R=[{id:g.UpdateDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:g.UpdateRuleType.RANGE,payload:c},source:"patched"}}];return{redos:V,undos:R}}else{const v={unitId:s,subUnitId:e,ruleId:t.uid},V=[{id:g.RemoveDataValidationMutation.id,params:v}],R=it(this._injector,v);return{redos:V,undos:R}}},r=[];t.ranges.forEach(u=>{const c=this._refRangeService.registerRefRange(u,a,s,e);r.push(()=>c.dispose())});const o=this._getIdWithUnitId(s,e,t.uid),l=(d=this._disposableMap.get(o))!=null?d:new Set;l.add(()=>r.forEach(u=>u())),this._disposableMap.set(o,l)}_initRefRange(){const s=this._dataValidationModel.getAll();for(const[e,t]of s)for(const[a,r]of t)for(const o of r)this.registerRule(e,a,o);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{const{unitId:t,subUnitId:a,rule:r}=e;switch(e.type){case"add":{const o=e.rule;this.registerRule(e.unitId,e.subUnitId,o);break}case"remove":{const o=this._disposableMap.get(this._getIdWithUnitId(t,a,r.uid));o&&o.forEach(l=>l());break}case"update":{const o=e.rule,l=this._disposableMap.get(this._getIdWithUnitId(t,a,o.uid));l&&l.forEach(d=>d()),this.registerRule(e.unitId,e.subUnitId,o);break}}})),this.disposeWithMe(i.toDisposable(()=>{this._disposableMap.forEach(e=>{e.forEach(t=>t())}),this._disposableMap.clear()}))}};ie=ct([A(0,i.Inject(exports.SheetDataValidationModel)),A(1,i.Inject(i.Injector)),A(2,i.Inject(_.RefRangeService)),A(3,i.Inject(exports.DataValidationFormulaService)),A(4,i.Inject(se.FormulaRefRangeService)),A(5,i.Inject(g.DataValidatorRegistryService))],ie);var mt=Object.getOwnPropertyDescriptor,ht=(n,s,e,t)=>{for(var a=t>1?void 0:t?mt(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},Se=(n,s)=>(e,t)=>s(e,t,n);let oe=class extends i.Disposable{constructor(n,s,e){super(),this._sheetInterceptorService=n,this._univerInstanceService=s,this._sheetDataValidationModel=e,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:n=>{var s;if(n.id===_.RemoveSheetCommand.id){const e=n.params,t=e.unitId||this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId(),a=this._univerInstanceService.getUniverSheetInstance(t);if(!a)return{redos:[],undos:[]};const r=e.subUnitId||((s=a.getActiveSheet())==null?void 0:s.getSheetId());if(!r)return{redos:[],undos:[]};const o=this._sheetDataValidationModel.getRules(t,r);if(o.length===0)return{redos:[],undos:[]};const l=o.map(c=>c.uid),d={unitId:t,subUnitId:r,ruleId:l,source:"patched"},u={unitId:t,subUnitId:r,rule:[...o],source:"patched"};return{redos:[{id:g.RemoveDataValidationMutation.id,params:d}],undos:[{id:g.AddDataValidationMutation.id,params:u}]}}else if(n.id===_.CopySheetCommand.id){const e=n.params,{unitId:t,subUnitId:a,targetSubUnitId:r}=e;if(!t||!a||!r)return{redos:[],undos:[]};const o=this._sheetDataValidationModel.getRules(t,a);if(o.length===0)return{redos:[],undos:[]};const l=o.map(d=>({...d,uid:i.generateRandomId(6)}));return{redos:[{id:g.AddDataValidationMutation.id,params:{unitId:t,subUnitId:r,rule:l,source:"patched"}}],undos:[{id:g.RemoveDataValidationMutation.id,params:{unitId:t,subUnitId:r,ruleId:l.map(d=>d.uid),source:"patched"}}]}}return{redos:[],undos:[]}}}))}};oe=ht([Se(0,i.Inject(_.SheetInterceptorService)),Se(1,i.Inject(i.IUniverInstanceService)),Se(2,i.Inject(exports.SheetDataValidationModel))],oe);class pt extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"id",i.DataValidationType.ANY);p(this,"title","dataValidation.any.title");p(this,"operators",[]);p(this,"scopes",["sheet"]);p(this,"order",0);p(this,"offsetFormulaByRange",!1)}async parseFormula(e,t,a){return{formula1:e.formula1,formula2:e.formula2,isFormulaValid:!0}}validatorFormula(e,t,a){return{success:!0}}async isValidType(e,t,a){return!0}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.any.error")}}class gt extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"id",i.DataValidationType.CUSTOM);p(this,"title","dataValidation.custom.title");p(this,"operators",[]);p(this,"scopes",["sheet"]);p(this,"order",60);p(this,"_customFormulaService",this.injector.get(exports.DataValidationCustomFormulaService));p(this,"_lexerTreeBuilder",this.injector.get(E.LexerTreeBuilder))}validatorFormula(e,t,a){var u;const r=i.isFormulaString(e.formula1),o=(u=e.formula1)!=null?u:"",d=this._lexerTreeBuilder.checkIfAddBracket(o)===0&&o.startsWith(E.operatorToken.EQUALS);return{success:r&&d,formula1:r&&d?"":this.localeService.t("dataValidation.validFail.formula")}}async parseFormula(e,t,a){return{formula1:void 0,formula2:void 0,isFormulaValid:!0}}async isValidType(e,t,a){const{column:r,row:o,unitId:l,subUnitId:d}=e,u=await this._customFormulaService.getCellFormulaValue(l,d,a.uid,o,r),c=u==null?void 0:u.v;return M(String(c))&&i.Tools.isDefine(c)&&c!==""?u.t===i.CellValueType.BOOLEAN?!!c:typeof c=="boolean"?c:typeof c=="number"?!!c:typeof c=="string"?M(c):!!c:!1}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.custom.error")}generateRuleName(e){var t;return this.localeService.t("dataValidation.custom.ruleName").replace("{FORMULA1}",(t=e.formula1)!=null?t:"")}}class Be extends Ve{constructor(){super(...arguments);p(this,"id",i.DataValidationType.LIST_MULTIPLE);p(this,"title","dataValidation.listMultiple.title");p(this,"offsetFormulaByRange",!1);p(this,"skipDefaultFontRender",()=>!0)}}class St extends g.BaseDataValidator{constructor(){super(...arguments);p(this,"_customFormulaService",this.injector.get(exports.DataValidationCustomFormulaService));p(this,"_lexerTreeBuilder",this.injector.get(E.LexerTreeBuilder));p(this,"id",i.DataValidationType.WHOLE);p(this,"title","dataValidation.whole.title");p(this,"order",10);p(this,"operators",[i.DataValidationOperator.BETWEEN,i.DataValidationOperator.EQUAL,i.DataValidationOperator.GREATER_THAN,i.DataValidationOperator.GREATER_THAN_OR_EQUAL,i.DataValidationOperator.LESS_THAN,i.DataValidationOperator.LESS_THAN_OR_EQUAL,i.DataValidationOperator.NOT_BETWEEN,i.DataValidationOperator.NOT_EQUAL]);p(this,"scopes",["sheet"])}_isFormulaOrInt(e){return!i.Tools.isBlank(e)&&(i.isFormulaString(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}async isValidType(e,t,a){const{value:r}=e,o=G(r);return!Number.isNaN(o)&&Number.isInteger(o)}transform(e,t,a){const{value:r}=e;return{...e,value:G(r)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,t,a,r,o){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,r,o),d=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,r,o),{formula1:u,formula2:c}=e,m=i.isFormulaString(u)?l==null?void 0:l.v:u,h=i.isFormulaString(c)?d==null?void 0:d.v:c,S=M(`${m}`)&&M(`${h}`);return{formula1:this._parseNumber(m),formula2:this._parseNumber(h),isFormulaValid:S}}validatorFormula(e,t,a){const r=e.operator;if(!r)return{success:!0};const o=i.Tools.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),l=i.Tools.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),d=le.includes(r),u=this.localeService.t("dataValidation.validFail.number");return d?{success:o&&l,formula1:o?void 0:u,formula2:l?void 0:u}:{success:o,formula1:u}}generateRuleErrorMessage(e,t){if(!e.operator)return this.localeService.t(ae.NONE).replace("{TYPE}",this.titleStr);const{transformedFormula1:a,transformedFormula2:r}=X(this._lexerTreeBuilder,e,t);return`${this.localeService.t(ae[e.operator]).replace(q,a!=null?a:"").replace(Q,r!=null?r:"")}`}}var ft=Object.getOwnPropertyDescriptor,vt=(n,s,e,t)=>{for(var a=t>1?void 0:t?ft(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},U=(n,s)=>(e,t)=>s(e,t,n);let ne=class extends i.RxDisposable{constructor(n,s,e,t,a,r){super(),this._univerInstanceService=n,this._dataValidatorRegistryService=s,this._injector=e,this._selectionManagerService=t,this._sheetInterceptorService=a,this._sheetDataValidationModel=r,this._init()}_init(){this._registerValidators(),this._initCommandInterceptor()}_registerValidators(){[pt,Je,St,rt,Te,ye,Ve,Be,gt].forEach(n=>{const s=this._injector.createInstance(n);this.disposeWithMe(this._dataValidatorRegistryService.register(s)),this.disposeWithMe(i.toDisposable(()=>this._injector.delete(n)))})}_initCommandInterceptor(){this._sheetInterceptorService.interceptCommand({getMutations:n=>{var s;if(n.id===_.ClearSelectionAllCommand.id){const e=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),t=e.getUnitId(),a=e.getActiveSheet();if(!a)throw new Error("No active sheet found");const r=a.getSheetId(),o=(s=this._selectionManagerService.getCurrentSelections())==null?void 0:s.map(m=>m.range),l=this._sheetDataValidationModel.getRuleObjectMatrix(t,r).clone();o&&l.removeRange(o);const d=l.diff(this._sheetDataValidationModel.getRules(t,r)),{redoMutations:u,undoMutations:c}=K(t,r,d,this._injector,"patched");return{undos:c,redos:u}}return{undos:[],redos:[]}}})}};ne=vt([U(0,i.IUniverInstanceService),U(1,i.Inject(g.DataValidatorRegistryService)),U(2,i.Inject(i.Injector)),U(3,i.Inject(_.SheetsSelectionsService)),U(4,i.Inject(_.SheetInterceptorService)),U(5,i.Inject(exports.SheetDataValidationModel))],ne);var Vt=Object.getOwnPropertyDescriptor,Rt=(n,s,e,t)=>{for(var a=t>1?void 0:t?Vt(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},te=(n,s)=>(e,t)=>s(e,t,n);exports.SheetsDataValidationValidatorService=class extends i.Disposable{constructor(s,e,t,a){super(),this._univerInstanceService=s,this._sheetDataValidationModel=e,this._dataValidationCacheService=t,this._lifecycleService=a,this._initRecalculate()}_initRecalculate(){const s=e=>{if(e.length===0)return;const t=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),a=t==null?void 0:t.getActiveSheet(),r={};e.flat().forEach(o=>{r[o.unitId]||(r[o.unitId]={}),r[o.unitId][o.subUnitId]||(r[o.unitId][o.subUnitId]=[]);const l=this._univerInstanceService.getUnit(o.unitId,i.UniverInstanceType.UNIVER_SHEET),d=l==null?void 0:l.getSheetBySheetId(o.subUnitId);d&&r[o.unitId][o.subUnitId].push(...o.ranges.map(u=>i.Range.transformRange(u,d)))}),Object.entries(r).forEach(([o,l])=>{Object.entries(l).forEach(([d,u])=>{(t==null?void 0:t.getUnitId())===o&&(a==null?void 0:a.getSheetId())===d?this.validatorRanges(o,d,u):requestIdleCallback(()=>{this.validatorRanges(o,d,u)})})})};this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(b.bufferWhen(()=>this._lifecycleService.lifecycle$.pipe(b.filter(e=>e===i.LifecycleStages.Rendered)))).subscribe(s)),this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(b.filter(()=>this._lifecycleService.stage>=i.LifecycleStages.Rendered),i.bufferDebounceTime(20)).subscribe(s))}async _validatorByCell(s,e,t,a){const r=s.getUnitId(),o=e.getSheetId();if(!i.Tools.isDefine(t)||!i.Tools.isDefine(a))throw new Error(`row or col is not defined, row: ${t}, col: ${a}`);const l=this._sheetDataValidationModel.getRuleByLocation(r,o,t,a);return l?new Promise(d=>{this._sheetDataValidationModel.validator(l,{unitId:r,subUnitId:o,row:t,col:a,worksheet:e,workbook:s},u=>{d(u)})}):i.DataValidationStatus.VALID}async validatorCell(s,e,t,a){const r=this._univerInstanceService.getUnit(s,i.UniverInstanceType.UNIVER_SHEET);if(!r)throw new Error(`cannot find current workbook, unitId: ${s}`);const o=r.getSheetBySheetId(e);if(!o)throw new Error(`cannot find current worksheet, sheetId: ${e}`);return this._validatorByCell(r,o,t,a)}validatorRanges(s,e,t){if(!t.length)return Promise.resolve([]);const a=this._univerInstanceService.getUnit(s,i.UniverInstanceType.UNIVER_SHEET);if(!a)throw new Error(`cannot find current workbook, unitId: ${s}`);const r=a.getSheetBySheetId(e);if(!r)throw new Error(`cannot find current worksheet, sheetId: ${e}`);const l=this._sheetDataValidationModel.getRules(s,e).map(u=>u.ranges).flat(),d=t.map(u=>l.map(c=>i.getIntersectRange(u,c))).flat().filter(Boolean);return Promise.all(d.map(u=>{const c=[];return i.Range.foreach(u,(m,h)=>{c.push(this._validatorByCell(a,r,m,h))}),Promise.all(c)}))}async validatorWorksheet(s,e){const t=this._univerInstanceService.getUnit(s,i.UniverInstanceType.UNIVER_SHEET);if(!t)throw new Error(`cannot find current workbook, unitId: ${s}`);const a=t.getSheetBySheetId(e);if(!a)throw new Error(`cannot find current worksheet, sheetId: ${e}`);const r=this._sheetDataValidationModel.getRules(s,e);return await Promise.all(r.map(o=>Promise.all(o.ranges.map(l=>{const d=[];return i.Range.foreach(l,(u,c)=>{d.push(this._validatorByCell(t,a,u,c))}),Promise.all(d)})))),this._dataValidationCacheService.ensureCache(s,e)}async validatorWorkbook(s){const e=this._sheetDataValidationModel.getSubUnitIds(s),t=await Promise.all(e.map(r=>this.validatorWorksheet(s,r))),a={};return t.forEach((r,o)=>{a[e[o]]=r}),a}getDataValidations(s,e,t){const a=this._sheetDataValidationModel.getRuleObjectMatrix(s,e),r=new Set;return t.forEach(l=>{i.Range.foreach(l,(d,u)=>{const c=a.getValue(d,u);c&&r.add(c)})}),Array.from(r).map(l=>this._sheetDataValidationModel.getRuleById(s,e,l)).filter(Boolean)}getDataValidation(s,e,t){return this.getDataValidations(s,e,t)[0]}};exports.SheetsDataValidationValidatorService=Rt([te(0,i.IUniverInstanceService),te(1,i.Inject(exports.SheetDataValidationModel)),te(2,i.Inject(exports.DataValidationCacheService)),te(3,i.Inject(i.LifecycleService))],exports.SheetsDataValidationValidatorService);var _t=Object.defineProperty,Dt=Object.getOwnPropertyDescriptor,Mt=(n,s,e)=>s in n?_t(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e,Et=(n,s,e,t)=>{for(var a=t>1?void 0:t?Dt(s,e):s,r=n.length-1,o;r>=0;r--)(o=n[r])&&(a=o(a)||a);return a},fe=(n,s)=>(e,t)=>s(e,t,n),xe=(n,s,e)=>Mt(n,typeof s!="symbol"?s+"":s,e);exports.UniverSheetsDataValidationPlugin=class extends i.Plugin{constructor(s=Me,e,t,a){super(),this._config=s,this._injector=e,this._commandService=t,this._configService=a;const{...r}=i.merge({},Me,this._config);this._configService.setConfig(st,r)}onStarting(){[[exports.DataValidationCacheService],[exports.DataValidationFormulaService],[exports.DataValidationCustomFormulaService],[exports.SheetsDataValidationValidatorService],[exports.SheetDataValidationModel],[ne],[exports.DataValidationFormulaController],[oe],[ie],[re]].forEach(s=>{this._injector.add(s)}),[Ie,Oe,Ce,Ne,we,Ue,Ae].forEach(s=>{this._commandService.registerCommand(s)}),this._injector.get(exports.DataValidationCacheService),this._injector.get(exports.SheetsDataValidationValidatorService),this._injector.get(ne),this._injector.get(re),this._injector.get(ie)}onReady(){this._injector.get(oe)}onRendered(){this._injector.get(exports.DataValidationFormulaController)}};xe(exports.UniverSheetsDataValidationPlugin,"pluginName",be);xe(exports.UniverSheetsDataValidationPlugin,"type",i.UniverInstanceType.UNIVER_SHEET);exports.UniverSheetsDataValidationPlugin=Et([i.DependentOn(g.UniverDataValidationPlugin),fe(1,i.Inject(i.Injector)),fe(2,i.ICommandService),fe(3,i.IConfigService)],exports.UniverSheetsDataValidationPlugin);function yt(n){const e=n.get(_.SheetsSelectionsService).getCurrentSelections().map(r=>r.range);return{uid:i.generateRandomId(6),type:i.DataValidationType.DECIMAL,operator:i.DataValidationOperator.EQUAL,formula1:"100",ranges:e!=null?e:[{startColumn:0,endColumn:0,startRow:0,endRow:0}]}}const Tt="data-validation.custom-formula-input",Ft="data-validation.formula-input",Ot="data-validation.list-formula-input",It="data-validation.checkbox-formula-input";exports.AddSheetDataValidationCommand=Ie;exports.BASE_FORMULA_INPUT_NAME=Ft;exports.CHECKBOX_FORMULA_1=$;exports.CHECKBOX_FORMULA_2=k;exports.CHECKBOX_FORMULA_INPUT_NAME=It;exports.CUSTOM_FORMULA_INPUT_NAME=Tt;exports.CheckboxValidator=ye;exports.ClearRangeDataValidationCommand=Ae;exports.DATA_VALIDATION_PLUGIN_NAME=be;exports.DateValidator=Te;exports.LIST_FORMULA_INPUT_NAME=Ot;exports.ListMultipleValidator=Be;exports.ListValidator=Ve;exports.RemoveSheetAllDataValidationCommand=Ue;exports.RemoveSheetDataValidationCommand=we;exports.UpdateSheetDataValidationOptionsCommand=Ne;exports.UpdateSheetDataValidationRangeCommand=Oe;exports.UpdateSheetDataValidationSettingCommand=Ce;exports.createDefaultNewRule=yt;exports.deserializeListOptions=W;exports.getCellValueNumber=G;exports.getCellValueOrigin=L;exports.getDataValidationCellValue=Ze;exports.getDataValidationDiffMutations=K;exports.getFormulaCellData=j;exports.getFormulaResult=w;exports.getTransformedFormula=X;exports.isLegalFormulaResult=M;exports.serializeListOptions=ze;exports.transformCheckboxValue=H;
