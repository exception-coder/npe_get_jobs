import {
  S,
  k
} from "./chunk-FOCXVU2X.js";
import {
  B1,
  Bi,
  H1,
  Mi,
  Mr,
  S1,
  Y1,
  Yi,
  a1,
  he,
  p5,
  qe2 as qe,
  st,
  ue,
  useDependency
} from "./chunk-DZMX4FYO.js";
import {
  G,
  ME,
  P,
  Pe,
  Ve as Ve2,
  Xs2 as Xs,
  ht,
  qr,
  ss,
  xh,
  xt,
  z
} from "./chunk-I7I3GTAS.js";
import {
  HE,
  I,
  ie,
  j,
  require_jsx_runtime,
  require_react
} from "./chunk-YFGUMDM2.js";
import {
  BehaviorSubject,
  E1,
  En,
  Fn,
  Inject,
  Injector,
  Jo,
  KC,
  Ls,
  Ms,
  Ol,
  Subject,
  Ve,
  ao,
  combineLatest,
  debounceTime,
  filter,
  ge,
  ic,
  map,
  of,
  oo,
  pt,
  qR,
  sr,
  switchMap,
  vr,
  we,
  zc
} from "./chunk-RGZYGL3P.js";
import {
  __toESM
} from "./chunk-DC5AMYBS.js";

// node_modules/@univerjs/sheets-note/lib/es/index.js
var W = Object.defineProperty;
var L = (i, r, e) => r in i ? W(i, r, { enumerable: true, configurable: true, writable: true, value: e }) : i[r] = e;
var l = (i, r, e) => L(i, typeof r != "symbol" ? r + "" : r, e);
var u = class extends Ve {
  constructor() {
    super(...arguments);
    l(this, "_noteMatrix", /* @__PURE__ */ new Map());
    l(this, "_change$", new Subject());
    l(this, "change$", this._change$.asObservable());
  }
  _ensureNoteMatrix(e, s) {
    let t = this._noteMatrix.get(e);
    t || (t = /* @__PURE__ */ new Map(), this._noteMatrix.set(e, t));
    let n = t.get(s);
    return n || (n = new pt(), t.set(s, n)), n;
  }
  getSheetShowNotes$(e, s) {
    return this._change$.pipe(
      filter(({ unitId: t, sheetId: n }) => t === e && n === s),
      map(() => {
        const t = this._ensureNoteMatrix(e, s), n = [];
        return t.forValue((o, a, c) => {
          c.show && n.push({ loc: { row: o, col: a, unitId: e, subUnitId: s }, note: c });
        }), n;
      })
    );
  }
  getCellNoteChange$(e, s, t, n) {
    return this._change$.pipe(
      filter(({ unitId: o, sheetId: a, row: c, col: h }) => o === e && a === s && c === t && h === n),
      map(({ note: o }) => o)
    );
  }
  updateNote(e, s, t, n, o, a) {
    const c = this._ensureNoteMatrix(e, s), h = c.getValue(t, n);
    c.setValue(t, n, o), this._change$.next({ unitId: e, sheetId: s, row: t, col: n, type: "update", note: o, oldNote: h, silent: a });
  }
  removeNote(e, s, t, n, o) {
    const a = this._ensureNoteMatrix(e, s), c = a.getValue(t, n);
    a.realDeleteValue(t, n), this._change$.next({ unitId: e, sheetId: s, row: t, col: n, type: "update", note: null, oldNote: c, silent: o });
  }
  toggleNotePopup(e, s, t, n, o) {
    const a = this._ensureNoteMatrix(e, s), c = a.getValue(t, n);
    if (c) {
      c.show = !c.show;
      const h = { ...c, show: c.show };
      a.setValue(t, n, h), this._change$.next({
        unitId: e,
        sheetId: s,
        row: t,
        col: n,
        type: "update",
        note: h,
        oldNote: c,
        silent: o
      });
    }
  }
  updateNotePosition(e, s, t, n, o, a, c) {
    const h = this._ensureNoteMatrix(e, s), d = h.getValue(t, n);
    d && (h.realDeleteValue(t, n), h.setValue(o, a, d), this._change$.next({
      unitId: e,
      sheetId: s,
      row: t,
      col: n,
      type: "ref",
      newPosition: { row: o, col: a },
      note: d,
      silent: c
    }));
  }
  getNote(e, s, t, n) {
    return this._ensureNoteMatrix(e, s).getValue(t, n);
  }
  getUnitNotes(e) {
    return this._noteMatrix.get(e);
  }
  getSheetNotes(e, s) {
    const t = this._noteMatrix.get(e);
    if (t)
      return t.get(s);
  }
  getNotes() {
    return this._noteMatrix;
  }
  deleteUnitNotes(e) {
    this._noteMatrix.delete(e);
  }
};
var _ = {
  id: "sheet.mutation.update-note",
  type: Ms.MUTATION,
  handler: (i, r) => {
    const { unitId: e, sheetId: s, row: t, col: n, note: o, silent: a } = r;
    return i.get(u).updateNote(e, s, t, n, o, a), true;
  }
};
var m = {
  id: "sheet.mutation.remove-note",
  type: Ms.MUTATION,
  handler: (i, r) => {
    const { unitId: e, sheetId: s, row: t, col: n, silent: o } = r;
    return i.get(u).removeNote(e, s, t, n, o), true;
  }
};
var D = {
  id: "sheet.mutation.toggle-note-popup",
  type: Ms.MUTATION,
  handler: (i, r) => {
    const { unitId: e, sheetId: s, row: t, col: n, silent: o } = r;
    return i.get(u).toggleNotePopup(e, s, t, n, o), true;
  }
};
var R = {
  id: "sheet.mutation.update-note-position",
  type: Ms.MUTATION,
  handler: (i, r) => {
    const { unitId: e, sheetId: s, row: t, col: n, newPosition: o, silent: a } = r;
    return i.get(u).updateNotePosition(e, s, t, n, o.row, o.col, a), true;
  }
};
var se = {
  id: "sheet.command.delete-note",
  type: Ms.COMMAND,
  handler: (i, r) => {
    const e = i.get(vr), s = P(e);
    if (!s) return false;
    const n = i.get(z).getCurrentLastSelection();
    if (!(n != null && n.primary)) return false;
    const { actualColumn: o, actualRow: a } = n.primary;
    return i.get(Ls).executeCommand(m.id, {
      unitId: s.unitId,
      sheetId: s.subUnitId,
      row: a,
      col: o
    });
  }
};
var ne = {
  id: "sheet.command.toggle-note-popup",
  type: Ms.COMMAND,
  handler: (i, r) => {
    const e = i.get(vr), s = P(e);
    if (!s) return false;
    const n = i.get(z).getCurrentLastSelection();
    if (!(n != null && n.primary)) return false;
    const { actualColumn: o, actualRow: a } = n.primary;
    return i.get(Ls).executeCommand(D.id, {
      unitId: s.unitId,
      sheetId: s.subUnitId,
      row: a,
      col: o
    });
  }
};
var re = {
  id: "sheet.command.update-note",
  type: Ms.COMMAND,
  handler: (i, r) => i.get(Ls).syncExecuteCommand(_.id, r)
};
var V = "SHEET_NOTE_PLUGIN";
var oe = Object.getOwnPropertyDescriptor;
var ie2 = (i, r, e, s) => {
  for (var t = s > 1 ? void 0 : s ? oe(r, e) : r, n = i.length - 1, o; n >= 0; n--)
    (o = i[n]) && (t = o(t) || t);
  return t;
};
var f = (i, r) => (e, s) => r(e, s, i);
var M = class extends Ve {
  constructor(i, r, e, s) {
    super(), this._resourceManagerService = i, this._univerInstanceService = r, this._sheetInterceptorService = e, this._sheetsNoteModel = s, this._initSnapshot(), this._initSheetChange();
  }
  _initSnapshot() {
    const i = (e) => {
      const s = this._sheetsNoteModel.getUnitNotes(e);
      if (!s)
        return "";
      const t = {};
      return s.forEach((n, o) => {
        const a = {};
        n.forValue((c, h, d) => {
          a[c] || (a[c] = {}), a[c][h] = d;
        }), Object.keys(a).length > 0 && (t[o] = a);
      }), JSON.stringify(t);
    }, r = (e) => {
      if (!e)
        return {};
      try {
        return JSON.parse(e);
      } catch {
        return {};
      }
    };
    this.disposeWithMe(
      this._resourceManagerService.registerPluginResource({
        pluginName: V,
        businesses: [we.UNIVER_SHEET],
        toJson: (e) => i(e),
        parseJson: (e) => r(e),
        onUnLoad: (e) => {
          this._sheetsNoteModel.deleteUnitNotes(e);
        },
        onLoad: (e, s) => {
          Object.entries(s).forEach(([t, n]) => {
            Object.entries(n).forEach(([o, a]) => {
              Object.entries(a).forEach(([c, h]) => {
                this._sheetsNoteModel.updateNote(
                  e,
                  t,
                  Number(o),
                  Number(c),
                  h
                );
              });
            });
          });
        }
      })
    );
  }
  // eslint-disable-next-line max-lines-per-function
  _initSheetChange() {
    this.disposeWithMe(
      this._sheetInterceptorService.interceptCommand({
        // eslint-disable-next-line max-lines-per-function
        getMutations: (i) => {
          var r;
          if (i.id === Xs.id) {
            const e = i.params, s = e.unitId || this._univerInstanceService.getCurrentUnitOfType(we.UNIVER_SHEET).getUnitId(), t = e.subUnitId || ((r = this._univerInstanceService.getCurrentUnitOfType(we.UNIVER_SHEET).getActiveSheet()) == null ? void 0 : r.getSheetId());
            if (!s || !t)
              return { redos: [], undos: [] };
            const n = this._sheetsNoteModel.getSheetNotes(s, t);
            if (!n)
              return { redos: [], undos: [] };
            const o = [], a = [];
            return n.forValue((c, h, d) => {
              o.push({
                id: m.id,
                params: {
                  unitId: s,
                  sheetId: t,
                  row: c,
                  col: h
                }
              }), a.push({
                id: _.id,
                params: {
                  unitId: s,
                  sheetId: t,
                  row: c,
                  col: h,
                  note: d
                }
              });
            }), { redos: o, undos: a };
          } else if (i.id === qr.id) {
            const e = i.params, { unitId: s, subUnitId: t, targetSubUnitId: n } = e;
            if (!s || !t || !n)
              return { redos: [], undos: [] };
            const o = this._sheetsNoteModel.getSheetNotes(s, t);
            if (!o)
              return { redos: [], undos: [] };
            const a = [], c = [];
            return o.forValue((h, d, A) => {
              a.push({
                id: _.id,
                params: {
                  unitId: s,
                  sheetId: n,
                  row: h,
                  col: d,
                  note: A
                }
              }), c.push({
                id: m.id,
                params: {
                  unitId: s,
                  sheetId: n,
                  row: h,
                  col: d
                }
              });
            }), { redos: a, undos: c };
          }
          return { redos: [], undos: [] };
        }
      })
    );
  }
};
M = ie2([
  f(0, Jo),
  f(1, vr),
  f(2, Inject(G)),
  f(3, Inject(u))
], M);
var ae = "sheets-note.config";
var b = {};
var ce = Object.getOwnPropertyDescriptor;
var he2 = (i, r, e, s) => {
  for (var t = s > 1 ? void 0 : s ? ce(r, e) : r, n = i.length - 1, o; n >= 0; n--)
    (o = i[n]) && (t = o(t) || t);
  return t;
};
var S2 = (i, r) => (e, s) => r(e, s, i);
var I2 = class extends Ve {
  constructor(r, e, s, t) {
    super();
    l(this, "_disposableMap", /* @__PURE__ */ new Map());
    l(this, "_watcherMap", /* @__PURE__ */ new Map());
    l(this, "_handleRangeChange", (r2, e2, s2, t2, n, o, a) => o ? {
      redos: [{
        id: R.id,
        params: {
          unitId: r2,
          sheetId: e2,
          row: t2,
          col: n,
          newPosition: {
            row: o.startRow,
            col: o.startColumn
          },
          silent: a
        }
      }],
      undos: [{
        id: R.id,
        params: {
          unitId: r2,
          sheetId: e2,
          row: o.startRow,
          col: o.startColumn,
          newPosition: {
            row: t2,
            col: n
          },
          note: s2,
          silent: a
        }
      }]
    } : {
      redos: [{
        id: m.id,
        params: {
          unitId: r2,
          sheetId: e2,
          row: t2,
          col: n
        }
      }],
      undos: [{
        id: _.id,
        params: {
          unitId: r2,
          sheetId: e2,
          row: t2,
          col: n,
          note: s2
        }
      }]
    });
    this._refRangeService = r, this._sheetsNoteModel = e, this._selectionManagerService = s, this._commandService = t, this._initData(), this._initRefRange();
  }
  _getIdWithUnitId(r, e, s, t) {
    return `${r}-${e}-${s}-${t}`;
  }
  _register(r, e, s, t, n) {
    const o = {
      startColumn: n,
      endColumn: n,
      startRow: t,
      endRow: t
    };
    this._disposableMap.set(
      this._getIdWithUnitId(r, e, t, n),
      this._refRangeService.registerRefRange(o, (a) => {
        const c = xh(o, a, { selectionManagerService: this._selectionManagerService }), h = Array.isArray(c) ? c[0] : c;
        return h && h.startColumn === o.startColumn && h.startRow === o.startRow ? {
          undos: [],
          redos: []
        } : this._handleRangeChange(r, e, s, t, n, h, false);
      }, r, e)
    );
  }
  _watch(r, e, s, t, n) {
    const o = {
      startColumn: n,
      endColumn: n,
      startRow: t,
      endRow: t
    };
    this._watcherMap.set(
      this._getIdWithUnitId(r, e, t, n),
      this._refRangeService.watchRange(r, e, o, (a, c) => {
        const { redos: h } = this._handleRangeChange(r, e, s, a.startRow, a.startColumn, c, true);
        E1(h, this._commandService, { onlyLocal: true });
      }, true)
    );
  }
  _unwatch(r, e, s, t) {
    var o;
    const n = this._getIdWithUnitId(r, e, s, t);
    (o = this._watcherMap.get(n)) == null || o.dispose(), this._watcherMap.delete(n);
  }
  _unregister(r, e, s, t) {
    var o;
    const n = this._getIdWithUnitId(r, e, s, t);
    (o = this._disposableMap.get(n)) == null || o.dispose(), this._disposableMap.delete(n);
  }
  _initData() {
    const r = this._sheetsNoteModel.getNotes();
    for (const [e, s] of r)
      for (const [t, n] of s)
        n.forValue((o, a, c) => (c && (this._register(e, t, c, o, a), this._watch(e, t, c, o, a)), true));
  }
  _initRefRange() {
    this.disposeWithMe(
      this._sheetsNoteModel.change$.subscribe((r) => {
        switch (r.type) {
          case "update": {
            const { unitId: e, sheetId: s, row: t, col: n, note: o } = r, a = this._getIdWithUnitId(e, s, t, n);
            o ? this._disposableMap.has(a) || (this._register(e, s, o, t, n), this._watch(e, s, o, t, n)) : (this._unregister(e, s, t, n), this._unwatch(e, s, t, n));
            break;
          }
          case "ref": {
            const { unitId: e, sheetId: s, row: t, col: n, newPosition: o, note: a, silent: c } = r;
            this._unregister(e, s, t, n), c || (this._unwatch(e, s, t, n), this._watch(e, s, a, o.row, o.col)), this._register(e, s, a, o.row, o.col);
            break;
          }
        }
      })
    );
  }
};
I2 = he2([
  S2(0, Inject(xt)),
  S2(1, Inject(u)),
  S2(2, Inject(z)),
  S2(3, Ls)
], I2);
var de = Object.getOwnPropertyDescriptor;
var ue2 = (i, r, e, s) => {
  for (var t = s > 1 ? void 0 : s ? de(r, e) : r, n = i.length - 1, o; n >= 0; n--)
    (o = i[n]) && (t = o(t) || t);
  return t;
};
var le = (i, r) => (e, s) => r(e, s, i);
var C = class extends Ve {
  constructor(i) {
    super(), this._commandService = i, this._initialize();
  }
  _initialize() {
    [
      R,
      D,
      _,
      m,
      se,
      ne,
      re
    ].forEach((i) => {
      this.disposeWithMe(
        this._commandService.registerCommand(i)
      );
    });
  }
};
C = ue2([
  le(0, Ls)
], C);
var pe = Object.defineProperty;
var ge2 = Object.getOwnPropertyDescriptor;
var _e = (i, r, e) => r in i ? pe(i, r, { enumerable: true, configurable: true, writable: true, value: e }) : i[r] = e;
var me = (i, r, e, s) => {
  for (var t = s > 1 ? void 0 : s ? ge2(r, e) : r, n = i.length - 1, o; n >= 0; n--)
    (o = i[n]) && (t = o(t) || t);
  return t;
};
var $ = (i, r) => (e, s) => r(e, s, i);
var j2 = (i, r, e) => _e(i, typeof r != "symbol" ? r + "" : r, e);
var w = class extends Ol {
  constructor(i = b, r, e) {
    super(), this._config = i, this._configService = r, this._injector = e;
    const { ...s } = oo(
      {},
      b,
      this._config
    );
    this._configService.setConfig(ae, s);
  }
  onStarting() {
    [
      [u],
      [C],
      [M],
      [I2]
    ].forEach((i) => {
      this._injector.add(i);
    }), zc(this._injector, [
      [u],
      [C],
      [M]
    ]);
  }
  onReady() {
    zc(this._injector, [
      [I2]
    ]);
  }
};
j2(w, "pluginName", V);
j2(w, "type", we.UNIVER_SHEET);
w = me([
  qR(ss),
  $(1, ic),
  $(2, Inject(Injector))
], w);

// node_modules/@univerjs/sheets-note-ui/lib/es/index.js
var import_react = __toESM(require_react());
var import_jsx_runtime = __toESM(require_jsx_runtime());
var me2 = Object.defineProperty;
var Se = (i, e, t) => e in i ? me2(i, e, { enumerable: true, configurable: true, writable: true, value: t }) : i[e] = t;
var v = (i, e, t) => Se(i, typeof e != "symbol" ? e + "" : e, t);
var ot = Object.getOwnPropertyDescriptor;
var nt = (i, e, t, r) => {
  for (var o = r > 1 ? void 0 : r ? ot(e, t) : e, s = i.length - 1, n; s >= 0; s--)
    (n = i[s]) && (o = n(o) || o);
  return o;
};
var E = (i, e) => (t, r) => e(t, r, i);
var $2 = class extends Ve {
  constructor(i, e, t, r) {
    super(), this._sheetInterceptorService = i, this._sheetsNoteModel = e, this._renderManagerService = t, this._univerInstanceService = r, this._initViewModelIntercept(), this._initSkeletonChange();
  }
  _initViewModelIntercept() {
    this.disposeWithMe(
      this._sheetInterceptorService.intercept(
        ht.CELL_CONTENT,
        {
          effect: sr.Style,
          handler: (i, e, t) => {
            const { row: r, col: o, unitId: s, subUnitId: n } = e;
            return this._sheetsNoteModel.getNote(s, n, r, o) && ((!i || i === e.rawData) && (i = { ...e.rawData }), i.markers = {
              ...i == null ? void 0 : i.markers,
              tr: {
                color: "#FFBD37",
                size: 6
              }
            }), t(i);
          },
          priority: 100
        }
      )
    );
  }
  _initSkeletonChange() {
    const i = () => {
      var o;
      const e = this._univerInstanceService.getCurrentUnitForType(we.UNIVER_SHEET);
      if (!e) return;
      const t = e.getUnitId(), r = this._renderManagerService.getRenderById(t);
      (o = r == null ? void 0 : r.mainComponent) == null || o.makeForceDirty();
    };
    this.disposeWithMe(this._sheetsNoteModel.change$.pipe(debounceTime(16)).subscribe(() => {
      i();
    }));
  }
};
$2 = nt([
  E(0, Inject(G)),
  E(1, Inject(u)),
  E(2, ME),
  E(3, vr)
], $2);
var G2 = "SHEET_NOTE_COMPONENT";
var st2 = Object.getOwnPropertyDescriptor;
var at = (i, e, t, r) => {
  for (var o = r > 1 ? void 0 : r ? st2(e, t) : e, s = i.length - 1, n; s >= 0; s--)
    (n = i[s]) && (o = n(o) || o);
  return o;
};
var ee = (i, e) => (t, r) => e(t, r, i);
var S3 = class extends Ve {
  constructor(e, t) {
    super();
    v(this, "_lastPopup", null);
    v(this, "_activePopup");
    v(this, "_activePopup$", new BehaviorSubject(null));
    v(this, "activePopup$", this._activePopup$.asObservable());
    this._zenZoneService = e, this._cellPopupManagerService = t, this._initZenVisible(), this.disposeWithMe(() => {
      this._activePopup$.complete();
    });
  }
  get activePopup() {
    return this._activePopup;
  }
  _initZenVisible() {
    this.disposeWithMe(this._zenZoneService.visible$.subscribe((e) => {
      e && this.hidePopup();
    }));
  }
  dispose() {
    super.dispose(), this.hidePopup();
  }
  showPopup(e, t) {
    var c;
    const { row: r, col: o, unitId: s, subUnitId: n } = e;
    if (this._activePopup && r === this._activePopup.row && o === this._activePopup.col && s === this._activePopup.unitId && n === ((c = this.activePopup) == null ? void 0 : c.subUnitId)) {
      this._activePopup = e, this._activePopup$.next(e);
      return;
    }
    if (this._lastPopup && this._lastPopup.dispose(), this._zenZoneService.visible)
      return;
    this._activePopup = e, this._activePopup$.next(e);
    const a = this._cellPopupManagerService.showPopup(
      {
        unitId: s,
        subUnitId: n,
        row: r,
        col: o
      },
      {
        componentKey: G2,
        onClickOutside: () => {
          this.hidePopup();
        },
        direction: "horizontal",
        extraProps: {
          location: e
        },
        priority: 3
      }
    );
    if (!a)
      throw new Error("[SheetsNotePopupService]: cannot show popup!");
    const u2 = new ao();
    u2.add(a), u2.add({
      dispose: () => {
        t == null || t();
      }
    }), this._lastPopup = u2;
  }
  hidePopup(e) {
    this._activePopup && (!e && !this._activePopup.temp || (this._lastPopup && this._lastPopup.dispose(), this._lastPopup = null, this._activePopup = null, this._activePopup$.next(null)));
  }
  persistPopup() {
    !this._activePopup || !this._activePopup.temp || (this._activePopup = {
      ...this._activePopup,
      temp: false
    }, this._activePopup$.next(this._activePopup));
  }
};
S3 = at([
  ee(0, st),
  ee(1, Inject(Mi))
], S3);
var ct = Object.getOwnPropertyDescriptor;
var ut = (i, e, t, r) => {
  for (var o = r > 1 ? void 0 : r ? ct(e, t) : e, s = i.length - 1, n; s >= 0; s--)
    (n = i[s]) && (o = n(o) || o);
  return o;
};
var m2 = (i, e) => (t, r) => e(t, r, i);
var x = class extends Ve {
  constructor(e, t, r, o, s, n) {
    super();
    v(this, "_isSwitchingSheet", false);
    this._sheetsNotePopupService = e, this._sheetsNoteModel = t, this._sheetSelectionService = r, this._editorBridgeService = o, this._renderManagerService = s, this._hoverManagerService = n, this._initSelectionUpdateListener(), this._initEditorBridge(), this._initHoverEvent();
  }
  _handleSelectionChange(e, t, r) {
    var d, _2, f2;
    const o = (d = e[0]) == null ? void 0 : d.range, s = this._renderManagerService.getRenderById(t), n = (_2 = s == null ? void 0 : s.with(ue).getSkeletonParam(r)) == null ? void 0 : _2.skeleton;
    if (!n || !o)
      return;
    const a = n.getCellWithCoordByIndex(o.startRow, o.startColumn);
    if ((((f2 = o.rangeType) != null ? f2 : ge.NORMAL) !== ge.NORMAL || o.endColumn - o.startColumn > 0 || o.endRow - o.startRow > 0) && !((a.isMerged || a.isMergedMainCell) && En.equals(a.mergeInfo, o))) {
      this._sheetsNotePopupService.hidePopup();
      return;
    }
    const c = a.actualRow, l2 = a.actualColumn, p = this._sheetsNoteModel.getNote(t, r, c, l2);
    p != null && p.show || (p ? this._sheetsNotePopupService.showPopup({
      unitId: t,
      subUnitId: r,
      row: c,
      col: l2
    }) : this._sheetsNotePopupService.hidePopup(true));
  }
  _initSelectionUpdateListener() {
    this.disposeWithMe(
      this._sheetSelectionService.selectionMoveEnd$.subscribe((e) => {
        if (this._isSwitchingSheet)
          return;
        const t = this._sheetSelectionService.currentSelectionParam;
        t && this._handleSelectionChange(e, t.unitId, t.sheetId);
      })
    );
  }
  _initEditorBridge() {
    this.disposeWithMe(
      this._editorBridgeService.visible$.subscribe((e) => {
        e.visible && this._sheetsNotePopupService.hidePopup(true);
      })
    );
  }
  _initHoverEvent() {
    this.disposeWithMe(
      this._hoverManagerService.currentCell$.pipe(debounceTime(100)).subscribe((e) => {
        if (!(e != null && e.location)) return;
        const { unitId: t, subUnitId: r, row: o, col: s } = e.location, n = this._sheetsNoteModel.getNote(t, r, o, s);
        n != null && n.show || (n ? this._sheetsNotePopupService.showPopup({
          unitId: t,
          subUnitId: r,
          row: o,
          col: s,
          temp: true
        }) : this._sheetsNotePopupService.hidePopup());
      })
    );
  }
};
x = ut([
  m2(0, Inject(S3)),
  m2(1, Inject(u)),
  m2(2, Inject(z)),
  m2(3, qe),
  m2(4, ME),
  m2(5, Inject(Mr))
], x);
var pe2 = "sheets-note-ui.config";
var te = {};
var pt2 = Object.getOwnPropertyDescriptor;
var lt = (i, e, t, r) => {
  for (var o = r > 1 ? void 0 : r ? pt2(e, t) : e, s = i.length - 1, n; s >= 0; s--)
    (n = i[s]) && (o = n(o) || o);
  return o;
};
var y = (i, e) => (t, r) => e(t, r, i);
var H = class extends Ve {
  constructor(e, t, r, o) {
    super();
    v(this, "_noteMatrix", new pt());
    this._sheetsNoteModel = e, this._univerInstanceService = t, this._cellPopupManagerService = r, this._sheetsNotePopupService = o, this._initNoteChangeListener();
  }
  _showPopup(e, t, r, o) {
    return this._sheetsNotePopupService.hidePopup(true), this._cellPopupManagerService.showPopup(
      {
        unitId: e,
        subUnitId: t,
        row: r,
        col: o
      },
      {
        componentKey: G2,
        direction: "horizontal",
        extraProps: {
          location: {
            unitId: e,
            subUnitId: t,
            row: r,
            col: o
          }
        },
        priority: 3
      }
    );
  }
  dispose() {
    super.dispose(), this._noteMatrix.forValue((e, t, r) => {
      r.dispose();
    });
  }
  _initSheet(e, t) {
    var s;
    this._noteMatrix.forValue((n, a, u2) => {
      u2.dispose();
    }), this._noteMatrix = new pt();
    const o = (n, a, u2, c, l2) => {
      const p = this._noteMatrix, d = p.getValue(u2, c);
      if (l2 != null && l2.show) {
        if (!d) {
          const _2 = this._showPopup(n, a, u2, c);
          _2 && p.setValue(u2, c, _2);
        }
      } else
        d && (d.dispose(), p.realDeleteValue(u2, c));
    };
    return (s = this._sheetsNoteModel.getSheetNotes(e, t)) == null || s.forValue((n, a, u2) => {
      o(e, t, n, a, u2);
    }), this._sheetsNoteModel.change$.subscribe((n) => {
      if (!(n.unitId !== e || n.sheetId !== t))
        switch (n.type) {
          case "ref": {
            const { unitId: a, sheetId: u2, row: c, col: l2, newPosition: p, note: d } = n, _2 = this._noteMatrix;
            if (!d.show) return;
            const f2 = _2.getValue(c, l2);
            f2 && (f2.dispose(), _2.realDeleteValue(c, l2));
            const P2 = this._showPopup(a, u2, p.row, p.col);
            P2 && _2.setValue(p.row, p.col, P2);
            break;
          }
          case "update": {
            const { unitId: a, sheetId: u2, row: c, col: l2, note: p } = n;
            o(a, u2, c, l2, p);
            break;
          }
        }
    });
  }
  _initNoteChangeListener() {
    this.disposeWithMe(
      this._univerInstanceService.getCurrentTypeOfUnit$(we.UNIVER_SHEET).pipe(
        switchMap((e) => {
          var t;
          return (t = e == null ? void 0 : e.activeSheet$) != null ? t : of(null);
        })
      ).subscribe((e) => {
        if (e) {
          const t = this._initSheet(e.getUnitId(), e.getSheetId());
          return () => {
            t.unsubscribe();
          };
        } else
          this._noteMatrix.forValue((t, r, o) => {
            o.dispose();
          }), this._noteMatrix = new pt();
      })
    );
  }
};
H = lt([
  y(0, Inject(u)),
  y(1, Inject(vr)),
  y(2, Inject(Mi)),
  y(3, Inject(S3))
], H);
function R2({ ref: i, ...e }) {
  const { icon: t, id: r, className: o, extend: s, ...n } = e, a = `univerjs-icon univerjs-icon-${r} ${o || ""}`.trim(), u2 = (0, import_react.useRef)(`_${_t()}`);
  return le2(t, `${r}`, {
    defIds: t.defIds,
    idSuffix: u2.current
  }, {
    ref: i,
    className: a,
    ...n
  }, s);
}
function le2(i, e, t, r, o) {
  return (0, import_react.createElement)(i.tag, {
    key: e,
    ...ht2(i, t, o),
    ...r
  }, (dt(i, t).children || []).map((s, n) => le2(s, `${e}-${i.tag}-${n}`, t, void 0, o)));
}
function ht2(i, e, t) {
  const r = { ...i.attrs };
  t != null && t.colorChannel1 && r.fill === "colorChannel1" && (r.fill = t.colorChannel1), i.tag === "mask" && r.id && (r.id = r.id + e.idSuffix), Object.entries(r).forEach(([s, n]) => {
    s === "mask" && typeof n == "string" && (r[s] = n.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  });
  const { defIds: o } = e;
  return !o || o.length === 0 || (i.tag === "use" && r["xlink:href"] && (r["xlink:href"] = r["xlink:href"] + e.idSuffix), Object.entries(r).forEach(([s, n]) => {
    typeof n == "string" && (r[s] = n.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  })), r;
}
function dt(i, e) {
  var r;
  const { defIds: t } = e;
  return !t || t.length === 0 ? i : i.tag === "defs" && ((r = i.children) != null && r.length) ? {
    ...i,
    children: i.children.map((o) => typeof o.attrs.id == "string" && t && t.includes(o.attrs.id) ? {
      ...o,
      attrs: {
        ...o.attrs,
        id: o.attrs.id + e.idSuffix
      }
    } : o)
  } : i;
}
function _t() {
  return Math.random().toString(36).substring(2, 8);
}
R2.displayName = "UniverIcon";
var Ct = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M12.8481 8.00049V3.87451C12.8481 3.13737 12.2503 2.5398 11.5132 2.53955H4.48682C3.74952 2.53955 3.15186 3.13721 3.15186 3.87451V12.1255C3.15186 12.8628 3.74952 13.4604 4.48682 13.4604H6.99951L7.1333 13.4741C7.43655 13.536 7.66454 13.804 7.66455 14.1255C7.66455 14.447 7.43655 14.715 7.1333 14.7769L6.99951 14.7905H4.48682C3.01498 14.7905 1.82178 13.5973 1.82178 12.1255V3.87451C1.82178 2.40267 3.01498 1.20947 4.48682 1.20947H11.5132C12.9848 1.20972 14.1772 2.40283 14.1772 3.87451V8.00049C14.177 8.36738 13.8801 8.6643 13.5132 8.66455C13.1461 8.66455 12.8484 8.36754 12.8481 8.00049Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M10.1463 4.53859L10.2801 4.55226C10.5832 4.61419 10.8113 4.8822 10.8113 5.20363C10.8113 5.52506 10.5832 5.79306 10.2801 5.85499L10.1463 5.86867H5.85331C5.48604 5.86867 5.18827 5.5709 5.18827 5.20363C5.18827 4.83636 5.48604 4.53859 5.85331 4.53859H10.1463Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M8.11307 7.33497L8.24686 7.34865C8.54984 7.41069 8.77811 7.67869 8.77811 8.00001C8.77811 8.32134 8.54984 8.58933 8.24686 8.65138L8.11307 8.66505H5.85331C5.48604 8.66505 5.18827 8.36728 5.18827 8.00001C5.18827 7.63274 5.48604 7.33497 5.85331 7.33497H8.11307Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M6.98319 10.1314L7.11698 10.145C7.42003 10.207 7.64823 10.475 7.64823 10.7964C7.64823 11.1178 7.42003 11.3858 7.11698 11.4478L6.98319 11.4614H5.85331C5.48604 11.4614 5.18827 11.1637 5.18827 10.7964C5.18827 10.4291 5.48604 10.1314 5.85331 10.1314H6.98319Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M10.8813 14.4312V10.2925C10.8813 9.92522 11.1791 9.62745 11.5463 9.62745C11.9136 9.62745 12.2114 9.92522 12.2114 10.2925V14.4312C12.2112 14.7983 11.9135 15.0962 11.5463 15.0962C11.1791 15.0962 10.8814 14.7983 10.8813 14.4312Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M9.47697 11.6968H11.5463H13.6156C13.9829 11.6968 14.2807 11.9946 14.2807 12.3618C14.2807 12.7291 13.9829 13.0269 13.6156 13.0269H9.47697C9.10981 13.0267 8.81193 12.729 8.81193 12.3618C8.81193 11.9946 9.10981 11.6969 9.47697 11.6968Z"
      }
    }
  ]
};
var he3 = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(R2, Object.assign({}, e, {
    id: "add-note-icon",
    ref: t,
    icon: Ct
  }));
});
he3.displayName = "AddNoteIcon";
var ft = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M12.8481 8.00049V3.87451C12.8481 3.13737 12.2503 2.5398 11.5132 2.53955H4.48682C3.74952 2.53955 3.15186 3.13721 3.15186 3.87451V12.1255C3.15186 12.8628 3.74952 13.4604 4.48682 13.4604H6.99951L7.1333 13.4741C7.43655 13.536 7.66454 13.804 7.66455 14.1255C7.66455 14.447 7.43655 14.715 7.1333 14.7769L6.99951 14.7905H4.48682C3.01498 14.7905 1.82178 13.5973 1.82178 12.1255V3.87451C1.82178 2.40267 3.01498 1.20947 4.48682 1.20947H11.5132C12.9848 1.20972 14.1772 2.40283 14.1772 3.87451V8.00049C14.177 8.36738 13.8801 8.6643 13.5132 8.66455C13.1461 8.66455 12.8484 8.36754 12.8481 8.00049Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M10.1463 4.53859L10.2801 4.55226C10.5832 4.61419 10.8113 4.8822 10.8113 5.20363C10.8113 5.52506 10.5832 5.79306 10.2801 5.85499L10.1463 5.86867H5.85331C5.48604 5.86867 5.18827 5.5709 5.18827 5.20363C5.18827 4.83636 5.48604 4.53859 5.85331 4.53859H10.1463Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M8.11307 7.33497L8.24686 7.34865C8.54984 7.41069 8.77811 7.67869 8.77811 8.00001C8.77811 8.32134 8.54984 8.58933 8.24686 8.65138L8.11307 8.66505H5.85331C5.48604 8.66505 5.18827 8.36728 5.18827 8.00001C5.18827 7.63274 5.48604 7.33497 5.85331 7.33497H8.11307Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M6.98319 10.1314L7.11698 10.145C7.42003 10.207 7.64823 10.475 7.64823 10.7964C7.64823 11.1178 7.42003 11.3858 7.11698 11.4478L6.98319 11.4614H5.85331C5.48604 11.4614 5.18827 11.1637 5.18827 10.7964C5.18827 10.4291 5.48604 10.1314 5.85331 10.1314H6.98319Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M9.47489 11.6968H13.6175C13.9847 11.6968 14.2825 11.9946 14.2825 12.3618C14.2825 12.7291 13.9847 13.0269 13.6175 13.0269H9.47489C9.10762 13.0269 8.80985 12.7291 8.80985 12.3618C8.80985 11.9946 9.10762 11.6968 9.47489 11.6968Z"
      }
    }
  ]
};
var de2 = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(R2, Object.assign({}, e, {
    id: "delete-note-icon",
    ref: t,
    icon: ft
  }));
});
de2.displayName = "DeleteNoteIcon";
var vt = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M12.8481 8.00049V3.87451C12.8481 3.13737 12.2503 2.5398 11.5132 2.53955H4.48682C3.74952 2.53955 3.15186 3.13721 3.15186 3.87451V12.1255C3.15186 12.8628 3.74952 13.4604 4.48682 13.4604H6.99951L7.1333 13.4741C7.43655 13.536 7.66454 13.804 7.66455 14.1255C7.66455 14.447 7.43655 14.715 7.1333 14.7769L6.99951 14.7905H4.48682C3.01498 14.7905 1.82178 13.5973 1.82178 12.1255V3.87451C1.82178 2.40267 3.01498 1.20947 4.48682 1.20947H11.5132C12.9848 1.20972 14.1772 2.40283 14.1772 3.87451V8.00049C14.177 8.36738 13.8801 8.6643 13.5132 8.66455C13.1461 8.66455 12.8484 8.36754 12.8481 8.00049Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M10.1463 4.53859L10.2801 4.55226C10.5832 4.61419 10.8113 4.8822 10.8113 5.20363C10.8113 5.52506 10.5832 5.79306 10.2801 5.85499L10.1463 5.86867H5.85331C5.48604 5.86867 5.18827 5.5709 5.18827 5.20363C5.18827 4.83636 5.48604 4.53859 5.85331 4.53859H10.1463Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M8.11307 7.33497L8.24686 7.34865C8.54984 7.41069 8.77811 7.67869 8.77811 8.00001C8.77811 8.32134 8.54984 8.58933 8.24686 8.65138L8.11307 8.66505H5.85331C5.48604 8.66505 5.18827 8.36728 5.18827 8.00001C5.18827 7.63274 5.48604 7.33497 5.85331 7.33497H8.11307Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M6.98319 10.1314L7.11698 10.145C7.42003 10.207 7.64823 10.475 7.64823 10.7964C7.64823 11.1178 7.42003 11.3858 7.11698 11.4478L6.98319 11.4614H5.85331C5.48604 11.4614 5.18827 11.1637 5.18827 10.7964C5.18827 10.4291 5.48604 10.1314 5.85331 10.1314H6.98319Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M13.8743 12.6147C13.8742 12.5394 13.7749 12.2553 13.3909 11.9477C13.039 11.6659 12.5573 11.4614 12.0394 11.4614C11.5213 11.4614 11.0398 11.6666 10.6878 11.9487C10.3037 12.2565 10.2045 12.5399 10.2044 12.6147C10.2044 12.6893 10.3034 12.9737 10.6878 13.2817C11.0398 13.5636 11.5215 13.768 12.0394 13.768C12.5574 13.768 13.039 13.5635 13.3909 13.2817C13.7751 12.9739 13.8743 12.6897 13.8743 12.6147ZM15.2044 12.6147C15.2044 13.2772 14.7436 13.9027 14.223 14.3198C13.6701 14.7627 12.9019 15.0981 12.0394 15.0981C11.1768 15.0981 10.4085 14.7627 9.85577 14.3198C9.33533 13.9027 8.87433 13.2769 8.87433 12.6147C8.8744 11.9526 9.33541 11.3276 9.85577 10.9106C10.4086 10.4676 11.1767 10.1313 12.0394 10.1313C12.9018 10.1313 13.6701 10.4668 14.223 10.9096C14.7435 11.3267 15.2043 11.9523 15.2044 12.6147Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M12.0394 13.299C12.4172 13.299 12.7234 12.9927 12.7234 12.6149C12.7234 12.2371 12.4172 11.9308 12.0394 11.9308C11.6616 11.9308 11.3553 12.2371 11.3553 12.6149C11.3553 12.9927 11.6616 13.299 12.0394 13.299Z"
      }
    }
  ]
};
var _e2 = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(R2, Object.assign({}, e, {
    id: "hide-note-icon",
    ref: t,
    icon: vt
  }));
});
_e2.displayName = "HideNoteIcon";
var O = {
  id: "sheet.operation.add-note-popup",
  type: Ms.OPERATION,
  handler: async (i, e) => {
    const t = i.get(z), r = i.get(S3), s = i.get(vr).getCurrentUnitForType(we.UNIVER_SHEET);
    if (!s)
      return false;
    const n = s.getActiveSheet(), a = t.getCurrentLastSelection();
    if (!(a != null && a.primary))
      return false;
    const { primary: u2 } = a;
    return r.showPopup({
      unitId: s.getUnitId(),
      subUnitId: n.getSheetId(),
      row: u2.actualRow,
      col: u2.actualColumn,
      temp: false,
      trigger: e == null ? void 0 : e.trigger
    }), true;
  }
};
var gt = (i) => {
  var P2;
  const { popup: e } = i, t = useDependency(u), r = useDependency(Fn), o = useDependency(ME), s = p5(pe2), n = (P2 = e.extraProps) == null ? void 0 : P2.location;
  if (!n)
    return console.error("Popup extraProps or location is undefined."), null;
  const a = (0, import_react.useRef)(null), u2 = o.getRenderById(n.unitId), [c, l2] = (0, import_react.useState)(null);
  (0, import_react.useEffect)(() => {
    var Y, q;
    const { unitId: C3, subUnitId: g, row: w2, col: fe } = n, { width: ve = 160, height: ge3 = 72 } = (Y = s == null ? void 0 : s.defaultNoteSize) != null ? Y : {}, Z = (q = t.getNote(C3, g, w2, fe)) != null ? q : { width: ve, height: ge3, note: "" };
    a.current && (l2(Z), a.current.style.width = `${Z.width}px`, a.current.style.height = `${Z.height}px`);
  }, [n, a]);
  const p = useDependency(Ls), d = Yi((C3) => {
    n && (C3.note ? p.executeCommand(re.id, {
      unitId: n.unitId,
      sheetId: n.subUnitId,
      row: n.row,
      col: n.col,
      note: C3
    }) : p.executeCommand(se.id, {
      unitId: n.unitId,
      sheetId: n.subUnitId,
      row: n.row,
      col: n.col
    }));
  }), _2 = (0, import_react.useCallback)((C3) => {
    if (!c) return;
    const g = { ...c, note: C3 };
    l2(g), d(g);
  }, [c]), f2 = (0, import_react.useCallback)((C3, g) => {
    if (!c) return;
    const w2 = { ...c, width: C3, height: g };
    l2(w2), d(w2);
  }, [c]);
  return (0, import_jsx_runtime.jsx)(
    HE,
    {
      ref: a,
      "data-u-comp": "note-textarea",
      className: ie("univer-ml-px univer-min-h-1 univer-min-w-1 univer-bg-white !univer-text-sm univer-shadow dark:!univer-bg-gray-800"),
      value: c == null ? void 0 : c.note,
      placeholder: r.t("note.placeholder"),
      onResize: f2,
      onValueChange: _2,
      onWheel: (C3) => {
        document.activeElement !== a.current && u2.engine.getCanvasElement().dispatchEvent(new WheelEvent(C3.type, C3.nativeEvent));
      }
    }
  );
};
function K(i) {
  const e = i.get(z), t = i.get(vr);
  return e.selectionMoveEnd$.pipe(map(() => {
    const r = e.getCurrentLastSelection();
    if (!(r != null && r.primary)) return false;
    const o = P(t);
    if (!o) return false;
    const { actualColumn: s, actualRow: n } = r.primary;
    return !!i.get(u).getNote(o.unitId, o.subUnitId, n, s);
  }));
}
function mt(i) {
  return {
    id: O.id,
    type: H1.BUTTON,
    title: "rightClick.addNote",
    icon: "AddNoteIcon",
    hidden$: combineLatest([Bi(i, we.UNIVER_SHEET), K(i)]).pipe(map(([e, t]) => e || t)),
    disabled$: he(i, { workbookTypes: [Pe], worksheetTypes: [Ve2] }),
    commandId: O.id
  };
}
function St(i) {
  return {
    id: se.id,
    type: H1.BUTTON,
    title: "rightClick.deleteNote",
    icon: "DeleteNoteIcon",
    hidden$: K(i).pipe(map((e) => !e)),
    disabled$: he(i, { workbookTypes: [Pe], worksheetTypes: [Ve2] })
  };
}
function Pt(i) {
  return {
    id: ne.id,
    type: H1.BUTTON,
    title: "rightClick.toggleNote",
    icon: "HideNoteIcon",
    hidden$: K(i).pipe(map((e) => !e))
  };
}
var Nt = {
  [Y1.MAIN_AREA]: {
    [a1.OTHERS]: {
      order: 0,
      [O.id]: {
        order: 0,
        menuItemFactory: mt
      },
      [se.id]: {
        order: 0,
        menuItemFactory: St
      },
      [ne.id]: {
        order: 0,
        menuItemFactory: Pt
      }
    }
  }
};
var It = Object.getOwnPropertyDescriptor;
var Mt = (i, e, t, r) => {
  for (var o = r > 1 ? void 0 : r ? It(e, t) : e, s = i.length - 1, n; s >= 0; s--)
    (n = i[s]) && (o = n(o) || o);
  return o;
};
var k2 = (i, e) => (t, r) => e(t, r, i);
var T = class extends Ve {
  constructor(i, e, t) {
    super(), this._componentManager = i, this._menuManagerService = e, this._commandService = t, this._initComponents(), this._initMenu(), this._initCommands();
  }
  _initComponents() {
    [
      [G2, gt],
      ["AddNoteIcon", he3],
      ["DeleteNoteIcon", de2],
      ["HideNoteIcon", _e2]
    ].forEach(([i, e]) => {
      this.disposeWithMe(
        this._componentManager.register(i, e)
      );
    });
  }
  _initMenu() {
    this._menuManagerService.mergeMenu(Nt);
  }
  _initCommands() {
    this._commandService.registerCommand(O);
  }
};
T = Mt([
  k2(0, Inject(S1)),
  k2(1, Inject(B1)),
  k2(2, Ls)
], T);
var wt = Object.defineProperty;
var bt = Object.getOwnPropertyDescriptor;
var Et = (i, e, t) => e in i ? wt(i, e, { enumerable: true, configurable: true, writable: true, value: t }) : i[e] = t;
var yt = (i, e, t, r) => {
  for (var o = r > 1 ? void 0 : r ? bt(e, t) : e, s = i.length - 1, n; s >= 0; s--)
    (n = i[s]) && (o = n(o) || o);
  return o;
};
var ie3 = (i, e) => (t, r) => e(t, r, i);
var Ce = (i, e, t) => Et(i, typeof e != "symbol" ? e + "" : e, t);
var $t = "SHEET_NOTE_UI_PLUGIN";
var L2 = class extends Ol {
  constructor(i = te, e, t) {
    super(), this._config = i, this._injector = e, this._configService = t;
    const { menu: r, ...o } = oo(
      {},
      te,
      this._config
    );
    r && this._configService.setConfig("menu", r, { merge: true }), this._configService.setConfig(pe2, o);
  }
  onStarting() {
    [
      [S3],
      [$2],
      [x],
      [T],
      [H]
    ].forEach((i) => {
      this._injector.add(i);
    });
  }
  onReady() {
    zc(this._injector, [
      [T],
      [$2]
    ]);
  }
  onRendered() {
    zc(this._injector, [
      [x],
      [H]
    ]);
  }
};
Ce(L2, "pluginName", $t);
Ce(L2, "type", we.UNIVER_SHEET);
L2 = yt([
  qR(w),
  ie3(1, Inject(Injector)),
  ie3(2, ic)
], L2);

// node_modules/@univerjs/sheets-note/lib/es/facade.js
var x2 = class {
  get SheetNoteAdd() {
    return "SheetNoteAdd";
  }
  get SheetNoteDelete() {
    return "SheetNoteDelete";
  }
  get SheetNoteUpdate() {
    return "SheetNoteUpdate";
  }
  get SheetNoteShow() {
    return "SheetNoteShow";
  }
  get SheetNoteHide() {
    return "SheetNoteHide";
  }
  get BeforeSheetNoteAdd() {
    return "BeforeSheetNoteAdd";
  }
  get BeforeSheetNoteDelete() {
    return "BeforeSheetNoteDelete";
  }
  get BeforeSheetNoteUpdate() {
    return "BeforeSheetNoteUpdate";
  }
  get BeforeSheetNoteShow() {
    return "BeforeSheetNoteShow";
  }
  get BeforeSheetNoteHide() {
    return "BeforeSheetNoteHide";
  }
};
j.extend(x2);
var U = class extends k {
  createOrUpdateNote(d) {
    return this._commandService.syncExecuteCommand(
      _.id,
      {
        unitId: this.getUnitId(),
        sheetId: this.getSheetId(),
        row: this.getRow(),
        col: this.getColumn(),
        note: d
      }
    ), this;
  }
  deleteNote() {
    return this._commandService.syncExecuteCommand(
      m.id,
      {
        unitId: this.getUnitId(),
        sheetId: this.getSheetId(),
        row: this.getRow(),
        col: this.getColumn()
      }
    ), this;
  }
  getNote() {
    return this._injector.get(u).getNote(this.getUnitId(), this.getSheetId(), this.getRow(), this.getColumn());
  }
};
k.extend(U);
var C2 = class extends I {
  // eslint-disable-next-line max-lines-per-function
  _initialize(d) {
    this.registerEventHandler(
      this.Event.SheetNoteAdd,
      () => d.get(u).change$.subscribe((e) => {
        if (e.type === "update" && !e.oldNote && e.note) {
          const { unitId: h, sheetId: t, row: o, col: s, note: r, oldNote: i } = e, n = this.getSheetTarget(h, t);
          if (!n)
            return;
          const { workbook: c, worksheet: l2 } = n;
          this.fireEvent(this.Event.SheetNoteAdd, {
            workbook: c,
            worksheet: l2,
            row: o,
            col: s,
            note: r
          });
        }
      })
    ), this.registerEventHandler(
      this.Event.SheetNoteDelete,
      () => d.get(u).change$.subscribe((e) => {
        if (e.type === "update" && e.oldNote && !e.note) {
          const { unitId: h, sheetId: t, row: o, col: s, note: r, oldNote: i } = e, n = this.getSheetTarget(h, t);
          if (!n)
            return;
          const { workbook: c, worksheet: l2 } = n;
          this.fireEvent(this.Event.SheetNoteDelete, {
            workbook: c,
            worksheet: l2,
            row: o,
            col: s,
            oldNote: i
          });
        }
      })
    ), this.registerEventHandler(
      this.Event.SheetNoteUpdate,
      () => d.get(u).change$.subscribe((e) => {
        if (e.type === "update" && e.oldNote && e.note) {
          const { unitId: h, sheetId: t, row: o, col: s, note: r, oldNote: i } = e, n = this.getSheetTarget(h, t);
          if (!n)
            return;
          const { workbook: c, worksheet: l2 } = n;
          this.fireEvent(this.Event.SheetNoteUpdate, {
            workbook: c,
            worksheet: l2,
            row: o,
            col: s,
            note: r,
            oldNote: i
          });
        }
      })
    ), this.registerEventHandler(
      this.Event.SheetNoteShow,
      () => d.get(u).change$.subscribe((e) => {
        if (e.type === "update" && e.oldNote && e.note && !e.oldNote.show && e.note.show) {
          const { unitId: h, sheetId: t, row: o, col: s } = e, r = this.getSheetTarget(h, t);
          if (!r)
            return;
          const { workbook: i, worksheet: n } = r;
          this.fireEvent(this.Event.SheetNoteShow, {
            workbook: i,
            worksheet: n,
            row: o,
            col: s
          });
        }
      })
    ), this.registerEventHandler(
      this.Event.SheetNoteHide,
      () => d.get(u).change$.subscribe((e) => {
        if (e.type === "update" && e.oldNote && e.note && e.oldNote.show && !e.note.show) {
          const { unitId: h, sheetId: t, row: o, col: s } = e, r = this.getSheetTarget(h, t);
          if (!r)
            return;
          const { workbook: i, worksheet: n } = r;
          this.fireEvent(this.Event.SheetNoteHide, {
            workbook: i,
            worksheet: n,
            row: o,
            col: s
          });
        }
      })
    ), this.registerEventHandler(
      this.Event.BeforeSheetNoteAdd,
      () => d.get(Ls).beforeCommandExecuted((e) => {
        if (e.id === re.id) {
          const h = d.get(u), { unitId: t, sheetId: o, row: s, col: r, note: i } = e.params;
          if (h.getNote(t, o, s, r)) return;
          const c = this.getSheetTarget(t, o);
          if (!c)
            return;
          const { workbook: l2, worksheet: g } = c;
          if (this.fireEvent(this.Event.BeforeSheetNoteAdd, {
            workbook: l2,
            worksheet: g,
            row: s,
            col: r,
            note: i
          }))
            throw new KC();
        }
      })
    ), this.registerEventHandler(
      this.Event.BeforeSheetNoteDelete,
      () => d.get(Ls).beforeCommandExecuted((e) => {
        if (e.id === se.id) {
          const h = d.get(u), { unitId: t, sheetId: o, row: s, col: r } = e.params, i = h.getNote(t, o, s, r);
          if (!i) return;
          const n = this.getSheetTarget(t, o);
          if (!n)
            return;
          const { workbook: c, worksheet: l2 } = n;
          if (this.fireEvent(this.Event.BeforeSheetNoteDelete, {
            workbook: c,
            worksheet: l2,
            row: s,
            col: r,
            oldNote: i
          }))
            throw new KC();
        }
      })
    ), this.registerEventHandler(
      this.Event.BeforeSheetNoteUpdate,
      () => d.get(Ls).beforeCommandExecuted((e) => {
        if (e.id === re.id) {
          const h = d.get(u), { unitId: t, sheetId: o, row: s, col: r, note: i } = e.params, n = h.getNote(t, o, s, r);
          if (!n) return;
          const c = this.getSheetTarget(t, o);
          if (!c)
            return;
          const { workbook: l2, worksheet: g } = c;
          if (this.fireEvent(this.Event.BeforeSheetNoteUpdate, {
            workbook: l2,
            worksheet: g,
            row: s,
            col: r,
            note: i,
            oldNote: n
          }))
            throw new KC();
        }
      })
    ), this.registerEventHandler(
      this.Event.BeforeSheetNoteShow,
      () => d.get(Ls).beforeCommandExecuted((e) => {
        if (e.id === ne.id) {
          const h = d.get(u), { unitId: t, sheetId: o, row: s, col: r } = e.params, i = h.getNote(t, o, s, r);
          if (i != null && i.show) return;
          const n = this.getSheetTarget(t, o);
          if (!n)
            return;
          const { workbook: c, worksheet: l2 } = n;
          if (this.fireEvent(this.Event.BeforeSheetNoteShow, {
            workbook: c,
            worksheet: l2,
            row: s,
            col: r
          }))
            throw new KC();
        }
      })
    ), this.registerEventHandler(
      this.Event.BeforeSheetNoteHide,
      () => d.get(Ls).beforeCommandExecuted((e) => {
        if (e.id === ne.id) {
          const h = d.get(u), { unitId: t, sheetId: o, row: s, col: r } = e.params, i = h.getNote(t, o, s, r);
          if (!(i != null && i.show)) return;
          const n = this.getSheetTarget(t, o);
          if (!n)
            return;
          const { workbook: c, worksheet: l2 } = n;
          if (this.fireEvent(this.Event.BeforeSheetNoteHide, {
            workbook: c,
            worksheet: l2,
            row: s,
            col: r
          }))
            throw new KC();
        }
      })
    );
  }
};
I.extend(C2);
var T2 = class extends S {
  getNotes() {
    const a = this._injector.get(u).getSheetNotes(this.getWorkbook().getUnitId(), this.getSheetId()), e = [];
    return a == null || a.forValue((h, t, o) => {
      e.push({
        ...o,
        row: h,
        col: t
      });
    }), e;
  }
};
S.extend(T2);

// node_modules/@univerjs/preset-sheets-note/lib/es/index.js
function m3() {
  return {
    plugins: [
      w,
      L2
    ].filter((e) => !!e)
  };
}
export {
  m as RemoveNoteMutation,
  se as SheetDeleteNoteCommand,
  ne as SheetToggleNotePopupCommand,
  re as SheetUpdateNoteCommand,
  $2 as SheetsCellContentController,
  gt as SheetsNote,
  u as SheetsNoteModel,
  x as SheetsNotePopupController,
  S3 as SheetsNotePopupService,
  M as SheetsNoteResourceController,
  D as ToggleNotePopupMutation,
  w as UniverSheetsNotePlugin,
  m3 as UniverSheetsNotePreset,
  L2 as UniverSheetsNoteUIPlugin,
  _ as UpdateNoteMutation,
  R as UpdateNotePositionMutation
};
//# sourceMappingURL=@univerjs_presets_preset-sheets-note.js.map
