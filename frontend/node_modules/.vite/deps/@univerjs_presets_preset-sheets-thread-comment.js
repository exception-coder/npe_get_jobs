import {
  E,
  I,
  Q,
  R,
  X,
  Z,
  ee,
  he,
  i,
  p,
  te,
  z
} from "./chunk-6Q4G5S6Y.js";
import {
  C,
  S,
  k
} from "./chunk-FOCXVU2X.js";
import {
  $d2 as $d,
  B1,
  Bi,
  De,
  Ge2 as Ge,
  Gr,
  H1,
  Jf,
  L1,
  Mi,
  Mr,
  S1,
  Ve as Ve2,
  Wi2 as Wi,
  Y1,
  Yn2 as Yn,
  _e,
  a1,
  he as he2,
  nn,
  p5,
  q1,
  qe2 as qe,
  st,
  ue,
  useDependency,
  useObservable,
  we as we2,
  ye,
  yi2 as yi
} from "./chunk-DZMX4FYO.js";
import {
  Dr,
  Ft,
  G,
  Hs,
  ME,
  P,
  Xs2 as Xs,
  fs,
  ht,
  ls,
  nr,
  pn2,
  qn,
  qr,
  xh,
  xt,
  z as z2
} from "./chunk-I7I3GTAS.js";
import {
  I as I2,
  LE,
  Rp,
  ie,
  j,
  kt as kt2,
  pr,
  require_jsx_runtime,
  require_react,
  vf,
  vr as vr2
} from "./chunk-YFGUMDM2.js";
import {
  BehaviorSubject,
  Dl,
  E1,
  En,
  Fn,
  Inject,
  Injector,
  J,
  Je,
  KC,
  Ls,
  Ms,
  Ol,
  Or,
  Pn,
  Rs,
  Subject,
  Ve,
  We,
  ao,
  debounceTime,
  dn,
  et,
  filter,
  ge,
  ic,
  kt,
  map,
  nC,
  oo,
  pn,
  pt,
  qR,
  sr,
  vr,
  we,
  zc
} from "./chunk-RGZYGL3P.js";
import {
  __toESM
} from "./chunk-DC5AMYBS.js";

// node_modules/@univerjs/sheets-thread-comment/lib/es/index.js
var A = Object.defineProperty;
var W = (a, e, r) => e in a ? A(a, e, { enumerable: true, configurable: true, writable: true, value: r }) : a[e] = r;
var _ = (a, e, r) => W(a, typeof e != "symbol" ? e + "" : e, r);
var Z2 = Object.getOwnPropertyDescriptor;
var ee2 = (a, e, r, t) => {
  for (var n = t > 1 ? void 0 : t ? Z2(e, r) : e, s = a.length - 1, o; s >= 0; s--)
    (o = a[s]) && (n = o(n) || n);
  return n;
};
var x = (a, e) => (r, t) => e(r, t, a);
var C2 = class extends Ve {
  constructor(e, r) {
    super();
    _(this, "_matrixMap", /* @__PURE__ */ new Map());
    _(this, "_locationMap", /* @__PURE__ */ new Map());
    _(this, "_commentUpdate$", new Subject());
    _(this, "commentUpdate$", this._commentUpdate$.asObservable());
    this._threadCommentModel = e, this._univerInstanceService = r, this._init(), this.disposeWithMe(() => {
      this._commentUpdate$.complete();
    });
  }
  _init() {
    this._initData(), this._initUpdateTransform();
  }
  _ensureCommentMatrix(e, r) {
    let t = this._matrixMap.get(e);
    t || (t = /* @__PURE__ */ new Map(), this._matrixMap.set(e, t));
    let n = t.get(r);
    return n || (n = new pt(), t.set(r, n)), n;
  }
  _ensureCommentLocationMap(e, r) {
    let t = this._locationMap.get(e);
    t || (t = /* @__PURE__ */ new Map(), this._locationMap.set(e, t));
    let n = t.get(r);
    return n || (n = /* @__PURE__ */ new Map(), t.set(r, n)), n;
  }
  _addCommentToMatrix(e, r, t, n) {
    var o;
    const s = (o = e.getValue(r, t)) != null ? o : /* @__PURE__ */ new Set();
    s.add(n), e.setValue(r, t, s);
  }
  _deleteCommentFromMatrix(e, r, t, n) {
    if (r >= 0 && t >= 0) {
      const s = e.getValue(r, t);
      s && s.has(n) && (s.delete(n), s.size === 0 && e.realDeleteValue(r, t));
    }
  }
  _ensure(e, r) {
    const t = this._ensureCommentMatrix(e, r), n = this._ensureCommentLocationMap(e, r);
    return { matrix: t, locationMap: n };
  }
  _initData() {
    const e = this._threadCommentModel.getAll();
    for (const r of e)
      for (const t of r.threads) {
        const { unitId: n, subUnitId: s, root: o } = t;
        this._addComment(n, s, o);
      }
  }
  _addComment(e, r, t) {
    const n = fs(t.ref), s = t.parentId, { row: o, column: i2 } = n, c = t.id, { matrix: m, locationMap: d } = this._ensure(e, r);
    !s && o >= 0 && i2 >= 0 && (this._addCommentToMatrix(m, o, i2, c), d.set(c, { row: o, column: i2 })), s || this._commentUpdate$.next({
      unitId: e,
      subUnitId: r,
      payload: t,
      type: "add",
      isRoot: !s,
      ...n
    });
  }
  // eslint-disable-next-line max-lines-per-function
  _initUpdateTransform() {
    this.disposeWithMe(this._threadCommentModel.commentUpdate$.subscribe((e) => {
      const { unitId: r, subUnitId: t } = e;
      try {
        if (this._univerInstanceService.getUnitType(r) !== we.UNIVER_SHEET)
          return;
      } catch {
      }
      const { matrix: n, locationMap: s } = this._ensure(r, t);
      switch (e.type) {
        case "add": {
          this._addComment(e.unitId, e.subUnitId, e.payload);
          break;
        }
        case "delete": {
          const { isRoot: o, comment: i2 } = e.payload;
          if (o) {
            const c = fs(i2.ref), { row: m, column: d } = c;
            this._deleteCommentFromMatrix(n, m, d, i2.id), this._commentUpdate$.next({
              ...e,
              ...c
            });
          }
          break;
        }
        case "update": {
          const { commentId: o } = e.payload, i2 = this._threadCommentModel.getComment(r, t, o);
          if (!i2)
            return;
          const c = fs(i2.ref);
          this._commentUpdate$.next({
            ...e,
            ...c
          });
          break;
        }
        case "updateRef": {
          const o = fs(e.payload.ref), { commentId: i2 } = e.payload, c = s.get(i2);
          if (!c)
            return;
          const { row: m, column: d } = c;
          this._deleteCommentFromMatrix(n, m, d, i2), s.delete(i2), o.row >= 0 && o.column >= 0 && (this._addCommentToMatrix(n, o.row, o.column, i2), s.set(i2, { row: o.row, column: o.column })), this._commentUpdate$.next({
            ...e,
            ...o
          });
          break;
        }
        case "resolve": {
          const { unitId: o, subUnitId: i2, payload: c } = e, { locationMap: m } = this._ensure(o, i2), d = m.get(c.commentId);
          d && this._commentUpdate$.next({
            ...e,
            ...d
          });
          break;
        }
      }
    }));
  }
  getByLocation(e, r, t, n) {
    var i2;
    return (i2 = this.getAllByLocation(e, r, t, n).filter((c) => !c.resolved)[0]) == null ? void 0 : i2.id;
  }
  getAllByLocation(e, r, t, n) {
    const o = this._ensureCommentMatrix(e, r).getValue(t, n);
    return o ? Array.from(o).map((i2) => this.getComment(e, r, i2)).filter(Boolean) : [];
  }
  getComment(e, r, t) {
    return this._threadCommentModel.getComment(e, r, t);
  }
  getCommentWithChildren(e, r, t, n) {
    const s = this.getByLocation(e, r, t, n);
    if (!s)
      return;
    const o = this.getComment(e, r, s);
    if (o)
      return this._threadCommentModel.getThread(e, r, o.threadId);
  }
  showCommentMarker(e, r, t, n) {
    const s = this.getByLocation(e, r, t, n);
    if (!s)
      return false;
    const o = this.getComment(e, r, s);
    return !!(o && !o.resolved);
  }
  getSubUnitAll(e, r) {
    return this._threadCommentModel.getUnit(e).filter((t) => t.subUnitId === r).map((t) => t.root);
  }
};
C2 = ee2([
  x(0, Inject(i)),
  x(1, vr)
], C2);
var te2 = Object.getOwnPropertyDescriptor;
var re = (a, e, r, t) => {
  for (var n = t > 1 ? void 0 : t ? te2(e, r) : e, s = a.length - 1, o; s >= 0; s--)
    (o = a[s]) && (n = o(n) || n);
  return n;
};
var u = (a, e) => (r, t) => e(r, t, a);
var M = class extends Ve {
  constructor(e, r, t, n, s) {
    super();
    _(this, "_disposableMap", /* @__PURE__ */ new Map());
    _(this, "_watcherMap", /* @__PURE__ */ new Map());
    _(this, "_handleRangeChange", (e2, r2, t2, n2, s2) => {
      const o = t2.id, i2 = {
        startColumn: t2.column,
        endColumn: t2.column,
        startRow: t2.row,
        endRow: t2.row
      };
      return n2 ? {
        redos: [{
          id: z.id,
          params: {
            unitId: e2,
            subUnitId: r2,
            payload: {
              ref: Ft(n2),
              commentId: o
            },
            silent: s2
          }
        }],
        undos: [{
          id: z.id,
          params: {
            unitId: e2,
            subUnitId: r2,
            payload: {
              ref: Ft(i2),
              commentId: o
            },
            silent: s2
          }
        }]
      } : {
        redos: [{
          id: E.id,
          params: {
            unitId: e2,
            subUnitId: r2,
            commentId: o
          }
        }],
        undos: [{
          id: R.id,
          params: {
            unitId: e2,
            subUnitId: r2,
            comment: t2,
            sync: true
          }
        }]
      };
    });
    this._refRangeService = e, this._sheetsThreadCommentModel = r, this._threadCommentModel = t, this._selectionManagerService = n, this._commandService = s, this._initData(), this._initRefRange();
  }
  _getIdWithUnitId(e, r, t) {
    return `${e}-${r}-${t}`;
  }
  _register(e, r, t) {
    const n = t.id, s = {
      startColumn: t.column,
      endColumn: t.column,
      startRow: t.row,
      endRow: t.row
    };
    this._disposableMap.set(
      this._getIdWithUnitId(e, r, n),
      this._refRangeService.registerRefRange(s, (o) => {
        const i2 = xh(s, o, { selectionManagerService: this._selectionManagerService }), c = Array.isArray(i2) ? i2[0] : i2;
        return c && c.startColumn === s.startColumn && c.startRow === s.startRow ? {
          undos: [],
          redos: []
        } : this._handleRangeChange(e, r, t, c, false);
      }, e, r)
    );
  }
  _watch(e, r, t) {
    const n = t.id, s = {
      startColumn: t.column,
      endColumn: t.column,
      startRow: t.row,
      endRow: t.row
    };
    this._watcherMap.set(
      this._getIdWithUnitId(e, r, n),
      this._refRangeService.watchRange(e, r, s, (o, i2) => {
        const { redos: c } = this._handleRangeChange(e, r, t, i2, true);
        E1(c, this._commandService, { onlyLocal: true });
      }, true)
    );
  }
  _unwatch(e, r, t) {
    var s;
    const n = this._getIdWithUnitId(e, r, t);
    (s = this._watcherMap.get(n)) == null || s.dispose(), this._watcherMap.delete(n);
  }
  _unregister(e, r, t) {
    var s;
    const n = this._getIdWithUnitId(e, r, t);
    (s = this._disposableMap.get(n)) == null || s.dispose(), this._disposableMap.delete(n);
  }
  _initData() {
    const e = this._threadCommentModel.getAll();
    for (const r of e)
      for (const t of r.threads) {
        const { unitId: n, subUnitId: s, root: o } = t, i2 = fs(o.ref), c = {
          ...o,
          ...i2
        };
        this._register(n, s, c), this._watch(n, s, c);
      }
  }
  _initRefRange() {
    this.disposeWithMe(
      this._sheetsThreadCommentModel.commentUpdate$.subscribe((e) => {
        const { unitId: r, subUnitId: t } = e;
        switch (e.type) {
          case "add": {
            if (e.payload.parentId)
              return;
            const n = {
              ...e.payload,
              row: e.row,
              column: e.column
            };
            this._register(e.unitId, e.subUnitId, n), this._watch(e.unitId, e.subUnitId, n);
            break;
          }
          case "delete": {
            this._unregister(r, t, e.payload.commentId), this._unwatch(r, t, e.payload.commentId);
            break;
          }
          case "updateRef": {
            const n = this._sheetsThreadCommentModel.getComment(r, t, e.payload.commentId);
            if (!n)
              return;
            this._unregister(r, t, e.payload.commentId);
            const s = {
              ...n,
              row: e.row,
              column: e.column
            };
            e.silent || (this._unwatch(r, t, e.payload.commentId), this._watch(r, t, s)), this._register(e.unitId, e.subUnitId, s);
            break;
          }
        }
      })
    ), this.disposeWithMe(We(() => {
      this._disposableMap.forEach((e) => {
        e.dispose();
      }), this._disposableMap.clear();
    }));
  }
};
M = re([
  u(0, Inject(xt)),
  u(1, Inject(C2)),
  u(2, Inject(i)),
  u(3, Inject(z2)),
  u(4, Ls)
], M);
var ne = {};
var se = Object.getOwnPropertyDescriptor;
var oe = (a, e, r, t) => {
  for (var n = t > 1 ? void 0 : t ? se(e, r) : e, s = a.length - 1, o; s >= 0; s--)
    (o = a[s]) && (n = o(n) || n);
  return n;
};
var f = (a, e) => (r, t) => e(r, t, a);
var v = class extends Ve {
  constructor(a, e, r, t) {
    super(), this._univerInstanceService = a, this._sheetInterceptorService = e, this._threadCommentModel = r, this._threadCommentDataSourceService = t, this._initSheetChange();
  }
  // eslint-disable-next-line max-lines-per-function
  _initSheetChange() {
    this.disposeWithMe(
      this._sheetInterceptorService.interceptCommand({
        // eslint-disable-next-line max-lines-per-function
        getMutations: (a) => {
          var e;
          if (a.id === Xs.id) {
            const r = a.params, t = r.unitId || this._univerInstanceService.getCurrentUnitOfType(we.UNIVER_SHEET).getUnitId(), n = r.subUnitId || ((e = this._univerInstanceService.getCurrentUnitOfType(we.UNIVER_SHEET).getActiveSheet()) == null ? void 0 : e.getSheetId());
            if (!t || !n)
              return { redos: [], undos: [] };
            const s = this._threadCommentModel.ensureMap(t, n), o = Array.from(s.values()).filter((d) => !d.parentId), i2 = this._threadCommentDataSourceService.syncUpdateMutationToColla, c = [], m = [];
            return o.forEach(({ children: d, ...l3 }) => {
              c.push({
                id: E.id,
                params: {
                  unitId: t,
                  subUnitId: n,
                  commentId: l3.id
                }
              }), m.push({
                id: R.id,
                params: {
                  unitId: t,
                  subUnitId: n,
                  comment: {
                    ...l3,
                    children: i2 ? d : void 0
                  },
                  sync: !i2
                }
              });
            }), { redos: c, undos: m };
          } else if (a.id === qr.id) {
            const r = a.params, { unitId: t, subUnitId: n, targetSubUnitId: s } = r;
            if (!t || !n || !s)
              return { redos: [], undos: [] };
            const o = this._threadCommentModel.ensureMap(t, n), i2 = Array.from(o.values()).map((l3) => ({
              ...l3,
              subUnitId: s,
              id: et(),
              threadId: et()
            })).filter((l3) => !l3.parentId), c = this._threadCommentDataSourceService.syncUpdateMutationToColla, m = [], d = [];
            return i2.forEach(({ children: l3, ...U2 }) => {
              m.push({
                id: R.id,
                params: {
                  unitId: t,
                  subUnitId: s,
                  comment: {
                    ...U2,
                    children: c ? l3 : void 0
                  },
                  sync: !c
                }
              }), d.push({
                id: E.id,
                params: {
                  unitId: t,
                  subUnitId: s,
                  commentId: U2.id
                }
              });
            }), { redos: m, undos: d };
          }
          return { redos: [], undos: [] };
        }
      })
    );
  }
};
v = oe([
  f(0, vr),
  f(1, Inject(G)),
  f(2, Inject(i)),
  f(3, p)
], v);
var ae = "SHEET_THREAD_COMMENT_BASE_PLUGIN";
var ie2 = Object.defineProperty;
var ce = Object.getOwnPropertyDescriptor;
var de = (a, e, r) => e in a ? ie2(a, e, { enumerable: true, configurable: true, writable: true, value: r }) : a[e] = r;
var me = (a, e, r, t) => {
  for (var n = t > 1 ? void 0 : t ? ce(e, r) : e, s = a.length - 1, o; s >= 0; s--)
    (o = a[s]) && (n = o(n) || n);
  return n;
};
var D = (a, e) => (r, t) => e(r, t, a);
var P2 = (a, e, r) => de(a, typeof e != "symbol" ? e + "" : e, r);
var S2 = class extends Ol {
  constructor(a = ne, e, r) {
    super(), this._config = a, this._injector = e, this._commandService = r;
  }
  onStarting() {
    [
      [C2],
      [M],
      [v]
    ].forEach((a) => {
      this._injector.add(a);
    }), zc(this._injector, [
      [M],
      [v]
    ]);
  }
};
P2(S2, "pluginName", ae);
P2(S2, "type", we.UNIVER_SHEET);
S2 = me([
  qR(I),
  D(1, Inject(Injector)),
  D(2, Inject(Ls))
], S2);

// node_modules/@univerjs/thread-comment-ui/lib/es/index.js
var import_jsx_runtime = __toESM(require_jsx_runtime());
var import_react = __toESM(require_react());
var He = Object.defineProperty;
var Ve3 = (n, e, t) => e in n ? He(n, e, { enumerable: true, configurable: true, writable: true, value: t }) : n[e] = t;
var W2 = (n, e, t) => Ve3(n, typeof e != "symbol" ? e + "" : e, t);
var pt2 = Object.getOwnPropertyDescriptor;
var Ct = (n, e, t, r) => {
  for (var i2 = r > 1 ? void 0 : r ? pt2(e, t) : e, o = n.length - 1, c; o >= 0; o--)
    (c = n[o]) && (i2 = c(i2) || i2);
  return i2;
};
var Ie = (n, e) => (t, r) => e(t, r, n);
var Y = class extends Ve {
  constructor(e, t) {
    super();
    W2(this, "_panelVisible", false);
    W2(this, "_panelVisible$", new BehaviorSubject(false));
    W2(this, "_activeCommentId");
    W2(this, "_activeCommentId$", new BehaviorSubject(void 0));
    W2(this, "panelVisible$", this._panelVisible$.asObservable());
    W2(this, "activeCommentId$", this._activeCommentId$.asObservable());
    this._sidebarService = e, this._univerInstanceService = t, this._init(), this.disposeWithMe(() => {
      this._activeCommentId$.complete(), this._panelVisible$.complete();
    });
  }
  _init() {
    this.disposeWithMe(
      this._sidebarService.sidebarOptions$.subscribe((e) => {
        e.visible || this.setPanelVisible(false);
      })
    ), this.disposeWithMe(
      this._univerInstanceService.getCurrentTypeOfUnit$(we.UNIVER_SHEET).pipe(filter((e) => !e)).subscribe(() => {
        this._sidebarService.close();
      })
    );
  }
  get panelVisible() {
    return this._panelVisible;
  }
  get activeCommentId() {
    return this._activeCommentId;
  }
  setPanelVisible(e) {
    this._panelVisible = e, this._panelVisible$.next(e);
  }
  setActiveComment(e) {
    this._activeCommentId = e, this._activeCommentId$.next(e);
  }
};
Y = Ct([
  Ie(0, Inject(we2)),
  Ie(1, vr)
], Y);
var gt = "thread-comment-panel";
var It = "UNIVER_THREAD_COMMENT_UI_PLUGIN";
var xt2 = {
  id: "thread-comment-ui.operation.toggle-panel",
  type: Ms.OPERATION,
  handler(n) {
    const e = n.get(we2), t = n.get(Y);
    return t.panelVisible ? (e.close(), t.setPanelVisible(false)) : (e.open({
      header: { title: "threadCommentUI.panel.title" },
      children: { label: gt },
      width: 330
    }), t.setPanelVisible(true)), true;
  }
};
var F = {
  id: "thread-comment-ui.operation.set-active-comment",
  type: Ms.OPERATION,
  handler(n, e) {
    return n.get(Y).setActiveComment(e), true;
  }
};
var bt = "thread-comment-ui.config";
var xe = {};
var yt = Object.defineProperty;
var wt = Object.getOwnPropertyDescriptor;
var _t = (n, e, t) => e in n ? yt(n, e, { enumerable: true, configurable: true, writable: true, value: t }) : n[e] = t;
var St = (n, e, t, r) => {
  for (var i2 = r > 1 ? void 0 : r ? wt(e, t) : e, o = n.length - 1, c; o >= 0; o--)
    (c = n[o]) && (i2 = c(i2) || i2);
  return i2;
};
var me2 = (n, e) => (t, r) => e(t, r, n);
var $e = (n, e, t) => _t(n, typeof e != "symbol" ? e + "" : e, t);
var ce2 = class extends Ol {
  constructor(n = xe, e, t, r) {
    super(), this._config = n, this._injector = e, this._commandService = t, this._configService = r;
    const { menu: i2, ...o } = oo(
      {},
      xe,
      this._config
    );
    i2 && this._configService.setConfig("menu", i2, { merge: true }), this._configService.setConfig(bt, o);
  }
  onStarting() {
    var n;
    nC([
      [Y]
    ], (n = this._config) == null ? void 0 : n.overrides).forEach((e) => {
      this._injector.add(e);
    }), [xt2, F].forEach((e) => {
      this._commandService.registerCommand(e);
    });
  }
};
$e(ce2, "pluginName", It);
$e(ce2, "type", we.UNIVER_UNKNOWN);
ce2 = St([
  qR(I),
  me2(1, Inject(Injector)),
  me2(2, Ls),
  me2(3, ic)
], ce2);
function z3({ ref: n, ...e }) {
  const { icon: t, id: r, className: i2, extend: o, ...c } = e, x2 = `univerjs-icon univerjs-icon-${r} ${i2 || ""}`.trim(), h2 = (0, import_react.useRef)(`_${kt3()}`);
  return ke(t, `${r}`, {
    defIds: t.defIds,
    idSuffix: h2.current
  }, {
    ref: n,
    className: x2,
    ...c
  }, o);
}
function ke(n, e, t, r, i2) {
  return (0, import_react.createElement)(n.tag, {
    key: e,
    ...Nt(n, t, i2),
    ...r
  }, ($t(n, t).children || []).map((o, c) => ke(o, `${e}-${n.tag}-${c}`, t, void 0, i2)));
}
function Nt(n, e, t) {
  const r = { ...n.attrs };
  t != null && t.colorChannel1 && r.fill === "colorChannel1" && (r.fill = t.colorChannel1), n.tag === "mask" && r.id && (r.id = r.id + e.idSuffix), Object.entries(r).forEach(([o, c]) => {
    o === "mask" && typeof c == "string" && (r[o] = c.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  });
  const { defIds: i2 } = e;
  return !i2 || i2.length === 0 || (n.tag === "use" && r["xlink:href"] && (r["xlink:href"] = r["xlink:href"] + e.idSuffix), Object.entries(r).forEach(([o, c]) => {
    typeof c == "string" && (r[o] = c.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  })), r;
}
function $t(n, e) {
  var r;
  const { defIds: t } = e;
  return !t || t.length === 0 ? n : n.tag === "defs" && ((r = n.children) != null && r.length) ? {
    ...n,
    children: n.children.map((i2) => typeof i2.attrs.id == "string" && t && t.includes(i2.attrs.id) ? {
      ...i2,
      attrs: {
        ...i2.attrs,
        id: i2.attrs.id + e.idSuffix
      }
    } : i2)
  } : n;
}
function kt3() {
  return Math.random().toString(36).substring(2, 8);
}
z3.displayName = "UniverIcon";
var Ut = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M5.3313 1.4667C5.3313 1.13533 5.59993 0.866699 5.9313 0.866699H10.069C10.4004 0.866699 10.669 1.13533 10.669 1.4667C10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443C14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928L9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171C10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778L9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539C9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263L6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539C5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778L6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",
        fillRule: "evenodd",
        clipRule: "evenodd"
      }
    }
  ]
};
var Ue = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(z3, Object.assign({}, e, {
    id: "delete-icon",
    ref: t,
    icon: Ut
  }));
});
Ue.displayName = "DeleteIcon";
var Tt = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [{
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"
    }
  }]
};
var Te = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(z3, Object.assign({}, e, {
    id: "increase-icon",
    ref: t,
    icon: Tt
  }));
});
Te.displayName = "IncreaseIcon";
var Dt = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M3 9C3.55228 9 4 8.55228 4 8C4 7.44772 3.55228 7 3 7C2.44772 7 2 7.44772 2 8C2 8.55228 2.44772 9 3 9Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M8 9C8.55228 9 9 8.55228 9 8C9 7.44772 8.55228 7 8 7C7.44772 7 7 7.44772 7 8C7 8.55228 7.44772 9 8 9Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M13 9C13.5523 9 14 8.55228 14 8C14 7.44772 13.5523 7 13 7C12.4477 7 12 7.44772 12 8C12 8.55228 12.4477 9 13 9Z"
      }
    }
  ]
};
var De2 = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(z3, Object.assign({}, e, {
    id: "more-horizontal-icon",
    ref: t,
    icon: Dt
  }));
});
De2.displayName = "MoreHorizontalIcon";
var Et = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        stroke: "currentColor",
        d: "M7.48389 10.3267V12.1905C7.48389 12.7428 7.9316 13.1905 8.48389 13.1905H11.2216L12.2955 14.2644L13.3695 13.1905H14.1593C14.7116 13.1905 15.1593 12.7428 15.1593 12.1905V8.46289C15.1593 7.91061 14.7116 7.46289 14.1593 7.46289H12.2955",
        strokeLinecap: "round",
        strokeLinejoin: "round",
        strokeWidth: 1.2
      }
    },
    {
      tag: "path",
      attrs: {
        stroke: "currentColor",
        d: "M0.840332 3.73535C0.840332 2.63078 1.73576 1.73535 2.84033 1.73535H10.2955C11.4001 1.73535 12.2955 2.63078 12.2955 3.73535V8.32676C12.2955 9.43132 11.4001 10.3268 10.2955 10.3268H5.6014L4.1695 11.7587L3.05978 10.3268H2.84033C1.73576 10.3268 0.840332 9.43133 0.840332 8.32676V3.73535Z",
        strokeLinecap: "round",
        strokeLinejoin: "round",
        strokeWidth: 1.2
      }
    },
    {
      tag: "path",
      attrs: {
        stroke: "currentColor",
        d: "M6.41016 6.1311H6.76813",
        strokeLinecap: "round",
        strokeWidth: 1.2
      }
    },
    {
      tag: "path",
      attrs: {
        stroke: "currentColor",
        d: "M8.91626 6.1311H9.27424",
        strokeLinecap: "round",
        strokeWidth: 1.2
      }
    },
    {
      tag: "path",
      attrs: {
        stroke: "currentColor",
        d: "M3.90454 6.1311H4.26252",
        strokeLinecap: "round",
        strokeWidth: 1.2
      }
    }
  ]
};
var Ee = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(z3, Object.assign({}, e, {
    id: "reply-to-comment-icon",
    ref: t,
    icon: Et
  }));
});
Ee.displayName = "ReplyToCommentIcon";
var Mt = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 17 17",
    width: "1em",
    height: "1em"
  },
  children: [{
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M8.6106 15.4036C12.4766 15.4036 15.6106 12.2696 15.6106 8.40356C15.6106 4.53757 12.4766 1.40356 8.6106 1.40356C4.7446 1.40356 1.6106 4.53757 1.6106 8.40356C1.6106 12.2696 4.7446 15.4036 8.6106 15.4036ZM12.3351 6.82773C12.5694 6.59342 12.5694 6.21352 12.3351 5.9792C12.1007 5.74489 11.7208 5.74489 11.4865 5.9792L7.91079 9.55494L6.33506 7.9792C6.10074 7.74489 5.72084 7.74489 5.48653 7.9792C5.25221 8.21352 5.25221 8.59342 5.48653 8.82773L7.48653 10.8277C7.72084 11.062 8.10074 11.062 8.33506 10.8277L12.3351 6.82773Z",
      fillRule: "evenodd",
      clipRule: "evenodd"
    }
  }]
};
var Me = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(z3, Object.assign({}, e, {
    id: "resolved-icon",
    ref: t,
    icon: Mt
  }));
});
Me.displayName = "ResolvedIcon";
var Rt = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 17 17",
    width: "1em",
    height: "1em"
  },
  children: [{
    tag: "circle",
    attrs: {
      cx: 8.73,
      cy: 8.4,
      r: 6.4,
      stroke: "currentColor",
      strokeWidth: 1.2
    }
  }, {
    tag: "path",
    attrs: {
      stroke: "currentColor",
      d: "M6.02637 8.40356L8.02637 10.4036L12.0264 6.40356",
      strokeLinecap: "round",
      strokeLinejoin: "round",
      strokeWidth: 1.2
    }
  }]
};
var Re = (0, import_react.forwardRef)(function(e, t) {
  return (0, import_react.createElement)(z3, Object.assign({}, e, {
    id: "solve-icon",
    ref: t,
    icon: Rt
  }));
});
Re.displayName = "SolveIcon";
function be(n) {
  return {
    id: "d",
    body: n,
    documentStyle: {}
  };
}
var Oe = (0, import_react.forwardRef)((n, e) => {
  var R3;
  const { comment: t, onSave: r, id: i2, onCancel: o, autoFocus: c, unitId: x2, type: h2 } = n, N2 = useDependency(Ls), k2 = useDependency(Fn), [V2, U2] = (0, import_react.useState)(false), b = useDependency(Ge), u2 = (0, import_react.useRef)(null), v2 = h2 === we.UNIVER_DOC ? Dl : x2, [T, y2] = (0, import_react.useState)(() => {
    var d, m, f2;
    return Je.transform.getPlainText((f2 = (m = (d = u2.current) == null ? void 0 : d.getDocumentData().body) == null ? void 0 : m.dataStream) != null ? f2 : "");
  });
  (0, import_react.useEffect)(() => {
    var m, f2, w2, p2;
    y2(Je.transform.getPlainText((w2 = (f2 = (m = u2.current) == null ? void 0 : m.getDocumentData().body) == null ? void 0 : f2.dataStream) != null ? w2 : ""));
    const d = (p2 = u2.current) == null ? void 0 : p2.selectionChange$.subscribe(() => {
      var s, _3, A4;
      y2(Je.transform.getPlainText((A4 = (_3 = (s = u2.current) == null ? void 0 : s.getDocumentData().body) == null ? void 0 : _3.dataStream) != null ? A4 : ""));
    });
    return () => d == null ? void 0 : d.unsubscribe();
  }, [(R3 = u2.current) == null ? void 0 : R3.selectionChange$]);
  const j3 = (0, import_react.useMemo)(() => ({
    keyCodes: [{ keyCode: q1.ENTER }],
    handler: (d) => {
      d === q1.ENTER && N2.executeCommand(
        Gr.id
      );
    }
  }), [N2]);
  (0, import_react.useImperativeHandle)(e, () => ({
    reply(d) {
      var f2, w2;
      if (!u2.current)
        return;
      b.focus((f2 = u2.current.getEditorId()) != null ? f2 : "");
      const m = be(d);
      (w2 = u2.current) == null || w2.setDocumentData(m, [{
        startOffset: m.body.dataStream.length - 2,
        endOffset: m.body.dataStream.length - 2,
        collapsed: true
      }]);
    }
  }));
  const C3 = () => {
    if (u2.current) {
      const d = J.deepClone(u2.current.getDocumentData().body);
      U2(false), r == null || r({
        ...t,
        text: d
      }), u2.current.replaceText(""), setTimeout(() => {
        var m, f2;
        (m = u2.current) == null || m.setSelectionRanges([]), (f2 = u2.current) == null || f2.blur();
      }, 10);
    }
  };
  return (0, import_jsx_runtime.jsxs)("div", { onClick: (d) => d.preventDefault(), children: [
    (0, import_jsx_runtime.jsx)(
      Jf,
      {
        className: "univer-w-full",
        editorRef: u2,
        autoFocus: c,
        keyboardEventConfig: j3,
        placeholder: k2.t("threadCommentUI.editor.placeholder"),
        initialValue: (t == null ? void 0 : t.text) && be(t.text),
        onFocusChange: (d) => d && U2(d),
        isSingle: false,
        maxHeight: 64,
        onClickOutside: () => {
          setTimeout(() => {
            b.focus(v2);
          }, 30);
        }
      }
    ),
    V2 ? (0, import_jsx_runtime.jsxs)("div", { className: "univer-mt-3 univer-flex univer-flex-row univer-justify-end univer-gap-2", children: [
      (0, import_jsx_runtime.jsx)(
        vr2,
        {
          onClick: () => {
            var d;
            o == null || o(), U2(false), (d = u2.current) == null || d.replaceText("", true), N2.executeCommand(F.id);
          },
          children: k2.t("threadCommentUI.editor.cancel")
        }
      ),
      (0, import_jsx_runtime.jsx)(
        vr2,
        {
          variant: "primary",
          disabled: !T,
          onClick: C3,
          children: k2.t(i2 ? "threadCommentUI.editor.save" : "threadCommentUI.editor.reply")
        }
      )
    ] }) : null
  ] });
});
var Ot = (n) => {
  const { dataStream: e, customRanges: t } = n, r = e.endsWith(`\r
`) ? e.length - 2 : e.length, i2 = [];
  let o = 0;
  return t == null || t.forEach((c) => {
    o < c.startIndex && i2.push({
      type: "text",
      content: e.slice(o, c.startIndex)
    }), i2.push({
      type: "mention",
      content: {
        label: e.slice(c.startIndex, c.endIndex + 1),
        id: c.rangeId
      }
    }), o = c.endIndex + 1;
  }), i2.push({
    type: "text",
    content: e.slice(o, r)
  }), i2;
};
var Lt = (n) => {
  const { paragraphs: e = [] } = n;
  let t = 0;
  return e.map((r) => {
    const i2 = kt(n, t, r.startIndex);
    return t = r.startIndex + 1, Ot(i2);
  });
};
var Ht = (n) => {
  let e = "";
  const t = [];
  return n.forEach((r) => {
    switch (r.type) {
      case "text":
        e += r.content;
        break;
      case "mention": {
        const i2 = e.length;
        e += r.content.label;
        const o = e.length - 1;
        t.push({
          rangeId: r.content.id,
          rangeType: pn.MENTION,
          startIndex: i2,
          endIndex: o,
          properties: {},
          wholeEntity: true
        });
        break;
      }
    }
  }), e += `\r
`, {
    textRuns: [],
    paragraphs: [
      {
        startIndex: e.length - 2,
        paragraphStyle: {}
      }
    ],
    sectionBreaks: [
      {
        startIndex: e.length - 1
      }
    ],
    dataStream: e,
    customRanges: t
  };
};
var Le = "__mock__";
var Vt = (n) => {
  const { item: e, unitId: t, subUnitId: r, editing: i2, onEditingChange: o, onReply: c, resolved: x2, isRoot: h2, onClose: N2, onDeleteComment: k2, type: V2 } = n, U2 = useDependency(Ls), b = useDependency(Fn), u2 = useDependency(Rs), v2 = u2.getUser(e.personId), T = useObservable(u2.currentUser$), y2 = (T == null ? void 0 : T.userID) === e.personId, j3 = e.id === Le, [C3, R3] = (0, import_react.useState)(false), d = p5(_e), m = d == null ? void 0 : d.avatarFallback, f2 = () => {
    (k2 == null ? void 0 : k2(e)) !== false && (U2.executeCommand(
      h2 ? te.id : ee.id,
      {
        unitId: t,
        subUnitId: r,
        commentId: e.id
      }
    ), h2 && (N2 == null || N2()));
  };
  return (0, import_jsx_runtime.jsxs)("div", { className: "univer-relative univer-mb-3 univer-pl-[30px]", onMouseLeave: () => R3(false), onMouseEnter: () => R3(true), children: [
    (0, import_jsx_runtime.jsx)(
      "div",
      {
        className: "univer-absolute univer-left-0 univer-top-0 univer-h-6 univer-w-6 univer-rounded-full univer-bg-cover univer-bg-center univer-bg-no-repeat",
        style: {
          backgroundImage: `url(${(v2 == null ? void 0 : v2.avatar) || m})`
        }
      }
    ),
    v2 ? (0, import_jsx_runtime.jsxs)("div", { className: "univer-mb-1 univer-flex univer-h-6 univer-items-center univer-justify-between", children: [
      (0, import_jsx_runtime.jsx)("div", { className: "univer-text-sm univer-font-medium univer-leading-5", children: (v2 == null ? void 0 : v2.name) || " " }),
      (0, import_jsx_runtime.jsxs)("div", { children: [
        j3 || x2 ? null : C3 && v2 ? (0, import_jsx_runtime.jsx)(
          "div",
          {
            className: "univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-sm univer-text-base hover:univer-bg-gray-50",
            onClick: () => c(v2),
            children: (0, import_jsx_runtime.jsx)(Ee, {})
          }
        ) : null,
        y2 && !j3 && !x2 ? (0, import_jsx_runtime.jsx)(
          vf,
          {
            overlay: (0, import_jsx_runtime.jsx)("div", { className: "univer-rounded-lg", children: (0, import_jsx_runtime.jsxs)(
              "ul",
              {
                className: "univer-m-0 univer-box-border univer-grid univer-list-none univer-p-1.5 univer-text-sm [&_a]:univer-block [&_a]:univer-cursor-pointer [&_a]:univer-rounded [&_a]:univer-px-2 [&_a]:univer-py-1.5 [&_a]:univer-transition-colors",
                children: [
                  (0, import_jsx_runtime.jsx)("li", { children: (0, import_jsx_runtime.jsx)(
                    "a",
                    {
                      className: "hover:univer-bg-gray-200",
                      onClick: () => o == null ? void 0 : o(true),
                      children: b.t("threadCommentUI.item.edit")
                    }
                  ) }),
                  (0, import_jsx_runtime.jsx)("li", { children: (0, import_jsx_runtime.jsx)(
                    "a",
                    {
                      className: "hover:univer-bg-gray-200",
                      onClick: f2,
                      children: b.t("threadCommentUI.item.delete")
                    }
                  ) })
                ]
              }
            ) }),
            children: (0, import_jsx_runtime.jsx)(
              "div",
              {
                className: "univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-sm univer-text-base hover:univer-bg-gray-50",
                children: (0, import_jsx_runtime.jsx)(De2, {})
              }
            )
          }
        ) : null
      ] })
    ] }) : null,
    (0, import_jsx_runtime.jsx)(
      "time",
      {
        className: "univer-mb-1 univer-text-xs/normal univer-text-gray-600 dark:!univer-text-gray-200",
        children: e.dT
      }
    ),
    i2 ? (0, import_jsx_runtime.jsx)(
      Oe,
      {
        type: V2,
        id: e.id,
        comment: e,
        onCancel: () => o == null ? void 0 : o(false),
        autoFocus: true,
        unitId: t,
        subUnitId: r,
        onSave: ({ text: w2, attachments: p2 }) => {
          o == null || o(false), U2.executeCommand(
            X.id,
            {
              unitId: t,
              subUnitId: r,
              payload: {
                commentId: e.id,
                text: w2,
                attachments: p2
              }
            }
          );
        }
      }
    ) : (0, import_jsx_runtime.jsx)(
      "div",
      {
        className: "univer-text-sm univer-text-gray-900 dark:!univer-text-white",
        children: Lt(e.text).map((w2, p2) => (0, import_jsx_runtime.jsx)("div", { className: "univer-break-words", children: w2.map((s, _3) => {
          switch (s.type) {
            case "mention":
              return (0, import_jsx_runtime.jsxs)("a", { className: "univer-text-primary-600", children: [
                s.content.label,
                " "
              ] }, _3);
            default:
              return s.content;
          }
        }) }, p2))
      }
    )
  ] });
};
var jt = (n) => {
  var se3, Q3, a;
  const {
    id: e,
    unitId: t,
    subUnitId: r,
    refStr: i2,
    showEdit: o = true,
    onClick: c,
    showHighlight: x2,
    onClose: h2,
    getSubUnitName: N2,
    prefix: k2,
    autoFocus: V2,
    onMouseEnter: U2,
    onMouseLeave: b,
    onAddComment: u2,
    onDeleteComment: v2,
    onResolve: T,
    type: y2,
    style: j3,
    full: C3
  } = n, R3 = useDependency(i), [d, m] = (0, import_react.useState)(false), [f2, w2] = (0, import_react.useState)(""), p2 = (0, import_react.useMemo)(() => R3.commentUpdate$.pipe(debounceTime(16)), [R3]);
  useObservable(p2);
  const s = e ? R3.getCommentWithChildren(t, r, e) : null, _3 = useDependency(Ls), A4 = useDependency(Rs), D2 = s == null ? void 0 : s.root.resolved, E2 = useObservable(A4.currentUser$), L3 = (0, import_react.useRef)(null), q = [
    ...s ? [s.root] : (
      // mock empty comment
      [{
        id: Le,
        text: {
          dataStream: `
\r`
        },
        personId: (se3 = E2 == null ? void 0 : E2.userID) != null ? se3 : "",
        ref: i2 != null ? i2 : "",
        dT: "",
        unitId: t,
        subUnitId: r,
        threadId: ""
      }]
    ),
    ...(Q3 = s == null ? void 0 : s.children) != null ? Q3 : []
  ], O = (0, import_react.useRef)(null), ne3 = (g) => {
    g.stopPropagation(), D2 ? _3.executeCommand(F.id, {
      unitId: t,
      subUnitId: r,
      commentId: e
    }) : _3.executeCommand(F.id), _3.executeCommand(Z.id, {
      unitId: t,
      subUnitId: r,
      commentId: e,
      resolved: !D2
    }), T == null || T(!D2);
  }, J3 = (g) => {
    g.stopPropagation(), _3.executeCommand(F.id), !(s != null && s.root && (v2 == null ? void 0 : v2(s.root)) === false) && (_3.executeCommand(
      te.id,
      {
        unitId: t,
        subUnitId: r,
        commentId: e
      }
    ), h2 == null || h2());
  };
  (0, import_react.useEffect)(() => b == null ? void 0 : b(), []);
  const re3 = N2((a = s == null ? void 0 : s.root.subUnitId) != null ? a : r), ie3 = o && !f2 && !D2, oe3 = `${i2 || (s == null ? void 0 : s.root.ref) || ""}${re3 ? " Â· " : ""}${re3}`;
  return (0, import_jsx_runtime.jsxs)(
    "div",
    {
      id: `${k2}-${t}-${r}-${e}`,
      className: ie("univer-relative univer-box-border univer-rounded-md univer-bg-white univer-p-4 dark:!univer-bg-gray-900 dark:!univer-text-white", kt2, {
        "univer-w-[278px]": !C3,
        "univer-w-full": C3,
        "univer-shadow": !D2 && (x2 || d || k2 === "cell")
      }),
      style: j3,
      onClick: c,
      onMouseEnter: () => {
        U2 == null || U2(), m(true);
      },
      onMouseLeave: () => {
        b == null || b(), m(false);
      },
      children: [
        !D2 && x2 && (0, import_jsx_runtime.jsx)(
          "div",
          {
            className: "univer-absolute univer-left-0 univer-right-0 univer-top-0 univer-h-1.5 univer-rounded-t-md univer-bg-yellow-400"
          }
        ),
        (0, import_jsx_runtime.jsxs)(
          "div",
          {
            className: "univer-mb-4 univer-flex univer-flex-row univer-items-center univer-justify-between univer-text-sm univer-leading-5",
            children: [
              (0, import_jsx_runtime.jsxs)("div", { className: "univer-flex univer-flex-1 univer-flex-row univer-items-center univer-overflow-hidden", children: [
                (0, import_jsx_runtime.jsx)(
                  "div",
                  {
                    className: "univer-mr-2 univer-h-3.5 univer-w-[3px] univer-flex-shrink-0 univer-flex-grow-0 univer-rounded-sm univer-bg-yellow-500"
                  }
                ),
                (0, import_jsx_runtime.jsx)(Rp, { showIfEllipsis: true, title: oe3, children: (0, import_jsx_runtime.jsx)(
                  "span",
                  {
                    className: "univer-flex-1 univer-truncate",
                    children: oe3
                  }
                ) })
              ] }),
              !!s && (0, import_jsx_runtime.jsxs)("div", { className: "univer-flex univer-flex-shrink-0 univer-flex-grow-0 univer-flex-row", children: [
                (0, import_jsx_runtime.jsx)(
                  "div",
                  {
                    className: ie("univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-[3px] univer-text-base hover:univer-bg-gray-50 dark:hover:!univer-bg-gray-800", {
                      "univer-text-green-500": D2
                    }),
                    onClick: ne3,
                    children: D2 ? (0, import_jsx_runtime.jsx)(Me, {}) : (0, import_jsx_runtime.jsx)(Re, {})
                  }
                ),
                (E2 == null ? void 0 : E2.userID) === s.root.personId ? (0, import_jsx_runtime.jsx)(
                  "div",
                  {
                    className: "univer-ml-1 univer-inline-flex univer-h-6 univer-w-6 univer-cursor-pointer univer-items-center univer-justify-center univer-rounded-[3px] univer-text-base hover:univer-bg-gray-50 dark:hover:!univer-bg-gray-800",
                    onClick: J3,
                    children: (0, import_jsx_runtime.jsx)(Ue, {})
                  }
                ) : null
              ] })
            ]
          }
        ),
        (0, import_jsx_runtime.jsx)(
          "div",
          {
            ref: O,
            className: ie("univer-max-h-80 univer-overflow-y-auto univer-overflow-x-hidden", pr),
            children: q.map(
              (g) => (0, import_jsx_runtime.jsx)(
                Vt,
                {
                  unitId: t,
                  subUnitId: r,
                  item: g,
                  isRoot: g.id === (s == null ? void 0 : s.root.id),
                  editing: f2 === g.id,
                  resolved: s == null ? void 0 : s.root.resolved,
                  type: y2,
                  onClose: h2,
                  onEditingChange: (M3) => {
                    w2(M3 ? g.id : "");
                  },
                  onReply: (M3) => {
                    M3 && requestAnimationFrame(() => {
                      var H2;
                      (H2 = L3.current) == null || H2.reply(Ht([
                        {
                          type: "mention",
                          content: {
                            id: M3.userID,
                            label: `@${M3.name}`
                          }
                        },
                        {
                          type: "text",
                          content: " "
                        }
                      ]));
                    });
                  },
                  onAddComment: u2,
                  onDeleteComment: v2
                },
                g.id
              )
            )
          }
        ),
        ie3 && (0, import_jsx_runtime.jsx)("div", { children: (0, import_jsx_runtime.jsx)(
          Oe,
          {
            ref: L3,
            type: y2,
            unitId: t,
            subUnitId: r,
            onSave: async ({ text: g, attachments: M3 }) => {
              const H2 = {
                text: g,
                attachments: M3,
                dT: he(),
                id: et(),
                ref: i2,
                personId: E2 == null ? void 0 : E2.userID,
                parentId: s == null ? void 0 : s.root.id,
                unitId: t,
                subUnitId: r,
                threadId: s == null ? void 0 : s.root.threadId
              };
              (u2 == null ? void 0 : u2(H2)) !== false && (await _3.executeCommand(
                Q.id,
                {
                  unitId: t,
                  subUnitId: r,
                  comment: H2
                }
              ), O.current && (O.current.scrollTop = O.current.scrollHeight));
            },
            autoFocus: V2 || !s,
            onCancel: () => {
              s || h2 == null || h2();
            }
          },
          `${V2}`
        ) })
      ]
    }
  );
};
var Yt = (n) => {
  const {
    unitId: e,
    subUnitId$: t,
    type: r,
    onAdd: i2,
    getSubUnitName: o,
    onResolve: c,
    sortComments: x2,
    onItemLeave: h2,
    onItemEnter: N2,
    disableAdd: k2,
    tempComment: V2,
    onAddComment: U2,
    onDeleteComment: b,
    showComments: u2
  } = n, [v2, T] = (0, import_react.useState)("all"), [y2, j3] = (0, import_react.useState)("all"), C3 = useDependency(Fn), R3 = useDependency(Rs), d = useDependency(i), [m, f2] = (0, import_react.useState)(() => d.getUnit(e)), w2 = useDependency(Y), p2 = useObservable(w2.activeCommentId$), s = useObservable(d.commentUpdate$), _3 = useDependency(Ls), A4 = useObservable(t), D2 = (0, import_react.useRef)(true), E2 = "panel", L3 = useObservable(R3.currentUser$), q = (0, import_react.useMemo)(() => {
    var H2;
    const a = v2 === "all" ? m : (H2 = m.filter(($) => $.subUnitId === A4)) != null ? H2 : [], g = x2 != null ? x2 : ($) => $, M3 = a.map(($) => {
      var B2;
      return { ...$.root, children: (B2 = $.children) != null ? B2 : [], users: $.relativeUsers };
    });
    if (u2) {
      const $ = /* @__PURE__ */ new Map();
      return M3.forEach((B2) => {
        $.set(B2.id, B2);
      }), [...u2, ""].map((B2) => $.get(B2)).filter(Boolean);
    } else
      return g(M3);
  }, [u2, v2, m, x2, A4]), O = (0, import_react.useMemo)(() => [
    ...q.filter((a) => !a.resolved),
    ...q.filter((a) => a.resolved)
  ], [q]), ne3 = (0, import_react.useMemo)(() => y2 === "resolved" ? O.filter((a) => a.resolved) : y2 === "unsolved" ? O.filter((a) => !a.resolved) : y2 === "concern_me" && L3 != null && L3.userID ? O.filter((a) => a == null ? void 0 : a.users.has(L3.userID)) : O, [O, L3 == null ? void 0 : L3.userID, y2]), J3 = V2 ? [V2, ...ne3] : ne3, re3 = J3.filter((a) => !a.resolved), ie3 = J3.filter((a) => a.resolved), oe3 = y2 !== "all" || v2 !== "all", se3 = () => {
    j3("all"), T("all");
  };
  (0, import_react.useEffect)(() => {
    e && f2(
      d.getUnit(e)
    );
  }, [e, d, s]), (0, import_react.useEffect)(() => {
    var $;
    if (!p2)
      return;
    if (!D2.current) {
      D2.current = true;
      return;
    }
    const { unitId: a, subUnitId: g, commentId: M3 } = p2, H2 = `${E2}-${a}-${g}-${M3}`;
    ($ = document.getElementById(H2)) == null || $.scrollIntoView({ block: "center" });
  }, [p2]);
  const Q3 = (a) => (0, import_jsx_runtime.jsx)(
    jt,
    {
      prefix: E2,
      getSubUnitName: o,
      id: a.id,
      unitId: a.unitId,
      subUnitId: a.subUnitId,
      refStr: a.ref,
      type: r,
      showEdit: (p2 == null ? void 0 : p2.commentId) === a.id,
      showHighlight: (p2 == null ? void 0 : p2.commentId) === a.id,
      onClick: () => {
        D2.current = false, a.resolved ? _3.executeCommand(F.id) : _3.executeCommand(
          F.id,
          {
            unitId: a.unitId,
            subUnitId: a.subUnitId,
            commentId: a.id,
            temp: false
          }
        );
      },
      onMouseEnter: () => N2 == null ? void 0 : N2(a),
      onMouseLeave: () => h2 == null ? void 0 : h2(a),
      onAddComment: U2,
      onDeleteComment: b,
      onResolve: (g) => c == null ? void 0 : c(a.id, g)
    },
    a.id
  );
  return (0, import_jsx_runtime.jsxs)("div", { className: "univer-flex univer-min-h-full univer-flex-col univer-pb-3", children: [
    (0, import_jsx_runtime.jsxs)("div", { className: "univer-mt-3 univer-flex univer-flex-row univer-justify-between", children: [
      r === we.UNIVER_SHEET ? (0, import_jsx_runtime.jsx)(
        LE,
        {
          borderless: true,
          value: v2,
          options: [
            {
              value: "current",
              label: C3.t("threadCommentUI.filter.sheet.current")
            },
            {
              value: "all",
              label: C3.t("threadCommentUI.filter.sheet.all")
            }
          ],
          onChange: T
        }
      ) : null,
      (0, import_jsx_runtime.jsx)(
        LE,
        {
          borderless: true,
          value: y2,
          options: [
            {
              value: "all",
              label: C3.t("threadCommentUI.filter.status.all")
            },
            {
              value: "resolved",
              label: C3.t("threadCommentUI.filter.status.resolved")
            },
            {
              value: "unsolved",
              label: C3.t("threadCommentUI.filter.status.unsolved")
            },
            {
              value: "concern_me",
              label: C3.t("threadCommentUI.filter.status.concernMe")
            }
          ],
          onChange: j3
        }
      )
    ] }),
    J3.length === 0 ? (0, import_jsx_runtime.jsxs)(
      "div",
      {
        className: "univer-flex univer-flex-1 univer-flex-col univer-items-center univer-justify-center univer-text-sm univer-text-gray-600 dark:!univer-text-gray-200",
        children: [
          C3.t("threadCommentUI.panel.empty"),
          oe3 ? (0, import_jsx_runtime.jsx)("div", { className: "univer-mt-2 univer-flex univer-flex-row", children: (0, import_jsx_runtime.jsx)(vr2, { onClick: se3, children: C3.t("threadCommentUI.panel.reset") }) }) : k2 ? null : (0, import_jsx_runtime.jsx)("div", { className: "univer-mt-2 univer-flex univer-flex-row", children: (0, import_jsx_runtime.jsxs)(vr2, { onClick: i2, children: [
            (0, import_jsx_runtime.jsx)(Te, { className: "univer-mr-1.5" }),
            C3.t("threadCommentUI.panel.addComment")
          ] }) })
        ]
      }
    ) : (0, import_jsx_runtime.jsxs)("div", { className: "univer-mt-3 univer-flex univer-flex-col univer-gap-3", children: [
      re3.map(Q3),
      ie3.length > 0 && (0, import_jsx_runtime.jsx)("div", { className: "univer-text-xs", children: C3.t("threadCommentUI.panel.solved") }),
      ie3.map(Q3)
    ] })
  ] });
};

// node_modules/@univerjs/sheets-thread-comment-ui/lib/es/index.js
var import_react2 = __toESM(require_react());
var import_jsx_runtime2 = __toESM(require_jsx_runtime());
var Re2 = Object.defineProperty;
var Ue2 = (t, e, r) => e in t ? Re2(t, e, { enumerable: true, configurable: true, writable: true, value: r }) : t[e] = r;
var y = (t, e, r) => Ue2(t, typeof e != "symbol" ? e + "" : e, r);
var Pe = "univer.sheet.thread-comment-modal";
var Te2 = "SHEET_THREAD_COMMENT";
var It2 = Object.getOwnPropertyDescriptor;
var Pt = (t, e, r, n) => {
  for (var o = n > 1 ? void 0 : n ? It2(e, r) : e, i2 = t.length - 1, s; i2 >= 0; i2--)
    (s = t[i2]) && (o = s(o) || o);
  return o;
};
var J2 = (t, e) => (r, n) => e(r, n, t);
var R2 = class extends Ve {
  constructor(e, r, n) {
    super();
    y(this, "_lastPopup", null);
    y(this, "_activePopup");
    y(this, "_activePopup$", new BehaviorSubject(null));
    y(this, "activePopup$", this._activePopup$.asObservable());
    this._canvasPopupManagerService = e, this._zenZoneService = r, this._cellPopupManagerService = n, this._initZenVisible(), this.disposeWithMe(() => {
      this._activePopup$.complete();
    });
  }
  get activePopup() {
    return this._activePopup;
  }
  _initZenVisible() {
    this.disposeWithMe(this._zenZoneService.visible$.subscribe((e) => {
      e && this.hidePopup();
    }));
  }
  dispose() {
    super.dispose(), this.hidePopup();
  }
  showPopup(e, r) {
    var h2;
    const { row: n, col: o, unitId: i2, subUnitId: s } = e;
    if (this._activePopup && n === this._activePopup.row && o === this._activePopup.col && i2 === this._activePopup.unitId && s === ((h2 = this.activePopup) == null ? void 0 : h2.subUnitId)) {
      this._activePopup = e, this._activePopup$.next(e);
      return;
    }
    if (this._lastPopup && this._lastPopup.dispose(), this._zenZoneService.visible)
      return;
    this._activePopup = e, this._activePopup$.next(e);
    const a = this._cellPopupManagerService.showPopup(
      {
        row: n,
        col: o,
        unitId: i2,
        subUnitId: s
      },
      {
        componentKey: Pe,
        onClickOutside: () => {
          this.hidePopup();
        },
        direction: "horizontal",
        excludeOutside: [
          ...Array.from(document.querySelectorAll(".univer-thread-comment")),
          document.getElementById("thread-comment-add")
        ].filter(Boolean),
        priority: 2
      }
    );
    if (!a)
      throw new Error("[SheetsThreadCommentPopupService]: cannot show popup!");
    const c = new ao();
    c.add(a), c.add({
      dispose: () => {
        r == null || r();
      }
    }), this._lastPopup = c;
  }
  hidePopup() {
    this._activePopup && (this._lastPopup && this._lastPopup.dispose(), this._lastPopup = null, this._activePopup = null, this._activePopup$.next(null));
  }
  persistPopup() {
    !this._activePopup || !this._activePopup.temp || (this._activePopup = {
      ...this._activePopup,
      temp: false
    }, this._activePopup$.next(this._activePopup));
  }
};
R2 = Pt([
  J2(0, Inject(yi)),
  J2(1, st),
  J2(2, Inject(Mi))
], R2);
var A2 = {
  type: Ms.OPERATION,
  id: "sheets.operation.show-comment-modal",
  handler(t) {
    var _3;
    const e = t.get(z2), r = t.get(vr), n = t.get(R2), o = t.get(Y), i2 = (_3 = e.getCurrentLastSelection()) == null ? void 0 : _3.primary, s = t.get(C2);
    if (!i2)
      return false;
    const a = P(r);
    if (!a)
      return false;
    const { workbook: c, worksheet: h2, unitId: d, subUnitId: m } = a, C3 = {
      workbook: c,
      worksheet: h2,
      unitId: d,
      subUnitId: m,
      row: i2.startRow,
      col: i2.startColumn
    };
    n.showPopup(C3);
    const l3 = s.getByLocation(d, m, i2.startRow, i2.startColumn);
    return l3 && o.setActiveComment({
      unitId: d,
      subUnitId: m,
      commentId: l3,
      trigger: "context-menu"
    }), true;
  }
};
var Tt2 = "sheets-thread-comment.config";
var me3 = {};
var wt2 = Object.getOwnPropertyDescriptor;
var Mt2 = (t, e, r, n) => {
  for (var o = n > 1 ? void 0 : n ? wt2(e, r) : e, i2 = t.length - 1, s; i2 >= 0; i2--)
    (s = t[i2]) && (o = s(o) || o);
  return o;
};
var V = (t, e) => (r, n) => e(r, n, t);
var H = class extends Ve {
  constructor(t, e, r, n) {
    super(), this._sheetInterceptorService = t, this._sheetsThreadCommentModel = e, this._univerInstanceService = r, this._renderManagerService = n, this._initViewModelIntercept(), this._initSkeletonChange();
  }
  _initViewModelIntercept() {
    this.disposeWithMe(
      this._sheetInterceptorService.intercept(
        ht.CELL_CONTENT,
        {
          effect: sr.Style,
          handler: (t, e, r) => {
            const { row: n, col: o, unitId: i2, subUnitId: s } = e;
            return this._sheetsThreadCommentModel.showCommentMarker(i2, s, n, o) && ((!t || t === e.rawData) && (t = { ...e.rawData }), t.markers = {
              ...t == null ? void 0 : t.markers,
              tr: {
                color: "#FFBD37",
                size: 6
              }
            }), r(t);
          },
          priority: 100
        }
      )
    );
  }
  _initSkeletonChange() {
    const t = () => {
      var o;
      const e = this._univerInstanceService.getCurrentUnitForType(we.UNIVER_SHEET);
      if (!e) return;
      const r = e.getUnitId(), n = this._renderManagerService.getRenderById(r);
      (o = n == null ? void 0 : n.mainComponent) == null || o.makeForceDirty();
    };
    this.disposeWithMe(this._sheetsThreadCommentModel.commentUpdate$.pipe(debounceTime(16)).subscribe(() => {
      t();
    }));
  }
};
H = Mt2([
  V(0, Inject(G)),
  V(1, Inject(C2)),
  V(2, vr),
  V(3, ME)
], H);
var bt2 = Object.getOwnPropertyDescriptor;
var yt2 = (t, e, r, n) => {
  for (var o = n > 1 ? void 0 : n ? bt2(e, r) : e, i2 = t.length - 1, s; i2 >= 0; i2--)
    (s = t[i2]) && (o = s(o) || o);
  return o;
};
var Q2 = (t, e) => (r, n) => e(r, n, t);
var Et2 = (t, e, r) => {
  const n = fs(t), o = r.row - e.row, i2 = r.column - e.column, s = {
    startColumn: n.column + i2,
    startRow: n.row + o,
    endColumn: n.column + i2,
    endRow: n.row + o
  };
  return Ft(s);
};
var L = class extends Ve {
  constructor(e, r, n) {
    super();
    y(this, "_copyInfo");
    this._sheetClipboardService = e, this._sheetsThreadCommentModel = r, this._threadCommentDataSourceService = n, this._initClipboardHook();
  }
  // eslint-disable-next-line max-lines-per-function
  _initClipboardHook() {
    this.disposeWithMe(
      this._sheetClipboardService.addClipboardHook({
        id: Te2,
        onBeforeCopy: (e, r, n) => {
          this._copyInfo = {
            unitId: e,
            subUnitId: r,
            range: n
          };
        },
        // eslint-disable-next-line max-lines-per-function
        onPasteCells: (e, r, n, o) => {
          const { unitId: i2, subUnitId: s, range: a } = r, c = {
            row: a.rows[0],
            column: a.cols[0]
          };
          if (o.copyType === Yn.CUT && this._copyInfo) {
            const { range: h2, unitId: d, subUnitId: m } = this._copyInfo, C3 = {
              row: h2.startRow,
              column: h2.startColumn
            };
            if (!(i2 === d && s === m)) {
              const l3 = [];
              Or.foreach(h2, (g, u2) => {
                const I5 = this._sheetsThreadCommentModel.getAllByLocation(d, m, g, u2);
                this._threadCommentDataSourceService.syncUpdateMutationToColla ? I5.forEach((v2) => {
                  l3.push(v2);
                }) : I5.forEach(({ children: v2, ...T }) => {
                  T.parentId || l3.push(T);
                });
              });
              const _3 = [], f2 = [], U2 = [], k2 = [], Y2 = (g) => {
                _3.unshift({
                  id: E.id,
                  params: {
                    unitId: d,
                    subUnitId: m,
                    commentId: g.id
                  }
                }), U2.push({
                  id: R.id,
                  params: {
                    unitId: i2,
                    subUnitId: s,
                    comment: {
                      ...g,
                      ref: Et2(g.ref, C3, c),
                      unitId: i2,
                      subUnitId: s
                    },
                    sync: true
                  }
                }), f2.push({
                  id: R.id,
                  params: {
                    unitId: d,
                    subUnitId: m,
                    comment: g,
                    sync: true
                  }
                }), k2.unshift({
                  id: E.id,
                  params: {
                    unitId: i2,
                    subUnitId: s,
                    commentId: g.id
                  }
                });
              };
              return l3.forEach((g) => {
                Y2(g);
              }), {
                redos: [..._3, ...U2],
                undos: [...k2, ...f2]
              };
            }
          }
          return {
            redos: [],
            undos: []
          };
        }
      })
    );
  }
};
L = yt2([
  Q2(0, Inject(nn)),
  Q2(1, Inject(C2)),
  Q2(2, p)
], L);
var Rt2 = Object.getOwnPropertyDescriptor;
var Ut2 = (t, e, r, n) => {
  for (var o = n > 1 ? void 0 : n ? Rt2(e, r) : e, i2 = t.length - 1, s; i2 >= 0; i2--)
    (s = t[i2]) && (o = s(o) || o);
  return o;
};
var B = (t, e) => (r, n) => e(r, n, t);
var j2 = class extends Ve {
  constructor(t, e, r, n) {
    super(), this._hoverManagerService = t, this._sheetsThreadCommentPopupService = e, this._sheetsThreadCommentModel = r, this._sheetPermissionCheckController = n, this._initHoverEvent();
  }
  _initHoverEvent() {
    this.disposeWithMe(
      this._hoverManagerService.currentCell$.pipe(debounceTime(100)).subscribe((t) => {
        const e = this._sheetsThreadCommentPopupService.activePopup;
        if (t && (e && e.temp || !e)) {
          const { location: r } = t, { unitId: n, subUnitId: o, row: i2, col: s } = r, a = this._sheetsThreadCommentModel.getByLocation(n, o, i2, s);
          if (a) {
            if (!this._sheetPermissionCheckController.permissionCheckWithRanges({
              workbookTypes: [nr],
              worksheetTypes: [ls],
              rangeTypes: [Hs]
            }, [{ startRow: i2, startColumn: s, endRow: i2, endColumn: s }]))
              return;
            const h2 = this._sheetsThreadCommentModel.getComment(n, o, a);
            h2 && !h2.resolved && this._sheetsThreadCommentPopupService.showPopup({
              unitId: n,
              subUnitId: o,
              row: i2,
              col: s,
              commentId: a,
              temp: true
            });
          } else
            e && this._sheetsThreadCommentPopupService.hidePopup();
        }
      })
    );
  }
};
j2 = Ut2([
  B(0, Inject(Mr)),
  B(1, Inject(R2)),
  B(2, Inject(C2)),
  B(3, Inject(qn))
], j2);
var $t2 = Object.getOwnPropertyDescriptor;
var Ot2 = (t, e, r, n) => {
  for (var o = n > 1 ? void 0 : n ? $t2(e, r) : e, i2 = t.length - 1, s; i2 >= 0; i2--)
    (s = t[i2]) && (o = s(o) || o);
  return o;
};
var w = (t, e) => (r, n) => e(r, n, t);
var F2 = class extends Ve {
  constructor(e, r, n, o, i2, s, a, c, h2, d) {
    super();
    y(this, "_isSwitchToCommenting", false);
    y(this, "_selectionShapeInfo", null);
    this._commandService = e, this._sheetsThreadCommentPopupService = r, this._sheetsThreadCommentModel = n, this._threadCommentPanelService = o, this._univerInstanceService = i2, this._sheetPermissionCheckController = s, this._markSelectionService = a, this._sheetSelectionService = c, this._editorBridgeService = h2, this._renderManagerService = d, this._initCommandListener(), this._initPanelListener(), this._initMarkSelection(), this._initSelectionUpdateListener(), this._initEditorBridge();
  }
  _handleSelectionChange(e, r, n) {
    var C3, l3, _3;
    const o = (C3 = e[0]) == null ? void 0 : C3.range, i2 = this._renderManagerService.getRenderById(r), s = (l3 = i2 == null ? void 0 : i2.with(ue).getSkeletonParam(n)) == null ? void 0 : l3.skeleton;
    if (!s || !o)
      return;
    const a = s.getCellWithCoordByIndex(o.startRow, o.startColumn);
    if ((((_3 = o.rangeType) != null ? _3 : ge.NORMAL) !== ge.NORMAL || o.endColumn - o.startColumn > 0 || o.endRow - o.startRow > 0) && !((a.isMerged || a.isMergedMainCell) && En.equals(a.mergeInfo, o))) {
      this._threadCommentPanelService.activeCommentId && this._commandService.executeCommand(F.id);
      return;
    }
    const h2 = a.actualRow, d = a.actualColumn;
    if (!this._sheetsThreadCommentModel.showCommentMarker(r, n, h2, d)) {
      this._threadCommentPanelService.activeCommentId && this._commandService.executeCommand(F.id);
      return;
    }
    const m = this._sheetsThreadCommentModel.getByLocation(r, n, h2, d);
    m && this._commandService.executeCommand(F.id, {
      unitId: r,
      subUnitId: n,
      commentId: m
    });
  }
  _initSelectionUpdateListener() {
    this.disposeWithMe(
      this._sheetSelectionService.selectionMoveEnd$.subscribe((e) => {
        if (this._isSwitchToCommenting)
          return;
        const r = this._sheetSelectionService.currentSelectionParam;
        r && this._handleSelectionChange(e, r.unitId, r.sheetId);
      })
    );
  }
  _initEditorBridge() {
    this.disposeWithMe(
      this._editorBridgeService.visible$.subscribe((e) => {
        e.visible && this._sheetsThreadCommentPopupService.hidePopup();
      })
    );
  }
  _initCommandListener() {
    this._commandService.onCommandExecuted((e) => {
      if (e.id === E.id) {
        const r = e.params, n = this._sheetsThreadCommentPopupService.activePopup;
        if (!n)
          return;
        const { unitId: o, subUnitId: i2, commentId: s } = n;
        r.unitId === o && r.subUnitId === i2 && r.commentId === s && this._sheetsThreadCommentPopupService.hidePopup();
      }
    });
  }
  _initPanelListener() {
    this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.subscribe(async (e) => {
      var r;
      if (e) {
        const { unitId: n, subUnitId: o, commentId: i2, trigger: s } = e, a = this._sheetsThreadCommentModel.getComment(n, o, i2);
        if (!a || a.resolved)
          return;
        const c = this._univerInstanceService.getCurrentUnitForType(we.UNIVER_SHEET);
        if (!c || c.getUnitId() !== n)
          return;
        this._isSwitchToCommenting = true, ((r = c.getActiveSheet()) == null ? void 0 : r.getSheetId()) !== o && await this._commandService.executeCommand(pn2.id, {
          unitId: n,
          subUnitId: o
        }), this._isSwitchToCommenting = false;
        const m = fs(a.ref), { row: C3, column: l3 } = m;
        if (!this._sheetPermissionCheckController.permissionCheckWithRanges({
          workbookTypes: [nr],
          worksheetTypes: [ls],
          rangeTypes: [Hs]
        }, [{ startRow: C3, startColumn: l3, endRow: C3, endColumn: l3 }]))
          return;
        const f2 = 1;
        if (await this._commandService.executeCommand($d.id, {
          range: {
            startRow: Math.max(m.row - f2, 0),
            endRow: m.row + f2,
            startColumn: Math.max(m.column - f2, 0),
            endColumn: m.column + f2
          }
        }), this._editorBridgeService.isVisible().visible)
          return;
        this._sheetsThreadCommentPopupService.showPopup({
          unitId: n,
          subUnitId: o,
          row: m.row,
          col: m.column,
          commentId: a.id,
          trigger: s
        });
      } else
        this._sheetsThreadCommentPopupService.hidePopup();
    }));
  }
  _initMarkSelection() {
    this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.pipe(debounceTime(100)).subscribe((e) => {
      var C3, l3;
      if (!e) {
        this._selectionShapeInfo && (this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId), this._selectionShapeInfo = null);
        return;
      }
      const { unitId: r, subUnitId: n, commentId: o } = e;
      this._selectionShapeInfo && (this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId), this._selectionShapeInfo = null);
      const i2 = this._sheetsThreadCommentModel.getComment(r, n, o);
      if (!i2)
        return;
      const s = fs(i2.ref), { row: a, column: c } = s;
      if (Number.isNaN(a) || Number.isNaN(c))
        return null;
      const h2 = (C3 = this._univerInstanceService.getCurrentUnitForType(we.UNIVER_SHEET)) == null ? void 0 : C3.getSheetBySheetId(n), d = (l3 = h2 == null ? void 0 : h2.getMergedCell(a, c)) != null ? l3 : {
        startColumn: c,
        endColumn: c,
        startRow: a,
        endRow: a
      }, m = this._markSelectionService.addShape(
        {
          range: d,
          style: {
            // hasAutoFill: false,
            fill: "rgba(255, 189, 55, 0.35)",
            strokeWidth: 1,
            stroke: "#FFBD37",
            widgets: {}
          },
          primary: null
        },
        [],
        -1
      );
      m && (this._selectionShapeInfo = {
        ...e,
        shapeId: m
      });
    }));
  }
};
F2 = Ot2([
  w(0, Ls),
  w(1, Inject(R2)),
  w(2, Inject(C2)),
  w(3, Inject(Y)),
  w(4, vr),
  w(5, Inject(qn)),
  w(6, Wi),
  w(7, Inject(z2)),
  w(8, qe),
  w(9, ME)
], F2);
function we3({ ref: t, ...e }) {
  const { icon: r, id: n, className: o, extend: i2, ...s } = e, a = `univerjs-icon univerjs-icon-${n} ${o || ""}`.trim(), c = (0, import_react2.useRef)(`_${Dt2()}`);
  return Me2(r, `${n}`, {
    defIds: r.defIds,
    idSuffix: c.current
  }, {
    ref: t,
    className: a,
    ...s
  }, i2);
}
function Me2(t, e, r, n, o) {
  return (0, import_react2.createElement)(t.tag, {
    key: e,
    ...kt4(t, r, o),
    ...n
  }, (Nt2(t, r).children || []).map((i2, s) => Me2(i2, `${e}-${t.tag}-${s}`, r, void 0, o)));
}
function kt4(t, e, r) {
  const n = { ...t.attrs };
  r != null && r.colorChannel1 && n.fill === "colorChannel1" && (n.fill = r.colorChannel1), t.tag === "mask" && n.id && (n.id = n.id + e.idSuffix), Object.entries(n).forEach(([i2, s]) => {
    i2 === "mask" && typeof s == "string" && (n[i2] = s.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  });
  const { defIds: o } = e;
  return !o || o.length === 0 || (t.tag === "use" && n["xlink:href"] && (n["xlink:href"] = n["xlink:href"] + e.idSuffix), Object.entries(n).forEach(([i2, s]) => {
    typeof s == "string" && (n[i2] = s.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  })), n;
}
function Nt2(t, e) {
  var n;
  const { defIds: r } = e;
  return !r || r.length === 0 ? t : t.tag === "defs" && ((n = t.children) != null && n.length) ? {
    ...t,
    children: t.children.map((o) => typeof o.attrs.id == "string" && r && r.includes(o.attrs.id) ? {
      ...o,
      attrs: {
        ...o.attrs,
        id: o.attrs.id + e.idSuffix
      }
    } : o)
  } : t;
}
function Dt2() {
  return Math.random().toString(36).substring(2, 8);
}
we3.displayName = "UniverIcon";
var xt3 = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 17 17",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521C5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345ZM8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521C8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345ZM11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521C11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345Z",
        fillRule: "evenodd",
        clipRule: "evenodd"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521C5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521C8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521C11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M1.84351 3.41861C1.84351 3.01861 2.15531 2.69434 2.53993 2.69434H14.9381C15.3228 2.69434 15.6346 3.01861 15.6346 3.41861V12.4611C15.6346 12.8612 15.3228 13.1854 14.9381 13.1854H8.82117L6.06643 14.6179C5.85054 14.7301 5.59416 14.7181 5.38884 14.5862C5.18352 14.4542 5.05855 14.2211 5.05855 13.9701V13.1854H2.53993C2.15531 13.1854 1.84351 12.8612 1.84351 12.4611L1.84351 3.41861ZM6.45141 12.7982L8.34531 12.0135C8.44201 11.9632 8.54864 11.9371 8.65676 11.9371H14.2417C14.3522 11.9371 14.4417 11.8475 14.4417 11.7371V4.14271C14.4417 4.03225 14.3522 3.94271 14.2417 3.94271H3.23636C3.12591 3.94271 3.03636 4.03225 3.03636 4.14271L3.03636 11.7371C3.03636 11.8475 3.12591 11.9371 3.23636 11.9371L5.75498 11.9371C6.1396 11.9371 6.45141 12.0611 6.45141 12.4611V12.7982Z",
        fillRule: "evenodd",
        clipRule: "evenodd"
      }
    }
  ]
};
var be2 = (0, import_react2.forwardRef)(function(e, r) {
  return (0, import_react2.createElement)(we3, Object.assign({}, e, {
    id: "comment-icon",
    ref: r,
    icon: xt3
  }));
});
be2.displayName = "CommentIcon";
var At = () => {
  const t = useDependency(vr), e = useDependency(R2), r = useObservable(e.activePopup$), n = useDependency(C2);
  if (useObservable(n.commentUpdate$), !r)
    return null;
  const { row: o, col: i2, unitId: s, subUnitId: a, trigger: c } = r, h2 = n.getByLocation(s, a, o, i2), d = `${J.chatAtABC(i2)}${o + 1}`, m = () => {
    e.hidePopup();
  }, C3 = (l3) => {
    var _3, f2, U2;
    return (U2 = (f2 = (_3 = t.getCurrentUnitForType(we.UNIVER_SHEET)) == null ? void 0 : _3.getSheetBySheetId(l3)) == null ? void 0 : f2.getName()) != null ? U2 : "";
  };
  return (0, import_jsx_runtime2.jsx)(
    jt,
    {
      onClick: () => {
        e.persistPopup();
      },
      prefix: "cell",
      id: h2,
      unitId: s,
      subUnitId: a,
      type: we.UNIVER_SHEET,
      refStr: d,
      onClose: m,
      getSubUnitName: C3,
      autoFocus: c === "context-menu"
    }
  );
};
var Vt2 = () => {
  var g;
  const t = useDependency(Wi), e = useDependency(vr), r = useDependency(R2), n = e.getCurrentUnitForType(we.UNIVER_SHEET), o = n.getUnitId(), i2 = useDependency(Ls), s = (0, import_react2.useMemo)(() => n.activeSheet$.pipe(map((u2) => u2 == null ? void 0 : u2.getSheetId())), [n.activeSheet$]), a = useObservable(s, (g = n.getActiveSheet()) == null ? void 0 : g.getSheetId()), c = (0, import_react2.useRef)(null), h2 = useDependency(Y), d = useObservable(h2.activeCommentId$), m = useObservable(h2.panelVisible$, h2.panelVisible), C3 = (0, import_react2.useCallback)((u2) => {
    const I5 = n.getSheets(), v2 = {};
    I5.forEach((P4, S3) => {
      v2[P4.getSheetId()] = S3;
    });
    const T = (P4) => P4.map((S3) => {
      var ie3;
      const b = fs(S3.ref), Ee2 = [(ie3 = v2[S3.subUnitId]) != null ? ie3 : 0, b.row, b.column];
      return { ...S3, p: Ee2 };
    }).sort((S3, b) => S3.p[0] === b.p[0] ? S3.p[1] === b.p[1] ? S3.p[2] - b.p[2] : S3.p[1] - b.p[1] : S3.p[0] - b.p[0]);
    return [
      ...T(u2.filter((P4) => !P4.resolved)),
      ...T(u2.filter((P4) => P4.resolved))
    ];
  }, [n]), l3 = (0, import_react2.useCallback)((u2) => {
    var I5;
    if (u2.unitId === o && u2.subUnitId === a && !u2.resolved) {
      const { row: v2, column: T } = fs(u2.ref), P4 = n.getSheetBySheetId(u2.subUnitId), S3 = (I5 = P4 == null ? void 0 : P4.getMergedCell(v2, T)) != null ? I5 : {
        startColumn: T,
        endColumn: T,
        startRow: v2,
        endRow: v2
      };
      if (!Number.isNaN(v2) && !Number.isNaN(T))
        return t.addShape({
          range: S3,
          style: {
            // hasAutoFill: false,
            fill: "rgb(255, 189, 55, 0.35)",
            strokeWidth: 1,
            stroke: "#FFBD37",
            widgets: {}
          },
          primary: null
        });
    }
    return null;
  }, [t, a, o]), _3 = (u2) => {
    var I5, v2;
    return (v2 = (I5 = n.getSheetBySheetId(u2)) == null ? void 0 : I5.getName()) != null ? v2 : "";
  }, f2 = () => {
    i2.executeCommand(A2.id);
  }, U2 = (u2) => {
    d && d.unitId === u2.unitId && d.subUnitId === u2.subUnitId && d.commentId === u2.id || (c.current && (t.removeShape(c.current), c.current = null), c.current = l3(u2));
  }, k2 = () => {
    c.current && (t.removeShape(c.current), c.current = null);
  }, Y2 = (u2, I5) => {
    I5 && r.hidePopup();
  };
  return (0, import_react2.useEffect)(() => {
    !m && c.current && t.removeShape(c.current);
  }, [t, m]), (0, import_jsx_runtime2.jsx)(
    Yt,
    {
      unitId: o,
      subUnitId$: s,
      type: we.UNIVER_SHEET,
      onAdd: f2,
      getSubUnitName: _3,
      onResolve: Y2,
      sortComments: C3,
      onItemEnter: U2,
      onItemLeave: k2,
      onDeleteComment: () => (k2(), true)
    }
  );
};
var Bt = (t) => ({
  id: A2.id,
  type: H1.BUTTON,
  icon: "CommentIcon",
  title: "sheetThreadComment.menu.addComment",
  hidden$: Bi(t, we.UNIVER_SHEET),
  disabled$: he2(t, {
    workbookTypes: [nr],
    worksheetTypes: [ls],
    rangeTypes: [Hs]
  })
});
var Ht2 = (t) => ({
  id: xt2.id,
  type: H1.BUTTON,
  icon: "CommentIcon",
  tooltip: "sheetThreadComment.menu.commentManagement",
  disabled$: he2(t, {
    workbookTypes: [nr],
    worksheetTypes: [ls],
    rangeTypes: [Hs]
  }),
  hidden$: Bi(t, we.UNIVER_SHEET)
});
var Lt2 = {
  id: A2.id,
  binding: q1.M | L1.CTRL_COMMAND | L1.ALT,
  preconditions: Ve2
};
var jt2 = {
  [De.MEDIA]: {
    [xt2.id]: {
      order: 2,
      menuItemFactory: Ht2
    }
  },
  [Y1.MAIN_AREA]: {
    [a1.OTHERS]: {
      [A2.id]: {
        order: 0,
        menuItemFactory: Bt
      }
    }
  }
};
var Ft2 = Object.getOwnPropertyDescriptor;
var Wt = (t, e, r, n) => {
  for (var o = n > 1 ? void 0 : n ? Ft2(e, r) : e, i2 = t.length - 1, s; i2 >= 0; i2--)
    (s = t[i2]) && (o = s(o) || o);
  return o;
};
var X3 = (t, e) => (r, n) => e(r, n, t);
var W3 = class extends Ve {
  constructor(t, e, r) {
    super(), this._menuManagerService = t, this._componentManager = e, this._shortcutService = r, this._initMenu(), this._initShortcut(), this._initComponent();
  }
  _initShortcut() {
    this._shortcutService.registerShortcut(Lt2);
  }
  _initMenu() {
    this._menuManagerService.mergeMenu(jt2);
  }
  _initComponent() {
    [
      [Pe, At],
      [gt, Vt2],
      ["CommentIcon", be2]
    ].forEach(([t, e]) => {
      this.disposeWithMe(
        this._componentManager.register(t, e)
      );
    });
  }
};
W3 = Wt([
  X3(0, B1),
  X3(1, Inject(S1)),
  X3(2, ye)
], W3);
var Zt = Object.defineProperty;
var Gt = Object.getOwnPropertyDescriptor;
var zt = (t, e, r) => e in t ? Zt(t, e, { enumerable: true, configurable: true, writable: true, value: r }) : t[e] = r;
var Kt = (t, e, r, n) => {
  for (var o = n > 1 ? void 0 : n ? Gt(e, r) : e, i2 = t.length - 1, s; i2 >= 0; i2--)
    (s = t[i2]) && (o = s(o) || o);
  return o;
};
var ee4 = (t, e) => (r, n) => e(r, n, t);
var ye2 = (t, e, r) => zt(t, typeof e != "symbol" ? e + "" : e, r);
var Z3 = class extends Ol {
  constructor(t = me3, e, r, n) {
    super(), this._config = t, this._injector = e, this._commandService = r, this._configService = n;
    const { menu: o, ...i2 } = oo(
      {},
      me3,
      this._config
    );
    o && this._configService.setConfig("menu", o, { merge: true }), this._configService.setConfig(Tt2, i2);
  }
  onStarting() {
    [
      [W3],
      [H],
      [L],
      [j2],
      [F2],
      [R2]
    ].forEach((t) => {
      this._injector.add(t);
    }), [A2].forEach((t) => {
      this._commandService.registerCommand(t);
    }), this._injector.get(W3);
  }
  onReady() {
    this._injector.get(H);
  }
  onRendered() {
    this._injector.get(L), this._injector.get(j2), this._injector.get(F2);
  }
};
ye2(Z3, "pluginName", Te2);
ye2(Z3, "type", we.UNIVER_SHEET);
Z3 = Kt([
  qR(ce2, S2),
  ee4(1, Inject(Injector)),
  ee4(2, Inject(Ls)),
  ee4(3, ic)
], Z3);

// node_modules/@univerjs/sheets-thread-comment/lib/es/facade.js
var L2 = Object.defineProperty;
var N = (i2, e, r) => e in i2 ? L2(i2, e, { enumerable: true, configurable: true, writable: true, value: r }) : i2[e] = r;
var M2 = (i2, e, r) => N(i2, typeof e != "symbol" ? e + "" : e, r);
var Z4 = Object.getOwnPropertyDescriptor;
var ee5 = (i2, e, r, t) => {
  for (var n = t > 1 ? void 0 : t ? Z4(e, r) : e, o = i2.length - 1, s; o >= 0; o--)
    (s = i2[o]) && (n = s(n) || n);
  return n;
};
var _2 = (i2, e) => (r, t) => e(r, t, i2);
var A3 = class _A {
  constructor(e) {
    M2(this, "_comment", {
      id: et(),
      ref: "",
      threadId: "",
      dT: "",
      personId: "",
      text: Pn.newEmptyData().body,
      attachments: [],
      unitId: "",
      subUnitId: ""
    });
    e && (this._comment = e);
  }
  /**
   * Create a new FTheadCommentItem
   * @param {IThreadComment|undefined} comment The comment
   * @returns {FTheadCommentItem} A new instance of FTheadCommentItem
   * @example
   * ```ts
   * const commentBuilder = univerAPI.newTheadComment();
   * console.log(commentBuilder);
   * ```
   */
  static create(e) {
    return new _A(e);
  }
  /**
   * Get the person id of the comment
   * @returns {string} The person id of the comment
   * @example
   * ```ts
   * const commentBuilder = univerAPI.newTheadComment();
   * console.log(commentBuilder.personId);
   * ```
   */
  get personId() {
    return this._comment.personId;
  }
  /**
   * Get the date time of the comment
   * @returns {string} The date time of the comment
   * @example
   * ```ts
   * const commentBuilder = univerAPI.newTheadComment();
   * console.log(commentBuilder.dateTime);
   * ```
   */
  get dateTime() {
    return this._comment.dT;
  }
  /**
   * Get the content of the comment
   * @returns {RichTextValue} The content of the comment
   * @example
   * ```ts
   * const commentBuilder = univerAPI.newTheadComment();
   * console.log(commentBuilder.content);
   * ```
   */
  get content() {
    return dn.createByBody(this._comment.text);
  }
  /**
   * Get the id of the comment
   * @returns {string} The id of the comment
   * @example
   * ```ts
   * const commentBuilder = univerAPI.newTheadComment();
   * console.log(commentBuilder.id);
   * ```
   */
  get id() {
    return this._comment.id;
  }
  /**
   * Get the thread id of the comment
   * @returns {string} The thread id of the comment
   * @example
   * ```ts
   * const commentBuilder = univerAPI.newTheadComment();
   * console.log(commentBuilder.threadId);
   * ```
   */
  get threadId() {
    return this._comment.threadId;
  }
  /**
   * Copy the comment
   * @returns {FTheadCommentBuilder} The comment builder
   * @example
   * ```ts
   * const commentBuilder = univerAPI.newTheadComment();
   * const newCommentBuilder = commentBuilder.copy();
   * console.log(newCommentBuilder);
   * ```
   */
  copy() {
    return U.create(J.deepClone(this._comment));
  }
};
var U = class _U extends A3 {
  static create(e) {
    return new _U(e);
  }
  /**
   * Set the content of the comment
   * @param {IDocumentBody | RichTextValue} content The content of the comment
   * @returns {FTheadCommentBuilder} The comment builder for chaining
   * @example
   * ```ts
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText);
   * console.log(commentBuilder.content);
   *
   * // Add the comment to the cell A1
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const cell = fWorksheet.getRange('A1');
   * const result = await cell.addCommentAsync(commentBuilder);
   * console.log(result);
   * ```
   */
  setContent(e) {
    return e instanceof dn ? this._comment.text = e.getData().body : this._comment.text = e, this;
  }
  /**
   * Set the person id of the comment
   * @param {string} userId The person id of the comment
   * @returns {FTheadCommentBuilder} The comment builder for chaining
   * @example
   * ```ts
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setPersonId('mock-user-id');
   * console.log(commentBuilder.personId);
   *
   * // Add the comment to the cell A1
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const cell = fWorksheet.getRange('A1');
   * const result = await cell.addCommentAsync(commentBuilder);
   * console.log(result);
   * ```
   */
  setPersonId(e) {
    return this._comment.personId = e, this;
  }
  /**
   * Set the date time of the comment
   * @param {Date} date The date time of the comment
   * @returns {FTheadCommentBuilder} The comment builder for chaining
   * @example
   * ```ts
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setDateTime(new Date('2025-02-21 14:22:22'));
   * console.log(commentBuilder.dateTime);
   *
   * // Add the comment to the cell A1
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const cell = fWorksheet.getRange('A1');
   * const result = await cell.addCommentAsync(commentBuilder);
   * console.log(result);
   * ```
   */
  setDateTime(e) {
    return this._comment.dT = he(e), this;
  }
  /**
   * Set the id of the comment
   * @param {string} id The id of the comment
   * @returns {FTheadCommentBuilder} The comment builder for chaining
   * @example
   * ```ts
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setId('mock-comment-id');
   * console.log(commentBuilder.id);
   *
   * // Add the comment to the cell A1
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const cell = fWorksheet.getRange('A1');
   * const result = await cell.addCommentAsync(commentBuilder);
   * console.log(result);
   * ```
   */
  setId(e) {
    return this._comment.id = e, this;
  }
  /**
   * Set the thread id of the comment
   * @param {string} threadId The thread id of the comment
   * @returns {FTheadCommentBuilder} The comment builder
   * @example
   * ```ts
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setThreadId('mock-thread-id');
   * console.log(commentBuilder.threadId);
   *
   * // Add the comment to the cell A1
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const cell = fWorksheet.getRange('A1');
   * const result = await cell.addCommentAsync(commentBuilder);
   * console.log(result);
   * ```
   */
  setThreadId(e) {
    return this._comment.threadId = e, this;
  }
  /**
   * Build the comment
   * @returns {IThreadComment} The comment
   * @example
   * ```ts
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const comment = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setPersonId('mock-user-id')
   *   .setDateTime(new Date('2025-02-21 14:22:22'))
   *   .setId('mock-comment-id')
   *   .setThreadId('mock-thread-id')
   *   .build();
   * console.log(comment);
   * ```
   */
  build() {
    return this._comment;
  }
};
var I4 = class {
  /**
   * @ignore
   */
  constructor(i2, e, r, t, n, o, s) {
    this._thread = i2, this._parent = e, this._injector = r, this._commandService = t, this._univerInstanceService = n, this._threadCommentModel = o, this._userManagerService = s;
  }
  _getRef() {
    var r;
    const i2 = ((r = this._parent) == null ? void 0 : r.ref) || this._thread.ref;
    return Dr(i2).range;
  }
  /**
   * Whether the comment is a root comment
   * @returns {boolean} Whether the comment is a root comment
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const comments = fWorksheet.getComments();
   * comments.forEach((comment) => {
   *   console.log(comment.getIsRoot());
   * });
   * ```
   */
  getIsRoot() {
    return !this._parent;
  }
  /**
   * Get the comment data
   * @returns {IBaseComment} The comment data
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const comments = fWorksheet.getComments();
   * comments.forEach((comment) => {
   *   console.log(comment.getCommentData());
   * });
   * ```
   */
  getCommentData() {
    const { children: i2, ...e } = this._thread;
    return e;
  }
  /**
   * Get the replies of the comment
   * @returns {FThreadComment[]} the replies of the comment
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const comments = fWorksheet.getComments();
   * comments.forEach((comment) => {
   *   if (comment.getIsRoot()) {
   *     const replies = comment.getReplies();
   *     replies.forEach((reply) => {
   *       console.log(reply.getCommentData());
   *     });
   *   }
   * });
   * ```
   */
  getReplies() {
    var r;
    const i2 = this._getRef(), e = this._threadCommentModel.getCommentWithChildren(this._thread.unitId, this._thread.subUnitId, i2.startRow, i2.startColumn);
    return (r = e == null ? void 0 : e.children) == null ? void 0 : r.map((t) => this._injector.createInstance(I4, t));
  }
  /**
   * Get the range of the comment
   * @returns {FRange | null} The range of the comment
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const comments = fWorksheet.getComments();
   * comments.forEach((comment) => {
   *   console.log(comment.getRange().getA1Notation());
   * });
   * ```
   */
  getRange() {
    const i2 = this._univerInstanceService.getUnit(this._thread.unitId, we.UNIVER_SHEET);
    if (!i2)
      return null;
    const e = i2.getSheetBySheetId(this._thread.subUnitId);
    if (!e)
      return null;
    const r = this._getRef();
    return this._injector.createInstance(k, i2, e, r);
  }
  // eslint-disable-next-line
  /**
   * @deprecated use `getRichText` as instead
   */
  getContent() {
    return this._thread.text;
  }
  /**
   * Get the rich text of the comment
   * @returns {RichTextValue} The rich text of the comment
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const comments = fWorksheet.getComments();
   * comments.forEach((comment) => {
   *   console.log(comment.getRichText());
   * });
   * ```
   */
  getRichText() {
    const i2 = this._thread.text;
    return dn.create({ body: i2, documentStyle: {}, id: "d" });
  }
  /**
   * Delete the comment and it's replies
   * @returns {Promise<boolean>} Whether the comment is deleted successfully
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   * const comments = fWorksheet.getComments();
   *
   * // Delete the first comment
   * const result = await comments[0]?.deleteAsync();
   * console.log(result);
   * ```
   */
  deleteAsync() {
    return this._commandService.executeCommand(
      this.getIsRoot() ? te.id : ee.id,
      {
        commentId: this._thread.id,
        unitId: this._thread.unitId,
        subUnitId: this._thread.subUnitId
      }
    );
  }
  // eslint-disable-next-line
  /**
   * @deprecated use `deleteAsync` as instead.
   */
  delete() {
    return this.deleteAsync();
  }
  // eslint-disable-next-line
  /**
   * @deprecated use `updateAsync` as instead
   */
  async update(i2) {
    return this.updateAsync(i2);
  }
  /**
   * Update the comment content
   * @param {IDocumentBody | RichTextValue} content The new content of the comment
   * @returns {Promise<boolean>} Whether the comment is updated successfully
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   *
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setId('mock-comment-id');
   * const cell = fWorksheet.getRange('A1');
   * await cell.addCommentAsync(commentBuilder);
   *
   * // Update the comment after 3 seconds
   * setTimeout(async () => {
   *   const comment = fWorksheet.getCommentById('mock-comment-id');
   *   const newRichText = univerAPI.newRichText().insertText('Hello Univer AI');
   *   const result = await comment.updateAsync(newRichText);
   *   console.log(result);
   * }, 3000);
   * ```
   */
  async updateAsync(i2) {
    const e = i2 instanceof dn ? i2.getData().body : i2, r = he();
    return await this._commandService.executeCommand(
      X.id,
      {
        unitId: this._thread.unitId,
        subUnitId: this._thread.subUnitId,
        payload: {
          commentId: this._thread.id,
          text: e,
          updated: true,
          updateT: r
        }
      }
    );
  }
  // eslint-disable-next-line
  /**
   * @deprecated use `resolveAsync` as instead
   */
  resolve(i2) {
    return this.resolveAsync(i2);
  }
  /**
   * Resolve the comment
   * @param {boolean} resolved Whether the comment is resolved
   * @returns {Promise<boolean>} Set the comment to resolved or not operation result
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   *
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setId('mock-comment-id');
   * const cell = fWorksheet.getRange('A1');
   * await cell.addCommentAsync(commentBuilder);
   *
   * // Resolve the comment after 3 seconds
   * setTimeout(async () => {
   *   const comment = fWorksheet.getCommentById('mock-comment-id');
   *   const result = await comment.resolveAsync(true);
   *   console.log(result);
   * }, 3000);
   * ```
   */
  resolveAsync(i2) {
    return this._commandService.executeCommand(
      Z.id,
      {
        unitId: this._thread.unitId,
        subUnitId: this._thread.subUnitId,
        commentId: this._thread.id,
        resolved: i2 != null ? i2 : !this._thread.resolved
      }
    );
  }
  /**
   * Reply to the comment
   * @param {FTheadCommentBuilder} comment The comment to reply to
   * @returns {Promise<boolean>} Whether the comment is replied successfully
   * @example
   * ```ts
   * const fWorkbook = univerAPI.getActiveWorkbook();
   * const fWorksheet = fWorkbook.getActiveSheet();
   *
   * // Create a new comment
   * const richText = univerAPI.newRichText().insertText('hello univer');
   * const commentBuilder = univerAPI.newTheadComment()
   *   .setContent(richText)
   *   .setId('mock-comment-id');
   * const cell = fWorksheet.getRange('A1');
   * await cell.addCommentAsync(commentBuilder);
   *
   * // Reply to the comment
   * const replyText = univerAPI.newRichText().insertText('Hello Univer AI');
   * const reply = univerAPI.newTheadComment().setContent(replyText);
   * const comment = fWorksheet.getCommentById('mock-comment-id');
   * const result = await comment.replyAsync(reply);
   * console.log(result);
   * ```
   */
  replyAsync(i2) {
    var r;
    const e = i2.build();
    return this._commandService.executeCommand(
      Q.id,
      {
        unitId: this._thread.unitId,
        subUnitId: this._thread.subUnitId,
        comment: {
          id: et(),
          parentId: this._thread.id,
          threadId: this._thread.threadId,
          ref: ((r = this._parent) == null ? void 0 : r.ref) || this._thread.ref,
          unitId: this._thread.unitId,
          subUnitId: this._thread.subUnitId,
          text: e.text,
          attachments: e.attachments,
          dT: e.dT || he(),
          personId: e.personId || this._userManagerService.getCurrentUser().userID
        }
      }
    );
  }
};
I4 = ee5([
  _2(2, Inject(Injector)),
  _2(3, Ls),
  _2(4, vr),
  _2(5, Inject(C2)),
  _2(6, Inject(Rs))
], I4);
var te3 = class extends k {
  getComment() {
    const r = this._injector.get(C2), t = this._workbook.getUnitId(), n = this._worksheet.getSheetId(), o = r.getByLocation(t, n, this._range.startRow, this._range.startColumn);
    if (!o)
      return null;
    const s = r.getComment(t, n, o);
    return s ? this._injector.createInstance(I4, s) : null;
  }
  getComments() {
    const r = this._injector.get(C2), t = this._workbook.getUnitId(), n = this._worksheet.getSheetId(), o = [];
    return Or.foreach(this._range, (s, h2) => {
      const c = r.getByLocation(t, n, s, h2);
      if (c) {
        const m = r.getComment(t, n, c);
        m && o.push(this._injector.createInstance(I4, m));
      }
    }), o;
  }
  addComment(e) {
    var a;
    const r = this._injector, t = (a = this.getComment()) == null ? void 0 : a.getCommentData(), n = r.get(Ls), o = r.get(Rs), s = this._workbook.getUnitId(), h2 = this._worksheet.getSheetId(), c = `${J.chatAtABC(this._range.startColumn)}${this._range.startRow + 1}`, m = o.getCurrentUser(), d = e instanceof U ? e.build() : { text: e };
    return n.executeCommand(Q.id, {
      unitId: s,
      subUnitId: h2,
      comment: {
        text: d.text,
        dT: d.dT || he(),
        attachments: [],
        id: d.id || et(),
        ref: c,
        personId: d.personId || m.userID,
        parentId: t == null ? void 0 : t.id,
        unitId: s,
        subUnitId: h2,
        threadId: (t == null ? void 0 : t.threadId) || et()
      }
    });
  }
  clearComment() {
    var s;
    const e = this._injector, r = (s = this.getComment()) == null ? void 0 : s.getCommentData(), t = e.get(Ls), n = this._workbook.getUnitId(), o = this._worksheet.getSheetId();
    return r ? t.executeCommand(te.id, {
      unitId: n,
      subUnitId: o,
      threadId: r.threadId,
      commentId: r.id
    }) : Promise.resolve(true);
  }
  clearComments() {
    const r = this.getComments().map((t) => t.deleteAsync());
    return Promise.all(r).then(() => true);
  }
  addCommentAsync(e) {
    return this.addComment(e);
  }
  clearCommentAsync() {
    return this.clearComment();
  }
  clearCommentsAsync() {
    return this.clearComments();
  }
};
k.extend(te3);
var ne2 = class extends C {
  /**
   * @ignore
   */
  _initialize() {
    Object.defineProperty(this, "_threadCommentModel", {
      get() {
        return this._injector.get(i);
      }
    });
  }
  getComments() {
    return this._threadCommentModel.getUnit(this._workbook.getUnitId()).map((e) => this._injector.createInstance(I4, e.root));
  }
  clearComments() {
    const r = this.getComments().map((t) => t.deleteAsync());
    return Promise.all(r).then(() => true);
  }
  /**
   * @param callback
   * @deprecated
   */
  onThreadCommentChange(e) {
    return We(this._threadCommentModel.commentUpdate$.pipe(filter((r) => r.unitId === this._workbook.getUnitId())).subscribe(e));
  }
  /**
   * @param callback
   * @deprecated
   */
  onBeforeAddThreadComment(e) {
    return We(this._commandService.beforeCommandExecuted((r, t) => {
      const n = r.params;
      if (r.id === Q.id) {
        if (n.unitId !== this._workbook.getUnitId())
          return;
        if (e(n, t) === false)
          throw new Error("Command is stopped by the hook onBeforeAddThreadComment");
      }
    }));
  }
  /**
   * @param callback
   * @deprecated
   */
  onBeforeUpdateThreadComment(e) {
    return We(this._commandService.beforeCommandExecuted((r, t) => {
      const n = r.params;
      if (r.id === X.id) {
        if (n.unitId !== this._workbook.getUnitId())
          return;
        if (e(n, t) === false)
          throw new Error("Command is stopped by the hook onBeforeUpdateThreadComment");
      }
    }));
  }
  /**
   * @param callback
   * @deprecated
   */
  onBeforeDeleteThreadComment(e) {
    return We(this._commandService.beforeCommandExecuted((r, t) => {
      const n = r.params;
      if (r.id === ee.id || r.id === te.id) {
        if (n.unitId !== this._workbook.getUnitId())
          return;
        if (e(n, t) === false)
          throw new Error("Command is stopped by the hook onBeforeDeleteThreadComment");
      }
    }));
  }
};
C.extend(ne2);
var re2 = class extends S {
  getComments() {
    return this._injector.get(C2).getSubUnitAll(this._workbook.getUnitId(), this._worksheet.getSheetId()).map((t) => this._injector.createInstance(I4, t));
  }
  clearComments() {
    const r = this.getComments().map((t) => t.deleteAsync());
    return Promise.all(r).then(() => true);
  }
  /**
   * Subscribe to comment events.
   * @param callback Callback function, param contains comment info and target cell.
   */
  onCommented(e) {
    return this._injector.get(Ls).onCommandExecuted((t) => {
      if (t.id === Q.id) {
        const n = t.params;
        e(n);
      }
    });
  }
  getCommentById(e) {
    const t = this._injector.get(C2).getComment(this._workbook.getUnitId(), this._worksheet.getSheetId(), e);
    if (t)
      return this._injector.createInstance(I4, t);
  }
};
S.extend(re2);
var l2 = {
  CommentAdded: "CommentAdded",
  BeforeCommentAdd: "BeforeCommentAdd",
  CommentUpdated: "CommentUpdated",
  BeforeCommentUpdate: "BeforeCommentUpdate",
  CommentDeleted: "CommentDeleted",
  BeforeCommentDelete: "BeforeCommentDelete",
  CommentResolved: "CommentResolved",
  BeforeCommentResolve: "BeforeCommentResolve"
};
var oe2 = class extends j {
  get CommentAdded() {
    return l2.CommentAdded;
  }
  get BeforeCommentAdd() {
    return l2.BeforeCommentAdd;
  }
  get CommentUpdated() {
    return l2.CommentUpdated;
  }
  get BeforeCommentUpdate() {
    return l2.BeforeCommentUpdate;
  }
  get CommentDeleted() {
    return l2.CommentDeleted;
  }
  get BeforeCommentDelete() {
    return l2.BeforeCommentDelete;
  }
  get CommentResolved() {
    return l2.CommentResolved;
  }
  get BeforeCommentResolve() {
    return l2.BeforeCommentResolve;
  }
};
j.extend(oe2);
var se2 = class extends I2 {
  // eslint-disable-next-line max-lines-per-function
  _initialize(e) {
    const r = e.get(Ls);
    this.registerEventHandler(
      this.Event.CommentAdded,
      () => r.onCommandExecuted((t) => {
        var d, a, u2, g, C3;
        if (t.id !== Q.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (d = this.getActiveWorkbook) == null ? void 0 : d.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { comment: c } = h2, m = s.getRange(c.ref).getComment();
        m && this.fireEvent(this.Event.CommentAdded, {
          workbook: o,
          worksheet: s,
          row: (u2 = (a = m.getRange()) == null ? void 0 : a.getRow()) != null ? u2 : 0,
          col: (C3 = (g = m.getRange()) == null ? void 0 : g.getColumn()) != null ? C3 : 0,
          comment: m
        });
      })
    ), this.registerEventHandler(
      this.Event.CommentUpdated,
      () => r.onCommandExecuted((t) => {
        var d, a, u2, g, C3;
        if (t.id !== X.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (d = this.getActiveWorkbook) == null ? void 0 : d.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { commentId: c } = h2.payload, m = s.getCommentById(c);
        m && this.fireEvent(this.Event.CommentUpdated, {
          workbook: o,
          worksheet: s,
          row: (u2 = (a = m.getRange()) == null ? void 0 : a.getRow()) != null ? u2 : 0,
          col: (C3 = (g = m.getRange()) == null ? void 0 : g.getColumn()) != null ? C3 : 0,
          comment: m
        });
      })
    ), this.registerEventHandler(
      this.Event.CommentDeleted,
      () => r.onCommandExecuted((t) => {
        var m;
        if (t.id !== ee.id && t.id !== te.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (m = this.getActiveWorkbook) == null ? void 0 : m.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { commentId: c } = h2;
        this.fireEvent(this.Event.CommentDeleted, {
          workbook: o,
          worksheet: s,
          commentId: c
        });
      })
    ), this.registerEventHandler(
      this.Event.CommentResolved,
      () => r.onCommandExecuted((t) => {
        var a, u2, g;
        if (t.id !== Z.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (a = this.getActiveWorkbook) == null ? void 0 : a.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { commentId: c, resolved: m } = h2, d = s.getComments().find((C3) => C3.getCommentData().id === c);
        d && this.fireEvent(this.Event.CommentResolved, {
          workbook: o,
          worksheet: s,
          row: (u2 = d.getRange().getRow()) != null ? u2 : 0,
          col: (g = d.getRange().getColumn()) != null ? g : 0,
          comment: d,
          resolved: m
        });
      })
    ), this.registerEventHandler(
      this.Event.BeforeCommentAdd,
      () => r.beforeCommandExecuted((t) => {
        var a, u2, g;
        if (t.id !== Q.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (a = this.getActiveWorkbook) == null ? void 0 : a.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { comment: c } = h2, m = s.getActiveRange();
        if (!m) return;
        const d = {
          workbook: o,
          worksheet: s,
          row: (u2 = m.getRow()) != null ? u2 : 0,
          col: (g = m.getColumn()) != null ? g : 0,
          comment: A3.create(c)
        };
        if (this.fireEvent(this.Event.BeforeCommentAdd, d), d.cancel)
          throw new KC();
      })
    ), this.registerEventHandler(
      this.Event.BeforeCommentUpdate,
      () => r.beforeCommandExecuted((t) => {
        var a, u2, g, C3, v2;
        if (t.id !== X.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (a = this.getActiveWorkbook) == null ? void 0 : a.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { commentId: c, text: m } = h2.payload, d = s.getCommentById(c);
        if (d) {
          const P4 = {
            workbook: o,
            worksheet: s,
            row: (g = (u2 = d.getRange()) == null ? void 0 : u2.getRow()) != null ? g : 0,
            col: (v2 = (C3 = d.getRange()) == null ? void 0 : C3.getColumn()) != null ? v2 : 0,
            comment: d,
            newContent: dn.createByBody(m)
          };
          if (this.fireEvent(this.Event.BeforeCommentUpdate, P4), P4.cancel)
            throw new KC();
        }
      })
    ), this.registerEventHandler(
      this.Event.BeforeCommentDelete,
      () => r.beforeCommandExecuted((t) => {
        var d, a, u2, g, C3;
        if (t.id !== ee.id && t.id !== te.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (d = this.getActiveWorkbook) == null ? void 0 : d.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { commentId: c } = h2, m = s.getCommentById(c);
        if (m) {
          const v2 = {
            workbook: o,
            worksheet: s,
            row: (u2 = (a = m.getRange()) == null ? void 0 : a.getRow()) != null ? u2 : 0,
            col: (C3 = (g = m.getRange()) == null ? void 0 : g.getColumn()) != null ? C3 : 0,
            comment: m
          };
          if (this.fireEvent(this.Event.BeforeCommentDelete, v2), v2.cancel)
            throw new KC();
        }
      })
    ), this.registerEventHandler(
      this.Event.BeforeCommentResolve,
      () => r.beforeCommandExecuted((t) => {
        var a, u2, g;
        if (t.id !== Z.id) return;
        const n = t.params;
        if (!n) return;
        const o = n.unitId ? this.getUniverSheet(n.unitId) : (a = this.getActiveWorkbook) == null ? void 0 : a.call(this);
        if (!o) return;
        const s = o.getSheetBySheetId(n.subUnitId || n.sheetId) || o.getActiveSheet();
        if (!s) return;
        const h2 = t.params, { commentId: c, resolved: m } = h2, d = s.getComments().find((C3) => C3.getCommentData().id === c);
        if (d) {
          const C3 = {
            workbook: o,
            worksheet: s,
            row: (u2 = d.getRange().getRow()) != null ? u2 : 0,
            col: (g = d.getRange().getColumn()) != null ? g : 0,
            comment: d,
            resolved: m
          };
          if (this.fireEvent(this.Event.BeforeCommentResolve, C3), C3.cancel)
            throw new KC();
        }
      })
    );
  }
  /**
   * @ignore
   */
  newTheadComment(e) {
    return new U(e);
  }
};
I2.extend(se2);

// node_modules/@univerjs/preset-sheets-thread-comment/lib/es/index.js
function h(t = {}) {
  return { plugins: [
    ce2,
    S2,
    Z3
  ] };
}
export {
  Q as AddCommentCommand,
  ee as DeleteCommentCommand,
  te as DeleteCommentTreeCommand,
  p as IThreadCommentDataSourceService,
  Z as ResolveCommentCommand,
  Te2 as SHEETS_THREAD_COMMENT,
  F as SetActiveCommentOperation,
  C2 as SheetsThreadCommentModel,
  R2 as SheetsThreadCommentPopupService,
  M as SheetsThreadCommentRefRangeController,
  A2 as ShowAddSheetCommentModalOperation,
  gt as THREAD_COMMENT_PANEL,
  Yt as ThreadCommentPanel,
  Y as ThreadCommentPanelService,
  jt as ThreadCommentTree,
  xt2 as ToggleSheetCommentPanelOperation,
  S2 as UniverSheetsThreadCommentPlugin,
  h as UniverSheetsThreadCommentPreset,
  Z3 as UniverSheetsThreadCommentUIPlugin,
  ce2 as UniverThreadCommentUIPlugin,
  X as UpdateCommentCommand
};
//# sourceMappingURL=@univerjs_presets_preset-sheets-thread-comment.js.map
