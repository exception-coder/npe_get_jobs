import {
  F
} from "./chunk-ZKTLMAEM.js";
import {
  Ct,
  D,
  E,
  It,
  Mt,
  N,
  R,
  Rt,
  St,
  de,
  te,
  ve,
  wt
} from "./chunk-P747PEZ4.js";
import {
  Wr
} from "./chunk-RWMUFXJB.js";
import {
  $d2 as $d,
  $y,
  B1,
  Bi,
  Bn,
  De,
  H1,
  Hr,
  Jy,
  L1,
  Le as Le2,
  Mr,
  Re,
  S1,
  Ve as Ve3,
  Wi2 as Wi,
  Y1,
  Yn2 as Yn,
  Yy,
  a1,
  et as et2,
  et2 as et3,
  he,
  hl,
  nn,
  nr2 as nr,
  q1,
  qe2 as qe,
  re,
  st,
  ue,
  uo,
  useDependency,
  useObservable,
  wr,
  wr2,
  wt as wt2,
  ye,
  yi2 as yi,
  zy
} from "./chunk-DZMX4FYO.js";
import {
  An,
  Dr,
  Ft,
  G,
  Hc as Hc2,
  Hs,
  Ir,
  Le,
  Ls2,
  ME,
  Nr as Nr2,
  P,
  Pe,
  Ss,
  Ve as Ve2,
  Ws2 as Ws,
  hr,
  ht,
  ie as ie2,
  ku,
  ls,
  m3 as m,
  mr,
  pn2,
  qn,
  qs,
  sr as sr2,
  z
} from "./chunk-I7I3GTAS.js";
import {
  $C,
  LE,
  Rp,
  Vx,
  gE,
  ie,
  kt,
  require_jsx_runtime,
  require_react,
  vr as vr2
} from "./chunk-YFGUMDM2.js";
import {
  BehaviorSubject,
  Dl,
  En,
  Fn,
  Gi,
  Hc,
  Inject,
  Injector,
  J,
  Je,
  Ls,
  Ms,
  Nr,
  Observable,
  Ol,
  Or,
  Subject,
  TC,
  Ul,
  Ve,
  ao,
  bt,
  combineLatest,
  ct,
  debounceTime,
  eC,
  et,
  ge,
  gr,
  ic,
  map,
  of,
  oo,
  pn,
  pt,
  qR,
  sr,
  switchMap,
  vr,
  we,
  z1
} from "./chunk-RGZYGL3P.js";
import {
  __toESM
} from "./chunk-DC5AMYBS.js";

// node_modules/@univerjs/sheets-hyper-link-ui/lib/es/index.js
var import_jsx_runtime = __toESM(require_jsx_runtime());
var import_react = __toESM(require_react());
var qn2 = Object.defineProperty;
var Jn = (t, e, n) => e in t ? qn2(t, e, { enumerable: true, configurable: true, writable: true, value: n }) : t[e] = n;
var A = (t, e, n) => Jn(t, typeof e != "symbol" ? e + "" : e, n);
var m2 = ((t) => (t.EDITING = "editing", t.VIEWING = "viewing", t.ZEN_EDITOR = "zen_mode", t))(m2 || {});
function Ke(t) {
  return J.isLegalUrl(t);
}
function di(t) {
  return /^[a-zA-Z]+:\/\//.test(t);
}
function pi(t) {
  return /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(t);
}
function hi(t) {
  if (Ke(t)) {
    const e = di(t) ? t : pi(t) ? `mailto://${t}` : `http://${t}`;
    let n;
    try {
      n = new URL(e);
    } catch {
      return t;
    }
    return n.hostname === location.hostname && n.port === location.port && n.protocol === location.protocol && n.pathname === location.pathname && n.hash && !n.search ? n.hash : e;
  }
  return t;
}
var Mn = "sheets-hyper-link-ui.config";
var gn = {};
var gi = Object.getOwnPropertyDescriptor;
var mi = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? gi(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var me = (t, e) => (n, i) => e(n, i, t);
function vi(t, e) {
  const n = e.getMergeData(), i = e.getMaxColumns() - 1, r = e.getMaxRows() - 1;
  if (i < t.endColumn && (t.endColumn = i), r < t.endRow && (t.endRow = r), t.rangeType === ge.COLUMN || ge.ROW)
    return t;
  const s = [];
  return n.forEach((o) => {
    En.intersects(t, o) && s.push(o);
  }), En.realUnion(t, ...s);
}
var ce = class {
  constructor(t, e, n, i, r, s) {
    this._univerInstanceService = t, this._commandService = e, this._definedNamesService = n, this._messageService = i, this._localeService = r, this._configService = s;
  }
  navigate(t) {
    switch (t.type) {
      case E.URL:
        this.navigateToOtherWebsite(t.url);
        break;
      default:
        this._navigateToUniver(t.searchObj);
    }
  }
  _navigateToUniver(t) {
    const { gid: e, range: n, rangeid: i } = t, r = this._univerInstanceService.getCurrentUnitForType(we.UNIVER_SHEET);
    if (!r)
      return;
    const s = r.getUnitId();
    if (i) {
      const o = this._definedNamesService.getValueById(s, i);
      if (!o)
        return;
      const { formulaOrRefString: c } = o, u = this._definedNamesService.getWorksheetByRef(s, c);
      if (!u) {
        this._messageService.show({
          content: this._localeService.t("hyperLink.message.refError"),
          type: $C.Error
        });
        return;
      }
      if (u.isSheetHidden()) {
        this._messageService.show({
          content: this._localeService.t("hyperLink.message.hiddenSheet"),
          type: $C.Error
        });
        return;
      }
      this.navigateToDefineName(s, i);
    }
    if (e) {
      if (n) {
        const o = Dr(n);
        z1(o.range) && n !== te && this.navigateToRange(s, e, o.range);
        return;
      }
      this.navigateToSheetById(s, e);
    }
  }
  async navigateToRange(t, e, n, i) {
    const r = await this.navigateToSheetById(t, e);
    if (r) {
      const s = vi(n, r);
      await this._commandService.executeCommand(
        ie2.id,
        {
          unitId: t,
          subUnitId: e,
          selections: [{
            range: s,
            primary: null
          }]
        }
      ), await this._commandService.executeCommand($d.id, {
        range: s,
        forceTop: i
      });
    }
  }
  async navigateToSheetById(t, e) {
    const n = this._univerInstanceService.getUnit(t, we.UNIVER_SHEET);
    if (!n)
      return false;
    const i = n.getActiveSheet();
    if (!i)
      return false;
    if (i.getSheetId() === e)
      return i;
    const r = n.getSheetBySheetId(e);
    return r ? n.getHiddenWorksheets().indexOf(e) > -1 ? (this._messageService.show({
      content: this._localeService.t("hyperLink.message.hiddenSheet"),
      type: $C.Error
    }), false) : await this._commandService.executeCommand(pn2.id, { unitId: t, subUnitId: e }) ? r : false : (this._messageService.show({
      content: this._localeService.t("hyperLink.message.noSheet"),
      type: $C.Error
    }), false);
  }
  async navigateToDefineName(t, e) {
    return this._definedNamesService.focusRange(t, e), true;
  }
  async navigateToOtherWebsite(t) {
    var n;
    const e = this._configService.getConfig(Mn);
    if ((n = e == null ? void 0 : e.urlHandler) != null && n.navigateToOtherWebsite)
      return e.urlHandler.navigateToOtherWebsite(t);
    window.open(t, "_blank", "noopener noreferrer");
  }
};
ce = mi([
  me(0, vr),
  me(1, Ls),
  me(2, Nr2),
  me(3, et2),
  me(4, Inject(Fn)),
  me(5, ic)
], ce);
var Un = class extends Ve {
  constructor() {
    super(...arguments);
    A(this, "_customHyperLinks", /* @__PURE__ */ new Map());
  }
  isBuiltInLinkType(n) {
    return n !== E.URL;
  }
  getOptions() {
    return Array.from(this._customHyperLinks.values()).map(({ option: n }) => n);
  }
  findCustomHyperLink(n) {
    return Array.from(this._customHyperLinks.values()).find((r) => r.match(n));
  }
  registerCustomHyperLink(n) {
    this._customHyperLinks.set(n.type, n);
  }
  getCustomHyperLink(n) {
    return this._customHyperLinks.get(n);
  }
  removeCustomHyperLink(n) {
    const { _customHyperLinks: i } = this;
    i.delete(n);
  }
  dispose() {
    super.dispose(), this._customHyperLinks.clear();
  }
};
var Ye = () => {
  var Zt;
  const [t, e] = (0, import_react.useState)(""), [n, i] = (0, import_react.useState)(false), [r, s] = (0, import_react.useState)(""), [o, c] = (0, import_react.useState)(true), [u, p] = (0, import_react.useState)(E.URL), [l, g] = (0, import_react.useState)(""), d = useDependency(Fn), _ = useDependency(Nr2), I = useDependency(qe), f = useDependency(vr), w = useDependency(Z), a = useObservable(w.currentEditing$), b = useDependency(ve), M = useDependency(ce), T = useDependency(Ls), P2 = useDependency(Un), D2 = (0, import_react.useMemo)(() => P2.getOptions(), [P2]), $ = useDependency(st), Y = useDependency(ME), ne = useDependency(Wi), He = useDependency(m), re2 = useDependency(Nr), Se = useDependency(Gi), ye2 = useDependency(m), [Ee, De2] = (0, import_react.useState)(false), de2 = useDependency(z), Zn = (0, import_react.useMemo)(() => de2.getCurrentSelections(), []), $e = (0, import_react.useMemo)(() => {
    if (!P2.isBuiltInLinkType(u))
      return P2.getCustomHyperLink(u);
  }, [P2, u]), [pe, Gn] = (0, import_react.useState)(false), [Re2, Wt] = (0, import_react.useState)(false), H = (0, import_react.useRef)(false), V = f.getCurrentUnitForType(we.UNIVER_SHEET), Kn = (V == null ? void 0 : V.getActiveSheet().getSheetId()) || "", X = (0, import_react.useCallback)((h) => {
    s(h.replaceAll(ct.CUSTOM_RANGE_START, "").replaceAll(ct.CUSTOM_RANGE_END, ""));
  }, [s]);
  (0, import_react.useEffect)(() => {
    var h, E2, R2, L, O, B, Gt, Kt, Yt, zt, Xt, qt, Jt, Qt, en, tn, nn2;
    if ((a == null ? void 0 : a.row) !== void 0 && a.col !== void 0) {
      const { customRange: ie3, row: ft, col: _t } = a;
      let { label: z2 } = a;
      typeof z2 == "number" && (z2 = `${z2}`);
      let F2;
      if (ie3)
        F2 = {
          id: (h = ie3 == null ? void 0 : ie3.rangeId) != null ? h : "",
          display: z2 != null ? z2 : "",
          payload: (R2 = (E2 = ie3 == null ? void 0 : ie3.properties) == null ? void 0 : E2.url) != null ? R2 : "",
          row: ft,
          column: _t
        };
      else if (a.type === m2.VIEWING) {
        const N2 = f.getUnit(a.unitId), J2 = N2 == null ? void 0 : N2.getSheetBySheetId(a.subUnitId), U = J2 == null ? void 0 : J2.getCellRaw(a.row, a.col), he2 = (B = (O = (L = U == null ? void 0 : U.p) == null ? void 0 : L.body) == null ? void 0 : O.customRanges) == null ? void 0 : B.find((sn) => {
          var on;
          return sn.rangeType === pn.HYPERLINK && ((on = sn.properties) == null ? void 0 : on.url);
        }), Pe2 = U == null ? void 0 : U.v;
        U && (!Je.transform.isEmptyDocument((Kt = (Gt = U.p) == null ? void 0 : Gt.body) == null ? void 0 : Kt.dataStream) || J.isDefine(Pe2)) && c(false), F2 = {
          id: "",
          display: "",
          payload: (zt = (Yt = he2 == null ? void 0 : he2.properties) == null ? void 0 : Yt.url) != null ? zt : "",
          row: ft,
          column: _t
        };
      } else {
        const N2 = f.getCurrentUnitForType(we.UNIVER_DOC), J2 = He.getActiveTextRange(), U = N2 == null ? void 0 : N2.getBody(), he2 = J2 && U ? J2 : null, Pe2 = he2 && ((qt = Je.customRange.getCustomRangesInterestsWithSelection(he2, (Xt = U == null ? void 0 : U.customRanges) != null ? Xt : [])) == null ? void 0 : qt[0]);
        c(false), F2 = {
          id: "",
          display: z2 != null ? z2 : "",
          payload: (Qt = (Jt = Pe2 == null ? void 0 : Pe2.properties) == null ? void 0 : Jt.url) != null ? Qt : "",
          row: ft,
          column: _t
        };
      }
      e(F2.id);
      const rn = P2.findCustomHyperLink(F2);
      if (rn) {
        const N2 = rn.convert(F2);
        p(N2.type), g(N2.payload), X(N2.display);
        return;
      }
      X(F2.display);
      const q = b.parseHyperLink(F2.payload);
      switch (p(q.type === E.INVALID ? E.RANGE : q.type), q.type) {
        case E.URL: {
          g(q.url), q.url === F2.display && (H.current = true);
          break;
        }
        case E.RANGE: {
          const N2 = q.searchObj, J2 = N2.gid && (nn2 = (tn = (en = f.getUnit(a.unitId)) == null ? void 0 : en.getSheetBySheetId(N2.gid)) == null ? void 0 : tn.getName()) != null ? nn2 : "", U = Hc2(J2, Dr(N2.range).range);
          g(U), U === F2.display && (H.current = true);
          break;
        }
        case E.SHEET: {
          const N2 = q.searchObj;
          g(N2.gid);
          break;
        }
        case E.DEFINE_NAME: {
          const N2 = q.searchObj;
          g(N2.rangeid);
          break;
        }
        default:
          g("");
          break;
      }
    }
  }, [a, M, P2, He, f]), (0, import_react.useEffect)(() => {
    let h = null;
    if (a && !a.customRangeId && a.type === m2.VIEWING && J.isDefine(a.row) && J.isDefine(a.col)) {
      const E2 = f.getUnit(a.unitId, we.UNIVER_SHEET), R2 = E2 == null ? void 0 : E2.getSheetBySheetId(a.subUnitId), L = R2 == null ? void 0 : R2.getMergedCell(a.row, a.col), O = new bt(Se.getColorFromTheme("primary.600")).toRgb();
      h = ne.addShape(
        {
          range: L != null ? L : {
            startColumn: a.col,
            endColumn: a.col,
            startRow: a.row,
            endRow: a.row
          },
          style: {
            // hasAutoFill: false,
            fill: `rgb(${O.r}, ${O.g}, ${O.b}, 0.12)`,
            strokeWidth: 1,
            stroke: "#FFBD37",
            widgets: {}
          },
          primary: null
        },
        [],
        -1
      );
    }
    return () => {
      h && ne.removeShape(h);
    };
  }, [a, ne, Se, f]), (0, import_react.useEffect)(() => {
    Wt(u === E.RANGE);
  }, [u]), (0, import_react.useEffect)(() => {
    const h = (a == null ? void 0 : a.type) === m2.ZEN_EDITOR ? Y.getRenderById(Hc) : Y.getRenderById(I.getCurrentEditorId()), E2 = new ao();
    if (h) {
      const R2 = h.with(Re);
      R2.setReserveRangesStatus(true), E2.add(() => {
        R2.setReserveRangesStatus(false);
      });
    }
    return () => {
      I.disableForceKeepVisible(), E2.dispose();
    };
  }, [a == null ? void 0 : a.type, I, Y]), (0, import_react.useEffect)(() => (Re2 && w.setIsKeepVisible(Re2), w.setIsKeepVisible(Ee), () => {
    w.setIsKeepVisible(false);
  }), [Re2, Ee, w]), (0, import_react.useEffect)(() => () => {
    $.temporaryHidden && ($.show(), re2.setContextValue(gr, false));
  }, [re2, $]), (0, import_react.useEffect)(() => {
    if (Re2)
      return I.enableForceKeepVisible(), () => {
        I.disableForceKeepVisible();
      };
  }, [Re2, I]);
  const Yn2 = [
    {
      label: d.t("hyperLink.form.link"),
      value: E.URL
    },
    {
      label: d.t("hyperLink.form.range"),
      value: E.RANGE
    },
    {
      label: d.t("hyperLink.form.worksheet"),
      value: E.SHEET
    },
    {
      label: d.t("hyperLink.form.definedName"),
      value: E.DEFINE_NAME
    },
    ...D2
  ];
  if (!V)
    return;
  const zn = V.getHiddenWorksheets(), gt = V.getSheets().map((h) => ({ label: h.getName(), value: h.getSheetId() })).filter((h) => zn.indexOf(h.value) === -1), mt = Object.values((Zt = _.getDefinedNameMap(V.getUnitId())) != null ? Zt : {}).map((h) => ({
    label: h.name,
    value: h.id
  })), jt = (h, E2) => {
    if (h === E.URL)
      return hi(E2);
    if (h === E.RANGE) {
      const R2 = Dr(E2), L = V.getSheetBySheetName(R2.sheetName);
      if (L)
        return `#gid=${L.getSheetId()}&range=${Ft(R2.range)}`;
    }
    return `#${h}=${E2}`;
  }, Xn = re((h) => {
    var O;
    const R2 = h.split(",").map(Dr)[0];
    if (!R2 || !z1(R2.range))
      return;
    R2.sheetName || (R2.sheetName = ((O = V.getActiveSheet()) == null ? void 0 : O.getName()) || "");
    const L = Ss(R2);
    g(L), L && (H.current || !r) && (X(L), H.current = true);
  }), vt = async () => {
    if (o && !r || !l || u === E.URL && !Ke(l)) {
      Gn(true);
      return;
    }
    if (a)
      if (t) {
        const h = a.type === m2.ZEN_EDITOR || a.type === m2.EDITING ? wt.id : Ct.id;
        await T.executeCommand(h, {
          id: t,
          unitId: a.unitId,
          subUnitId: a.subUnitId,
          payload: {
            display: o ? r : "",
            payload: jt(u, l)
          },
          row: a.row,
          column: a.col,
          documentId: a.type === m2.ZEN_EDITOR ? Hc : I.getCurrentEditorId()
        });
      } else {
        const h = a.type === m2.ZEN_EDITOR || a.type === m2.EDITING ? Rt.id : St.id;
        await T.executeCommand(h, {
          unitId: a.unitId,
          subUnitId: a.subUnitId,
          link: {
            id: et(),
            row: a.row,
            column: a.col,
            payload: jt(u, l),
            display: o ? r : ""
          },
          documentId: a.type === m2.ZEN_EDITOR ? Hc : I.getCurrentEditorId()
        });
      }
    if ((a == null ? void 0 : a.type) === m2.VIEWING) {
      await T.executeCommand(pn2.id, {
        unitId: a.unitId,
        subUnitId: a.subUnitId
      });
      const h = 1;
      await T.executeCommand($d.id, {
        range: {
          startRow: Math.max(a.row - h, 0),
          endRow: a.row + h,
          startColumn: Math.max(a.col - h, 0),
          endColumn: a.col + h
        }
      });
    }
    T.executeCommand(Xe.id);
  };
  return a ? (0, import_jsx_runtime.jsxs)(
    "div",
    {
      className: ie("univer-box-border univer-w-[296px] univer-rounded-xl univer-bg-white univer-p-4 univer-shadow-md dark:!univer-bg-gray-900", kt),
      children: [
        o ? (0, import_jsx_runtime.jsx)(
          gE,
          {
            label: d.t("hyperLink.form.label"),
            error: pe && !r ? d.t("hyperLink.form.inputError") : "",
            children: (0, import_jsx_runtime.jsx)(
              Vx,
              {
                value: r,
                onChange: (h) => {
                  X(h), H.current = false;
                },
                placeholder: d.t("hyperLink.form.labelPlaceholder"),
                autoFocus: true,
                onKeyDown: (h) => {
                  h.keyCode === q1.ENTER && vt();
                }
              }
            )
          }
        ) : null,
        (0, import_jsx_runtime.jsx)(gE, { label: d.t("hyperLink.form.type"), children: (0, import_jsx_runtime.jsx)(
          LE,
          {
            className: "univer-w-full",
            options: Yn2,
            value: u,
            onChange: (h) => {
              p(h), g("");
            }
          }
        ) }),
        u === E.URL && (0, import_jsx_runtime.jsx)(
          gE,
          {
            error: pe ? l ? Ke(l) ? "" : d.t("hyperLink.form.linkError") : d.t("hyperLink.form.inputError") : "",
            children: (0, import_jsx_runtime.jsx)(
              Vx,
              {
                value: l,
                onChange: (h) => {
                  g(h), h && (H.current || !r || r === h) && (X(h), H.current = true);
                },
                placeholder: d.t("hyperLink.form.linkPlaceholder"),
                autoFocus: true,
                onKeyDown: (h) => {
                  h.keyCode === q1.ENTER && vt();
                }
              }
            )
          }
        ),
        u === E.RANGE && (0, import_jsx_runtime.jsx)(gE, { error: pe && !l ? d.t("hyperLink.form.inputError") : "", children: (0, import_jsx_runtime.jsx)(
          Wr,
          {
            unitId: V.getUnitId(),
            subUnitId: Kn,
            maxRangeCount: 1,
            supportAcrossSheet: true,
            initialValue: l,
            resetRange: Zn,
            onChange: (h, E2) => Xn(E2),
            onRangeSelectorDialogVisibleChange: async (h) => {
              var E2, R2;
              if (De2(h), h)
                a.type === m2.ZEN_EDITOR && ($.hide(), re2.setContextValue(gr, true)), a.type !== m2.VIEWING && I.enableForceKeepVisible(), i(true);
              else {
                if (await M.navigateToRange(a.unitId, a.subUnitId, { startRow: a.row, endRow: a.row, startColumn: a.col, endColumn: a.col }, true), a.type === m2.ZEN_EDITOR) {
                  await T.executeCommand(ie2.id, {
                    unitId: a.unitId,
                    subUnitId: a.subUnitId,
                    selections: [{ range: { startRow: a.row, endRow: a.row, startColumn: a.col, endColumn: a.col } }]
                  }), $.show(), re2.setContextValue(gr, false);
                  const L = (E2 = Y.getRenderById(Hc)) == null ? void 0 : E2.with(uo), O = (R2 = ye2.getTextRanges({ unitId: Hc, subUnitId: Hc })) == null ? void 0 : R2[0];
                  L && O && (L.scrollToRange(O), ye2.refreshSelection({ unitId: Hc, subUnitId: Hc }));
                }
                I.disableForceKeepVisible(), i(false);
              }
            },
            onFocusChange: (h) => Wt(h)
          }
        ) }),
        u === E.SHEET && (0, import_jsx_runtime.jsx)(gE, { error: pe && !l ? d.t("hyperLink.form.selectError") : "", children: (0, import_jsx_runtime.jsx)(
          LE,
          {
            className: "univer-w-full",
            options: gt,
            value: l,
            onChange: (h) => {
              var L, O;
              g(h);
              const E2 = (L = gt.find((B) => B.value === h)) == null ? void 0 : L.label, R2 = (O = gt.find((B) => B.value === l)) == null ? void 0 : O.label;
              E2 && (H.current || !r || r === R2) && (X(E2), H.current = true);
            }
          }
        ) }),
        u === E.DEFINE_NAME && (0, import_jsx_runtime.jsx)(gE, { error: pe && !l ? d.t("hyperLink.form.selectError") : "", children: (0, import_jsx_runtime.jsx)(
          LE,
          {
            className: "univer-w-full",
            options: mt,
            value: l,
            onChange: (h) => {
              var L, O;
              g(h);
              const E2 = (L = mt.find((B) => B.value === h)) == null ? void 0 : L.label, R2 = (O = mt.find((B) => B.value === l)) == null ? void 0 : O.label;
              E2 && (H.current || !r || r === R2) && (X(E2), H.current = true);
            }
          }
        ) }),
        ($e == null ? void 0 : $e.Form) && (0, import_jsx_runtime.jsx)(
          $e.Form,
          {
            linkId: t,
            payload: l,
            display: r,
            showError: pe,
            setByPayload: H,
            setDisplay: (h) => {
              X(h), H.current = true;
            },
            setPayload: g
          }
        ),
        (0, import_jsx_runtime.jsxs)("div", { className: "univer-flex univer-flex-row univer-justify-end univer-gap-2", children: [
          (0, import_jsx_runtime.jsx)(
            vr2,
            {
              onClick: () => {
                a && M.navigateToRange(a.unitId, a.subUnitId, { startRow: a.row, endRow: a.row, startColumn: a.col, endColumn: a.col }, true), T.executeCommand(Xe.id);
              },
              children: d.t("hyperLink.form.cancel")
            }
          ),
          (0, import_jsx_runtime.jsx)(
            vr2,
            {
              variant: "primary",
              onClick: async () => {
                vt();
              },
              children: d.t("hyperLink.form.ok")
            }
          )
        ] })
      ]
    }
  ) : null;
};
Ye.componentKey = "univer.sheet.cell-link-edit";
function le({ ref: t, ...e }) {
  const { icon: n, id: i, className: r, extend: s, ...o } = e, c = `univerjs-icon univerjs-icon-${i} ${r || ""}`.trim(), u = (0, import_react.useRef)(`_${Ii()}`);
  return Hn(n, `${i}`, {
    defIds: n.defIds,
    idSuffix: u.current
  }, {
    ref: t,
    className: c,
    ...o
  }, s);
}
function Hn(t, e, n, i, r) {
  return (0, import_react.createElement)(t.tag, {
    key: e,
    ...fi(t, n, r),
    ...i
  }, (_i(t, n).children || []).map((s, o) => Hn(s, `${e}-${t.tag}-${o}`, n, void 0, r)));
}
function fi(t, e, n) {
  const i = { ...t.attrs };
  n != null && n.colorChannel1 && i.fill === "colorChannel1" && (i.fill = n.colorChannel1), t.tag === "mask" && i.id && (i.id = i.id + e.idSuffix), Object.entries(i).forEach(([s, o]) => {
    s === "mask" && typeof o == "string" && (i[s] = o.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  });
  const { defIds: r } = e;
  return !r || r.length === 0 || (t.tag === "use" && i["xlink:href"] && (i["xlink:href"] = i["xlink:href"] + e.idSuffix), Object.entries(i).forEach(([s, o]) => {
    typeof o == "string" && (i[s] = o.replace(/url\(#(.*)\)/, `url(#$1${e.idSuffix})`));
  })), i;
}
function _i(t, e) {
  var i;
  const { defIds: n } = e;
  return !n || n.length === 0 ? t : t.tag === "defs" && ((i = t.children) != null && i.length) ? {
    ...t,
    children: t.children.map((r) => typeof r.attrs.id == "string" && n && n.includes(r.attrs.id) ? {
      ...r,
      attrs: {
        ...r.attrs,
        id: r.attrs.id + e.idSuffix
      }
    } : r)
  } : t;
}
function Ii() {
  return Math.random().toString(36).substring(2, 8);
}
le.displayName = "UniverIcon";
var Ci = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [{
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M7.9999 1.12915C8.03875 1.12915 8.07673 1.13284 8.11352 1.13989H12.2599C13.6958 1.13989 14.8599 2.30395 14.8599 3.73989V7.88619C14.867 7.92301 14.8707 7.96102 14.8707 7.9999C14.8707 8.03878 14.867 8.0768 14.8599 8.11362V12.2599C14.8599 13.6958 13.6958 14.8599 12.2599 14.8599H8.11362C8.0768 14.867 8.03878 14.8707 7.9999 14.8707C7.96102 14.8707 7.92301 14.867 7.88619 14.8599H3.73989C2.30396 14.8599 1.13989 13.6958 1.13989 12.2599V8.11352C1.13284 8.07673 1.12915 8.03875 1.12915 7.9999C1.12915 7.96106 1.13284 7.92308 1.13989 7.88629V3.73989C1.13989 2.30396 2.30395 1.13989 3.73989 1.13989H7.88629C7.92308 1.13284 7.96106 1.12915 7.9999 1.12915ZM2.33989 8.5999V12.2599C2.33989 13.0331 2.9667 13.6599 3.73989 13.6599H7.3999V8.5999H2.33989ZM7.3999 7.3999H2.33989V3.73989C2.33989 2.9667 2.96669 2.33989 3.73989 2.33989H7.3999V7.3999ZM8.5999 8.5999V13.6599H12.2599C13.0331 13.6599 13.6599 13.0331 13.6599 12.2599V8.5999H8.5999ZM13.6599 7.3999H8.5999V2.33989H12.2599C13.0331 2.33989 13.6599 2.96669 13.6599 3.73989V7.3999Z",
      fillRule: "evenodd",
      clipRule: "evenodd"
    }
  }]
};
var Ge = (0, import_react.forwardRef)(function(e, n) {
  return (0, import_react.createElement)(le, Object.assign({}, e, {
    id: "all-border-icon",
    ref: n,
    icon: Ci
  }));
});
Ge.displayName = "AllBorderIcon";
var Si = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [{
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M4.1302 12.4251C4.25802 13.7417 5.36779 14.7708 6.71792 14.7708H11.7179C13.1539 14.7708 14.3179 13.6067 14.3179 12.1708V6.1708C14.3179 4.78586 13.2351 3.65383 11.8698 3.57517C11.742 2.25858 10.6323 1.22949 9.28213 1.22949H4.28213C2.84619 1.22949 1.68213 2.39355 1.68213 3.82949V9.82949C1.68213 11.2144 2.76497 12.3465 4.1302 12.4251ZM10.6583 3.5708H6.71792C5.28198 3.5708 4.11792 4.73486 4.11792 6.1708V11.22C3.4221 11.1387 2.88213 10.5471 2.88213 9.82949V3.82949C2.88213 3.05629 3.50893 2.42949 4.28213 2.42949H9.28213C9.96695 2.42949 10.5369 2.92119 10.6583 3.5708ZM13.1179 6.1708C13.1179 5.3976 12.4911 4.7708 11.7179 4.7708H6.71792C5.94472 4.7708 5.31792 5.3976 5.31792 6.1708V12.1708C5.31792 12.944 5.94472 13.5708 6.71792 13.5708H11.7179C12.4911 13.5708 13.1179 12.944 13.1179 12.1708V6.1708Z",
      fillRule: "evenodd",
      clipRule: "evenodd"
    }
  }]
};
var Dn = (0, import_react.forwardRef)(function(e, n) {
  return (0, import_react.createElement)(le, Object.assign({}, e, {
    id: "copy-icon",
    ref: n,
    icon: Si
  }));
});
Dn.displayName = "CopyIcon";
var yi2 = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [{
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M9.8816 1.97978C11.0177 0.843607 12.862 0.884962 14.0004 2.02342C15.1389 3.16188 15.1803 5.00612 14.0441 6.14228L11.399 8.78737C11.1608 9.02559 10.7746 9.02559 10.5363 8.78737C10.2981 8.54915 10.2981 8.16292 10.5363 7.9247L13.1814 5.2796C13.8195 4.64155 13.8217 3.57006 13.1378 2.8861C12.4538 2.20211 11.3823 2.20438 10.7443 2.84245L7.6976 5.88911L7.69317 5.89349C7.05959 6.53211 7.05894 7.60014 7.74132 8.28252C7.97954 8.52074 7.97954 8.90697 7.74132 9.14519C7.5031 9.38341 7.11687 9.38341 6.87865 9.14519C5.74016 8.00671 5.69884 6.16251 6.83497 5.02633L6.84021 5.02116L9.8816 1.97978Z"
    }
  }, {
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M4.61426 7.2364C4.85248 6.99818 5.23871 6.99818 5.47693 7.2364C5.71515 7.47462 5.71515 7.86085 5.47693 8.09907L2.83183 10.7442C2.19375 11.3823 2.1915 12.4537 2.87547 13.1377C3.55945 13.8217 4.6309 13.8194 5.26899 13.1813L8.31566 10.1347C8.32262 10.1277 8.32971 10.121 8.33691 10.1144C8.34408 10.1064 8.3515 10.0986 8.35916 10.091C8.99721 9.45291 8.99949 8.38145 8.3155 7.69746C8.07728 7.45924 8.07728 7.07301 8.3155 6.83479C8.55372 6.59657 8.93995 6.59657 9.17817 6.83479C10.3166 7.97327 10.358 9.81748 9.22183 10.9536C9.21487 10.9606 9.20779 10.9673 9.20058 10.9739C9.19341 10.9819 9.18599 10.9897 9.17833 10.9973L6.13166 14.044C4.99548 15.1802 3.15127 15.1389 2.01279 14.0004C0.874362 12.8619 0.83297 11.0177 1.96916 9.8815L4.61426 7.2364Z"
    }
  }]
};
var Dt = (0, import_react.forwardRef)(function(e, n) {
  return (0, import_react.createElement)(le, Object.assign({}, e, {
    id: "link-icon",
    ref: n,
    icon: yi2
  }));
});
Dt.displayName = "LinkIcon";
var Ei = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 17",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M12.5935 3.47302C11.6354 2.51492 10.082 2.51492 9.12388 3.47302L7.83534 4.76157C7.60102 4.99588 7.22112 4.99588 6.98681 4.76157C6.75249 4.52725 6.75249 4.14735 6.98681 3.91304L8.27535 2.62449C9.70209 1.19776 12.0153 1.19776 13.442 2.62449C14.8688 4.05123 14.8688 6.36442 13.442 7.79116L12.1535 9.0797C11.9192 9.31402 11.5393 9.31402 11.3049 9.0797C11.0706 8.84539 11.0706 8.46549 11.3049 8.23117L12.5935 6.94263C13.5516 5.98452 13.5516 4.43113 12.5935 3.47302Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M3.40637 12.6606C2.44827 11.7025 2.44827 10.1491 3.40637 9.19102L4.69492 7.90248C4.92923 7.66816 4.92923 7.28826 4.69492 7.05395C4.4606 6.81963 4.0807 6.81963 3.84639 7.05395L2.55784 8.34249C1.13111 9.76923 1.13111 12.0824 2.55784 13.5092C3.98458 14.9359 6.29777 14.9359 7.72451 13.5092L9.01305 12.2206C9.24737 11.9863 9.24737 11.6064 9.01305 11.3721C8.77874 11.1378 8.39884 11.1378 8.16452 11.3721L6.87598 12.6606C5.91787 13.6187 4.36448 13.6187 3.40637 12.6606Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "currentColor",
        d: "M3.5852 2.80332C3.35088 2.569 2.97098 2.569 2.73667 2.80332C2.50235 3.03763 2.50235 3.41753 2.73667 3.65185L12.4151 13.3302C12.6494 13.5646 13.0293 13.5646 13.2636 13.3302C13.4979 13.0959 13.4979 12.716 13.2636 12.4817L3.5852 2.80332Z"
      }
    }
  ]
};
var $n = (0, import_react.forwardRef)(function(e, n) {
  return (0, import_react.createElement)(le, Object.assign({}, e, {
    id: "unlink-icon",
    ref: n,
    icon: Ei
  }));
});
$n.displayName = "UnlinkIcon";
var Ri = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 17 16",
    width: "1em",
    height: "1em"
  },
  children: [{
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M12.6551 1.98906C11.7476 1.08113 10.2757 1.08149 9.3686 1.98987L4.82542 6.53955C4.75087 6.61421 4.69336 6.70411 4.65682 6.80309L3.2461 10.625C3.16506 10.8446 3.21909 11.0912 3.3845 11.2568C3.54991 11.4224 3.79651 11.4767 4.01616 11.3959L7.85031 9.98517C7.94979 9.94856 8.04014 9.89077 8.11508 9.81579L12.6552 5.27327C13.5618 4.36621 13.5618 2.89607 12.6551 1.98906ZM10.2177 2.83779C10.6562 2.39869 11.3677 2.39851 11.8064 2.8374C12.2447 3.27584 12.2447 3.9865 11.8065 4.42497L7.3392 8.89457L4.82213 9.82068L5.74706 7.31487L10.2177 2.83779Z",
      fillRule: "evenodd",
      clipRule: "evenodd"
    }
  }, {
    tag: "path",
    attrs: {
      fill: "currentColor",
      d: "M1.79238 13.2999C1.46101 13.2999 1.19238 13.5685 1.19238 13.8999C1.19238 14.2313 1.46101 14.4999 1.79238 14.4999H14.4924C14.8238 14.4999 15.0924 14.2313 15.0924 13.8999C15.0924 13.5685 14.8238 13.2999 14.4924 13.2999H1.79238Z"
    }
  }]
};
var An2 = (0, import_react.forwardRef)(function(e, n) {
  return (0, import_react.createElement)(le, Object.assign({}, e, {
    id: "write-icon",
    ref: n,
    icon: Ri
  }));
});
An2.displayName = "WriteIcon";
var Pi = {
  tag: "svg",
  attrs: {
    xmlns: "http://www.w3.org/2000/svg",
    fill: "none",
    viewBox: "0 0 16 16",
    width: "1em",
    height: "1em"
  },
  children: [
    {
      tag: "path",
      attrs: {
        fill: "#35BD4B",
        d: "M3.4535 1.12549C2.7002 1.12549 2.08954 1.73615 2.08954 2.48945V13.5104C2.08954 14.2637 2.7002 14.8744 3.4535 14.8744H12.5465C13.2998 14.8744 13.9105 14.2637 13.9105 13.5104V5.0992L10.0091 1.12549H3.4535Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "#32A846",
        d: "M10.0075 1.12549L13.9104 5.09842H10.6742C10.306 5.09842 10.0075 4.79994 10.0075 4.43175V1.12549Z"
      }
    },
    {
      tag: "path",
      attrs: {
        fill: "white",
        d: "M7.8088 10.2949L6.3764 12.403C6.26259 12.5705 6.03455 12.614 5.86705 12.5002C5.69955 12.3864 5.65603 12.1584 5.76984 11.9909L7.3655 9.64252L5.94042 7.54519C5.82661 7.37769 5.87013 7.14964 6.03763 7.03583C6.20512 6.92202 6.43317 6.96555 6.54698 7.13304L7.8088 8.9901L9.07062 7.13304C9.18443 6.96555 9.41248 6.92202 9.57997 7.03583C9.74747 7.14964 9.79099 7.37769 9.67718 7.54519L8.2521 9.64252L9.84776 11.9909C9.96157 12.1584 9.91805 12.3864 9.75055 12.5002C9.58305 12.614 9.35501 12.5705 9.2412 12.403L7.8088 10.2949Z",
        fillRule: "evenodd",
        clipRule: "evenodd"
      }
    }
  ]
};
var Vn = (0, import_react.forwardRef)(function(e, n) {
  return (0, import_react.createElement)(le, Object.assign({}, e, {
    id: "xlsx-multi-icon",
    ref: n,
    icon: Pi
  }));
});
Vn.displayName = "XlsxMultiIcon";
var Li = {
  [E.URL]: (0, import_jsx_runtime.jsx)(Dt, {}),
  [E.SHEET]: (0, import_jsx_runtime.jsx)(Vn, { className: "univer-text-green-500" }),
  [E.RANGE]: (0, import_jsx_runtime.jsx)(Ge, {}),
  [E.DEFINE_NAME]: (0, import_jsx_runtime.jsx)(Ge, {}),
  [E.INVALID]: (0, import_jsx_runtime.jsx)(Ge, {})
};
var mn = (t) => {
  var M, T;
  const e = useDependency(Z), n = useDependency(Ls), i = useDependency(et2), r = useDependency(Fn), s = useDependency(ce), o = useDependency(qe), c = useDependency(ve), u = useDependency(st), { customRange: p, row: l, col: g, unitId: d, subUnitId: _, editPermission: I, copyPermission: f, type: w } = t;
  if (!((M = p == null ? void 0 : p.properties) != null && M.url))
    return null;
  const a = c.parseHyperLink((T = p.properties.url) != null ? T : ""), b = a.type === E.INVALID;
  return (0, import_jsx_runtime.jsxs)(
    "div",
    {
      className: ie("univer-mb-1 univer-flex univer-max-w-80 univer-flex-row univer-items-center univer-justify-between univer-overflow-hidden univer-rounded-lg univer-bg-white univer-p-3 univer-shadow-md dark:!univer-bg-gray-900", kt),
      onClick: () => e.hideCurrentPopup(),
      children: [
        (0, import_jsx_runtime.jsxs)(
          "div",
          {
            className: ie("univer-flex univer-h-6 univer-flex-1 univer-cursor-pointer univer-flex-row univer-items-center univer-truncate univer-text-sm univer-leading-5 univer-text-primary-600", { "univer-text-red-500": b }),
            onClick: () => {
              u.visible || b || s.navigate(a);
            },
            children: [
              (0, import_jsx_runtime.jsx)(
                "div",
                {
                  className: "univer-mr-2 univer-flex univer-h-5 univer-w-5 univer-flex-none univer-items-center univer-justify-center univer-text-base univer-text-gray-900 dark:!univer-text-white",
                  children: Li[a.type]
                }
              ),
              (0, import_jsx_runtime.jsx)(Rp, { showIfEllipsis: true, title: a.name, asChild: true, children: (0, import_jsx_runtime.jsx)("span", { className: "univer-flex-1 univer-truncate", children: a.name }) })
            ]
          }
        ),
        (0, import_jsx_runtime.jsxs)(
          "div",
          {
            className: "univer-flex univer-h-6 univer-flex-none univer-flex-row univer-items-center univer-justify-center",
            children: [
              f && (0, import_jsx_runtime.jsx)(
                "div",
                {
                  className: ie("univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-flex-row univer-items-center univer-justify-center univer-rounded univer-text-base hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-700", { "univer-text-red-500": b }),
                  onClick: () => {
                    if (!b) {
                      if (a.type !== E.URL) {
                        const P2 = new URL(window.location.href);
                        P2.hash = a.url.slice(1), navigator.clipboard.writeText(P2.href);
                      } else
                        navigator.clipboard.writeText(a.url);
                      i.show({
                        content: r.t("hyperLink.message.coped"),
                        type: $C.Info
                      });
                    }
                  },
                  children: (0, import_jsx_runtime.jsx)(Rp, { placement: "bottom", title: r.t("hyperLink.popup.copy"), children: (0, import_jsx_runtime.jsx)(Dn, { className: "dark:!univer-text-white" }) })
                }
              ),
              I && (0, import_jsx_runtime.jsxs)(import_jsx_runtime.Fragment, { children: [
                (0, import_jsx_runtime.jsx)(
                  "div",
                  {
                    className: "univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-flex-row univer-items-center univer-justify-center univer-rounded univer-text-base hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-700",
                    onClick: () => {
                      n.executeCommand(At.id, {
                        unitId: d,
                        subUnitId: _,
                        row: l,
                        col: g,
                        customRangeId: p.rangeId,
                        type: w
                      });
                    },
                    children: (0, import_jsx_runtime.jsx)(Rp, { placement: "bottom", title: r.t("hyperLink.popup.edit"), children: (0, import_jsx_runtime.jsx)(An2, { className: "dark:!univer-text-white" }) })
                  }
                ),
                (0, import_jsx_runtime.jsx)(
                  "div",
                  {
                    className: "univer-ml-2 univer-flex univer-size-6 univer-cursor-pointer univer-flex-row univer-items-center univer-justify-center univer-rounded univer-text-base hover:univer-bg-gray-100 dark:hover:!univer-bg-gray-700",
                    onClick: () => {
                      const P2 = w === m2.EDITING || w === m2.ZEN_EDITOR ? Mt.id : It.id;
                      n.syncExecuteCommand(P2, {
                        unitId: d,
                        subUnitId: _,
                        id: p.rangeId,
                        row: l,
                        column: g,
                        documentId: w === m2.ZEN_EDITOR ? Hc : o.getCurrentEditorId()
                      }) && e.hideCurrentPopup(void 0, true);
                    },
                    children: (0, import_jsx_runtime.jsx)(Rp, { placement: "bottom", title: r.t("hyperLink.popup.cancel"), children: (0, import_jsx_runtime.jsx)($n, { className: "dark:!univer-text-white" }) })
                  }
                )
              ] })
            ]
          }
        )
      ]
    }
  );
};
var ze = () => {
  var r, s;
  const t = useDependency(Z), [e, n] = (0, import_react.useState)(null), i = useDependency(vr);
  if ((0, import_react.useEffect)(() => {
    n(t.currentPopup);
    const o = t.currentPopup$.subscribe((c) => {
      n(c);
    });
    return () => {
      o.unsubscribe();
    };
  }, [t.currentPopup, t.currentPopup$]), !e)
    return null;
  if (e.showAll) {
    const o = i.getUnit(e.unitId, we.UNIVER_SHEET), c = o == null ? void 0 : o.getSheetBySheetId(e.subUnitId), u = c == null ? void 0 : c.getCell(e.row, e.col), p = (s = (r = u == null ? void 0 : u.p) == null ? void 0 : r.body) == null ? void 0 : s.customRanges;
    return p != null && p.length ? (0, import_jsx_runtime.jsx)("div", { children: p.map((l) => (0, import_jsx_runtime.jsx)(mn, { ...e, customRange: l }, l.rangeId)) }) : null;
  }
  return (0, import_jsx_runtime.jsx)(mn, { ...e });
};
ze.componentKey = "univer.sheet.cell-link-popup";
var wi = Object.getOwnPropertyDescriptor;
var bi = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? wi(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var se = (t, e) => (n, i) => e(n, i, t);
var vn = (t, e) => {
  var n, i;
  return t.unitId === e.unitId && t.subUnitId === e.subUnitId && t.row === e.row && t.col === e.col && ((n = t.customRange) == null ? void 0 : n.rangeId) === ((i = e.customRange) == null ? void 0 : i.rangeId) && t.type === e.type;
};
var Z = class extends Ve {
  constructor(e, n, i, r, s, o, c) {
    super();
    A(this, "_currentPopup", null);
    A(this, "_currentPopup$", new Subject());
    A(this, "currentPopup$", this._currentPopup$.asObservable());
    A(this, "_currentEditingPopup", null);
    A(this, "_currentEditing$", new BehaviorSubject(null));
    A(this, "currentEditing$", this._currentEditing$.asObservable());
    A(this, "_isKeepVisible", false);
    this._sheetCanvasPopManagerService = e, this._injector = n, this._univerInstanceService = i, this._editorBridgeService = r, this._textSelectionManagerService = s, this._docCanvasPopManagerService = o, this._zenZoneService = c, this.disposeWithMe(() => {
      this.hideCurrentPopup(), this.endEditing(), this._currentEditing$.complete(), this._currentPopup$.complete();
    });
  }
  get currentPopup() {
    return this._currentPopup;
  }
  get currentEditing() {
    return this._currentEditing$.getValue();
  }
  setIsKeepVisible(e) {
    this._isKeepVisible = e;
  }
  getIsKeepVisible() {
    return this._isKeepVisible;
  }
  // eslint-disable-next-line max-lines-per-function
  showPopup(e) {
    var g;
    if (this._currentPopup && vn(e, this._currentPopup) || (this.hideCurrentPopup(void 0, true), e.type !== m2.ZEN_EDITOR && this._zenZoneService.visible))
      return;
    const n = this._currentEditing$.getValue();
    if (n && vn(e, n))
      return;
    const { unitId: i, subUnitId: r, row: s, col: o, customRangeRect: c, customRange: u } = e;
    let p;
    const l = {
      componentKey: ze.componentKey,
      direction: "bottom",
      onClickOutside: () => {
        this.hideCurrentPopup();
      },
      onClick: () => {
        this.hideCurrentPopup(e.type, true);
      }
    };
    if (e.type === m2.EDITING) {
      if (!u)
        return;
      p = c && this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(
        c,
        l
      );
    } else if (e.type === m2.ZEN_EDITOR) {
      if (!u)
        return;
      p = this._docCanvasPopManagerService.attachPopupToRange(
        {
          startOffset: u.startIndex,
          endOffset: u.endIndex + 1,
          collapsed: false
        },
        l,
        Hc
      );
    } else if (e.showAll)
      p = this._sheetCanvasPopManagerService.attachPopupToCell(e.row, e.col, l, i, r);
    else {
      if (!u)
        return;
      p = c && this._sheetCanvasPopManagerService.attachPopupByPosition(
        c,
        l,
        e
      );
    }
    p && (this._currentPopup && ((g = this._currentPopup.disposable) == null || g.dispose()), this._currentPopup = {
      unitId: i,
      subUnitId: r,
      disposable: p,
      row: s,
      col: o,
      editPermission: !!e.editPermission,
      copyPermission: !!e.copyPermission,
      customRange: u,
      type: e.type,
      showAll: e.showAll
    }, this._currentPopup$.next(this._currentPopup));
  }
  hideCurrentPopup(e, n) {
    var i, r;
    this._currentPopup && ((!e || e === this._currentPopup.type) && this._currentPopup.disposable.canDispose() || n) && ((r = (i = this._currentPopup) == null ? void 0 : i.disposable) == null || r.dispose(), this._currentPopup = null, this._currentPopup$.next(null));
  }
  dispose() {
    super.dispose(), this.hideCurrentPopup(), this.endEditing(), this._currentPopup$.complete(), this._currentEditing$.complete();
  }
  _getEditingRange() {
    var i, r, s;
    const e = this._editorBridgeService.isVisible().visible, n = this._editorBridgeService.getEditCellState();
    if (e && n) {
      const o = this._textSelectionManagerService.getActiveTextRange(), c = (i = n.documentLayoutObject.documentModel) == null ? void 0 : i.getBody();
      if (!c)
        return null;
      if (!o || o.collapsed)
        return {
          startOffset: 0,
          endOffset: c.dataStream.length - 2,
          collapsed: c.dataStream.length - 2 === 0,
          label: Je.transform.getPlainText(c.dataStream)
        };
      const u = Je.customRange.getCustomRangesInterestsWithSelection(o, (s = (r = c.customRanges) == null ? void 0 : r.filter((g) => g.rangeType === pn.HYPERLINK)) != null ? s : []);
      let p = o.startOffset, l = o.endOffset;
      return u.forEach((g) => {
        p = Math.min(p, g.startIndex), l = Math.max(l, g.endIndex + 1);
      }), {
        startOffset: p,
        endOffset: l,
        collapsed: p === l,
        label: Je.transform.getPlainText(c.dataStream.slice(p, l))
      };
    }
    return null;
  }
  get _editPopup() {
    return {
      componentKey: Ye.componentKey,
      direction: "vertical",
      onClickOutside: () => {
        this.endEditing();
      },
      onContextMenu: () => {
        this.endEditing();
      },
      hiddenType: "hide"
    };
  }
  startAddEditing(e) {
    var s, o, c, u, p;
    const { unitId: n, subUnitId: i, type: r } = e;
    if (r === m2.ZEN_EDITOR) {
      const l = this._univerInstanceService.getUnit(Hc, we.UNIVER_DOC);
      if (!l)
        return;
      const g = this._textSelectionManagerService.getActiveTextRange();
      if (!g)
        return;
      this._currentEditingPopup = this._docCanvasPopManagerService.attachPopupToRange(
        g,
        this._editPopup,
        Hc
      );
      const d = (s = l.getBody()) == null ? void 0 : s.dataStream.slice(g.startOffset, g.endOffset);
      this._currentEditing$.next({
        ...e,
        label: d
      });
    } else if (r === m2.EDITING) {
      const l = this._getEditingRange();
      if (!l)
        return;
      this._textSelectionManagerService.replaceDocRanges([{ ...l }], { unitId: Dl, subUnitId: Dl });
      const g = this._injector.get(ME).getRenderById(Dl);
      if (!g)
        return;
      const d = nr(l, g);
      if (!(d != null && d.length))
        return;
      this._currentEditingPopup = this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(
        d.pop(),
        this._editPopup,
        n,
        i
      ), this._currentEditing$.next({
        ...e,
        label: (o = l == null ? void 0 : l.label) != null ? o : ""
      });
    } else {
      this._currentEditingPopup = this._sheetCanvasPopManagerService.attachPopupToCell(
        e.row,
        e.col,
        this._editPopup,
        n,
        i
      );
      const l = this._univerInstanceService.getUnit(n, we.UNIVER_SHEET), g = l == null ? void 0 : l.getSheetBySheetId(i), d = g == null ? void 0 : g.getCellRaw(e.row, e.col);
      this._currentEditing$.next({
        ...e,
        label: d != null && d.p ? Je.transform.getPlainText((u = (c = d.p.body) == null ? void 0 : c.dataStream) != null ? u : "") : ((p = d == null ? void 0 : d.v) != null ? p : "").toString()
      });
    }
  }
  // eslint-disable-next-line complexity, max-lines-per-function
  startEditing(e) {
    var o, c, u, p, l, g;
    (o = this._currentEditingPopup) == null || o.dispose(), this.hideCurrentPopup(void 0, true);
    const { unitId: n, subUnitId: i } = e;
    let r, s;
    if (e.type === m2.ZEN_EDITOR) {
      const d = this._univerInstanceService.getUnit(Hc, we.UNIVER_DOC);
      if (r = (u = (c = d == null ? void 0 : d.getBody()) == null ? void 0 : c.customRanges) == null ? void 0 : u.find((_) => _.rangeId === e.customRangeId), s = r ? (p = d == null ? void 0 : d.getBody()) == null ? void 0 : p.dataStream.slice(r.startIndex, r.endIndex + 1) : "", !r || !s)
        return;
      this._textSelectionManagerService.replaceTextRanges([
        {
          startOffset: r.startIndex,
          endOffset: r.endIndex + 1
        }
      ]), this._currentEditingPopup = this._docCanvasPopManagerService.attachPopupToRange(
        {
          startOffset: r.startIndex,
          endOffset: r.endIndex,
          collapsed: false
        },
        this._editPopup,
        Hc
      );
    } else if (e.type === m2.EDITING) {
      const d = $y(this._injector, e.unitId, e.subUnitId, e.row, e.col, e.customRangeId);
      if (!d || !((l = d.rects) != null && l.length))
        return;
      r = d.customRange, s = d.label, this._textSelectionManagerService.replaceTextRanges([
        {
          startOffset: r.startIndex,
          endOffset: r.endIndex + 1
        }
      ]), this._currentEditingPopup = this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(
        d.rects.pop(),
        this._editPopup,
        n,
        i
      );
    } else {
      const d = this._univerInstanceService.getUnit(n, we.UNIVER_SHEET), _ = d == null ? void 0 : d.getSheetBySheetId(i), I = _ == null ? void 0 : _.getCellRaw(e.row, e.col), f = d == null ? void 0 : d.getStyles().getStyleByCell(I), w = f == null ? void 0 : f.tr, a = Jy(this._injector, e.unitId, e.subUnitId, e.row, e.col, e.customRangeId);
      if (!a || !((g = a.rects) != null && g.length))
        return;
      r = a.customRange, s = a.label, w ? this._currentEditingPopup = this._sheetCanvasPopManagerService.attachPopupToCell(
        e.row,
        e.col,
        this._editPopup,
        n,
        i
      ) : this._currentEditingPopup = this._sheetCanvasPopManagerService.attachPopupByPosition(
        a.rects.pop(),
        this._editPopup,
        {
          unitId: n,
          subUnitId: i,
          row: e.row,
          col: e.col
        }
      );
    }
    this._currentEditing$.next({
      ...e,
      customRange: r,
      label: s
    });
  }
  endEditing(e) {
    var i;
    if (this.getIsKeepVisible())
      return;
    const n = this._currentEditing$.getValue();
    n && (!e || e === n.type) && ((i = this._currentEditingPopup) == null || i.dispose(), this._currentEditing$.next(null));
  }
};
Z = bi([
  se(0, Inject(yi)),
  se(1, Inject(Injector)),
  se(2, vr),
  se(3, qe),
  se(4, Inject(m)),
  se(5, Inject(Bn)),
  se(6, st)
], Z);
var ke = ((t) => (t[t.ALLOWED = 0] = "ALLOWED", t[t.DISABLED_BY_CELL = 1] = "DISABLED_BY_CELL", t[t.ALLOW_ON_EDITING = 2] = "ALLOW_ON_EDITING", t))(ke || {});
var ki = /* @__PURE__ */ new Set([
  TC.CHECKBOX,
  TC.LIST,
  TC.LIST_MULTIPLE
]);
var $t = (t, e, n, i) => {
  var c, u, p, l, g;
  const r = e.getCell(n, i);
  if (r != null && r.f || r != null && r.si || (p = (u = (c = r == null ? void 0 : r.p) == null ? void 0 : c.body) == null ? void 0 : u.customBlocks) != null && p.length)
    return 1;
  const s = t.has(F) ? t.get(F) : null, o = s == null ? void 0 : s.getRuleByLocation(e.getUnitId(), e.getSheetId(), n, i);
  return o && ki.has(o.type) ? true : (g = (l = r == null ? void 0 : r.p) == null ? void 0 : l.drawingsOrder) != null && g.length ? 2 : 0;
};
var Ti = (t) => {
  const e = t.get(vr).getCurrentUnitForType(we.UNIVER_SHEET);
  if (!e)
    return true;
  const n = e.getActiveSheet(), i = t.get(z).getCurrentSelections();
  if (!i.length)
    return true;
  const r = i[0].range.startRow, s = i[0].range.startColumn;
  return $t(t, n, r, s) === 1;
};
var Ni = (t) => {
  const e = t.get(m), n = t.get(vr), i = e.getTextRanges();
  if (!(i != null && i.length))
    return true;
  const r = n.getCurrentUnitForType(we.UNIVER_DOC);
  return !!(!r || i.every((o) => o.collapsed) || !r.getSelfOrHeaderFooterModel(i[0].segmentId).getBody());
};
var At = {
  type: Ms.OPERATION,
  id: "sheet.operation.open-hyper-link-edit-panel",
  handler(t, e) {
    if (!e)
      return false;
    const n = t.get(Z);
    return e.customRangeId ? n.startEditing(e) : n.startAddEditing(e), true;
  }
};
var Xe = {
  type: Ms.OPERATION,
  id: "sheet.operation.close-hyper-link-popup",
  handler(t) {
    return t.get(Z).endEditing(), true;
  }
};
var Vt = {
  type: Ms.OPERATION,
  id: "sheet.operation.insert-hyper-link",
  handler(t) {
    var g;
    const e = t.get(vr), n = P(e), i = t.get(qe);
    if (!n)
      return false;
    const r = t.get(Ls), o = t.get(z).getCurrentLastSelection();
    if (!o)
      return false;
    const c = o.range.startRow, u = o.range.startColumn, p = i.isVisible(), l = ((g = e.getFocusedUnit()) == null ? void 0 : g.getUnitId()) === Hc;
    return r.executeCommand(At.id, {
      unitId: n.unitId,
      subUnitId: n.subUnitId,
      row: c,
      col: u,
      type: l ? m2.ZEN_EDITOR : p.visible ? m2.EDITING : m2.VIEWING
    });
  }
};
var ae = {
  type: Ms.OPERATION,
  id: "sheet.operation.insert-hyper-link-toolbar",
  handler(t) {
    if (Ti(t))
      return false;
    const e = t.get(Ls);
    return t.get(Z).currentEditing ? e.executeCommand(Xe.id) : e.executeCommand(Vt.id);
  }
};
var Bt = "SHEET_HYPER_LINK_UI_PLUGIN";
var xi = Object.getOwnPropertyDescriptor;
var Oi = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? xi(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var Be = (t, e) => (n, i) => e(n, i, t);
var qe2 = class extends Ve {
  constructor(e, n, i, r) {
    super();
    A(this, "_plainTextFilter", /* @__PURE__ */ new Set());
    A(this, "_copyInfo");
    this._sheetClipboardService = e, this._hyperLinkModel = n, this._injector = i, this._resolverService = r, this._initCopyPaste(), this.disposeWithMe(() => {
      this._plainTextFilter.clear();
    });
  }
  registerPlainTextFilter(e) {
    this._plainTextFilter.add(e);
  }
  removePlainTextFilter(e) {
    this._plainTextFilter.delete(e);
  }
  /* If return false the process of paste text will be stop */
  _filterPlainText(e) {
    return Array.from(this._plainTextFilter).every((n) => n(e));
  }
  _initCopyPaste() {
    this._sheetClipboardService.addClipboardHook({
      id: Bt,
      onBeforeCopy: (e, n, i) => this._collect(e, n, i),
      onPasteCells: (e, n, i, r) => {
        const { copyType: s = Yn.COPY, pasteType: o } = r, { range: c } = e || {}, { range: u, unitId: p, subUnitId: l } = n;
        return this._generateMutations(u, { copyType: s, pasteType: o, copyRange: c, unitId: p, subUnitId: l });
      },
      onPastePlainText: (e, n) => {
        const i = this._filterPlainText(n);
        if (Ke(n) && i) {
          const { range: r, unitId: s, subUnitId: o } = e, { ranges: [c], mapFunc: u } = wr2([r]), p = [], l = [];
          return Or.foreach(c, (g, d) => {
            const { row: _, col: I } = u(g, d), f = this._hyperLinkModel.getHyperLinkByLocation(s, o, _, I);
            f && p.push({
              id: N.id,
              params: {
                unitId: s,
                subUnitId: o,
                id: f.id
              }
            }), f && l.push({
              id: D.id,
              params: {
                unitId: s,
                subUnitId: o,
                link: f
              }
            });
          }), { redos: p, undos: l };
        }
        return { undos: [], redos: [] };
      },
      priority: 99
    });
  }
  _collect(e, n, i) {
    const r = new pt();
    this._copyInfo = {
      unitId: e,
      subUnitId: n,
      matrix: r
    };
    const s = this._injector.invoke((u) => ku(i, u, e, n));
    if (!s)
      return;
    const { rows: o, cols: c } = s;
    o.forEach((u, p) => {
      c.forEach((l, g) => {
        var _;
        const d = this._hyperLinkModel.getHyperLinkByLocation(e, n, u, l);
        r.setValue(p, g, (_ = d == null ? void 0 : d.id) != null ? _ : "");
      });
    });
  }
  // eslint-disable-next-line max-lines-per-function
  _generateMutations(e, n) {
    if (!this._copyInfo)
      return { redos: [], undos: [] };
    if (!this._copyInfo || !this._copyInfo.matrix.getSizeOf() || !n.copyRange)
      return { redos: [], undos: [] };
    if ([
      et3.SPECIAL_PASTE_COL_WIDTH,
      et3.SPECIAL_PASTE_VALUE,
      et3.SPECIAL_PASTE_FORMAT,
      et3.SPECIAL_PASTE_FORMULA
    ].includes(n.pasteType))
      return { redos: [], undos: [] };
    const { unitId: r, subUnitId: s } = this._copyInfo, o = [], c = [], { ranges: [u, p], mapFunc: l } = wr2([n.copyRange, e]);
    return Yy(u, p, true).forEach(({ startRange: d }) => {
      var _;
      (_ = this._copyInfo) == null || _.matrix.forValue((I, f, w) => {
        const a = En.getPositionRange(
          {
            startRow: I,
            endRow: I,
            startColumn: f,
            endColumn: f
          },
          d
        ), b = this._hyperLinkModel.getHyperLink(r, s, w), { row: M, col: T } = l(a.startRow, a.startColumn), P2 = this._hyperLinkModel.getHyperLinkByLocation(n.unitId, n.subUnitId, M, T), D2 = et();
        P2 && o.push({
          id: N.id,
          params: {
            unitId: n.unitId,
            subUnitId: n.subUnitId,
            id: P2.id
          }
        }), b && (o.push({
          id: D.id,
          params: {
            unitId: n.unitId,
            subUnitId: n.subUnitId,
            link: {
              ...b,
              id: D2,
              row: M,
              column: T
            }
          }
        }), c.push({
          id: N.id,
          params: {
            unitId: n.unitId,
            subUnitId: n.subUnitId,
            id: D2
          }
        })), P2 && c.push({
          id: D.id,
          params: {
            unitId: n.unitId,
            subUnitId: n.subUnitId,
            link: P2
          }
        });
      });
    }), { redos: o, undos: c };
  }
};
qe2 = Oi([
  Be(0, nn),
  Be(1, Inject(R)),
  Be(2, Inject(Injector)),
  Be(3, Inject(ce))
], qe2);
var Ft2 = (t, e = Hc) => {
  var r;
  const n = t.get(vr), i = (r = t.get(ME).getRenderById(e)) == null ? void 0 : r.with(Re);
  return i ? i.textSelectionInner$.pipe(map(() => {
    const o = t.get(qe).getEditCellState();
    if (!o)
      return true;
    const c = P(n, { unitId: o.unitId, subUnitId: o.sheetId });
    return !(c != null && c.worksheet) || $t(t, c.worksheet, o.row, o.column) === 1 ? true : Ni(t);
  })) : of(true);
};
var Bn2 = (t) => {
  var r;
  const e = t.get(vr), n = t.has(qe) ? t.get(qe) : null;
  return ((r = n == null ? void 0 : n.currentEditCellState$.pipe(
    map((s) => {
      if (!s)
        return ke.DISABLED_BY_CELL;
      const o = P(e, { unitId: s.unitId, subUnitId: s.sheetId });
      return o ? $t(t, o.worksheet, s.row, s.column) : ke.DISABLED_BY_CELL;
    }),
    switchMap((s) => {
      if (s === ke.DISABLED_BY_CELL)
        return of(true);
      const o = n ? n.visible$ : of(null);
      return combineLatest([o, e.getCurrentTypeOfUnit$(we.UNIVER_DOC)]).pipe(
        switchMap(
          ([c, u]) => c != null && c.visible ? (u == null ? void 0 : u.getUnitId()) === Ul ? of(true) : Ft2(t, Dl) : of(s !== ke.ALLOWED)
        )
      );
    })
  )) != null ? r : of(true)).pipe(
    switchMap((s) => s ? of(true) : he(t, { workbookTypes: [Pe], worksheetTypes: [Ve2, An, Ir], rangeTypes: [Le] }, true))
  );
};
var Je2 = {
  commandId: Vt.id,
  type: H1.BUTTON,
  title: "hyperLink.menu.add",
  icon: "LinkIcon"
};
var Qe = (t) => `${t}-zen-editor`;
var Mi = (t) => ({
  ...Je2,
  id: Je2.commandId,
  hidden$: Bi(t, we.UNIVER_SHEET),
  disabled$: Bn2(t)
  // disabled$: getObservableWithExclusiveRange$(accessor, getCurrentRangeDisable$(accessor, { workbookTypes: [WorkbookEditablePermission], worksheetTypes: [WorksheetEditPermission, WorksheetSetCellValuePermission, WorksheetInsertHyperlinkPermission], rangeTypes: [RangeProtectionPermissionEditPoint] })),
});
var Ui = (t) => ({
  ...Je2,
  id: Qe(Je2.commandId),
  hidden$: Bi(t, we.UNIVER_DOC, Hc),
  disabled$: Ft2(t)
});
var et4 = {
  tooltip: "hyperLink.form.addTitle",
  commandId: ae.id,
  type: H1.BUTTON,
  icon: "LinkIcon"
};
var Hi = (t) => ({
  ...et4,
  id: et4.commandId,
  hidden$: Bi(t, we.UNIVER_SHEET),
  disabled$: Bn2(t)
});
var Di = (t) => ({
  ...et4,
  id: Qe(et4.commandId),
  hidden$: Bi(t, we.UNIVER_DOC, Hc),
  disabled$: Ft2(t)
});
var Fn2 = {
  id: ae.id,
  binding: q1.K | L1.CTRL_COMMAND,
  preconditions: Ve3
};
var $i = Object.getOwnPropertyDescriptor;
var Ai = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? $i(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var fn = (t, e) => (n, i) => e(n, i, t);
var tt = class extends Ve {
  constructor(t, e) {
    super(), this._autoFillService = t, this._hyperLinkModel = e, this._initAutoFill();
  }
  // eslint-disable-next-line max-lines-per-function
  _initAutoFill() {
    const t = () => ({ redos: [], undos: [] }), e = (i, r) => {
      const { source: s, target: o, unitId: c, subUnitId: u } = i, p = wr2([s, o]), [l, g] = p.ranges, { mapFunc: d } = p, _ = {
        row: l.startRow,
        col: l.startColumn
      }, I = zy(l, g), f = [], w = [];
      return I.forEach((a) => {
        const b = a.repeatStartCell, M = a.relativeRange, T = {
          startRow: _.row,
          startColumn: _.col,
          endColumn: _.col,
          endRow: _.row
        }, P2 = {
          startRow: b.row,
          startColumn: b.col,
          endColumn: b.col,
          endRow: b.row
        };
        Or.foreach(M, (D2, $) => {
          const Y = En.getPositionRange(
            {
              startRow: D2,
              startColumn: $,
              endColumn: $,
              endRow: D2
            },
            T
          ), { row: ne, col: He } = d(Y.startRow, Y.startColumn), re2 = this._hyperLinkModel.getHyperLinkByLocation(c, u, ne, He), Se = En.getPositionRange(
            {
              startRow: D2,
              startColumn: $,
              endColumn: $,
              endRow: D2
            },
            P2
          ), { row: ye2, col: Ee } = d(Se.startRow, Se.startColumn), De2 = et(), de2 = this._hyperLinkModel.getHyperLinkByLocation(c, u, ye2, Ee);
          de2 && f.push({
            id: N.id,
            params: {
              unitId: c,
              subUnitId: u,
              id: de2.id
            }
          }), (Le2.COPY === r || Le2.SERIES === r) && re2 && (f.push({
            id: D.id,
            params: {
              unitId: c,
              subUnitId: u,
              link: {
                ...re2,
                id: De2,
                row: ye2,
                column: Ee
              }
            }
          }), w.push({
            id: N.id,
            params: {
              unitId: c,
              subUnitId: u,
              id: De2
            }
          })), de2 && w.push({
            id: D.id,
            params: {
              unitId: c,
              subUnitId: u,
              link: de2
            }
          });
        });
      }), {
        undos: w,
        redos: f
      };
    }, n = {
      id: Bt,
      onFillData: (i, r, s) => s === Le2.COPY || s === Le2.ONLY_FORMAT || s === Le2.SERIES ? e(i, s) : t()
    };
    this.disposeWithMe(this._autoFillService.addHook(n));
  }
};
tt = Ai([
  fn(0, Hr),
  fn(1, Inject(R))
], tt);
var Vi = Object.getOwnPropertyDescriptor;
var Bi2 = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? Vi(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var Et = (t, e) => (n, i) => e(n, i, t);
var nt = class extends Ve {
  constructor(t, e, n) {
    super(), this._localeService = t, this._commandService = e, this._sheetPermissionCheckController = n, this._commandExecutedListener();
  }
  _commandExecutedListener() {
    this.disposeWithMe(
      this._commandService.beforeCommandExecuted((t) => {
        t.id === Fn2.id && (this._sheetPermissionCheckController.permissionCheckWithRanges({
          workbookTypes: [Pe],
          rangeTypes: [Le],
          worksheetTypes: [Ve2, An, Ir]
        }) || this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.hyperLinkErr")));
      })
    );
  }
};
nt = Bi2([
  Et(0, Inject(Fn)),
  Et(1, Ls),
  Et(2, Inject(qn))
], nt);
var Fi = Object.getOwnPropertyDescriptor;
var Wi2 = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? Fi(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var W = (t, e) => (n, i) => e(n, i, t);
var rt = class extends Ve {
  constructor(t, e, n, i, r, s, o, c, u, p) {
    super(), this._hoverManagerService = t, this._sheetsHyperLinkPopupService = e, this._renderManagerService = n, this._permissionService = i, this._sheetPermissionCheckController = r, this._commandService = s, this._editorBridgeService = o, this._textSelectionManagerService = c, this._univerInstanceService = u, this._zenZoneService = p, this._initHoverListener(), this._initCommandListener(), this._initHoverEditingListener(), this._initTextSelectionListener(), this._initZenEditor();
  }
  _getLinkPermission(t) {
    const { unitId: e, subUnitId: n, row: i, col: r } = t, s = this._univerInstanceService.getUnit(e, we.UNIVER_SHEET), o = s == null ? void 0 : s.getSheetBySheetId(n);
    if (!o)
      return {
        viewPermission: false,
        editPermission: false,
        copyPermission: false
      };
    const c = this._sheetPermissionCheckController.permissionCheckWithRanges({
      workbookTypes: [hr],
      worksheetTypes: [ls],
      rangeTypes: [Hs]
    }, [{ startRow: i, startColumn: r, endRow: i, endColumn: r }]);
    let u = this._sheetPermissionCheckController.permissionCheckWithRanges({
      workbookTypes: [Pe],
      worksheetTypes: [Ve2, Ir],
      rangeTypes: [Le]
    }, [{ startRow: i, startColumn: r, endRow: i, endColumn: r }]);
    const p = o.getCellRaw(i, r);
    p != null && p.f && p.f.startsWith("=HYPERLINK(") && (u = false);
    const l = this._permissionService.composePermission([new sr2(e).id, new mr(e, n).id]).every((g) => g.value);
    return {
      viewPermission: c,
      editPermission: u,
      copyPermission: l
    };
  }
  _initHoverListener() {
    this.disposeWithMe(
      // hover over not editing cell
      this._hoverManagerService.currentRichText$.pipe(debounceTime(200)).subscribe((t) => {
        var T, P2, D2;
        if (!t || ((T = t.customRange) == null ? void 0 : T.rangeType) !== pn.HYPERLINK) {
          this._sheetsHyperLinkPopupService.hideCurrentPopup();
          return;
        }
        const { unitId: e, subUnitId: n, row: i, col: r } = t, s = this._renderManagerService.getRenderById(e);
        if (!s)
          return;
        const o = this._univerInstanceService.getUnit(e, we.UNIVER_SHEET), c = o == null ? void 0 : o.getSheetBySheetId(n);
        if (!c)
          return;
        if (!s.with(hl).active) {
          this._sheetsHyperLinkPopupService.hideCurrentPopup(m2.VIEWING);
          return;
        }
        const p = (P2 = s == null ? void 0 : s.with(ue).getSkeletonParam(n)) == null ? void 0 : P2.skeleton, l = r, g = i;
        let d = g, _ = l;
        p && p.overflowCache.forValue(($, Y, ne) => {
          En.contains(ne, { startColumn: l, endColumn: l, startRow: g, endRow: g }) && (d = $, _ = Y);
        });
        const { viewPermission: I, editPermission: f, copyPermission: w } = this._getLinkPermission(t);
        if (!I) {
          this._sheetsHyperLinkPopupService.hideCurrentPopup();
          return;
        }
        const a = c.getCellStyleOnly(d, _), b = o.getStyles().getStyleByCell(a), M = (D2 = b == null ? void 0 : b.tr) == null ? void 0 : D2.a;
        if (!M && !t.customRange) {
          this._sheetsHyperLinkPopupService.hideCurrentPopup();
          return;
        }
        this._sheetsHyperLinkPopupService.showPopup({
          row: d,
          col: _,
          editPermission: f,
          copyPermission: w,
          customRange: t.customRange,
          customRangeRect: t.rect,
          type: m2.VIEWING,
          unitId: e,
          subUnitId: n,
          showAll: !!M
        });
      })
    );
  }
  _initHoverEditingListener() {
    let t = null;
    this.disposeWithMe(
      this._editorBridgeService.currentEditCellState$.pipe(switchMap((e) => this._editorBridgeService.visible$.pipe(map((n) => ({ visible: n, state: e }))))).subscribe(({ visible: e, state: n }) => {
        if (!n || n.editorUnitId !== Dl)
          return;
        if (!e.visible) {
          t == null || t.unsubscribe(), this._sheetsHyperLinkPopupService.hideCurrentPopup(m2.EDITING), this._sheetsHyperLinkPopupService.endEditing(m2.EDITING);
          return;
        }
        const { editorUnitId: i, unitId: r, sheetId: s, row: o, column: c } = n, u = this._renderManagerService.getRenderById(i);
        if (!u)
          return;
        const { editPermission: p, viewPermission: l, copyPermission: g } = this._getLinkPermission({ unitId: r, subUnitId: s, row: o, col: c }), d = u.with(wt2);
        l && (t == null || t.unsubscribe(), t = d.hoverCustomRanges$.pipe(debounceTime(200)).subscribe((_) => {
          var b, M;
          const I = _.find((T) => T.range.rangeType === pn.HYPERLINK);
          if (!I) {
            this._sheetsHyperLinkPopupService.hideCurrentPopup();
            return;
          }
          const f = I.rects[I.rects.length - 1];
          if (!((M = (b = this._renderManagerService.getRenderById(r)) == null ? void 0 : b.with(ue).getSkeletonParam(s)) == null ? void 0 : M.skeleton) || !f)
            return;
          const a = u.engine.getCanvasElement().getBoundingClientRect();
          this._sheetsHyperLinkPopupService.showPopup({
            unitId: r,
            subUnitId: s,
            row: o,
            col: c,
            customRange: I.range,
            customRangeRect: {
              left: f.left + a.left,
              top: f.top + a.top,
              bottom: f.bottom + a.top,
              right: f.right + a.left
            },
            editPermission: p,
            copyPermission: g,
            type: m2.EDITING
          });
        }));
      })
    ), this.disposeWithMe(() => {
      t == null || t.unsubscribe();
    });
  }
  _initZenEditor() {
    this.disposeWithMe(
      this._zenZoneService.visible$.subscribe((t) => {
        t ? (this._sheetsHyperLinkPopupService.hideCurrentPopup(m2.VIEWING), this._sheetsHyperLinkPopupService.hideCurrentPopup(m2.EDITING), this._sheetsHyperLinkPopupService.endEditing(m2.EDITING), this._sheetsHyperLinkPopupService.hideCurrentPopup(m2.VIEWING)) : (this._sheetsHyperLinkPopupService.hideCurrentPopup(m2.ZEN_EDITOR), this._sheetsHyperLinkPopupService.endEditing(m2.ZEN_EDITOR));
      })
    ), this.disposeWithMe(
      this._univerInstanceService.focused$.pipe(
        switchMap((t) => {
          const e = t === Hc ? this._renderManagerService.getRenderById(t) : null;
          return e ? e.with(wt2).hoverCustomRanges$.pipe(debounceTime(200)) : new Observable((n) => {
            n.next(null);
          });
        })
      ).subscribe((t) => {
        const e = t == null ? void 0 : t.find((i) => i.range.rangeType === pn.HYPERLINK), n = this._editorBridgeService.getEditCellState();
        if (e && n) {
          const { unitId: i, sheetId: r, row: s, column: o } = n, { editPermission: c, viewPermission: u, copyPermission: p } = this._getLinkPermission({ unitId: i, subUnitId: r, row: s, col: o });
          u && this._sheetsHyperLinkPopupService.showPopup({
            type: m2.ZEN_EDITOR,
            unitId: i,
            subUnitId: r,
            row: s,
            col: o,
            customRange: e.range,
            editPermission: c,
            copyPermission: p
          });
        } else
          this._sheetsHyperLinkPopupService.hideCurrentPopup(m2.ZEN_EDITOR);
      })
    );
  }
  _initTextSelectionListener() {
    this.disposeWithMe(
      this._textSelectionManagerService.textSelection$.subscribe((t) => {
        t && t.unitId === Dl && this._sheetsHyperLinkPopupService.endEditing(m2.EDITING);
      })
    );
  }
  _initCommandListener() {
    const t = [qs.id, Ws.id, Ls2.id];
    this.disposeWithMe(this._commandService.onCommandExecuted((e) => {
      t.includes(e.id) && this._sheetsHyperLinkPopupService.hideCurrentPopup();
    }));
  }
};
rt = Wi2([
  W(0, Inject(Mr)),
  W(1, Inject(Z)),
  W(2, Inject(ME)),
  W(3, Inject(eC)),
  W(4, Inject(qn)),
  W(5, Ls),
  W(6, qe),
  W(7, Inject(m)),
  W(8, vr),
  W(9, st)
], rt);
var ji = Object.getOwnPropertyDescriptor;
var Wn = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? ji(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var Lt = (t, e) => (n, i) => e(n, i, t);
var wt3 = class extends Ve {
  constructor(t, e) {
    super(), this._context = t, this._hyperLinkModel = e, this._initSkeletonChange();
  }
  _initSkeletonChange() {
    const t = () => {
      var e;
      (e = this._context.mainComponent) == null || e.makeForceDirty();
    };
    this.disposeWithMe(this._hyperLinkModel.linkUpdate$.pipe(debounceTime(16)).subscribe(() => {
      t();
    }));
  }
};
wt3 = Wn([
  Lt(1, Inject(R))
], wt3);
var it = class extends Ve {
  constructor(t, e) {
    super(), this._sheetInterceptorService = t, this._hyperLinkModel = e, this._initViewModelIntercept();
  }
  _initViewModelIntercept() {
    this.disposeWithMe(
      this._sheetInterceptorService.intercept(
        ht.CELL_CONTENT,
        {
          effect: sr.Value,
          priority: 100,
          handler: (t, e, n) => {
            const { row: i, col: r, unitId: s, subUnitId: o } = e, c = this._hyperLinkModel.getHyperLinkByLocation(s, o, i, r);
            return c && t && (t === e.rawData && (t = { ...e.rawData }), t.linkUrl = c.payload, t.linkId = c.id), n(t);
          }
        }
      )
    );
  }
};
it = Wn([
  Lt(0, Inject(G)),
  Lt(1, Inject(R))
], it);
var Zi = {
  [De.MEDIA]: {
    [ae.id]: {
      order: 1,
      menuItemFactory: Hi
    },
    [Qe(ae.id)]: {
      order: 1,
      menuItemFactory: Di
    }
  },
  [Y1.MAIN_AREA]: {
    [a1.OTHERS]: {
      order: 1,
      [ae.id]: {
        order: 0,
        menuItemFactory: Mi
      },
      [Qe(ae.id)]: {
        order: 0,
        menuItemFactory: Ui
      }
    }
  }
};
var Gi2 = Object.getOwnPropertyDescriptor;
var Ki = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? Gi2(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var we2 = (t, e) => (n, i) => e(n, i, t);
var st2 = class extends Ve {
  constructor(t, e, n, i, r) {
    super(), this._componentManager = t, this._commandService = e, this._menuManagerService = n, this._injector = i, this._shortcutService = r, this._initComponents(), this._initCommands(), this._initMenus(), this._initShortCut();
  }
  _initComponents() {
    [
      [ze.componentKey, ze],
      [Ye.componentKey, Ye],
      ["LinkIcon", Dt]
    ].forEach(([t, e]) => {
      this._componentManager.register(t, e);
    });
  }
  _initCommands() {
    [
      At,
      Xe,
      Vt,
      ae
    ].forEach((t) => {
      this._commandService.registerCommand(t);
    });
  }
  _initMenus() {
    this._menuManagerService.mergeMenu(Zi);
  }
  _initShortCut() {
    this._shortcutService.registerShortcut(Fn2);
  }
};
st2 = Ki([
  we2(0, Inject(S1)),
  we2(1, Ls),
  we2(2, B1),
  we2(3, Inject(Injector)),
  we2(4, Inject(ye))
], st2);
var Yi = Object.getOwnPropertyDescriptor;
var zi = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? Yi(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var _n = (t, e) => (n, i) => e(n, i, t);
var ot = class extends Ve {
  constructor(t, e) {
    super(), this._parserService = t, this._resolverService = e, this._handleInitUrl();
  }
  _handleInitUrl() {
    const t = location.hash;
    if (t) {
      const e = this._parserService.parseHyperLink(t);
      this._resolverService.navigate(e);
    }
  }
};
ot = zi([
  _n(0, Inject(ve)),
  _n(1, Inject(ce))
], ot);
var Xi = Object.defineProperty;
var qi = Object.getOwnPropertyDescriptor;
var Ji = (t, e, n) => e in t ? Xi(t, e, { enumerable: true, configurable: true, writable: true, value: n }) : t[e] = n;
var Qi = (t, e, n, i) => {
  for (var r = i > 1 ? void 0 : i ? qi(e, n) : e, s = t.length - 1, o; s >= 0; s--)
    (o = t[s]) && (r = o(r) || r);
  return r;
};
var In = (t, e) => (n, i) => e(n, i, t);
var jn = (t, e, n) => Ji(t, typeof e != "symbol" ? e + "" : e, n);
var at = class extends Ol {
  constructor(t = gn, e, n) {
    super(), this._config = t, this._injector = e, this._configService = n;
    const { menu: i, ...r } = oo(
      {},
      gn,
      this._config
    );
    i && this._configService.setConfig("menu", i, { merge: true }), this._configService.setConfig(Mn, r);
  }
  onStarting() {
    [
      [ce],
      [Z],
      [Un],
      [it],
      [rt],
      [st2],
      [tt],
      [qe2],
      [nt],
      [ot]
    ].forEach((e) => this._injector.add(e)), this._injector.get(it);
  }
  onReady() {
    this._injector.get(ME).registerRenderModule(we.UNIVER_SHEET, [wt3]), this._injector.get(tt), this._injector.get(qe2), this._injector.get(st2);
  }
  onRendered() {
    this._injector.get(nt), this._injector.get(ot), this._injector.get(rt);
  }
};
jn(at, "pluginName", Bt);
jn(at, "type", we.UNIVER_SHEET);
at = Qi([
  qR(de, wr),
  In(1, Inject(Injector)),
  In(2, ic)
], at);

export {
  ce,
  Un,
  Z,
  At,
  Xe,
  Vt,
  qe2 as qe,
  Fn2 as Fn,
  at
};
//# sourceMappingURL=chunk-ST7J4VGM.js.map
